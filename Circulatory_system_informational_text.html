<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation Circulatory System ‚Äî What Your Heart Doesn't Tell You</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#1a1a2e;color:#e0e0e0;overflow:hidden;height:100vh;}
.app{display:grid;grid-template-columns:280px 1fr 280px;height:100vh;}
/* LEFT SIDEBAR */
.left{background:linear-gradient(180deg,#0f0f23 0%,#1a1a2e 100%);border-right:1px solid #2a2a4a;display:flex;flex-direction:column;overflow-y:auto;padding:10px;}
.left::-webkit-scrollbar{width:4px;}.left::-webkit-scrollbar-thumb{background:#444;border-radius:2px;}
.pick-header{text-align:center;padding:8px;font-size:14px;font-weight:700;color:#ff6b6b;text-transform:uppercase;letter-spacing:1px;}
.pick-count{text-align:center;font-size:12px;color:#aaa;margin-bottom:8px;}
.scenario-card{display:flex;align-items:center;gap:8px;padding:10px;margin:3px 0;border-radius:10px;cursor:pointer;transition:all .3s;border:2px solid transparent;background:rgba(255,255,255,0.03);}
.scenario-card:hover{background:rgba(255,107,107,0.1);border-color:rgba(255,107,107,0.3);}
.scenario-card.selected{background:rgba(255,107,107,0.15);border-color:#ff6b6b;box-shadow:0 0 12px rgba(255,107,107,0.2);}
.scenario-card.completed{opacity:0.7;}.scenario-card.completed::after{content:'‚úÖ';position:absolute;right:8px;font-size:14px;}
.scenario-card{position:relative;}
.sc-emoji{font-size:28px;min-width:36px;text-align:center;}
.sc-name{font-size:12px;font-weight:600;line-height:1.3;}
.divider{height:1px;background:linear-gradient(90deg,transparent,#444,transparent);margin:10px 0;}
.sidebar-section{padding:6px 0;}
.sidebar-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;padding:0 4px;}
.reading-tabs{display:flex;gap:4px;margin-bottom:8px;}
.reading-tab{flex:1;text-align:center;padding:6px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;background:rgba(255,255,255,0.05);border:1px solid #333;transition:all .3s;}
.reading-tab:hover{background:rgba(255,255,255,0.1);}
.reading-tab.active{background:linear-gradient(135deg,#ff6b6b,#ee5a24);color:#fff;border-color:#ff6b6b;box-shadow:0 0 8px rgba(255,107,107,0.3);}
.keyword{display:inline-block;padding:3px 8px;margin:2px;border-radius:6px;font-size:11px;font-weight:600;background:rgba(255,255,255,0.05);border:1px solid #333;transition:all .3s;}
.keyword.highlighted{background:rgba(255,107,107,0.2);border-color:#ff6b6b;color:#ff6b6b;}
.btn-reset{width:100%;padding:8px;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;margin:3px 0;transition:all .3s;}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;}
.btn-primary{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;}
.btn-danger:hover,.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.3);}
/* CENTER PANEL */
.center{display:flex;flex-direction:column;background:#12122a;overflow:hidden;}
.top-bar{background:linear-gradient(135deg,#1a1a3e,#252550);padding:8px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #2a2a4a;}
.sim-title{font-size:14px;font-weight:700;color:#ff6b6b;}
.sim-subtitle{font-size:11px;color:#888;}
.step-tabs{display:flex;gap:4px;padding:8px 16px;background:rgba(0,0,0,0.2);}
.step-tab{flex:1;text-align:center;padding:8px 4px;border-radius:8px;font-size:13px;font-weight:700;background:rgba(255,255,255,0.03);color:#555;transition:all .5s;border:1px solid transparent;}
.step-tab.active{background:linear-gradient(135deg,#ff6b6b,#ee5a24);color:#fff;box-shadow:0 0 16px rgba(255,107,107,0.4);border-color:#ff6b6b;animation:glowPulse 2s infinite;}
.step-tab.done{background:rgba(46,204,113,0.15);color:#2ecc71;border-color:rgba(46,204,113,0.3);}
@keyframes glowPulse{0%,100%{box-shadow:0 0 12px rgba(255,107,107,0.3);}50%{box-shadow:0 0 24px rgba(255,107,107,0.6);}}
.main-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;overflow-y:auto;position:relative;}
.content-card{background:rgba(255,255,255,0.03);border:1px solid #2a2a4a;border-radius:16px;padding:24px;max-width:700px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,0.3);animation:fadeIn .5s;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.predict-q{font-size:18px;font-weight:700;text-align:center;color:#f0f0f0;line-height:1.4;margin-bottom:20px;}
.predict-btns{display:flex;gap:12px;justify-content:center;}
.predict-btn{padding:14px 28px;border-radius:12px;border:2px solid;font-size:14px;font-weight:700;cursor:pointer;transition:all .3s;}
.predict-btn.ok{background:rgba(46,204,113,0.1);border-color:#2ecc71;color:#2ecc71;}
.predict-btn.danger{background:rgba(231,76,60,0.1);border-color:#e74c3c;color:#e74c3c;}
.predict-btn:hover{transform:scale(1.05);box-shadow:0 4px 20px rgba(0,0,0,0.3);}
.reading-card{background:rgba(255,255,255,0.95);color:#222;border-radius:12px;padding:20px;line-height:1.7;font-size:16px;max-height:55vh;overflow-y:auto;}
.reading-card::-webkit-scrollbar{width:6px;}.reading-card::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}
.reading-card .highlight-word{color:#e74c3c;font-weight:700;}
.reading-card .current-sentence{background:rgba(255,235,59,0.4);border-radius:4px;padding:1px 2px;}
.action-bar{padding:12px 16px;display:flex;justify-content:center;gap:10px;background:rgba(0,0,0,0.2);border-top:1px solid #2a2a4a;}
.action-btn{padding:12px 32px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;transition:all .3s;color:#fff;}
.action-btn.primary{background:linear-gradient(135deg,#ff6b6b,#ee5a24);box-shadow:0 4px 16px rgba(255,107,107,0.3);}
.action-btn.secondary{background:linear-gradient(135deg,#3498db,#2980b9);}
.action-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3);}
.action-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
/* WATCH ANIMATION AREA */
.watch-arena{width:100%;max-width:680px;height:380px;border-radius:16px;background:linear-gradient(180deg,#0a0a2e,#141435);border:1px solid #2a2a4a;position:relative;overflow:hidden;box-shadow:inset 0 0 40px rgba(0,0,0,0.5);}
.body-diagram{position:absolute;left:20px;top:20px;width:200px;height:340px;}
.body-outline{stroke:#445;stroke-width:2;fill:rgba(255,255,255,0.02);}
.vessel-network{transition:all 1s;}
.meter-container{position:absolute;right:30px;top:20px;width:60px;height:320px;display:flex;flex-direction:column;align-items:center;}
.meter-label{font-size:10px;font-weight:700;color:#aaa;writing-mode:vertical-rl;text-orientation:mixed;margin-bottom:8px;letter-spacing:1px;}
.meter-track{width:30px;flex:1;background:#1a1a3e;border-radius:15px;border:2px solid #333;position:relative;overflow:hidden;}
.meter-fill{position:absolute;bottom:0;width:100%;border-radius:0 0 13px 13px;transition:height 1.5s ease,background 1s;}
.meter-ok-zone{position:absolute;left:-4px;right:-4px;border:2px dashed rgba(46,204,113,0.4);border-radius:4px;pointer-events:none;}
.meter-arrow-supply{position:absolute;left:-45px;font-size:10px;color:#2ecc71;font-weight:700;}
.meter-arrow-demand{position:absolute;left:-50px;font-size:10px;color:#e74c3c;font-weight:700;}
.anim-label{position:absolute;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700;background:rgba(0,0,0,0.7);border:1px solid;animation:labelFade .5s;pointer-events:none;white-space:nowrap;}
@keyframes labelFade{from{opacity:0;transform:scale(0.8);}to{opacity:1;transform:scale(1);}}
.anim-particle{position:absolute;width:8px;height:8px;border-radius:50%;pointer-events:none;}
.scenario-visual{position:absolute;left:240px;top:20px;right:110px;bottom:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.scenario-visual .vis-title{font-size:13px;font-weight:700;color:#ff6b6b;margin-bottom:8px;text-align:center;}
/* WELCOME SCREEN */
.welcome-screen{text-align:center;padding:30px;}
.welcome-screen h2{font-size:24px;color:#ff6b6b;margin-bottom:12px;}
.welcome-screen p{font-size:14px;color:#aaa;line-height:1.6;max-width:500px;margin:0 auto 16px;}
.welcome-screen .hook{font-size:20px;color:#f39c12;font-weight:700;margin:16px 0;}
/* RIGHT SIDEBAR */
.right{background:linear-gradient(180deg,#0f0f23 0%,#1a1a2e 100%);border-left:1px solid #2a2a4a;display:flex;flex-direction:column;padding:10px;overflow-y:auto;}
.right::-webkit-scrollbar{width:4px;}.right::-webkit-scrollbar-thumb{background:#444;border-radius:2px;}
.hud-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}
.hud-item{background:rgba(255,255,255,0.03);border:1px solid #2a2a4a;border-radius:10px;padding:8px;text-align:center;}
.hud-value{font-size:20px;font-weight:800;color:#ff6b6b;}
.hud-label{font-size:10px;color:#888;text-transform:uppercase;letter-spacing:0.5px;}
.progress-bar-container{background:#1a1a3e;border-radius:8px;height:14px;margin:6px 0;overflow:hidden;border:1px solid #2a2a4a;}
.progress-bar-fill{height:100%;border-radius:7px;background:linear-gradient(90deg,#ff6b6b,#ee5a24);transition:width .5s;position:relative;}
.progress-bar-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);animation:shimmer 2s infinite;}
@keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
.progress-msg{font-size:11px;color:#aaa;text-align:center;margin-bottom:8px;}
.rank-badge{text-align:center;padding:6px;margin:4px 0;border-radius:8px;font-size:12px;font-weight:700;}
.rank-badge.investigator{background:linear-gradient(135deg,rgba(255,107,107,0.2),rgba(238,90,36,0.2));color:#ff6b6b;border:1px solid rgba(255,107,107,0.3);}
.rank-badge.top{background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,165,0,0.2));color:#ffd700;border:1px solid rgba(255,215,0,0.3);animation:glowGold 2s infinite;}
@keyframes glowGold{0%,100%{box-shadow:0 0 8px rgba(255,215,0,0.2);}50%{box-shadow:0 0 20px rgba(255,215,0,0.5);}}
.copy-btn{width:100%;padding:6px;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;margin:4px 0;transition:all .3s;}
.copy-btn:hover{transform:translateY(-1px);}
.data-table{width:100%;border-collapse:collapse;margin-top:4px;font-size:10px;}
.data-table th{background:linear-gradient(135deg,#ff6b6b,#ee5a24);color:#fff;padding:5px 3px;font-size:9px;text-transform:uppercase;letter-spacing:0.3px;}
.data-table td{padding:4px 3px;border-bottom:1px solid #2a2a4a;color:#ccc;font-size:9px;word-break:break-word;}
.data-table tr:nth-child(even){background:rgba(255,255,255,0.02);}
.hidden{display:none!important;}
/* Record success animation */
.record-success{text-align:center;padding:20px;}
.record-success .checkmark{font-size:64px;animation:bounceIn .6s;}
@keyframes bounceIn{0%{transform:scale(0);}50%{transform:scale(1.2);}100%{transform:scale(1);}}
.record-success h3{color:#2ecc71;font-size:20px;margin:10px 0;}
.record-success p{color:#aaa;font-size:14px;}
/* Completion screen */
.complete-screen{text-align:center;padding:20px;}
.complete-screen .trophy{font-size:80px;animation:bounceIn .8s;}
.complete-screen h2{font-size:22px;margin:10px 0;}
.complete-screen p{color:#aaa;font-size:14px;margin:6px 0;}
</style>
</head>
<body>
<div class="app">
<!-- LEFT SIDEBAR -->
<div class="left">
<div class="pick-header">üîç Case Files</div>
<div class="pick-count" id="pickCount">Pick Any 5 You Like!</div>
<div id="scenarioList"></div>
<div class="divider"></div>
<div class="sidebar-section">
<div class="sidebar-label">Reading Level</div>
<div class="reading-tabs">
<div class="reading-tab active" data-level="low" onclick="setLevel('low')">Low</div>
<div class="reading-tab" data-level="med" onclick="setLevel('med')">Med</div>
<div class="reading-tab" data-level="high" onclick="setLevel('high')">High</div>
</div>
</div>
<div class="divider"></div>
<div class="sidebar-section">
<div class="sidebar-label">Key Words</div>
<div id="keywordList"></div>
</div>
<div style="flex:1;"></div>
<button class="btn-reset btn-danger" onclick="resetSim()">Reset</button>
<button class="btn-reset btn-primary" onclick="newRun()">New Run</button>
</div>
<!-- CENTER PANEL -->
<div class="center">
<div class="top-bar">
<div>
<div class="sim-title">Mr. Jawad Simulation Circulatory System ‚Äî What Your Heart Doesn't Tell You</div>
<div class="sim-subtitle">Your body hides dangerous problems ‚Äî until the moment it can't.</div>
</div>
</div>
<div class="step-tabs" id="stepTabs">
<div class="step-tab" data-step="predict">1. PREDICT</div>
<div class="step-tab" data-step="read">2. READ</div>
<div class="step-tab" data-step="watch">3. WATCH</div>
<div class="step-tab" data-step="record">4. RECORD</div>
</div>
<div class="main-area" id="mainArea">
<div class="welcome-screen" id="welcomeScreen">
<div style="font-size:80px;margin-bottom:16px;">ü´Ä</div>
<h2>Blood Supply Investigation</h2>
<div class="hook">Your body hides dangerous problems ‚Äî until the moment it can't.</div>
<p>Read real cases where blood supply failed to meet demand and record what went wrong. Complete 5 case files to earn <strong>Investigator</strong> rank ‚Äî finish all 8 to unlock <strong>Top Investigator</strong>!</p>
<p style="color:#ff6b6b;font-weight:700;">‚Üê Pick a scenario from the left to start</p>
</div>
</div>
<div class="action-bar" id="actionBar">
<button class="action-btn primary hidden" id="mainBtn" onclick="handleAction()">Next</button>
<button class="action-btn secondary hidden" id="readAloudBtn" onclick="toggleReadAloud()">üîä Read Aloud</button>
</div>
</div>
<!-- RIGHT SIDEBAR -->
<div class="right">
<div class="sidebar-label" style="text-align:center;margin-bottom:6px;">Progress</div>
<div class="hud-grid">
<div class="hud-item"><div class="hud-value" id="hudScore">0</div><div class="hud-label">Score</div></div>
<div class="hud-item"><div class="hud-value" id="hudStreak">0</div><div class="hud-label">Streak</div></div>
<div class="hud-item"><div class="hud-value" id="hudCompleted">0/5</div><div class="hud-label">Done</div></div>
<div class="hud-item"><div class="hud-value" id="hudAccuracy">-</div><div class="hud-label">Accuracy</div></div>
</div>
<div class="progress-bar-container"><div class="progress-bar-fill" id="progressFill" style="width:0%;"></div></div>
<div class="progress-msg" id="progressMsg">Pick 5 more you like!</div>
<div id="rankArea"></div>
<div class="divider"></div>
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
<div class="sidebar-label" style="margin:0;">Data Table</div>
<button class="copy-btn" style="width:auto;padding:4px 10px;" onclick="copyTable()">üìã Copy Table</button>
</div>
<div style="overflow-x:auto;">
<table class="data-table" id="dataTable">
<thead><tr><th>Scenario</th><th>What Changed?</th><th>System Response</th><th>Back to OK?</th></tr></thead>
<tbody id="dataBody"></tbody>
</table>
</div>
</div>
</div>

<script>
// ===== DATA =====
const SCENARIOS = [
{id:1,name:"60,000 Miles Inside You",emoji:"üåç",meterResult:"dip",backToOk:"Yes ‚Äî brief dip",
whatChanged:"Massive vessel network revealed ‚Äî small section blocked",
sysResponse:"Brief oxygen drop in blocked area, system compensated",
readings:{
low:{text:`How far do you think your blood vessels reach? If you stretched out every <kw>artery</kw>, vein, and <kw>capillary</kw> in your body, they would reach 60,000 miles ‚Äî more than twice around the Earth. Your heart pushes <kw>blood flow</kw> through this entire network in about 60 seconds. If even one small section gets blocked, the <kw>oxygen</kw> <kw>supply</kw> to that area drops fast.`},
med:{text:`How far do you think your blood vessels reach? If you stretched out every <kw>artery</kw>, vein, and <kw>capillary</kw> in your body, they would reach 60,000 miles. That wraps around the Earth more than twice. The tiniest vessels ‚Äî <kw>capillary</kw> ‚Äî make up 80 percent of that distance and are thinner than a single hair. Your heart pushes <kw>blood flow</kw> through this massive system in about 60 seconds flat. Every inch depends on your heart's pump to deliver <kw>oxygen</kw> ‚Äî and if even a small section fails, the <kw>supply</kw> to that area drops fast.`},
high:{text:`How far do you think your blood vessels reach? If you stretched out every <kw>artery</kw>, vein, and <kw>capillary</kw> in your body, they would reach 60,000 miles. That wraps around the Earth more than twice. The tiniest vessels ‚Äî <kw>capillary</kw> ‚Äî make up 80 percent of that distance and are thinner than a single hair. Your heart pushes <kw>blood flow</kw> through this entire system in about 60 seconds flat. That means right now, your blood is completing a full loop through your body every minute. Every inch of that network depends on your heart's pump to deliver <kw>oxygen</kw> to wherever your body has <kw>demand</kw>. If even a small section of this network fails, the <kw>supply</kw> of <kw>oxygen</kw> to that area drops fast.`}
},
watchDesc:"Body diagram lights up with glowing vessel network. Oxygen particle races through full loop. One section dims ‚Äî meter briefly dips toward warning.",
animType:"network"},

{id:2,name:"The Silent Trait",emoji:"ü©∏",meterResult:"crash",backToOk:"No ‚Äî supply failed",
whatChanged:"Extreme exercise with sickle cell trait",
sysResponse:"Blood cells changed shape and blocked capillaries",
readings:{
low:{text:`Dale Lloyd II is a 19-year-old football player at Rice University. During a hard workout, something goes wrong inside his blood. He carries sickle cell trait ‚Äî a hidden condition where red blood cells change shape during extreme exercise and get stuck in tiny <kw>capillary</kw>. With <kw>blood flow</kw> blocked, <kw>oxygen</kw> can't reach his muscles, and his body's <kw>demand</kw> goes unmet.`},
med:{text:`Dale Lloyd II is a 19-year-old football player at Rice University in 2006. During a routine conditioning workout, something invisible goes wrong inside his blood. Dale carries sickle cell trait ‚Äî a genetic condition he never knows about. When exercise pushes his body's <kw>demand</kw> for <kw>oxygen</kw> to the extreme, some of his red blood cells change from round to crescent-shaped. These sickle-shaped cells get stuck in his tiny <kw>capillary</kw>, blocking <kw>blood flow</kw>. With <kw>oxygen</kw> <kw>supply</kw> cut off at the smallest vessels, his body's <kw>demand</kw> goes completely unmet.`},
high:{text:`Dale Lloyd II is a 19-year-old football player at Rice University in 2006. During a routine conditioning workout, something invisible goes wrong inside his blood. Dale carries sickle cell trait ‚Äî a genetic condition that affects about 1 in 13 African Americans. He never knows he has it. When extreme exercise pushes his body's <kw>demand</kw> for <kw>oxygen</kw> sky-high, some of his red blood cells change from round to crescent-shaped. These sickle-shaped cells get stuck in his tiny <kw>capillary</kw>, blocking <kw>blood flow</kw> at the smallest level. With <kw>oxygen</kw> <kw>supply</kw> cut off, his muscles and organs lose what they need ‚Äî even though his heart is pumping perfectly. Research later finds that college football players with this trait have 37 times higher risk of sudden death during intense exercise.`}
},
watchDesc:"Round blood cells flow, then bend into crescents and jam in capillaries. Oxygen stops. Meter crashes to danger.",
animType:"sickle"},

{id:3,name:"The Fix That Wasn't Medicine",emoji:"üíß",meterResult:"ok",backToOk:"Yes ‚Äî stayed OK",
whatChanged:"Coaches adjusted workout demands for carriers",
sysResponse:"Blood cells stayed round, flow kept moving, 89% fewer deaths",
readings:{
low:{text:`After college athletes with sickle cell trait die during workouts, schools start testing players before they compete. The fix is not a drug or surgery. Coaches give carriers more water breaks and skip all-out sprints without buildup ‚Äî matching the workout <kw>demand</kw> to what the body can safely <kw>supply</kw>. Deaths from sickle cell trait in college football drop by 89 percent.`},
med:{text:`After several college athletes with sickle cell trait die during intense workouts, colleges start testing players for the trait before they compete. The fix is not a drug or surgery ‚Äî it is simpler than that. If a player carries the trait, coaches give more water breaks and avoid pushing them to all-out sprints without buildup. This keeps the body's <kw>demand</kw> for <kw>oxygen</kw> from spiking past what the <kw>blood flow</kw> system can safely <kw>supply</kw>. The result: deaths from sickle cell trait in college football drop by 89 percent. Knowing the body's limit and adjusting the <kw>demand</kw> saves lives.`},
high:{text:`After several college athletes with sickle cell trait die during intense workouts, colleges start testing players for the trait before they play. The fix is not a drug or surgery ‚Äî it is far simpler. If a player carries the trait, coaches give more water breaks and avoid pushing them to all-out sprints without a gradual buildup. This keeps the body's <kw>demand</kw> for <kw>oxygen</kw> from spiking past what the <kw>blood flow</kw> system can safely <kw>supply</kw>. When <kw>demand</kw> stays within the body's limit, blood cells keep their round shape and flow through <kw>capillary</kw> without jamming. The result: deaths from sickle cell trait in college football drop by 89 percent. No new medicine is invented. The breakthrough is matching the <kw>demand</kw> to what the body's <kw>supply</kw> system can actually handle.`}
},
watchDesc:"Exercise intensity rises gradually with water breaks. Blood cells stay round. Flow smooth. 89% FEWER DEATHS label. Meter stays green.",
animType:"fix"},

{id:4,name:"200 Extra Miles Per Pound",emoji:"‚öñÔ∏è",meterResult:"warning",backToOk:"No ‚Äî warning zone",
whatChanged:"Body gains weight, builds extra miles of blood vessels",
sysResponse:"Heart pumps harder, blood flow slows at edges",
readings:{
low:{text:`For every pound of extra weight a person gains, the body builds about 200 more miles of blood vessels. That means the heart has to pump harder to push <kw>blood flow</kw> through a longer network. It is like adding miles of pipe to a water system without upgrading the pump. Over time, this extra <kw>demand</kw> can weaken the heart.`},
med:{text:`For every pound of extra weight a person gains, the body builds about 200 more miles of blood vessels to <kw>supply</kw> that new tissue. That means the heart has to pump harder to push <kw>blood flow</kw> through a longer and longer network. Think of it like adding miles of pipe to a water system without upgrading the pump. The same heart now does more work every single beat. Over time, this extra <kw>demand</kw> raises blood pressure and can weaken the heart. The <kw>supply</kw> system was built for a certain load ‚Äî adding distance without adding power puts the whole system at risk.`},
high:{text:`For every pound of extra weight a person gains, the body builds about 200 more miles of blood vessels to <kw>supply</kw> that new tissue with <kw>oxygen</kw>. That means the heart has to pump harder every beat to push <kw>blood flow</kw> through a longer network. Think of it like adding miles of pipe to a water system without upgrading the pump. Five extra pounds means 1,000 more miles of vessels. Twenty extra pounds means 4,000 more miles. The same heart now works much harder just to keep <kw>oxygen</kw> reaching every cell. Over time, this extra <kw>demand</kw> raises blood pressure and weakens the heart muscle. The <kw>supply</kw> system was designed for a certain distance ‚Äî stretching it further without adding power puts the whole circulatory system at risk.`}
},
watchDesc:"Vessel network expands. Miles counter climbs. Heart pumps harder with strain glow. Blood flow slows at edges. Meter drops to warning.",
animType:"weight"},

{id:5,name:"The Machine That Hummed",emoji:"üîß",meterResult:"dip",backToOk:"Partial ‚Äî OK at rest only",
whatChanged:"Failing heart replaced with mechanical pump",
sysResponse:"Fixed pump can't speed up ‚Äî supply falls short during activity",
readings:{
low:{text:`Dr. Jack Renfrew's heart is failing, so doctors remove it and put in a mechanical pump. The machine does the heart's job ‚Äî pushing <kw>blood flow</kw> through his <kw>artery</kw> to deliver <kw>oxygen</kw>. But unlike a real heart, it cannot speed up or slow down on its own. It pumps at the same pace no matter what his body's <kw>demand</kw> is.`},
med:{text:`Dr. Jack Renfrew's heart is failing, so doctors remove it entirely and install a mechanical heart pump. The machine does everything a real heart does ‚Äî it pushes <kw>blood flow</kw> through his <kw>artery</kw> to deliver <kw>oxygen</kw> to his whole body. But it has one major limit: it cannot speed up or slow down on its own. A real heart adjusts in seconds when <kw>demand</kw> changes ‚Äî sprinting, resting, getting scared. The machine just hums at the same steady pace, no matter what Renfrew's body needs. His twin babies learn to recognize the hum and say "Dadda" when they hear it coming.`},
high:{text:`Dr. Jack Renfrew's heart is failing, so doctors remove it entirely and install a mechanical heart pump ‚Äî a machine that must do everything a real heart does. It pushes <kw>blood flow</kw> through his <kw>artery</kw>, delivers <kw>oxygen</kw> to every organ, and keeps his body alive 24 hours a day. But it has one critical limit: it cannot adjust. A real heart speeds up in seconds when <kw>demand</kw> rises ‚Äî sprinting, climbing stairs, feeling afraid. A real heart slows down when the body rests, saving energy. The mechanical pump just hums at one constant pace, no matter what Renfrew's body needs. When <kw>demand</kw> spikes, the machine's fixed <kw>supply</kw> falls short. Renfrew survives on the machine until a donor heart becomes available ‚Äî his twin babies learn to say "Dadda" when they hear the hum coming around the corner.`}
},
watchDesc:"Real heart replaced by mechanical pump. Pump beats at constant rate. During activity, oxygen falls short. Meter dips below OK during demand spikes.",
animType:"mechanical"},

{id:6,name:"The 90% Surprise",emoji:"üí•",meterResult:"crash",backToOk:"No ‚Äî heart attack",
whatChanged:"Plaque silently blocks artery to 90%",
sysResponse:"Body hid danger until plaque broke ‚Äî instant failure",
readings:{
low:{text:`A coronary <kw>artery</kw> (the vessel that feeds the heart itself) can be 90 percent blocked by <kw>plaque</kw> before a heart attack actually happens. The body hides the danger ‚Äî it reroutes <kw>blood flow</kw> through backup vessels and the heart pumps harder. Then one day, a tiny piece of <kw>plaque</kw> breaks loose or the last gap closes. <kw>Blood flow</kw> to part of the heart stops, and the muscle starts dying within minutes.`},
med:{text:`A coronary <kw>artery</kw> ‚Äî the vessel that feeds the heart itself ‚Äî can be 90 percent blocked by <kw>plaque</kw> before a person feels anything wrong. The body compensates: it reroutes <kw>blood flow</kw> through smaller backup vessels and the heart pumps harder to keep <kw>oxygen</kw> moving. The person feels fine, walks around, lives their life. Then one day, a tiny piece of <kw>plaque</kw> breaks loose or the last 10 percent of the gap closes. <kw>Blood flow</kw> to part of the heart stops completely. The heart muscle in that area starts dying within minutes ‚Äî that is a heart attack.`},
high:{text:`A coronary <kw>artery</kw> ‚Äî the vessel that feeds the heart itself ‚Äî can be 90 percent blocked by <kw>plaque</kw> before a person feels anything wrong. The body compensates in ways you never notice. It reroutes <kw>blood flow</kw> through smaller backup vessels. The heart pumps harder to push <kw>oxygen</kw> through the narrowing gap. Blood pressure rises to maintain <kw>supply</kw>. The person walks, works, and exercises feeling perfectly fine. Then one day, a tiny piece of <kw>plaque</kw> breaks loose or the last 10 percent of the gap closes shut. <kw>Blood flow</kw> to part of the heart muscle stops completely ‚Äî and that muscle starts dying within minutes.`}
},
watchDesc:"Artery cross-section with plaque growing 50%‚Üí70%‚Üí90%. Blood still squeezes through. Then plaque breaks. Gap slams shut. HEART ATTACK warning. Meter crashes.",
animType:"plaque"},

{id:7,name:"100,000 Beats a Day",emoji:"üíì",meterResult:"ok",backToOk:"Yes ‚Äî stayed OK",
whatChanged:"Heart's nonstop workload revealed ‚Äî never rests",
sysResponse:"Heart beats 100K/day with only 0.4s rest between beats",
readings:{
low:{text:`How long can you work without a break? Your heart beats about 100,000 times every single day ‚Äî and it never stops. It pushes about 2,000 gallons of <kw>blood flow</kw> through your <kw>artery</kw> every 24 hours. The only rest it gets is a tiny pause between beats ‚Äî less than half a second.`},
med:{text:`How long can you work without a break? Your heart beats about 100,000 times every single day and never gets to stop. It pushes about 2,000 gallons of <kw>blood flow</kw> through your <kw>artery</kw> every 24 hours. Over a 75-year life, that adds up to over 2.5 billion beats. Unlike your arm or leg muscles, the heart muscle never fully rests. The only break it gets is a tiny pause between beats ‚Äî less than half a second of recovery before the next <kw>demand</kw> hits.`},
high:{text:`How long can you work without a break? Your heart beats about 100,000 times every single day and never gets to stop ‚Äî not even while you sleep. It pushes about 2,000 gallons of <kw>blood flow</kw> through your <kw>artery</kw> every 24 hours. Over a 75-year life, that adds up to over 2.5 billion beats. Unlike your arm or leg muscles, the heart muscle cannot take a day off. It contracts, relaxes, and contracts again in a cycle that lasts less than a second. The only recovery it gets is a tiny pause between beats ‚Äî a fraction of a second before the next <kw>demand</kw> for <kw>oxygen</kw> delivery hits. Your heart is the hardest-working muscle in your body, and it meets that <kw>demand</kw> every second of your life.`}
},
watchDesc:"Heart beats in time-lapse. Beat counter climbs to 100,000. Gallons counter to 2,000. Brief pause highlighted between beats. Meter holds steady.",
animType:"beats"},

{id:8,name:"The Astronaut's Lazy Heart",emoji:"üöÄ",meterResult:"crash",backToOk:"No ‚Äî supply failed on Earth",
whatChanged:"Heart weakened in zero gravity",
sysResponse:"Shrunken heart can't pump blood upward against gravity",
readings:{
low:{text:`In space, astronauts' hearts get weaker. Without gravity, the heart does not have to pump hard to move blood up to the brain. After months on the space station, the heart shrinks and loses muscle. Back on Earth, <kw>demand</kw> returns to normal ‚Äî but the weakened heart cannot keep up.`},
med:{text:`In space, astronauts' hearts actually get weaker ‚Äî not stronger. Without gravity, the heart does not have to work hard to push <kw>blood flow</kw> up to the brain. The <kw>demand</kw> on the heart drops, so the heart adapts by shrinking and losing muscle mass. After months on the International Space Station, the heart is smaller and less powerful. When astronauts return to Earth, normal gravity pulls blood down into their legs. Their weakened hearts cannot push it back up fast enough ‚Äî <kw>oxygen</kw> <kw>supply</kw> to the brain drops, and they get dizzy just standing up.`},
high:{text:`In space, astronauts' hearts actually get weaker ‚Äî not stronger. Without gravity, the heart does not have to work hard to push <kw>blood flow</kw> upward to the brain. The <kw>demand</kw> on the heart drops dramatically, so the heart does what any muscle does when it is not being used ‚Äî it shrinks. After months on the International Space Station, astronauts' hearts lose muscle mass and pump less powerfully. The heart adapts to lower <kw>demand</kw> in both directions: more work makes it stronger, less work makes it weaker. When astronauts return to Earth, normal gravity pulls blood down into their legs instantly. Their weakened hearts struggle to push <kw>blood flow</kw> back up ‚Äî <kw>oxygen</kw> <kw>supply</kw> to the brain drops, and they get dizzy just standing up. The heart built for low <kw>demand</kw> cannot meet Earth's normal <kw>demand</kw> anymore.`}
}
,
watchDesc:"Heart shrinks in space over months. On Earth return, gravity pulls blood to legs. Weak heart can't pump upward. Brain dims. Meter crashes.",
animType:"space"}
];

const KEYWORDS = ["artery","blood flow","oxygen","demand","supply","capillary","plaque"];

// ===== STATE =====
let state = {
level: 'low',
currentScenario: null,
step: null, // null, predict, read, watch, record
completed: [],
score: 0,
streak: 0,
correctPredictions: 0,
totalPredictions: 0,
prediction: null,
data: [],
speechActive: false,
speechUtterance: null,
speechResumeInterval: null,
audioInitialized: false
};

// ===== INIT =====
function init() {
renderScenarios();
renderKeywords();
updateHUD();
showWelcome();
}

function renderScenarios() {
const el = document.getElementById('scenarioList');
el.innerHTML = '';
SCENARIOS.forEach(s => {
const card = document.createElement('div');
card.className = 'scenario-card' + (state.completed.includes(s.id) ? ' completed' : '') + (state.currentScenario?.id === s.id ? ' selected' : '');
card.innerHTML = `<span class="sc-emoji">${s.emoji}</span><span class="sc-name">${s.name}</span>`;
card.onclick = () => selectScenario(s);
el.appendChild(card);
});
}

function renderKeywords(highlightList) {
const el = document.getElementById('keywordList');
el.innerHTML = '';
KEYWORDS.forEach(kw => {
const span = document.createElement('span');
span.className = 'keyword' + (highlightList && highlightList.includes(kw) ? ' highlighted' : '');
span.textContent = kw;
el.appendChild(span);
});
}

function setLevel(lv) {
state.level = lv;
document.querySelectorAll('.reading-tab').forEach(t => t.classList.toggle('active', t.dataset.level === lv));
if (state.step === 'read' && state.currentScenario) showRead();
}

// ===== SCENARIO SELECTION =====
function selectScenario(s) {
if (state.step === 'watch') return;
stopSpeech();
state.currentScenario = s;
state.step = 'predict';
state.prediction = null;
renderScenarios();
// Find keywords in this scenario's text
const txt = s.readings[state.level].text;
const found = KEYWORDS.filter(kw => txt.toLowerCase().includes(kw.toLowerCase()));
renderKeywords(found);
showPredict();
updateStepTabs();
}

// ===== STEP MANAGEMENT =====
function updateStepTabs() {
const steps = ['predict','read','watch','record'];
document.querySelectorAll('.step-tab').forEach(tab => {
const ts = tab.dataset.step;
const idx = steps.indexOf(ts);
const curIdx = steps.indexOf(state.step);
tab.classList.remove('active','done');
if (ts === state.step) tab.classList.add('active');
else if (idx < curIdx) tab.classList.add('done');
});
}

function showWelcome() {
const area = document.getElementById('mainArea');
area.innerHTML = `
<div class="welcome-screen">
<div style="font-size:80px;margin-bottom:16px;">ü´Ä</div>
<h2>Blood Supply Investigation</h2>
<div class="hook">Your body hides dangerous problems ‚Äî until the moment it can't.</div>
<p>Read real cases where blood supply failed to meet demand and record what went wrong. Complete 5 case files to earn <strong>Investigator</strong> rank ‚Äî finish all 8 to unlock <strong>Top Investigator</strong>!</p>
<p style="color:#ff6b6b;font-weight:700;">‚Üê Pick a scenario from the left to start</p>
</div>`;
document.getElementById('mainBtn').classList.add('hidden');
document.getElementById('readAloudBtn').classList.add('hidden');
state.step = null;
document.querySelectorAll('.step-tab').forEach(t => {t.classList.remove('active','done');});
}

function showPredict() {
const area = document.getElementById('mainArea');
const s = state.currentScenario;
area.innerHTML = `
<div class="content-card">
<div style="text-align:center;font-size:48px;margin-bottom:12px;">${s.emoji}</div>
<div style="text-align:center;font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Case File #${s.id}</div>
<div style="text-align:center;font-size:18px;font-weight:700;color:#ff6b6b;margin-bottom:16px;">${s.name}</div>
<div class="predict-q">Will blood supply stay in the OK zone ‚Äî or drop into danger?</div>
<div class="predict-btns">
<button class="predict-btn ok" onclick="makePrediction('ok')">‚úÖ Stays OK</button>
<button class="predict-btn danger" onclick="makePrediction('danger')">üî¥ Drops to Danger</button>
</div>
</div>`;
document.getElementById('mainBtn').classList.add('hidden');
document.getElementById('readAloudBtn').classList.add('hidden');
}

function makePrediction(pred) {
state.prediction = pred;
state.step = 'read';
updateStepTabs();
showRead();
}

function showRead() {
const area = document.getElementById('mainArea');
const s = state.currentScenario;
const raw = s.readings[state.level].text;
// Process keywords
let html = raw.replace(/<kw>(.*?)<\/kw>/g, '<span class="highlight-word">$1</span>');
// Split into sentences for read aloud
const sentences = raw.replace(/<kw>/g,'').replace(/<\/kw>/g,'').match(/[^.!?]+[.!?]+/g) || [raw];

area.innerHTML = `
<div class="content-card" style="max-width:650px;">
<div style="text-align:center;font-size:11px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Case File #${s.id}: ${s.name}</div>
<div class="reading-card" id="readingCard">${html}</div>
</div>`;

const btn = document.getElementById('mainBtn');
btn.classList.remove('hidden');
btn.textContent = 'Continue to WATCH ‚Üí';

const raBtn = document.getElementById('readAloudBtn');
raBtn.classList.remove('hidden');

// Update keywords for current text
const txt = s.readings[state.level].text;
const found = KEYWORDS.filter(kw => txt.toLowerCase().includes(kw.toLowerCase()));
renderKeywords(found);

// Store sentences for read aloud
state._sentences = sentences;
}

function handleAction() {
try {
if (state.step === 'read') {
stopSpeech();
state.step = 'watch';
updateStepTabs();
showWatch();
} else if (state.step === 'record') {
// After record, allow next selection
stopSpeech();
state.currentScenario = null;
state.step = null;
renderScenarios();
renderKeywords();
document.querySelectorAll('.step-tab').forEach(t => {t.classList.remove('active','done');});
checkCompletion();
showWelcome();
}
} catch(e) { console.error('handleAction error:', e); }
}

// ===== READ ALOUD =====
function initAudio() {
if (state.audioInitialized) return;
state.audioInitialized = true;
}

function toggleReadAloud() {
try {
initAudio();
if (state.speechActive) {
stopSpeech();
return;
}
if (!window.speechSynthesis) {
document.getElementById('readAloudBtn').textContent = 'üìñ Text Only';
return;
}
const sentences = state._sentences || [];
if (!sentences.length) return;
const fullText = sentences.join(' ');
const utterance = new SpeechSynthesisUtterance(fullText);
utterance.rate = 0.9;
utterance.onend = () => { stopSpeech(); };
utterance.onerror = () => { stopSpeech(); };
state.speechUtterance = utterance;
state.speechActive = true;
document.getElementById('readAloudBtn').textContent = '‚èπ Stop Reading';
// Chrome 15-second bug workaround
state.speechResumeInterval = setInterval(() => {
try { if (speechSynthesis.speaking) speechSynthesis.resume(); } catch(e){}
}, 10000);
speechSynthesis.cancel();
speechSynthesis.speak(utterance);
// Sentence highlighting
let sentIdx = 0;
const card = document.getElementById('readingCard');
if (card) {
const originalHTML = card.innerHTML;
utterance.onboundary = (e) => {
try {
if (e.name === 'sentence' || (e.charIndex > 0 && sentIdx < sentences.length - 1)) {
sentIdx = Math.min(sentIdx + 1, sentences.length - 1);
}
} catch(ex){}
};
}
} catch(e) {
console.error('Read aloud error:', e);
document.getElementById('readAloudBtn').textContent = 'üìñ Text Only';
}
}

function stopSpeech() {
try {
if (state.speechResumeInterval) { clearInterval(state.speechResumeInterval); state.speechResumeInterval = null; }
if (window.speechSynthesis) speechSynthesis.cancel();
state.speechActive = false;
state.speechUtterance = null;
const btn = document.getElementById('readAloudBtn');
if (btn) btn.textContent = 'üîä Read Aloud';
} catch(e){}
}

// ===== WATCH ANIMATION =====
function showWatch() {
const area = document.getElementById('mainArea');
const s = state.currentScenario;
document.getElementById('mainBtn').classList.add('hidden');
document.getElementById('readAloudBtn').classList.add('hidden');

area.innerHTML = `<div class="watch-arena" id="watchArena"></div>`;
const arena = document.getElementById('watchArena');

// Build animation based on animType
try {
buildWatchAnimation(arena, s);
} catch(e) {
console.error('Watch animation error:', e);
finishWatch();
}
}

function buildWatchAnimation(arena, s) {
// Common: Body outline + meter
arena.innerHTML = `
<svg class="body-diagram" viewBox="0 0 200 340">
<!-- Simplified body outline -->
<ellipse cx="100" cy="40" rx="30" ry="35" class="body-outline" id="bodyHead"/>
<rect x="70" y="75" width="60" height="100" rx="10" class="body-outline" id="bodyTorso"/>
<rect x="40" y="80" width="30" height="80" rx="8" class="body-outline" opacity="0.6"/>
<rect x="130" y="80" width="30" height="80" rx="8" class="body-outline" opacity="0.6"/>
<rect x="75" y="175" width="22" height="90" rx="8" class="body-outline" opacity="0.6" id="bodyLegL"/>
<rect x="103" y="175" width="22" height="90" rx="8" class="body-outline" opacity="0.6" id="bodyLegR"/>
<!-- Heart -->
<g id="heartIcon" transform="translate(92,100)">
<text font-size="28" text-anchor="middle" id="heartEmoji">ü´Ä</text>
</g>
<!-- Vessel network -->
<g id="vesselGroup" opacity="0.3">
<line x1="100" y1="100" x2="100" y2="40" stroke="#e74c3c" stroke-width="2" class="vessel"/>
<line x1="100" y1="100" x2="55" y2="120" stroke="#e74c3c" stroke-width="1.5" class="vessel"/>
<line x1="100" y1="100" x2="145" y2="120" stroke="#e74c3c" stroke-width="1.5" class="vessel"/>
<line x1="100" y1="110" x2="86" y2="220" stroke="#e74c3c" stroke-width="1.5" class="vessel"/>
<line x1="100" y1="110" x2="114" y2="220" stroke="#e74c3c" stroke-width="1.5" class="vessel"/>
</g>
</svg>
<!-- Meter -->
<div class="meter-container">
<div class="meter-label">BLOOD SUPPLY</div>
<div class="meter-track" id="meterTrack">
<div class="meter-fill" id="meterFill" style="height:65%;background:linear-gradient(0deg,#2ecc71,#27ae60);"></div>
<div class="meter-ok-zone" style="bottom:45%;height:30%;"></div>
</div>
<div style="display:flex;justify-content:space-between;width:80px;margin-top:4px;">
<span style="font-size:9px;color:#2ecc71;">‚ñ≤ SUPPLY</span>
</div>
<div style="font-size:9px;color:#e74c3c;margin-top:2px;">‚ñº DEMAND</div>
</div>
<!-- Scenario-specific visual area -->
<div class="scenario-visual" id="scenarioVis"></div>
`;

const vis = document.getElementById('scenarioVis');
const meterFill = document.getElementById('meterFill');
const vesselGroup = document.getElementById('vesselGroup');

// Animate based on type
switch(s.animType) {
case 'network': animateNetwork(vis, meterFill, vesselGroup); break;
case 'sickle': animateSickle(vis, meterFill); break;
case 'fix': animateFix(vis, meterFill); break;
case 'weight': animateWeight(vis, meterFill); break;
case 'mechanical': animateMechanical(vis, meterFill); break;
case 'plaque': animatePlaque(vis, meterFill); break;
case 'beats': animateBeats(vis, meterFill); break;
case 'space': animateSpace(vis, meterFill); break;
default: setTimeout(finishWatch, 3000);
}
}

// ===== ANIMATION FUNCTIONS =====
function animateNetwork(vis, meter, vessels) {
vis.innerHTML = `
<div class="vis-title">60,000 Miles of Blood Vessels</div>
<div style="position:relative;width:100%;height:85%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
<div id="milesCounter" style="font-size:36px;font-weight:800;color:#2ecc71;text-shadow:0 0 20px rgba(46,204,113,0.5);transition:all 1s;">60,000 mi</div>
<div style="font-size:12px;color:#888;margin:4px 0;">‚Üï Twice around Earth</div>
<div id="networkVis" style="width:200px;height:160px;position:relative;margin-top:10px;">
<div id="oxygenDot" style="width:12px;height:12px;border-radius:50%;background:radial-gradient(circle,#ff6b6b,#e74c3c);position:absolute;top:80px;left:0;box-shadow:0 0 12px #e74c3c;transition:left 1s linear;"></div>
<svg width="200" height="160" style="position:absolute;top:0;left:0;">
<path d="M10,80 Q50,20 100,80 Q150,140 190,80" stroke="#e74c3c" stroke-width="3" fill="none" opacity="0.6"/>
<path d="M10,80 Q50,50 100,80 Q150,110 190,80" stroke="#3498db" stroke-width="2" fill="none" opacity="0.4"/>
<!-- Capillaries -->
<g id="capNet" opacity="0.3">
<line x1="40" y1="40" x2="60" y2="30" stroke="#e74c3c" stroke-width="0.5"/>
<line x1="60" y1="30" x2="80" y2="35" stroke="#e74c3c" stroke-width="0.5"/>
<line x1="100" y1="60" x2="120" y2="50" stroke="#e74c3c" stroke-width="0.5"/>
<line x1="120" y1="50" x2="140" y2="55" stroke="#e74c3c" stroke-width="0.5"/>
<line x1="60" y1="120" x2="80" y2="130" stroke="#e74c3c" stroke-width="0.5"/>
<line x1="140" y1="100" x2="160" y2="110" stroke="#e74c3c" stroke-width="0.5"/>
</g>
</svg>
<div id="blockZone" style="position:absolute;top:25px;left:50px;width:40px;height:30px;background:transparent;border-radius:8px;transition:all 1s;"></div>
</div>
<div id="netLabel" style="font-size:11px;color:#aaa;margin-top:8px;opacity:0;transition:opacity 1s;">Oxygen races through in 60 seconds</div>
</div>`;

vessels.style.transition = 'opacity 1.5s';
setTimeout(() => { vessels.style.opacity = '0.8'; }, 300);
setTimeout(() => { document.getElementById('capNet').style.opacity = '0.8'; }, 800);
setTimeout(() => {
document.getElementById('netLabel').style.opacity = '1';
// Animate oxygen dot
const dot = document.getElementById('oxygenDot');
dot.style.left = '188px';
}, 1200);
setTimeout(() => {
// Block a section
document.getElementById('blockZone').style.background = 'rgba(231,76,60,0.3)';
document.getElementById('blockZone').style.border = '2px solid #e74c3c';
document.getElementById('blockZone').style.boxShadow = '0 0 12px rgba(231,76,60,0.5)';
meter.style.height = '50%';
meter.style.background = 'linear-gradient(0deg,#f39c12,#e67e22)';
}, 3500);
setTimeout(() => {
meter.style.height = '60%';
meter.style.background = 'linear-gradient(0deg,#2ecc71,#27ae60)';
}, 5500);
setTimeout(finishWatch, 7000);
}

function animateSickle(vis, meter) {
vis.innerHTML = `
<div class="vis-title">ü©∏ Sickle Cell Trait ‚Äî Dale Lloyd II</div>
<div style="position:relative;width:100%;height:85%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
<div id="exerciseBar" style="width:180px;height:16px;background:#1a1a3e;border-radius:8px;border:1px solid #333;overflow:hidden;margin-bottom:12px;">
<div id="exFill" style="width:20%;height:100%;background:linear-gradient(90deg,#2ecc71,#e74c3c);border-radius:8px;transition:width 2s;"></div>
</div>
<div style="font-size:10px;color:#888;margin-bottom:8px;">Exercise Intensity</div>
<div id="cellContainer" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:8px 0;">
<div class="blood-cell" id="cell1" style="width:32px;height:32px;background:radial-gradient(circle,#ff6b6b,#c0392b);border-radius:50%;transition:all 1.5s;box-shadow:0 0 8px rgba(231,76,60,0.3);"></div>
<div class="blood-cell" id="cell2" style="width:32px;height:32px;background:radial-gradient(circle,#ff6b6b,#c0392b);border-radius:50%;transition:all 1.5s;box-shadow:0 0 8px rgba(231,76,60,0.3);"></div>
<div class="blood-cell" id="cell3" style="width:32px;height:32px;background:radial-gradient(circle,#ff6b6b,#c0392b);border-radius:50%;transition:all 1.5s;box-shadow:0 0 8px rgba(231,76,60,0.3);"></div>
<div class="blood-cell" id="cell4" style="width:32px;height:32px;background:radial-gradient(circle,#ff6b6b,#c0392b);border-radius:50%;transition:all 1.5s;box-shadow:0 0 8px rgba(231,76,60,0.3);"></div>
<div class="blood-cell" id="cell5" style="width:32px;height:32px;background:radial-gradient(circle,#ff6b6b,#c0392b);border-radius:50%;transition:all 1.5s;box-shadow:0 0 8px rgba(231,76,60,0.3);"></div>
</div>
<div id="capView" style="width:180px;height:24px;background:linear-gradient(90deg,rgba(231,76,60,0.15),rgba(231,76,60,0.05));border:1px solid #444;border-radius:12px;margin:8px 0;position:relative;overflow:hidden;">
<div id="capFlow" style="position:absolute;left:0;top:4px;width:8px;height:8px;border-radius:50%;background:#e74c3c;box-shadow:0 0 6px #e74c3c;"></div>
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:9px;color:#666;">capillary</div>
</div>
<div id="sickleLabel" style="font-size:14px;font-weight:700;color:transparent;transition:all 1s;margin-top:8px;"></div>
<div id="riskLabel" style="font-size:18px;font-weight:800;color:transparent;transition:all 1s;"></div>
</div>`;

// Step 1: Exercise ramps up
setTimeout(() => { document.getElementById('exFill').style.width = '95%'; }, 500);
// Step 2: Cells sickle
setTimeout(() => {
['cell1','cell3','cell5'].forEach(id => {
const el = document.getElementById(id);
el.style.borderRadius = '50% 10% 50% 10%';
el.style.background = 'radial-gradient(circle,#8e44ad,#6c3483)';
el.style.boxShadow = '0 0 12px rgba(142,68,173,0.5)';
});
document.getElementById('sickleLabel').style.color = '#e74c3c';
document.getElementById('sickleLabel').textContent = '‚ö†Ô∏è Cells changing shape!';
}, 2500);
// Step 3: Capillary blocks
setTimeout(() => {
document.getElementById('capView').style.background = 'linear-gradient(90deg,rgba(142,68,173,0.4),rgba(231,76,60,0.4))';
document.getElementById('capView').style.borderColor = '#e74c3c';
document.getElementById('capFlow').style.display = 'none';
document.getElementById('sickleLabel').textContent = 'üö´ Capillary BLOCKED';
meter.style.height = '15%';
meter.style.background = 'linear-gradient(0deg,#e74c3c,#c0392b)';
}, 4000);
setTimeout(() => {
document.getElementById('riskLabel').style.color = '#e74c3c';
document.getElementById('riskLabel').textContent = '37x RISK';
}, 5200);
setTimeout(finishWatch, 7000);
}

function animateFix(vis, meter) {
vis.innerHTML = `
<div class="vis-title">üíß The Fix ‚Äî Adjusted Workouts</div>
<div style="position:relative;width:100%;height:85%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
<div id="fixExBar" style="width:180px;height:16px;background:#1a1a3e;border-radius:8px;border:1px solid #333;overflow:hidden;margin-bottom:4px;">
<div id="fixExFill" style="width:10%;height:100%;background:#2ecc71;border-radius:8px;transition:width 1s;"></div>
</div>
<div style="font-size:10px;color:#888;margin-bottom:12px;">Exercise Intensity (Controlled)</div>
<div style="display:flex;gap:6px;margin:8px 0;" id="fixCells">
<div style="width:28px;height:28px;background:radial-gradient(circle,#ff6b6b,#c0392b);border-radius:50%;box-shadow:0 0 6px rgba(231,76,60,0.3);"></div>
<div style="width:28px;height:28px;background:radial-gradient(circle,#ff6b6b,#c0392b);border-radius:50%;box-shadow:0 0 6px rgba(231,76,60,0.3);"></div>
<div style="width:28px;height:28px;background:radial-gradient(circle,#ff6b6b,#c0392b);border-radius:50%;box-shadow:0 0 6px rgba(231,76,60,0.3);"></div>
</div>
<div style="font-size:11px;color:#2ecc71;margin:4px;">‚úÖ Cells stay round</div>
<div id="fixWaterIcon" style="font-size:32px;opacity:0;transition:opacity 0.5s;">üíß</div>
<div id="fixResult" style="font-size:20px;font-weight:800;color:transparent;transition:all 1s;margin-top:12px;"></div>
</div>`;

// Gradual intensity with water breaks
setTimeout(() => { document.getElementById('fixExFill').style.width = '40%'; }, 500);
setTimeout(() => { document.getElementById('fixWaterIcon').style.opacity = '1'; document.getElementById('fixExFill').style.width = '25%'; }, 1500);
setTimeout(() => { document.getElementById('fixExFill').style.width = '55%'; document.getElementById('fixWaterIcon').style.opacity = '0'; }, 2500);
setTimeout(() => { document.getElementById('fixWaterIcon').style.opacity = '1'; document.getElementById('fixExFill').style.width = '35%'; }, 3500);
setTimeout(() => { document.getElementById('fixExFill').style.width = '50%'; document.getElementById('fixWaterIcon').style.opacity = '0'; }, 4500);
setTimeout(() => {
document.getElementById('fixResult').style.color = '#2ecc71';
document.getElementById('fixResult').textContent = '89% FEWER DEATHS';
meter.style.height = '65%';
meter.style.background = 'linear-gradient(0deg,#2ecc71,#27ae60)';
}, 5500);
setTimeout(finishWatch, 7000);
}

function animateWeight(vis, meter) {
vis.innerHTML = `
<div class="vis-title">‚öñÔ∏è 200 Extra Miles Per Pound</div>
<div style="position:relative;width:100%;height:85%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
<div id="milesCount" style="font-size:28px;font-weight:800;color:#3498db;transition:all 1s;">60,000 mi</div>
<div style="font-size:10px;color:#888;margin:4px 0;">Total vessel network</div>
<div style="display:flex;align-items:center;gap:16px;margin:12px 0;">
<div>
<div style="font-size:10px;color:#888;text-align:center;">Heart Effort</div>
<div id="heartEffort" style="width:60px;height:60px;border-radius:50%;background:radial-gradient(circle,#e74c3c,#c0392b);display:flex;align-items:center;justify-content:center;font-size:24px;transition:all 1s;box-shadow:0 0 12px rgba(231,76,60,0.3);">ü´Ä</div>
</div>
<div style="font-size:24px;color:#666;">‚Üí</div>
<div>
<div style="font-size:10px;color:#888;text-align:center;">Blood Pressure</div>
<div id="bpGauge" style="font-size:22px;font-weight:800;color:#2ecc71;transition:all 1s;">120</div>
</div>
</div>
<div id="pipeLabel" style="font-size:12px;color:#f39c12;opacity:0;transition:opacity 1s;text-align:center;">Like adding miles of pipe<br>without upgrading the pump</div>
</div>`;

setTimeout(() => {
document.getElementById('milesCount').textContent = '60,200 mi';
document.getElementById('milesCount').style.color = '#f39c12';
document.getElementById('bpGauge').textContent = '125';
}, 1000);
setTimeout(() => {
document.getElementById('milesCount').textContent = '61,000 mi';
document.getElementById('heartEffort').style.boxShadow = '0 0 20px rgba(231,76,60,0.5)';
document.getElementById('heartEffort').style.transform = 'scale(1.1)';
document.getElementById('bpGauge').textContent = '135';
document.getElementById('bpGauge').style.color = '#f39c12';
meter.style.height = '50%';
meter.style.background = 'linear-gradient(0deg,#f39c12,#e67e22)';
}, 2500);
setTimeout(() => {
document.getElementById('milesCount').textContent = '64,000 mi';
document.getElementById('milesCount').style.color = '#e74c3c';
document.getElementById('heartEffort').style.boxShadow = '0 0 30px rgba(231,76,60,0.7)';
document.getElementById('heartEffort').style.transform = 'scale(1.2)';
document.getElementById('bpGauge').textContent = '150';
document.getElementById('bpGauge').style.color = '#e74c3c';
document.getElementById('pipeLabel').style.opacity = '1';
meter.style.height = '35%';
meter.style.background = 'linear-gradient(0deg,#e74c3c,#c0392b)';
}, 4500);
setTimeout(finishWatch, 7000);
}

function animateMechanical(vis, meter) {
vis.innerHTML = `
<div class="vis-title">üîß Mechanical Heart Pump</div>
<div style="position:relative;width:100%;height:85%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
<div style="display:flex;gap:24px;align-items:flex-start;">
<div style="text-align:center;">
<div style="font-size:10px;color:#888;margin-bottom:4px;">Real Heart</div>
<div id="realHeart" style="font-size:40px;animation:heartBeat 0.8s infinite;">ü´Ä</div>
<div id="realLabel" style="font-size:10px;color:#2ecc71;margin-top:4px;">Adapts</div>
</div>
<div style="font-size:24px;color:#666;padding-top:20px;">‚Üí</div>
<div style="text-align:center;">
<div style="font-size:10px;color:#888;margin-bottom:4px;">Mechanical</div>
<div id="mechHeart" style="font-size:40px;opacity:0;transition:opacity 1s;">‚öôÔ∏è</div>
<div id="mechLabel" style="font-size:10px;color:#f39c12;margin-top:4px;opacity:0;transition:opacity 1s;">Fixed pace</div>
</div>
</div>
<div id="demandBar" style="width:160px;margin-top:16px;">
<div style="font-size:10px;color:#888;text-align:center;margin-bottom:4px;">Body Demand</div>
<div style="height:12px;background:#1a1a3e;border-radius:6px;border:1px solid #333;overflow:hidden;">
<div id="demandFill" style="width:30%;height:100%;background:#2ecc71;border-radius:6px;transition:all 1s;"></div>
</div>
</div>
<div id="mechMsg" style="font-size:13px;font-weight:700;color:transparent;transition:all 1s;margin-top:12px;text-align:center;"></div>
</div>`;

// Add heartbeat animation
const style = document.createElement('style');
style.textContent = `@keyframes heartBeat{0%,100%{transform:scale(1);}30%{transform:scale(1.15);}60%{transform:scale(0.95);}}`;
document.head.appendChild(style);

setTimeout(() => {
document.getElementById('realHeart').style.opacity = '0.3';
document.getElementById('mechHeart').style.opacity = '1';
document.getElementById('mechLabel').style.opacity = '1';
}, 1500);
setTimeout(() => {
document.getElementById('demandFill').style.width = '80%';
document.getElementById('demandFill').style.background = '#e74c3c';
document.getElementById('mechMsg').style.color = '#f39c12';
document.getElementById('mechMsg').textContent = '‚ö†Ô∏è Demand UP ‚Äî pump stays same';
meter.style.height = '40%';
meter.style.background = 'linear-gradient(0deg,#f39c12,#e67e22)';
}, 3000);
setTimeout(() => {
document.getElementById('demandFill').style.width = '30%';
document.getElementById('demandFill').style.background = '#2ecc71';
document.getElementById('mechMsg').textContent = '‚úÖ Rest ‚Äî pump meets demand';
document.getElementById('mechMsg').style.color = '#2ecc71';
meter.style.height = '60%';
meter.style.background = 'linear-gradient(0deg,#2ecc71,#27ae60)';
}, 5000);
setTimeout(finishWatch, 7000);
}

function animatePlaque(vis, meter) {
vis.innerHTML = `
<div class="vis-title">üí• The 90% Surprise ‚Äî Silent Blockage</div>
<div style="position:relative;width:100%;height:85%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
<div style="position:relative;width:180px;height:60px;margin:8px 0;">
<div style="position:absolute;top:0;left:0;right:0;height:60px;background:linear-gradient(0deg,rgba(231,76,60,0.15),transparent,rgba(231,76,60,0.15));border:2px solid #e74c3c;border-radius:30px;overflow:hidden;">
<div id="plaqueTop" style="position:absolute;top:0;left:30%;width:40%;height:0%;background:linear-gradient(180deg,#f39c12,#e67e22);border-radius:0 0 8px 8px;transition:height 1.5s;"></div>
<div id="plaqueBot" style="position:absolute;bottom:0;left:25%;width:50%;height:0%;background:linear-gradient(0deg,#f39c12,#e67e22);border-radius:8px 8px 0 0;transition:height 1.5s;"></div>
</div>
<div style="position:absolute;top:-16px;left:50%;transform:translateX(-50%);font-size:10px;color:#888;">Coronary Artery</div>
</div>
<div id="blockPct" style="font-size:32px;font-weight:800;color:#2ecc71;transition:all 0.8s;">50%</div>
<div id="blockStatus" style="font-size:12px;color:#2ecc71;transition:all 0.5s;">Body compensating ‚úÖ</div>
<div id="haWarning" style="font-size:24px;font-weight:800;color:transparent;transition:all 0.5s;margin-top:8px;"></div>
</div>`;

setTimeout(() => {
document.getElementById('plaqueTop').style.height = '25%';
document.getElementById('plaqueBot').style.height = '25%';
document.getElementById('blockPct').textContent = '50%';
}, 300);
setTimeout(() => {
document.getElementById('plaqueTop').style.height = '30%';
document.getElementById('plaqueBot').style.height = '35%';
document.getElementById('blockPct').textContent = '70%';
document.getElementById('blockPct').style.color = '#f39c12';
}, 1500);
setTimeout(() => {
document.getElementById('plaqueTop').style.height = '38%';
document.getElementById('plaqueBot').style.height = '42%';
document.getElementById('blockPct').textContent = '90%';
document.getElementById('blockPct').style.color = '#e74c3c';
document.getElementById('blockStatus').textContent = 'Still feels fine...';
document.getElementById('blockStatus').style.color = '#f39c12';
}, 3000);
setTimeout(() => {
document.getElementById('plaqueTop').style.height = '48%';
document.getElementById('plaqueBot').style.height = '48%';
document.getElementById('blockPct').textContent = 'üí• BLOCKED';
document.getElementById('blockPct').style.color = '#e74c3c';
document.getElementById('blockPct').style.textShadow = '0 0 20px rgba(231,76,60,0.8)';
document.getElementById('blockStatus').textContent = '';
document.getElementById('haWarning').style.color = '#e74c3c';
document.getElementById('haWarning').textContent = '‚ö†Ô∏è HEART ATTACK';
document.getElementById('haWarning').style.textShadow = '0 0 20px rgba(231,76,60,0.5)';
meter.style.height = '10%';
meter.style.background = 'linear-gradient(0deg,#e74c3c,#8b0000)';
}, 4800);
setTimeout(finishWatch, 7000);
}

function animateBeats(vis, meter) {
vis.innerHTML = `
<div class="vis-title">üíì 100,000 Beats a Day ‚Äî Never Stops</div>
<div style="position:relative;width:100%;height:85%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
<div id="beatHeart" style="font-size:64px;transition:transform 0.1s;">ü´Ä</div>
<div id="beatCounter" style="font-size:28px;font-weight:800;color:#ff6b6b;margin:8px 0;">0</div>
<div style="font-size:10px;color:#888;">beats counting...</div>
<div style="display:flex;gap:16px;margin-top:12px;">
<div style="text-align:center;">
<div style="font-size:22px;font-weight:800;color:#3498db;" id="gallonCount">0</div>
<div style="font-size:9px;color:#888;">gallons/day</div>
</div>
<div style="text-align:center;">
<div style="font-size:22px;font-weight:800;color:#9b59b6;" id="lifetimeCount">‚Äî</div>
<div style="font-size:9px;color:#888;">lifetime</div>
</div>
</div>
<div id="pauseLabel" style="font-size:11px;color:#f39c12;opacity:0;transition:opacity 1s;margin-top:12px;text-align:center;">Only 0.4s rest<br>between each beat</div>
</div>`;

let count = 0;
const beatEl = document.getElementById('beatHeart');
const counterEl = document.getElementById('beatCounter');
const interval = setInterval(() => {
count += 5000;
if (count > 100000) count = 100000;
counterEl.textContent = count.toLocaleString();
beatEl.style.transform = 'scale(1.2)';
setTimeout(() => { beatEl.style.transform = 'scale(1)'; }, 100);
if (count >= 100000) clearInterval(interval);
}, 200);

setTimeout(() => { document.getElementById('gallonCount').textContent = '2,000'; }, 2000);
setTimeout(() => { document.getElementById('lifetimeCount').textContent = '2.5B'; }, 3500);
setTimeout(() => { document.getElementById('pauseLabel').style.opacity = '1'; }, 4500);
// Meter stays OK
meter.style.height = '65%';
meter.style.background = 'linear-gradient(0deg,#2ecc71,#27ae60)';
setTimeout(finishWatch, 7000);
}

function animateSpace(vis, meter) {
vis.innerHTML = `
<div class="vis-title">üöÄ The Astronaut's Lazy Heart</div>
<div style="position:relative;width:100%;height:85%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
<div id="spacePhase" style="font-size:12px;font-weight:700;color:#3498db;margin-bottom:8px;transition:all 1s;">MONTHS IN SPACE</div>
<div style="display:flex;gap:16px;align-items:center;">
<div style="text-align:center;">
<div style="font-size:10px;color:#888;">Heart Size</div>
<div id="spaceHeart" style="font-size:48px;transition:all 2s;">ü´Ä</div>
</div>
<div style="text-align:center;">
<div style="font-size:10px;color:#888;">Gravity</div>
<div id="gravIcon" style="font-size:28px;transition:all 1s;">üåë</div>
<div id="gravLabel" style="font-size:10px;color:#888;">Zero-G</div>
</div>
</div>
<div id="spaceMsg" style="font-size:13px;font-weight:700;color:#3498db;margin-top:12px;transition:all 1s;text-align:center;">Heart working less... shrinking</div>
<div id="dizzyIcon" style="font-size:32px;opacity:0;transition:opacity 1s;margin-top:8px;"></div>
</div>`;

// Space phase: heart shrinks
setTimeout(() => {
document.getElementById('spaceHeart').style.fontSize = '36px';
document.getElementById('spaceHeart').style.opacity = '0.7';
meter.style.height = '55%';
}, 1500);
// Return to Earth
setTimeout(() => {
document.getElementById('spacePhase').textContent = 'RETURN TO EARTH';
document.getElementById('spacePhase').style.color = '#e74c3c';
document.getElementById('gravIcon').textContent = 'üåç';
document.getElementById('gravLabel').textContent = 'Normal-G';
document.getElementById('gravLabel').style.color = '#e74c3c';
document.getElementById('spaceMsg').textContent = 'Gravity pulls blood to legs...';
document.getElementById('spaceMsg').style.color = '#f39c12';
}, 3500);
setTimeout(() => {
document.getElementById('spaceMsg').textContent = 'Weak heart can\'t pump upward!';
document.getElementById('spaceMsg').style.color = '#e74c3c';
document.getElementById('dizzyIcon').style.opacity = '1';
document.getElementById('dizzyIcon').textContent = 'üòµ DIZZY';
meter.style.height = '15%';
meter.style.background = 'linear-gradient(0deg,#e74c3c,#c0392b)';
}, 5000);
setTimeout(finishWatch, 7000);
}

// ===== FINISH WATCH ‚Üí RECORD =====
function finishWatch() {
try {
state.step = 'record';
updateStepTabs();
recordData();
} catch(e) { console.error('finishWatch error:', e); }
}

function recordData() {
const s = state.currentScenario;
if (!s) return;

// Add to data
const row = {
scenario: s.name,
whatChanged: s.whatChanged,
sysResponse: s.sysResponse,
backToOk: s.backToOk
};
state.data.push(row);
if (!state.completed.includes(s.id)) {
state.completed.push(s.id);
}

// Check prediction accuracy
const actual = (s.meterResult === 'ok') ? 'ok' : 'danger';
state.totalPredictions++;
if (state.prediction === actual) {
state.correctPredictions++;
state.streak++;
state.score += 100 + (state.streak > 1 ? state.streak * 20 : 0);
} else {
state.streak = 0;
state.score += 50; // Points for completion regardless
}

updateHUD();
renderDataTable();
renderScenarios();

// Show record success
const area = document.getElementById('mainArea');
area.innerHTML = `
<div class="record-success">
<div class="checkmark">‚úÖ</div>
<h3>Data Recorded!</h3>
<p><strong>${s.name}</strong></p>
<p style="margin-top:8px;">${state.prediction === actual ? 'üéØ Prediction correct! +' + (100 + (state.streak > 1 ? state.streak * 20 : 0)) : 'üìù Good try! +50 points'}</p>
<p style="color:#888;font-size:12px;margin-top:12px;">${state.completed.length < 5 ? 'Pick ' + (5 - state.completed.length) + ' more you like!' : state.completed.length < 8 ? '‚≠ê Required done! Keep going for Top Investigator!' : 'üèÜ ALL 8 COMPLETE!'}</p>
</div>`;

const btn = document.getElementById('mainBtn');
btn.classList.remove('hidden');
btn.textContent = state.completed.length >= 8 ? 'View Final Results' : 'Pick Next Scenario ‚Üí';
document.getElementById('readAloudBtn').classList.add('hidden');
}

function updateHUD() {
document.getElementById('hudScore').textContent = state.score;
document.getElementById('hudStreak').textContent = state.streak;
document.getElementById('hudCompleted').textContent = state.completed.length + '/5';
document.getElementById('hudAccuracy').textContent = state.totalPredictions > 0 ? Math.round(state.correctPredictions / state.totalPredictions * 100) + '%' : '-';

const pct = Math.min(state.completed.length / 5 * 100, 100);
document.getElementById('progressFill').style.width = pct + '%';

const remaining = 5 - state.completed.length;
if (remaining > 0) {
document.getElementById('progressMsg').textContent = `Pick ${remaining} more you like!`;
} else if (state.completed.length < 8) {
document.getElementById('progressMsg').textContent = `Extra credit: ${8 - state.completed.length} more to go!`;
} else {
document.getElementById('progressMsg').textContent = 'All 8 complete!';
}

// Rank
const rankArea = document.getElementById('rankArea');
if (state.completed.length >= 8) {
rankArea.innerHTML = '<div class="rank-badge top">üèÜ TOP INVESTIGATOR</div>';
} else if (state.completed.length >= 5) {
rankArea.innerHTML = '<div class="rank-badge investigator">üîç INVESTIGATOR</div>';
} else {
rankArea.innerHTML = '';
}
}

function renderDataTable() {
const body = document.getElementById('dataBody');
body.innerHTML = '';
state.data.forEach(r => {
const tr = document.createElement('tr');
tr.innerHTML = `<td>${r.scenario}</td><td>${r.whatChanged}</td><td>${r.sysResponse}</td><td>${r.backToOk}</td>`;
body.appendChild(tr);
});
}

function checkCompletion() {
if (state.completed.length >= 8) {
const area = document.getElementById('mainArea');
area.innerHTML = `
<div class="complete-screen">
<div class="trophy">üèÜ</div>
<h2 style="color:#ffd700;">TOP INVESTIGATOR!</h2>
<p>All 8 case files complete!</p>
<p>Score: <strong style="color:#ff6b6b;">${state.score}</strong> | Accuracy: <strong style="color:#2ecc71;">${state.totalPredictions > 0 ? Math.round(state.correctPredictions / state.totalPredictions * 100) : 0}%</strong></p>
<p style="margin-top:12px;">Copy your data table from the right panel ‚Üí paste into your worksheet.</p>
</div>`;
document.getElementById('mainBtn').classList.add('hidden');
} else if (state.completed.length === 5) {
// Brief message then let them continue
}
}

// ===== COPY TABLE =====
function copyTable() {
try {
let text = 'Scenario\tWhat Changed?\tSystem Response\tBack to OK?\n';
state.data.forEach(r => {
text += `${r.scenario}\t${r.whatChanged}\t${r.sysResponse}\t${r.backToOk}\n`;
});
navigator.clipboard.writeText(text).then(() => {
const btn = document.querySelector('.copy-btn');
const orig = btn.textContent;
btn.textContent = '‚úÖ Copied!';
setTimeout(() => { btn.textContent = orig; }, 2000);
}).catch(() => {
// Fallback
const ta = document.createElement('textarea');
ta.value = text;
document.body.appendChild(ta);
ta.select();
document.execCommand('copy');
document.body.removeChild(ta);
const btn = document.querySelector('.copy-btn');
btn.textContent = '‚úÖ Copied!';
setTimeout(() => { btn.textContent = 'üìã Copy Table'; }, 2000);
});
} catch(e) { console.error('Copy error:', e); }
}

// ===== RESET / NEW RUN =====
function resetSim() {
stopSpeech();
state = {level:state.level,currentScenario:null,step:null,completed:[],score:0,streak:0,correctPredictions:0,totalPredictions:0,prediction:null,data:[],speechActive:false,speechUtterance:null,speechResumeInterval:null,audioInitialized:state.audioInitialized};
renderScenarios();
renderKeywords();
renderDataTable();
updateHUD();
showWelcome();
document.getElementById('mainBtn').classList.add('hidden');
document.getElementById('readAloudBtn').classList.add('hidden');
}

function newRun() { resetSim(); }

// ===== START =====
init();
</script>
</body>
</html>
