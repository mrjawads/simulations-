<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation ‚Äî Immune System: When Disease Hits Real People</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#0a0e1a;color:#e0e0e0;overflow:hidden;height:100vh;width:100vw;}
#app{display:flex;height:100vh;width:100vw;}
.left-sidebar{width:280px;min-width:280px;background:linear-gradient(180deg,#0d1526,#121d35);border-right:1px solid #1a2744;display:flex;flex-direction:column;overflow-y:auto;}
.left-sidebar::-webkit-scrollbar{width:4px;}.left-sidebar::-webkit-scrollbar-thumb{background:#2a3f6a;border-radius:4px;}
.pick-header{padding:12px 14px 4px;font-size:15px;font-weight:700;color:#7ecfff;text-align:center;}
.pick-sub{font-size:12px;color:#5a8ab5;text-align:center;margin-bottom:6px;padding:0 14px;}
.scenario-card{display:flex;align-items:center;gap:10px;padding:9px 12px;margin:2px 8px;border-radius:10px;cursor:pointer;transition:all .25s;border:2px solid transparent;background:rgba(255,255,255,.03);position:relative;}
.scenario-card:hover{background:rgba(126,207,255,.08);border-color:rgba(126,207,255,.2);}
.scenario-card.active{background:rgba(126,207,255,.12);border-color:#7ecfff;box-shadow:0 0 12px rgba(126,207,255,.15);}
.scenario-card.completed .sc-check{display:inline;}
.sc-check{display:none;position:absolute;right:8px;font-size:13px;}
.sc-emoji{font-size:26px;flex-shrink:0;}.sc-name{font-size:12px;font-weight:600;color:#c8ddf0;line-height:1.25;}
.sc-name small{display:block;font-size:10px;font-weight:400;color:#6a8fb5;margin-top:2px;}
.divider{height:1px;background:linear-gradient(90deg,transparent,#1a2744,transparent);margin:8px 16px;}
.section-label{padding:4px 14px;font-size:11px;font-weight:700;color:#5a8ab5;text-transform:uppercase;letter-spacing:1px;}
.reading-levels{display:flex;gap:4px;padding:4px 14px 6px;}
.rl-btn{flex:1;padding:6px 4px;border:2px solid #1a2744;border-radius:8px;background:transparent;color:#7a9fc0;font-size:12px;font-weight:700;cursor:pointer;text-align:center;transition:all .2s;}
.rl-btn.active{background:rgba(126,207,255,.15);border-color:#7ecfff;color:#7ecfff;}
.rl-btn:hover{border-color:#3a5f8a;}
.key-words-list{padding:4px 14px 6px;}
.kw-item{display:inline-block;padding:3px 9px;margin:2px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(126,207,255,.06);color:#6a9fc5;border:1px solid rgba(126,207,255,.1);transition:all .3s;}
.kw-item.highlighted{background:rgba(126,207,255,.2);color:#7ecfff;border-color:#7ecfff;box-shadow:0 0 6px rgba(126,207,255,.15);}
.bottom-btns{padding:8px 12px;margin-top:auto;display:flex;gap:6px;}
.btn-reset{flex:1;padding:9px;border:none;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#c0392b,#e74c3c);color:#fff;transition:all .2s;}
.btn-newrun{flex:1;padding:9px;border:none;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#2471a3,#2e86c1);color:#fff;transition:all .2s;}
.btn-reset:hover,.btn-newrun:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3);}
.center-panel{flex:1;display:flex;flex-direction:column;background:linear-gradient(180deg,#0c1220,#0f1628);overflow:hidden;}
.sim-title{text-align:center;padding:8px 16px 4px;font-size:16px;font-weight:800;background:linear-gradient(90deg,#7ecfff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.step-tabs{display:flex;justify-content:center;gap:5px;padding:4px 16px 8px;}
.step-tab{padding:7px 16px;border-radius:20px;font-size:11px;font-weight:700;color:#3a5570;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);transition:all .3s;letter-spacing:.5px;}
.step-tab.active{color:#7ecfff;background:rgba(126,207,255,.1);border-color:rgba(126,207,255,.3);box-shadow:0 0 16px rgba(126,207,255,.15);}
.step-tab.done{color:#27ae60;border-color:rgba(39,174,96,.3);}
.main-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 20px;overflow-y:auto;position:relative;}
.main-content::-webkit-scrollbar{width:4px;}.main-content::-webkit-scrollbar-thumb{background:#2a3f6a;border-radius:4px;}
.welcome-screen{text-align:center;max-width:600px;}
.welcome-screen h2{font-size:26px;font-weight:800;background:linear-gradient(135deg,#7ecfff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px;}
.welcome-screen p{font-size:14px;color:#7a9fc0;line-height:1.6;margin-bottom:12px;}
.welcome-icon{font-size:72px;margin-bottom:12px;display:block;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.predict-box{width:100%;max-width:580px;text-align:center;}
.predict-question{font-size:17px;font-weight:700;color:#c8ddf0;margin-bottom:4px;line-height:1.4;}
.predict-premise{font-size:13px;color:#6a8fb5;margin-bottom:16px;line-height:1.5;font-style:italic;}
.predict-options{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.predict-btn{padding:12px 20px;border-radius:14px;border:2px solid #1a2744;background:rgba(255,255,255,.03);color:#c8ddf0;font-size:14px;font-weight:700;cursor:pointer;transition:all .25s;min-width:150px;}
.predict-btn:hover{border-color:#7ecfff;background:rgba(126,207,255,.08);transform:translateY(-2px);}
.predict-btn.selected{border-color:#7ecfff;background:rgba(126,207,255,.15);box-shadow:0 0 12px rgba(126,207,255,.2);}
.read-box{width:100%;max-width:700px;display:flex;flex-direction:column;align-items:center;}
.passage-card{background:rgba(255,255,255,.04);border:1px solid #1a2744;border-radius:16px;padding:20px 24px;width:100%;line-height:1.65;font-size:15px;color:#c8ddf0;max-height:calc(100vh - 260px);overflow-y:auto;}
.passage-card::-webkit-scrollbar{width:4px;}.passage-card::-webkit-scrollbar-thumb{background:#2a3f6a;border-radius:4px;}
.kw-inline{color:#7ecfff;font-weight:700;}
.sentence{transition:background .3s;}.sentence.speaking{background:rgba(126,207,255,.15);border-radius:4px;padding:0 2px;}
.watch-box{width:100%;max-width:700px;display:flex;flex-direction:column;align-items:center;}
.body-arena{width:100%;height:320px;background:radial-gradient(ellipse at center,#0d1a30,#080e1a);border-radius:20px;border:1px solid #1a2744;position:relative;overflow:hidden;margin-bottom:8px;}
.organ-label{position:absolute;font-size:10px;font-weight:700;color:#fff;text-shadow:0 0 6px rgba(0,0,0,.8);white-space:nowrap;pointer-events:none;z-index:5;}
.particle{position:absolute;border-radius:50%;pointer-events:none;}
.particle.pathogen{background:radial-gradient(circle,#ff4444,#cc0000);box-shadow:0 0 6px rgba(255,68,68,.5);}
.particle.wbc{background:radial-gradient(circle,#44aaff,#0066dd);box-shadow:0 0 8px rgba(68,170,255,.6);border:1px solid rgba(255,255,255,.3);}
.particle.phage{background:radial-gradient(circle,#44dd44,#00aa00);box-shadow:0 0 6px rgba(68,221,68,.5);}
.defense-meter{width:90%;max-width:500px;height:28px;background:#111;border-radius:14px;border:1px solid #1a2744;position:relative;overflow:hidden;margin:0 auto;}
.meter-fill{height:100%;transition:width 1.2s ease,background 1.2s ease;border-radius:14px;width:50%;background:linear-gradient(90deg,#ff8800,#ffcc00);}
.ok-zone{position:absolute;right:15%;width:25%;height:100%;background:rgba(68,204,68,.1);border-left:2px dashed rgba(68,204,68,.3);border-right:2px dashed rgba(68,204,68,.3);}
.meter-labels{display:flex;justify-content:space-between;width:90%;max-width:500px;margin:3px auto 0;font-size:10px;font-weight:700;}
.meter-labels .red-label{color:#ff4444;}.meter-labels .green-label{color:#44cc44;}.meter-labels .blue-label{color:#4488ff;}
.watch-label{font-size:12px;color:#5a8ab5;text-align:center;margin-top:6px;font-style:italic;}
.anim-step-label{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.75);padding:5px 14px;border-radius:10px;font-size:12px;font-weight:700;color:#7ecfff;white-space:nowrap;z-index:10;transition:opacity .5s;}
.record-box{text-align:center;max-width:500px;}
.record-box h3{font-size:20px;font-weight:800;color:#27ae60;margin-bottom:6px;}
.record-box p{color:#7a9fc0;font-size:13px;}
.record-emoji{font-size:56px;margin-bottom:10px;display:block;}
.action-area{padding:8px 20px 10px;display:flex;justify-content:center;gap:10px;flex-shrink:0;}
.action-btn{padding:10px 28px;border:none;border-radius:14px;font-size:14px;font-weight:700;cursor:pointer;transition:all .25s;background:linear-gradient(135deg,#2471a3,#2e86c1);color:#fff;box-shadow:0 4px 16px rgba(36,113,163,.3);}
.action-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(36,113,163,.4);}
.action-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.action-btn.read-aloud{background:linear-gradient(135deg,#6c3483,#8e44ad);box-shadow:0 4px 16px rgba(108,52,131,.3);}
.action-btn.hidden{display:none;}
.right-sidebar{width:280px;min-width:280px;background:linear-gradient(180deg,#0d1526,#121d35);border-left:1px solid #1a2744;display:flex;flex-direction:column;overflow-y:auto;}
.right-sidebar::-webkit-scrollbar{width:4px;}.right-sidebar::-webkit-scrollbar-thumb{background:#2a3f6a;border-radius:4px;}
.progress-header{padding:10px 14px 4px;font-size:13px;font-weight:700;color:#7ecfff;text-align:center;}
.hud-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;padding:4px 8px 6px;}
.hud-stat{background:rgba(255,255,255,.03);border:1px solid #1a2744;border-radius:10px;padding:6px 4px;text-align:center;}
.hud-val{font-size:18px;font-weight:800;background:linear-gradient(135deg,#7ecfff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hud-label{font-size:9px;color:#5a8ab5;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}
.progress-bar-wrap{padding:4px 12px;}
.progress-bar{height:12px;background:#111;border-radius:6px;overflow:hidden;border:1px solid #1a2744;}
.progress-fill{height:100%;background:linear-gradient(90deg,#27ae60,#2ecc71);border-radius:6px;transition:width .5s;width:0%;}
.progress-msg{text-align:center;font-size:11px;color:#27ae60;font-weight:700;padding:3px 12px 6px;}
.data-header{display:flex;justify-content:space-between;align-items:center;padding:6px 12px 3px;}
.data-header span{font-size:13px;font-weight:700;color:#7ecfff;}
.copy-btn{padding:4px 10px;border:none;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#1a6b3c,#27ae60);color:#fff;transition:all .2s;}
.copy-btn:hover{transform:translateY(-1px);}
.data-table-wrap{padding:0 6px 8px;overflow-y:auto;flex:1;}
.data-table{width:100%;border-collapse:collapse;font-size:9px;}
.data-table th{background:rgba(126,207,255,.1);color:#7ecfff;padding:4px 3px;font-weight:700;text-align:left;border-bottom:1px solid #1a2744;position:sticky;top:0;}
.data-table td{padding:4px 3px;border-bottom:1px solid rgba(26,39,68,.5);color:#a0b8d0;vertical-align:top;line-height:1.3;}
.outcome-cell{font-size:13px;text-align:center;}
.empty-data{text-align:center;padding:16px 8px;color:#3a5570;font-size:11px;font-style:italic;}
.completion-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:100;justify-content:center;align-items:center;}
.completion-overlay.show{display:flex;}
.completion-card{background:linear-gradient(135deg,#0d1a30,#1a2744);border:2px solid #27ae60;border-radius:24px;padding:36px;text-align:center;max-width:480px;box-shadow:0 0 60px rgba(39,174,96,.2);}
.completion-card h2{font-size:26px;font-weight:800;color:#27ae60;margin-bottom:6px;}
.completion-card p{color:#7a9fc0;font-size:14px;margin-bottom:14px;}
.completion-card .big-emoji{font-size:64px;display:block;margin-bottom:14px;}
.completion-card button{padding:10px 24px;border:none;border-radius:12px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;font-size:15px;font-weight:700;cursor:pointer;}
.safety-bar{background:rgba(255,255,255,.02);border-top:1px solid #1a2744;padding:5px 12px;display:flex;gap:10px;justify-content:center;flex-shrink:0;}
.safety-item{font-size:9px;color:#4a6a8a;font-weight:600;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .35s ease;}
</style>
</head>
<body>
<div id="app">
<div class="left-sidebar">
<div class="pick-header">üîç Pick Any Story</div>
<div class="pick-sub" id="pickSub">Choose 5 of 8 ‚Äî any order!</div>
<div id="scenarioList"></div>
<div class="divider"></div>
<div class="section-label">Reading Level</div>
<div class="reading-levels">
<button class="rl-btn active" data-level="low" onclick="setLevel('low')">Low</button>
<button class="rl-btn" data-level="med" onclick="setLevel('med')">Med</button>
<button class="rl-btn" data-level="high" onclick="setLevel('high')">High</button>
</div>
<div class="divider"></div>
<div class="section-label">Key Words</div>
<div class="key-words-list" id="keyWordsList"></div>
<div class="bottom-btns">
<button class="btn-reset" onclick="resetSim()">Reset</button>
<button class="btn-newrun" onclick="newRun()">New Run</button>
</div>
</div>
<div class="center-panel">
<div class="sim-title">Mr. Jawad Simulation ‚Äî Immune System: When Disease Hits Real People</div>
<div class="step-tabs" id="stepTabs">
<div class="step-tab" data-step="predict">1. PREDICT</div>
<div class="step-tab" data-step="read">2. READ</div>
<div class="step-tab" data-step="watch">3. WATCH</div>
<div class="step-tab" data-step="record">4. RECORD</div>
</div>
<div class="main-content" id="mainContent">
<div class="welcome-screen fade-in" id="welcomeScreen">
<span class="welcome-icon">üõ°Ô∏è</span>
<h2>Medical Investigator</h2>
<p>Real people ‚Äî presidents, authors, kids ‚Äî all fought invisible wars inside their own bodies. Read their true stories and track how their immune systems responded.</p>
<p style="font-size:12px;color:#5a8ab5;">Pick any story from the left to begin.</p>
</div>
</div>
<div class="action-area" id="actionArea">
<button class="action-btn hidden" id="mainActionBtn">Next</button>
<button class="action-btn read-aloud hidden" id="readAloudBtn" onclick="toggleReadAloud()">üîä Read Aloud</button>
</div>
<div class="safety-bar">
<span class="safety-item">üìå Choose any stories you want</span>
<span class="safety-item">üìå Low/Med/High = different supports, not smarter</span>
<span class="safety-item">üìå Use evidence from reading</span>
</div>
</div>
<div class="right-sidebar">
<div class="progress-header">üìä Progress</div>
<div class="hud-grid">
<div class="hud-stat"><div class="hud-val" id="hudScore">0</div><div class="hud-label">Score</div></div>
<div class="hud-stat"><div class="hud-val" id="hudStreak">0</div><div class="hud-label">Streak</div></div>
<div class="hud-stat"><div class="hud-val" id="hudCompleted">0/5</div><div class="hud-label">Done</div></div>
<div class="hud-stat"><div class="hud-val" id="hudAccuracy">--%</div><div class="hud-label">Accuracy</div></div>
</div>
<div class="progress-bar-wrap"><div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div></div>
<div class="progress-msg" id="progressMsg">Pick your first story!</div>
<div class="data-header"><span>Data Table</span><button class="copy-btn" id="copyBtn" onclick="copyTable()">üìã Copy Table</button></div>
<div class="data-table-wrap">
<table class="data-table" id="dataTable">
<thead><tr><th>Scenario</th><th>What Happened?</th><th>Response</th><th>Immune Connection</th><th>Out</th></tr></thead>
<tbody id="dataBody"></tbody>
</table>
<div class="empty-data" id="emptyData">Complete stories to fill the table.</div>
</div>
</div>
</div>
<div class="completion-overlay" id="completionOverlay">
<div class="completion-card fade-in">
<span class="big-emoji">üèÜ</span>
<h2 id="completionTitle">Required Complete!</h2>
<p id="completionMsg">You finished 5 stories. Continue for extra credit?</p>
<button onclick="dismissCompletion()">Continue</button>
</div>
</div>
<script>
// ============ SCENARIO DATA ============
const SC=[
{id:1,name:"Roosevelt's Secret",emoji:"üèõÔ∏è",brief:"FDR was 39 when polio paralyzed his legs.",organ:"spine",outcome:"warn",oe:"‚ö†Ô∏è",wh:"Polio virus attacked spinal cord",resp:"WBC fought back, antibodies too slow",conn:"Immune response lost the race",mt:15,
passages:{
low:{t:'Franklin Roosevelt is 39 when a deadly <kw>pathogen</kw> invades his body ‚Äî the polio virus. His <kw>white blood cells</kw> launch an <kw>immune response</kw>, but the virus attacks his spinal cord before <kw>antibodies</kw> can stop it. The damage is permanent ‚Äî Roosevelt never walks again. He hides his disability, becomes president, and launches the campaign that funds the polio <kw>vaccine</kw>.',kw:['pathogen','white blood cells','immune response','antibody','vaccine']},
med:{t:'Franklin Roosevelt is 39 years old ‚Äî strong and active ‚Äî when a deadly <kw>pathogen</kw> slips into his body. The polio virus races straight for his spinal cord, targeting the nerve cells that control his legs. His <kw>white blood cells</kw> detect the invader and launch an <kw>immune response</kw>, but there is a problem. The virus multiplies faster than his body can produce <kw>antibodies</kw> to stop it. By the time his defenses catch up, the nerve damage is done ‚Äî Roosevelt is paralyzed from the waist down for life. He hides his disability from the public, leads America through war, and starts the fundraising campaign that eventually pays for the polio <kw>vaccine</kw> ‚Äî but he dies ten years before it is ready.',kw:['pathogen','white blood cells','immune response','antibody','vaccine']},
high:{t:'Franklin Roosevelt is 39 years old ‚Äî strong, active, and dreaming of the presidency ‚Äî when a deadly <kw>pathogen</kw> invades his body without warning. The polio virus does not attack his lungs or his stomach. It races straight for his spinal cord, targeting the nerve cells that send movement signals to his legs. His <kw>white blood cells</kw> detect the invader and launch a massive <kw>immune response</kw>, flooding the area with defenders. But the body has a weakness: it takes time to identify a new <kw>pathogen</kw> and build the right <kw>antibodies</kw>. During that delay, the virus destroys nerve cell after nerve cell. By the time his <kw>antibodies</kw> finally match the virus, the damage is permanent ‚Äî Roosevelt never walks again.',kw:['pathogen','white blood cells','immune response','antibody','vaccine']}
},ws:['Polio virus swarms spinal cord','WBC rush in ‚Äî antibodies too slow','Spinal cord damaged, legs gray out']},

{id:2,name:"Lincoln's Hidden Illness",emoji:"üé©",brief:"Lincoln got smallpox around his most famous speech.",organ:"skin",outcome:"win",oe:"‚úÖ",wh:"Smallpox caused fever and rash",resp:"WBC produced antibodies over weeks",conn:"Immune response won after weeks",mt:75,
passages:{
low:{t:'Abraham Lincoln delivers the Gettysburg Address in 1863 ‚Äî one of the most famous speeches in American history. Days later, a <kw>pathogen</kw> hits him hard: smallpox. His <kw>white blood cells</kw> mount an <kw>immune response</kw>, producing <kw>antibodies</kw> that fight the virus for weeks. Lincoln survives, but smallpox kills about 30% of the people it infects ‚Äî his doctor hides the diagnosis to prevent nationwide panic.',kw:['pathogen','white blood cells','immune response','antibody']},
med:{t:'It is November 1863, and Abraham Lincoln has just delivered the Gettysburg Address ‚Äî 272 words that will be remembered forever. But a dangerous <kw>pathogen</kw> is already inside him. Smallpox attacks his body with <kw>fever</kw>, rashes, and deep exhaustion. His <kw>white blood cells</kw> fight back with a full <kw>immune response</kw>, producing <kw>antibodies</kw> to target the virus. The battle takes weeks, and Lincoln\'s doctor tells no one ‚Äî if the country finds out the president is dying, panic will spread faster than the disease. Lincoln\'s body wins.',kw:['pathogen','white blood cells','immune response','antibody','fever']},
high:{t:'On November 19, 1863, Abraham Lincoln stands before a crowd and delivers the Gettysburg Address ‚Äî 272 words that will become one of the most famous speeches in history. What no one knows is that a deadly <kw>pathogen</kw> is already multiplying inside the president\'s body. Within days, Lincoln is covered in rashes, burning with <kw>fever</kw>, and barely able to stand. Smallpox kills about 30% of the people it touches. Lincoln\'s <kw>white blood cells</kw> launch an all-out <kw>immune response</kw>, identifying the virus and producing <kw>antibodies</kw> to fight it. His doctor hides the diagnosis from the entire country. It takes weeks, but Lincoln\'s <kw>immune response</kw> wins ‚Äî his body clears the virus. He survives to lead the country through the war.',kw:['pathogen','white blood cells','immune response','antibody','fever','vaccine']}
},ws:['Smallpox spreads ‚Äî fever burns','WBC fight back, antibodies build','Body clears the virus ‚Äî survival']},

{id:3,name:"Roald Dahl's Loss",emoji:"üìñ",brief:"Dahl lost his daughter Olivia to measles in 1962.",organ:"brain",outcome:"lose",oe:"‚ùå",wh:"Measles caused deadly brain swelling",resp:"WBC could not build antibodies fast enough",conn:"Pathogen won ‚Äî too fast for defenses",mt:5,
passages:{
low:{t:'Roald Dahl\'s daughter Olivia is seven years old when the measles <kw>pathogen</kw> enters her body in 1962. Her <kw>white blood cells</kw> launch an <kw>immune response</kw>, but the virus causes deadly swelling in her brain. Her body cannot produce <kw>antibodies</kw> fast enough ‚Äî Olivia dies within hours. Dahl spends the rest of his life urging parents to get the measles <kw>vaccine</kw> for their children.',kw:['pathogen','white blood cells','immune response','antibody','vaccine']},
med:{t:'It is 1962, and seven-year-old Olivia Dahl seems to be recovering from a normal case of measles. Then the <kw>pathogen</kw> does something sudden ‚Äî it crosses into her brain. The measles virus causes her brain to swell, a condition called encephalitis. Her <kw>white blood cells</kw> launch an <kw>immune response</kw>, but the <kw>infection</kw> moves too fast. Olivia\'s body cannot build enough <kw>antibodies</kw> in time, and she dies within twelve hours. Her father Roald Dahl ‚Äî author of Charlie and the Chocolate Factory ‚Äî spends decades urging parents to get the measles <kw>vaccine</kw>.',kw:['pathogen','white blood cells','immune response','antibody','infection','vaccine']},
high:{t:'In 1962, seven-year-old Olivia Dahl catches measles ‚Äî the same <kw>pathogen</kw> that millions of children get every year. At first, it looks like a normal <kw>infection</kw>: fever, rash, tired eyes. Her <kw>white blood cells</kw> begin the usual <kw>immune response</kw>. But the measles <kw>pathogen</kw> does something rare ‚Äî it crosses into Olivia\'s brain. The virus triggers massive swelling called encephalitis, and her brain begins to shut down. Her body races to produce <kw>antibodies</kw>, but the damage is too fast. Olivia dies within twelve hours. Her father writes public letters for decades urging parents to get the measles <kw>vaccine</kw>.',kw:['pathogen','white blood cells','immune response','antibody','infection','vaccine']}
},ws:['Measles crosses into the brain','Brain swells ‚Äî encephalitis','Antibodies too slow ‚Äî pathogen wins']},

{id:4,name:"Candy Land's Origin",emoji:"üé≤",brief:"Eleanor Abbott invented Candy Land in a polio ward.",organ:"spine",outcome:"warn",oe:"‚ö†Ô∏è",wh:"Polio destroyed spinal cord nerves",resp:"WBC stopped virus but nerves already gone",conn:"Body survived but damage permanent",mt:35,
passages:{
low:{t:'Eleanor Abbott is a young woman when the polio <kw>pathogen</kw> attacks her spinal cord and leaves her paralyzed. Her <kw>immune response</kw> fights the virus, but her <kw>white blood cells</kw> cannot save the nerves the virus already destroyed. She ends up in a hospital ward in 1945, surrounded by children whose bodies lost the same battle. She invents the board game Candy Land for those kids ‚Äî it becomes one of the best-selling games in history.',kw:['pathogen','immune response','white blood cells']},
med:{t:'The year is 1945, and Eleanor Abbott lies in a hospital bed in San Diego. The polio <kw>pathogen</kw> attacked her spinal cord, and her <kw>white blood cells</kw> launched a full <kw>immune response</kw> ‚Äî producing <kw>antibodies</kw> that eventually stopped the virus. But the virus destroyed too many nerve cells before her defenses could win. Abbott survived, but she cannot walk. Around her, the ward is full of children who will never run again. So Abbott invents Candy Land, one of the best-selling games in American history.',kw:['pathogen','white blood cells','immune response','antibody']},
high:{t:'In a San Diego hospital ward in 1945, rows of children lie in beds they may never leave. Every one of them fought the same invisible battle ‚Äî the polio <kw>pathogen</kw> invaded their spinal cords, and their <kw>white blood cells</kw> launched an <kw>immune response</kw> as fast as they could. For most, the body produced <kw>antibodies</kw> that eventually stopped the virus. But polio does not need to win the whole war to do permanent damage. If the virus destroys enough nerve cells before the <kw>antibodies</kw> arrive, the signals from brain to muscle are cut forever. Eleanor Abbott is one of these patients ‚Äî her body beat the <kw>pathogen</kw>, but her legs will never work again. She invents Candy Land for those kids ‚Äî born in a polio ward, it becomes one of the best-selling games in history.',kw:['pathogen','white blood cells','immune response','antibody']}
},ws:['Polio attacks spinal cord nerves','WBC fight ‚Äî antibodies arrive','Virus stopped but nerve damage stays']},

{id:5,name:"Patterson's Superbug",emoji:"üö¢",brief:"Tom Patterson caught a superbug on a cruise in Egypt.",organ:"abdomen",outcome:"win",oe:"‚úÖ",wh:"Superbug resisted all antibiotics",resp:"Phage therapy + WBC destroyed bacteria",conn:"Experimental help let immune response win",mt:70,
passages:{
low:{t:'Tom Patterson gets stomach cramps on a cruise in Egypt in 2015. Doctors find a massive <kw>infection</kw> caused by a superbug ‚Äî a <kw>pathogen</kw> that resists almost every antibiotic. His <kw>white blood cells</kw> launch an <kw>immune response</kw>, but the bacteria are too strong and his <kw>fever</kw> spikes dangerously. His wife, a scientist, finds an experimental treatment using viruses that eat bacteria ‚Äî and it saves his life.',kw:['pathogen','white blood cells','immune response','infection','fever']},
med:{t:'In 2015, Tom Patterson is on a cruise on the Nile River when he feels stomach cramps. Doctors discover a grapefruit-sized <kw>infection</kw> ‚Äî caused by a superbug <kw>pathogen</kw> that resists nearly every antibiotic on Earth. His <kw>immune response</kw> kicks in, and his <kw>white blood cells</kw> fight hard, but the bacteria are too powerful. Patterson\'s <kw>fever</kw> spikes and his organs start to fail. His wife convinces doctors to try phage therapy ‚Äî using special viruses that eat bacteria. The treatment destroys the superbug, and Patterson\'s <kw>immune response</kw> finishes the job.',kw:['pathogen','white blood cells','immune response','infection','fever']},
high:{t:'It is Thanksgiving 2015, and Tom Patterson is on a cruise on the Nile River in Egypt when he doubles over with stomach pain. Doctors find a grapefruit-sized <kw>infection</kw> caused by a superbug <kw>pathogen</kw> called Acinetobacter baumannii. This <kw>pathogen</kw> resists almost every antibiotic that exists. Patterson\'s <kw>white blood cells</kw> launch a full <kw>immune response</kw>, and his <kw>fever</kw> burns as his body tries to fight back, but the bacteria multiply too fast. His organs begin to fail. Then his wife finds phage therapy ‚Äî special viruses designed to eat bacteria. The phages destroy the superbug\'s defenses, and his <kw>white blood cells</kw> finally overwhelm the weakened bacteria. Patterson makes a full recovery.',kw:['pathogen','white blood cells','immune response','infection','fever']}
},ws:['Superbug resists all defenses','Phage therapy breaks shields','WBC overwhelm weakened bacteria']},

{id:6,name:"Philadelphia, 1793",emoji:"üíÄ",brief:"Yellow fever killed 10% of the city in one summer.",organ:"liver",outcome:"win",oe:"‚úÖ",wh:"Yellow fever attacked liver and blood",resp:"90% survived ‚Äî antibodies won",conn:"Survivors became immune for life",mt:72,
passages:{
low:{t:'In the summer of 1793, the yellow fever <kw>pathogen</kw> tears through Philadelphia, the nation\'s capital. The virus attacks people\'s livers and blood, causing <kw>fever</kw>, bleeding, and organ failure. About 5,000 people die ‚Äî roughly 10% of the city ‚Äî but the other 90% survive because their <kw>immune response</kw> produces enough <kw>antibodies</kw> to beat the virus. Survivors become immune for life, but no one knows that mosquitoes are spreading the <kw>infection</kw>.',kw:['pathogen','immune response','antibody','fever','infection']},
med:{t:'Philadelphia in 1793 is the capital of the United States ‚Äî and a <kw>pathogen</kw> is about to destroy it. The yellow fever virus arrives with mosquitoes from the Caribbean, and the <kw>infection</kw> spreads like wildfire. The virus attacks the liver and blood vessels, causing <kw>fever</kw>, bleeding, and organ failure. People die so fast that bodies pile up and the government flees. But 90% who survive have their <kw>immune response</kw> produce <kw>antibodies</kw> strong enough to beat the virus ‚Äî those survivors become immune for life.',kw:['pathogen','immune response','antibody','fever','infection']},
high:{t:'In the summer of 1793, Philadelphia is the capital of the United States ‚Äî home to 50,000 people. Then a deadly <kw>pathogen</kw> arrives: the yellow fever virus, carried by mosquitoes. The <kw>infection</kw> spreads at alarming speed, attacking the liver and blood vessels and causing <kw>fever</kw>, internal bleeding, and organ failure. Roughly 5,000 people ‚Äî about 10% of the city ‚Äî are killed in a single summer. But the other 90% survive, and their survival reveals something powerful. Their <kw>white blood cells</kw> identified the <kw>pathogen</kw>, produced <kw>antibodies</kw> to fight it, and won. Every survivor walks away with lifelong immunity ‚Äî their bodies remember the virus forever.',kw:['pathogen','immune response','antibody','fever','infection','white blood cells']}
},ws:['Yellow fever attacks liver','Fever burns ‚Äî body fights back','Antibodies win ‚Äî lifetime immunity']},

{id:7,name:"NYC Measles Outbreak",emoji:"ü¶†",brief:"Unvaccinated boy started a 1,000+ case outbreak.",organ:"whole",outcome:"win",oe:"‚úÖ",wh:"Measles spread ‚Äî no vaccine = no antibodies",resp:"Body started from zero but eventually won",conn:"Slow start let outbreak spread first",mt:65,
passages:{
low:{t:'In 2019, an unvaccinated eight-year-old boy in Brooklyn catches measles from someone who walked through his school hours earlier. The measles <kw>pathogen</kw> enters his body, and his <kw>immune response</kw> starts from zero ‚Äî he has no <kw>antibodies</kw> ready because he never got the <kw>vaccine</kw>. His <kw>white blood cells</kw> scramble to identify the virus, but the <kw>infection</kw> has already spread to other kids. His body eventually fights off the virus, but the outbreak grows to over 1,000 cases.',kw:['pathogen','immune response','antibody','vaccine','white blood cells','infection']},
med:{t:'It takes just one sick person walking through a school hallway. In 2019, an unvaccinated eight-year-old boy in Brooklyn breathes in the measles <kw>pathogen</kw> ‚Äî a virus so contagious it hangs in the air for two hours. Because he never received the <kw>vaccine</kw>, his body has zero <kw>antibodies</kw> ready. His <kw>white blood cells</kw> detect the virus and launch an <kw>immune response</kw>, but they start from scratch. That delay gives the virus time to multiply and spread to other unvaccinated kids. His body eventually wins, but the outbreak grows to over 1,000 cases.',kw:['pathogen','immune response','antibody','vaccine','white blood cells','infection']},
high:{t:'In 2019, an unvaccinated eight-year-old boy walks into his school in Brooklyn ‚Äî not knowing the measles <kw>pathogen</kw> is floating in the hallway air. Measles is one of the most contagious <kw>infections</kw> in history: one sick person can spread it to 18 unvaccinated people, and the virus survives in the air for two hours. Because he never received the <kw>vaccine</kw>, his body has zero <kw>antibodies</kw> waiting. His <kw>white blood cells</kw> detect the invader and begin building brand-new <kw>antibodies</kw>, but that takes days. During those days, the virus spreads to dozens of other children. His body eventually produces enough <kw>antibodies</kw> to clear the virus, but the outbreak grows to over 1,000 cases ‚Äî the largest in the U.S. in nearly 30 years.',kw:['pathogen','immune response','antibody','vaccine','white blood cells','infection']}
},ws:['No vaccine = starting from zero','WBC slowly build new antibodies','Body wins but outbreak already spread']},

{id:8,name:"The Mystery Paralysis",emoji:"üî¨",brief:"Children struck by a polio-like illness in 2014.",organ:"spine",outcome:"warn",oe:"‚ö†Ô∏è",wh:"New virus attacked spinal cord like polio",resp:"WBC launched defense but too slow",conn:"Nerves destroyed before antibodies ready",mt:20,
passages:{
low:{t:'In 2014, twenty children in California suddenly cannot move their arms or legs. Doctors test for polio, but the <kw>pathogen</kw> is something new ‚Äî a virus called enterovirus D68 that attacks the spinal cord the same way. The children\'s <kw>white blood cells</kw> launch an <kw>immune response</kw>, but the <kw>infection</kw> destroys nerves before <kw>antibodies</kw> can stop it. Even "conquered" diseases can come back in new forms.',kw:['pathogen','white blood cells','immune response','antibody','infection']},
med:{t:'In 2014, something unexpected happens ‚Äî twenty children in California suddenly lose the ability to move their arms or legs. Doctors test for polio, but results are negative. The real <kw>pathogen</kw> is enterovirus D68, and it attacks the spinal cord the exact same way polio does. The children\'s <kw>white blood cells</kw> mount an <kw>immune response</kw>, producing <kw>antibodies</kw> to fight the <kw>infection</kw>, but the virus destroys nerves faster than the body can defend them. Waves of this mystery paralysis strike children across the United States.',kw:['pathogen','white blood cells','immune response','antibody','infection']},
high:{t:'In 2014, parents across California get a scary phone call ‚Äî their children have suddenly lost the ability to move their arms or legs. Doctors suspect polio, but every test is negative. The real culprit is a different <kw>pathogen</kw>: enterovirus D68, a virus that attacks the spinal cord in the exact same way as polio. The children\'s <kw>white blood cells</kw> detect the <kw>infection</kw> and launch an <kw>immune response</kw>, racing to produce <kw>antibodies</kw>. But the virus destroys nerve cells faster than the body can build defenses. The result is devastating paralysis that may never be reversed. It is a chilling reminder that <kw>pathogens</kw> can evolve into new forms the body has never seen.',kw:['pathogen','white blood cells','immune response','antibody','infection']}
},ws:['New virus attacks spinal cord','WBC rush in ‚Äî antibodies building','Nerves destroyed before defenses ready']}
];

const KW=['pathogen','immune response','antibody','white blood cells','vaccine','fever','infection'];

// ============ STATE ============
let S={cur:null,step:null,rl:'low',done:[],preds:{},score:0,streak:0,tp:0,cp:0,rows:[],spk:false,spkU:null,spkI:null};

// ============ INIT ============
function init(){renderCards();renderKW([]);updateHUD();}

function renderCards(){
const el=document.getElementById('scenarioList');el.innerHTML='';
SC.forEach(sc=>{
const d=document.createElement('div');
d.className='scenario-card'+(S.done.includes(sc.id)?' completed':'')+(S.cur&&S.cur.id===sc.id?' active':'');
d.innerHTML=`<span class="sc-emoji">${sc.emoji}</span><span class="sc-name">${sc.name}<small>${sc.brief}</small></span><span class="sc-check">‚úÖ</span>`;
d.onclick=()=>selectSc(sc);el.appendChild(d);
});
}

function renderKW(hl){
const el=document.getElementById('keyWordsList');el.innerHTML='';
KW.forEach(k=>{
const s=document.createElement('span');
s.className='kw-item'+(hl.some(h=>k.toLowerCase().includes(h.toLowerCase())||h.toLowerCase().includes(k.toLowerCase()))?' highlighted':'');
s.textContent=k;el.appendChild(s);
});
}

// ============ SELECT ============
function selectSc(sc){
stopSp();S.cur=sc;S.step='predict';renderCards();updateTabs();showPredict();
const p=sc.passages[S.rl];renderKW(p.kw);
}

function setLevel(lv){
S.rl=lv;document.querySelectorAll('.rl-btn').forEach(b=>b.classList.toggle('active',b.dataset.level===lv));
if(S.cur&&S.step==='read')showRead();
if(S.cur){renderKW(S.cur.passages[S.rl].kw);}
}

// ============ TABS ============
function updateTabs(){
const order=['predict','read','watch','record'];
document.querySelectorAll('.step-tab').forEach(t=>{
const s=t.dataset.step;t.classList.remove('active','done');
if(s===S.step)t.classList.add('active');
else if(S.step&&order.indexOf(s)<order.indexOf(S.step))t.classList.add('done');
});
}

// ============ PREDICT ============
function showPredict(){
const sc=S.cur,mc=document.getElementById('mainContent');
mc.innerHTML=`<div class="predict-box fade-in"><div class="predict-question">What do you predict will happen?</div><div class="predict-premise">${sc.emoji} ${sc.brief}</div><div class="predict-options"><button class="predict-btn" onclick="mkPred('win',this)">‚úÖ Body wins</button><button class="predict-btn" onclick="mkPred('warn',this)">‚ö†Ô∏è Body wins but damage</button><button class="predict-btn" onclick="mkPred('lose',this)">‚ùå Pathogen wins</button></div></div>`;
showAB(false);
}

function mkPred(p,btn){
document.querySelectorAll('.predict-btn').forEach(b=>b.classList.remove('selected'));
btn.classList.add('selected');S.preds[S.cur.id]=p;
showAB(true,'Continue to Read ‚Üí');
document.getElementById('mainActionBtn').onclick=()=>{S.step='read';updateTabs();showRead();};
}

// ============ READ ============
function showRead(){
const sc=S.cur,p=sc.passages[S.rl];
let html=p.t.replace(/<kw>(.*?)<\/kw>/g,'<span class="kw-inline">$1</span>');
let sents=html.split(/(?<=[.!?])\s+/);
html=sents.map((s,i)=>`<span class="sentence" data-idx="${i}">${s} </span>`).join('');
document.getElementById('mainContent').innerHTML=`<div class="read-box fade-in"><div class="passage-card" id="passageCard">${html}</div></div>`;
showAB(true,'Continue to Watch ‚Üí');showRA(true);
document.getElementById('mainActionBtn').onclick=()=>{stopSp();S.step='watch';updateTabs();showWatch();};
}

// ============ READ ALOUD ============
function toggleReadAloud(){
try{
if(S.spk){stopSp();return;}
if(!window.speechSynthesis){document.getElementById('readAloudBtn').textContent='üìñ Text Only';return;}
const p=S.cur.passages[S.rl];let txt=p.t.replace(/<kw>(.*?)<\/kw>/g,'$1');
let sents=txt.split(/(?<=[.!?])\s+/);S.spk=true;
document.getElementById('readAloudBtn').textContent='‚èπÔ∏è Stop';
spkSents(sents,0);
}catch(e){S.spk=false;}
}

function spkSents(sents,i){
if(!S.spk||i>=sents.length){stopSp();return;}
try{
document.querySelectorAll('.sentence').forEach(s=>s.classList.remove('speaking'));
const el=document.querySelector(`.sentence[data-idx="${i}"]`);
if(el){el.classList.add('speaking');el.scrollIntoView({behavior:'smooth',block:'nearest'});}
const u=new SpeechSynthesisUtterance(sents[i]);u.rate=0.9;
u.onend=()=>spkSents(sents,i+1);u.onerror=()=>spkSents(sents,i+1);
window.speechSynthesis.cancel();window.speechSynthesis.speak(u);
clearInterval(S.spkI);S.spkI=setInterval(()=>{try{if(window.speechSynthesis.speaking)window.speechSynthesis.resume();}catch(e){}},10000);
}catch(e){stopSp();}
}

function stopSp(){
S.spk=false;try{clearInterval(S.spkI);if(window.speechSynthesis)window.speechSynthesis.cancel();}catch(e){}
document.querySelectorAll('.sentence').forEach(s=>s.classList.remove('speaking'));
const b=document.getElementById('readAloudBtn');if(b)b.textContent='üîä Read Aloud';
}

// ============ WATCH ============
function showWatch(){
const sc=S.cur;showRA(false);showAB(false);
document.getElementById('mainContent').innerHTML=`<div class="watch-box fade-in"><div class="body-arena" id="bodyArena"><div class="anim-step-label" id="animLabel"></div></div><div class="defense-meter"><div class="ok-zone"></div><div class="meter-fill" id="meterFill" style="width:50%;background:linear-gradient(90deg,#ff8800,#ffcc00)"></div></div><div class="meter-labels"><span class="red-label">Pathogen Winning</span><span class="green-label">OK Zone</span><span class="blue-label">Body Winning</span></div><div class="watch-label">Watch the Body Defense Meter...</div></div>`;
runAnim(sc);
}

function runAnim(sc){
const arena=document.getElementById('bodyArena'),lbl=document.getElementById('animLabel');
drawBody(arena,sc.organ);
const steps=sc.ws;let si=0;
function next(){
if(si>=steps.length){
setTimeout(()=>{
setMeter(sc.mt);
lbl.textContent=sc.outcome==='win'?'‚úÖ Body wins!':sc.outcome==='warn'?'‚ö†Ô∏è Survived but damaged':'‚ùå Pathogen wins';
lbl.style.color=sc.outcome==='win'?'#27ae60':sc.outcome==='warn'?'#f39c12':'#e74c3c';
setTimeout(()=>{S.step='record';updateTabs();showRecord();},1800);
},400);return;
}
lbl.textContent=steps[si];lbl.style.color='#7ecfff';
if(si===0){spawnP(arena,'pathogen',14,sc.organ);setMeter(20);}
else if(si===1){spawnP(arena,'wbc',10,sc.organ);setMeter(sc.mt<50?28:55);}
else{
if(sc.outcome==='win'){fadeP(arena,'pathogen');setMeter(sc.mt);}
else{setMeter(sc.mt);dimOrg(arena);}
}
si++;setTimeout(next,2400);
}
setTimeout(()=>{if(S.step==='watch'){S.step='record';updateTabs();showRecord();}},14000);
setTimeout(next,700);
}

function setMeter(p){
const f=document.getElementById('meterFill');if(!f)return;
f.style.width=p+'%';
if(p<30)f.style.background='linear-gradient(90deg,#cc0000,#ff4444)';
else if(p<55)f.style.background='linear-gradient(90deg,#ff8800,#ffcc00)';
else f.style.background='linear-gradient(90deg,#44aa44,#44ccff)';
}

function drawBody(arena,organ){
const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
svg.setAttribute('viewBox','0 0 140 280');
svg.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:130px;height:260px;opacity:.8;z-index:1;';
svg.innerHTML=`<ellipse cx="70" cy="32" rx="20" ry="26" fill="rgba(42,100,160,.2)" stroke="#2a6490" stroke-width="1.5"/><rect x="50" y="56" width="40" height="65" rx="10" fill="rgba(42,100,160,.15)" stroke="#2a6490" stroke-width="1.5"/><rect x="54" y="121" width="14" height="75" rx="6" fill="rgba(42,100,160,.12)" stroke="#2a6490" stroke-width="1.2"/><rect x="72" y="121" width="14" height="75" rx="6" fill="rgba(42,100,160,.12)" stroke="#2a6490" stroke-width="1.2"/><rect x="28" y="60" width="12" height="50" rx="5" fill="rgba(42,100,160,.12)" stroke="#2a6490" stroke-width="1.2" transform="rotate(-8 34 85)"/><rect x="100" y="60" width="12" height="50" rx="5" fill="rgba(42,100,160,.12)" stroke="#2a6490" stroke-width="1.2" transform="rotate(8 106 85)"/>`;
arena.appendChild(svg);
const OP={brain:{x:'46%',y:'6%',w:30,h:30,l:'Brain',lx:'60%',ly:'4%'},spine:{x:'47%',y:'32%',w:14,h:55,l:'Spine',lx:'62%',ly:'32%'},skin:{x:'37%',y:'20%',w:38,h:45,l:'Skin',lx:'60%',ly:'18%'},liver:{x:'42%',y:'30%',w:26,h:22,l:'Liver',lx:'60%',ly:'28%'},abdomen:{x:'44%',y:'35%',w:24,h:24,l:'Abdomen',lx:'60%',ly:'34%'},whole:{x:'40%',y:'20%',w:32,h:55,l:'Whole Body',lx:'60%',ly:'18%'}};
const o=OP[organ]||OP.whole;
const z=document.createElement('div');z.id='organZone';
z.style.cssText=`position:absolute;left:${o.x};top:${o.y};width:${o.w}px;height:${o.h}px;background:radial-gradient(circle,rgba(255,68,68,.3),transparent);box-shadow:0 0 20px rgba(255,68,68,.2);border-radius:50%;z-index:2;transition:all .5s;`;
arena.appendChild(z);
const lb=document.createElement('div');lb.className='organ-label';lb.textContent=o.l;
lb.style.cssText=`left:${o.lx};top:${o.ly};`;arena.appendChild(lb);
// ambient glow
const g=document.createElement('div');
g.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:180px;height:180px;border-radius:50%;background:radial-gradient(circle,rgba(42,100,160,.06),transparent);z-index:0;animation:pulse 3s infinite;';
arena.appendChild(g);
}

function spawnP(arena,type,n,organ){
const OC={brain:{cx:50,cy:14},spine:{cx:50,cy:42},skin:{cx:50,cy:32},liver:{cx:48,cy:38},abdomen:{cx:50,cy:42},whole:{cx:50,cy:38}};
const c=OC[organ]||OC.whole;
for(let i=0;i<n;i++){
const p=document.createElement('div');const sz=type==='wbc'?9:6;
p.className='particle '+type;
const ox=c.cx+(Math.random()-.5)*28,oy=c.cy+(Math.random()-.5)*28;
p.style.cssText=`width:${sz}px;height:${sz}px;left:${ox}%;top:${oy}%;z-index:3;opacity:0;transition:all .7s;`;
arena.appendChild(p);
setTimeout(()=>{p.style.opacity='1';p.style.left=(ox+(Math.random()-.5)*8)+'%';p.style.top=(oy+(Math.random()-.5)*8)+'%';},40+i*60);
}
}

function fadeP(arena,type){arena.querySelectorAll('.particle.'+type).forEach(p=>{p.style.opacity='0';p.style.transform='scale(.2)';setTimeout(()=>p.remove(),800);});}

function dimOrg(arena){const z=document.getElementById('organZone');if(z){z.style.background='radial-gradient(circle,rgba(100,100,100,.4),transparent)';z.style.boxShadow='0 0 10px rgba(100,100,100,.2)';}}

// ============ RECORD ============
function showRecord(){
const sc=S.cur;showRA(false);
const pred=S.preds[sc.id];S.tp++;
const correct=pred===sc.outcome;
if(correct){S.cp++;S.streak++;S.score+=100+(S.streak>1?S.streak*20:0);}
else{S.streak=0;S.score+=50;}
if(!S.done.includes(sc.id)){
S.done.push(sc.id);
S.rows.push({sc:sc.name,wh:sc.wh,resp:sc.resp,conn:sc.conn,out:sc.oe});
}
updateHUD();renderDT();renderCards();
const c=S.done.length;
document.getElementById('mainContent').innerHTML=`<div class="record-box fade-in"><span class="record-emoji">${correct?'üéØ':'üìù'}</span><h3>${correct?'Correct Prediction!':'Data Recorded!'}</h3><p>${correct?'+'+(100+(S.streak>1?S.streak*20:0))+' points (streak: '+S.streak+'!)':'+50 points ‚Äî answer was '+sc.oe}</p><p style="margin-top:10px;font-size:12px;">${c<5?(5-c)+' more to go!':c===5?'Required complete! Extra credit?':c<8?(8-c)+' more for extra credit!':'All 8 complete! üèÜ'}</p></div>`;
showAB(true,'Pick Next Story');
document.getElementById('mainActionBtn').onclick=()=>{S.cur=null;S.step=null;updateTabs();showWB();};
if(c===5)setTimeout(()=>showComp('Required Complete! üéâ','You finished 5 stories. Continue for extra credit?'),1400);
else if(c===8)setTimeout(()=>showComp('Extra Credit Complete! üèÜ','All 8 stories done. Amazing work!'),1400);
}

// ============ HUD ============
function updateHUD(){
document.getElementById('hudScore').textContent=S.score;
document.getElementById('hudStreak').textContent=S.streak;
const c=S.done.length;
document.getElementById('hudCompleted').textContent=c+'/5';
document.getElementById('hudAccuracy').textContent=S.tp>0?Math.round(S.cp/S.tp*100)+'%':'--%';
document.getElementById('progressFill').style.width=Math.min(c/5*100,100)+'%';
const pm=document.getElementById('progressMsg');
if(c===0)pm.textContent='Pick your first story!';
else if(c<5)pm.textContent=c+' done! '+(5-c)+' more to go!';
else if(c<8)pm.textContent='‚úÖ Required done! '+(8-c)+' more = extra credit';
else pm.textContent='üèÜ All 8 complete!';
document.getElementById('pickSub').textContent=c<5?'Choose 5 of 8 ‚Äî '+(5-c)+' more!':c<8?'Extra credit: '+(8-c)+' more!':'All 8 complete!';
}

function renderDT(){
const b=document.getElementById('dataBody'),em=document.getElementById('emptyData');
b.innerHTML='';
if(S.rows.length===0){em.style.display='block';return;}
em.style.display='none';
S.rows.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.sc}</td><td>${r.wh}</td><td>${r.resp}</td><td>${r.conn}</td><td class="outcome-cell">${r.out}</td>`;b.appendChild(tr);});
}

// ============ COPY ============
function copyTable(){
try{
let t='Scenario\tWhat Happened?\tPerson/Situation Response\tConnection to Immune Response?\tOutcome\n';
S.rows.forEach(r=>{t+=r.sc+'\t'+r.wh+'\t'+r.resp+'\t'+r.conn+'\t'+r.out+'\n';});
navigator.clipboard.writeText(t).then(()=>{cpFB();}).catch(()=>{fbCopy(t);});
}catch(e){}
}
function fbCopy(t){try{const a=document.createElement('textarea');a.value=t;document.body.appendChild(a);a.select();document.execCommand('copy');document.body.removeChild(a);cpFB();}catch(e){}}
function cpFB(){const b=document.getElementById('copyBtn');b.textContent='‚úÖ Copied!';setTimeout(()=>b.textContent='üìã Copy Table',2000);}

// ============ UI HELPERS ============
function showAB(show,txt){const b=document.getElementById('mainActionBtn');if(show){b.classList.remove('hidden');if(txt)b.textContent=txt;}else b.classList.add('hidden');}
function showRA(show){const b=document.getElementById('readAloudBtn');if(show)b.classList.remove('hidden');else b.classList.add('hidden');}

function showWB(){
const c=S.done.length;
document.getElementById('mainContent').innerHTML=`<div class="welcome-screen fade-in"><span class="welcome-icon">üîç</span><h2>${c<5?'Pick Your Next Story':c<8?'Extra Credit ‚Äî Keep Going!':'All Stories Complete!'}</h2><p>${c<5?'You\'ve completed '+c+' stories. Pick another from the left!':c<8?'You finished the required 5! Complete '+(8-c)+' more for extra credit.':'Amazing work! All 8 case files done.'}</p></div>`;
showAB(false);showRA(false);renderKW([]);
}

function showComp(title,msg){
document.getElementById('completionTitle').textContent=title;
document.getElementById('completionMsg').textContent=msg;
document.getElementById('completionOverlay').classList.add('show');
}
function dismissCompletion(){document.getElementById('completionOverlay').classList.remove('show');}

function resetSim(){
stopSp();S={cur:null,step:null,rl:S.rl,done:[],preds:{},score:0,streak:0,tp:0,cp:0,rows:[],spk:false,spkU:null,spkI:null};
renderCards();renderDT();updateHUD();renderKW([]);
document.getElementById('mainContent').innerHTML=`<div class="welcome-screen fade-in"><span class="welcome-icon">üõ°Ô∏è</span><h2>Medical Investigator</h2><p>Real people ‚Äî presidents, authors, kids ‚Äî all fought invisible wars inside their own bodies. Read their true stories and track how their immune systems responded.</p><p style="font-size:12px;color:#5a8ab5;">Pick any story from the left to begin.</p></div>`;
showAB(false);showRA(false);updateTabs();
}
function newRun(){resetSim();}

init();
</script>
</body>
</html>
