<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation Heart Performance and Training</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#0a0a1a;color:#e0e0e0;overflow:hidden;height:100vh}
.game{display:grid;grid-template-columns:240px 1fr 260px;grid-template-rows:52px 1fr;gap:6px;padding:6px;height:100vh}

/* TOP BAR */
.top{grid-column:1/-1;background:linear-gradient(135deg,#121230,#1a1040);border-radius:14px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(124,77,255,0.15);box-shadow:0 2px 20px rgba(0,0,0,0.3)}
.top h1{font-size:16px;font-weight:800;background:linear-gradient(90deg,#ff6b6b,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.top .mission{font-size:11px;color:#888;letter-spacing:0.5px}
.round-pill{background:linear-gradient(135deg,#e94560,#c23152);color:#fff;padding:5px 16px;border-radius:20px;font-weight:800;font-size:13px;box-shadow:0 2px 12px rgba(233,69,96,0.3)}

/* LEFT PANEL */
.left{background:linear-gradient(180deg,#0f1535,#0c1028);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:6px;border:1px solid rgba(255,255,255,0.04);overflow-y:auto}
.sec-lbl{font-size:9px;text-transform:uppercase;letter-spacing:2px;color:#667;padding:0 4px}
.grp{background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,0.04)}
.grp h3{font-size:11px;color:#7c9fff;margin-bottom:5px;font-weight:700}
.btns{display:flex;flex-wrap:wrap;gap:4px}
.vb{padding:5px 0;border:2px solid rgba(255,255,255,0.08);border-radius:8px;background:rgba(255,255,255,0.02);color:#ccc;font-size:10px;cursor:pointer;transition:all 0.25s;font-weight:700;flex:1;min-width:50px;text-align:center;user-select:none}
.vb:hover:not(.lk):not(.dis){background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.15)}
.vb.sel{background:linear-gradient(135deg,#00c853,#00a844);border-color:#00c853;color:#000;box-shadow:0 0 14px rgba(0,200,83,0.35)}
.vb.lk{opacity:0.2;cursor:not-allowed;border-style:dashed}
.vb.dis{opacity:0.35;cursor:not-allowed}
.guide{background:rgba(255,214,0,0.08);border:1px solid rgba(255,214,0,0.2);border-radius:8px;padding:6px;text-align:center;font-size:10px;color:#ffd600;font-weight:600;display:none}
.go-btn{width:100%;padding:11px;border:none;border-radius:10px;font-size:15px;font-weight:800;cursor:pointer;transition:all 0.25s;letter-spacing:0.5px;margin-top:auto}
.go-btn.rdy{background:linear-gradient(135deg,#00c853,#00bfa5);color:#000;box-shadow:0 4px 24px rgba(0,200,83,0.3)}
.go-btn.rdy:hover{transform:translateY(-1px);box-shadow:0 6px 28px rgba(0,200,83,0.4)}
.go-btn:disabled{background:#1a1a2e;color:#444;cursor:not-allowed;box-shadow:none}
.bot{display:flex;gap:5px;margin-top:4px}
.bot button{flex:1;padding:7px;border:none;border-radius:8px;font-size:10px;font-weight:700;cursor:pointer;transition:all 0.2s}
.rst-b{background:#e94560;color:#fff}
.new-b{background:#448aff;color:#fff}
.one-var-note{font-size:9px;color:#ff9800;text-align:center;padding:2px 4px;background:rgba(255,152,0,0.08);border-radius:6px;display:none}

/* ARENA */
.arena-wrap{position:relative;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);background:#080818}
.arena-wrap canvas{width:100%;height:100%;display:block}
.hud{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;padding:8px 10px;pointer-events:none;z-index:10}
.hi{background:rgba(8,8,24,0.85);border-radius:10px;padding:6px 12px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.06);text-align:center;min-width:90px}
.hi .hl{font-size:8px;text-transform:uppercase;letter-spacing:1.2px;color:#667}
.hi .hv{font-size:20px;font-weight:900;margin-top:1px}
.hr-c{color:#ff6b6b}.o2-c{color:#4dd0e1}.sc-c{color:#ffd600}.st-c{color:#ce93d8}
.amsg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:32px;font-weight:900;text-shadow:0 0 40px rgba(0,0,0,0.9);opacity:0;transition:opacity 0.4s;z-index:12;pointer-events:none;text-align:center}
.amsg.show{opacity:1}
.chal-ban{position:absolute;top:56px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ff6d00,#e94560);color:#fff;padding:6px 20px;border-radius:16px;font-weight:800;font-size:12px;z-index:15;display:none;animation:pls 1.2s infinite;box-shadow:0 0 20px rgba(255,109,0,0.4)}
@keyframes pls{0%,100%{opacity:1;transform:translateX(-50%) scale(1)}50%{opacity:0.8;transform:translateX(-50%) scale(1.04)}}
.badge-pop{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ffd600,#ff6d00);color:#000;padding:8px 20px;border-radius:16px;font-weight:800;font-size:13px;z-index:15;display:none;box-shadow:0 0 30px rgba(255,214,0,0.4)}
.unlock-t{position:absolute;top:42%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#7c4dff,#448aff);color:#fff;padding:10px 24px;border-radius:14px;font-weight:800;font-size:15px;z-index:30;display:none;box-shadow:0 0 40px rgba(124,77,255,0.5);text-align:center}
.pred-ov{position:absolute;inset:0;background:rgba(8,8,24,0.96);z-index:25;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:20px}
.pred-ov h2{font-size:22px;background:linear-gradient(90deg,#ff6b6b,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:900}
.pred-ov p{color:#888;font-size:13px}
.pred-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.pb{padding:14px 22px;border:2px solid rgba(255,255,255,0.08);border-radius:12px;background:rgba(255,255,255,0.03);color:#e0e0e0;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.25s;min-width:110px;text-align:center}
.pb:hover{border-color:#e94560;background:rgba(233,69,96,0.08)}
.pb.chos{border-color:#00c853;background:rgba(0,200,83,0.12);color:#00c853}

/* RIGHT PANEL */
.right{background:linear-gradient(180deg,#0f1535,#0c1028);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:6px;border:1px solid rgba(255,255,255,0.04);overflow-y:auto}
.pbar-w{background:rgba(255,255,255,0.04);border-radius:6px;height:8px;overflow:hidden}
.pbar-f{height:100%;background:linear-gradient(90deg,#00c853,#00bfa5);border-radius:6px;transition:width 0.5s;width:0%}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.sb{background:rgba(255,255,255,0.03);border-radius:8px;padding:6px;text-align:center;border:1px solid rgba(255,255,255,0.04)}
.sb .sn{font-size:18px;font-weight:900}
.sb .sl{font-size:8px;text-transform:uppercase;color:#667;letter-spacing:1px}
.cpb{background:linear-gradient(135deg,#448aff,#2979ff);color:#fff;border:none;padding:5px 10px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;transition:all 0.2s;width:100%}
.cpb:hover{box-shadow:0 2px 12px rgba(68,138,255,0.3)}
.dt{width:100%;border-collapse:collapse;font-size:10px}
.dt th{background:rgba(255,255,255,0.04);padding:4px 2px;text-align:center;font-size:8px;text-transform:uppercase;letter-spacing:0.5px;color:#667;border-bottom:1px solid rgba(255,255,255,0.06)}
.dt td{padding:4px 2px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.03)}
.dt tr.gold td{background:rgba(255,214,0,0.08);box-shadow:inset 2px 0 0 #ffd600}
.dt tr.chal td{background:rgba(255,109,0,0.06)}
.smsg{text-align:center;font-size:11px;padding:5px;border-radius:6px;background:rgba(255,255,255,0.03);color:#aaa}
.cmsg{background:rgba(0,200,83,0.08);border:1px solid rgba(0,200,83,0.2);color:#00c853;text-align:center;padding:8px;border-radius:8px;font-weight:700;font-size:11px;display:none}
</style>
</head>
<body>
<div class="game">
  <div class="top">
    <h1>Mr. Jawad Simulation Heart Performance and Training</h1>
    <div class="mission">Find the training sweet spot</div>
    <div class="round-pill" id="rBadge">Round 1 / 8</div>
  </div>
  <div class="left">
    <div class="sec-lbl">Training Level</div>
    <div class="grp" id="tGrp">
      <h3>Training</h3>
      <div class="btns" id="tBtns">
        <div class="vb" data-v="Untrained" id="t_Untrained">Untrained</div>
        <div class="vb lk" data-v="Moderate" id="t_Moderate">Moderate üîí</div>
        <div class="vb lk" data-v="Heavy" id="t_Heavy">Heavy üîí</div>
        <div class="vb lk" data-v="Extreme" id="t_Extreme">Extreme üîí</div>
      </div>
    </div>
    <div class="sec-lbl">Activity Intensity</div>
    <div class="grp" id="aGrp">
      <h3>Activity</h3>
      <div class="btns" id="aBtns">
        <div class="vb" data-v="Resting" id="a_Resting">Resting</div>
        <div class="vb" data-v="Walking" id="a_Walking">Walking</div>
        <div class="vb" data-v="Jogging" id="a_Jogging">Jogging</div>
        <div class="vb" data-v="Sprinting" id="a_Sprinting">Sprinting</div>
      </div>
    </div>
    <div class="one-var-note" id="ovrNote">‚ö† One variable per round</div>
    <div class="guide" id="gPrompt"></div>
    <button class="go-btn" id="goBtn" disabled>Pick Both</button>
    <div class="bot">
      <button class="rst-b" onclick="resetAll()">Reset</button>
      <button class="new-b" onclick="resetAll()">New Run</button>
    </div>
  </div>
  <div class="arena-wrap" id="arWrap">
    <canvas id="C"></canvas>
    <div class="hud">
      <div class="hi"><div class="hl">Heart Rate</div><div class="hv hr-c" id="hHR">--</div></div>
      <div class="hi"><div class="hl">O‚ÇÇ Delivery</div><div class="hv o2-c" id="hO2">--%</div></div>
      <div class="hi"><div class="hl">Score</div><div class="hv sc-c" id="hSc">0</div></div>
      <div class="hi"><div class="hl">Streak</div><div class="hv st-c" id="hSt">0</div></div>
    </div>
    <div class="amsg" id="aMsg"></div>
    <div class="chal-ban" id="chalBan">üî• HEAT WAVE CHALLENGE ‚Äî Round 6 üî•</div>
    <div class="badge-pop" id="badgePop">üèÜ Coach Badge Earned!</div>
    <div class="unlock-t" id="unlkT"></div>
    <div class="pred-ov" id="predOv">
      <h2>‚ö° Round 8: Prediction</h2>
      <p>Which training gives the BEST sprint?</p>
      <div class="pred-btns">
        <div class="pb" onclick="doPred('Untrained')">Untrained</div>
        <div class="pb" onclick="doPred('Moderate')">Moderate</div>
        <div class="pb" onclick="doPred('Heavy')">Heavy</div>
        <div class="pb" onclick="doPred('Extreme')">Extreme</div>
      </div>
    </div>
  </div>
  <div class="right">
    <div class="sec-lbl">Progress</div>
    <div class="sg">
      <div class="sb"><div class="sn" id="sDone" style="color:#00c853">0</div><div class="sl">Done</div></div>
      <div class="sb"><div class="sn" id="sBest" style="color:#4dd0e1">--</div><div class="sl">Best O‚ÇÇ</div></div>
    </div>
    <div class="pbar-w"><div class="pbar-f" id="pBar"></div></div>
    <div class="smsg" id="sMsg">Pick training + activity</div>
    <div class="cmsg" id="reqDone">‚úÖ 5 Required Complete! Keep going for EC!</div>
    <div class="cmsg" id="ecDone" style="border-color:rgba(255,214,0,0.3);color:#ffd600">‚≠ê Extra Credit Complete!</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:2px">
      <div class="sec-lbl" style="margin:0">Data Table</div>
      <button class="cpb" id="cpBtn" onclick="copyTbl()">üìã Copy Table</button>
    </div>
    <div style="overflow-y:auto;flex:1">
      <table class="dt"><thead><tr><th>Rd</th><th>Training</th><th>Activity</th><th>HR</th><th>O‚ÇÇ%</th></tr></thead><tbody id="dBody"></tbody></table>
    </div>
  </div>
</div>

<script>
// ===== STATE =====
let G = {
  round:1, score:0, streak:0, bestO2:0, lastO2:-1, consImprove:0,
  selT:null, selA:null, prevT:null, prevA:null,
  changedVar:null, // 'T' or 'A' - which var was changed this round
  pred:null, data:[], over:false, coachRd:-1, busy:false,
  unlocked:['Untrained'], heatWave:false
};
const UNLOCK = {3:'Moderate',4:'Heavy',5:'Extreme'};
const D = {
  Untrained:{Resting:{hr:80,o2:72},Walking:{hr:110,o2:68},Jogging:{hr:150,o2:62},Sprinting:{hr:185,o2:55}},
  Moderate:{Resting:{hr:62,o2:85},Walking:{hr:88,o2:90},Jogging:{hr:120,o2:92},Sprinting:{hr:145,o2:88}},
  Heavy:{Resting:{hr:58,o2:82},Walking:{hr:82,o2:86},Jogging:{hr:115,o2:88},Sprinting:{hr:140,o2:84}},
  Extreme:{Resting:{hr:78,o2:65},Walking:{hr:105,o2:62},Jogging:{hr:155,o2:58},Sprinting:{hr:190,o2:48}}
};

// ===== CANVAS =====
const C = document.getElementById('C'), cx = C.getContext('2d');
let W=0,H=0, curHR=72, curO2=75, tarHR=72, tarO2=75;
let hPhase=0, hSpeed=1, warnLvl=0, athTrain='Untrained', athAct='Resting';
let rings=[], oxyParts=[], vessels=[], ambT=0, starField=[];

function resize(){
  const w=document.getElementById('arWrap');
  C.width=w.clientWidth; C.height=w.clientHeight;
  W=C.width; H=C.height;
  buildVessels(); buildStars();
}

function buildStars(){
  starField=[];
  for(let i=0;i<40;i++) starField.push({x:Math.random()*W,y:Math.random()*H,s:0.3+Math.random()*1.2,b:Math.random()});
}

function buildVessels(){
  vessels=[];
  const hx=W*0.32,hy=H*0.44;
  const ends=[
    {x:W*0.68,y:H*0.15,w:2.5},{x:W*0.76,y:H*0.32,w:2},{x:W*0.6,y:H*0.3,w:2},
    {x:W*0.74,y:H*0.62,w:2.5},{x:W*0.64,y:H*0.72,w:2.5},{x:W*0.7,y:H*0.48,w:3},
    {x:W*0.58,y:H*0.55,w:1.5},{x:W*0.78,y:H*0.5,w:1.5}
  ];
  ends.forEach(e=>{
    const r=()=>(Math.random()-0.5)*30;
    vessels.push({sx:hx+35,sy:hy,ex:e.x,ey:e.y,
      c1x:hx+35+(e.x-hx-35)*0.35+r(),c1y:hy+(e.y-hy)*0.25+r(),
      c2x:hx+35+(e.x-hx-35)*0.65+r(),c2y:hy+(e.y-hy)*0.7+r(),w:e.w});
  });
}

function spawnOxy(n){
  for(let i=0;i<n;i++){
    const pi=Math.floor(Math.random()*vessels.length);
    oxyParts.push({pi,t:Math.random()*0.2,sp:0.002+Math.random()*0.004,sz:1.5+Math.random()*3,a:0.5+Math.random()*0.5});
  }
}

function bezPt(v,t){
  const m=1-t;
  return{
    x:m*m*m*v.sx+3*m*m*t*v.c1x+3*m*t*t*v.c2x+t*t*t*v.ex,
    y:m*m*m*v.sy+3*m*m*t*v.c1y+3*m*t*t*v.c2y+t*t*t*v.ey
  };
}

// --- DRAW FUNCTIONS ---
function drawBG(){
  const g=cx.createRadialGradient(W*0.35,H*0.45,0,W*0.5,H*0.5,W*0.8);
  g.addColorStop(0,'#0e1230');g.addColorStop(0.5,'#080818');g.addColorStop(1,'#050510');
  cx.fillStyle=g;cx.fillRect(0,0,W,H);
  // Stars
  ambT+=0.008;
  starField.forEach((s,i)=>{
    const twinkle=0.3+Math.sin(ambT*2+i*0.7)*0.3;
    cx.beginPath();cx.arc(s.x,s.y,s.s,0,Math.PI*2);
    cx.fillStyle=`rgba(180,200,255,${twinkle*0.4})`;cx.fill();
  });
  // Ambient glow near heart
  const ag=cx.createRadialGradient(W*0.32,H*0.44,0,W*0.32,H*0.44,H*0.5);
  const glowA = warnLvl>=2?'rgba(255,20,50,0.06)':warnLvl>=1?'rgba(255,180,0,0.05)':'rgba(100,50,200,0.04)';
  ag.addColorStop(0,glowA);ag.addColorStop(1,'transparent');
  cx.fillStyle=ag;cx.fillRect(0,0,W,H);
  // Heat wave shimmer
  if(G.heatWave){
    for(let i=0;i<6;i++){
      const wx=W*0.1+Math.sin(ambT*3+i)*W*0.4;
      const wy=H*0.3+i*H*0.1;
      cx.beginPath();cx.ellipse(wx,wy,80+Math.sin(ambT*2+i)*20,3,Math.sin(ambT+i)*0.2,0,Math.PI*2);
      cx.fillStyle=`rgba(255,100,0,${0.03+Math.sin(ambT*4+i)*0.015})`;cx.fill();
    }
  }
}

function drawTrack(){
  // Ground plane
  const tg=cx.createLinearGradient(W*0.5,H*0.82,W*0.5,H);
  tg.addColorStop(0,'rgba(40,40,70,0.4)');tg.addColorStop(1,'rgba(20,20,40,0.6)');
  cx.fillStyle=tg;
  cx.beginPath();cx.moveTo(W*0.48,H*0.82);cx.lineTo(W*0.96,H*0.78);cx.lineTo(W*0.96,H*0.86);cx.lineTo(W*0.48,H*0.9);cx.fill();
  // Lane lines
  cx.strokeStyle='rgba(255,255,255,0.06)';cx.lineWidth=1;cx.setLineDash([10,8]);
  for(let i=0;i<3;i++){
    cx.beginPath();cx.moveTo(W*0.48,H*(0.83+i*0.025));cx.lineTo(W*0.96,H*(0.79+i*0.025));cx.stroke();
  }
  cx.setLineDash([]);
}

function drawHeart(px,py,sz){
  const beat=1+Math.sin(hPhase)*0.1;
  const s=sz*beat;
  cx.save();cx.translate(px,py);

  // Outer glow
  const gc=warnLvl>=2?[255,20,50]:warnLvl>=1?[255,180,0]:[200,80,120];
  const glR=s*2.5;
  const gg=cx.createRadialGradient(0,0,s*0.5,0,0,glR);
  gg.addColorStop(0,`rgba(${gc[0]},${gc[1]},${gc[2]},${0.15+Math.sin(hPhase)*0.05})`);
  gg.addColorStop(1,'transparent');
  cx.fillStyle=gg;cx.fillRect(-glR,-glR,glR*2,glR*2);

  // Heart body - more anatomical
  cx.beginPath();
  // Right atrium/ventricle
  cx.moveTo(0,s*0.25);
  cx.bezierCurveTo(-s*0.1,-s*0.5,-s*0.9,-s*0.5,-s*0.55,s*0.1);
  cx.bezierCurveTo(-s*0.7,s*0.5,-s*0.2,s*0.85,0,s*1.1);
  // Left side
  cx.bezierCurveTo(s*0.2,s*0.85,s*0.7,s*0.5,s*0.55,s*0.1);
  cx.bezierCurveTo(s*0.9,-s*0.5,s*0.1,-s*0.5,0,s*0.25);
  cx.closePath();

  const hg=cx.createRadialGradient(-s*0.1,-s*0.1,0,0,s*0.3,s*1.2);
  if(warnLvl>=2){hg.addColorStop(0,'#ff3355');hg.addColorStop(0.6,'#cc1133');hg.addColorStop(1,'#880022');}
  else if(warnLvl>=1){hg.addColorStop(0,'#ff6644');hg.addColorStop(0.6,'#dd4422');hg.addColorStop(1,'#aa2200');}
  else{hg.addColorStop(0,'#ff5566');hg.addColorStop(0.6,'#cc3344');hg.addColorStop(1,'#991122');}
  cx.fillStyle=hg;cx.fill();

  // Specular highlight
  const sg=cx.createRadialGradient(-s*0.2,-s*0.15,0,-s*0.2,-s*0.15,s*0.4);
  sg.addColorStop(0,'rgba(255,255,255,0.2)');sg.addColorStop(1,'rgba(255,255,255,0)');
  cx.fillStyle=sg;cx.fill();

  cx.strokeStyle='rgba(255,200,200,0.15)';cx.lineWidth=1.5;cx.stroke();

  // Chamber line (septum)
  cx.beginPath();cx.moveTo(0,s*0.1);cx.lineTo(0,s*0.9);
  cx.strokeStyle='rgba(150,50,50,0.4)';cx.lineWidth=1;cx.stroke();

  // Aorta bump
  cx.beginPath();
  cx.ellipse(s*0.1,-s*0.35,s*0.15,s*0.2,0.2,0,Math.PI*2);
  cx.fillStyle='rgba(200,60,80,0.7)';cx.fill();

  // Label
  cx.font='bold 11px Segoe UI';cx.textAlign='center';cx.fillStyle='rgba(255,200,200,0.7)';
  cx.fillText('Heart Rate',0,s*1.35);

  cx.restore();
}

function drawRings(px,py){
  rings.forEach(r=>{
    cx.beginPath();cx.arc(px,py,r.r,0,Math.PI*2);
    const c=warnLvl>=2?`rgba(255,30,60,${r.a})`:warnLvl>=1?`rgba(255,200,0,${r.a})`:`rgba(0,220,120,${r.a})`;
    cx.strokeStyle=c;cx.lineWidth=2.5;cx.stroke();
    // Second ring slightly offset for richness
    cx.beginPath();cx.arc(px,py,r.r+3,0,Math.PI*2);
    cx.strokeStyle=c.replace(/[\d.]+\)$/,(r.a*0.3).toFixed(3)+')');cx.lineWidth=1;cx.stroke();
    r.r+=1.5;r.a-=0.009;
  });
  rings=rings.filter(r=>r.a>0);
}

function drawVessels(){
  vessels.forEach(v=>{
    cx.beginPath();cx.moveTo(v.sx,v.sy);cx.bezierCurveTo(v.c1x,v.c1y,v.c2x,v.c2y,v.ex,v.ey);
    // Dark base
    cx.strokeStyle=`rgba(120,30,50,${warnLvl>=2?0.12:0.25})`;cx.lineWidth=v.w+1;cx.stroke();
    // Bright flow overlay
    const flowA=Math.max(0.05,(curO2/100)*0.35);
    const fc=curO2>75?`rgba(0,200,160,${flowA})`:curO2>55?`rgba(200,180,0,${flowA})`:`rgba(200,50,50,${flowA})`;
    cx.strokeStyle=fc;cx.lineWidth=v.w;cx.stroke();
  });
}

function drawOxy(){
  oxyParts.forEach(p=>{
    const v=vessels[p.pi]; if(!v)return;
    const pt=bezPt(v,p.t);
    const fade=curO2>70?p.a:p.a*(curO2/100);
    const bright=curO2>75;
    // Core
    cx.beginPath();cx.arc(pt.x,pt.y,p.sz,0,Math.PI*2);
    cx.fillStyle=bright?`rgba(0,255,200,${fade})`:`rgba(100,160,255,${fade*0.5})`;cx.fill();
    // Glow
    cx.beginPath();cx.arc(pt.x,pt.y,p.sz*3,0,Math.PI*2);
    cx.fillStyle=bright?`rgba(0,255,200,${fade*0.15})`:`rgba(100,160,255,${fade*0.08})`;cx.fill();
    p.t+=p.sp*(0.5+curO2/150);
    if(p.t>1){if(curO2>45)p.t=0;else p.a-=0.05;}
  });
  oxyParts=oxyParts.filter(p=>p.a>0.01);
  if(oxyParts.length<25&&curO2>40)spawnOxy(2);
}

function drawO2Bar(bx,by,bw,bh){
  // BG
  cx.fillStyle='rgba(255,255,255,0.03)';
  cx.beginPath();cx.roundRect(bx,by,bw,bh,5);cx.fill();
  cx.strokeStyle='rgba(255,255,255,0.06)';cx.lineWidth=1;cx.stroke();
  // Fill
  const fh=(curO2/100)*bh;
  const fg=cx.createLinearGradient(bx,by+bh,bx,by+bh-fh);
  if(curO2>75){fg.addColorStop(0,'#00c853');fg.addColorStop(1,'#69f0ae');}
  else if(curO2>55){fg.addColorStop(0,'#ffd600');fg.addColorStop(1,'#ffab00');}
  else{fg.addColorStop(0,'#ff1744');fg.addColorStop(1,'#ff5252');}
  cx.fillStyle=fg;
  cx.beginPath();cx.roundRect(bx,by+bh-fh,bw,fh,5);cx.fill();
  // Glow
  const gg=cx.createLinearGradient(bx-8,by+bh-fh,bx+bw+8,by+bh-fh);
  gg.addColorStop(0,'transparent');
  gg.addColorStop(0.5,curO2>75?'rgba(0,200,83,0.15)':curO2>55?'rgba(255,214,0,0.1)':'rgba(255,23,68,0.1)');
  gg.addColorStop(1,'transparent');
  cx.fillStyle=gg;cx.fillRect(bx-8,by+bh-fh-2,bw+16,fh+4);
  // Labels
  cx.font='bold 10px Segoe UI';cx.textAlign='center';
  cx.fillStyle='rgba(200,220,255,0.6)';cx.fillText('O‚ÇÇ',bx+bw/2,by-6);
  cx.fillStyle='#fff';cx.font='bold 12px Segoe UI';
  cx.fillText(Math.round(curO2)+'%',bx+bw/2,by+bh+16);
}

function drawAthlete(ax,ay){
  cx.save();cx.translate(ax,ay);
  const t=Date.now()/250;
  let lean=0,sDrop=0;
  if(athTrain==='Extreme'||warnLvl>=2){lean=0.15;sDrop=10;}
  if(warnLvl>=2){lean=0.22;sDrop=16;}
  let legSw=0,armSw=0,bounce=0;
  if(athAct==='Walking'){legSw=Math.sin(t)*14;armSw=Math.sin(t)*10;bounce=Math.abs(Math.sin(t))*3;}
  if(athAct==='Jogging'){legSw=Math.sin(t*1.6)*20;armSw=Math.sin(t*1.6)*16;bounce=Math.abs(Math.sin(t*1.6))*6;}
  if(athAct==='Sprinting'){legSw=Math.sin(t*2.5)*28;armSw=Math.sin(t*2.5)*22;bounce=Math.abs(Math.sin(t*2.5))*10;}
  cx.translate(0,-bounce);cx.rotate(lean);

  // Body color by O2
  const o=curO2/100;
  const bR=Math.round(80+o*175),bG=Math.round(60+o*120),bB=Math.round(70+o*90);
  const bc=`rgb(${bR},${bG},${bB})`;
  // Body aura
  const ag=cx.createRadialGradient(0,-5,5,0,-5,70);
  ag.addColorStop(0,curO2>75?'rgba(0,230,180,0.12)':curO2>55?'rgba(255,200,0,0.08)':'rgba(255,50,50,0.1)');
  ag.addColorStop(1,'transparent');
  cx.fillStyle=ag;cx.fillRect(-70,-80,140,180);

  // Shadow on ground
  cx.beginPath();cx.ellipse(0,52+sDrop,22,5,0,0,Math.PI*2);
  cx.fillStyle='rgba(0,0,0,0.3)';cx.fill();

  // HEAD
  cx.beginPath();cx.arc(0,-48+sDrop,16,0,Math.PI*2);
  const hg=cx.createRadialGradient(-3,-50+sDrop,0,0,-48+sDrop,16);
  hg.addColorStop(0,`rgb(${Math.min(255,bR+40)},${Math.min(255,bG+30)},${Math.min(255,bB+20)})`);
  hg.addColorStop(1,bc);
  cx.fillStyle=hg;cx.fill();
  cx.strokeStyle='rgba(255,255,255,0.08)';cx.lineWidth=0.8;cx.stroke();
  // Dark circles extreme
  if(athTrain==='Extreme'||warnLvl>=2){
    cx.fillStyle='rgba(60,0,20,0.5)';
    cx.beginPath();cx.ellipse(-5,-49+sDrop,4,2.5,0,0,Math.PI*2);cx.fill();
    cx.beginPath();cx.ellipse(5,-49+sDrop,4,2.5,0,0,Math.PI*2);cx.fill();
  }
  // Eyes
  cx.fillStyle=warnLvl>=2?'rgba(200,100,100,0.6)':'rgba(255,255,255,0.5)';
  cx.beginPath();cx.arc(-4,-49+sDrop,1.5,0,Math.PI*2);cx.fill();
  cx.beginPath();cx.arc(4,-49+sDrop,1.5,0,Math.PI*2);cx.fill();

  // TORSO
  cx.beginPath();cx.roundRect(-14,-30+sDrop,28,40,5);
  const tg=cx.createLinearGradient(-14,-30+sDrop,14,10+sDrop);
  tg.addColorStop(0,`rgb(${Math.min(255,bR+20)},${Math.min(255,bG+15)},${Math.min(255,bB+10)})`);
  tg.addColorStop(1,bc);
  cx.fillStyle=tg;cx.fill();
  // Muscle lines for trained
  if(athTrain==='Moderate'||athTrain==='Heavy'){
    cx.strokeStyle='rgba(255,255,255,0.1)';cx.lineWidth=0.7;
    cx.beginPath();cx.moveTo(-6,-24+sDrop);cx.lineTo(-6,-6+sDrop);cx.stroke();
    cx.beginPath();cx.moveTo(6,-24+sDrop);cx.lineTo(6,-6+sDrop);cx.stroke();
    if(athTrain==='Heavy'){
      cx.beginPath();cx.moveTo(-10,-20+sDrop);cx.lineTo(-10,-8+sDrop);cx.stroke();
      cx.beginPath();cx.moveTo(10,-20+sDrop);cx.lineTo(10,-8+sDrop);cx.stroke();
    }
  }

  // ARMS
  const drawArm=(side,swing)=>{
    cx.save();cx.translate(side*16,-26+sDrop);cx.rotate(swing*Math.PI/180*side);
    cx.beginPath();cx.roundRect(-4,0,8,30,4);
    cx.fillStyle=bc;cx.fill();
    cx.restore();
  };
  drawArm(-1,-armSw);drawArm(1,armSw);

  // LEGS
  const drawLeg=(side,swing)=>{
    cx.save();cx.translate(side*8,10+sDrop);cx.rotate(swing*Math.PI/180);
    cx.beginPath();cx.roundRect(-5,0,10,34,4);
    cx.fillStyle=bc;cx.fill();
    // Shoe
    cx.fillStyle='rgba(60,60,80,0.8)';
    cx.beginPath();cx.roundRect(-6,30,12,6,3);cx.fill();
    cx.restore();
  };
  drawLeg(-1,legSw);drawLeg(1,-legSw);

  // Dust for sprinting
  if(athAct==='Sprinting'){
    for(let i=0;i<5;i++){
      const dx=-15-Math.random()*40,dy=38+sDrop+Math.random()*15;
      const ds=1+Math.random()*3;
      cx.beginPath();cx.arc(dx,dy,ds,0,Math.PI*2);
      cx.fillStyle=`rgba(180,160,130,${0.15+Math.random()*0.2})`;cx.fill();
    }
  }
  // Sweat drops for jogging/sprinting
  if(athAct==='Jogging'||athAct==='Sprinting'){
    const drops=athAct==='Sprinting'?4:2;
    for(let i=0;i<drops;i++){
      const dx=-12+Math.random()*24,dy=-55+sDrop+Math.sin(t*3+i)*8-i*5;
      cx.beginPath();cx.ellipse(dx,dy,1,2.5,0,0,Math.PI*2);
      cx.fillStyle=`rgba(100,180,255,${0.3+Math.random()*0.2})`;cx.fill();
    }
  }
  // Fatigue icon
  if(warnLvl>=2){
    const fp=0.6+Math.sin(t*4)*0.4;
    cx.font=`${Math.round(24*fp)}px serif`;cx.textAlign='center';
    cx.globalAlpha=fp;cx.fillText('‚ö†Ô∏è',0,-72+sDrop);cx.globalAlpha=1;
  }
  // Training label
  cx.font='bold 9px Segoe UI';cx.textAlign='center';
  cx.fillStyle='rgba(180,200,255,0.5)';
  cx.fillText(athTrain,0,58+sDrop);
  cx.restore();
}

function drawHRMeter(mx,my){
  // Mini ECG-like line
  cx.save();cx.translate(mx,my);
  cx.strokeStyle=warnLvl>=2?'rgba(255,50,70,0.6)':warnLvl>=1?'rgba(255,200,0,0.5)':'rgba(255,100,120,0.5)';
  cx.lineWidth=1.5;cx.beginPath();
  const freq=curHR/60;
  for(let i=0;i<80;i++){
    const x=i*1.5;
    let y=0;
    const phase=(i*0.15+ambT*freq*8)%(Math.PI*2);
    if(phase<0.3)y=-Math.sin(phase/0.3*Math.PI)*18;
    else if(phase<0.5)y=Math.sin((phase-0.3)/0.2*Math.PI)*8;
    if(i===0)cx.moveTo(x,y);else cx.lineTo(x,y);
  }
  cx.stroke();
  cx.restore();
}

function animate(){
  drawBG();
  drawTrack();
  // Lerp
  curHR+=(tarHR-curHR)*0.05;
  curO2+=(tarO2-curO2)*0.05;
  hSpeed=0.5+(curHR/200)*4;
  hPhase+=hSpeed*0.04;
  // Pulse ring on beat
  if(Math.sin(hPhase)>0.97&&Math.sin(hPhase-hSpeed*0.04)<=0.97){
    rings.push({r:40,a:0.5});
    if(curO2>40)spawnOxy(4);
  }

  const hx=W*0.32,hy=H*0.44;
  drawVessels();
  drawOxy();
  drawRings(hx,hy);
  drawHeart(hx,hy,40);
  drawO2Bar(W*0.1,H*0.18,20,H*0.5);
  drawHRMeter(W*0.15,H*0.82);
  drawAthlete(W*0.7,H*0.46);

  requestAnimationFrame(animate);
}

// ===== SELECTION LOGIC (FIXED) =====
function refreshBtns(){
  // Training
  document.querySelectorAll('#tBtns .vb').forEach(b=>{
    const v=b.dataset.v;
    b.classList.remove('sel','lk','dis');
    if(!G.unlocked.includes(v)){
      b.classList.add('lk');b.textContent=v+' üîí';
    } else {
      b.textContent=v;
      if(v===G.selT) b.classList.add('sel');
      // If activity was changed this round, disable all training EXCEPT the previous training
      if(G.changedVar==='A'&&G.prevT!==null){
        if(v!==G.prevT) b.classList.add('dis');
        // Auto-select prevT
        if(v===G.prevT){b.classList.add('sel');G.selT=G.prevT;}
      }
    }
  });
  // Activity
  document.querySelectorAll('#aBtns .vb').forEach(b=>{
    const v=b.dataset.v;
    b.classList.remove('sel','dis');
    if(v===G.selA) b.classList.add('sel');
    if(G.changedVar==='T'&&G.prevA!==null){
      if(v!==G.prevA) b.classList.add('dis');
      if(v===G.prevA){b.classList.add('sel');G.selA=G.prevA;}
    }
  });
  // One-var note
  document.getElementById('ovrNote').style.display=G.changedVar?'block':'none';
  updateGoBtn();
}

function pickT(val){
  if(G.busy||G.over)return;
  if(!G.unlocked.includes(val))return;
  if(G.changedVar==='A'&&G.prevT!==null&&val!==G.prevT)return; // locked
  G.selT=val;
  // Detect if this is a CHANGE from previous round
  if(G.prevT!==null&&val!==G.prevT&&G.changedVar===null){
    G.changedVar='T'; // training changed, lock activity
  }
  refreshBtns();
}

function pickA(val){
  if(G.busy||G.over)return;
  if(G.changedVar==='T'&&G.prevA!==null&&val!==G.prevA)return;
  G.selA=val;
  if(G.prevA!==null&&val!==G.prevA&&G.changedVar===null){
    G.changedVar='A';
  }
  refreshBtns();
}

function updateGoBtn(){
  const b=document.getElementById('goBtn');
  if(G.selT&&G.selA){b.disabled=false;b.classList.add('rdy');b.textContent='‚ñ∂ Run Test';}
  else{b.disabled=true;b.classList.remove('rdy');b.textContent=G.selT||G.selA?'Pick Both':'Pick Both';}
}

// Click handlers via delegation
document.getElementById('tBtns').addEventListener('click',e=>{
  const b=e.target.closest('.vb');if(b)pickT(b.dataset.v);
});
document.getElementById('aBtns').addEventListener('click',e=>{
  const b=e.target.closest('.vb');if(b)pickA(b.dataset.v);
});
document.getElementById('goBtn').addEventListener('click',runRound);

// ===== RUN ROUND =====
function runRound(){
  if(!G.selT||!G.selA||G.busy||G.over)return;
  G.busy=true;
  const btn=document.getElementById('goBtn');
  btn.disabled=true;btn.classList.remove('rdy');btn.textContent='Testing...';

  let base=D[G.selT][G.selA];
  let hr=base.hr+Math.floor(Math.random()*9)-4;
  let o2=base.o2+Math.floor(Math.random()*5)-2;
  if(G.round===6){hr+=10;G.heatWave=true;document.getElementById('chalBan').style.display='block';}
  else{G.heatWave=false;document.getElementById('chalBan').style.display='none';}
  hr=Math.max(45,Math.min(210,hr));o2=Math.max(30,Math.min(99,o2));

  tarHR=hr;tarO2=o2;athTrain=G.selT;athAct=G.selA;
  warnLvl=G.selT==='Extreme'?2:(hr>160?1:0);

  animVal('hHR',parseInt(document.getElementById('hHR').textContent)||72,hr,1400,v=>v+' bpm');
  animVal('hO2',parseInt(document.getElementById('hO2').textContent)||75,o2,1400,v=>v+'%');
  showAMsg(o2>=85?'üü¢ Strong!':o2>=70?'üü° OK':o2>=55?'üü† Weak':'üî¥ Failing');

  setTimeout(()=>{
    G.score+=10;
    if(G.lastO2>0&&o2>G.lastO2){G.consImprove++;G.streak++;}
    else{G.consImprove=0;if(G.lastO2>0&&G.round!==6)G.streak=0;}
    if(G.consImprove>=2&&G.coachRd===-1){
      G.coachRd=G.round;G.score+=25;
      const bp=document.getElementById('badgePop');bp.style.display='block';setTimeout(()=>bp.style.display='none',3000);
    }
    if(o2>G.bestO2)G.bestO2=o2;
    G.lastO2=o2;
    document.getElementById('hSc').textContent=G.score;
    document.getElementById('hSt').textContent=G.streak;
    document.getElementById('sDone').textContent=G.round;
    document.getElementById('sBest').textContent=G.bestO2+'%';
    document.getElementById('pBar').style.width=Math.min(100,(G.round/5)*100)+'%';

    const rd={round:G.round,training:G.selT,activity:G.selA,hr,o2,isChal:G.round===6,isGold:G.round===G.coachRd};
    G.data.push(rd);addRow(rd);

    G.prevT=G.selT;G.prevA=G.selA;

    if(G.round>=5&&!document.getElementById('reqDone').style.display.includes('block')){
      document.getElementById('reqDone').style.display='block';
    }
    if(G.round<5)document.getElementById('sMsg').textContent=`${5-G.round} more required`;
    else if(G.round===5)document.getElementById('sMsg').textContent='EC: 3 more rounds!';
    else if(G.round<8)document.getElementById('sMsg').textContent=`EC: ${8-G.round} more`;
    else{document.getElementById('ecDone').style.display='block';document.getElementById('sMsg').textContent='All done!';}

    G.round++;
    if(G.round>8){G.over=true;btn.textContent='Complete!';showAMsg('üèÜ All Done!');G.busy=false;return;}
    document.getElementById('rBadge').textContent=`Round ${G.round} / 8`;

    // Unlock
    if(UNLOCK[G.round]&&!G.unlocked.includes(UNLOCK[G.round])){
      G.unlocked.push(UNLOCK[G.round]);
      showUnlock(UNLOCK[G.round]+' Unlocked!');
    }

    if(G.round===8){
      setTimeout(()=>{document.getElementById('predOv').style.display='flex';G.busy=false;},500);
      return;
    }

    // Reset for next round
    G.selT=null;G.selA=null;G.changedVar=null;
    G.heatWave=false;document.getElementById('chalBan').style.display='none';
    updateGuide();refreshBtns();
    G.busy=false;
  },2000);
}

function doPred(val){
  G.pred=val;
  document.querySelectorAll('.pb').forEach(b=>{b.classList.remove('chos');if(b.textContent.trim()===val)b.classList.add('chos');});
  setTimeout(()=>{
    document.getElementById('predOv').style.display='none';
    G.selT=val;G.selA='Sprinting';G.changedVar=null;
    refreshBtns();updateGuide();
  },700);
}

function updateGuide(){
  const g=document.getElementById('gPrompt');
  if(G.round===1){g.style.display='block';g.textContent='üí° Try Resting first!';}
  else if(G.round===2){g.style.display='block';g.textContent='üí° Now try Sprinting!';}
  else if(G.round===6){g.style.display='block';g.textContent='üî• Heat Wave ahead!';}
  else if(G.round===8){g.style.display='block';g.textContent='üéØ Prediction round!';}
  else g.style.display='none';
}

function showAMsg(txt){
  const e=document.getElementById('aMsg');e.textContent=txt;e.classList.add('show');
  setTimeout(()=>e.classList.remove('show'),2200);
}
function showUnlock(txt){
  const e=document.getElementById('unlkT');e.textContent='üîì '+txt;e.style.display='block';
  setTimeout(()=>e.style.display='none',2500);
}
function animVal(id,from,to,dur,fmt){
  const el=document.getElementById(id);const st=Date.now();from=Math.round(from)||0;
  (function step(){
    const t=Math.min(1,(Date.now()-st)/dur);const e=t<0.5?2*t*t:-1+(4-2*t)*t;
    el.textContent=fmt(Math.round(from+(to-from)*e));
    if(t<1)requestAnimationFrame(step);
  })();
}
function addRow(d){
  const tr=document.createElement('tr');
  if(d.isGold)tr.classList.add('gold');if(d.isChal)tr.classList.add('chal');
  tr.innerHTML=`<td>${d.round}</td><td>${d.training}</td><td>${d.activity}</td><td>${d.hr}</td><td>${d.o2}%</td>`;
  document.getElementById('dBody').appendChild(tr);
}
function copyTbl(){
  let t='Round\tTraining Level\tActivity\tHeart Rate (bpm)\tOxygen Delivery (%)\n';
  G.data.forEach(d=>{t+=`${d.round}\t${d.training}\t${d.activity}\t${d.hr}\t${d.o2}%\n`;});
  try{navigator.clipboard.writeText(t).then(()=>{cpFb();}).catch(()=>{cpFall(t);});}catch(e){cpFall(t);}
}
function cpFall(t){const a=document.createElement('textarea');a.value=t;document.body.appendChild(a);a.select();document.execCommand('copy');document.body.removeChild(a);cpFb();}
function cpFb(){const b=document.getElementById('cpBtn');b.textContent='‚úÖ Copied!';setTimeout(()=>b.textContent='üìã Copy Table',2000);}

function resetAll(){
  Object.assign(G,{round:1,score:0,streak:0,bestO2:0,lastO2:-1,consImprove:0,
    selT:null,selA:null,prevT:null,prevA:null,changedVar:null,pred:null,data:[],over:false,coachRd:-1,busy:false,
    unlocked:['Untrained'],heatWave:false});
  tarHR=72;tarO2=75;warnLvl=0;athTrain='Untrained';athAct='Resting';
  oxyParts=[];rings=[];
  document.getElementById('dBody').innerHTML='';
  document.getElementById('hHR').textContent='--';document.getElementById('hO2').textContent='--%';
  document.getElementById('hSc').textContent='0';document.getElementById('hSt').textContent='0';
  document.getElementById('sDone').textContent='0';document.getElementById('sBest').textContent='--';
  document.getElementById('pBar').style.width='0%';
  document.getElementById('sMsg').textContent='Pick training + activity';
  document.getElementById('reqDone').style.display='none';document.getElementById('ecDone').style.display='none';
  document.getElementById('rBadge').textContent='Round 1 / 8';
  document.getElementById('chalBan').style.display='none';document.getElementById('badgePop').style.display='none';
  document.getElementById('predOv').style.display='none';document.getElementById('ovrNote').style.display='none';
  refreshBtns();updateGuide();spawnOxy(15);
}

// ===== INIT =====
window.addEventListener('resize',resize);
resize();spawnOxy(20);animate();refreshBtns();updateGuide();
</script>
</body>
</html>
