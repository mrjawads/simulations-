<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation Digestive System Failures</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#0a0e1a;color:#e0e0e0;overflow:hidden;height:100vh;width:100vw;}

/* === MAIN LAYOUT === */
.app{display:flex;height:100vh;width:100vw;}
.sidebar-left{width:280px;min-width:280px;background:linear-gradient(180deg,#111827,#0f172a);border-right:1px solid #1e293b;display:flex;flex-direction:column;overflow-y:auto;padding:10px;}
.center{flex:1;display:flex;flex-direction:column;background:#0f172a;overflow:hidden;}
.sidebar-right{width:280px;min-width:280px;background:linear-gradient(180deg,#111827,#0f172a);border-left:1px solid #1e293b;display:flex;flex-direction:column;overflow-y:auto;padding:10px;}

/* === TITLE BAR === */
.title-bar{background:linear-gradient(135deg,#1e40af,#7c3aed);padding:8px 16px;text-align:center;font-size:15px;font-weight:700;color:#fff;letter-spacing:0.5px;text-shadow:0 2px 4px rgba(0,0,0,0.3);}

/* === LEFT SIDEBAR === */
.pick-header{font-size:13px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;text-align:center;}
.scenario-card{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;cursor:pointer;margin-bottom:4px;background:#1e293b;border:2px solid transparent;transition:all 0.3s;position:relative;}
.scenario-card:hover{background:#334155;border-color:#3b82f6;}
.scenario-card.selected{background:#1e3a5f;border-color:#3b82f6;box-shadow:0 0 12px rgba(59,130,246,0.3);}
.scenario-card.completed{border-color:#22c55e;}
.scenario-card.completed::after{content:'‚úì';position:absolute;right:8px;top:50%;transform:translateY(-50%);color:#22c55e;font-weight:700;font-size:16px;}
.sc-emoji{font-size:22px;flex-shrink:0;}
.sc-name{font-size:12px;font-weight:600;color:#e2e8f0;line-height:1.2;}
.divider{height:1px;background:#334155;margin:8px 0;}
.section-label{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
.level-tabs{display:flex;gap:4px;margin-bottom:8px;}
.level-tab{flex:1;padding:6px;text-align:center;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;background:#1e293b;color:#94a3b8;border:2px solid transparent;transition:all 0.2s;}
.level-tab:hover{background:#334155;}
.level-tab.active{background:#1e40af;color:#fff;border-color:#3b82f6;box-shadow:0 0 8px rgba(59,130,246,0.3);}
.keyword-list{display:flex;flex-direction:column;gap:3px;}
.keyword-item{font-size:11px;padding:4px 8px;border-radius:6px;background:#1e293b;color:#94a3b8;transition:all 0.3s;}
.keyword-item.highlighted{background:#1e3a5f;color:#60a5fa;font-weight:600;}
.btn-reset{width:100%;padding:8px;border-radius:8px;border:none;cursor:pointer;font-weight:700;font-size:12px;margin-top:4px;transition:all 0.2s;}
.btn-reset.red{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;}
.btn-reset.blue{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;}
.btn-reset:hover{transform:scale(1.02);filter:brightness(1.1);}

/* === CENTER PANEL === */
.step-tabs{display:flex;gap:0;background:#111827;border-bottom:2px solid #1e293b;padding:0 16px;}
.step-tab{flex:1;text-align:center;padding:10px 8px;font-size:13px;font-weight:700;color:#475569;cursor:default;border-bottom:3px solid transparent;transition:all 0.3s;letter-spacing:0.5px;}
.step-tab.active{color:#60a5fa;border-bottom-color:#3b82f6;text-shadow:0 0 10px rgba(59,130,246,0.4);}
.step-tab.done{color:#22c55e;}
.center-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;overflow:hidden;position:relative;}
.content-card{background:#1e293b;border-radius:16px;padding:24px;max-width:700px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid #334155;position:relative;}
.content-card h2{font-size:20px;color:#f1f5f9;margin-bottom:12px;text-align:center;}
.content-card p{font-size:15px;color:#cbd5e1;line-height:1.6;}

/* PREDICT */
.predict-box{text-align:center;}
.predict-q{font-size:18px;color:#f1f5f9;margin-bottom:16px;font-weight:600;}
.predict-btns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.predict-btn{padding:14px 24px;border-radius:12px;border:2px solid #334155;background:#0f172a;color:#e2e8f0;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.3s;min-width:140px;}
.predict-btn:hover{border-color:#3b82f6;background:#1e3a5f;transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,0.2);}
.predict-btn.chosen{border-color:#22c55e;background:#14532d;color:#22c55e;}

/* READ */
.passage-card{max-height:400px;overflow-y:auto;line-height:1.7;font-size:16px;color:#cbd5e1;}
.passage-card .kw{color:#60a5fa;font-weight:700;}
.passage-card .sent{transition:background 0.3s;}
.passage-card .sent.speaking{background:rgba(59,130,246,0.15);border-radius:4px;}

/* WATCH */
.watch-arena{width:100%;min-height:320px;background:#0a0e1a;border-radius:12px;position:relative;overflow:hidden;border:1px solid #1e293b;}
.gauge-panel{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:8px;z-index:5;}
.gauge{width:180px;background:#111827;border-radius:8px;padding:6px 8px;border:1px solid #1e293b;}
.gauge-label{font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px;}
.gauge-bar{height:14px;background:#1e293b;border-radius:7px;position:relative;overflow:hidden;}
.gauge-fill{height:100%;border-radius:7px;transition:all 1.5s ease;position:absolute;left:0;top:0;}
.gauge-ok{position:absolute;left:35%;width:30%;height:100%;border-left:2px dashed rgba(255,255,255,0.3);border-right:2px dashed rgba(255,255,255,0.3);top:0;}
.gauge-indicator{position:absolute;top:-2px;width:4px;height:18px;background:#fff;border-radius:2px;transition:left 1.5s ease;z-index:2;}
.arena-visual{position:absolute;left:10px;top:10px;right:200px;bottom:10px;display:flex;align-items:center;justify-content:center;}
.arena-scene{position:relative;width:100%;height:100%;}

/* RECORD */
.record-msg{text-align:center;}
.record-msg .big-check{font-size:64px;margin-bottom:12px;display:block;animation:popIn 0.5s ease;}
@keyframes popIn{0%{transform:scale(0);opacity:0;}50%{transform:scale(1.2);}100%{transform:scale(1);opacity:1;}}

/* ACTION BUTTON */
.action-area{padding:12px 16px;display:flex;justify-content:center;gap:10px;background:#111827;border-top:1px solid #1e293b;}
.action-btn{padding:12px 32px;border-radius:12px;border:none;cursor:pointer;font-size:15px;font-weight:700;color:#fff;transition:all 0.3s;background:linear-gradient(135deg,#2563eb,#1d4ed8);box-shadow:0 4px 12px rgba(37,99,235,0.3);}
.action-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(37,99,235,0.4);}
.action-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
.action-btn.read-aloud{background:linear-gradient(135deg,#7c3aed,#6d28d9);}
.action-btn.read-aloud:hover{box-shadow:0 6px 16px rgba(124,58,237,0.4);}

/* === RIGHT SIDEBAR === */
.hud-title{font-size:13px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;text-align:center;}
.hud-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}
.hud-cell{background:#1e293b;border-radius:8px;padding:8px;text-align:center;border:1px solid #334155;}
.hud-val{font-size:22px;font-weight:800;color:#f1f5f9;}
.hud-lbl{font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;}
.progress-section{margin-bottom:10px;}
.progress-bar-bg{height:12px;background:#1e293b;border-radius:6px;overflow:hidden;border:1px solid #334155;}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);border-radius:6px;transition:width 0.5s ease;}
.progress-msg{font-size:11px;color:#94a3b8;text-align:center;margin-top:4px;}
.data-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.copy-btn{padding:4px 10px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#94a3b8;font-size:11px;cursor:pointer;transition:all 0.2s;}
.copy-btn:hover{background:#334155;color:#e2e8f0;}
.copy-btn.copied{background:#22c55e;color:#fff;border-color:#22c55e;}
.data-table{width:100%;border-collapse:collapse;font-size:10px;}
.data-table th{background:#1e3a5f;color:#93c5fd;padding:4px 3px;text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid #334155;}
.data-table td{padding:4px 3px;border-bottom:1px solid #1e293b;color:#cbd5e1;font-size:10px;vertical-align:top;}
.data-table tr:nth-child(even){background:rgba(30,41,59,0.5);}

/* WELCOME STATE */
.welcome-state{text-align:center;padding:40px 20px;}
.welcome-state .big-icon{font-size:72px;margin-bottom:16px;display:block;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
.welcome-state h2{font-size:24px;color:#f1f5f9;margin-bottom:8px;}
.welcome-state p{font-size:15px;color:#94a3b8;}

/* COMPLETION */
.completion-banner{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;padding:10px;border-radius:10px;text-align:center;font-weight:700;font-size:14px;margin-bottom:8px;animation:pulseGlow 2s ease infinite;}
.ec-banner{background:linear-gradient(135deg,#f59e0b,#d97706);}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 8px rgba(34,197,94,0.3);}50%{box-shadow:0 0 20px rgba(34,197,94,0.5);}}

/* HIDDEN */
.hidden{display:none!important;}

/* Scrollbar */
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:#0f172a;}
::-webkit-scrollbar-thumb{background:#334155;border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:#475569;}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.fade-in{animation:fadeIn 0.4s ease;}
@keyframes slideIn{from{opacity:0;transform:translateX(-20px);}to{opacity:1;transform:translateX(0);}}
.slide-in{animation:slideIn 0.3s ease;}

/* Arena elements */
.organ-label{position:absolute;font-size:11px;font-weight:700;color:#f1f5f9;background:rgba(0,0,0,0.6);padding:2px 8px;border-radius:4px;white-space:nowrap;pointer-events:none;}
.particle{position:absolute;border-radius:50%;pointer-events:none;}
.anim-arrow{position:absolute;font-size:20px;transition:all 0.5s;}
</style>
</head>
<body>
<div class="app">
<!-- LEFT SIDEBAR -->
<div class="sidebar-left">
<div class="pick-header">Pick Any 5 You Like</div>
<div id="scenarioList"></div>
<div class="divider"></div>
<div class="section-label">Reading Level</div>
<div class="level-tabs" id="levelTabs">
<div class="level-tab active" data-level="low" onclick="setLevel('low')">Low</div>
<div class="level-tab" data-level="med" onclick="setLevel('med')">Med</div>
<div class="level-tab" data-level="high" onclick="setLevel('high')">High</div>
</div>
<div class="divider"></div>
<div class="section-label">Key Words</div>
<div class="keyword-list" id="keywordList"></div>
<div style="flex:1;"></div>
<div class="divider"></div>
<button class="btn-reset red" onclick="resetSim()">Reset All</button>
<button class="btn-reset blue" style="margin-top:4px;" onclick="newRun()">New Run</button>
</div>

<!-- CENTER -->
<div class="center">
<div class="title-bar">Mr. Jawad Simulation Digestive System Failures ‚Äî "What Went Wrong?"</div>
<div class="step-tabs" id="stepTabs">
<div class="step-tab" data-step="predict">1. PREDICT</div>
<div class="step-tab" data-step="read">2. READ</div>
<div class="step-tab" data-step="watch">3. WATCH</div>
<div class="step-tab" data-step="record">4. RECORD</div>
</div>
<div class="center-content" id="centerContent">
<div class="welcome-state" id="welcomeState">
<span class="big-icon">ü©∫</span>
<h2>Body Detective</h2>
<p>Pick a case from the left to start investigating.</p>
<p style="margin-top:8px;font-size:13px;color:#64748b;">Complete 5 cases. All 8 = extra credit!</p>
</div>
</div>
<div class="action-area" id="actionArea">
<button class="action-btn hidden" id="mainBtn" onclick="advanceStep()">Start</button>
<button class="action-btn read-aloud hidden" id="readAloudBtn" onclick="toggleReadAloud()">üîä Read Aloud</button>
</div>
</div>

<!-- RIGHT SIDEBAR -->
<div class="sidebar-right">
<div class="hud-title">Progress</div>
<div class="hud-grid">
<div class="hud-cell"><div class="hud-val" id="hudScore">0</div><div class="hud-lbl">Score</div></div>
<div class="hud-cell"><div class="hud-val" id="hudStreak">0</div><div class="hud-lbl">Streak</div></div>
<div class="hud-cell"><div class="hud-val" id="hudDone">0/5</div><div class="hud-lbl">Completed</div></div>
<div class="hud-cell"><div class="hud-val" id="hudAcc">0%</div><div class="hud-lbl">Accuracy</div></div>
</div>
<div class="progress-section">
<div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
<div class="progress-msg" id="progressMsg">Pick 5 more you like!</div>
</div>
<div id="completionArea"></div>
<div class="divider"></div>
<div class="data-header">
<div class="section-label" style="margin:0;">Data Table</div>
<button class="copy-btn" id="copyBtn" onclick="copyTable()">üìã Copy Table</button>
</div>
<div style="overflow-x:auto;">
<table class="data-table" id="dataTable">
<thead><tr><th>Scenario</th><th>What Changed?</th><th>System Response</th><th>Back Toward OK?</th></tr></thead>
<tbody id="dataBody"></tbody>
</table>
</div>
</div>
</div>

<script>
// ========== DATA ==========
const SCENARIOS = [
{id:1,name:"The Shrinking Athlete",emoji:"üèãÔ∏è",failFunction:"absorption",
keywords:["absorption","villi","villous atrophy"],
readings:{
low:{text:'A college athlete eats 4,000 calories every day, but she keeps losing weight. Her coach notices she looks tired and weak even after big meals. Doctors test her blood and find almost no iron, calcium, or vitamin D. Something inside her small intestine is blocking <kw>absorption</kw> ‚Äî nutrients pass right through without entering her bloodstream.',kws:["absorption"]},
med:{text:'A college athlete eats 4,000 calories every day ‚Äî more than most adults need. But she keeps losing weight, and her coach notices she looks exhausted after every practice. Doctors run blood tests and find dangerously low iron, calcium, and vitamin D. An intestinal biopsy reveals the problem: her <kw>villi</kw> ‚Äî the tiny finger-like bumps that handle <kw>absorption</kw> ‚Äî are almost completely flat. This is called <kw>villous atrophy</kw>. Without healthy villi, her small intestine cannot grab nutrients from food, so everything passes through her body unused.',kws:["villi","absorption","villous atrophy"]},
high:{text:'A college athlete eats 4,000 calories every day ‚Äî enough fuel for intense training. But she keeps losing weight, her energy crashes by mid-practice, and her bones ache. Doctors run blood tests and find dangerously low levels of iron, calcium, and vitamin D. An intestinal biopsy solves the mystery: her <kw>villi</kw> are almost completely flat. Healthy villi are tall, finger-like bumps that create massive surface area for <kw>absorption</kw>. When villi flatten ‚Äî a condition called <kw>villous atrophy</kw> ‚Äî that surface area disappears. Her small intestine has food passing through it constantly, but almost no nutrients make it into her bloodstream. She eats like an athlete but her body absorbs like someone who is starving.',kws:["villi","absorption","villous atrophy"]}
},
watchDesc:"Villi flattened ‚Äî nutrients flow through uncaptured",
dataRow:["The Shrinking Athlete","Villi flattened (villous atrophy)","Absorption failed ‚Äî nutrients not captured","No ‚Äî needs villi to regrow"]
},
{id:2,name:"The Ice Cream Emergency",emoji:"üç¶",failFunction:"breakdown",
keywords:["enzyme"],
readings:{
low:{text:'A 12-year-old eats ice cream at a birthday party. Within an hour, his stomach cramps up, gas builds, and diarrhea hits hard. His body stopped making enough lactase ‚Äî the <kw>enzyme</kw> that breaks down milk sugar. Without that <kw>enzyme</kw>, the sugar moves undigested to the large intestine, where bacteria attack it and produce painful gas.',kws:["enzyme"]},
med:{text:'A 12-year-old eats ice cream at a birthday party and feels fine at first. Within an hour, painful cramps twist his stomach, gas builds, and he rushes to the bathroom with diarrhea. His body used to make plenty of lactase ‚Äî the <kw>enzyme</kw> that breaks down lactose, the sugar in milk. But like most humans, his body slowed down lactase production after early childhood. Without enough of the <kw>enzyme</kw>, undigested lactose reaches the large intestine. Bacteria there ferment the sugar, producing the gas and cramping that hit him so fast.',kws:["enzyme"]},
high:{text:'A 12-year-old eats ice cream at a birthday party ‚Äî two scoops of chocolate. An hour later, painful cramps hit, gas builds, and he barely makes it to the bathroom. His body used to produce plenty of lactase, the <kw>enzyme</kw> that breaks down lactose ‚Äî the sugar in all dairy products. But after early childhood, his body slowed production way down. Most humans on Earth experience this ‚Äî making lactase into adulthood is actually the unusual condition, not the other way around. Without enough of the <kw>enzyme</kw>, undigested lactose passes into the large intestine untouched. Bacteria in the large intestine ferment the sugar, releasing gas that causes bloating, cramps, and diarrhea. The breakdown system failed at one specific step ‚Äî and the symptoms hit fast.',kws:["enzyme"]}
},
watchDesc:"Missing enzyme ‚Äî lactose undigested, bacteria produce gas",
dataRow:["The Ice Cream Emergency","Missing lactase enzyme","Breakdown failed ‚Äî lactose not digested","No ‚Äî body stopped making enzyme"]
},
{id:3,name:"The Stomach That Stopped",emoji:"üõë",failFunction:"breakdown",
keywords:["peristalsis"],
readings:{
low:{text:'A retired competitive eater can no longer feel full, and food sits in his stomach for hours without moving. Years of extreme eating stretched his stomach so much that it lost the ability to squeeze. Without <kw>peristalsis</kw> ‚Äî the muscle motion that pushes food forward ‚Äî nothing moves to the small intestine. The breakdown process stalls because food just sits there.',kws:["peristalsis"]},
med:{text:'A retired competitive eater walks into the doctor\'s office with constant nausea and vomiting. For years, he trained his stomach to stretch far beyond normal size by eating massive amounts in minutes. Now his stomach muscles are so damaged they can barely contract. The squeezing motion called <kw>peristalsis</kw> ‚Äî which normally pushes food forward through the digestive tract ‚Äî has nearly shut down. Food sits in his stomach for hours without moving toward the small intestine. Doctors call this gastroparesis, and without <kw>peristalsis</kw>, the entire breakdown process stalls at the stomach.',kws:["peristalsis"]},
high:{text:'A retired competitive eater used to swallow dozens of hot dogs in minutes. Now he cannot keep food down. Years of extreme stretching destroyed his stomach\'s ability to contract ‚Äî a condition called gastroparesis. The squeezing muscle motion called <kw>peristalsis</kw> normally pushes food from the stomach into the small intestine in waves. His stomach muscles are so damaged that food just sits there for hours. Without movement, food cannot reach the small intestine for <kw>absorption</kw>, and <kw>gastric acid</kw> keeps working on food that has nowhere to go. He experiences constant nausea, vomiting, and malnutrition ‚Äî even though he eats regular meals. The breakdown chain broke at its most basic step: moving food forward.',kws:["peristalsis","absorption","gastric acid"]}
},
watchDesc:"Peristalsis frozen ‚Äî food stuck in stretched stomach",
dataRow:["The Stomach That Stopped","Peristalsis lost (gastroparesis)","Breakdown failed ‚Äî food stuck in stomach","No ‚Äî stomach muscles too damaged"]
},
{id:4,name:"The Battery Burn",emoji:"üîã",failFunction:"protection",
keywords:["mucus lining"],
readings:{
low:{text:'A 2-year-old swallows a small button battery from a remote control. Within hours, she starts drooling and refuses to eat. The battery gets stuck in her esophagus and creates an electrical current. That current burns through the <kw>mucus lining</kw> and tissue in under two hours.',kws:["mucus lining"]},
med:{text:'A 2-year-old grabs a small button battery from a remote control and swallows it before anyone notices. Within hours, she starts drooling, crying, and refusing all food. X-rays show the battery lodged in her esophagus ‚Äî and it is already causing damage. Button batteries create an electrical current when they touch wet tissue, and that current burns through the esophageal wall in under two hours. A penny would pass through the digestive system harmlessly. But a battery is a chemical and electrical hazard that destroys the <kw>mucus lining</kw> and tissue underneath. The body\'s protection system cannot defend against this kind of attack.',kws:["mucus lining"]},
high:{text:'Over 80,000 children visit U.S. emergency rooms each year for swallowed objects. Coins are the most common ‚Äî and usually pass through harmlessly. But button batteries are different. A 2-year-old swallows one from a remote control, and within hours she is drooling, crying, and refusing food. X-rays reveal the battery stuck in her esophagus, pressing against the wet tissue. The battery creates an electrical current on contact, and that current can burn through the esophageal wall in under two hours. Unlike the stomach, the esophagus has very little <kw>mucus lining</kw> to protect itself. The body\'s protection system is overwhelmed ‚Äî surgeons must remove the battery immediately before the damage becomes life-threatening.',kws:["mucus lining"]}
},
watchDesc:"Battery burns through mucus lining ‚Äî protection destroyed",
dataRow:["The Battery Burn","Battery burned mucus lining","Protection failed ‚Äî tissue exposed","No ‚Äî requires surgery to fix"]
},
{id:5,name:"The Mystery Deficiency",emoji:"üî¨",failFunction:"absorption",
keywords:["villi","villous atrophy","absorption"],
readings:{
low:{text:'A patient eats balanced meals every day but blood tests show dangerously low iron, calcium, and vitamin D. Doctors are confused ‚Äî she is eating enough. A biopsy of her small intestine reveals the answer: her <kw>villi</kw> are almost completely flat. <kw>Villous atrophy</kw> has destroyed the surface area needed for <kw>absorption</kw>, so nutrients pass right through.',kws:["villi","villous atrophy","absorption"]},
med:{text:'A woman eats three balanced meals a day ‚Äî fruits, vegetables, protein, grains. But her blood tests tell a different story: iron is dangerously low, calcium is dropping, and vitamin D is nearly gone. Her doctor orders an intestinal biopsy and finds the answer. Her <kw>villi</kw> ‚Äî the tiny finger-like structures that grab nutrients during <kw>absorption</kw> ‚Äî are almost completely flat. This condition is called <kw>villous atrophy</kw>. Without tall, healthy villi, her small intestine has almost no surface area to capture what she eats, so nutrients flow through and leave her body unused.',kws:["villi","absorption","villous atrophy"]},
high:{text:'A woman eats three balanced meals a day and has never skipped her vitamins. But something is wrong ‚Äî she feels exhausted, her bones ache, and she bruises easily. Blood tests reveal dangerously low iron, calcium, and vitamin D despite her healthy diet. Her doctor suspects the problem is not what she eats but how her body handles it. An intestinal biopsy confirms it: her <kw>villi</kw> are nearly flat. Healthy <kw>villi</kw> are tall, finger-like projections that create massive surface area for <kw>absorption</kw> in the small intestine. When they flatten ‚Äî a condition called <kw>villous atrophy</kw> ‚Äî that surface area collapses. Food passes through her intestine like water through a smooth pipe, and almost nothing gets absorbed into her bloodstream.',kws:["villi","absorption","villous atrophy"]}
},
watchDesc:"Villi flattened ‚Äî surface area lost, nutrients not absorbed",
dataRow:["The Mystery Deficiency","Villi flattened (villous atrophy)","Absorption failed ‚Äî nutrients pass through","No ‚Äî villi must recover first"]
},
{id:6,name:"The Antacid Trap",emoji:"üíä",failFunction:"breakdown",
keywords:["gastric acid","enzyme"],
readings:{
low:{text:'A man takes antacid pills every day for years to stop his heartburn. The antacids lower his <kw>gastric acid</kw> so much that food is not fully broken down. Chunks of undigested food reach the small intestine, causing bloating and gas. By fixing one problem, he created another ‚Äî not enough acid to do its job.',kws:["gastric acid"]},
med:{text:'A man has dealt with heartburn and acid reflux for years ‚Äî that burning feeling when <kw>gastric acid</kw> flows up into his esophagus. He takes antacid pills every day, and the heartburn stops. But new problems appear: bloating, gas, and stomach pain after meals. The antacids reduced his stomach acid so much that food is no longer fully broken down before reaching the small intestine. His <kw>enzymes</kw> still work, but they need acid to activate properly. The breakdown step is now incomplete ‚Äî and his body absorbs fewer nutrients from partially digested food.',kws:["gastric acid","enzyme"]},
high:{text:'A man has battled heartburn for years. Every time he eats, <kw>gastric acid</kw> creeps up through a weak valve into his esophagus, burning tissue that has no <kw>mucus lining</kw> to protect it. His doctor prescribes daily antacids, and the burning stops almost immediately. But a year later, new symptoms appear: bloating after every meal, painful gas, and fatigue. The antacids lowered his stomach acid so far that food no longer breaks down properly before leaving the stomach. His <kw>enzymes</kw> need a certain acid level to activate ‚Äî without it, they barely function. Chunks of undigested food reach the small intestine, where bacteria ferment them and produce gas. He solved the protection problem but broke the breakdown system ‚Äî a tradeoff his body cannot afford long-term.',kws:["gastric acid","mucus lining","enzyme"]}
},
watchDesc:"Antacids killed acid ‚Äî enzymes can't activate, food undigested",
dataRow:["The Antacid Trap","Gastric acid too low (antacids)","Breakdown failed ‚Äî food not digested","No ‚Äî needs acid level restored"]
},
{id:7,name:"The Stomach Blockage",emoji:"üß±",failFunction:"breakdown",
keywords:["gastric acid","enzyme"],
readings:{
low:{text:'Surgeons open a patient\'s stomach and find a large, hard mass blocking the exit. The mass ‚Äî called a bezoar ‚Äî formed from materials that <kw>gastric acid</kw> and <kw>enzymes</kw> could not break down. Over months, fibers and other materials piled up because the breakdown system could not dissolve them. Without removal, the blockage would stop all food from moving forward.',kws:["gastric acid","enzyme"]},
med:{text:'A patient comes to the hospital with severe stomach pain, nausea, and vomiting after every meal. Imaging reveals a large, hard mass filling part of the stomach and blocking the exit to the small intestine. Surgeons remove it and identify it as a bezoar ‚Äî a ball of material that <kw>gastric acid</kw> and <kw>enzymes</kw> could not dissolve. Over many months, fibers, seeds, and other tough materials accumulated because the breakdown process could not handle them. The stomach kept adding acid, but some materials simply resist chemical digestion. Once the mass blocked the exit, no food ‚Äî even fully digested food ‚Äî could pass through to the small intestine for <kw>absorption</kw>.',kws:["gastric acid","enzyme","absorption"]},
high:{text:'A patient arrives at the hospital unable to keep any food down. For weeks, every meal ends in vomiting and sharp stomach pain. Imaging shows something alarming: a dense, solid mass filling the lower part of the stomach and completely blocking the exit. Surgeons remove the mass and identify it as a bezoar ‚Äî a compacted ball of material the body could not digest. <kw>Gastric acid</kw> is powerful enough to dissolve a razor blade, but certain plant fibers, seeds, and synthetic materials resist it entirely. Over months, these indigestible materials accumulated because <kw>enzymes</kw> had no effect on them either. The breakdown system failed not because it was weak, but because the material was too tough. Once the mass sealed the stomach\'s exit, even properly digested food had nowhere to go.',kws:["gastric acid","enzyme"]}
},
watchDesc:"Bezoar blocks stomach exit ‚Äî acid and enzymes can't dissolve it",
dataRow:["The Stomach Blockage","Bezoar blocked stomach exit","Breakdown failed ‚Äî indigestible mass","No ‚Äî requires surgical removal"]
},
{id:8,name:"The Traveler's Revenge",emoji:"üåç",failFunction:"absorption",
keywords:["villi","villous atrophy","absorption"],
readings:{
low:{text:'A college student drinks tap water on a trip abroad and gets severe diarrhea within 24 hours. A parasite called Giardia attached to the lining of her small intestine and flattened the <kw>villi</kw>. With damaged villi, <kw>absorption</kw> drops ‚Äî water and nutrients pass through without being captured. Even though she keeps eating and drinking, her body cannot hold onto what it needs.',kws:["villi","absorption"]},
med:{text:'A college student on a trip to Central America drinks tap water at a restaurant. Within 24 hours, she has severe diarrhea, cramps, and dehydration. Doctors find a waterborne parasite called Giardia has attached itself to the lining of her small intestine. The parasite damages the <kw>villi</kw>, flattening them and causing temporary <kw>villous atrophy</kw>. With flattened villi, her <kw>absorption</kw> drops sharply ‚Äî water and nutrients flow through without being captured. She keeps eating and drinking, but most of it passes right through her body until the infection is treated.',kws:["villi","villous atrophy","absorption"]},
high:{text:'A college student arrives in Central America for a study-abroad trip and drinks tap water at a local restaurant. Within 24 hours, severe diarrhea, cramps, and dehydration hit hard. Tests reveal a waterborne parasite called Giardia has invaded her small intestine. The parasite attaches directly to the intestinal lining and damages the <kw>villi</kw>, causing temporary <kw>villous atrophy</kw> ‚Äî the same flattening that happens in celiac disease, but from infection instead of an immune response. With flattened villi, her small intestine loses the surface area it needs for <kw>absorption</kw>. Water and nutrients flow through without being captured, which is why she becomes dehydrated even though she keeps drinking fluids. Up to 40 percent of Giardia patients also temporarily lose the ability to digest dairy ‚Äî the infection knocks out multiple systems at once. Once treated, her villi slowly recover and <kw>absorption</kw> returns to normal.',kws:["villi","villous atrophy","absorption"]}
},
watchDesc:"Parasite flattens villi ‚Äî absorption drops, dehydration hits",
dataRow:["The Traveler's Revenge","Giardia flattened villi","Absorption failed ‚Äî water/nutrients lost","Yes ‚Äî villi regrow after treatment"]
}
];

const ALL_KEYWORDS = ["enzyme","absorption","villous atrophy","mucus lining","villi","peristalsis","gastric acid"];

// ========== STATE ==========
let state = {
currentScenario: null,
currentStep: null, // 'predict','read','watch','record'
readingLevel: 'low',
prediction: null,
completed: new Set(),
score: 0,
streak: 0,
correctPredictions: 0,
totalPredictions: 0,
dataRows: [],
speechActive: false,
speechUtterance: null,
speechResumeInterval: null
};

// ========== INIT ==========
function init(){
try{
renderScenarioList();
renderKeywords();
updateHUD();
}catch(e){console.error('Init error:',e);}
}

function renderScenarioList(){
const el = document.getElementById('scenarioList');
el.innerHTML = SCENARIOS.map(s=>`
<div class="scenario-card ${state.completed.has(s.id)?'completed':''} ${state.currentScenario&&state.currentScenario.id===s.id?'selected':''}" id="sc-${s.id}" onclick="selectScenario(${s.id})">
<span class="sc-emoji">${s.emoji}</span>
<span class="sc-name">${s.name}</span>
</div>`).join('');
}

function renderKeywords(){
const el = document.getElementById('keywordList');
const activeKws = state.currentScenario ? 
(state.currentScenario.readings[state.readingLevel]?.kws || []) : [];
el.innerHTML = ALL_KEYWORDS.map(kw=>`
<div class="keyword-item ${activeKws.includes(kw)?'highlighted':''}">${kw}</div>`).join('');
}

// ========== SCENARIO SELECTION ==========
function selectScenario(id){
try{
if(state.currentStep==='watch') return;
stopSpeech();
const sc = SCENARIOS.find(s=>s.id===id);
if(!sc) return;
state.currentScenario = sc;
state.currentStep = 'predict';
state.prediction = null;
renderScenarioList();
renderKeywords();
updateStepTabs();
showPredictStep();
}catch(e){console.error('Select error:',e);}
}

function setLevel(lv){
state.readingLevel = lv;
document.querySelectorAll('.level-tab').forEach(t=>t.classList.toggle('active',t.dataset.level===lv));
renderKeywords();
if(state.currentStep==='read') showReadStep();
}

// ========== STEP MANAGEMENT ==========
function updateStepTabs(){
document.querySelectorAll('.step-tab').forEach(tab=>{
const step = tab.dataset.step;
tab.classList.remove('active','done');
if(step===state.currentStep) tab.classList.add('active');
const order = ['predict','read','watch','record'];
if(order.indexOf(step)<order.indexOf(state.currentStep)) tab.classList.add('done');
});
}

function advanceStep(){
try{
const order = ['predict','read','watch','record'];
const idx = order.indexOf(state.currentStep);
if(idx<order.length-1){
const next = order[idx+1];
state.currentStep = next;
updateStepTabs();
if(next==='read') showReadStep();
else if(next==='watch') showWatchStep();
else if(next==='record') showRecordStep();
}
}catch(e){console.error('Advance error:',e);}
}

// ========== PREDICT STEP ==========
function showPredictStep(){
const cc = document.getElementById('centerContent');
const sc = state.currentScenario;
document.getElementById('welcomeState')?.classList.add('hidden');
cc.innerHTML = `
<div class="content-card fade-in predict-box">
<h2>${sc.emoji} ${sc.name}</h2>
<p class="predict-q">Which function do you think will fail?</p>
<div class="predict-btns">
<div class="predict-btn" onclick="makePrediction('breakdown',this)">‚öôÔ∏è Breakdown</div>
<div class="predict-btn" onclick="makePrediction('protection',this)">üõ°Ô∏è Protection</div>
<div class="predict-btn" onclick="makePrediction('absorption',this)">ü©∏ Absorption</div>
</div>
</div>`;
const btn = document.getElementById('mainBtn');
btn.classList.add('hidden');
document.getElementById('readAloudBtn').classList.add('hidden');
}

function makePrediction(fn, el){
if(state.prediction) return;
state.prediction = fn;
state.totalPredictions++;
if(fn===state.currentScenario.failFunction) state.correctPredictions++;
document.querySelectorAll('.predict-btn').forEach(b=>b.style.opacity='0.4');
el.style.opacity='1';
el.classList.add('chosen');
const btn = document.getElementById('mainBtn');
btn.textContent = 'Next: Read the Case ‚Üí';
btn.classList.remove('hidden');
btn.disabled = false;
}

// ========== READ STEP ==========
function showReadStep(){
stopSpeech();
const sc = state.currentScenario;
const reading = sc.readings[state.readingLevel];
const cc = document.getElementById('centerContent');
let html = reading.text;
html = html.replace(/<kw>(.*?)<\/kw>/g,'<span class="kw">$1</span>');
// Wrap sentences for read-aloud
const sentences = html.split(/(?<=[.!?])\s+/);
const wrapped = sentences.map((s,i)=>`<span class="sent" data-si="${i}">${s}</span>`).join(' ');
cc.innerHTML = `
<div class="content-card fade-in">
<h2>${sc.emoji} ${sc.name}</h2>
<div class="passage-card">${wrapped}</div>
</div>`;
const btn = document.getElementById('mainBtn');
btn.textContent = 'Next: Watch the Diagnosis ‚Üí';
btn.classList.remove('hidden');
btn.disabled = false;
document.getElementById('readAloudBtn').classList.remove('hidden');
}

// ========== READ ALOUD ==========
let synthReady = false;
function initSpeech(){
try{
if(!window.speechSynthesis) return false;
synthReady = true;
return true;
}catch(e){return false;}
}

function toggleReadAloud(){
try{
if(state.speechActive){stopSpeech();return;}
if(!synthReady && !initSpeech()){return;}
const sents = document.querySelectorAll('.sent');
if(!sents.length) return;
state.speechActive = true;
document.getElementById('readAloudBtn').textContent = '‚èπÔ∏è Stop';
speakSentences(sents, 0);
// Chrome 15-second bug workaround
state.speechResumeInterval = setInterval(()=>{
try{if(window.speechSynthesis.speaking) window.speechSynthesis.resume();}catch(e){}
},10000);
}catch(e){console.error('Read aloud error:',e);stopSpeech();}
}

function speakSentences(sents, idx){
try{
if(!state.speechActive || idx>=sents.length){stopSpeech();return;}
sents.forEach(s=>s.classList.remove('speaking'));
sents[idx].classList.add('speaking');
sents[idx].scrollIntoView({behavior:'smooth',block:'nearest'});
const text = sents[idx].textContent;
const utt = new SpeechSynthesisUtterance(text);
utt.rate = 0.9;
utt.onend = ()=>speakSentences(sents, idx+1);
utt.onerror = ()=>speakSentences(sents, idx+1);
window.speechSynthesis.cancel();
window.speechSynthesis.speak(utt);
state.speechUtterance = utt;
// Safety timeout
setTimeout(()=>{
if(state.speechActive && window.speechSynthesis.speaking){
try{window.speechSynthesis.cancel();}catch(e){}
speakSentences(sents, idx+1);
}
},15000);
}catch(e){stopSpeech();}
}

function stopSpeech(){
try{
state.speechActive = false;
if(state.speechResumeInterval){clearInterval(state.speechResumeInterval);state.speechResumeInterval=null;}
if(window.speechSynthesis){window.speechSynthesis.cancel();}
document.querySelectorAll('.sent').forEach(s=>s.classList.remove('speaking'));
const btn = document.getElementById('readAloudBtn');
if(btn) btn.textContent = 'üîä Read Aloud';
}catch(e){}
}

// ========== WATCH STEP ==========
function showWatchStep(){
stopSpeech();
document.getElementById('readAloudBtn').classList.add('hidden');
document.getElementById('mainBtn').classList.add('hidden');
const sc = state.currentScenario;
const cc = document.getElementById('centerContent');

const failFn = sc.failFunction;
const breakdownColor = failFn==='breakdown'?'#ef4444':'#22c55e';
const protectionColor = failFn==='protection'?'#ef4444':'#22c55e';
const absorptionColor = failFn==='absorption'?'#ef4444':'#22c55e';
const breakdownPos = failFn==='breakdown'?'10%':'50%';
const protectionPos = failFn==='protection'?'10%':'50%';
const absorptionPos = failFn==='absorption'?'10%':'50%';

cc.innerHTML = `
<div class="watch-arena fade-in" id="watchArena">
<div class="gauge-panel">
<div class="gauge"><div class="gauge-label">‚öôÔ∏è Breakdown</div><div class="gauge-bar"><div class="gauge-ok"></div><div class="gauge-fill" id="gBreakdown" style="width:50%;background:#22c55e;"></div><div class="gauge-indicator" id="giBreakdown" style="left:50%;"></div></div></div>
<div class="gauge"><div class="gauge-label">üõ°Ô∏è Protection</div><div class="gauge-bar"><div class="gauge-ok"></div><div class="gauge-fill" id="gProtection" style="width:50%;background:#22c55e;"></div><div class="gauge-indicator" id="giProtection" style="left:50%;"></div></div></div>
<div class="gauge"><div class="gauge-label">ü©∏ Absorption</div><div class="gauge-bar"><div class="gauge-ok"></div><div class="gauge-fill" id="gAbsorption" style="width:50%;background:#22c55e;"></div><div class="gauge-indicator" id="giAbsorption" style="left:50%;"></div></div></div>
</div>
<div class="arena-visual" id="arenaVisual"></div>
</div>`;

// Start animation after brief delay
setTimeout(()=>{try{runWatchAnimation(sc);}catch(e){console.error('Watch anim error:',e);finishWatch();}},600);
}

function runWatchAnimation(sc){
const arena = document.getElementById('arenaVisual');
if(!arena) return;
const failFn = sc.failFunction;

// Build scenario-specific arena content
arena.innerHTML = getArenaHTML(sc);

// Animate gauges after 1s
setTimeout(()=>{
try{
const gEl = document.getElementById('g'+capitalize(failFn));
const giEl = document.getElementById('gi'+capitalize(failFn));
if(gEl){gEl.style.width='15%';gEl.style.background='#ef4444';}
if(giEl){giEl.style.left='15%';}
}catch(e){}
},1000);

// Animate arena elements after 1.5s
setTimeout(()=>{try{animateArena(sc);}catch(e){}},1500);

// Auto-advance after 6s
setTimeout(()=>{finishWatch();},6000);
}

function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}

function getArenaHTML(sc){
const id = sc.id;
let h = '<div class="arena-scene">';
switch(id){
case 1: // Shrinking Athlete - villi flattened
h+=`
<div style="position:absolute;left:50%;top:10%;transform:translateX(-50%);text-align:center;">
<div class="organ-label" style="position:relative;font-size:14px;background:rgba(30,64,175,0.8);padding:4px 16px;">SMALL INTESTINE</div>
</div>
<div id="villiContainer" style="position:absolute;bottom:15%;left:10%;right:10%;height:50%;display:flex;align-items:flex-end;justify-content:center;gap:8px;">
${Array(12).fill(0).map((_,i)=>`<div class="villi-finger" id="vf${i}" style="width:18px;height:60px;background:linear-gradient(180deg,#f472b6,#ec4899);border-radius:9px 9px 0 0;transition:all 1.5s ease;box-shadow:0 0 8px rgba(236,72,153,0.4);"></div>`).join('')}
</div>
<div id="nutrientFlow" style="position:absolute;top:30%;left:10%;right:10%;height:20%;overflow:hidden;"></div>
<div class="organ-label" style="bottom:8%;left:50%;transform:translateX(-50%);" id="villiLabel">Healthy Villi</div>`;
break;
case 2: // Ice Cream - missing enzyme
h+=`
<div style="position:absolute;left:50%;top:8%;transform:translateX(-50%);text-align:center;">
<div class="organ-label" style="position:relative;font-size:14px;background:rgba(30,64,175,0.8);padding:4px 16px;">DIGESTIVE TRACT</div>
</div>
<div style="position:absolute;top:25%;left:20%;width:25%;text-align:center;">
<div style="font-size:48px;" id="enzymeIcon">üß™</div>
<div class="organ-label" style="position:relative;margin-top:4px;">Enzyme</div>
</div>
<div style="position:absolute;top:20%;left:55%;width:35%;text-align:center;">
<div style="font-size:36px;">ü•õ</div>
<div style="font-size:12px;color:#94a3b8;margin-top:4px;">Lactose molecule</div>
<div id="lactoseArrow" style="margin-top:8px;font-size:24px;color:#f59e0b;opacity:0;transition:all 1s;">‚¨áÔ∏è</div>
</div>
<div style="position:absolute;bottom:12%;left:50%;transform:translateX(-50%);text-align:center;">
<div class="organ-label" style="position:relative;font-size:13px;background:rgba(153,27,27,0.8);padding:4px 16px;" id="bacteriaLabel">Large Intestine</div>
<div id="gasBubbles" style="margin-top:8px;font-size:24px;opacity:0;transition:all 1s;">üí®üí®üí®</div>
</div>`;
break;
case 3: // Stomach That Stopped - peristalsis frozen
h+=`
<div style="position:absolute;left:50%;top:8%;transform:translateX(-50%);">
<div class="organ-label" style="position:relative;font-size:14px;background:rgba(30,64,175,0.8);padding:4px 16px;">STOMACH</div>
</div>
<div style="position:absolute;top:22%;left:15%;width:30%;text-align:center;" id="normalStomach">
<div style="font-size:48px;">ü´É</div>
<div style="font-size:11px;color:#22c55e;margin-top:4px;font-weight:700;">Normal</div>
<div id="normalWaves" style="font-size:18px;color:#22c55e;margin-top:4px;">‚Üì ‚Üì ‚Üì</div>
</div>
<div style="position:absolute;top:22%;right:15%;width:30%;text-align:center;" id="damagedStomach">
<div style="font-size:64px;">ü´É</div>
<div style="font-size:11px;color:#ef4444;margin-top:4px;font-weight:700;">Stretched</div>
<div id="frozenWaves" style="font-size:18px;color:#64748b;margin-top:4px;">‚Äî ‚Äî ‚Äî</div>
</div>
<div style="position:absolute;bottom:12%;left:50%;transform:translateX(-50%);text-align:center;">
<div class="organ-label" style="position:relative;font-size:12px;background:rgba(153,27,27,0.8);padding:4px 16px;" id="peristalsisLabel">Peristalsis Frozen</div>
<div id="clockIcon" style="font-size:32px;margin-top:8px;opacity:0;transition:all 1s;">‚è∞</div>
</div>`;
break;
case 4: // Battery Burn - protection failure
h+=`
<div style="position:absolute;left:50%;top:8%;transform:translateX(-50%);">
<div class="organ-label" style="position:relative;font-size:14px;background:rgba(30,64,175,0.8);padding:4px 16px;">ESOPHAGUS</div>
</div>
<div style="position:absolute;top:20%;left:50%;transform:translateX(-50%);width:60px;display:flex;flex-direction:column;align-items:center;">
<div style="width:50px;height:180px;background:linear-gradient(180deg,#fda4af,#fb7185);border-radius:8px;position:relative;border:2px solid #f43f5e;overflow:hidden;" id="esophagusTube">
<div id="mucusLayer" style="position:absolute;inset:4px;background:rgba(74,222,128,0.3);border-radius:4px;transition:all 2s;"></div>
<div id="batteryObj" style="position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:20px;">üîã</div>
<div id="burnZone" style="position:absolute;top:35%;left:0;right:0;height:30%;background:rgba(239,68,68,0);border-radius:4px;transition:all 2s;"></div>
</div>
</div>
<div id="sparkEffect" style="position:absolute;top:45%;left:50%;transform:translateX(-50%);font-size:24px;opacity:0;transition:all 0.5s;">‚ö°‚ö°</div>
<div style="position:absolute;bottom:10%;left:50%;transform:translateX(-50%);text-align:center;">
<div class="organ-label" style="position:relative;font-size:12px;background:rgba(153,27,27,0.8);padding:4px 16px;">Mucus Lining Destroyed</div>
</div>`;
break;
case 5: // Mystery Deficiency - villi flat
h+=`
<div style="position:absolute;left:50%;top:8%;transform:translateX(-50%);">
<div class="organ-label" style="position:relative;font-size:14px;background:rgba(30,64,175,0.8);padding:4px 16px;">SMALL INTESTINE WALL</div>
</div>
<div style="position:absolute;top:22%;left:8%;width:40%;text-align:center;">
<div style="font-size:11px;color:#22c55e;font-weight:700;margin-bottom:4px;">HEALTHY</div>
<div style="display:flex;gap:3px;justify-content:center;align-items:flex-end;height:60px;">
${Array(6).fill(0).map(()=>`<div style="width:12px;height:50px;background:linear-gradient(180deg,#4ade80,#22c55e);border-radius:6px 6px 0 0;"></div>`).join('')}
</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px;">Tall villi catch nutrients</div>
</div>
<div style="position:absolute;top:22%;right:8%;width:40%;text-align:center;" id="patientVilli">
<div style="font-size:11px;color:#ef4444;font-weight:700;margin-bottom:4px;">PATIENT</div>
<div style="display:flex;gap:3px;justify-content:center;align-items:flex-end;height:60px;" id="flatVilliRow">
${Array(6).fill(0).map((_,i)=>`<div id="pv${i}" style="width:12px;height:50px;background:linear-gradient(180deg,#f87171,#ef4444);border-radius:6px 6px 0 0;transition:height 2s ease;"></div>`).join('')}
</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px;">Flattened ‚Äî nutrients lost</div>
</div>
<div style="position:absolute;bottom:18%;left:50%;transform:translateX(-50%);display:flex;gap:12px;" id="nutrientIcons">
<div style="font-size:24px;opacity:0;transition:all 1s;" id="ni1">üî¥ Fe</div>
<div style="font-size:24px;opacity:0;transition:all 1s;" id="ni2">ü¶¥ Ca</div>
<div style="font-size:24px;opacity:0;transition:all 1s;" id="ni3">‚òÄÔ∏è Vit D</div>
</div>
<div class="organ-label" style="position:absolute;bottom:8%;left:50%;transform:translateX(-50%);background:rgba(153,27,27,0.8);" id="surfaceLabel">Surface Area: CRITICAL</div>`;
break;
case 6: // Antacid Trap - acid too low
h+=`
<div style="position:absolute;left:50%;top:8%;transform:translateX(-50%);">
<div class="organ-label" style="position:relative;font-size:14px;background:rgba(30,64,175,0.8);padding:4px 16px;">STOMACH</div>
</div>
<div style="position:absolute;top:22%;left:50%;transform:translateX(-50%);width:120px;height:140px;background:linear-gradient(180deg,#fda4af,#fb7185);border-radius:0 0 50% 50%;border:2px solid #f43f5e;overflow:hidden;position:relative;" id="stomachShape">
<div id="acidPool" style="position:absolute;bottom:0;left:0;right:0;height:60%;background:linear-gradient(180deg,rgba(251,146,60,0.8),rgba(234,88,12,0.9));transition:all 2s;border-radius:0 0 50% 50%;"></div>
<div id="pillIcon" style="position:absolute;top:10%;left:50%;transform:translateX(-50%);font-size:24px;opacity:0;transition:all 1s;">üíä</div>
<div id="foodChunks" style="position:absolute;top:30%;left:50%;transform:translateX(-50%);font-size:18px;opacity:0;transition:all 1s;">üçñü•©üßÄ</div>
</div>
<div style="position:absolute;bottom:18%;left:50%;transform:translateX(-50%);font-size:24px;opacity:0;transition:all 1s;" id="bloatEffect">üò´ üí®</div>
<div class="organ-label" style="position:absolute;bottom:8%;left:50%;transform:translateX(-50%);background:rgba(153,27,27,0.8);">Acid Too Low</div>`;
break;
case 7: // Stomach Blockage - bezoar
h+=`
<div style="position:absolute;left:50%;top:8%;transform:translateX(-50%);">
<div class="organ-label" style="position:relative;font-size:14px;background:rgba(30,64,175,0.8);padding:4px 16px;">STOMACH CROSS-SECTION</div>
</div>
<div style="position:absolute;top:22%;left:50%;transform:translateX(-50%);width:140px;height:150px;background:linear-gradient(180deg,#fda4af,#fb7185);border-radius:0 0 50% 50%;border:2px solid #f43f5e;overflow:hidden;" id="stomachBlock">
<div id="bezoarMass" style="position:absolute;bottom:5%;left:50%;transform:translateX(-50%);width:20px;height:20px;background:radial-gradient(circle,#78350f,#451a03);border-radius:40%;transition:all 2s;box-shadow:0 0 8px rgba(120,53,15,0.5);"></div>
<div id="acidSplash" style="position:absolute;bottom:40%;left:50%;transform:translateX(-50%);font-size:12px;opacity:0;transition:all 1s;">üí¶üí¶</div>
<div id="foodPileup" style="position:absolute;top:15%;left:50%;transform:translateX(-50%);font-size:16px;opacity:0;transition:all 1.5s;">üçñü•©ü•¶</div>
</div>
<div id="blockedSign" style="position:absolute;bottom:18%;left:50%;transform:translateX(-50%);font-size:16px;font-weight:700;color:#ef4444;opacity:0;transition:all 1s;background:rgba(0,0,0,0.6);padding:4px 12px;border-radius:6px;">üö´ 100% BLOCKED</div>
<div class="organ-label" style="position:absolute;bottom:8%;left:50%;transform:translateX(-50%);background:rgba(153,27,27,0.8);">Bezoar Blocks Exit</div>`;
break;
case 8: // Traveler's Revenge - parasites
h+=`
<div style="position:absolute;left:50%;top:8%;transform:translateX(-50%);">
<div class="organ-label" style="position:relative;font-size:14px;background:rgba(30,64,175,0.8);padding:4px 16px;">SMALL INTESTINE</div>
</div>
<div style="position:absolute;top:22%;left:10%;right:10%;text-align:center;">
<div style="display:flex;gap:4px;justify-content:center;align-items:flex-end;height:70px;" id="travelVilli">
${Array(10).fill(0).map((_,i)=>`<div id="tv${i}" style="width:14px;height:55px;background:linear-gradient(180deg,#f472b6,#ec4899);border-radius:7px 7px 0 0;transition:all 2s;position:relative;"><span id="bug${i}" style="position:absolute;top:-8px;left:50%;transform:translateX(-50%);font-size:10px;opacity:0;transition:all 1s;">ü¶†</span></div>`).join('')}
</div>
</div>
<div style="position:absolute;bottom:28%;left:50%;transform:translateX(-50%);display:flex;gap:8px;" id="waterLoss">
<div style="font-size:20px;opacity:0;transition:all 1s;" id="wl1">üíß</div>
<div style="font-size:20px;opacity:0;transition:all 1.2s;" id="wl2">üíß</div>
<div style="font-size:20px;opacity:0;transition:all 1.4s;" id="wl3">üíß</div>
<div style="font-size:14px;opacity:0;transition:all 1.5s;color:#ef4444;font-weight:700;align-self:center;" id="wl4">LOST</div>
</div>
<div id="dehydrationWarn" style="position:absolute;bottom:12%;left:50%;transform:translateX(-50%);font-size:14px;font-weight:700;color:#f59e0b;opacity:0;transition:all 1s;background:rgba(0,0,0,0.6);padding:4px 12px;border-radius:6px;">‚ö†Ô∏è DEHYDRATION</div>
<div class="organ-label" style="position:absolute;bottom:4%;left:50%;transform:translateX(-50%);background:rgba(153,27,27,0.8);">Parasites Flatten Villi</div>`;
break;
}
h+='</div>';
return h;
}

function animateArena(sc){
const id = sc.id;
try{
switch(id){
case 1: // flatten villi, show nutrients flowing past
for(let i=0;i<12;i++){
const vf = document.getElementById('vf'+i);
if(vf){vf.style.height='12px';vf.style.background='linear-gradient(180deg,#94a3b8,#64748b)';vf.style.boxShadow='none';}
}
const vl = document.getElementById('villiLabel');
if(vl){vl.textContent='Villi Flattened ‚Äî 0% Absorbed';vl.style.background='rgba(153,27,27,0.8)';}
const nf = document.getElementById('nutrientFlow');
if(nf) nf.innerHTML = '<div style="font-size:16px;animation:flowRight 2s linear infinite;">üî¥ü¶¥‚òÄÔ∏è ‚Üí ‚Üí ‚Üí LOST</div>';
break;
case 2: // enzyme fades, gas erupts
const ei = document.getElementById('enzymeIcon');
if(ei){ei.style.opacity='0.15';ei.style.filter='grayscale(1)';}
const la = document.getElementById('lactoseArrow');
if(la) la.style.opacity='1';
setTimeout(()=>{
const gb = document.getElementById('gasBubbles');
if(gb) gb.style.opacity='1';
const bl = document.getElementById('bacteriaLabel');
if(bl){bl.textContent='Bacteria Ferment Sugar ‚Üí GAS';bl.style.background='rgba(153,27,27,0.9)';}
},1500);
break;
case 3: // frozen waves, clock appears
const ci = document.getElementById('clockIcon');
if(ci) ci.style.opacity='1';
const fw = document.getElementById('frozenWaves');
if(fw){fw.textContent='‚úñ ‚úñ ‚úñ';fw.style.color='#ef4444';}
break;
case 4: // battery burns, sparks, mucus dissolves
const sp = document.getElementById('sparkEffect');
if(sp) sp.style.opacity='1';
const ml = document.getElementById('mucusLayer');
if(ml) ml.style.background='rgba(239,68,68,0.4)';
const bz = document.getElementById('burnZone');
if(bz) bz.style.background='rgba(239,68,68,0.6)';
break;
case 5: // patient villi flatten, nutrient icons appear
for(let i=0;i<6;i++){
const pv = document.getElementById('pv'+i);
if(pv){pv.style.height='10px';pv.style.background='linear-gradient(180deg,#94a3b8,#64748b)';}
}
setTimeout(()=>{
['ni1','ni2','ni3'].forEach((id,i)=>{
setTimeout(()=>{const el=document.getElementById(id);if(el){el.style.opacity='1';el.style.transform='translateY(20px)';}},i*400);
});
},1000);
break;
case 6: // acid fades, pills appear, food chunks, bloating
const pi = document.getElementById('pillIcon');
if(pi) pi.style.opacity='1';
const ap = document.getElementById('acidPool');
if(ap) ap.style.height='15%';
if(ap) ap.style.background='linear-gradient(180deg,rgba(253,224,71,0.3),rgba(250,204,21,0.2))';
setTimeout(()=>{
const fc = document.getElementById('foodChunks');
if(fc) fc.style.opacity='1';
},1200);
setTimeout(()=>{
const be = document.getElementById('bloatEffect');
if(be) be.style.opacity='1';
},2000);
break;
case 7: // bezoar grows, acid bounces, food piles
const bm = document.getElementById('bezoarMass');
if(bm){bm.style.width='70px';bm.style.height='50px';}
setTimeout(()=>{
const as2 = document.getElementById('acidSplash');
if(as2) as2.style.opacity='1';
},800);
setTimeout(()=>{
const fp = document.getElementById('foodPileup');
if(fp) fp.style.opacity='1';
const bs = document.getElementById('blockedSign');
if(bs) bs.style.opacity='1';
},1800);
break;
case 8: // parasites attach, villi shrink, water lost
for(let i=0;i<10;i++){
setTimeout(()=>{
const bug = document.getElementById('bug'+i);
if(bug) bug.style.opacity='1';
const tv = document.getElementById('tv'+i);
if(tv){tv.style.height='15px';tv.style.background='linear-gradient(180deg,#94a3b8,#64748b)';}
},i*150);
}
setTimeout(()=>{
['wl1','wl2','wl3','wl4'].forEach((wid,i)=>{
setTimeout(()=>{const el=document.getElementById(wid);if(el){el.style.opacity='1';el.style.transform='translateY(15px)';}},i*300);
});
},1800);
setTimeout(()=>{
const dw = document.getElementById('dehydrationWarn');
if(dw) dw.style.opacity='1';
},3000);
break;
}
}catch(e){console.error('Arena anim error:',e);}
}

function finishWatch(){
try{
const btn = document.getElementById('mainBtn');
btn.textContent = 'Record Data ‚Üí';
btn.classList.remove('hidden');
btn.disabled = false;
}catch(e){
// Safety: auto-advance
setTimeout(()=>advanceStep(),1000);
}
}

// ========== RECORD STEP ==========
function showRecordStep(){
const sc = state.currentScenario;
state.completed.add(sc.id);
state.score++;
if(state.prediction===sc.failFunction) state.streak++;
else state.streak=0;
state.dataRows.push(sc.dataRow);

const cc = document.getElementById('centerContent');
const correct = state.prediction===sc.failFunction;
cc.innerHTML = `
<div class="content-card fade-in record-msg">
<span class="big-check">${correct?'‚úÖ':'üîç'}</span>
<h2>${correct?'Correct Diagnosis!':'Case Recorded'}</h2>
<p style="margin-top:8px;font-size:14px;color:#94a3b8;">The failing function was: <strong style="color:${sc.failFunction==='breakdown'?'#f59e0b':sc.failFunction==='protection'?'#a78bfa':'#60a5fa'}">${sc.failFunction.toUpperCase()}</strong></p>
<p style="margin-top:6px;font-size:13px;color:#64748b;">${sc.watchDesc}</p>
${state.completed.size>=5 && state.completed.size<8?'<p style="margin-top:12px;font-size:15px;color:#22c55e;font-weight:700;">Required Complete! Keep going for extra credit!</p>':''}
${state.completed.size>=8?'<p style="margin-top:12px;font-size:15px;color:#f59e0b;font-weight:700;">üèÜ Extra Credit Complete! All 8 cases investigated!</p>':''}
</div>`;

document.getElementById('mainBtn').classList.add('hidden');
renderScenarioList();
updateHUD();
addDataRow(sc.dataRow);
state.currentStep = null;
updateStepTabs();
}

function addDataRow(row){
const tbody = document.getElementById('dataBody');
const tr = document.createElement('tr');
tr.classList.add('slide-in');
tr.innerHTML = row.map(c=>`<td>${c}</td>`).join('');
tbody.appendChild(tr);
}

// ========== HUD ==========
function updateHUD(){
try{
const done = state.completed.size;
const req = 5;
document.getElementById('hudScore').textContent = state.score;
document.getElementById('hudStreak').textContent = state.streak;
document.getElementById('hudDone').textContent = `${done}/${req}`;
document.getElementById('hudAcc').textContent = state.totalPredictions?Math.round(state.correctPredictions/state.totalPredictions*100)+'%':'0%';
const pct = Math.min(100, (done/req)*100);
document.getElementById('progressFill').style.width = pct+'%';
const remaining = Math.max(0, req-done);
let msg = remaining>0?`Pick ${remaining} more you like!`:'Required complete!';
if(done>=8) msg='All 8 cases complete! üèÜ';
document.getElementById('progressMsg').textContent = msg;

const ca = document.getElementById('completionArea');
if(done>=5 && done<8) ca.innerHTML='<div class="completion-banner">‚úÖ 5 Required Complete!</div>';
else if(done>=8) ca.innerHTML='<div class="completion-banner ec-banner">üèÜ Extra Credit Complete!</div>';
else ca.innerHTML='';
}catch(e){console.error('HUD error:',e);}
}

// ========== COPY TABLE ==========
function copyTable(){
try{
if(state.dataRows.length===0) return;
let text = "Scenario\tWhat Changed?\tSystem Response\tBack Toward OK?\n";
state.dataRows.forEach(r=>{text+=r.join('\t')+'\n';});
navigator.clipboard.writeText(text).then(()=>{
const btn = document.getElementById('copyBtn');
btn.textContent='‚úì Copied!';
btn.classList.add('copied');
setTimeout(()=>{btn.textContent='üìã Copy Table';btn.classList.remove('copied');},2000);
}).catch(()=>{});
}catch(e){}
}

// ========== RESET ==========
function resetSim(){
stopSpeech();
state = {currentScenario:null,currentStep:null,readingLevel:state.readingLevel,prediction:null,completed:new Set(),score:0,streak:0,correctPredictions:0,totalPredictions:0,dataRows:[],speechActive:false,speechUtterance:null,speechResumeInterval:null};
document.getElementById('dataBody').innerHTML='';
document.getElementById('completionArea').innerHTML='';
renderScenarioList();
renderKeywords();
updateHUD();
const cc = document.getElementById('centerContent');
cc.innerHTML = `
<div class="welcome-state" id="welcomeState">
<span class="big-icon">ü©∫</span>
<h2>Body Detective</h2>
<p>Pick a case from the left to start investigating.</p>
<p style="margin-top:8px;font-size:13px;color:#64748b;">Complete 5 cases. All 8 = extra credit!</p>
</div>`;
document.getElementById('mainBtn').classList.add('hidden');
document.getElementById('readAloudBtn').classList.add('hidden');
document.querySelectorAll('.step-tab').forEach(t=>t.classList.remove('active','done'));
}

function newRun(){resetSim();}

// ========== CSS ANIMATION KEYFRAMES ==========
const style = document.createElement('style');
style.textContent = `@keyframes flowRight{0%{transform:translateX(-100%);}100%{transform:translateX(200%);}}`;
document.head.appendChild(style);

// ========== START ==========
init();
</script>
</body>
</html>
