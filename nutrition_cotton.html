<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation: King Cotton</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#1a1a2e;color:#fff;overflow:hidden;height:100vh;}
#app{display:flex;flex-direction:column;height:100vh;}

/* HEADER */
.header{background:linear-gradient(135deg,#2d1810,#5c3a21,#2d1810);padding:6px 20px;text-align:center;border-bottom:3px solid #d4a853;flex-shrink:0;}
.header h1{font-size:18px;color:#d4a853;text-shadow:0 0 10px rgba(212,168,83,0.5);letter-spacing:1px;}

/* MISSION BAR */
.mission-bar{background:linear-gradient(90deg,#1b5e20,#2e7d32,#1b5e20);padding:6px 20px;text-align:center;flex-shrink:0;border-bottom:2px solid #4caf50;display:flex;justify-content:center;align-items:center;gap:16px;}
.mission-bar .goal{display:flex;align-items:center;gap:6px;font-size:13px;font-weight:700;}
.mission-bar .goal .icon{font-size:20px;}
.mission-bar .vs{color:#fdd835;font-size:18px;font-weight:900;}
.mission-bar .tip{font-size:11px;color:#a5d6a7;font-style:italic;}

.main{display:flex;flex:1;overflow:hidden;}

/* LEFT PANEL */
.left-panel{width:280px;min-width:280px;background:linear-gradient(180deg,#1e1e3a,#16213e);padding:10px;display:flex;flex-direction:column;gap:6px;border-right:2px solid #333;overflow-y:auto;}
.panel-section{background:rgba(255,255,255,0.05);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.1);}
.panel-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:#888;margin-bottom:4px;}

.round-counter{text-align:center;font-size:26px;font-weight:900;color:#d4a853;text-shadow:0 0 15px rgba(212,168,83,0.4);}
.round-sub{font-size:10px;color:#888;margin-top:2px;text-align:center;}

/* Challenge box */
.challenge-box{background:linear-gradient(135deg,rgba(255,152,0,0.15),rgba(255,87,34,0.1));border:1px solid #ff9800;border-radius:10px;padding:8px;text-align:center;}
.challenge-box .challenge-label{font-size:9px;text-transform:uppercase;letter-spacing:2px;color:#ff9800;}
.challenge-box .challenge-text{font-size:12px;font-weight:700;color:#fff;margin-top:3px;line-height:1.3;}
.challenge-box .challenge-text em{color:#fdd835;font-style:normal;}

/* Price Banner */
.price-banner{text-align:center;padding:8px;border-radius:10px;font-size:20px;font-weight:900;transition:all 0.5s;position:relative;overflow:hidden;}
.price-banner.high{background:linear-gradient(135deg,#f9a825,#ff8f00);color:#fff;box-shadow:0 0 20px rgba(249,168,37,0.5);}
.price-banner.medium{background:linear-gradient(135deg,#8d6e63,#6d4c41);color:#fff;}
.price-banner.crashed{background:linear-gradient(135deg,#c62828,#b71c1c);color:#fff;box-shadow:0 0 20px rgba(198,40,40,0.5);animation:crashPulse 0.4s ease 3;}
@keyframes crashPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}
.price-sub{font-size:9px;color:rgba(255,255,255,0.7);}

/* SLIDER */
.slider-instruct{font-size:10px;color:#fdd835;text-align:center;margin-bottom:4px;font-weight:600;}
.slider-container{position:relative;}
.slider-labels{display:flex;justify-content:space-between;font-size:10px;color:#aaa;margin-bottom:3px;}
.slider-labels span:first-child{color:#4caf50;}
.slider-labels span:last-child{color:#fff;}
.land-slider{-webkit-appearance:none;width:100%;height:14px;border-radius:7px;outline:none;cursor:pointer;}
.land-slider::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:#d4a853;border:3px solid #fff;cursor:pointer;box-shadow:0 0 10px rgba(212,168,83,0.5);}
.land-slider:disabled{opacity:0.35;cursor:not-allowed;}
.slider-value{text-align:center;font-size:18px;font-weight:900;margin-top:3px;}
.slider-value .cotton-val{color:#fff;}
.slider-value .food-val{color:#4caf50;}

/* Food Choice */
.food-buttons{display:flex;gap:4px;}
.food-btn{flex:1;padding:7px 3px;border:2px solid #444;border-radius:8px;background:rgba(255,255,255,0.05);color:#777;font-size:9px;font-weight:700;cursor:pointer;transition:all 0.3s;text-align:center;line-height:1.2;}
.food-btn.active{border-color:#4caf50;color:#fff;background:rgba(76,175,80,0.2);box-shadow:0 0 10px rgba(76,175,80,0.3);}
.food-btn:disabled{opacity:0.3;cursor:not-allowed;}
.food-btn .food-icon{font-size:18px;display:block;margin-bottom:1px;}
.locked-overlay{display:none;font-size:9px;color:#ff9800;margin-top:3px;text-align:center;font-weight:600;}
.locked-overlay.show{display:block;}

/* GO Button */
.go-btn{width:100%;padding:12px;border:none;border-radius:12px;font-size:20px;font-weight:900;cursor:pointer;transition:all 0.3s;background:linear-gradient(135deg,#4caf50,#2e7d32);color:#fff;box-shadow:0 4px 15px rgba(76,175,80,0.4);text-transform:uppercase;letter-spacing:2px;}
.go-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(76,175,80,0.6);}
.go-btn:disabled{background:linear-gradient(135deg,#555,#444);box-shadow:none;cursor:not-allowed;transform:none;}

.bottom-btns{display:flex;gap:6px;margin-top:auto;padding-top:6px;}
.reset-btn,.newrun-btn{flex:1;padding:7px;border:none;border-radius:8px;font-size:10px;font-weight:700;cursor:pointer;text-transform:uppercase;}
.reset-btn{background:#c62828;color:#fff;}
.newrun-btn{background:#1565c0;color:#fff;}

/* CENTER */
.center-panel{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden;}

/* HUD */
.hud{display:flex;gap:6px;padding:6px 10px;background:rgba(0,0,0,0.4);flex-shrink:0;justify-content:center;flex-wrap:wrap;}
.hud-item{background:rgba(255,255,255,0.08);border-radius:10px;padding:4px 12px;text-align:center;min-width:90px;border:1px solid rgba(255,255,255,0.1);}
.hud-label{font-size:8px;text-transform:uppercase;letter-spacing:1px;color:#888;}
.hud-value{font-size:20px;font-weight:900;margin-top:1px;}
.hud-value.money{color:#4caf50;}
.hud-value.sick{color:#ef5350;}
.hud-value.streak{color:#ff9800;}
.hud-value.score{color:#d4a853;}
.hud-value.level{color:#ab47bc;}

/* Dual Meter Bar */
.dual-meter{display:flex;gap:8px;padding:4px 10px;background:rgba(0,0,0,0.25);flex-shrink:0;align-items:center;}
.meter-group{flex:1;display:flex;align-items:center;gap:5px;}
.meter-icon{font-size:14px;}
.meter-track{flex:1;height:14px;background:#333;border-radius:7px;overflow:hidden;position:relative;}
.meter-fill{height:100%;border-radius:7px;transition:width 0.8s ease,background 0.8s ease;}
.meter-fill::after{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(180deg,rgba(255,255,255,0.2),transparent);border-radius:7px 7px 0 0;}
.meter-text{position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:9px;font-weight:700;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.8);}

/* Arena */
.arena{flex:1;position:relative;overflow:hidden;}
canvas#arenaCanvas{width:100%;height:100%;display:block;}

/* Overlays */
.overlay-notif{position:absolute;left:50%;transform:translateX(-50%);padding:10px 24px;border-radius:14px;font-weight:700;font-size:14px;z-index:10;display:none;pointer-events:none;text-align:center;}
.powerup-notif{top:10px;background:linear-gradient(135deg,#ff9800,#f57c00);box-shadow:0 4px 15px rgba(255,152,0,0.5);animation:popIn 0.4s ease;}
.event-notif{top:10px;background:linear-gradient(135deg,#c62828,#b71c1c);box-shadow:0 4px 15px rgba(198,40,40,0.5);animation:popIn 0.4s ease;}
.round-result{top:50%;transform:translate(-50%,-50%);font-size:18px;padding:16px 30px;border-radius:16px;border:2px solid rgba(255,255,255,0.2);}
.round-result.good{background:linear-gradient(135deg,rgba(76,175,80,0.9),rgba(46,125,50,0.9));}
.round-result.warn{background:linear-gradient(135deg,rgba(255,152,0,0.9),rgba(245,124,0,0.9));}
.round-result.bad{background:linear-gradient(135deg,rgba(229,57,53,0.9),rgba(183,28,28,0.9));}
@keyframes popIn{from{transform:translateX(-50%) scale(0.5);opacity:0;}to{transform:translateX(-50%) scale(1);opacity:1;}}

/* Message modal */
.msg-modal{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(10,10,30,0.95);padding:24px 36px;border-radius:18px;text-align:center;z-index:20;display:none;border:2px solid #d4a853;max-width:420px;box-shadow:0 0 40px rgba(212,168,83,0.3);}
.msg-modal .badge{font-size:56px;margin-bottom:8px;}
.msg-modal h2{color:#d4a853;font-size:22px;margin-bottom:6px;}
.msg-modal p{color:#ccc;font-size:13px;line-height:1.4;}
.msg-modal button{margin-top:14px;padding:10px 28px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#4caf50,#2e7d32);color:#fff;box-shadow:0 4px 12px rgba(76,175,80,0.4);}

/* RIGHT PANEL */
.right-panel{width:290px;min-width:290px;background:linear-gradient(180deg,#1e1e3a,#16213e);display:flex;flex-direction:column;border-left:2px solid #333;}
.results-header{padding:6px 10px;background:rgba(0,0,0,0.3);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.results-header h3{font-size:12px;color:#d4a853;}
.copy-btn{padding:4px 10px;border:none;border-radius:6px;background:#1565c0;color:#fff;font-size:10px;cursor:pointer;font-weight:600;transition:all 0.3s;}
.copy-btn:hover{background:#1976d2;}
.copy-btn.copied{background:#4caf50;}

.data-table-wrap{flex:1;overflow-y:auto;padding:3px;}
table.dt{width:100%;border-collapse:collapse;font-size:10px;}
table.dt th{background:#2a2a4a;padding:5px 3px;text-align:center;color:#d4a853;font-size:9px;position:sticky;top:0;z-index:2;border-bottom:2px solid #d4a853;}
table.dt td{padding:5px 3px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.05);}
table.dt tr.filled{background:rgba(255,255,255,0.03);}
table.dt tr.filled:nth-child(even){background:rgba(255,255,255,0.06);}
table.dt tr.flash{animation:rowFlash 1.2s ease;}
@keyframes rowFlash{0%{background:rgba(212,168,83,0.5);}100%{background:transparent;}}
table.dt tr.empty td{color:#444;}

.progress-section{padding:6px 10px;background:rgba(0,0,0,0.2);flex-shrink:0;}
.pbar-wrap{height:10px;background:#333;border-radius:5px;overflow:hidden;margin-top:3px;}
.pbar-fill{height:100%;background:linear-gradient(90deg,#4caf50,#66bb6a);border-radius:5px;transition:width 0.5s;}
.progress-text{font-size:10px;color:#888;margin-top:3px;text-align:center;}

.badges{display:flex;gap:3px;flex-wrap:wrap;padding:4px 10px;}
.badge-item{background:rgba(212,168,83,0.15);border:1px solid #d4a853;border-radius:8px;padding:2px 7px;font-size:9px;color:#d4a853;}
</style>
</head>
<body>
<div id="app">
  <div class="header"><h1>üè† Mr. Jawad Simulation: King Cotton üè†</h1></div>

  <div class="mission-bar">
    <div class="goal"><span class="icon">üí∞</span> Keep Money Up</div>
    <div class="vs">‚öñÔ∏è</div>
    <div class="goal"><span class="icon">üíö</span> Keep People Healthy</div>
    <div class="tip">‚Äî find the balance before the epidemic wins ‚Äî</div>
  </div>

  <div class="main">
    <!-- LEFT -->
    <div class="left-panel">
      <div class="panel-section">
        <div class="round-counter">Round <span id="roundNum">1</span> / 8</div>
        <div class="round-sub" id="roundStatus">5 required</div>
      </div>

      <div class="challenge-box" id="challengeBox">
        <div class="challenge-label">Your Challenge</div>
        <div class="challenge-text" id="challengeText">Drag the slider to decide: <em>more cotton = more money</em> but <em>less food = more sickness</em></div>
      </div>

      <div class="panel-section">
        <div class="panel-label">Cotton Price This Round</div>
        <div class="price-banner high" id="priceBanner"><div id="priceText">HIGH</div><div class="price-sub">Cotton earns big</div></div>
      </div>

      <div class="panel-section">
        <div class="slider-instruct" id="sliderInstruct">‚Üï How much land grows cotton vs. food?</div>
        <div class="slider-container">
          <div class="slider-labels"><span>üåø Food</span><span>Cotton üåæ</span></div>
          <input type="range" min="0" max="100" value="50" step="10" class="land-slider" id="landSlider">
          <div class="slider-value"><span class="cotton-val" id="cottonVal">50%</span> Cotton / <span class="food-val" id="foodVal">50%</span> Food</div>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-label">Food Choice</div>
        <div class="food-buttons">
          <button class="food-btn active" id="btnLocalCorn" data-food="Local Corn" disabled><span class="food-icon">üåΩ</span>Local Corn</button>
          <button class="food-btn" id="btnShippedCorn" data-food="Shipped Corn" disabled><span class="food-icon">üì¶</span>Shipped Corn</button>
          <button class="food-btn" id="btnDiverseDiet" data-food="Diverse Diet" disabled><span class="food-icon">ü•©</span>Diverse Diet</button>
        </div>
        <div class="locked-overlay show" id="foodLock">üîí Unlocks Round 5</div>
      </div>

      <button class="go-btn" id="goBtn">‚ñ∂ GO</button>

      <div class="bottom-btns">
        <button class="reset-btn" id="resetBtn">Reset</button>
        <button class="newrun-btn" id="newRunBtn">New Run</button>
      </div>
    </div>

    <!-- CENTER -->
    <div class="center-panel">
      <div class="hud">
        <div class="hud-item"><div class="hud-label">Money</div><div class="hud-value money" id="hudMoney">$500</div></div>
        <div class="hud-item"><div class="hud-label">Score</div><div class="hud-value score" id="hudScore">0</div></div>
        <div class="hud-item"><div class="hud-label">Streak</div><div class="hud-value streak" id="hudStreak">0üî•</div></div>
        <div class="hud-item"><div class="hud-label">Level</div><div class="hud-value level" id="hudLevel">Rookie</div></div>
      </div>
      <div class="dual-meter">
        <div class="meter-group">
          <span class="meter-icon">üí∞</span>
          <div class="meter-track"><div class="meter-fill" id="moneyMeter" style="width:50%;background:linear-gradient(90deg,#4caf50,#66bb6a);"></div><span class="meter-text" id="moneyMeterTxt">$500</span></div>
        </div>
        <div class="meter-group">
          <span class="meter-icon">ü§í</span>
          <div class="meter-track"><div class="meter-fill" id="sickMeter" style="width:0%;background:#4caf50;"></div><span class="meter-text" id="sickMeterTxt">0%</span></div>
        </div>
      </div>

      <div class="arena">
        <canvas id="arenaCanvas"></canvas>
        <div class="overlay-notif powerup-notif" id="powerupNotif">ü•¨ Farmer's Market Boost!</div>
        <div class="overlay-notif event-notif" id="eventNotif"></div>
        <div class="overlay-notif round-result" id="roundResult"></div>
        <div class="msg-modal" id="msgModal">
          <div class="badge" id="msgBadge"></div>
          <h2 id="msgTitle"></h2>
          <p id="msgText"></p>
          <button onclick="dismissMsg()">Continue</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right-panel">
      <div class="results-header">
        <h3>üìã Data Table</h3>
        <button class="copy-btn" id="copyBtn" onclick="copyTable()">üìã Copy Table</button>
      </div>
      <div class="data-table-wrap">
        <table class="dt"><thead><tr><th>Round</th><th>Land (% Cotton)</th><th>Food</th><th>Sick (%)</th></tr></thead><tbody id="tableBody"></tbody></table>
      </div>
      <div class="progress-section">
        <div class="panel-label">Progress</div>
        <div class="pbar-wrap"><div class="pbar-fill" id="progressFill" style="width:0%"></div></div>
        <div class="progress-text" id="progressText">5 more to go</div>
      </div>
      <div class="badges" id="badgesArea"></div>
    </div>
  </div>
</div>

<script>
// ============ GAME STATE ============
const S = {
  round:1, money:500, score:0, streak:0, sickRate:0, sickCount:0,
  pop:50, cottonPct:50, food:'Local Corn', lockedLand:null,
  price:'HIGH', data:[], phase:'ready', badges:[],
  lowStreak:0, powerUsed:false, crashRound:0, crashed:false, marketBoost:false
};

// ============ PRICE SCHEDULE ============
const PRICES = ['HIGH','HIGH','MEDIUM','HIGH','MEDIUM','HIGH','MEDIUM','HIGH'];
function getPrice(r) {
  if (!S.crashed) {
    if (r === 4) { S.crashed = true; S.crashRound = 4; return 'CRASHED'; }
  }
  if (S.crashed && r === S.crashRound) return 'CRASHED';
  return PRICES[r - 1] || 'MEDIUM';
}

// ============ SICK RATE ============
function calcSick(cotton, food, price) {
  try {
    let base;
    if (food === 'Local Corn') {
      base = 12 + cotton * 0.55;
    } else if (food === 'Shipped Corn') {
      base = 18 + cotton * 0.52;
    } else {
      base = cotton > 90 ? (25 + (cotton - 90) * 3) : Math.max(1, cotton * 0.08);
    }
    if (price === 'CRASHED') { if (cotton > 60) base += 15; else if (cotton > 30) base += 5; }
    if (S.marketBoost) { base = Math.max(1, base - 10); S.marketBoost = false; }
    base += (Math.random() * 4 - 2);
    return Math.round(Math.max(0, Math.min(100, base)));
  } catch(e) { return 20; }
}

// ============ DOM ============
const $ = id => document.getElementById(id);

// Slider
const landSlider = $('landSlider');
landSlider.addEventListener('input', () => {
  if (S.phase !== 'ready') return;
  S.cottonPct = +landSlider.value;
  $('cottonVal').textContent = S.cottonPct + '%';
  $('foodVal').textContent = (100 - S.cottonPct) + '%';
  updateSliderBg();
  requestDraw();
});

function updateSliderBg() {
  const p = S.cottonPct;
  landSlider.style.background = `linear-gradient(to right, #4caf50 0%, #4caf50 ${100-p}%, #8d6e63 ${100-p}%, #e8e0d4 100%)`;
}

// Food buttons
const foodBtns = document.querySelectorAll('.food-btn');
foodBtns.forEach(b => b.addEventListener('click', () => {
  if (b.disabled || S.phase !== 'ready') return;
  foodBtns.forEach(x => x.classList.remove('active'));
  b.classList.add('active');
  S.food = b.dataset.food;
  requestDraw();
}));

// ============ TABLE ============
function initTable() {
  const tb = $('tableBody');
  tb.innerHTML = '';
  for (let i = 1; i <= 8; i++) {
    const tr = document.createElement('tr');
    tr.className = 'empty'; tr.id = 'row' + i;
    tr.innerHTML = `<td>${i}</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>`;
    tb.appendChild(tr);
  }
}

function copyTable() {
  try {
    let t = 'Round\tLand Choice (% Cotton)\tFood Choice\tSick Rate (%)\n';
    S.data.forEach(d => { t += `${d.round}\t${d.cotton}%\t${d.food}\t${d.sick}%\n`; });
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(t).then(() => flashCopy()).catch(() => fallbackCopy(t));
    } else { fallbackCopy(t); }
  } catch(e) { /* silent */ }
}
function fallbackCopy(t) {
  try { const a = document.createElement('textarea'); a.value = t; document.body.appendChild(a); a.select(); document.execCommand('copy'); document.body.removeChild(a); flashCopy(); } catch(e) {}
}
function flashCopy() {
  const b = $('copyBtn'); b.textContent = '‚úÖ Copied!'; b.classList.add('copied');
  setTimeout(() => { b.textContent = 'üìã Copy Table'; b.classList.remove('copied'); }, 2000);
}

// ============ HUD ============
function updateHUD() {
  try {
    $('hudMoney').textContent = '$' + S.money;
    $('hudScore').textContent = S.score;
    $('hudStreak').textContent = S.streak + 'üî•';
    // Level
    let lvl = 'Rookie';
    if (S.score >= 500) lvl = 'Expert';
    else if (S.score >= 300) lvl = 'Skilled';
    else if (S.score >= 150) lvl = 'Rising';
    $('hudLevel').textContent = lvl;
    // Money meter
    const mp = Math.min(100, S.money / 10);
    $('moneyMeter').style.width = mp + '%';
    $('moneyMeter').style.background = mp > 40 ? 'linear-gradient(90deg,#4caf50,#66bb6a)' : 'linear-gradient(90deg,#ff9800,#ffa726)';
    $('moneyMeterTxt').textContent = '$' + S.money;
    // Sick meter
    const sp = S.sickRate;
    $('sickMeter').style.width = sp + '%';
    $('sickMeter').style.background = sp < 15 ? 'linear-gradient(90deg,#4caf50,#66bb6a)' : sp < 30 ? 'linear-gradient(90deg,#ff9800,#ffa726)' : 'linear-gradient(90deg,#ef5350,#e53935)';
    $('sickMeterTxt').textContent = sp + '%';
    // Progress
    const done = S.data.length;
    $('progressFill').style.width = Math.min(100, done / 5 * 100) + '%';
    if (done >= 8) $('progressText').textContent = 'üåü All 8 complete!';
    else if (done >= 5) $('progressText').textContent = (8 - done) + ' more for extra credit';
    else $('progressText').textContent = (5 - done) + ' more to go';
  } catch(e) {}
}

// ============ CONTROLS STATE ============
function updateControls() {
  try {
    const r = S.round;
    $('roundNum').textContent = r;
    // Price
    S.price = getPrice(r);
    const pb = $('priceBanner');
    pb.className = 'price-banner ' + S.price.toLowerCase();
    $('priceText').textContent = S.price;
    pb.querySelector('.price-sub').textContent = S.price === 'HIGH' ? 'Cotton earns big' : S.price === 'MEDIUM' ? 'Cotton earns OK' : 'Cotton earns almost nothing!';

    // Rounds 1-4: slider free, food locked
    if (r <= 4) {
      landSlider.disabled = false;
      foodBtns.forEach(b => b.disabled = true);
      $('foodLock').classList.add('show');
      S.food = 'Local Corn';
      foodBtns.forEach(b => b.classList.remove('active'));
      $('btnLocalCorn').classList.add('active');
      $('sliderInstruct').textContent = '‚Üï How much land grows cotton vs. food?';
      $('challengeText').innerHTML = 'Drag the slider: <em>more cotton = more $</em> but <em>less food = more sickness</em>';
    } else {
      if (S.lockedLand === null) S.lockedLand = S.cottonPct;
      landSlider.value = S.lockedLand;
      S.cottonPct = S.lockedLand;
      $('cottonVal').textContent = S.cottonPct + '%';
      $('foodVal').textContent = (100 - S.cottonPct) + '%';
      updateSliderBg();
      landSlider.disabled = true;
      foodBtns.forEach(b => b.disabled = false);
      if (S.cottonPct > 90) $('btnDiverseDiet').disabled = true;
      $('foodLock').classList.remove('show');
      $('sliderInstruct').textContent = 'üîí Locked to Round 4 value';
      $('challengeText').innerHTML = 'Now change <em>Food Choice</em> ‚Äî can the RIGHT food fix the sickness?';
    }
    // Round status
    if (S.data.length < 5) $('roundStatus').textContent = (5 - S.data.length) + ' required left';
    else $('roundStatus').textContent = '‚≠ê Extra Credit';
  } catch(e) {}
}

// ============ GO ============
$('goBtn').addEventListener('click', () => {
  try {
    if (S.phase !== 'ready' || S.round > 8) return;
    S.phase = 'animating';
    $('goBtn').disabled = true;
    landSlider.disabled = true;
    foodBtns.forEach(b => b.disabled = true);

    // Crash event
    if (S.price === 'CRASHED') showNotif($('eventNotif'), 'üí• Cotton Price CRASHED!');

    // Calc
    const sick = calcSick(S.cottonPct, S.food, S.price);
    let income = Math.round(S.cottonPct * (S.price === 'HIGH' ? 8 : S.price === 'MEDIUM' ? 5 : 1.5));
    let cost = S.food === 'Diverse Diet' ? 80 : S.food === 'Shipped Corn' ? 40 : 10;
    let sickCost = Math.round((sick / 100) * S.pop * 3);
    S.money = Math.max(0, S.money + income - cost - sickCost);

    let pts = sick < 10 ? 100 : sick < 20 ? 70 : sick < 40 ? 40 : 10;
    S.score += pts;
    if (sick < 20) S.streak++; else S.streak = 0;
    if (sick < 5) { S.lowStreak++; if (S.lowStreak >= 2 && !S.badges.includes('üè° Healthy Town')) { S.badges.push('üè° Healthy Town'); renderBadges(); } } else S.lowStreak = 0;

    const row = { round: S.round, cotton: S.cottonPct, food: S.food, sick };
    S.data.push(row);

    // Animate
    animateRound(sick, () => {
      try {
        // Flash result
        const rr = $('roundResult');
        const cls = sick < 15 ? 'good' : sick < 35 ? 'warn' : 'bad';
        rr.className = 'overlay-notif round-result ' + cls;
        rr.innerHTML = sick < 15 ? 'üíö Sick ' + sick + '% ‚Äî Nice!' : sick < 35 ? '‚ö†Ô∏è Sick ' + sick + '%' : 'üö® Sick ' + sick + '% ‚Äî Epidemic!';
        rr.style.display = 'block';
        setTimeout(() => { rr.style.display = 'none'; }, 1800);

        // Update table
        const tr = $('row' + S.round);
        tr.className = 'filled flash';
        tr.innerHTML = `<td>${row.round}</td><td>${row.cotton}%</td><td>${row.food}</td><td>${row.sick}%</td>`;
        updateHUD();

        // Milestones
        if (S.data.length === 5) {
          if (!S.badges.includes('‚úÖ Required')) { S.badges.push('‚úÖ Required'); renderBadges(); }
          setTimeout(() => showMsg('üéâ', 'Required Complete!', 'Great job! Keep going for Extra Credit ‚Äî or copy your data now.'), 800);
        } else if (S.data.length === 8) {
          if (!S.badges.includes('‚≠ê Extra Credit')) { S.badges.push('‚≠ê Extra Credit'); renderBadges(); }
          setTimeout(() => showMsg('üèÜ', 'Extra Credit Complete!', 'All 8 rounds done! Copy your data with the Copy Table button.'), 800);
        }

        // Power-up after round 5
        if (S.data.length === 5 && !S.powerUsed) {
          S.powerUsed = true; S.marketBoost = true;
          if (!S.badges.includes('ü•¨ Market')) { S.badges.push('ü•¨ Market'); renderBadges(); }
          showNotif($('powerupNotif'), 'ü•¨ Farmer\'s Market Boost! Next round sickness drops.');
        }

        S.round++;
        if (S.round <= 8) { S.phase = 'ready'; $('goBtn').disabled = false; updateControls(); }
        else { S.phase = 'done'; $('goBtn').disabled = true; $('goBtn').textContent = '‚úÖ DONE'; }
      } catch(e) { S.phase = 'ready'; $('goBtn').disabled = false; }
    });
  } catch(e) { S.phase = 'ready'; $('goBtn').disabled = false; }
});

// ============ NOTIFICATIONS ============
function showNotif(el, txt) {
  try { el.textContent = txt; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 3000); } catch(e) {}
}
function showMsg(badge, title, text) {
  try { $('msgBadge').textContent = badge; $('msgTitle').textContent = title; $('msgText').textContent = text; $('msgModal').style.display = 'block'; } catch(e) {}
}
function dismissMsg() { try { $('msgModal').style.display = 'none'; } catch(e) {} }
function renderBadges() {
  try { $('badgesArea').innerHTML = S.badges.map(b => `<div class="badge-item">${b}</div>`).join(''); } catch(e) {}
}

// ============ RESET ============
function fullReset() {
  try {
    animRunning = false;
    Object.assign(S, { round:1, money:500, score:0, streak:0, sickRate:0, sickCount:0, cottonPct:50, food:'Local Corn', lockedLand:null, data:[], phase:'ready', badges:[], lowStreak:0, powerUsed:false, crashRound:0, crashed:false, marketBoost:false });
    landSlider.value = 50; $('cottonVal').textContent = '50%'; $('foodVal').textContent = '50%';
    updateSliderBg(); $('goBtn').disabled = false; $('goBtn').textContent = '‚ñ∂ GO';
    initTable(); updateHUD(); updateControls(); renderBadges(); dismissMsg();
    townspeople.length = 0; requestDraw();
  } catch(e) { S.phase = 'ready'; }
}
$('resetBtn').addEventListener('click', fullReset);
$('newRunBtn').addEventListener('click', fullReset);

// ============ CANVAS ============
const canvas = $('arenaCanvas');
const ctx = canvas.getContext('2d');
let W = 800, H = 400;
let townspeople = [];
let drawQueued = false;
let animRunning = false;

function requestDraw() { if (!drawQueued) { drawQueued = true; requestAnimationFrame(() => { drawQueued = false; draw(); }); } }

function resize() {
  try {
    const r = canvas.parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = r.width * dpr;
    canvas.height = r.height * dpr;
    canvas.style.width = r.width + 'px';
    canvas.style.height = r.height + 'px';
    W = r.width; H = r.height;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    townspeople.length = 0;
    requestDraw();
  } catch(e) {}
}

function ensurePeople() {
  if (townspeople.length === S.pop) return;
  townspeople = [];
  for (let i = 0; i < S.pop; i++) {
    townspeople.push({
      x: W * 0.42 + Math.random() * W * 0.48,
      y: H * 0.38 + Math.random() * H * 0.18,
      ph: Math.random() * Math.PI * 2,
      sp: 0.4 + Math.random() * 0.6,
      sz: 0.8 + Math.random() * 0.4
    });
  }
  // Sort by y for depth
  townspeople.sort((a, b) => a.y - b.y);
}

function draw() {
  try { ctx.clearRect(0, 0, W, H); } catch(e) { return; }
  try { ensurePeople(); } catch(e) {}
  try { drawSky(); } catch(e) {}
  try { drawSun(); } catch(e) {}
  try { drawFields(); } catch(e) {}
  try { drawBuildings(); } catch(e) {}
  try { drawMarket(); } catch(e) {}
  try { drawPeople(); } catch(e) {}
  try { drawLabels(); } catch(e) {}
}

function drawSky() {
  const g = ctx.createLinearGradient(0, 0, 0, H * 0.35);
  g.addColorStop(0, '#64b5f6');
  g.addColorStop(1, '#e3f2fd');
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, W, H * 0.35);
  // Clouds
  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  const t = Date.now() / 8000;
  for (let i = 0; i < 4; i++) {
    const cx = ((t * 20 + i * W / 3.5) % (W + 100)) - 50;
    const cy = 20 + i * 18;
    drawCloud(cx, cy, 30 + i * 8);
  }
  // Ground
  const gg = ctx.createLinearGradient(0, H * 0.32, 0, H);
  gg.addColorStop(0, '#a5d6a7');
  gg.addColorStop(0.3, '#81c784');
  gg.addColorStop(1, '#66bb6a');
  ctx.fillStyle = gg;
  ctx.fillRect(0, H * 0.32, W, H * 0.68);
  // Dirt path
  ctx.fillStyle = '#bcaaa4';
  ctx.beginPath();
  ctx.moveTo(W * 0.38, H * 0.35);
  ctx.quadraticCurveTo(W * 0.5, H * 0.5, W * 0.42, H);
  ctx.lineTo(W * 0.48, H);
  ctx.quadraticCurveTo(W * 0.55, H * 0.5, W * 0.43, H * 0.35);
  ctx.fill();
}

function drawCloud(x, y, s) {
  ctx.beginPath();
  ctx.arc(x, y, s * 0.4, 0, Math.PI * 2);
  ctx.arc(x + s * 0.3, y - s * 0.15, s * 0.35, 0, Math.PI * 2);
  ctx.arc(x + s * 0.6, y, s * 0.3, 0, Math.PI * 2);
  ctx.arc(x - s * 0.25, y + s * 0.05, s * 0.25, 0, Math.PI * 2);
  ctx.fill();
}

function drawSun() {
  const sx = W * 0.12, sy = 30;
  // Glow
  const sg = ctx.createRadialGradient(sx, sy, 5, sx, sy, 50);
  sg.addColorStop(0, 'rgba(255,235,59,0.6)');
  sg.addColorStop(1, 'rgba(255,235,59,0)');
  ctx.fillStyle = sg;
  ctx.fillRect(sx - 50, sy - 50, 100, 100);
  // Sun
  ctx.fillStyle = '#fdd835';
  ctx.beginPath();
  ctx.arc(sx, sy, 16, 0, Math.PI * 2);
  ctx.fill();
  // Rays
  const t = Date.now() / 2000;
  ctx.strokeStyle = 'rgba(255,235,59,0.3)';
  ctx.lineWidth = 2;
  for (let i = 0; i < 8; i++) {
    const a = t + i * Math.PI / 4;
    ctx.beginPath();
    ctx.moveTo(sx + Math.cos(a) * 20, sy + Math.sin(a) * 20);
    ctx.lineTo(sx + Math.cos(a) * 32, sy + Math.sin(a) * 32);
    ctx.stroke();
  }
}

function drawFields() {
  const fY = H * 0.6, fH = H * 0.38;
  const cottonW = W * 0.38 * (S.cottonPct / 100);
  const foodW = W * 0.38 * ((100 - S.cottonPct) / 100);
  const t = Date.now() / 1000;

  // COTTON FIELD
  if (cottonW > 5) {
    // Soil
    const cg = ctx.createLinearGradient(0, fY, 0, fY + fH);
    cg.addColorStop(0, '#d7ccc8'); cg.addColorStop(1, '#bcaaa4');
    ctx.fillStyle = cg;
    rRect(ctx, 8, fY, cottonW, fH, 8);
    ctx.fill();
    // Fence
    ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 2;
    ctx.strokeRect(8, fY, cottonW, fH);
    // Cotton plants
    const cols = Math.max(1, Math.floor(cottonW / 22));
    const rows = Math.max(1, Math.floor(fH / 24));
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const px = 18 + c * (cottonW / cols);
        const py = fY + 14 + r * (fH / rows);
        if (px > cottonW + 5) continue;
        // Stem
        ctx.strokeStyle = '#6d4c41'; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(px, py + 5); ctx.lineTo(px, py + 14); ctx.stroke();
        // Leaves
        ctx.fillStyle = '#8bc34a';
        ctx.beginPath(); ctx.ellipse(px - 4, py + 8, 3, 1.5, -0.5, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(px + 4, py + 8, 3, 1.5, 0.5, 0, Math.PI * 2); ctx.fill();
        // Cotton boll
        const wave = Math.sin(t * 1.2 + c + r) * 1;
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(px, py + wave, 5, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#f5f5f5';
        ctx.beginPath(); ctx.arc(px - 2, py - 1 + wave, 3, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.arc(px + 2, py - 1 + wave, 3, 0, Math.PI * 2); ctx.fill();
      }
    }
    // Pollen particles
    for (let i = 0; i < Math.floor(cottonW / 15); i++) {
      const px = 10 + ((t * 18 + i * 47) % cottonW);
      const py = fY + 5 + Math.sin(t * 0.7 + i * 3) * (fH * 0.4) + fH * 0.3;
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.beginPath(); ctx.arc(px, py, 1.5 + Math.sin(t + i) * 0.5, 0, Math.PI * 2); ctx.fill();
    }
  }

  // FOOD FIELD
  const foodX = 10 + cottonW + 6;
  if (foodW > 5) {
    const fg = ctx.createLinearGradient(0, fY, 0, fY + fH);
    fg.addColorStop(0, '#4caf50'); fg.addColorStop(1, '#388e3c');
    ctx.fillStyle = fg;
    rRect(ctx, foodX, fY, foodW, fH, 8);
    ctx.fill();
    ctx.strokeStyle = '#2e7d32'; ctx.lineWidth = 2;
    ctx.strokeRect(foodX, fY, foodW, fH);
    // Crops
    const cols = Math.max(1, Math.floor(foodW / 20));
    const rows = Math.max(1, Math.floor(fH / 22));
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const px = foodX + 10 + c * (foodW / cols);
        const py = fY + 12 + r * (fH / rows);
        if (px > foodX + foodW - 5) continue;
        const sway = Math.sin(t * 1.5 + c * 0.7 + r * 0.5) * 1.5;
        // Stalk
        ctx.strokeStyle = '#66bb6a'; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(px, py + 12); ctx.lineTo(px + sway, py); ctx.stroke();
        // Leaves
        ctx.fillStyle = '#81c784';
        ctx.beginPath();
        ctx.moveTo(px + sway, py);
        ctx.lineTo(px + sway - 5, py + 4);
        ctx.lineTo(px + sway + 5, py + 4);
        ctx.closePath();
        ctx.fill();
        ctx.fillStyle = '#a5d6a7';
        ctx.beginPath();
        ctx.moveTo(px + sway, py - 2);
        ctx.lineTo(px + sway - 3, py + 3);
        ctx.lineTo(px + sway + 3, py + 3);
        ctx.closePath();
        ctx.fill();
      }
    }
    // Leaf particles
    for (let i = 0; i < Math.floor(foodW / 25); i++) {
      const px = foodX + ((t * 12 + i * 53) % foodW);
      const py = fY + Math.sin(t * 0.5 + i * 2) * 15 + fH * 0.3;
      ctx.fillStyle = 'rgba(165,214,167,0.6)';
      ctx.beginPath();
      ctx.moveTo(px, py - 3);
      ctx.quadraticCurveTo(px + 3, py, px, py + 3);
      ctx.quadraticCurveTo(px - 3, py, px, py - 3);
      ctx.fill();
    }
  }
}

function drawBuildings() {
  const baseY = H * 0.32;
  const cx = W * 0.58;
  const t = Date.now() / 1000;
  
  // Building colors based on prosperity
  let wallColors, roofColor, glow;
  if (S.price === 'HIGH') {
    wallColors = ['#ffca28','#ffa726','#ffb74d','#ffd54f'];
    roofColor = '#e65100'; glow = 'rgba(255,202,40,0.3)';
  } else if (S.price === 'MEDIUM') {
    wallColors = ['#bcaaa4','#a1887f','#d7ccc8','#c8b8a8'];
    roofColor = '#795548'; glow = 'rgba(188,170,164,0.15)';
  } else {
    wallColors = ['#9e9e9e','#bdbdbd','#888','#aaa'];
    roofColor = '#616161'; glow = 'rgba(158,158,158,0.1)';
  }

  const buildings = [
    { x: cx - 100, w: 50, h: 65 },
    { x: cx - 40, w: 55, h: 75 },
    { x: cx + 25, w: 45, h: 55 },
    { x: cx + 80, w: 52, h: 70 }
  ];

  buildings.forEach((b, i) => {
    const by = baseY + 80 - b.h;
    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    rRect(ctx, b.x + 4, by + 4, b.w, b.h, 3);
    ctx.fill();
    // Wall
    ctx.fillStyle = wallColors[i];
    rRect(ctx, b.x, by, b.w, b.h, 3);
    ctx.fill();
    // Roof
    ctx.fillStyle = roofColor;
    ctx.beginPath();
    ctx.moveTo(b.x - 5, by + 2);
    ctx.lineTo(b.x + b.w / 2, by - 18);
    ctx.lineTo(b.x + b.w + 5, by + 2);
    ctx.closePath();
    ctx.fill();
    // Chimney
    ctx.fillStyle = '#795548';
    ctx.fillRect(b.x + b.w * 0.7, by - 22, 6, 12);
    // Smoke
    if (S.price !== 'CRASHED') {
      ctx.fillStyle = 'rgba(200,200,200,0.3)';
      for (let s = 0; s < 3; s++) {
        const sy = by - 25 - s * 8 - Math.sin(t + i + s) * 3;
        const sx = b.x + b.w * 0.73 + Math.sin(t * 0.5 + s) * 4;
        ctx.beginPath(); ctx.arc(sx, sy, 3 + s, 0, Math.PI * 2); ctx.fill();
      }
    }
    // Windows (2x2 grid)
    const winGlow = S.price === 'HIGH' ? '#fff9c4' : S.price === 'MEDIUM' ? '#ffe0b2' : '#e0e0e0';
    ctx.fillStyle = winGlow;
    const wx = b.x + 8, wy = by + 12, ww = 10, wh = 10, gap = 6;
    ctx.fillRect(wx, wy, ww, wh);
    ctx.fillRect(wx + ww + gap, wy, ww, wh);
    ctx.fillRect(wx, wy + wh + gap, ww, wh);
    ctx.fillRect(wx + ww + gap, wy + wh + gap, ww, wh);
    // Window frames
    ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.lineWidth = 0.5;
    ctx.strokeRect(wx, wy, ww, wh);
    ctx.strokeRect(wx + ww + gap, wy, ww, wh);
    // Door
    ctx.fillStyle = '#5d4037';
    rRect(ctx, b.x + b.w / 2 - 6, by + b.h - 18, 12, 18, 2);
    ctx.fill();
    ctx.fillStyle = '#fdd835';
    ctx.beginPath(); ctx.arc(b.x + b.w / 2 + 3, by + b.h - 9, 1.5, 0, Math.PI * 2); ctx.fill();
    // Prosperity glow
    if (S.price === 'HIGH') {
      const pg = ctx.createRadialGradient(b.x + b.w / 2, by + b.h / 2, 5, b.x + b.w / 2, by + b.h / 2, 50);
      pg.addColorStop(0, 'rgba(255,235,59,0.08)'); pg.addColorStop(1, 'transparent');
      ctx.fillStyle = pg;
      ctx.fillRect(b.x - 20, by - 20, b.w + 40, b.h + 40);
    }
    // Crash cracks
    if (S.price === 'CRASHED') {
      ctx.strokeStyle = 'rgba(0,0,0,0.3)'; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(b.x + 5, by + 10); ctx.lineTo(b.x + 20, by + 30); ctx.lineTo(b.x + 15, by + 50); ctx.stroke();
    }
  });
}

function drawMarket() {
  const mx = W * 0.82, my = H * 0.35;
  // Stand
  ctx.fillStyle = '#8d6e63';
  rRect(ctx, mx, my + 12, 80, 35, 4);
  ctx.fill();
  // Countertop
  ctx.fillStyle = '#a1887f';
  ctx.fillRect(mx - 2, my + 10, 84, 6);
  // Awning with stripes
  for (let i = 0; i < 4; i++) {
    ctx.fillStyle = i % 2 === 0 ? '#e53935' : '#ffcdd2';
    ctx.beginPath();
    ctx.moveTo(mx - 4 + i * 22, my - 2);
    ctx.lineTo(mx + 18 + i * 22, my - 2);
    ctx.lineTo(mx + 14 + i * 22, my + 10);
    ctx.lineTo(mx - 8 + i * 22, my + 10);
    ctx.closePath();
    ctx.fill();
  }
  // Awning top bar
  ctx.fillStyle = '#c62828';
  ctx.fillRect(mx - 4, my - 5, 88, 5);

  // Food display
  if (S.food === 'Local Corn') {
    for (let i = 0; i < 6; i++) {
      ctx.fillStyle = '#fdd835';
      ctx.beginPath();
      ctx.ellipse(mx + 8 + i * 12, my + 26, 4, 9, 0.1 * i, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#f9a825';
      ctx.beginPath();
      ctx.ellipse(mx + 8 + i * 12, my + 26, 2.5, 7, 0.1 * i, 0, Math.PI * 2);
      ctx.fill();
    }
  } else if (S.food === 'Shipped Corn') {
    for (let i = 0; i < 4; i++) {
      ctx.fillStyle = '#e0e0e0';
      rRect(ctx, mx + 5 + i * 18, my + 16, 14, 22, 2);
      ctx.fill();
      ctx.fillStyle = '#bdbdbd';
      ctx.fillRect(mx + 7 + i * 18, my + 22, 10, 4);
      ctx.fillStyle = '#9e9e9e';
      ctx.font = '6px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('CORN', mx + 12 + i * 18, my + 37);
    }
  } else {
    // Diverse diet - colorful spread
    const items = [
      { c: '#e53935', x: 8, y: 22, r: 5 },   // meat
      { c: '#4caf50', x: 22, y: 20, r: 5 },   // vegetables
      { c: '#fff9c4', x: 36, y: 24, r: 4 },   // eggs
      { c: '#fff', x: 48, y: 22, r: 5 },       // milk
      { c: '#ff9800', x: 62, y: 20, r: 5 },    // fruit
    ];
    items.forEach(it => {
      ctx.fillStyle = it.c;
      ctx.beginPath(); ctx.arc(mx + it.x, my + it.y, it.r, 0, Math.PI * 2); ctx.fill();
      // Shine
      ctx.fillStyle = 'rgba(255,255,255,0.3)';
      ctx.beginPath(); ctx.arc(mx + it.x - 1.5, my + it.y - 1.5, it.r * 0.4, 0, Math.PI * 2); ctx.fill();
    });
    // Sparkle effect
    const st = Date.now() / 400;
    ctx.fillStyle = 'rgba(255,235,59,0.5)';
    for (let i = 0; i < 3; i++) {
      const sx = mx + 10 + i * 25 + Math.sin(st + i) * 5;
      const sy = my + 14 + Math.cos(st + i * 2) * 3;
      drawStar(sx, sy, 3);
    }
  }
  ctx.textAlign = 'left';
}

function drawStar(x, y, s) {
  ctx.beginPath();
  for (let i = 0; i < 5; i++) {
    const a = -Math.PI / 2 + i * Math.PI * 2 / 5;
    const r = i % 2 === 0 ? s : s * 0.4;
    if (i === 0) ctx.moveTo(x + Math.cos(a) * r, y + Math.sin(a) * r);
    else ctx.lineTo(x + Math.cos(a) * r, y + Math.sin(a) * r);
    const a2 = a + Math.PI / 5;
    const r2 = i % 2 === 0 ? s * 0.4 : s;
    ctx.lineTo(x + Math.cos(a2) * r2, y + Math.sin(a2) * r2);
  }
  ctx.closePath();
  ctx.fill();
}

function drawPeople() {
  const t = Date.now() / 1000;
  ensurePeople();

  for (let i = 0; i < S.pop; i++) {
    const p = townspeople[i];
    const sick = i < S.sickCount;
    const px = p.x + (sick ? 0 : Math.sin(t * p.sp + p.ph) * 4);
    const py = p.y;
    const sc = p.sz;

    if (sick) {
      // --- SICK PERSON ---
      // Red glow underneath
      const rg = ctx.createRadialGradient(px, py - 4 * sc, 2, px, py - 4 * sc, 14 * sc);
      rg.addColorStop(0, 'rgba(229,57,53,0.15)'); rg.addColorStop(1, 'transparent');
      ctx.fillStyle = rg; ctx.fillRect(px - 14 * sc, py - 18 * sc, 28 * sc, 28 * sc);
      
      // Collapsed body (lying down)
      ctx.fillStyle = '#ef5350';
      ctx.beginPath();
      ctx.ellipse(px, py + 2 * sc, 8 * sc, 3 * sc, 0, 0, Math.PI * 2);
      ctx.fill();
      // Head
      ctx.fillStyle = '#e53935';
      ctx.beginPath(); ctx.arc(px - 5 * sc, py - 2 * sc, 5 * sc, 0, Math.PI * 2); ctx.fill();
      // Cracked skin patches
      ctx.fillStyle = '#b71c1c';
      ctx.beginPath(); ctx.arc(px - 6 * sc, py - 4 * sc, 2 * sc, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(px - 3 * sc, py - 1 * sc, 1.5 * sc, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(px + 2 * sc, py + 1 * sc, 1.5 * sc, 0, Math.PI * 2); ctx.fill();
      // X eyes
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
      const ex = px - 7 * sc, ey = py - 3 * sc;
      ctx.beginPath(); ctx.moveTo(ex - 1.5, ey - 1.5); ctx.lineTo(ex + 1.5, ey + 1.5); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(ex + 1.5, ey - 1.5); ctx.lineTo(ex - 1.5, ey + 1.5); ctx.stroke();
      const ex2 = px - 3 * sc;
      ctx.beginPath(); ctx.moveTo(ex2 - 1.5, ey - 1.5); ctx.lineTo(ex2 + 1.5, ey + 1.5); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(ex2 + 1.5, ey - 1.5); ctx.lineTo(ex2 - 1.5, ey + 1.5); ctx.stroke();
    } else {
      // --- HEALTHY PERSON ---
      const bounce = Math.sin(t * 2 + p.ph) * 2;
      const walk = Math.sin(t * 3 + p.ph) * 2;
      
      // Green glow
      const gg = ctx.createRadialGradient(px, py - 8 * sc + bounce, 3, px, py - 8 * sc + bounce, 12 * sc);
      gg.addColorStop(0, 'rgba(76,175,80,0.12)'); gg.addColorStop(1, 'transparent');
      ctx.fillStyle = gg; ctx.fillRect(px - 12 * sc, py - 20 * sc, 24 * sc, 30 * sc);

      // Legs
      ctx.strokeStyle = '#2e7d32'; ctx.lineWidth = 2 * sc;
      ctx.beginPath(); ctx.moveTo(px - 2 * sc, py + 3 * sc + bounce); ctx.lineTo(px - 3 * sc + walk, py + 10 * sc + bounce); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(px + 2 * sc, py + 3 * sc + bounce); ctx.lineTo(px + 3 * sc - walk, py + 10 * sc + bounce); ctx.stroke();
      // Body
      ctx.fillStyle = '#43a047';
      rRect(ctx, px - 4 * sc, py - 5 * sc + bounce, 8 * sc, 10 * sc, 2);
      ctx.fill();
      // Arms
      ctx.strokeStyle = '#388e3c'; ctx.lineWidth = 1.5 * sc;
      ctx.beginPath(); ctx.moveTo(px - 4 * sc, py - 2 * sc + bounce); ctx.lineTo(px - 7 * sc + walk * 0.5, py + 4 * sc + bounce); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(px + 4 * sc, py - 2 * sc + bounce); ctx.lineTo(px + 7 * sc - walk * 0.5, py + 4 * sc + bounce); ctx.stroke();
      // Head
      ctx.fillStyle = '#66bb6a';
      ctx.beginPath(); ctx.arc(px, py - 9 * sc + bounce, 5 * sc, 0, Math.PI * 2); ctx.fill();
      // Face
      ctx.fillStyle = '#fff';
      ctx.beginPath(); ctx.arc(px - 2 * sc, py - 10 * sc + bounce, 1 * sc, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(px + 2 * sc, py - 10 * sc + bounce, 1 * sc, 0, Math.PI * 2); ctx.fill();
      // Smile
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 0.8 * sc;
      ctx.beginPath(); ctx.arc(px, py - 8 * sc + bounce, 2.5 * sc, 0.2, Math.PI - 0.2); ctx.stroke();
    }
  }

  // Sick counter badge
  if (S.sickCount > 0) {
    const bx = W * 0.88, by = H * 0.16;
    ctx.fillStyle = 'rgba(183,28,28,0.85)';
    rRect(ctx, bx - 40, by - 14, 80, 32, 10);
    ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(S.sickCount + '/' + S.pop + ' Sick', bx, by + 6);
    ctx.textAlign = 'left';
  }
}

function drawLabels() {
  ctx.textAlign = 'center';
  const fY = H * 0.58;

  if (S.cottonPct > 15) {
    const lx = 8 + W * 0.38 * (S.cottonPct / 100) / 2;
    pill(lx, fY, 'Cotton Field', '#5d4037', '#fff');
  }
  if (S.cottonPct < 85) {
    const fx = 14 + W * 0.38 * (S.cottonPct / 100) + W * 0.38 * ((100 - S.cottonPct) / 100) / 2;
    pill(fx, fY, 'Food Crops', '#2e7d32', '#fff');
  }
  pill(W * 0.58, H * 0.32, 'Town Square', '#37474f', '#fff');
  pill(W * 0.86, H * 0.33, 'Market', '#c62828', '#fff');

  ctx.textAlign = 'left';
}

function pill(x, y, text, bg, fg) {
  ctx.font = 'bold 10px sans-serif';
  const m = ctx.measureText(text);
  const pw = m.width + 14, ph = 16;
  ctx.fillStyle = bg;
  ctx.globalAlpha = 0.8;
  rRect(ctx, x - pw / 2, y - ph / 2, pw, ph, ph / 2);
  ctx.fill();
  ctx.globalAlpha = 1;
  ctx.fillStyle = fg;
  ctx.textAlign = 'center';
  ctx.fillText(text, x, y + 4);
}

function rRect(ctx, x, y, w, h, r) {
  r = Math.min(r, w / 2, h / 2);
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y); ctx.arcTo(x + w, y, x + w, y + r, r);
  ctx.lineTo(x + w, y + h - r); ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
  ctx.lineTo(x + r, y + h); ctx.arcTo(x, y + h, x, y + h - r, r);
  ctx.lineTo(x, y + r); ctx.arcTo(x, y, x + r, y, r);
  ctx.closePath();
}

// ============ ROUND ANIMATION ============
function animateRound(newSick, cb) {
  const startCount = S.sickCount;
  const endCount = Math.round(newSick / 100 * S.pop);
  const dur = 2000;
  const t0 = Date.now();
  animRunning = true;

  function step() {
    try {
      if (!animRunning) return;
      const el = Date.now() - t0;
      const t = Math.min(1, el / dur);
      const e = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
      S.sickCount = Math.round(startCount + (endCount - startCount) * e);
      S.sickRate = Math.round(S.sickCount / S.pop * 100);
      updateHUD();
      draw();
      if (t < 1) requestAnimationFrame(step);
      else { animRunning = false; S.sickCount = endCount; S.sickRate = newSick; updateHUD(); draw(); setTimeout(cb, 500); }
    } catch(e) { animRunning = false; S.sickCount = endCount; S.sickRate = newSick; cb(); }
  }
  requestAnimationFrame(step);
}

// ============ AMBIENT LOOP ============
let lastAmbient = 0;
function ambient(ts) {
  if (!animRunning && ts - lastAmbient > 50) { lastAmbient = ts; draw(); }
  requestAnimationFrame(ambient);
}

// ============ INIT ============
window.addEventListener('resize', resize);
window.addEventListener('load', () => {
  try { initTable(); updateSliderBg(); resize(); updateHUD(); updateControls(); requestAnimationFrame(ambient); }
  catch(e) { console.error('Init error:', e); }
});
</script>
</body>
</html>
