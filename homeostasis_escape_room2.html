<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad ‚Äî Homeostasis Escape Room</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1a1a2e;--bg2:#16213e;--text:#e0e0e0;--text-bright:#fff;
  --r1:#00BCD4;--r1d:#004D40;--r1g:rgba(0,188,212,.4);
  --r2:#9C27B0;--r2d:#4A148C;--r2g:rgba(156,39,176,.4);
  --r3:#FF5722;--r3d:#BF360C;--r3g:rgba(255,87,34,.4);
  --r4:#2196F3;--r4d:#0D47A1;--r4g:rgba(33,150,243,.4);
  --grn:#4CAF50;--red:#f44336;--gld:#FFD700;
  --cc:var(--r1);--cg:var(--r1g);
}
html,body{height:100%;overflow:hidden;font-family:'Segoe UI',Tahoma,sans-serif;background:var(--bg);color:var(--text)}
button{cursor:pointer;font-family:inherit;border:none;outline:none}
button:focus-visible{outline:2px solid var(--cc);outline-offset:2px}
#app{width:100vw;height:100vh;display:flex;flex-direction:column;position:relative;overflow:hidden}
/* TOP BAR */
.tb{display:none;align-items:center;justify-content:space-between;padding:8px 16px;background:rgba(0,0,0,.4);border-bottom:2px solid var(--cc);z-index:10;min-height:48px;flex-shrink:0}
.tb .rl{font-size:1.1rem;font-weight:700;color:var(--cc);text-shadow:0 0 10px var(--cg);cursor:default;user-select:none}
.tb .ri{font-size:.8rem;color:var(--text);opacity:.7}
.tb .tm{font-size:1rem;font-variant-numeric:tabular-nums;color:var(--text-bright);background:rgba(0,0,0,.3);padding:4px 12px;border-radius:8px}
.xa{display:flex;align-items:center;gap:8px}
.xbc{width:clamp(80px,12vw,150px);height:14px;background:rgba(255,255,255,.1);border-radius:7px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
.xbf{height:100%;background:linear-gradient(90deg,var(--gld),#ffeb3b);border-radius:7px;transition:width .6s;width:0%}
.xl{font-size:.75rem;color:var(--gld);font-weight:700;white-space:nowrap}
.sf{font-size:1.2rem;transition:opacity .3s;opacity:0}
.sf.on{opacity:1;animation:ffire .5s infinite alternate}
@keyframes ffire{to{transform:scale(1.15)}}
/* MISSION */
.ml{display:none;text-align:center;padding:6px 16px;font-size:.9rem;color:var(--cc);font-style:italic;opacity:.85;background:rgba(0,0,0,.2);flex-shrink:0}
/* MAIN */
.ma{flex:1;display:flex;align-items:center;justify-content:center;padding:12px;overflow-y:auto;position:relative}
/* BOTTOM BAR */
.bb{display:none;align-items:center;justify-content:space-between;padding:8px 16px;background:rgba(0,0,0,.4);border-top:1px solid rgba(255,255,255,.08);flex-shrink:0;min-height:48px}
.sb{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.07);color:var(--text);padding:8px 14px;border-radius:8px;font-size:.85rem;min-width:48px;min-height:48px;transition:all .3s}
.sb:hover{background:rgba(255,255,255,.14);box-shadow:0 0 10px var(--cg)}
.pd{display:flex;gap:8px}
.pd>div{width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.2);transition:all .3s}
.pd>.act{background:var(--cc);border-color:var(--cc);box-shadow:0 0 6px var(--cg)}
.pd>.done{background:var(--grn);border-color:var(--grn)}
.cv{display:flex;flex-direction:column;gap:3px;align-items:flex-end}
.cv-l{font-size:.6rem;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:1px}
.cv-s{display:flex;gap:5px}
.vs{font-size:.7rem;font-weight:700;padding:3px 7px;border-radius:4px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);min-width:40px;text-align:center;color:rgba(255,255,255,.4);transition:all .5s}
.vs.ul{color:var(--sc);border-color:var(--sc);box-shadow:0 0 6px var(--sg);text-shadow:0 0 5px var(--sg)}
/* SCREENS */
.scr{display:none;width:100%;max-width:900px;flex-direction:column;align-items:center;gap:14px;animation:fin .4s}
.scr.act{display:flex}
@keyframes fin{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
/* TITLE */
.ts{text-align:center}
.ts h1{font-size:clamp(1.5rem,4vw,2.6rem);color:var(--text-bright);text-shadow:0 0 25px rgba(0,188,212,.5);margin-bottom:8px;line-height:1.2}
.ts .sub{font-size:clamp(.85rem,2vw,1.2rem);color:var(--r1);margin-bottom:24px}
.go{font-size:1.15rem;padding:16px 44px;background:linear-gradient(135deg,var(--r1),var(--r1d));color:#fff;border-radius:12px;font-weight:700;box-shadow:0 0 20px var(--r1g);transition:all .3s;min-height:54px}
.go:hover{transform:scale(1.05);box-shadow:0 0 35px var(--r1g)}
/* PUZZLE */
.pc{width:100%;max-width:800px;text-align:center}
.pt{font-size:1.2rem;color:var(--cc);font-weight:700;margin-bottom:10px;text-shadow:0 0 8px var(--cg)}
.pq{font-size:1.1rem;color:var(--text-bright);margin-bottom:14px;font-weight:600}
/* MATCH */
.mta{display:flex;gap:20px;justify-content:center;flex-wrap:wrap}
.mtc{display:flex;flex-direction:column;gap:8px;min-width:180px;flex:1;max-width:340px}
.mc{padding:12px 16px;border-radius:10px;font-size:.9rem;font-weight:600;transition:all .3s;min-height:50px;display:flex;align-items:center;justify-content:center;text-align:center;line-height:1.3;user-select:none}
.mt{background:rgba(255,255,255,.07);border:2px solid rgba(255,255,255,.18);color:var(--text-bright)}
.mt:hover{border-color:var(--cc);box-shadow:0 0 8px var(--cg)}
.mt.sel{border-color:var(--cc);background:rgba(255,255,255,.13);box-shadow:0 0 12px var(--cg)}
.mr{background:rgba(255,255,255,.03);border:2px dashed rgba(255,255,255,.13);color:var(--text)}
.mr:hover{border-color:var(--cc);background:rgba(255,255,255,.05)}
.mc.lk{border-color:var(--grn)!important;background:rgba(76,175,80,.12)!important;box-shadow:0 0 8px rgba(76,175,80,.3)!important;pointer-events:none;border-style:solid!important}
.mc.wr{animation:wsh .4s}
/* SEQUENCE */
.sa{display:flex;flex-direction:column;gap:8px;align-items:center;width:100%;max-width:480px;margin:0 auto}
.ss{width:100%;padding:12px;border-radius:10px;font-size:.9rem;font-weight:600;display:flex;align-items:center;gap:10px;min-height:48px;transition:all .3s;user-select:none}
.sn{width:26px;height:26px;border-radius:50%;background:var(--cc);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;flex-shrink:0}
.ss.emp{background:rgba(255,255,255,.03);border:2px dashed rgba(255,255,255,.12);color:rgba(255,255,255,.35)}
.ss.fil{background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.18);color:var(--text-bright)}
.ss.fil:hover{border-color:var(--cc)}
.ss.cor{border-color:var(--grn)!important;background:rgba(76,175,80,.12)!important}
.ss.wro{border-color:var(--red)!important;background:rgba(244,67,54,.08)!important}
.sbk{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px}
.sbc{padding:10px 16px;border-radius:10px;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.18);color:var(--text-bright);font-size:.85rem;font-weight:600;transition:all .3s;min-height:44px}
.sbc:hover{border-color:var(--cc);box-shadow:0 0 8px var(--cg)}
.sbc.usd{opacity:.25;pointer-events:none}
.ckb{margin-top:14px;padding:12px 32px;border-radius:10px;font-size:1rem;font-weight:700;background:var(--cc);color:#fff;min-height:48px;transition:all .3s}
.ckb:hover{box-shadow:0 0 12px var(--cg);transform:scale(1.03)}
/* OPTIONS */
.opr{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.oc{padding:14px 22px;border-radius:12px;background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.13);color:var(--text-bright);font-size:.95rem;font-weight:600;transition:all .3s;min-height:52px;min-width:120px;display:flex;align-items:center;justify-content:center;text-align:center}
.oc:hover{border-color:var(--cc);box-shadow:0 0 10px var(--cg);transform:translateY(-2px)}
.oc.cp{border-color:var(--grn);background:rgba(76,175,80,.18);box-shadow:0 0 12px rgba(76,175,80,.3)}
.oc.wp{border-color:var(--red);background:rgba(244,67,54,.12)}
.oc.dis{pointer-events:none;opacity:.4}
/* GAUGES */
.gp{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-bottom:14px}
.gg{flex:1;min-width:130px;max-width:190px;background:rgba(0,0,0,.35);border:2px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;text-align:center}
.gl{font-size:.7rem;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.gbo{height:110px;width:28px;background:rgba(255,255,255,.04);border-radius:14px;margin:0 auto;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
.gbf{position:absolute;bottom:0;width:100%;border-radius:14px;transition:height 1s}
.gv{font-size:1rem;font-weight:700;margin-top:6px;color:var(--text-bright)}
/* DIAGNOSTIC */
.dp{display:flex;flex-direction:column;gap:14px;align-items:center;width:100%;max-width:580px;margin:0 auto}
.dss{display:flex;gap:18px;justify-content:center;flex-wrap:wrap}
.ds{width:190px;min-height:90px;border:2px dashed rgba(255,255,255,.15);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:12px;transition:all .3s;background:rgba(0,0,0,.25)}
.dsl{font-size:.8rem;color:var(--cc);font-weight:600}
.dsc{font-size:.95rem;color:var(--text-bright);font-weight:700;min-height:32px;display:flex;align-items:center}
.ds.fil{border-style:solid;background:rgba(255,255,255,.04)}
.ds.csl{border-color:var(--grn);background:rgba(76,175,80,.12)}
.ds.wsl{border-color:var(--red);background:rgba(244,67,54,.08);animation:wsh .4s}
.pbk{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:6px}
.pch{padding:10px 16px;border-radius:20px;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.15);color:var(--text-bright);font-size:.85rem;font-weight:600;min-height:42px;transition:all .3s}
.pch:hover{border-color:var(--cc);box-shadow:0 0 8px var(--cg)}
.pch.pld{opacity:.25;pointer-events:none}
/* QUICK FIRE */
.qfc{text-align:center;width:100%;max-width:580px}
.qfp{font-size:.8rem;color:rgba(255,255,255,.45);margin-bottom:10px}
.qfq{font-size:1.1rem;color:var(--text-bright);font-weight:600;margin-bottom:18px;min-height:44px;display:flex;align-items:center;justify-content:center;padding:0 14px}
.qfbs{display:flex;gap:14px;justify-content:center}
.qfb{padding:14px 32px;border-radius:12px;font-size:1rem;font-weight:700;min-height:52px;min-width:120px;transition:all .3s;color:#fff}
.qfb.cb{background:linear-gradient(135deg,#43A047,#2E7D32);border:2px solid #43A047}
.qfb.cb:hover{box-shadow:0 0 12px rgba(76,175,80,.5);transform:scale(1.02)}
.qfb.rb{background:linear-gradient(135deg,#E53935,#C62828);border:2px solid #E53935}
.qfb.rb:hover{box-shadow:0 0 12px rgba(244,67,54,.5);transform:scale(1.02)}
/* MYSTERY */
.myc{display:flex;align-items:center;gap:6px;justify-content:center;flex-wrap:wrap;margin-bottom:18px;padding:14px;background:rgba(0,0,0,.25);border-radius:12px}
.myb{padding:10px 14px;border-radius:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:.85rem;font-weight:600;color:var(--text-bright)}
.mya{font-size:1.1rem;color:var(--cc)}
.mym{border:2px dashed var(--cc);background:rgba(0,0,0,.35);color:var(--cc);font-size:1rem;box-shadow:0 0 8px var(--cg)}
/* VISUAL SCENE */
.vsc{width:100%;max-width:480px;height:clamp(170px,28vh,260px);border-radius:14px;border:2px solid rgba(255,255,255,.08);margin:0 auto 14px;position:relative;overflow:hidden;background:rgba(0,0,0,.35)}
/* CODE ENTRY */
.ce{display:flex;flex-direction:column;align-items:center;gap:14px}
.dd{display:flex;gap:10px}
.db{width:56px;height:66px;border-radius:12px;border:2px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:700;color:var(--text-bright);transition:all .4s}
.db.rv{border-color:var(--cc);box-shadow:0 0 12px var(--cg);color:var(--cc);text-shadow:0 0 8px var(--cg)}
.cia{display:flex;gap:8px;align-items:center}
.ci{width:130px;height:48px;border-radius:10px;border:2px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:var(--text-bright);font-size:1.4rem;text-align:center;font-weight:700;letter-spacing:6px;font-family:inherit}
.ci:focus{border-color:var(--cc);box-shadow:0 0 8px var(--cg);outline:none}
.cs{padding:10px 22px;border-radius:10px;background:var(--cc);color:#fff;font-size:.95rem;font-weight:700;min-height:48px;transition:all .3s}
.cs:hover{box-shadow:0 0 12px var(--cg)}
/* OVERLAYS */
.ov{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;align-items:center;justify-content:center}
.ov.sh{display:flex}
.sov{background:rgba(0,0,0,.65);animation:fin .3s}
.sox{max-width:480px;width:90%;padding:22px;border-radius:14px;background:var(--bg2);border:2px solid var(--cc);box-shadow:0 0 25px var(--cg);text-align:center}
.sox h3{color:var(--cc);font-size:1.05rem;margin-bottom:10px}
.sox p{color:var(--text);font-size:.9rem;line-height:1.5}
.sxc{margin-top:14px;padding:10px 26px;border-radius:8px;background:rgba(255,255,255,.08);color:var(--text-bright);font-size:.85rem;min-height:42px}
.sxc:hover{background:rgba(255,255,255,.16)}
.sox.str{border-color:var(--gld);box-shadow:0 0 25px rgba(255,215,0,.3)}
.sox.str h3{color:var(--gld)}
.sox.ovr{border-color:var(--red);box-shadow:0 0 25px rgba(244,67,54,.3)}
.sox.ovr h3{color:var(--red)}
/* PASS */
.pov{background:rgba(0,0,0,.82);flex-direction:column;gap:22px;animation:fin .3s}
.ptx{font-size:clamp(1.8rem,5.5vw,3.2rem);font-weight:900;color:var(--cc);text-shadow:0 0 25px var(--cg);letter-spacing:3px}
.prb{padding:14px 44px;border-radius:12px;font-size:1.15rem;font-weight:700;background:var(--cc);color:#fff;min-height:52px;transition:all .3s}
.prb:hover{transform:scale(1.04);box-shadow:0 0 18px var(--cg)}
/* DOOR */
.dov{position:fixed;top:0;left:0;width:100%;height:100%;z-index:80;pointer-events:none;display:none;background:rgba(8,8,20,.97);perspective:1200px}
.dov.sh{display:flex;pointer-events:all;align-items:center;justify-content:center;flex-direction:column}
.door-frame{position:relative;width:clamp(220px,40vw,340px);height:clamp(340px,55vh,480px);border:6px solid #444;border-radius:8px 8px 0 0;background:#1a1a1a;box-shadow:0 0 60px rgba(0,0,0,.8),inset 0 0 30px rgba(0,0,0,.5);overflow:hidden;transform-style:preserve-3d}
.door-panel{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(180deg,#2a2a3e 0%,#1e1e30 100%);border:3px solid #333;transform-origin:left center;transition:transform 1s cubic-bezier(.645,.045,.355,1);box-shadow:inset 0 0 20px rgba(0,0,0,.4)}
.door-panel-inner{position:absolute;top:8%;left:10%;width:80%;height:35%;border:2px solid #3a3a4e;border-radius:4px;background:rgba(255,255,255,.02)}
.door-panel-inner2{position:absolute;top:52%;left:10%;width:80%;height:35%;border:2px solid #3a3a4e;border-radius:4px;background:rgba(255,255,255,.02)}
.door-handle{position:absolute;right:12%;top:48%;width:14px;height:44px;background:linear-gradient(135deg,#c9a84c,#a07828);border-radius:7px;box-shadow:0 0 10px rgba(201,168,76,.3);z-index:2}
.door-keyhole{position:absolute;right:calc(12% + 2px);top:calc(48% + 50px);width:10px;height:16px;background:#111;border-radius:50% 50% 2px 2px;border:1px solid #555}
.door-glow{position:absolute;top:0;left:-4px;width:8px;height:100%;background:var(--cc);box-shadow:0 0 20px var(--cg),0 0 40px var(--cg);opacity:0;transition:opacity .5s .3s}
.dov.opening .door-panel{transform:rotateY(-105deg)}
.dov.opening .door-glow{opacity:1}
.door-plate{position:absolute;top:15%;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#333,#222);padding:8px 18px;border-radius:4px;border:1px solid #555;z-index:3;text-align:center;min-width:60%;box-shadow:0 2px 8px rgba(0,0,0,.5)}
.door-plate-txt{font-size:clamp(.7rem,2vw,1rem);font-weight:700;color:var(--cc);text-shadow:0 0 8px var(--cg);letter-spacing:1px;text-transform:uppercase}
.door-plate-sub{font-size:clamp(.55rem,1.3vw,.72rem);color:rgba(255,255,255,.4);margin-top:2px}
.drl{position:absolute;bottom:clamp(20px,5vh,50px);left:50%;transform:translateX(-50%);font-size:clamp(1rem,2.5vw,1.5rem);font-weight:900;color:var(--cc);text-shadow:0 0 25px var(--cg);z-index:2;text-align:center;opacity:1;transition:opacity .4s}
.dov.opening .drl{opacity:0}
.door-light{position:absolute;top:-20px;left:50%;transform:translateX(-50%);width:60%;height:6px;background:var(--cc);border-radius:3px;box-shadow:0 0 15px var(--cg),0 5px 25px var(--cg);animation:doorPulse 2s ease-in-out infinite}
@keyframes doorPulse{0%,100%{opacity:.6;box-shadow:0 0 15px var(--cg)}50%{opacity:1;box-shadow:0 0 25px var(--cg),0 5px 35px var(--cg)}}
.door-enter-btn{margin-top:clamp(14px,3vh,28px);padding:14px 40px;background:transparent;border:2px solid var(--cc);color:var(--cc);font-size:1rem;font-weight:700;border-radius:10px;cursor:pointer;min-height:48px;transition:all .3s, opacity .4s;text-transform:uppercase;letter-spacing:2px;opacity:0}
.door-enter-btn:hover{background:var(--cc);color:#fff;box-shadow:0 0 20px var(--cg);transform:scale(1.04)}
/* RESET BTN */
.resetBtn{position:fixed;bottom:56px;left:50%;transform:translateX(-50%);padding:8px 20px;background:rgba(26,26,46,.92);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.6);font-size:.78rem;font-weight:600;border-radius:8px;cursor:pointer;min-height:40px;transition:all .3s;display:none;z-index:15;backdrop-filter:blur(4px)}
.resetBtn.vis{display:inline-flex;align-items:center;gap:5px}
.resetBtn:hover{background:rgba(255,255,255,.12);color:rgba(255,255,255,.9);border-color:rgba(255,255,255,.35)}
/* DIGIT REVEAL */
.drov{background:rgba(0,0,0,.55);flex-direction:column;gap:14px;z-index:85}
.drn{font-size:clamp(3.5rem,10vw,7rem);font-weight:900;color:var(--cc);text-shadow:0 0 35px var(--cg);animation:dpls 1s}
@keyframes dpls{0%{transform:scale(0);opacity:0}50%{transform:scale(1.3)}to{transform:scale(1);opacity:1}}
.drlb{font-size:.9rem;color:var(--text);opacity:.6}
/* ESCAPE REPORT */
.er{text-align:center;width:100%;max-width:580px;animation:fin .5s}
.ert{font-size:clamp(1.8rem,5vw,3.2rem);font-weight:900;color:var(--gld);text-shadow:0 0 35px rgba(255,215,0,.5);margin-bottom:14px}
.rg{display:grid;grid-template-columns:1fr 1fr;gap:10px;text-align:left;margin:14px 0}
.rgi{background:rgba(255,255,255,.04);padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.08)}
.rgl{font-size:.7rem;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px}
.rgv{font-size:1.15rem;color:var(--text-bright);font-weight:700;margin-top:3px}
.rs{font-size:1.8rem;margin:14px 0}
.bdr{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px 0}
.bdg{padding:7px 14px;border-radius:18px;background:rgba(255,215,0,.08);border:1px solid var(--gld);color:var(--gld);font-size:.8rem;font-weight:600}
.rab{display:flex;gap:10px;justify-content:center;margin-top:18px;flex-wrap:wrap}
.rbt{padding:12px 28px;border-radius:10px;font-size:.95rem;font-weight:700;min-height:46px;transition:all .3s}
.rbt.pri{background:var(--gld);color:#1a1a2e}
.rbt.sec{background:rgba(255,255,255,.08);color:var(--text-bright);border:1px solid rgba(255,255,255,.15)}
.rbt:hover{transform:scale(1.03)}
/* FX */
.ffb{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(1.8rem,4.5vw,2.8rem);font-weight:900;z-index:70;pointer-events:none;animation:fpop .8s forwards}
.ffb.sh{display:block}
@keyframes fpop{0%{opacity:1;transform:translate(-50%,-50%) scale(.5)}30%{transform:translate(-50%,-50%) scale(1.2)}60%{transform:translate(-50%,-50%) scale(1)}to{opacity:0;transform:translate(-50%,-50%) scale(1) translateY(-25px)}}
.xpp{position:fixed;top:55px;right:18px;z-index:75;font-size:1rem;font-weight:900;color:var(--gld);text-shadow:0 0 8px rgba(255,215,0,.5);animation:xpf 1.4s forwards;pointer-events:none}
@keyframes xpf{0%{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-35px)}}
.ptc{position:fixed;width:7px;height:7px;border-radius:50%;pointer-events:none;z-index:60;animation:pbst .7s forwards}
@keyframes pbst{0%{opacity:1;transform:translate(0,0) scale(1)}to{opacity:0;transform:translate(var(--px),var(--py)) scale(0)}}
.cnf{position:fixed;width:9px;height:14px;z-index:200;pointer-events:none;animation:cfl 3s forwards}
@keyframes cfl{0%{opacity:1;transform:translateY(-100vh) rotate(0)}50%{opacity:1}to{opacity:0;transform:translateY(100vh) rotate(720deg)}}
@keyframes wsh{0%,100%{transform:translateX(0)}20%{transform:translateX(-7px)}40%{transform:translateX(7px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
.shk .ma{animation:wsh .4s}
@keyframes bnc{to{transform:translateY(-7px)}}
/* SKIP */
.skc{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg2);border:2px solid var(--red);border-radius:14px;padding:22px;z-index:110;text-align:center;box-shadow:0 0 25px rgba(244,67,54,.3)}
.skc.sh{display:block;animation:fin .3s}
.skc p{color:var(--text);margin-bottom:14px}
.skc button{padding:10px 22px;border-radius:8px;font-weight:700;min-height:42px;margin:0 6px}
.sky{background:var(--red);color:#fff}
.skn{background:rgba(255,255,255,.08);color:var(--text-bright)}
</style>
</head>
<body>
<div id="app">
<div class="tb" id="topBar">
  <div><div class="rl" id="roomLabel">üî¨ Sensor Bay</div><div class="ri" id="roomInd">Room 1 / 4</div></div>
  <div class="tm" id="timer">00:00</div>
  <div class="xa"><span class="sf" id="streakF">üî•</span><div class="xbc"><div class="xbf" id="xpBar"></div></div><span class="xl" id="xpLbl">0 XP</span></div>
</div>
<div class="ml" id="misLine"></div>
<div class="ma" id="mainA">
  <div class="scr act ts" id="titleScr">
    <h1>Mr. Jawad<br>Unit Review: Homeostasis</h1>
    <div class="sub">Escape Room Challenge</div>
    <button class="go" onclick="G.start()">üöÄ Begin Escape</button>
  </div>
  <div class="scr" id="puzzleScr"><div class="pc" id="pzC"></div><button class="resetBtn" id="resetBtn" onclick="G.resetPz()">üîÑ Reset Puzzle</button></div>
  <div class="scr" id="codeScr">
    <div class="ce">
      <div style="font-size:1.15rem;color:var(--cc);font-weight:700;margin-bottom:6px">Exit Code Required</div>
      <div class="dd" id="digDisp"></div>
      <div class="cia" style="margin-top:14px"><input class="ci" id="codeIn" type="text" maxlength="3" inputmode="numeric" placeholder="_ _ _"><button class="cs" onclick="G.submitCode()">Enter</button></div>
      <div id="codeErr" style="color:var(--red);font-size:.85rem;margin-top:6px;min-height:20px"></div>
    </div>
  </div>
  <div class="scr" id="escScr"><div class="er" id="escRpt"></div></div>
</div>
<div class="bb" id="botBar">
  <button class="sb" id="scanBtn" onclick="G.openScan()">üîç Scanner</button>
  <div class="pd" id="progDots"></div>
  <div class="cv"><div class="cv-l">Code Vault</div><div class="cv-s" id="vSlots">
    <div class="vs" style="--sc:var(--r1);--sg:var(--r1g)">???</div>
    <div class="vs" style="--sc:var(--r2);--sg:var(--r2g)">???</div>
    <div class="vs" style="--sc:var(--r3);--sg:var(--r3g)">???</div>
    <div class="vs" style="--sc:var(--r4);--sg:var(--r4g)">???</div>
  </div></div>
</div>
</div>
<div class="ov sov" id="scanOv"><div class="sox" id="scanBox"><h3 id="scanTtl">üîç Scanner Active</h3><p id="scanTxt"></p><button class="sxc" onclick="G.closeScan()">Close Scanner</button></div></div>
<div class="ov pov" id="passOv"><div class="ptx">PASS THE LAPTOP</div><button class="prb" onclick="G.closePass()">Ready</button></div>
<div class="dov" id="doorOv">
<div class="door-frame">
<div class="door-light"></div>
<div class="door-panel">
<div class="door-panel-inner"></div>
<div class="door-panel-inner2"></div>
<div class="door-handle"></div>
<div class="door-keyhole"></div>
<div class="door-plate"><div class="door-plate-txt" id="doorPlate"></div><div class="door-plate-sub" id="doorSub"></div></div>
</div>
<div class="door-glow"></div>
</div>
<div class="drl" id="doorLbl"></div>
<button class="door-enter-btn" id="doorEnterBtn" onclick="G.openDoor()">Enter Room</button>
</div>
<div class="ov drov" id="digRev"><div class="drn" id="drNum"></div><div class="drlb">Digit Unlocked</div></div>
<div class="skc" id="skipC"><p style="color:var(--text-bright);font-weight:700;font-size:1.05rem">Reveal all digits for this room?</p><p>This skips the remaining puzzles.</p><button class="sky" onclick="G.doSkip()">Reveal</button><button class="skn" onclick="G.noSkip()">Cancel</button></div>

<script>
(function(){
"use strict";
// ===== DATA =====
const ROOMS=[
{name:'üî¨ Sensor Bay',mis:'Calibrate the body\'s sensor array.',c:'#00BCD4',cg:'rgba(0,188,212,.4)',cd:'#004D40',code:'472',pz:[
{tp:'match',tt:'MATCH LOCK',dg:4,
 tm:['üèÉ‚Äç‚ôÄÔ∏è Marathon Runner','‚ùÑÔ∏è Arctic Explorer','üèîÔ∏è Everest Climber','üèúÔ∏è Desert Rescue'],
 tg:['Sweating + wider vessels','Shivering + tight vessels','Faster breathing','Kidneys save water + thirst'],
 cr:{0:0,1:1,2:2,3:3},
 sc:"Scanning Marathon Runner file ‚Äî her body temp hit 104¬∞F. What came out of her skin? Now check what the Arctic Explorer's body did in -35¬∞F cold.",
 ss:"Two matches remain ‚Äî each correct pair is highlighted."},
{tp:'seq',tt:'SEQUENCE LOCK',dg:7,
 cards:[{l:'üèúÔ∏èüí• Dehydration hits',id:0},{l:'üîç‚ö†Ô∏è Receptors detect',id:1},{l:'üíßüîí Kidneys save water',id:2},{l:'‚úÖüíß Balance restored',id:3}],
 co:[0,1,2,3],
 sc:"Scanning Desert Rescue file ‚Äî the lost hiker's body was losing water. Something detected the problem FIRST, then the body made a fix to hold onto water.",
 ss:"Cards 1 and 4 are locked in place. Order the middle two."},
{tp:'vis',tt:'VISUAL RECALL',dg:2,scene:'marathon',
 q:'What cools the runner down?',
 opts:[{l:'‚ùÑÔ∏è Shivering',c:false},{l:'üíß Sweating + wider vessels',c:true},{l:'üí® Faster breathing',c:false}],
 sc:"Scanning Marathon Runner file ‚Äî body temp hit 104¬∞F. Detecting what came out of her skin to cool down.",
 ss:"One wrong option removed. Choose between the remaining two."}
]},
{name:'üß† Dopamine Lab',mis:'Stabilize the brain\'s reward system.',c:'#9C27B0',cg:'rgba(156,39,176,.4)',cd:'#4A148C',code:'836',pz:[
{tp:'gauge',tt:'SYSTEM SCANNER',dg:8,
 gauges:[{l:'DOSE LEVEL',v:100,cl:'#f44336',d:'HIGH'},{l:'FEEL GOOD',v:100,cl:'#4CAF50',d:'10'},{l:'RECEPTORS',v:60,sv:80,cl:'#FFC107',d:'8 ‚Üí 6'}],
 q:'High dose ‚Üí receptors go ___?',
 opts:[{l:'‚¨ÜÔ∏è Up',c:false},{l:'‚¨áÔ∏è Down',c:true},{l:'‚û°Ô∏è Stay same',c:false}],
 sc:"Scanning Receptors gauge ‚Äî it was at 8, now it's dropping. The HIGH dose did something to those receptors.",
 ss:"One wrong option removed. Choose between Up and Down."},
{tp:'myst',tt:'MYSTERY INPUT',dg:3,
 chain:['Choose NONE','no dopamine','brain ??? receptors'],mi:2,
 opts:[{l:'‚ûñ Removes',c:false},{l:'‚ûï Recovers',c:true},{l:'‚û°Ô∏è Ignores',c:false}],
 sc:"Scanning NONE dose logs ‚Äî Feel Good dropped, but something good happened to receptors. The brain did something to fix them.",
 ss:"One wrong option removed. Choose between Removes and Recovers."},
{tp:'qf',tt:'QUICK FIRE',dg:6,fr:'SYSTEM DIAGNOSTIC ‚Äî Verify these lab readings',
 qs:[{t:'"High dose ‚Üí receptors go down"',a:true},{t:'"Tolerance ‚Üí need LESS to feel it"',a:false},{t:'"Low dose ‚Üí receptors stay safe"',a:true},{t:'"No dose ‚Üí receptors recover"',a:true},{t:'"More receptors ‚Üí MORE Feel Good"',a:true}],
 pt:3,
 sc:"Scanning Dopamine Tolerance logs ‚Äî HIGH dose felt great but cost you something. LOW and NONE felt worse but helped something recover.",
 ss:"Each question narrows to the likely answer."}
]},
{name:'üå°Ô∏è Thermal Control',mis:'Restore the thermal defense grid.',c:'#FF5722',cg:'rgba(255,87,34,.4)',cd:'#BF360C',code:'519',pz:[
{tp:'diag',tt:'DIAGNOSTIC PANEL',dg:5,pt2:'BODY RESPONSE UNIT',
 slots:[{l:'üî¥ HOT EVENT response',ci:0},{l:'üîµ COLD EVENT response',ci:1}],
 parts:[{l:'üíß Sweat',id:0},{l:'‚ùÑÔ∏è Shiver',id:1},{l:'‚ûñ None',id:2},{l:'üîÑ Digest',id:3}],
 sc:"Scanning thermal logs ‚Äî HOT events needed one response to cool down. COLD events needed a different one to warm up.",
 ss:"Each slot narrows to 2 options: Sweat vs. Shiver."},
{tp:'seq',tt:'SEQUENCE LOCK',dg:1,
 cards:[{l:'‚ùÑÔ∏èüí• Cold hits',id:0},{l:'üå°Ô∏è‚¨áÔ∏è Temp drops',id:1},{l:'ü•∂üî• Body shivers',id:2},{l:'‚úÖüå°Ô∏è Temp recovers',id:3}],
 co:[0,1,2,3],
 sc:"Scanning cold event sequence ‚Äî the gauge dropped. The body had one move to push temp back to the OK zone.",
 ss:"Cards 1 and 4 are locked in place. Order the middle two."},
{tp:'vis',tt:'VISUAL RECALL',dg:9,scene:'thermal',
 q:'OK zone + sweat ‚Üí what happens?',
 opts:[{l:'üå°Ô∏è Temp goes up',c:false},{l:'üå°Ô∏è Temp swings too cold',c:true},{l:'‚úÖ Nothing, stays OK',c:false}],
 sc:"Scanning thermal logs ‚Äî when you picked a response the body DIDN'T need, the gauge swung the wrong way.",
 ss:"One wrong option removed. Choose between the remaining two."}
]},
{name:'‚ö° Command Center',mis:'Unlock the master override code.',c:'#2196F3',cg:'rgba(33,150,243,.4)',cd:'#0D47A1',code:'742',pz:[
{tp:'vis',tt:'VISUAL RECALL',dg:7,scene:'brain',
 q:'Drug overload ‚Üí brain does what?',
 opts:[{l:'‚ûï Adds receptors',c:false},{l:'‚ûñ Removes receptors',c:true},{l:'üíä Releases more dopamine',c:false}],
 sc:"Scanning brain visual ‚Äî count the receptor slots. Some are crossed off. Drug overload triggered the brain to do something to those receptors.",
 ss:"One wrong option removed. Choose between Adds and Removes."},
{tp:'match',tt:'MATCH LOCK',dg:4,
 tm:['Homeostasis','Hypothalamus','Dopamine','Tolerance'],
 tg:['ü•µ Body sweats ‚Üí temp back to 98.6¬∞F','üß† Detects change, sends the fix','üíï Floods your brain when in love','üíä Need a bigger dose each time'],
 cr:{0:0,1:1,2:2,3:3},
 sc:"Scanning Body Balance Investigator ‚Äî one term names the brain part that detected EVERY change. Another names what spiked when in love.",
 ss:"Two matches remain ‚Äî correct pairs highlighted."},
{tp:'myst',tt:'MYSTERY INPUT',dg:2,
 chain:['Blood sugar drops','pancreas detects','liver ??? stored sugar'],mi:2,
 opts:[{l:'üî• Destroys',c:false},{l:'‚û°Ô∏è Releases',c:true},{l:'üì¶ Stores',c:false}],
 sc:"Scanning blood sugar scenario ‚Äî sugar dropped, the pancreas sent a signal. The liver had sugar saved up. What did it do?",
 ss:"One wrong option removed. Choose between Releases and Stores."}
]}
];

const FL={pairs:[
{lt:'üèîÔ∏è Everest Climber',rt:'Faster breathing',c:'#00BCD4',e:'üî¨'},
{lt:'üíä High dose of dopamine',rt:'Receptors decrease (tolerance)',c:'#9C27B0',e:'üß†'},
{lt:'üî• Hot event hits body',rt:'Sweat to cool down',c:'#FF5722',e:'üå°Ô∏è'},
{lt:'üß† Hypothalamus',rt:"Brain's thermostat",c:'#2196F3',e:'‚ö°'}
]};

// ===== STATE =====
const S={ph:'title',cr:0,cp:0,xp:0,mxp:2500,strk:0,ts:0,ti:null,tp:false,
  pa:0,cw:0,res:[],rd:[[null,null,null],[null,null,null],[null,null,null],[null,null,null]],
  vc:[null,null,null,null],bg:[],rst:0,passCb:null};

// ===== UTILS =====
const $=id=>document.getElementById(id);
const setC=(c,g)=>{document.documentElement.style.setProperty('--cc',c);document.documentElement.style.setProperty('--cg',g)};
const showScr=id=>{document.querySelectorAll('.scr').forEach(s=>s.classList.remove('act'));$(id).classList.add('act')};

function updTimer(){
  if(S.tp)return;S.ts++;
  $('timer').textContent=String(Math.floor(S.ts/60)).padStart(2,'0')+':'+String(S.ts%60).padStart(2,'0');
}

function updXP(a,lb){
  S.xp+=a;
  $('xpBar').style.width=Math.min(S.xp/S.mxp*100,100)+'%';
  $('xpLbl').textContent=S.xp+' XP';
  if(lb){const p=document.createElement('div');p.className='xpp';p.textContent=lb;document.body.appendChild(p);setTimeout(()=>{try{p.remove()}catch(e){}},1500);}
}

function updStrk(ft){if(ft)S.strk++;else S.strk=0;const f=$('streakF');S.strk>=2?f.classList.add('on'):f.classList.remove('on');}

function particles(x,y,c,n){try{for(let i=0;i<Math.min(n||6,10);i++){const p=document.createElement('div');p.className='ptc';p.style.cssText=`left:${x}px;top:${y}px;background:${c}`;const a=Math.random()*Math.PI*2,d=35+Math.random()*55;p.style.setProperty('--px',Math.cos(a)*d+'px');p.style.setProperty('--py',Math.sin(a)*d+'px');document.body.appendChild(p);p.addEventListener('animationend',()=>{try{p.remove()}catch(e){}})}}catch(e){}}

function showFB(ok,x,y){try{const f=document.createElement('div');f.className='ffb sh';f.textContent=ok?'‚úî':'‚úñ';f.style.color=ok?'var(--grn)':'var(--red)';document.body.appendChild(f);if(ok)particles(x||innerWidth/2,y||innerHeight/2,'var(--grn)',7);setTimeout(()=>{try{f.remove()}catch(e){}},900)}catch(e){}}

function wrongFX(cw){try{if(cw>=2){const a=$('app');a.classList.add('shk');setTimeout(()=>a.classList.remove('shk'),500)};try{$('resetBtn').classList.add('vis')}catch(e){}}catch(e){}}

function showDigR(dg,cb){try{$('drNum').textContent=dg;$('digRev').classList.add('sh');particles(innerWidth/2,innerHeight/2,'var(--cc)',8);setTimeout(()=>{try{$('digRev').classList.remove('sh')}catch(e){};if(cb)cb()},1400)}catch(e){if(cb)cb()}}

function showPass(cb){try{$('passOv').classList.add('sh');S.passCb=cb}catch(e){if(cb)cb()}}

function showDoor(lb,sub,cb){try{const d=$('doorOv');$('doorPlate').textContent=lb;$('doorSub').textContent=sub||'';$('doorLbl').textContent='üîí Locked';d.classList.remove('opening');d.classList.add('sh');const eb=$('doorEnterBtn');eb.style.display='inline-block';eb.style.opacity='0';S._doorCb=cb;setTimeout(()=>{$('doorLbl').textContent='üîë Ready to enter';eb.style.opacity='1'},600)}catch(e){if(cb)cb()}}

function updPD(){const d=$('progDots');d.innerHTML='';for(let i=0;i<3;i++){const x=document.createElement('div');if(i<S.cp)x.className='done';else if(i===S.cp)x.className='act';d.appendChild(x)}}

function updV(){const sl=$('vSlots').children;for(let i=0;i<4;i++){if(S.vc[i]){sl[i].textContent=S.vc[i];sl[i].classList.add('ul')}}}

function autoStrong(){try{const pz=ROOMS[S.cr].pz[S.cp];$('scanTtl').textContent='‚ö° Stronger Scan';$('scanTxt').textContent=pz.ss;$('scanBox').className='sox str';$('scanOv').classList.add('sh')}catch(e){}}

// ===== PUZZLE SOLVED =====
let _solving=false;
function pzSolved(dg,tries){try{
  if(_solving)return;_solving=true;
  S.rd[S.cr][S.cp]=dg;
  let xg=0,lb='';
  if(tries===1){xg=100;lb='+100 CLEAN SOLVE'}else if(tries===2){xg=50;lb='+50 NICE'}else if(tries===3){xg=25;lb='+25'}else{lb='No bonus'}
  S.res.push({r:S.cr,p:S.cp,t:tries});
  updStrk(tries===1);
  if(xg)updXP(xg,lb);else{const p=document.createElement('div');p.className='xpp';p.textContent=lb;p.style.color='#999';document.body.appendChild(p);setTimeout(()=>{try{p.remove()}catch(e){}},1500)}
  showDigR(dg,()=>{
    const np=S.cp+1;
    if(np<3)showPass(()=>loadPz(S.cr,np));
    else{checkRB();showCode()}
  })
}catch(e){console.error(e)}}

function checkRB(){try{
  const rr=S.res.filter(r=>r.r===S.cr);
  if(rr.length===3&&rr.every(r=>r.t<=2)){updXP(200,'+200 CLEAN ROOM');if(!S.bg.includes('Clean Room'))S.bg.push('Clean Room')}
  if(rr.length===3&&rr.every(r=>r.t===1)&&!S.bg.includes('No Scanner'))S.bg.push('No Scanner');
  if(S.ts-S.rst<180&&rr.length===3&&!S.bg.includes('Speed Run'))S.bg.push('Speed Run');
  if(rr.some(r=>r.t>1)&&rr.some(r=>r.t===1)&&!S.bg.includes('Comeback'))S.bg.push('Comeback');
}catch(e){}}

// ===== CODE SCREEN =====
function showCode(){try{
  S.ph='code';showScr('codeScr');
  const dd=$('digDisp');dd.innerHTML='';
  for(let i=0;i<3;i++){const b=document.createElement('div');b.className='db';const d=S.rd[S.cr][i];if(d!==null){b.textContent=d;b.classList.add('rv')}else b.textContent='?';dd.appendChild(b)}
  $('codeIn').value='';$('codeErr').textContent='';$('codeIn').focus()
}catch(e){}}

// ===== RENDER MATCH =====
function rMatch(c,pz){try{
  let sel=null,mat=0,tot=pz.tm.length,cw=0;
  const st=[...pz.tg.map((t,i)=>({t,id:i}))].sort(()=>Math.random()-.5);
  c.innerHTML=`<div class="pt">${pz.tt}</div><p style="color:var(--text);margin-bottom:10px;font-size:.82rem">Tap a term, then tap its match</p><div class="mta"><div class="mtc" id="mT"></div><div class="mtc" id="mR"></div></div>`;
  const tc=$('mT'),rc=$('mR');
  pz.tm.forEach((t,i)=>{const b=document.createElement('button');b.className='mc mt';b.textContent=t;b.dataset.id=i;b.onclick=()=>{if(b.classList.contains('lk'))return;tc.querySelectorAll('.mt').forEach(x=>x.classList.remove('sel'));b.classList.add('sel');sel=i};tc.appendChild(b)});
  st.forEach(t=>{const b=document.createElement('button');b.className='mc mr';b.textContent=t.t;b.dataset.id=t.id;b.onclick=()=>{
    if(b.classList.contains('lk')||sel===null)return;
    if(pz.cr[sel]===t.id){b.classList.add('lk');tc.querySelector(`[data-id="${sel}"]`).classList.add('lk');showFB(true);cw=0;sel=null;mat++;if(mat===tot){S.pa=Math.max(S.pa,1);setTimeout(()=>pzSolved(pz.dg,S.pa),500)}}
    else{S.pa++;cw++;b.classList.add('wr');showFB(false);wrongFX(cw);setTimeout(()=>b.classList.remove('wr'),500);
      if(S.pa>=3){let delay=0;tc.querySelectorAll('.mt:not(.lk)').forEach(x=>{const id=+x.dataset.id;const tg=rc.querySelector(`[data-id="${pz.cr[id]}"]`);setTimeout(()=>{x.classList.add('lk');x.style.borderColor='var(--gld)';if(tg){tg.classList.add('lk');tg.style.borderColor='var(--gld)';tg.style.boxShadow='0 0 10px rgba(255,215,0,.4)'}mat++},delay);delay+=500});setTimeout(()=>pzSolved(pz.dg,S.pa),delay+400)}
      else if(S.pa>=2)autoStrong()}
  };rc.appendChild(b)})
}catch(e){c.innerHTML='<p style="color:var(--red)">Puzzle error ‚Äî <button class="ckb" onclick="loadPz(S.cr,S.cp)">Retry</button></p>'}}

// ===== RENDER SEQUENCE =====
function rSeq(c,pz){try{
  let placed=new Array(pz.cards.length).fill(undefined),locked=new Array(pz.cards.length).fill(false),cw=0,checking=false;
  const shuf=[...pz.cards].sort(()=>Math.random()-.5);
  c.innerHTML=`<div class="pt">${pz.tt}</div><p style="color:var(--text);margin-bottom:10px;font-size:.82rem">Tap cards to place in order. Tap a placed card to remove it.</p><div class="sa" id="seqA"></div><div class="sbk" id="seqB"></div><button class="ckb" id="seqC" style="display:none">Check Order</button>`;
  function rS(){const a=$('seqA');a.innerHTML='';placed.forEach((p,i)=>{const s=document.createElement('div');s.className='ss '+(locked[i]?'fil cor':(p!==undefined?'fil':'emp'));s.innerHTML=`<div class="sn">${i+1}</div><span>${p!==undefined?pz.cards.find(x=>x.id===p).l:'Tap a card below'}</span>`;if(p!==undefined&&!locked[i])s.onclick=()=>{if(checking)return;placed[i]=undefined;rS();rB();$('seqC').style.display=placed.every(x=>x!==undefined)?'block':'none'};a.appendChild(s)})}
  function rB(){const b=$('seqB');b.innerHTML='';shuf.forEach(cd=>{const btn=document.createElement('button');btn.className='sbc';if(placed.includes(cd.id))btn.classList.add('usd');btn.textContent=cd.l;btn.onclick=()=>{if(checking)return;const ne=placed.findIndex((v,i)=>v===undefined&&!locked[i]);if(ne===-1)return;placed[ne]=cd.id;rS();rB();if(placed.every(x=>x!==undefined))$('seqC').style.display='block'};b.appendChild(btn)})}
  rS();rB();
  $('seqC').onclick=()=>{try{
    if(checking)return;checking=true;
    const ok=placed.every((id,i)=>id===pz.co[i]);
    const slots=$('seqA').children;
    if(ok){S.pa=Math.max(S.pa,1);for(let i=0;i<slots.length;i++)slots[i].classList.add('cor');showFB(true);cw=0;setTimeout(()=>pzSolved(pz.dg,S.pa),600)}
    else{S.pa++;cw++;showFB(false);wrongFX(cw);
      for(let i=0;i<slots.length;i++){placed[i]===pz.co[i]?slots[i].classList.add('cor'):slots[i].classList.add('wro')}
      setTimeout(()=>{
        checking=false;
        if(S.pa>=3){for(let i=0;i<pz.co.length;i++)placed[i]=pz.co[i];locked.fill(true);rS();rB();const s2=$('seqA').children;for(let i=0;i<s2.length;i++){s2[i].style.borderColor='var(--gld)';s2[i].style.boxShadow='0 0 8px rgba(255,215,0,.3)'}setTimeout(()=>pzSolved(pz.dg,S.pa),800);return}
        for(let i=0;i<placed.length;i++){if(placed[i]===pz.co[i]){locked[i]=true}else{placed[i]=undefined}}
        rS();rB();$('seqC').style.display='none';
        if(S.pa>=2)autoStrong();
      },900)}
  }catch(e){checking=false}}
}catch(e){c.innerHTML='<p style="color:var(--red)">Puzzle error ‚Äî <button class="ckb" onclick="loadPz(S.cr,S.cp)">Retry</button></p>'}}

// ===== RENDER OPTIONS PUZZLE (visual, gauge, mystery) =====
function rOpts(optRow,pz,afterSolve){
  let cw=0;
  pz.opts.forEach((o,i)=>{
    const b=document.createElement('button');b.className='oc';b.textContent=o.l;
    b.onclick=()=>{if(b.classList.contains('dis'))return;
      if(o.c){b.classList.add('cp');showFB(true);S.pa=Math.max(S.pa,1);optRow.querySelectorAll('.oc').forEach(x=>x.classList.add('dis'));cw=0;setTimeout(()=>{if(afterSolve)afterSolve();pzSolved(pz.dg,S.pa)},600)}
      else{S.pa++;cw++;b.classList.add('wp','dis');showFB(false);wrongFX(cw);
        if(S.pa>=3){const cb=Array.from(optRow.children).find((_,j)=>pz.opts[j].c);if(cb){cb.style.borderColor='var(--gld)';cb.style.boxShadow='0 0 12px rgba(255,215,0,.4)';cb.style.background='rgba(255,215,0,.08)'}}
        else if(S.pa>=2)autoStrong()}
    };optRow.appendChild(b)
  });
}

function rVis(c,pz){try{
  c.innerHTML=`<div class="pt">${pz.tt}</div><div class="vsc" id="vScene"></div><div class="pq">${pz.q}</div><div class="opr" id="vOpts"></div>`;
  drawScene($('vScene'),pz.scene);
  rOpts($('vOpts'),pz);
}catch(e){c.innerHTML='<p style="color:var(--red)">Puzzle error</p>'}}

function drawScene(el,t){try{
  if(t==='marathon'){
    el.style.background='linear-gradient(180deg,#2d1b00,#4a2800 40%,#666 60%,#555)';
    el.innerHTML=`<div style="position:absolute;bottom:35%;left:50%;transform:translateX(-50%);text-align:center"><div style="font-size:2.8rem;animation:bnc .6s infinite alternate">üèÉ‚Äç‚ôÄÔ∏è</div><div style="position:absolute;top:-8px;left:-18px;font-size:1.3rem;opacity:.7">üíß</div><div style="position:absolute;top:-3px;right:-22px;font-size:1.1rem;opacity:.6">üíß</div><div style="position:absolute;top:6px;left:-32px;font-size:.9rem;opacity:.5">üíß</div></div><div style="position:absolute;left:12%;top:18%;background:linear-gradient(0deg,#4CAF50,#FFC107 60%,#f44336 85%);width:16px;height:90px;border-radius:8px;border:2px solid rgba(255,255,255,.25)"><div style="position:absolute;bottom:15%;left:50%;transform:translateX(-50%);width:7px;height:7px;background:#f44336;border-radius:50%;box-shadow:0 0 6px #f44336"></div></div><div style="position:absolute;left:7%;top:13%;color:#f44336;font-size:.7rem;font-weight:700">104¬∞F</div>`;
  }else if(t==='thermal'){
    el.style.background='linear-gradient(180deg,#1a1a2e,#1e2a3a)';
    el.innerHTML=`<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:55px;height:90px;border:3px solid var(--grn);border-radius:28px;background:rgba(76,175,80,.08);box-shadow:0 0 18px rgba(76,175,80,.25)"><div style="position:absolute;top:15%;left:50%;transform:translateX(-50%);width:9px;height:9px;background:var(--grn);border-radius:50%"></div></div><div style="position:absolute;left:18%;top:28%;background:linear-gradient(0deg,#2196F3,#4CAF50 40%,#f44336);width:14px;height:75px;border-radius:7px;border:2px solid rgba(255,255,255,.18)"><div style="position:absolute;top:40%;left:50%;transform:translateX(-50%);width:5px;height:5px;background:var(--grn);border-radius:50%;box-shadow:0 0 5px var(--grn)"></div></div><div style="position:absolute;left:12%;top:22%;color:var(--grn);font-size:.65rem;font-weight:700">98.6¬∞F</div><div style="position:absolute;right:18%;top:38%;font-size:1.8rem;opacity:.7">üíß</div><div style="position:absolute;right:13%;top:32%;color:var(--gld);font-size:1.8rem">‚ö†Ô∏è</div><div style="position:absolute;bottom:12%;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.4);font-size:.75rem">‚Üì Temp dropping? ‚Üì</div>`;
  }else if(t==='brain'){
    el.style.background='linear-gradient(180deg,#0D47A1,#1a1a2e)';
    el.innerHTML=`<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3.5rem">üß†</div><div style="position:absolute;left:12%;top:18%;display:flex;gap:3px;flex-wrap:wrap;width:28%">${Array(10).fill(0).map((_,i)=>`<div style="width:12px;height:12px;border-radius:50%;border:2px solid ${i>=6?'#f44336':'#2196F3'};background:${i>=6?'rgba(244,67,54,.15)':'rgba(33,150,243,.25)'}">${i>=6?'<span style="color:#f44336;font-size:7px;display:flex;align-items:center;justify-content:center;height:100%">‚úñ</span>':''}</div>`).join('')}</div><div style="position:absolute;left:8%;bottom:12%;color:#FFC107;font-size:.75rem;font-weight:700;padding:3px 7px;background:rgba(0,0,0,.3);border-radius:4px">RECEPTORS: 6/10</div><div style="position:absolute;right:12%;top:22%;font-size:1.3rem">üíäüíäüíä</div><div style="position:absolute;right:10%;top:35%;color:rgba(255,255,255,.4);font-size:.65rem">‚Üê Drug overload</div>`;
  }
}catch(e){el.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text)">Simulation Visual</div>'}}

function rGauge(c,pz){try{
  c.innerHTML=`<div class="pt">${pz.tt}</div><div class="gp" id="gPanel"></div><div class="pq">${pz.q}</div><div class="opr" id="gOpts"></div>`;
  const p=$('gPanel');
  pz.gauges.forEach((g,i)=>{const d=document.createElement('div');d.className='gg';d.style.borderColor=g.cl;d.innerHTML=`<div class="gl">${g.l}</div><div class="gbo"><div class="gbf" id="gf${i}" style="background:${g.cl};height:${g.sv||g.v}%"></div></div><div class="gv" style="color:${g.cl}">${g.d}</div>`;p.appendChild(d)});
  setTimeout(()=>{try{const g=$('gf2');if(g)g.style.height=pz.gauges[2].v+'%'}catch(e){}},500);
  rOpts($('gOpts'),pz);
}catch(e){c.innerHTML='<p style="color:var(--red)">Puzzle error</p>'}}

function rMyst(c,pz){try{
  c.innerHTML=`<div class="pt">${pz.tt}</div><div class="myc" id="myChain"></div><div class="opr" id="myOpts"></div>`;
  const ch=$('myChain');
  pz.chain.forEach((item,i)=>{if(i>0){const a=document.createElement('span');a.className='mya';a.textContent='‚Üí';ch.appendChild(a)}const b=document.createElement('div');b.className='myb';if(i===pz.mi){b.classList.add('mym');b.id='myBox';b.innerHTML=item.replace('???','<span style="color:var(--gld);font-weight:900">???</span>')}else b.textContent=item;ch.appendChild(b)});
  rOpts($('myOpts'),pz,()=>{try{const mb=$('myBox');if(mb){const co=pz.opts.find(o=>o.c);mb.textContent=pz.chain[pz.mi].replace('???',co.l);mb.style.borderColor='var(--grn)';mb.style.borderStyle='solid';mb.style.boxShadow='0 0 8px rgba(76,175,80,.3)'}}catch(e){}});
}catch(e){c.innerHTML='<p style="color:var(--red)">Puzzle error</p>'}}

function rQF(c,pz){try{
  let cur=0,res=new Array(pz.qs.length).fill(null),retry=false,rq=[],cw=0,totalWrong=0;
  try{$('resetBtn').classList.remove('vis');$('resetBtn').style.visibility='hidden'}catch(e){}
  c.innerHTML=`<div class="pt">${pz.tt}</div><div style="color:var(--text);font-size:.82rem;margin-bottom:6px">${pz.fr}</div><div class="qfc"><div class="qfp" id="qfP"></div><div class="qfq" id="qfQ"></div><div class="qfbs"><button class="qfb cb" id="qfT">‚úÖ CONFIRMED</button><button class="qfb rb" id="qfF">‚ùå REJECTED</button></div><div id="qfFB" style="margin-top:10px;min-height:20px;font-weight:700"></div></div>`;
  function showQ(){const qi=retry?rq[cur]:cur;const q=pz.qs[qi];$('qfP').textContent=retry?`Retry ${cur+1}/${rq.length}`:`${cur+1} / ${pz.qs.length}`;$('qfQ').textContent=q.t;$('qfFB').textContent='';$('qfT').disabled=false;$('qfF').disabled=false}
  function qfOverride(){res.fill(true);$('qfFB').innerHTML='<span style="color:var(--gld);font-size:1rem">üîì Scanner locked on ‚Äî diagnostic cleared</span>';showFB(true);setTimeout(()=>pzSolved(pz.dg,S.pa),800)}
  function ans(a){try{const qi=retry?rq[cur]:cur;const q=pz.qs[qi];$('qfT').disabled=true;$('qfF').disabled=true;
    if(a===q.a){res[qi]=true;$('qfFB').innerHTML='<span style="color:var(--grn)">‚úî Correct!</span>';showFB(true);cw=0}
    else{res[qi]=false;$('qfFB').innerHTML='<span style="color:var(--red)">‚úñ Not quite</span>';showFB(false);cw++;totalWrong++;wrongFX(cw);
      if(totalWrong>=5){setTimeout(qfOverride,600);return}}
    setTimeout(()=>{cur++;const mx=retry?rq.length:pz.qs.length;
      if(cur<mx)showQ();
      else{const ct=res.filter(r=>r===true).length;
        if(ct>=pz.pt){S.pa=Math.max(S.pa,1);$('qfFB').innerHTML='<span style="color:var(--grn);font-size:1rem">‚úî Diagnostic passed!</span>';setTimeout(()=>pzSolved(pz.dg,S.pa),600)}
        else{S.pa++;rq=[];res.forEach((r,i)=>{if(r!==true)rq.push(i)});if(!rq.length){setTimeout(()=>pzSolved(pz.dg,S.pa),600);return}retry=true;cur=0;$('qfFB').innerHTML='<span style="color:var(--gld)">Retrying missed questions...</span>';if(S.pa>=2)autoStrong();setTimeout(showQ,1000)}}
    },600)
  }catch(e){}}
  $('qfT').onclick=()=>ans(true);$('qfF').onclick=()=>ans(false);
  showQ();
}catch(e){c.innerHTML='<p style="color:var(--red)">Puzzle error</p>'}}

function rDiag(c,pz){try{
  let sv=[null,null],cw=0;
  c.innerHTML=`<div class="pt">${pz.tt}</div><div style="color:var(--cc);font-size:.95rem;font-weight:600;margin-bottom:10px">${pz.pt2}</div><div class="dp"><div class="dss" id="dSlots"></div><div class="pbk" id="pBank"></div><button class="ckb" id="dAct" style="display:none">‚ö° Activate</button></div>`;
  function rAll(){
    $('dSlots').innerHTML='';pz.slots.forEach((s,i)=>{const d=document.createElement('div');d.className='ds'+(sv[i]!==null?' fil':'');d.innerHTML=`<div class="dsl">${s.l}</div><div class="dsc">${sv[i]!==null?pz.parts.find(p=>p.id===sv[i]).l:'Empty'}</div>`;if(sv[i]!==null){d.style.cursor='pointer';d.onclick=()=>{sv[i]=null;rAll();$('dAct').style.display='none'}}$('dSlots').appendChild(d)});
    $('pBank').innerHTML='';pz.parts.forEach(p=>{const ch=document.createElement('button');ch.className='pch';if(sv.includes(p.id))ch.classList.add('pld');ch.textContent=p.l;ch.onclick=()=>{const ne=sv.indexOf(null);if(ne===-1)return;sv[ne]=p.id;rAll();if(!sv.includes(null))$('dAct').style.display='block'};$('pBank').appendChild(ch)});
  }
  rAll();
  $('dAct').onclick=()=>{try{
    if($('dAct').disabled)return;$('dAct').disabled=true;
    const ok=pz.slots.every((s,i)=>sv[i]===s.ci);
    const sl=$('dSlots').children;
    if(ok){S.pa=Math.max(S.pa,1);Array.from(sl).forEach(s=>s.classList.add('csl'));showFB(true);cw=0;setTimeout(()=>pzSolved(pz.dg,S.pa),600)}
    else{S.pa++;cw++;Array.from(sl).forEach(s=>s.classList.add('wsl'));showFB(false);wrongFX(cw);
      setTimeout(()=>{sv=[null,null];rAll();$('dAct').style.display='none';$('dAct').disabled=false},800);
      if(S.pa>=3)setTimeout(()=>{pz.slots.forEach((s,i)=>sv[i]=s.ci);rAll();Array.from($('dSlots').children).forEach(s=>{s.style.borderColor='var(--gld)';s.style.boxShadow='0 0 8px rgba(255,215,0,.3)'});$('dAct').style.display='block';$('dAct').disabled=false},900);
      else if(S.pa>=2)autoStrong()}
  }catch(e){$('dAct').disabled=false}};
}catch(e){c.innerHTML='<p style="color:var(--red)">Puzzle error</p>'}}

// ===== LOAD PUZZLE =====
function loadPz(ri,pi){try{
  _solving=false;S.cr=ri;S.cp=pi;S.pa=0;S.cw=0;S.ph='room';updPD();showScr('puzzleScr');try{$('resetBtn').classList.remove('vis');$('resetBtn').style.visibility='visible'}catch(e){}
  const pz=ROOMS[ri].pz[pi],c=$('pzC');
  switch(pz.tp){
    case'match':rMatch(c,pz);break;case'seq':rSeq(c,pz);break;case'vis':rVis(c,pz);break;
    case'gauge':rGauge(c,pz);break;case'myst':rMyst(c,pz);break;case'qf':rQF(c,pz);break;
    case'diag':rDiag(c,pz);break;default:c.innerHTML='<p>Loading...</p>'}
}catch(e){$('pzC').innerHTML=`<p style="color:var(--red)">Something went wrong ‚Äî click to retry this puzzle</p><button class="ckb" onclick="loadPz(${ri},${pi})">Retry</button>`}}

// ===== START ROOM =====
function startRoom(ri){try{
  S.cr=ri;S.cp=0;S.rst=S.ts;const rm=ROOMS[ri];setC(rm.c,rm.cg);
  $('roomLabel').textContent=rm.name;$('roomInd').textContent=`Room ${ri+1} / 4`;$('misLine').textContent=rm.mis;
  updPD();S.ph='room';showDoor(rm.name,`Room ${ri+1} of 4 ‚Äî ${rm.mis}`,()=>loadPz(ri,0))
}catch(e){}}

// ===== FINAL LOCK =====
function startFL(){try{
  S.ph='finalLock';setC('#FFD700','rgba(255,215,0,.4)');
  $('roomLabel').textContent='üîì FINAL LOCK';$('roomInd').textContent='Master Match';$('misLine').textContent='Match each cause to its effect ‚Äî one from every room.';$('progDots').innerHTML='';
  showDoor('üîì FINAL LOCK','All codes collected ‚Äî one last challenge',()=>{
    showScr('puzzleScr');try{$('resetBtn').classList.remove('vis')}catch(e){};$('pzC').innerHTML='<div style="font-size:clamp(1.4rem,4vw,2.4rem);font-weight:900;color:var(--text-bright);text-shadow:0 0 18px rgba(255,255,255,.3);animation:fin 1s">THIS IS IT.</div>';
    setTimeout(renderFL,2000)})
}catch(e){}}

function renderFL(){try{
  _solving=false;S.pa=0;let sel=null,mat=0,cw=0;
  const sr=[...FL.pairs.map((p,i)=>({...p,oi:i}))].sort(()=>Math.random()-.5);
  const c=$('pzC');
  c.innerHTML='<div class="pt">MASTER MATCH</div><p style="color:var(--text);margin-bottom:10px;font-size:.82rem">Match each cause to its effect ‚Äî colors are your guide</p><div class="mta"><div class="mtc" id="flT"></div><div class="mtc" id="flR"></div></div>';
  const tc=$('flT'),rc=$('flR');
  FL.pairs.forEach((p,i)=>{const b=document.createElement('button');b.className='mc mt';b.innerHTML=`<span style="margin-right:5px">${p.e}</span>${p.lt}`;b.style.borderColor=p.c;b.style.color=p.c;b.dataset.id=i;b.onclick=()=>{if(b.classList.contains('lk'))return;tc.querySelectorAll('.mt').forEach(x=>x.classList.remove('sel'));b.classList.add('sel');sel=i};tc.appendChild(b)});
  sr.forEach(p=>{const b=document.createElement('button');b.className='mc mr';b.textContent=p.rt;b.style.borderColor=p.c+'55';b.dataset.id=p.oi;b.onclick=()=>{
    if(b.classList.contains('lk')||sel===null)return;
    if(sel===p.oi){b.classList.add('lk');b.style.borderColor=FL.pairs[sel].c;b.style.boxShadow=`0 0 8px ${FL.pairs[sel].c}44`;tc.querySelector(`[data-id="${sel}"]`).classList.add('lk');showFB(true);cw=0;sel=null;mat++;if(mat===4)setTimeout(triggerEsc,800)}
    else{S.pa++;cw++;b.classList.add('wr');showFB(false);wrongFX(cw);setTimeout(()=>b.classList.remove('wr'),500)}
  };rc.appendChild(b)})
}catch(e){}}

// ===== ESCAPE =====
function triggerEsc(){try{
  S.ph='escaped';clearInterval(S.ti);updXP(500,'+500 ESCAPED!');
  document.body.style.background='#fff';setTimeout(()=>document.body.style.background='',200);
  const cls=['#f44336','#2196F3','#FFD700','#4CAF50','#9C27B0','#FF5722'];
  for(let i=0;i<35;i++){try{const p=document.createElement('div');p.className='cnf';p.style.left=Math.random()*100+'vw';p.style.background=cls[i%cls.length];p.style.animationDelay=Math.random()*2+'s';p.style.animationDuration=(2+Math.random()*2)+'s';document.body.appendChild(p);p.addEventListener('animationend',()=>{try{p.remove()}catch(e){}})}catch(e){}}
  setTimeout(showEscRpt,2500)
}catch(e){showEscRpt()}}

function showEscRpt(){try{
  $('topBar').style.display='none';$('botBar').style.display='none';$('misLine').style.display='none';showScr('escScr');
  const ft=S.res.filter(r=>r.t===1).length;let st=1;if(ft>=6)st=3;else if(ft>=3)st=2;
  const m=String(Math.floor(S.ts/60)).padStart(2,'0'),s=String(S.ts%60).padStart(2,'0');
  const bi={'Clean Room':'üßπ','Comeback':'üîÅ','No Scanner':'ü§ù','Speed Run':'‚ö°'};
  let bh=S.bg.length?S.bg.map(b=>`<span class="bdg">${bi[b]||'üèÖ'} ${b}</span>`).join(''):'';
  $('escRpt').innerHTML=`<div class="ert">YOU ESCAPED!</div><div class="rs">${'‚≠ê'.repeat(st)+'‚òÜ'.repeat(3-st)}</div><div class="rg"><div class="rgi"><div class="rgl">Total Time</div><div class="rgv">${m}:${s}</div></div><div class="rgi"><div class="rgl">Crew Score</div><div class="rgv">${S.xp} XP</div></div><div class="rgi"><div class="rgl">Rooms Cleared</div><div class="rgv">4 / 4</div></div><div class="rgi"><div class="rgl">First-Try Solves</div><div class="rgv">${ft} / 12</div></div></div>${bh?`<div class="bdr">${bh}</div>`:''}<div class="rab"><button class="rbt pri" onclick="copyRpt(this)">üìã Copy Report</button><button class="rbt sec" onclick="location.reload()">üîÑ Play Again</button></div>`;
}catch(e){}}

window.copyRpt=function(btn){try{
  const ft=S.res.filter(r=>r.t===1).length;let st=1;if(ft>=6)st=3;else if(ft>=3)st=2;
  const m=String(Math.floor(S.ts/60)).padStart(2,'0'),s=String(S.ts%60).padStart(2,'0');
  const t=`Escape Report ‚Äî Mr. Jawad Homeostasis\nTime: ${m}:${s}\tCrew Score: ${S.xp} XP\tRooms: 4/4\tFirst-Try: ${ft}/12\tStars: ${'‚≠ê'.repeat(st)}\tBadges: ${S.bg.join(', ')||'None'}`;
  navigator.clipboard.writeText(t).then(()=>{if(btn){btn.textContent='‚úî Copied!';setTimeout(()=>btn.textContent='üìã Copy Report',2000)}}).catch(()=>{})
}catch(e){}};

// ===== TUTORIAL =====
function startTut(){try{
  S.ph='tutorial';$('roomLabel').textContent='üìñ Tutorial';$('roomInd').textContent='Practice Round';$('misLine').textContent='Learn the controls ‚Äî tap to match!';$('scanBtn').style.display='none';$('progDots').innerHTML='';showScr('puzzleScr');
  const c=$('pzC');
  c.innerHTML='<div class="pt">TUTORIAL ‚Äî MATCH LOCK</div><p style="color:var(--text);margin-bottom:14px;font-size:.85rem">Tap a card on the left, then tap its match on the right.</p><div class="mta"><div class="mtc" id="tutT"></div><div class="mtc" id="tutR"></div></div><button style="margin-top:18px;padding:10px 26px;border-radius:8px;background:rgba(255,255,255,.08);color:var(--text-bright);font-size:.85rem;min-height:42px" onclick="G.endTut()">Skip Tutorial ‚Üí</button>';
  const tms=[{t:'‚òÄÔ∏è Sun',id:0},{t:'üßä Ice',id:1}],tgs=[{t:'Hot',id:0},{t:'Cold',id:1}];
  const cr={0:0,1:1};let sel=null,mat=0;
  const tc=$('tutT'),rc=$('tutR');
  const stg=[...tgs].sort(()=>Math.random()-.5);
  tms.forEach(t=>{const b=document.createElement('button');b.className='mc mt';b.textContent=t.t;b.dataset.id=t.id;b.onclick=()=>{tc.querySelectorAll('.mt').forEach(x=>x.classList.remove('sel'));b.classList.add('sel');sel=t.id};tc.appendChild(b)});
  stg.forEach(t=>{const b=document.createElement('button');b.className='mc mr';b.textContent=t.t;b.dataset.id=t.id;b.onclick=()=>{if(sel===null)return;if(cr[sel]===t.id){b.classList.add('lk');tc.querySelector(`[data-id="${sel}"]`).classList.add('lk');showFB(true);sel=null;mat++;if(mat===2)setTimeout(()=>G.endTut(),600)}else{b.classList.add('wr');showFB(false);setTimeout(()=>b.classList.remove('wr'),400)}};rc.appendChild(b)});
}catch(e){G.endTut()}}

// ===== SKIP =====
let skTmr=null,shSTmr=null,shS=false;
function initSkip(){try{
  $('roomLabel').addEventListener('pointerdown',e=>{e.preventDefault();if(S.ph!=='room'&&S.ph!=='code')return;skTmr=setTimeout(()=>$('skipC').classList.add('sh'),5000)});
  $('roomLabel').addEventListener('pointerup',()=>clearTimeout(skTmr));
  $('roomLabel').addEventListener('pointerleave',()=>clearTimeout(skTmr));
  document.addEventListener('keydown',e=>{if(e.key==='S'&&e.shiftKey&&!shS){shS=true;shSTmr=setTimeout(()=>{if(S.ph==='room'||S.ph==='code')$('skipC').classList.add('sh')},2000)}});
  document.addEventListener('keyup',e=>{if(e.key==='S'){shS=false;clearTimeout(shSTmr)}});
}catch(e){}}

// ===== PUBLIC API =====
window.G={
  start(){try{$('topBar').style.display='flex';$('botBar').style.display='flex';$('misLine').style.display='block';S.ti=setInterval(updTimer,1000);setC('#00BCD4','rgba(0,188,212,.4)');initSkip();startTut()}catch(e){}},
  endTut(){try{$('scanBtn').style.display='flex';startRoom(0)}catch(e){}},
  submitCode(){try{
    const v=$('codeIn').value.trim(),rm=ROOMS[S.cr];
    if(v===rm.code){S.vc[S.cr]=rm.code.split('').join('-');updV();$('codeErr').innerHTML='<span style="color:var(--grn)">üö™ Room cleared!</span>';
      setTimeout(()=>{S.cr+1<4?showPass(()=>startRoom(S.cr+1)):startFL()},600)}
    else{$('codeErr').textContent='‚úñ Code incorrect ‚Äî check your digits';$('codeIn').value='';$('codeIn').focus()}
  }catch(e){}},
  openScan(){try{
    if(S.ph==='finalLock'){$('scanTtl').textContent='üîç Scanner Active';$('scanTxt').textContent='Match each cause to its effect. The colors and room icons are your guide.';$('scanBox').className='sox';$('scanOv').classList.add('sh');return}
    const pz=ROOMS[S.cr].pz[S.cp];if(!pz)return;const bx=$('scanBox');
    if(S.pa>=3){$('scanTtl').textContent='üîì Lock Override';$('scanTxt').textContent='Override triggered ‚Äî the correct answer is highlighted on screen.';bx.className='sox ovr'}
    else if(S.pa>=2){$('scanTtl').textContent='‚ö° Stronger Scan';$('scanTxt').textContent=pz.ss;bx.className='sox str'}
    else{$('scanTtl').textContent='üîç Scanner Active';$('scanTxt').textContent=pz.sc;bx.className='sox'}
    $('scanOv').classList.add('sh')
  }catch(e){}},
  closeScan(){$('scanOv').classList.remove('sh')},
  closePass(){try{$('passOv').classList.remove('sh');if(S.passCb){const cb=S.passCb;S.passCb=null;cb()}}catch(e){}},
  doSkip(){try{$('skipC').classList.remove('sh');const rm=ROOMS[S.cr];for(let i=0;i<3;i++)S.rd[S.cr][i]=parseInt(rm.code[i]);S.vc[S.cr]=rm.code.split('').join('-');updV();S.cp=3;showCode()}catch(e){}},
  noSkip(){$('skipC').classList.remove('sh')},
  openDoor(){try{const d=$('doorOv');$('doorEnterBtn').style.display='none';$('doorLbl').textContent='';d.classList.add('opening');setTimeout(()=>{d.classList.remove('sh','opening');if(S._doorCb){const cb=S._doorCb;S._doorCb=null;cb()}},1100)}catch(e){if(S._doorCb){const cb=S._doorCb;S._doorCb=null;cb()}}},
  resetPz(){try{if(S.ph==='finalLock'){const pa=S.pa;renderFL();S.pa=pa}else{const pa=S.pa;loadPz(S.cr,S.cp);S.pa=pa}}catch(e){}}
};

// Expose loadPz globally for error retry buttons
window.loadPz=loadPz;window.S=S;window.resetPz=function(){G.resetPz()};

// Visibility pause
try{document.addEventListener('visibilitychange',()=>{S.tp=document.hidden})}catch(e){}
// Enter key for code
try{document.addEventListener('keydown',e=>{if(e.key==='Enter'&&S.ph==='code')G.submitCode()})}catch(e){}
})();
</script>
</body>
</html>
