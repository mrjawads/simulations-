<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation How Vaccines Train the Immune System</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#0a1628;color:#e0e0e0;overflow:hidden;height:100vh;display:flex;flex-direction:column;}
#app-header{background:linear-gradient(135deg,#1a237e,#4a148c,#b71c1c);padding:8px 20px;text-align:center;font-size:20px;font-weight:700;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.5);letter-spacing:1px;flex-shrink:0;}
#main-container{display:flex;flex:1;overflow:hidden;}

/* LEFT SIDEBAR */
#left-sidebar{width:280px;min-width:280px;background:linear-gradient(180deg,#1a1a2e,#16213e);border-right:1px solid #2a2a4a;display:flex;flex-direction:column;overflow-y:auto;padding:10px;}
#left-sidebar::-webkit-scrollbar{width:6px;}
#left-sidebar::-webkit-scrollbar-thumb{background:#4a4a6a;border-radius:3px;}
.sidebar-header{font-size:14px;font-weight:700;color:#80cbc4;margin:8px 0 6px;text-transform:uppercase;letter-spacing:1px;}
.scenario-card{display:flex;align-items:center;gap:8px;padding:8px 10px;margin:3px 0;border-radius:8px;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.04);border:1px solid transparent;font-size:13px;}
.scenario-card:hover{background:rgba(255,255,255,.1);border-color:#4fc3f7;}
.scenario-card.selected{background:linear-gradient(135deg,#1565c0,#0d47a1);border-color:#42a5f5;color:#fff;box-shadow:0 0 12px rgba(33,150,243,.3);}
.scenario-card.completed{opacity:.7;}
.scenario-card.completed::after{content:'âœ“';margin-left:auto;color:#69f0ae;font-weight:700;}
.scenario-card .sc-emoji{font-size:22px;flex-shrink:0;}
.scenario-card .sc-name{font-weight:600;line-height:1.2;}
.divider{height:1px;background:linear-gradient(90deg,transparent,#4a4a6a,transparent);margin:10px 0;}
.reading-level-tabs{display:flex;gap:4px;margin:6px 0;}
.rl-tab{flex:1;padding:6px;text-align:center;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;background:rgba(255,255,255,.06);border:1px solid #3a3a5a;transition:all .2s;}
.rl-tab:hover{background:rgba(255,255,255,.12);}
.rl-tab.active{background:linear-gradient(135deg,#00897b,#00695c);border-color:#26a69a;color:#fff;}
.key-word{display:inline-block;padding:3px 8px;margin:2px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(255,255,255,.08);border:1px solid #3a3a5a;transition:all .2s;}
.key-word.highlighted{background:rgba(255,193,7,.2);border-color:#ffc107;color:#ffd54f;}
#btn-reset{width:100%;padding:8px;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:13px;margin-top:6px;background:linear-gradient(135deg,#c62828,#b71c1c);color:#fff;transition:all .2s;}
#btn-reset:hover{transform:scale(1.02);box-shadow:0 0 10px rgba(198,40,40,.4);}
#btn-new-run{width:100%;padding:8px;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:13px;margin-top:4px;background:linear-gradient(135deg,#1565c0,#0d47a1);color:#fff;transition:all .2s;}
#btn-new-run:hover{transform:scale(1.02);}

/* CENTER PANEL */
#center-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;background:linear-gradient(180deg,#0d1b2a,#1b2838);}
#step-tabs{display:flex;padding:8px 12px;gap:6px;flex-shrink:0;background:rgba(0,0,0,.3);}
.step-tab{flex:1;text-align:center;padding:8px;border-radius:8px;font-size:13px;font-weight:700;background:rgba(255,255,255,.05);color:#666;border:1px solid #2a2a4a;transition:all .3s;}
.step-tab.active{background:linear-gradient(135deg,#1565c0,#0d47a1);color:#fff;border-color:#42a5f5;box-shadow:0 0 15px rgba(33,150,243,.3);animation:glowPulse 2s ease-in-out infinite;}
@keyframes glowPulse{0%,100%{box-shadow:0 0 15px rgba(33,150,243,.3);}50%{box-shadow:0 0 25px rgba(33,150,243,.5);}}
#center-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;overflow-y:auto;}
#center-content::-webkit-scrollbar{width:6px;}
#center-content::-webkit-scrollbar-thumb{background:#4a4a6a;border-radius:3px;}
.content-card{background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid #2a2a4a;border-radius:16px;padding:24px;max-width:700px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,.3);}
.content-card h2{font-size:20px;margin-bottom:12px;color:#80cbc4;}
.predict-question{font-size:18px;line-height:1.5;margin:12px 0;}
.predict-btns{display:flex;gap:12px;margin-top:16px;}
.predict-btn{flex:1;padding:14px;border:2px solid;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s;background:transparent;}
.predict-btn.toward{border-color:#4caf50;color:#4caf50;}
.predict-btn.toward:hover{background:rgba(76,175,80,.2);transform:scale(1.03);}
.predict-btn.away{border-color:#f44336;color:#f44336;}
.predict-btn.away:hover{background:rgba(244,67,54,.2);transform:scale(1.03);}
.passage-text{font-size:17px;line-height:1.7;color:#e0e0e0;white-space:pre-wrap;}
.passage-text b{color:#ffd54f;}
.sentence-highlight{background:rgba(33,150,243,.25);border-radius:4px;padding:1px 2px;}
#btn-read-aloud{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;background:linear-gradient(135deg,#7b1fa2,#4a148c);color:#fff;margin-top:12px;transition:all .2s;}
#btn-read-aloud:hover{transform:scale(1.03);}
#action-btn-container{padding:12px;flex-shrink:0;display:flex;justify-content:center;gap:10px;}
#action-btn{padding:12px 40px;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#00897b,#00695c);color:#fff;transition:all .2s;box-shadow:0 4px 15px rgba(0,137,123,.3);}
#action-btn:hover{transform:scale(1.03);box-shadow:0 6px 20px rgba(0,137,123,.4);}
#action-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}

/* WATCH ANIMATION AREA */
#watch-arena{width:100%;max-width:700px;height:380px;border-radius:16px;background:linear-gradient(180deg,#0a1628,#162447);border:1px solid #2a2a4a;position:relative;overflow:hidden;}
#meter-container{position:absolute;right:30px;top:20px;bottom:20px;width:50px;display:flex;flex-direction:column;border-radius:10px;overflow:hidden;border:2px solid #4a4a6a;background:#111;}
.meter-zone{display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;}
#meter-zone-protected{flex:1;background:linear-gradient(180deg,#2e7d32,#1b5e20);color:#a5d6a7;}
#meter-zone-building{flex:1;background:linear-gradient(180deg,#f9a825,#f57f17);color:#fff8e1;}
#meter-zone-vulnerable{flex:1;background:linear-gradient(180deg,#c62828,#b71c1c);color:#ffcdd2;}
#meter-fill{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.1));transition:height 2s ease;height:10%;border-top:3px solid #fff;box-shadow:0 -4px 15px rgba(255,255,255,.3);}
#meter-ok-line{position:absolute;left:-6px;right:-6px;top:33.3%;height:3px;background:#ffd54f;box-shadow:0 0 10px #ffd54f;z-index:2;}
#arena-main{position:absolute;left:20px;top:20px;right:100px;bottom:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.arena-label{position:absolute;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:700;background:rgba(0,0,0,.7);border:1px solid;animation:fadeInUp .5s ease;}
@keyframes fadeInUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.antibody{position:absolute;font-size:20px;animation:floatUp 3s ease-out forwards;opacity:0;}
@keyframes floatUp{0%{opacity:0;transform:translateY(20px);}20%{opacity:1;}80%{opacity:1;}100%{opacity:0;transform:translateY(-40px);}}
.memory-cell{position:absolute;width:14px;height:14px;border-radius:50%;background:radial-gradient(circle,#64b5f6,#1565c0);box-shadow:0 0 10px #42a5f5;animation:pulseGlow 2s ease-in-out infinite;}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 10px #42a5f5;transform:scale(1);}50%{box-shadow:0 0 20px #42a5f5;transform:scale(1.2);}}
.pathogen{position:absolute;font-size:24px;animation:approachBounce 2s ease forwards;}
@keyframes approachBounce{0%{transform:translateX(80px);opacity:0;}40%{transform:translateX(0);opacity:1;}60%{transform:translateX(-10px) scale(1.1);}80%{transform:translateX(20px) scale(.5);opacity:.5;}100%{transform:translateX(40px) scale(0);opacity:0;}}
.particle-burst{position:absolute;width:6px;height:6px;border-radius:50%;animation:burst 1s ease-out forwards;}
@keyframes burst{0%{transform:scale(1);opacity:1;}100%{transform:scale(0);opacity:0;}}

/* RIGHT SIDEBAR */
#right-sidebar{width:280px;min-width:280px;background:linear-gradient(180deg,#1a1a2e,#16213e);border-left:1px solid #2a2a4a;display:flex;flex-direction:column;overflow-y:auto;padding:10px;}
#right-sidebar::-webkit-scrollbar{width:6px;}
#right-sidebar::-webkit-scrollbar-thumb{background:#4a4a6a;border-radius:3px;}
.hud-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:6px 0;}
.hud-stat{background:rgba(255,255,255,.05);border:1px solid #2a2a4a;border-radius:8px;padding:8px;text-align:center;}
.hud-stat .hud-val{font-size:22px;font-weight:700;color:#64b5f6;}
.hud-stat .hud-label{font-size:10px;color:#888;text-transform:uppercase;margin-top:2px;}
#progress-bar-container{margin:8px 0;background:#1a1a2e;border-radius:6px;height:20px;border:1px solid #2a2a4a;overflow:hidden;position:relative;}
#progress-bar-fill{height:100%;background:linear-gradient(90deg,#00897b,#4caf50);transition:width .5s;width:0;border-radius:6px;}
#progress-bar-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;}
#status-message{text-align:center;font-size:13px;color:#ffd54f;font-weight:600;margin:6px 0;min-height:18px;}
#copy-table-btn{width:100%;padding:6px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;background:linear-gradient(135deg,#37474f,#263238);color:#fff;margin:6px 0;transition:all .2s;}
#copy-table-btn:hover{background:linear-gradient(135deg,#455a64,#37474f);}
#data-table-container{flex:1;overflow-y:auto;}
#data-table{width:100%;border-collapse:collapse;font-size:11px;}
#data-table th{background:#1565c0;color:#fff;padding:5px 4px;text-align:left;position:sticky;top:0;z-index:1;font-size:10px;}
#data-table td{padding:4px;border-bottom:1px solid #2a2a4a;font-size:10px;color:#ccc;}
#data-table tr:nth-child(even){background:rgba(255,255,255,.02);}

/* WELCOME / IDLE STATE */
#welcome-screen{text-align:center;max-width:500px;}
#welcome-screen h2{font-size:28px;background:linear-gradient(135deg,#64b5f6,#ce93d8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px;}
#welcome-screen p{font-size:16px;color:#aaa;line-height:1.5;}
.mission-badge{display:inline-block;padding:8px 16px;border-radius:20px;background:linear-gradient(135deg,rgba(33,150,243,.2),rgba(156,39,176,.2));border:1px solid #4a4a6a;font-size:13px;margin-top:12px;color:#b0bec5;}

/* RECORD SCREEN */
.record-card{text-align:center;}
.record-card .checkmark{font-size:64px;animation:bounceIn .5s ease;}
@keyframes bounceIn{0%{transform:scale(0);}60%{transform:scale(1.2);}100%{transform:scale(1);}}
.record-card h2{color:#69f0ae;margin:8px 0;}

/* COMPLETION */
#completion-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:100;}
#completion-card{background:linear-gradient(135deg,#1a237e,#4a148c);border-radius:20px;padding:40px;text-align:center;max-width:420px;box-shadow:0 0 60px rgba(156,39,176,.4);}
#completion-card h1{font-size:32px;color:#ffd54f;margin-bottom:10px;}
#completion-card p{font-size:16px;color:#ccc;margin:8px 0;}
#completion-card button{margin-top:16px;padding:12px 30px;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#00897b,#00695c);color:#fff;}
</style>
</head>
<body>
<div id="app-header">Mr. Jawad Simulation: How Vaccines Train the Immune System</div>
<div id="main-container">

<!-- LEFT SIDEBAR -->
<div id="left-sidebar">
<div class="sidebar-header">Pick Any 5 You Like</div>
<div id="scenario-list"></div>
<div class="divider"></div>
<div class="sidebar-header">Reading Level</div>
<div class="reading-level-tabs">
<div class="rl-tab active" data-level="low" onclick="setReadingLevel('low')">Low</div>
<div class="rl-tab" data-level="med" onclick="setReadingLevel('med')">Med</div>
<div class="rl-tab" data-level="high" onclick="setReadingLevel('high')">High</div>
</div>
<div class="divider"></div>
<div class="sidebar-header">Key Words</div>
<div id="key-words-container"></div>
<div class="divider"></div>
<button id="btn-reset" onclick="resetSim()">Reset</button>
<button id="btn-new-run" onclick="newRun()">New Run</button>
</div>

<!-- CENTER PANEL -->
<div id="center-panel">
<div id="step-tabs">
<div class="step-tab" data-step="predict">1. PREDICT</div>
<div class="step-tab" data-step="read">2. READ</div>
<div class="step-tab" data-step="watch">3. WATCH</div>
<div class="step-tab" data-step="record">4. RECORD</div>
</div>
<div id="center-content">
<div id="welcome-screen">
<h2>The Vaccine Playbook</h2>
<p>Your body can be trained to fight diseases it has never seen â€” and the secret has been hiding in cows, fish farms, and cells that never forget.</p>
<div class="mission-badge">You are a medical investigator. Pick a case file from the left to begin.</div>
</div>
</div>
<div id="action-btn-container">
<button id="action-btn" style="display:none" onclick="handleAction()">Continue</button>
</div>
</div>

<!-- RIGHT SIDEBAR -->
<div id="right-sidebar">
<div class="sidebar-header">Progress</div>
<div class="hud-grid">
<div class="hud-stat"><div class="hud-val" id="hud-score">0</div><div class="hud-label">Score</div></div>
<div class="hud-stat"><div class="hud-val" id="hud-streak">0</div><div class="hud-label">Streak</div></div>
<div class="hud-stat"><div class="hud-val" id="hud-completed">0/8</div><div class="hud-label">Done</div></div>
<div class="hud-stat"><div class="hud-val" id="hud-accuracy">0%</div><div class="hud-label">Accuracy</div></div>
</div>
<div id="progress-bar-container">
<div id="progress-bar-fill"></div>
<div id="progress-bar-text">0 / 5 required</div>
</div>
<div id="status-message">Pick 5 more you like!</div>
<div class="divider"></div>
<div class="sidebar-header">Data Table <button id="copy-table-btn" onclick="copyTable()">ğŸ“‹ Copy Table</button></div>
<div id="data-table-container">
<table id="data-table">
<thead><tr><th>Scenario</th><th>What Changed?</th><th>System Response</th><th>Back Toward OK?</th></tr></thead>
<tbody id="data-table-body"></tbody>
</table>
</div>
</div>
</div>

<!-- COMPLETION OVERLAY -->
<div id="completion-overlay">
<div id="completion-card">
<h1 id="completion-title">Required Complete!</h1>
<p id="completion-text">You finished 5 scenarios. Continue for extra credit?</p>
<button onclick="closeCompletion()">Keep Going</button>
</div>
</div>

<script>
// ===================== DATA =====================
const SCENARIOS = [
{id:1,name:"The Milkmaid's Secret",emoji:"ğŸ„",whatChanged:"Boy received cowpox material",sysResponse:"Body produced antibodies that also fought smallpox",backOk:"Yes",
passages:{
low:"In the 1700s, milkmaids who catch <b>cowpox</b> from cows almost never get <b>smallpox</b>. A doctor named Edward Jenner tests this by giving a boy a small amount of cowpox material. The boy's body launches an <b>immune response</b> â€” his body produces <b>antibodies</b> that also recognize smallpox. The world's first <b>vaccine</b> is born, and the word \"<b>vaccine</b>\" comes from the Latin word for cow.",
med:"It is the 1700s, and smallpox kills about 30% of the people it infects. But milkmaids who catch <b>cowpox</b> â€” a mild disease from cows â€” almost never get smallpox. Doctor Edward Jenner decides to test why. He takes material from a milkmaid's cowpox sore and gives it to an 8-year-old boy named James Phipps. The boy's <b>immune response</b> kicks in â€” his body produces <b>antibodies</b> that happen to recognize smallpox too. Jenner has just invented the <b>vaccine</b>, and the word itself comes from vacca, the Latin word for cow.",
high:"It is the 1700s, and smallpox is one of the deadliest diseases on Earth â€” it kills about 30% of the people it infects and leaves survivors scarred for life. But something strange is happening on dairy farms. Milkmaids who catch <b>cowpox</b> â€” a mild disease picked up from cows â€” almost never get smallpox. In 1796, a doctor named Edward Jenner decides to test this pattern. He takes fluid from a milkmaid's cowpox sore and scratches it into the arm of an 8-year-old boy named James Phipps. The boy gets mildly sick, then recovers â€” his <b>immune response</b> has built <b>antibodies</b> that also recognize smallpox. Weeks later, Jenner exposes the boy to actual smallpox, and the boy does not get sick. The world's first <b>vaccine</b> is born â€” and the word comes from vacca, the Latin word for cow."
},watchType:"milkmaid",predictQ:"Will injecting cowpox material move protection TOWARD or AWAY from the Protected zone?"},

{id:2,name:"The Disease That Disappeared",emoji:"ğŸŒ",whatChanged:"Global vaccination campaign launched",sysResponse:"Worldwide immune protection built â€” smallpox eradicated",backOk:"Yes",
passages:{
low:"Smallpox kills an estimated 300 to 500 million people over 12,000 years â€” more than every war in history combined. In 1967, the World Health Organization launches a global <b>vaccine</b> campaign to wipe it out. Health workers travel to every country on Earth, vaccinating millions and building worldwide <b>immune response</b> protection. By 1980, smallpox is completely gone â€” the first human disease ever erased from the planet.",
med:"Smallpox is the deadliest disease in human history. Over 12,000 years, it kills an estimated 300 to 500 million people â€” more than every war combined. There is no cure. In 1967, the World Health Organization launches a massive global <b>vaccine</b> campaign. Health workers travel to remote villages, war zones, and crowded cities, vaccinating millions of people to build <b>immune response</b> protection. The <b>antibodies</b> and <b>memory cells</b> produced by the <b>vaccine</b> spread through population after population. By 1980, smallpox is declared completely gone â€” the only human disease ever erased from the planet.",
high:"Over 12,000 years, smallpox kills an estimated 300 to 500 million people â€” more than every war in human history combined. It leaves survivors blind or scarred for life. There is no cure, and no one is safe. In 1967, the World Health Organization decides to do something no one has ever attempted: erase a disease from the face of the Earth. Health workers carry <b>vaccines</b> to remote villages, active war zones, and the most crowded cities on the planet. In country after country, the <b>vaccine</b> triggers an <b>immune response</b> â€” people produce <b>antibodies</b> and <b>memory cells</b> that destroy the virus on contact. As vaccination rates climb, the virus runs out of people to infect. By 1980, smallpox is declared eradicated â€” the first and only human disease completely eliminated, thanks to a global <b>immune response</b> built one <b>vaccine</b> at a time."
},watchType:"eradication",predictQ:"Will a global vaccine campaign move protection TOWARD or AWAY from the Protected zone?"},

{id:3,name:"Post-Shot Reaction",emoji:"ğŸ’‰",whatChanged:"Person received a vaccine and felt sick",sysResponse:"Body built antibodies and memory cells through immune training",backOk:"Yes",
passages:{
low:"You get a <b>vaccine</b> and the next day your arm hurts and you feel tired. Nothing is wrong â€” your <b>immune response</b> is doing what it is supposed to do. Your body is building <b>antibodies</b> and <b>memory cells</b> to fight the real disease. The soreness means your body is learning.",
med:"You get a <b>vaccine</b> and wake up the next day feeling achy, tired, and maybe a little feverish. Most people think something went wrong â€” but the opposite is true. Your <b>immune response</b> has detected the harmless piece of <b>pathogen</b> inside the <b>vaccine</b> and is treating it like a real threat. Your body produces <b>antibodies</b> to neutralize the invader and builds <b>memory cells</b> that will remember this <b>pathogen</b> for years. The soreness in your arm is inflammation â€” your immune system rushing resources to the injection site. These mild symptoms mean your body is training its defenses so it can respond instantly if the real disease ever shows up.",
high:"You roll up your sleeve, get a <b>vaccine</b>, and wake up the next morning with a sore arm, a headache, and a low fever. It feels like you are getting sick. Most people worry that the shot caused a problem â€” but your body is actually doing exactly what it was designed to do. The <b>vaccine</b> contains a harmless piece of a <b>pathogen</b> â€” just enough for your <b>immune response</b> to detect and react to it. Your body launches the same defense it would use against a real infection: your <b>immune response</b> identifies the invader, produces <b>antibodies</b> to neutralize it, and builds <b>memory cells</b> that store the pattern for years. The soreness is inflammation â€” your immune system flooding the injection site with resources. The fever is your body raising its temperature to help immune cells work faster. These mild, temporary symptoms are proof that your body is training â€” building a defense system that can respond in hours instead of days if the real <b>pathogen</b> ever appears."
},watchType:"postshot",predictQ:"Will feeling sick after a vaccine move protection TOWARD or AWAY from the Protected zone?"},

{id:4,name:"Cells That Never Forget",emoji:"ğŸ§ ",whatChanged:"Memory cells entered low-energy standby mode",sysResponse:"Instant immune response activated decades later",backOk:"Yes",
passages:{
low:"After you get a <b>vaccine</b>, your body creates special <b>memory cells</b> that can survive for decades. Scientists discover that these cells switch into a low-energy standby mode â€” barely using any power but ready to activate instantly. This is why one yellow fever <b>vaccine</b> shot protects you for your entire life. Your <b>memory cells</b> are always standing guard, waiting to launch an <b>immune response</b> the moment a real threat appears.",
med:"After a <b>vaccine</b>, your body does not just make <b>antibodies</b> â€” it creates special <b>memory cells</b> designed to last. Scientists recently discover something remarkable about how these cells survive so long. <b>Memory cells</b> switch into a low-energy standby mode, barely using any resources but staying ready to activate at any moment. They can sit quietly in your body for decades, using almost zero energy. This is why a single yellow fever <b>vaccine</b> can protect a person for their entire life â€” the <b>memory cells</b> never stop standing guard. The moment a real <b>pathogen</b> shows up, they snap out of standby and launch a full <b>immune response</b> in hours instead of days.",
high:"Your body has a secret weapon that most people never think about: <b>memory cells</b>. After a <b>vaccine</b> trains your <b>immune response</b>, these specialized cells do not die off like regular immune cells. Instead, they switch into a low-energy standby mode â€” barely consuming any resources, like a phone on power-saving mode. Scientists recently discover that <b>memory cells</b> can survive in this state for decades, quietly stationed throughout your body. They do not need reminders. They do not weaken over time. This is why a single yellow fever <b>vaccine</b> shot can protect a person for their entire life â€” the <b>memory cells</b> are always there, always ready. The moment a real <b>pathogen</b> enters your body, these cells snap out of standby and launch a full <b>antibody</b> attack in hours â€” skipping the days-long delay your body needed the first time it fought that disease."
},watchType:"memorycells",predictQ:"Will memory cells surviving for decades move protection TOWARD or AWAY from the Protected zone?"},

{id:5,name:"154 Million Lives Saved",emoji:"ğŸ›¡ï¸",whatChanged:"50 years of global vaccination programs",sysResponse:"154 million lives saved through antibody protection",backOk:"Yes",
passages:{
low:"Over the past 50 years, <b>vaccines</b> save an estimated 154 million lives worldwide â€” about 6 lives every single minute. Most of those lives are babies and young children. They would have died from diseases like measles, polio, and whooping cough. Each of those children survived because a <b>vaccine</b> triggered an <b>immune response</b> that built <b>antibodies</b> before the real disease arrived. Childhood <b>vaccines</b> alone prevent about 4 million deaths every year.",
med:"The numbers are staggering: over the past 50 years, <b>vaccines</b> save an estimated 154 million lives. That is roughly 6 lives saved every single minute for half a century. Most of those lives are babies and young children too weak to fight diseases on their own. Each <b>vaccine</b> gives their bodies a head start â€” building <b>antibodies</b> and <b>memory cells</b> before the real <b>pathogen</b> shows up. Today, childhood <b>vaccines</b> prevent about 4 million deaths every single year. Without them, millions of children alive today would not have survived.",
high:"Here is a number that is hard to wrap your mind around: 154 million. That is how many lives <b>vaccines</b> have saved over the past 50 years â€” roughly 6 lives every single minute for half a century. The vast majority of those lives are babies and young children. Diseases like measles, polio, and whooping cough used to kill millions of kids every year â€” <b>vaccines</b> changed that. Each shot triggers the child's body to produce <b>antibodies</b> and build <b>memory cells</b> before the real <b>pathogen</b> arrives. This gives their immune system a blueprint for a disease it has never faced. Today, childhood <b>vaccines</b> alone prevent about 4 million deaths every single year. Without vaccination programs, millions of children currently alive would not have survived past their fifth birthday."
},watchType:"livessaved",predictQ:"Will 50 years of vaccination move protection TOWARD or AWAY from the Protected zone?"},

{id:6,name:"Measles Fights Back",emoji:"ğŸ“‰",whatChanged:"Vaccination rates dropped in communities",sysResponse:"Measles returned â€” over 1,200 cases in 2019",backOk:"No",
passages:{
low:"In the year 2000, measles is declared eliminated in the United States thanks to widespread <b>vaccination</b>. But when <b>vaccine</b> rates drop, the disease comes roaring back â€” over 1,200 cases in 2019. One infected person can spread the <b>pathogen</b> to 12 to 18 others. Without enough <b>antibodies</b> in the population, the <b>immune response</b> shield collapses.",
med:"Measles is declared eliminated in the United States in the year 2000 â€” a triumph of <b>vaccination</b>. For years, the disease stays gone because nearly everyone carries <b>antibodies</b> from their <b>vaccines</b>. But then <b>vaccine</b> rates start dropping in certain communities. Without enough people carrying <b>immune response</b> protection, measles finds openings. By 2019, over 1,200 cases explode across the country â€” the worst outbreak in nearly 30 years. The measles <b>pathogen</b> is so contagious that one sick person can infect 12 to 18 others.",
high:"In the year 2000, the United States makes a historic announcement: measles has been eliminated. Years of widespread <b>vaccination</b> mean nearly every person carries <b>antibodies</b> and <b>memory cells</b> that destroy the virus on contact. The disease has nowhere to go. But victory does not last. Over the next two decades, <b>vaccine</b> rates drop in certain communities â€” not by much, but enough. Measles is one of the most contagious <b>pathogens</b> on Earth: one infected person can spread it to 12 to 18 unvaccinated people, and the virus hangs in the air for up to 2 hours after that person leaves the room. Without enough <b>immune response</b> protection in the population, measles finds the gaps. By 2019, over 1,200 cases explode across the country â€” the largest U.S. measles outbreak in nearly 30 years, caused not by a new disease but by old protection fading away."
},watchType:"measles",predictQ:"Will dropping vaccination rates move protection TOWARD or AWAY from the Protected zone?"},

{id:7,name:"The Shield Around You",emoji:"ğŸ”¥",whatChanged:"Community maintained high vaccination rates",sysResponse:"Herd immunity protected unvaccinated baby",backOk:"Yes",
passages:{
low:"Some people cannot get <b>vaccinated</b> â€” babies too young, cancer patients on treatment, and anyone with a weak immune system. But if enough people around them carry <b>antibodies</b> from their <b>vaccines</b>, the disease cannot spread easily. This is called <b>herd immunity</b> â€” it works like a firewall protecting those who cannot protect themselves. When <b>vaccine</b> rates stay high, the <b>pathogen</b> runs out of people to infect.",
med:"Not everyone can get a <b>vaccine</b>. Babies are too young. Cancer patients on chemotherapy have weakened immune systems. Some people are allergic to <b>vaccine</b> ingredients. These individuals cannot build their own <b>antibodies</b> â€” their bodies cannot launch a proper <b>immune response</b> to the shot. But there is a way to protect them: if enough people around them ARE <b>vaccinated</b>, the <b>pathogen</b> cannot spread from person to person. This protection is called <b>herd immunity</b> â€” and it works because the disease runs out of hosts before it can reach the vulnerable person in the middle.",
high:"Imagine a baby born three weeks ago. She is too young for her first <b>vaccine</b> â€” her <b>immune response</b> is still developing, and she has almost no <b>antibodies</b> of her own. If a dangerous <b>pathogen</b> reaches her, she has very little defense. Now imagine the people around her: her parents, her older siblings, her neighbors, the nurses at her doctor's office. If every one of them is <b>vaccinated</b>, they all carry <b>antibodies</b> and <b>memory cells</b> that destroy the <b>pathogen</b> on contact. The disease cannot jump from person to person â€” it hits a wall of protection and dies out before reaching the baby. This is <b>herd immunity</b>: a shield built not by one person's immune system, but by an entire community's. When <b>vaccine</b> rates stay high enough, even the most vulnerable people are protected by the people standing around them."
},watchType:"herd",predictQ:"Will high community vaccination rates move protection TOWARD or AWAY from the Protected zone?"},

{id:8,name:"Fish Farms Fix It",emoji:"ğŸŸ",whatChanged:"Farms replaced antibiotics with vaccines",sysResponse:"Antibiotic use dropped 99%, fish built natural immunity",backOk:"Yes",
passages:{
low:"Norwegian fish farms used to pump their animals full of antibiotics to prevent infections. The problem: bacteria developed <b>resistance</b>, creating dangerous superbugs. In the late 1980s, the farms switch to <b>vaccines</b> instead â€” triggering each fish's <b>immune response</b> to build <b>antibodies</b> naturally. Antibiotic use drops by over 99%, and the fish stay healthier.",
med:"For years, Norwegian fish farms dump massive amounts of antibiotics into their water to keep fish from getting sick. It works at first â€” but the bacteria fight back. Some bacteria survive the antibiotics because they carry natural <b>resistance</b>, and those survivors multiply. The farms face a growing superbug crisis. Then in the late 1980s, scientists try something different: <b>vaccines</b> for fish. Each <b>vaccine</b> triggers the fish's <b>immune response</b> to produce <b>antibodies</b> naturally â€” no antibiotics needed. Antibiotic use on Norwegian fish farms drops by over 99%, the fish stay healthier, and <b>resistance</b> stops growing.",
high:"Norwegian fish farms have a problem. To keep millions of fish healthy in crowded pens, they pump massive amounts of antibiotics into the water â€” killing bacteria before they can cause infections. But bacteria are adaptable â€” the ones that survive carry natural <b>resistance</b> and multiply fast. Within years, the farms face superbugs that no antibiotic can touch â€” the same process that makes superbugs dangerous in hospitals worldwide. In the late 1980s, Norwegian scientists try a completely different approach: <b>vaccines</b> for fish. Each <b>vaccine</b> triggers the fish's own <b>immune response</b> to produce <b>antibodies</b> and <b>memory cells</b> â€” fighting infections naturally without creating <b>resistance</b>. The results are dramatic: antibiotic use on Norwegian farms drops by over 99%. Scientists around the world start asking whether <b>vaccines</b> could replace antibiotics in livestock too."
},watchType:"fishfarm",predictQ:"Will replacing antibiotics with vaccines move protection TOWARD or AWAY from the Protected zone?"}
];

const KEY_WORDS = ["vaccine","memory cell","antibody","immune response","herd immunity","resistance","pathogen"];

// ===================== STATE =====================
let state = {
currentScenario: null,
currentStep: null, // null, predict, read, watch, record
readingLevel: 'low',
completedScenarios: new Set(),
score: 0,
streak: 0,
predictions: 0,
correctPredictions: 0,
dataRows: [],
prediction: null,
speechActive: false,
speechResumeInterval: null
};

// ===================== INIT =====================
function init(){
renderScenarioCards();
renderKeyWords();
updateHUD();
}

function renderScenarioCards(){
const list = document.getElementById('scenario-list');
list.innerHTML = '';
SCENARIOS.forEach(sc => {
const card = document.createElement('div');
card.className = 'scenario-card' + (state.completedScenarios.has(sc.id)?' completed':'') + (state.currentScenario && state.currentScenario.id===sc.id?' selected':'');
card.innerHTML = `<span class="sc-emoji">${sc.emoji}</span><span class="sc-name">${sc.name}</span>`;
card.onclick = () => selectScenario(sc);
list.appendChild(card);
});
}

function renderKeyWords(){
const container = document.getElementById('key-words-container');
container.innerHTML = '';
KEY_WORDS.forEach(w => {
const span = document.createElement('span');
span.className = 'key-word';
span.textContent = w;
span.dataset.word = w.toLowerCase();
container.appendChild(span);
});
}

function highlightKeyWords(passageText){
const words = document.querySelectorAll('.key-word');
const lower = passageText.toLowerCase();
words.forEach(w => {
w.classList.toggle('highlighted', lower.includes(w.dataset.word));
});
}

// ===================== SCENARIO SELECT =====================
function selectScenario(sc){
if(state.completedScenarios.has(sc.id)) return;
if(state.currentStep === 'watch') return;
stopSpeech();
state.currentScenario = sc;
state.currentStep = 'predict';
state.prediction = null;
renderScenarioCards();
showStep('predict');
}

// ===================== STEP MANAGEMENT =====================
function showStep(step){
state.currentStep = step;
document.querySelectorAll('.step-tab').forEach(t => t.classList.toggle('active', t.dataset.step === step));
const center = document.getElementById('center-content');
const actionBtn = document.getElementById('action-btn');
const sc = state.currentScenario;

if(step === 'predict'){
center.innerHTML = `
<div class="content-card">
<h2>${sc.emoji} ${sc.name}</h2>
<div class="predict-question">${sc.predictQ}</div>
<div class="predict-btns">
<button class="predict-btn toward" onclick="makePrediction('toward')">â¬†ï¸ TOWARD Protected</button>
<button class="predict-btn away" onclick="makePrediction('away')">â¬‡ï¸ AWAY from Protected</button>
</div>
</div>`;
actionBtn.style.display = 'none';
} else if(step === 'read'){
const passage = sc.passages[state.readingLevel];
highlightKeyWords(passage);
center.innerHTML = `
<div class="content-card">
<h2>${sc.emoji} ${sc.name}</h2>
<div class="passage-text" id="passage-area">${passage}</div>
<button id="btn-read-aloud" onclick="readAloud()">ğŸ”Š Read Aloud</button>
</div>`;
actionBtn.style.display = 'block';
actionBtn.textContent = 'I Finished Reading â†’';
actionBtn.disabled = false;
} else if(step === 'watch'){
actionBtn.style.display = 'none';
center.innerHTML = `<div id="watch-arena">
<div id="arena-main"></div>
<div id="meter-container">
<div id="meter-zone-protected">SAFE</div>
<div id="meter-zone-building">BUILD</div>
<div id="meter-zone-vulnerable">RISK</div>
<div id="meter-ok-line"></div>
<div id="meter-fill"></div>
</div>
</div>`;
runWatchAnimation(sc);
} else if(step === 'record'){
recordData(sc);
center.innerHTML = `
<div class="content-card record-card">
<div class="checkmark">âœ…</div>
<h2>Data Recorded!</h2>
<p style="font-size:16px;color:#aaa;margin-top:8px;">${sc.emoji} ${sc.name} complete.</p>
</div>`;
actionBtn.style.display = 'block';
actionBtn.textContent = 'Pick Next Scenario â†’';
actionBtn.disabled = false;
}
}

function handleAction(){
if(state.currentStep === 'read'){
stopSpeech();
showStep('watch');
} else if(state.currentStep === 'record'){
state.currentScenario = null;
state.currentStep = null;
document.getElementById('action-btn').style.display = 'none';
document.getElementById('center-content').innerHTML = `
<div id="welcome-screen">
<h2>The Vaccine Playbook</h2>
<p>Pick another case file from the left sidebar to continue your investigation.</p>
<div class="mission-badge">${state.completedScenarios.size >= 5 ? 'Required complete! Keep going for extra credit.' : 'Pick ' + (5 - state.completedScenarios.size) + ' more you like!'}</div>
</div>`;
document.querySelectorAll('.step-tab').forEach(t => t.classList.remove('active'));
renderKeyWords();
}
}

// ===================== PREDICT =====================
function makePrediction(dir){
state.prediction = dir;
state.predictions++;
const sc = state.currentScenario;
const correct = (sc.backOk === 'Yes' && dir === 'toward') || (sc.backOk === 'No' && dir === 'away');
if(correct){
state.correctPredictions++;
state.score += 10;
state.streak++;
} else {
state.streak = 0;
}
updateHUD();
showStep('read');
}

// ===================== READING LEVEL =====================
function setReadingLevel(level){
state.readingLevel = level;
document.querySelectorAll('.rl-tab').forEach(t => t.classList.toggle('active', t.dataset.level === level));
if(state.currentStep === 'read' && state.currentScenario){
showStep('read');
}
}

// ===================== READ ALOUD =====================
let speechSynth = null;
function initSpeech(){
try { speechSynth = window.speechSynthesis; } catch(e){ speechSynth = null; }
}

function readAloud(){
try {
if(!speechSynth) initSpeech();
if(!speechSynth) return;
stopSpeech();
const area = document.getElementById('passage-area');
if(!area) return;
const text = area.innerText;
const utter = new SpeechSynthesisUtterance(text);
utter.rate = 0.9;
state.speechActive = true;

// Chrome 15-second bug workaround
state.speechResumeInterval = setInterval(() => {
try { if(speechSynth && speechSynth.speaking) speechSynth.resume(); } catch(e){}
}, 10000);

utter.onend = () => { stopSpeech(); };
utter.onerror = () => { stopSpeech(); };
speechSynth.speak(utter);
const btn = document.getElementById('btn-read-aloud');
if(btn) btn.textContent = 'â¹ Stop Reading';
btn.onclick = stopSpeech;
} catch(e){
// fallback: do nothing, text is visible
}
}

function stopSpeech(){
try {
if(speechSynth) speechSynth.cancel();
} catch(e){}
state.speechActive = false;
if(state.speechResumeInterval){
clearInterval(state.speechResumeInterval);
state.speechResumeInterval = null;
}
const btn = document.getElementById('btn-read-aloud');
if(btn){
btn.textContent = 'ğŸ”Š Read Aloud';
btn.onclick = readAloud;
}
}

// ===================== WATCH ANIMATIONS =====================
function runWatchAnimation(sc){
const arena = document.getElementById('arena-main');
const meterFill = document.getElementById('meter-fill');
if(!arena || !meterFill) return;

const isNegative = sc.backOk === 'No';
arena.innerHTML = '';

// Safety timeout
const safetyTimer = setTimeout(() => {
try { showStep('record'); } catch(e){}
}, 8000);

if(isNegative){
// MEASLES scenario - meter drops
meterFill.style.height = '80%';
setTimeout(() => {
arena.innerHTML = `<div style="text-align:center;">
<div style="font-size:48px;margin-bottom:8px;">ğŸ›¡ï¸âœ…</div>
<div class="arena-label" style="position:relative;border-color:#4caf50;color:#4caf50;">Eliminated â€” 2000</div>
</div>`;
}, 200);
setTimeout(() => {
arena.innerHTML = `<div style="text-align:center;">
<div style="font-size:48px;margin-bottom:8px;">âš ï¸ğŸ“‰</div>
<div class="arena-label" style="position:relative;border-color:#ff9800;color:#ff9800;">Vaccination Rates Dropping</div>
</div>`;
meterFill.style.height = '50%';
}, 2000);
setTimeout(() => {
arena.innerHTML = `<div style="text-align:center;">
<div style="font-size:48px;margin-bottom:8px;">ğŸ¦ ğŸ¦ ğŸ¦ ğŸ¦ ğŸ¦ </div>
<div class="arena-label" style="position:relative;border-color:#f44336;color:#f44336;">Measles Returns â€” 1,200+ Cases</div>
<div style="font-size:14px;color:#ffcdd2;margin-top:8px;">1 person â†’ infects 12-18 others</div>
</div>`;
meterFill.style.height = '15%';
meterFill.style.background = 'linear-gradient(180deg,rgba(244,67,54,.5),rgba(198,40,40,.3))';
}, 4000);
setTimeout(() => {
clearTimeout(safetyTimer);
meterFill.style.background = '';
showStep('record');
}, 6500);
} else {
// Positive scenarios - meter rises
meterFill.style.height = '10%';
const watchVisuals = getWatchVisuals(sc.watchType);
setTimeout(() => {
arena.innerHTML = watchVisuals.step1;
meterFill.style.height = '25%';
}, 300);
setTimeout(() => {
arena.innerHTML = watchVisuals.step2;
meterFill.style.height = '55%';
spawnAntibodies(arena, 5);
}, 2000);
setTimeout(() => {
arena.innerHTML = watchVisuals.step3;
meterFill.style.height = '85%';
spawnMemoryCells(arena, 4);
spawnAntibodies(arena, 4);
}, 4000);
setTimeout(() => {
clearTimeout(safetyTimer);
showStep('record');
}, 6500);
}
}

function getWatchVisuals(type){
const visuals = {
milkmaid: {
step1: `<div style="text-align:center;"><div style="font-size:56px;">ğŸ„ğŸ’§</div><div class="arena-label" style="position:relative;border-color:#8d6e63;color:#bcaaa4;">Cowpox material injected</div></div>`,
step2: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ›¡ï¸ğŸ”¬ğŸ”¬ğŸ”¬</div><div class="arena-label" style="position:relative;border-color:#ffd54f;color:#ffd54f;">Antibodies forming</div></div>`,
step3: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ›¡ï¸âœ¨ğŸ§ ğŸ’™</div><div class="arena-label" style="position:relative;border-color:#4caf50;color:#69f0ae;">Protected â€” Smallpox blocked!</div><div style="font-size:12px;color:#a5d6a7;margin-top:6px;">Memory cells standing guard</div></div>`
},
eradication: {
step1: `<div style="text-align:center;"><div style="font-size:48px;">ğŸŒğŸ’‰</div><div class="arena-label" style="position:relative;border-color:#42a5f5;color:#90caf9;">Global vaccine campaign begins</div></div>`,
step2: `<div style="text-align:center;"><div style="font-size:48px;">ğŸŒğŸ›¡ï¸ğŸ›¡ï¸ğŸ›¡ï¸</div><div class="arena-label" style="position:relative;border-color:#ffd54f;color:#ffd54f;">Countries turning protected</div></div>`,
step3: `<div style="text-align:center;"><div style="font-size:48px;">ğŸŒâœ…ğŸ†</div><div class="arena-label" style="position:relative;border-color:#ffd54f;color:#ffd54f;">ERADICATED â€” 1980</div><div style="font-size:12px;color:#a5d6a7;margin-top:6px;">First disease ever eliminated</div></div>`
},
postshot: {
step1: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ’‰ğŸ˜«ğŸ¤’</div><div class="arena-label" style="position:relative;border-color:#ff9800;color:#ffcc80;">Mild fever â€” body reacting</div></div>`,
step2: `<div style="text-align:center;"><div style="font-size:48px;">âš”ï¸ğŸ”¬ğŸ”¬</div><div class="arena-label" style="position:relative;border-color:#ffd54f;color:#ffd54f;">Antibodies training</div><div style="font-size:12px;color:#ffe082;margin-top:6px;">Soreness = learning</div></div>`,
step3: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ’ªğŸ§ âœ¨</div><div class="arena-label" style="position:relative;border-color:#4caf50;color:#69f0ae;">Trained â€” Ready for real threat</div><div style="font-size:12px;color:#a5d6a7;margin-top:6px;">Memory cells in standby</div></div>`
},
memorycells: {
step1: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ§ ğŸ’¤</div><div class="arena-label" style="position:relative;border-color:#42a5f5;color:#90caf9;">Memory cells â†’ Standby mode</div><div style="font-size:12px;color:#b3e5fc;margin-top:6px;">Near zero energy</div></div>`,
step2: `<div style="text-align:center;"><div style="font-size:48px;">â° 10yr â†’ 20yr â†’ 30yr</div><div class="arena-label" style="position:relative;border-color:#9575cd;color:#ce93d8;">Decades pass â€” cells still ready</div></div>`,
step3: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ¦ â†’ğŸ§ âš¡â†’ğŸ›¡ï¸</div><div class="arena-label" style="position:relative;border-color:#4caf50;color:#69f0ae;">Pathogen arrives â†’ Instant response!</div><div style="font-size:12px;color:#a5d6a7;margin-top:6px;">Hours, not days</div></div>`
},
livessaved: {
step1: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ’‰ğŸ‘¶ğŸ‘¶ğŸ‘¶</div><div class="arena-label" style="position:relative;border-color:#42a5f5;color:#90caf9;">Vaccinating children worldwide</div></div>`,
step2: `<div style="text-align:center;"><div style="font-size:36px;">ğŸ”¢ 154,000,000</div><div class="arena-label" style="position:relative;border-color:#ffd54f;color:#ffd54f;">Lives saved â€” 6 per minute</div></div>`,
step3: `<div style="text-align:center;"><div style="font-size:48px;">ğŸŒğŸ›¡ï¸ğŸ†</div><div class="arena-label" style="position:relative;border-color:#ffd54f;color:#ffd54f;">4 million saved every year</div><div style="font-size:12px;color:#a5d6a7;margin-top:6px;">Antibodies built before disease arrives</div></div>`
},
herd: {
step1: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ‘¤ğŸ›¡ï¸ğŸ‘¤ğŸ›¡ï¸ğŸ‘¶ğŸ‘¤ğŸ›¡ï¸</div><div class="arena-label" style="position:relative;border-color:#42a5f5;color:#90caf9;">Community vaccinated around baby</div></div>`,
step2: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ¦ â†’ğŸ›¡ï¸âŒ</div><div class="arena-label" style="position:relative;border-color:#ff9800;color:#ffcc80;">Pathogen blocked by shield</div></div>`,
step3: `<div style="text-align:center;"><div style="font-size:48px;">ğŸ‘¶âœ…ğŸ”¥ğŸ›¡ï¸</div><div class="arena-label" style="position:relative;border-color:#4caf50;color:#69f0ae;">Herd immunity â€” baby protected!</div><div style="font-size:12px;color:#a5d6a7;margin-top:6px;">Community shield active</div></div>`
},
fishfarm: {
step1: `<div style="text-align:center;"><div style="font-size:48px;">ğŸŸğŸ’ŠğŸ¦ </div><div class="arena-label" style="position:relative;border-color:#f44336;color:#ef9a9a;">Antibiotics â†’ Resistance growing</div></div>`,
step2: `<div style="text-align:center;"><div style="font-size:48px;">ğŸŸğŸ’‰ğŸ›¡ï¸</div><div class="arena-label" style="position:relative;border-color:#ffd54f;color:#ffd54f;">Vaccines replace antibiotics</div></div>`,
step3: `<div style="text-align:center;"><div style="font-size:48px;">ğŸŸâœ…ğŸ“‰</div><div class="arena-label" style="position:relative;border-color:#4caf50;color:#69f0ae;">99% less antibiotics!</div><div style="font-size:12px;color:#a5d6a7;margin-top:6px;">Natural immunity, no resistance</div></div>`
}
};
return visuals[type] || visuals.milkmaid;
}

function spawnAntibodies(container, count){
try {
for(let i = 0; i < count; i++){
const ab = document.createElement('div');
ab.className = 'antibody';
ab.textContent = 'ğŸ”¬';
ab.style.left = (20 + Math.random() * 60) + '%';
ab.style.top = (20 + Math.random() * 50) + '%';
ab.style.animationDelay = (i * 0.3) + 's';
container.appendChild(ab);
}
} catch(e){}
}

function spawnMemoryCells(container, count){
try {
for(let i = 0; i < count; i++){
const mc = document.createElement('div');
mc.className = 'memory-cell';
mc.style.left = (30 + Math.random() * 40) + '%';
mc.style.top = (30 + Math.random() * 30) + '%';
mc.style.animationDelay = (i * 0.4) + 's';
container.appendChild(mc);
}
} catch(e){}
}

// ===================== RECORD DATA =====================
function recordData(sc){
if(state.completedScenarios.has(sc.id)) return;
state.completedScenarios.add(sc.id);
state.score += 20;

const row = {
scenario: sc.name,
whatChanged: sc.whatChanged,
sysResponse: sc.sysResponse,
backOk: sc.backOk === 'Yes' ? 'Yes â€” toward Protected' : 'No â€” away from Protected'
};
state.dataRows.push(row);

const tbody = document.getElementById('data-table-body');
const tr = document.createElement('tr');
tr.innerHTML = `<td>${sc.name}</td><td>${sc.whatChanged}</td><td>${sc.sysResponse}</td><td>${row.backOk}</td>`;
tr.style.animation = 'fadeInUp .4s ease';
tbody.appendChild(tr);

renderScenarioCards();
updateHUD();

const completed = state.completedScenarios.size;
if(completed === 5){
setTimeout(() => showCompletionOverlay(false), 800);
} else if(completed === 8){
setTimeout(() => showCompletionOverlay(true), 800);
}
}

// ===================== HUD =====================
function updateHUD(){
document.getElementById('hud-score').textContent = state.score;
document.getElementById('hud-streak').textContent = state.streak;
const done = state.completedScenarios.size;
document.getElementById('hud-completed').textContent = done + '/8';
const acc = state.predictions > 0 ? Math.round((state.correctPredictions/state.predictions)*100) : 0;
document.getElementById('hud-accuracy').textContent = acc + '%';

const required = Math.min(done, 5);
document.getElementById('progress-bar-fill').style.width = (required/5*100) + '%';
document.getElementById('progress-bar-text').textContent = required + ' / 5 required';

const remaining = Math.max(0, 5 - done);
if(done >= 8) document.getElementById('status-message').textContent = 'Extra Credit Complete! ğŸ†';
else if(done >= 5) document.getElementById('status-message').textContent = 'Required done! ' + (8-done) + ' more for extra credit.';
else document.getElementById('status-message').textContent = 'Pick ' + remaining + ' more you like!';
}

// ===================== COMPLETION =====================
function showCompletionOverlay(isExtra){
const overlay = document.getElementById('completion-overlay');
const title = document.getElementById('completion-title');
const text = document.getElementById('completion-text');
overlay.style.display = 'flex';
if(isExtra){
title.textContent = 'Extra Credit Complete! ğŸ†';
text.textContent = 'Amazing! You completed all 8 scenarios. Copy your data table now.';
} else {
title.textContent = 'Required Complete! âœ…';
text.textContent = 'You finished 5 scenarios. Continue for extra credit?';
}
}

function closeCompletion(){
document.getElementById('completion-overlay').style.display = 'none';
}

// ===================== COPY TABLE =====================
function copyTable(){
try {
if(state.dataRows.length === 0){ alert('No data recorded yet.'); return; }
let text = 'Scenario\tWhat Changed?\tSystem Response\tBack Toward OK/Target?\n';
state.dataRows.forEach(r => {
text += r.scenario + '\t' + r.whatChanged + '\t' + r.sysResponse + '\t' + r.backOk + '\n';
});
navigator.clipboard.writeText(text).then(() => {
const btn = document.getElementById('copy-table-btn');
btn.textContent = 'âœ… Copied!';
setTimeout(() => { btn.textContent = 'ğŸ“‹ Copy Table'; }, 2000);
}).catch(() => {
// fallback
const ta = document.createElement('textarea');
ta.value = text;
document.body.appendChild(ta);
ta.select();
document.execCommand('copy');
document.body.removeChild(ta);
const btn = document.getElementById('copy-table-btn');
btn.textContent = 'âœ… Copied!';
setTimeout(() => { btn.textContent = 'ğŸ“‹ Copy Table'; }, 2000);
});
} catch(e){
alert('Could not copy. Please copy manually from the table.');
}
}

// ===================== RESET / NEW RUN =====================
function resetSim(){
stopSpeech();
state.currentScenario = null;
state.currentStep = null;
state.completedScenarios.clear();
state.score = 0;
state.streak = 0;
state.predictions = 0;
state.correctPredictions = 0;
state.dataRows = [];
state.prediction = null;
document.getElementById('data-table-body').innerHTML = '';
document.getElementById('action-btn').style.display = 'none';
document.querySelectorAll('.step-tab').forEach(t => t.classList.remove('active'));
renderScenarioCards();
renderKeyWords();
updateHUD();
document.getElementById('center-content').innerHTML = `
<div id="welcome-screen">
<h2>The Vaccine Playbook</h2>
<p>Your body can be trained to fight diseases it has never seen â€” and the secret has been hiding in cows, fish farms, and cells that never forget.</p>
<div class="mission-badge">You are a medical investigator. Pick a case file from the left to begin.</div>
</div>`;
}

function newRun(){
resetSim();
}

// ===================== START =====================
init();
</script>
</body>
</html>
