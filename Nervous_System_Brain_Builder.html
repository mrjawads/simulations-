<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad's Simulation Brain Builder</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#080818;color:#e0e0e0;overflow:hidden;height:100vh;user-select:none;}
#app{display:grid;grid-template-columns:250px 1fr 270px;height:100vh;gap:0;}

/* LEFT PANEL */
.lp{background:linear-gradient(180deg,#0d1b2a,#101828);padding:10px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;border-right:1px solid #1a3050;}
.lp::-webkit-scrollbar{width:4px;}.lp::-webkit-scrollbar-thumb{background:#1a3050;border-radius:4px;}
.ptitle{font-size:11px;font-weight:800;color:#64b5f6;text-transform:uppercase;letter-spacing:2px;text-align:center;padding:2px 0;}
.round-ind{text-align:center;font-size:22px;font-weight:900;color:#ffd54f;text-shadow:0 0 15px rgba(255,213,79,.4);padding:4px 0;}
.mission{background:linear-gradient(135deg,#1a237e,#283593);border-radius:10px;padding:8px;text-align:center;font-size:11px;color:#bbdefb;border:1px solid #3949ab;line-height:1.4;}
.evbanner{background:linear-gradient(135deg,#bf360c,#e64a19);border-radius:8px;padding:8px;text-align:center;font-size:12px;font-weight:700;color:#fff;display:none;animation:evflash 0.6s 4;}
@keyframes evflash{0%,100%{opacity:1;}50%{opacity:.5;}}
.vg{background:rgba(13,27,42,.6);border-radius:10px;padding:8px;border:1px solid #1a3050;}
.vg-label{font-size:10px;font-weight:800;color:#81d4fa;text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;}
.vg-opts{display:grid;grid-template-columns:1fr 1fr;gap:3px;}
.vg-opts.c3{grid-template-columns:1fr 1fr 1fr;}
.vb{padding:7px 4px;border:2px solid #1a3050;border-radius:8px;background:rgba(10,22,40,.8);color:#78909c;font-size:10px;font-weight:700;cursor:pointer;transition:all .25s;text-align:center;}
.vb:hover{border-color:#42a5f5;color:#e3f2fd;background:rgba(13,35,60,.9);}
.vb.sel{border-color:#00e676;background:linear-gradient(135deg,#1b5e20,#2e7d32);color:#fff;box-shadow:0 0 12px rgba(0,230,118,.35);}
.run-btn{padding:12px;border:none;border-radius:10px;font-size:15px;font-weight:800;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:1px;}
.run-btn.go{background:linear-gradient(135deg,#00c853,#2e7d32);color:#fff;box-shadow:0 0 25px rgba(0,200,83,.4);animation:pgo 2s infinite;}
.run-btn.no{background:#0f1a28;color:#37474f;cursor:default;box-shadow:none;animation:none;}
@keyframes pgo{0%,100%{box-shadow:0 0 20px rgba(0,200,83,.3);}50%{box-shadow:0 0 40px rgba(0,200,83,.6);}}
.bot-btns{display:flex;gap:5px;margin-top:auto;padding-top:6px;}
.bot-btns button{flex:1;padding:8px;border:none;border-radius:8px;font-size:10px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:.5px;}
.brst{background:linear-gradient(135deg,#b71c1c,#e53935);color:#fff;}
.bnew{background:linear-gradient(135deg,#0d47a1,#1e88e5);color:#fff;}

/* CENTER */
.cp{position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#050510;}
#brainCanvas{display:block;}
.toast{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:28px;font-weight:900;pointer-events:none;opacity:0;z-index:20;text-shadow:0 2px 15px currentColor;}
.toast.show{animation:tIn 1.8s forwards;}
@keyframes tIn{0%{opacity:0;transform:translate(-50%,-50%) scale(.5);}15%{opacity:1;transform:translate(-50%,-50%) scale(1.1);}30%{transform:translate(-50%,-50%) scale(1);}80%{opacity:1;}100%{opacity:0;transform:translate(-50%,-65%) scale(1);}}
.win-ov{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:30;}
.win-box{text-align:center;padding:30px 40px;border-radius:20px;background:linear-gradient(135deg,#1a237e,#4a148c);border:3px solid #ffd54f;box-shadow:0 0 80px rgba(255,213,79,.5);}
.win-box h2{font-size:30px;color:#ffd54f;margin-bottom:6px;}
.win-box p{color:#e1bee7;font-size:14px;}
.pow-badge{position:absolute;top:12px;right:12px;background:linear-gradient(135deg,#ff6f00,#ffab00);color:#fff;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:800;display:none;animation:ppow 1s infinite;z-index:10;box-shadow:0 0 15px rgba(255,171,0,.5);}
@keyframes ppow{0%,100%{transform:scale(1);}50%{transform:scale(1.08);}}
.str-badge{position:absolute;top:12px;left:12px;background:linear-gradient(135deg,#6a1b9a,#ab47bc);color:#fff;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:800;display:none;z-index:10;box-shadow:0 0 15px rgba(171,71,188,.4);}
.legend{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:14px;font-size:10px;color:#546e7a;z-index:5;background:rgba(5,5,16,.7);padding:4px 14px;border-radius:12px;}
.legend span{display:flex;align-items:center;gap:4px;}
.legend .d{width:10px;height:10px;border-radius:50%;}

/* RIGHT */
.rp{background:linear-gradient(180deg,#0d1b2a,#101828);padding:10px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;border-left:1px solid #1a3050;}
.rp::-webkit-scrollbar{width:4px;}.rp::-webkit-scrollbar-thumb{background:#1a3050;border-radius:4px;}
.meter{background:rgba(10,22,40,.7);border-radius:10px;padding:8px 10px;border:1px solid #1a3050;}
.meter-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.mn{font-size:11px;font-weight:700;}
.mv{font-size:16px;font-weight:900;min-width:32px;text-align:right;}
.md{font-size:13px;font-weight:900;margin-left:4px;opacity:0;transition:opacity .3s;}
.md.show{opacity:1;animation:dFade 2s forwards;}
@keyframes dFade{0%{opacity:1;}70%{opacity:1;}100%{opacity:0;}}
.mbar{height:16px;border-radius:8px;background:#0a1628;overflow:hidden;position:relative;border:1px solid #1a2a3a;}
.mfill{height:100%;border-radius:8px;transition:width 1s ease;position:relative;}
.mfill::after{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(180deg,rgba(255,255,255,.18),transparent);border-radius:8px 8px 0 0;}
.tline{position:absolute;height:100%;width:2px;top:0;z-index:2;}
.tline::after{content:'';position:absolute;top:-6px;left:-3px;width:8px;height:8px;background:inherit;border-radius:50%;}
.prune-box{background:rgba(10,22,40,.7);border-radius:10px;padding:10px;border:1px solid #1a3050;text-align:center;}
.prune-icon{font-size:36px;transition:all .5s;}
.prune-lbl{font-size:10px;font-weight:800;color:#607d8b;margin-top:2px;text-transform:uppercase;letter-spacing:1px;}
.hstats{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.hs{background:rgba(10,22,40,.7);border-radius:8px;padding:7px;text-align:center;border:1px solid #1a3050;}
.hs .v{font-size:18px;font-weight:900;color:#ffd54f;}
.hs .l{font-size:8px;color:#607d8b;text-transform:uppercase;letter-spacing:.5px;}
.cmsg{text-align:center;padding:6px 8px;border-radius:8px;font-size:11px;font-weight:700;display:none;}
.cmsg.req{background:linear-gradient(135deg,#1b5e20,#2e7d32);color:#a5d6a7;border:1px solid #4caf50;}
.cmsg.ext{background:linear-gradient(135deg,#e65100,#ff6d00);color:#fff;border:1px solid #ff9800;}
.dsec{flex:1;display:flex;flex-direction:column;min-height:0;}
.dtitle{font-size:11px;font-weight:800;color:#64b5f6;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px;}
.dtwrap{flex:1;overflow-y:auto;border-radius:8px;border:1px solid #1a3050;min-height:80px;}
.dtwrap::-webkit-scrollbar{width:3px;}.dtwrap::-webkit-scrollbar-thumb{background:#1a3050;border-radius:3px;}
.dt{width:100%;border-collapse:collapse;font-size:10px;}
.dt th{background:#1a237e;color:#bbdefb;padding:5px 3px;position:sticky;top:0;z-index:2;font-size:9px;font-weight:700;}
.dt td{padding:4px 3px;text-align:center;border-bottom:1px solid rgba(26,48,80,.5);color:#90a4ae;}
.dt tr.nr{animation:rf .8s;}
@keyframes rf{0%{background:rgba(0,230,118,.25);}100%{background:transparent;}}

/* SPLASH */
.splash{position:fixed;inset:0;background:rgba(8,8,24,.97);z-index:100;display:flex;align-items:center;justify-content:center;}
.sbox{text-align:center;max-width:520px;padding:40px 30px;}
.sbox h1{font-size:36px;color:#64b5f6;margin-bottom:6px;text-shadow:0 0 30px rgba(100,181,246,.4);}
.sbox .sub{color:#ffd54f;font-size:14px;font-weight:700;margin-bottom:16px;}
.sbox p{color:#90a4ae;font-size:13px;margin-bottom:16px;line-height:1.5;}
.sbox button{padding:16px 50px;border:none;border-radius:14px;background:linear-gradient(135deg,#00c853,#2e7d32);color:#fff;font-size:20px;font-weight:800;cursor:pointer;box-shadow:0 0 40px rgba(0,200,83,.4);transition:transform .2s;text-transform:uppercase;letter-spacing:2px;}
.sbox button:hover{transform:scale(1.05);}
.bp{font-size:80px;margin-bottom:10px;filter:drop-shadow(0 0 20px rgba(100,181,246,.5));}
</style>
</head>
<body>
<div class="splash" id="splash">
<div class="sbox">
<div class="bp">üß†</div>
<h1>Brain Builder</h1>
<div class="sub">How Long-Term Habits Wire Your Developing Brain</div>
<p>Your teenage brain is a construction site ‚Äî every week, it decides which pathways to keep and which to tear down.</p>
<p style="color:#e0e0e0;font-weight:600;">Build strong pathways. Keep vulnerability low. Survive 8 weeks!</p>
<button onclick="startGame()">START</button>
</div>
</div>

<div id="app" style="display:none;">
<div class="lp">
<div class="ptitle">Control Panel</div>
<div class="round-ind" id="roundDisp">Week 1 / 8</div>
<div class="mission">Build pathways. Stay strong. Beat pruning.</div>
<div class="evbanner" id="evBan"></div>
<div class="vg"><div class="vg-label">Practice Type</div><div class="vg-opts" id="vg0">
<div class="vb" onclick="sel(0,0)">None</div><div class="vb" onclick="sel(0,1)">Passive</div><div class="vb" onclick="sel(0,2)">Active</div><div class="vb" onclick="sel(0,3)">Overload</div>
</div></div>
<div class="vg"><div class="vg-label">Sleep Consistency</div><div class="vg-opts c3" id="vg1">
<div class="vb" onclick="sel(1,0)">Irregular</div><div class="vb" onclick="sel(1,1)">Mostly Reg</div><div class="vb" onclick="sel(1,2)">Consistent</div>
</div></div>
<div class="vg"><div class="vg-label">Challenge Level</div><div class="vg-opts c3" id="vg2">
<div class="vb" onclick="sel(2,0)">Too Easy</div><div class="vb" onclick="sel(2,1)">Just Right</div><div class="vb" onclick="sel(2,2)">Overwhelming</div>
</div></div>
<div class="vg"><div class="vg-label">Social Connection</div><div class="vg-opts c3" id="vg3">
<div class="vb" onclick="sel(3,0)">Isolated</div><div class="vb" onclick="sel(3,1)">Some</div><div class="vb" onclick="sel(3,2)">Regular</div>
</div></div>
<button class="run-btn no" id="runBtn" onclick="runWeek()">Run Week</button>
<div class="bot-btns"><button class="brst" onclick="resetGame()">Reset</button><button class="bnew" onclick="resetGame()">New Run</button></div>
</div>

<div class="cp" id="cp">
<div class="str-badge" id="strBadge">üî• Streak: 0</div>
<div class="pow-badge" id="powBadge">‚ö° Growth Spurt!</div>
<canvas id="brainCanvas"></canvas>
<div class="toast" id="toast"></div>
<div class="win-ov" id="winOv"><div class="win-box"><h2>üèÜ Brain Fully Wired!</h2><p>3 balanced rounds ‚Äî golden brain!</p></div></div>
<div class="legend">
<span><div class="d" style="background:#00e676;box-shadow:0 0 6px #00e676;"></div>Growing</span>
<span><div class="d" style="background:#42a5f5;box-shadow:0 0 6px #42a5f5;"></div>Active</span>
<span><div class="d" style="background:#ef5350;box-shadow:0 0 6px #ef5350;"></div>Pruning</span>
<span><div class="d" style="background:#ffd54f;box-shadow:0 0 6px #ffd54f;"></div>Myelin</span>
</div>
</div>

<div class="rp">
<div class="ptitle">Progress</div>
<div class="hstats">
<div class="hs"><div class="v" id="sScore">0</div><div class="l">Score</div></div>
<div class="hs"><div class="v" id="sStreak">0</div><div class="l">Win Streak</div></div>
<div class="hs"><div class="v" id="sRounds">0/8</div><div class="l">Completed</div></div>
<div class="hs"><div class="v" id="sBest">0</div><div class="l">Best Growth</div></div>
</div>
<div class="meter"><div class="meter-top"><span class="mn" style="color:#00e676;">Brain Strength</span><span><span class="mv" id="bsV" style="color:#00e676;">65</span><span class="md" id="bsD"></span></span></div><div class="mbar"><div class="mfill" id="bsF" style="width:65%;background:linear-gradient(90deg,#1b5e20,#00e676);"></div><div class="tline" style="left:60%;background:rgba(255,255,255,.35);"></div></div></div>
<div class="meter"><div class="meter-top"><span class="mn" style="color:#42a5f5;">Pathway Growth</span><span><span class="mv" id="pgV" style="color:#42a5f5;">50</span><span class="md" id="pgD"></span></span></div><div class="mbar"><div class="mfill" id="pgF" style="width:50%;background:linear-gradient(90deg,#0d47a1,#42a5f5);"></div><div class="tline" style="left:60%;background:rgba(255,255,255,.35);"></div></div></div>
<div class="meter"><div class="meter-top"><span class="mn" style="color:#ef5350;">Vulnerability</span><span><span class="mv" id="vuV" style="color:#ef5350;">30</span><span class="md" id="vuD"></span></span></div><div class="mbar"><div class="mfill" id="vuF" style="width:30%;background:linear-gradient(90deg,#b71c1c,#ef5350);"></div><div class="tline" style="left:40%;background:rgba(255,255,255,.35);"></div></div></div>
<div class="prune-box"><div class="prune-icon" id="prIcon">üü¢</div><div class="prune-lbl" id="prLbl">No Alert</div></div>
<div class="cmsg req" id="reqMsg">‚úÖ 5 Rounds Done! Extra Credit?</div>
<div class="cmsg ext" id="extMsg">üåü All 8 Complete!</div>
<div class="dsec"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;"><div class="dtitle">Data Table</div><button id="copyBtn" onclick="copyTable()" style="background:linear-gradient(135deg,#1565c0,#1e88e5);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:10px;font-weight:700;cursor:pointer;">üìã Copy Table</button></div><div class="dtwrap"><table class="dt"><thead><tr><th>Rnd</th><th>Variable</th><th>Brain</th><th>Growth</th><th>Vuln</th></tr></thead><tbody id="dtBody"></tbody></table></div></div>
</div>
</div>

<script>
const S={round:0,bs:65,pg:50,vuln:30,score:0,bestPG:50,selVar:-1,selVal:-1,
activePracticeStreak:0,badStreak:0,pruneLevel:0,growthSpurt:false,
winStreak:0,won:false,gameOver:false,
vars:[{n:'Practice',v:['None','Passive','Active','Overload'],c:2},
{n:'Sleep',v:['Irregular','Mostly Reg','Consistent'],c:2},
{n:'Challenge',v:['Too Easy','Just Right','Overwhelming'],c:1},
{n:'Social',v:['Isolated','Some','Regular'],c:2}]};

let canvas,ctx,CW,CH,BCX,BCY,BR;
let golden=false;

// Brain data
const REG=[
{cx:0,cy:-0.30,lbl:'Prefrontal',col:'#42a5f5'},
{cx:-0.25,cy:-0.08,lbl:'Motor',col:'#66bb6a'},
{cx:0.25,cy:-0.08,lbl:'Sensory',col:'#ffa726'},
{cx:-0.30,cy:0.18,lbl:'Temporal',col:'#ab47bc'},
{cx:0.30,cy:0.18,lbl:'Parietal',col:'#26c6da'},
{cx:0,cy:0.32,lbl:'Limbic',col:'#ef5350'}
];

let paths=[];   // neural pathways
let sparks=[];   // particle sparks
let pruneAni=[]; // dying pathway anims
let growAni=[];  // growth ring anims
let myelAni=[];  // myelin coating anims
let pulseAni=[]; // region pulse anims

function initCanvas(){
canvas=document.getElementById('brainCanvas');
const cp=document.getElementById('cp');
CW=cp.clientWidth;CH=cp.clientHeight;
canvas.width=CW;canvas.height=CH;
ctx=canvas.getContext('2d');
BCX=CW/2;BCY=CH/2;
BR=Math.min(CW,CH)*0.38;
}

function regXY(i){return{x:BCX+REG[i].cx*BR*2,y:BCY+REG[i].cy*BR*2};}

function initPaths(){
paths=[];sparks=[];pruneAni=[];growAni=[];myelAni=[];pulseAni=[];
for(let i=0;i<REG.length;i++){
const p=regXY(i);
// Internal branches
for(let j=0;j<5;j++){
const a=Math.random()*Math.PI*2;
const d=BR*0.12+Math.random()*BR*0.22;
const ex=p.x+Math.cos(a)*d,ey=p.y+Math.sin(a)*d;
// Add intermediate control point for curved paths
const mx=(p.x+ex)/2+(Math.random()-0.5)*d*0.5;
const my=(p.y+ey)/2+(Math.random()-0.5)*d*0.5;
paths.push({x1:p.x,y1:p.y,mx:mx,my:my,x2:ex,y2:ey,
str:0.25+Math.random()*0.35,mye:0.1+Math.random()*0.25,
reg:i,alive:true});
}
// Cross connections
const ni=(i+1)%REG.length;
const np=regXY(ni);
const mx2=(p.x+np.x)/2+(Math.random()-0.5)*30;
const my2=(p.y+np.y)/2+(Math.random()-0.5)*30;
paths.push({x1:p.x,y1:p.y,mx:mx2,my:my2,x2:np.x,y2:np.y,
str:0.35+Math.random()*0.2,mye:0.15+Math.random()*0.2,
reg:i,alive:true});
// Additional cross to non-adjacent
const fi=(i+3)%REG.length;
const fp=regXY(fi);
const mx3=(p.x+fp.x)/2+(Math.random()-0.5)*40;
const my3=(p.y+fp.y)/2+(Math.random()-0.5)*40;
paths.push({x1:p.x,y1:p.y,mx:mx3,my:my3,x2:fp.x,y2:fp.y,
str:0.2+Math.random()*0.2,mye:0.1+Math.random()*0.15,
reg:i,alive:true});
}
}

// Point on quadratic bezier
function bezPt(p,t){
const u=1-t;
return{x:u*u*p.x1+2*u*t*p.mx+t*t*p.x2,y:u*u*p.y1+2*u*t*p.my+t*t*p.y2};
}

function sel(vi,val){
if(S.gameOver)return;
document.querySelectorAll('.vb').forEach(b=>b.classList.remove('sel'));
const grp=document.getElementById('vg'+vi);
grp.children[val].classList.add('sel');
S.selVar=vi;S.selVal=val;
document.getElementById('runBtn').className='run-btn go';
// Pulse associated regions
const regionMap=[[0,1],[2,3],[0,4],[4,5]];
const regs=regionMap[vi]||[vi];
regs.forEach(ri=>{
const rp=regXY(ri);
pulseAni.push({x:rp.x,y:rp.y,t:0,max:40,col:REG[ri].col});
});
}

function runWeek(){
if(S.selVar===-1||S.gameOver)return;
S.round++;
S.vars[S.selVar].c=S.selVal;

// Random event
let eventFired=false;
if(S.round>1&&Math.random()<0.18){
eventFired=true;S.vars[1].c=0;
const eb=document.getElementById('evBan');
eb.innerHTML='‚òÄÔ∏è Summer Break! Sleep ‚Üí Irregular';
eb.style.display='block';
setTimeout(()=>eb.style.display='none',4000);
}else document.getElementById('evBan').style.display='none';

const pr=S.vars[0].c,sl=S.vars[1].c,ch=S.vars[2].c,so=S.vars[3].c;

if(pr===2)S.activePracticeStreak++;else S.activePracticeStreak=0;
let gB=0;
if(S.growthSpurt){gB=15;S.growthSpurt=false;}
if(S.activePracticeStreak>=2)S.growthSpurt=true;

let dB=0,dP=0,dV=0;
// Practice
if(pr===0){dP-=12;dV+=5;}else if(pr===1){dP-=2;dV+=3;}
else if(pr===2){dP+=14;dB+=5;dV-=3;}else{dP+=5;dB-=10;dV+=12;}
// Sleep
if(sl===0){dB-=8;dV+=8;dP-=3;}else if(sl===1){dB+=2;dP+=4;}
else{dB+=5;dP+=10;dV-=4;}
// Challenge
if(ch===0){dP-=5;}else if(ch===1){dP+=10;dB+=3;}
else{dV+=10;dB-=8;dP+=2;}
// Social
if(so===0){dV+=5;}else if(so===1){dV-=1;}else{dB+=3;dV-=3;}
dP+=gB;

// Pruning
const bad=(pr<=1&&sl===0);
if(bad)S.badStreak++;else S.badStreak=0;
if(S.badStreak>=3){S.pruneLevel=2;dP-=20;}
else if(S.badStreak>=2)S.pruneLevel=2;
else if(S.badStreak>=1)S.pruneLevel=1;
else S.pruneLevel=0;

const oB=S.bs,oP=S.pg,oV=S.vuln;
S.bs=clamp(S.bs+dB);S.pg=clamp(S.pg+dP);S.vuln=clamp(S.vuln+dV);

let rs=0;
if(S.bs>60)rs+=10;if(S.pg>60)rs+=10;if(S.vuln<40)rs+=10;
S.score+=rs;if(S.pg>S.bestPG)S.bestPG=S.pg;

const inZ=S.bs>60&&S.pg>60&&S.vuln<40;
if(inZ&&!(gB>0&&dP-gB<=0))S.winStreak++;else S.winStreak=0;

if(S.winStreak>=3&&!S.won){
S.won=true;golden=true;S.score+=50;
setTimeout(()=>{document.getElementById('winOv').style.display='flex';
setTimeout(()=>document.getElementById('winOv').style.display='none',3500);},1000);
}

// ANIMATE PATHWAYS
animPaths(pr,dP);
showToast(dP);
showDelta('bsD',S.bs-oB);showDelta('pgD',S.pg-oP);showDelta('vuD',S.vuln-oV);

const vn=['Practice','Sleep','Challenge','Social'];
addRow(S.round,vn[S.selVar]+'‚Äî'+S.vars[S.selVar].v[S.selVal],S.bs,S.pg,S.vuln);

S.selVar=-1;S.selVal=-1;
document.querySelectorAll('.vb').forEach(b=>b.classList.remove('sel'));
document.getElementById('runBtn').className='run-btn no';
if(S.round===5)document.getElementById('reqMsg').style.display='block';
if(S.round>=8){document.getElementById('extMsg').style.display='block';document.getElementById('reqMsg').style.display='none';S.gameOver=true;}
updateUI();
}

function animPaths(pr,dP){
const alive=paths.filter(p=>p.alive);
if(dP>5){
// GROWTH
alive.forEach(p=>{p.str=Math.min(1,p.str+0.05+Math.random()*0.04);p.mye=Math.min(1,p.mye+0.04+Math.random()*0.03);});
// Growth rings
for(let i=0;i<10;i++){
const pw=alive[Math.floor(Math.random()*alive.length)];
const pt=bezPt(pw,Math.random());
growAni.push({x:pt.x,y:pt.y,t:0,max:50});
}
// Myelin coaters
for(let i=0;i<15;i++){
const pw=alive[Math.floor(Math.random()*alive.length)];
myelAni.push({p:pw,t:0,max:70});
}
// Green sparks
for(let i=0;i<30;i++){
const pw=alive[Math.floor(Math.random()*alive.length)];
const pt=bezPt(pw,Math.random());
sparks.push({x:pt.x,y:pt.y,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,
life:35+Math.random()*30,ml:65,col:'#00e676'});
}
// New pathway on active
if(pr===2&&alive.length<50){
const ri=Math.floor(Math.random()*6);const rp=regXY(ri);
const a=Math.random()*Math.PI*2,d=BR*0.12+Math.random()*BR*0.25;
const ex=rp.x+Math.cos(a)*d,ey=rp.y+Math.sin(a)*d;
const mx=(rp.x+ex)/2+(Math.random()-0.5)*d*0.5;
const my=(rp.y+ey)/2+(Math.random()-0.5)*d*0.5;
paths.push({x1:rp.x,y1:rp.y,mx,my,x2:ex,y2:ey,str:0.15,mye:0.05,reg:ri,alive:true});
}
}else if(dP<-5){
// PRUNING
alive.forEach(p=>{p.str=Math.max(0.05,p.str-0.05);p.mye=Math.max(0,p.mye-0.04);});
const toKill=Math.min(4,Math.floor(Math.abs(dP)/7));
const weak=alive.filter(p=>p.str<0.45).sort((a,b)=>a.str-b.str);
for(let i=0;i<toKill&&weak.length>i&&alive.length>8;i++){
const pw=weak[i];pw.alive=false;
pruneAni.push({x1:pw.x1,y1:pw.y1,mx:pw.mx,my:pw.my,x2:pw.x2,y2:pw.y2,t:0,max:80});
}
// Red sparks
for(let i=0;i<25;i++){
const pw=alive[Math.floor(Math.random()*alive.length)];if(!pw)continue;
const pt=bezPt(pw,Math.random());
sparks.push({x:pt.x,y:pt.y,vx:(Math.random()-0.5)*3.5,vy:(Math.random()-0.5)*3.5-0.5,
life:40+Math.random()*25,ml:65,col:'#ef5350'});
}
}else{
// Stable
for(let i=0;i<6;i++){
const pw=alive[Math.floor(Math.random()*alive.length)];if(!pw)continue;
const pt=bezPt(pw,Math.random());
sparks.push({x:pt.x,y:pt.y,vx:(Math.random()-0.5)*1.5,vy:(Math.random()-0.5)*1.5,
life:25+Math.random()*20,ml:45,col:'#78909c'});
}
}
}

function showToast(dP){
const el=document.getElementById('toast');
let msg,col;
if(dP>15){msg='üß† Massive Growth!';col='#00e676';}
else if(dP>5){msg='üìà Pathways Growing';col='#66bb6a';}
else if(dP>-3){msg='‚öñÔ∏è Holding Steady';col='#ffa726';}
else if(dP>-12){msg='‚ö†Ô∏è Weakening';col='#ff7043';}
else{msg='üî¥ Pruning Alert!';col='#ef5350';}
if(S.growthSpurt)msg='‚ö° Growth Spurt Next!';
el.textContent=msg;el.style.color=col;
el.className='toast show';
setTimeout(()=>el.className='toast',1900);
}
function showDelta(id,d){
const el=document.getElementById(id);
if(d>0){el.textContent='‚ñ≤+'+d;el.style.color='#00e676';}
else if(d<0){el.textContent='‚ñº'+d;el.style.color='#ef5350';}
else{el.textContent='';return;}
el.className='md show';setTimeout(()=>el.className='md',2200);
}
function addRow(r,v,bs,pg,vu){
const tb=document.getElementById('dtBody');
const tr=document.createElement('tr');tr.className='nr';
tr.innerHTML=`<td>${r}</td><td style="font-size:9px">${v}</td><td>${bs}</td><td>${pg}</td><td>${vu}</td>`;
tb.appendChild(tr);tr.scrollIntoView({behavior:'smooth'});
}
function updateUI(){
document.getElementById('roundDisp').textContent=S.round>=8?'Complete!':'Week '+(S.round+1)+' / 8';
document.getElementById('bsV').textContent=S.bs;document.getElementById('pgV').textContent=S.pg;document.getElementById('vuV').textContent=S.vuln;
const bsF=document.getElementById('bsF');bsF.style.width=S.bs+'%';
bsF.style.background=S.bs>60?'linear-gradient(90deg,#1b5e20,#00e676)':'linear-gradient(90deg,#b71c1c,#ef5350)';
const pgF=document.getElementById('pgF');pgF.style.width=S.pg+'%';
pgF.style.background=S.pg>60?'linear-gradient(90deg,#0d47a1,#42a5f5)':'linear-gradient(90deg,#e65100,#ff6d00)';
const vuF=document.getElementById('vuF');vuF.style.width=S.vuln+'%';
vuF.style.background=S.vuln<40?'linear-gradient(90deg,#1b5e20,#66bb6a)':'linear-gradient(90deg,#b71c1c,#ef5350)';
const pi=document.getElementById('prIcon'),pl=document.getElementById('prLbl');
if(S.pruneLevel===0){pi.textContent='üü¢';pl.textContent='No Alert';}
else if(S.pruneLevel===1){pi.textContent='üü°';pl.textContent='Warning!';}
else{pi.textContent='üî¥';pl.textContent='DANGER!';}
document.getElementById('sScore').textContent=S.score;
document.getElementById('sStreak').textContent=S.winStreak;
document.getElementById('sRounds').textContent=S.round+'/8';
document.getElementById('sBest').textContent=S.bestPG;
document.getElementById('powBadge').style.display=S.growthSpurt?'block':'none';
const sb=document.getElementById('strBadge');
if(S.winStreak>0){sb.style.display='block';sb.textContent='üî• Streak: '+S.winStreak;}else sb.style.display='none';
}

// ‚îÄ‚îÄ‚îÄ DRAWING ‚îÄ‚îÄ‚îÄ
function draw(){
if(!ctx)return;
ctx.clearRect(0,0,CW,CH);

drawBG();
drawBrainShape();
drawPaths();
drawPruneA();
drawGrowA();
drawMyelA();
drawSignals();
drawSparksA();
drawPulseA();
drawRegLabels();

requestAnimationFrame(draw);
}

function drawBG(){
const g=ctx.createRadialGradient(BCX,BCY,BR*0.2,BCX,BCY,BR*2.5);
g.addColorStop(0,golden?'rgba(60,50,0,0.12)':'rgba(15,25,50,0.15)');
g.addColorStop(1,'rgba(5,5,16,1)');
ctx.fillStyle=g;ctx.fillRect(0,0,CW,CH);
}

function drawBrainShape(){
ctx.save();
const glow=0.15+(S.pg/100)*0.3;
const sCol=golden?'rgba(255,213,79,':'rgba(100,181,246,';

// Brain silhouette - two overlapping ellipses
// Left hemisphere
ctx.beginPath();
ctx.ellipse(BCX-BR*0.08,BCY,BR*0.78,BR*0.92,0,0,Math.PI*2);
ctx.strokeStyle=sCol+glow+')';ctx.lineWidth=2.5;
ctx.shadowColor=golden?'#ffd54f':'#42a5f5';ctx.shadowBlur=20+(S.pg/100)*15;
ctx.stroke();

// Right hemisphere
ctx.beginPath();
ctx.ellipse(BCX+BR*0.08,BCY,BR*0.78,BR*0.92,0,0,Math.PI*2);
ctx.stroke();

// Fill
ctx.beginPath();
ctx.ellipse(BCX,BCY,BR*0.85,BR*0.95,0,0,Math.PI*2);
const fg=ctx.createRadialGradient(BCX,BCY,BR*0.1,BCX,BCY,BR*0.95);
fg.addColorStop(0,golden?'rgba(255,213,79,0.06)':'rgba(30,60,100,0.04)');
fg.addColorStop(1,'rgba(5,5,16,0)');
ctx.fillStyle=fg;ctx.shadowBlur=0;ctx.fill();

// Fissure
ctx.beginPath();ctx.moveTo(BCX,BCY-BR*0.92);
ctx.bezierCurveTo(BCX-4,BCY-BR*0.3,BCX+4,BCY+BR*0.3,BCX,BCY+BR*0.92);
ctx.strokeStyle=sCol+(glow*0.4)+')';ctx.lineWidth=1.5;ctx.shadowBlur=5;ctx.stroke();

// Sulci (wrinkle lines)
ctx.lineWidth=0.7;ctx.strokeStyle=sCol+'0.07)';ctx.shadowBlur=0;
const sulci=[[-0.5,-0.3,-0.1,-0.6,0.2,-0.2],[-0.6,0,-.2,0.3,0.1,0.15],
[0.1,-0.6,0.4,-0.3,0.6,-0.5],[0.15,0.1,0.45,0.3,0.55,0],[-.4,0.2,-.15,0.5,.1,0.35]];
sulci.forEach(s=>{
ctx.beginPath();ctx.moveTo(BCX+s[0]*BR,BCY+s[1]*BR);
ctx.quadraticCurveTo(BCX+s[2]*BR,BCY+s[3]*BR,BCX+s[4]*BR,BCY+s[5]*BR);
ctx.stroke();
});
ctx.restore();
}

function drawPaths(){
paths.forEach(p=>{
if(!p.alive)return;
ctx.save();
const w=1.5+p.str*5+p.mye*3;

// Draw curved pathway
ctx.beginPath();
ctx.moveTo(p.x1,p.y1);ctx.quadraticCurveTo(p.mx,p.my,p.x2,p.y2);

if(golden){
ctx.strokeStyle=`rgba(255,213,79,${0.15+p.str*0.55})`;
ctx.shadowColor='#ffd54f';ctx.shadowBlur=4+p.mye*18;
}else{
ctx.strokeStyle=`rgba(100,181,246,${0.08+p.str*0.5})`;
ctx.shadowColor='#42a5f5';ctx.shadowBlur=2+p.mye*12;
}
ctx.lineWidth=w;ctx.lineCap='round';ctx.stroke();

// Myelin sheath glow (bright yellow overlay)
if(p.mye>0.25){
ctx.beginPath();ctx.moveTo(p.x1,p.y1);ctx.quadraticCurveTo(p.mx,p.my,p.x2,p.y2);
ctx.strokeStyle=`rgba(255,235,59,${p.mye*0.3})`;
ctx.lineWidth=w+3;ctx.shadowColor='#ffd54f';ctx.shadowBlur=p.mye*20;
ctx.stroke();
}

// Synaptic nodes at ends
[{x:p.x1,y:p.y1,s:1},{x:p.x2,y:p.y2,s:0.7}].forEach(n=>{
const r=2+p.str*3.5*n.s;
ctx.beginPath();ctx.arc(n.x,n.y,r,0,Math.PI*2);
const a=0.3+p.str*0.5;
ctx.fillStyle=golden?`rgba(255,213,79,${a})`:`rgba(129,212,250,${a})`;
ctx.shadowColor=golden?'#ffd54f':'#81d4fa';ctx.shadowBlur=r*3;
ctx.fill();
// Outer ring on strong nodes
if(p.str>0.6){
ctx.beginPath();ctx.arc(n.x,n.y,r+3,0,Math.PI*2);
ctx.strokeStyle=golden?`rgba(255,213,79,${a*0.3})`:`rgba(129,212,250,${a*0.3})`;
ctx.lineWidth=1;ctx.shadowBlur=0;ctx.stroke();
}
});

ctx.restore();
});
}

function drawSignals(){
const t=Date.now()*0.0015;
paths.forEach((p,i)=>{
if(!p.alive||p.str<0.3)return;
const count=p.str>0.7?3:p.str>0.5?2:1;
for(let s=0;s<count;s++){
const prog=((t+i*0.97+s*0.33)%1);
const pt=bezPt(p,prog);
const sz=1.5+p.mye*3;
const alpha=0.4+p.str*0.4;

ctx.save();ctx.beginPath();ctx.arc(pt.x,pt.y,sz,0,Math.PI*2);
if(p.mye>0.4){
ctx.fillStyle=`rgba(255,235,59,${alpha})`;ctx.shadowColor='#ffd54f';
}else if(golden){
ctx.fillStyle=`rgba(255,213,79,${alpha})`;ctx.shadowColor='#ffd54f';
}else{
ctx.fillStyle=`rgba(129,212,250,${alpha})`;ctx.shadowColor='#81d4fa';
}
ctx.shadowBlur=sz*5;ctx.fill();

// Small tail
const prog2=((t+i*0.97+s*0.33-0.04)%1);
const pt2=bezPt(p,Math.max(0,prog2));
ctx.beginPath();ctx.moveTo(pt2.x,pt2.y);ctx.lineTo(pt.x,pt.y);
ctx.strokeStyle=ctx.fillStyle;ctx.lineWidth=sz*0.7;ctx.shadowBlur=sz*2;ctx.stroke();

ctx.restore();
}
});
}

function drawPruneA(){
pruneAni=pruneAni.filter(a=>{
a.t++;const pr=a.t/a.max;if(pr>=1)return false;
ctx.save();
// Break into segments that drift apart and fade
const segs=10;
for(let i=0;i<segs;i++){
const s=i/segs,e=(i+1)/segs;
const sp=bezPtA(a,s),ep=bezPtA(a,e);
// Drift perpendicular
const dx=ep.x-sp.x,dy=ep.y-sp.y;
const nx=-dy,ny=dx;
const len=Math.sqrt(nx*nx+ny*ny)||1;
const drift=pr*20*(Math.sin(i*2.1+pr*5));
const ox=nx/len*drift,oy=ny/len*drift;

ctx.beginPath();
ctx.moveTo(sp.x+ox,sp.y+oy);ctx.lineTo(ep.x+ox,ep.y+oy);
ctx.strokeStyle=`rgba(244,67,54,${(1-pr)*0.8})`;
ctx.lineWidth=3*(1-pr);ctx.shadowColor='#f44336';ctx.shadowBlur=12*(1-pr);
ctx.setLineDash([3,3]);ctx.stroke();ctx.setLineDash([]);
}
// Emit red sparks
if(a.t%4===0){
const pt=bezPtA(a,Math.random());
sparks.push({x:pt.x,y:pt.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5-1,
life:20+Math.random()*20,ml:40,col:'#ef5350'});
}
ctx.restore();return true;
});
}
function bezPtA(a,t){const u=1-t;return{x:u*u*a.x1+2*u*t*a.mx+t*t*a.x2,y:u*u*a.y1+2*u*t*a.my+t*t*a.y2};}

function drawGrowA(){
growAni=growAni.filter(a=>{
a.t++;const pr=a.t/a.max;if(pr>=1)return false;
ctx.save();
const r=4+pr*30;
ctx.beginPath();ctx.arc(a.x,a.y,r,0,Math.PI*2);
ctx.strokeStyle=`rgba(0,230,118,${(1-pr)*0.5})`;
ctx.lineWidth=2.5*(1-pr);ctx.shadowColor='#00e676';ctx.shadowBlur=12*(1-pr);
ctx.stroke();
// Inner ring
ctx.beginPath();ctx.arc(a.x,a.y,r*0.5,0,Math.PI*2);
ctx.strokeStyle=`rgba(0,230,118,${(1-pr)*0.3})`;ctx.lineWidth=1.5*(1-pr);
ctx.stroke();
ctx.restore();return true;
});
}

function drawMyelA(){
myelAni=myelAni.filter(a=>{
a.t++;const pr=a.t/a.max;if(pr>=1||!a.p.alive)return false;
const pt=bezPt(a.p,pr);
const sz=3+a.p.mye*5;
ctx.save();
// Bright golden dot traveling along pathway
ctx.beginPath();ctx.arc(pt.x,pt.y,sz,0,Math.PI*2);
ctx.fillStyle=`rgba(255,235,59,${0.6*(1-pr*0.4)})`;
ctx.shadowColor='#ffd54f';ctx.shadowBlur=sz*4;ctx.fill();
// Trail glow
const pt2=bezPt(a.p,Math.max(0,pr-0.1));
ctx.beginPath();ctx.moveTo(pt2.x,pt2.y);ctx.lineTo(pt.x,pt.y);
ctx.strokeStyle=`rgba(255,235,59,${0.35*(1-pr)})`;
ctx.lineWidth=a.p.mye*7+3;ctx.shadowBlur=10;ctx.stroke();
ctx.restore();return true;
});
}

function drawSparksA(){
sparks=sparks.filter(s=>{
s.life--;if(s.life<=0)return false;
s.x+=s.vx;s.y+=s.vy;s.vy+=0.03;
const a=s.life/s.ml;const r=1+a*2.5;
ctx.save();ctx.globalAlpha=a;
ctx.beginPath();ctx.arc(s.x,s.y,r,0,Math.PI*2);
ctx.fillStyle=s.col;ctx.shadowColor=s.col;ctx.shadowBlur=r*4;
ctx.fill();ctx.restore();
return true;
});
}

function drawPulseA(){
pulseAni=pulseAni.filter(a=>{
a.t++;const pr=a.t/a.max;if(pr>=1)return false;
ctx.save();
const r=8+pr*40;
ctx.beginPath();ctx.arc(a.x,a.y,r,0,Math.PI*2);
ctx.strokeStyle=a.col.replace(')',`,${(1-pr)*0.4})`).replace('rgb','rgba');
// Handle hex
const alpha=(1-pr)*0.4;
ctx.strokeStyle=hexToRgba(a.col,alpha);
ctx.lineWidth=3*(1-pr);ctx.stroke();
ctx.restore();return true;
});
}

function drawRegLabels(){
ctx.save();ctx.font='bold 10px Segoe UI';ctx.textAlign='center';
REG.forEach((r,i)=>{
const p=regXY(i);
const regionPaths=paths.filter(pw=>pw.reg===i&&pw.alive);
const avgStr=regionPaths.length?regionPaths.reduce((s,pw)=>s+pw.str,0)/regionPaths.length:0;

// Region glow
const gr=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,10+avgStr*20);
gr.addColorStop(0,hexToRgba(r.col,0.12+avgStr*0.2));
gr.addColorStop(1,hexToRgba(r.col,0));
ctx.fillStyle=gr;ctx.beginPath();ctx.arc(p.x,p.y,10+avgStr*20,0,Math.PI*2);ctx.fill();

// Core
ctx.beginPath();ctx.arc(p.x,p.y,3+avgStr*4,0,Math.PI*2);
ctx.fillStyle=hexToRgba(r.col,0.4+avgStr*0.5);
ctx.shadowColor=r.col;ctx.shadowBlur=6+avgStr*12;ctx.fill();ctx.shadowBlur=0;

// Label
ctx.fillStyle='rgba(176,190,197,0.4)';ctx.fillText(r.lbl,p.x,p.y-14-avgStr*6);
});
ctx.restore();
}

// Helpers
function clamp(v){return Math.max(0,Math.min(100,v));}
function hexToRgba(hex,a){
const m=hex.match(/^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i);
if(!m)return `rgba(100,181,246,${a})`;
return `rgba(${parseInt(m[1],16)},${parseInt(m[2],16)},${parseInt(m[3],16)},${a})`;
}

function startGame(){
document.getElementById('splash').style.display='none';
document.getElementById('app').style.display='grid';
initCanvas();initPaths();updateUI();draw();
}
function copyTable(){
try{
const rows=document.querySelectorAll('#dtBody tr');
let txt='Round\tVariable Changed\tBrain Strength\tPathway Growth\tVulnerability\n';
rows.forEach(r=>{const cells=r.querySelectorAll('td');
txt+=Array.from(cells).map(c=>c.textContent.trim()).join('\t')+'\n';});
navigator.clipboard.writeText(txt).then(()=>{
const btn=document.getElementById('copyBtn');
btn.textContent='‚úÖ Copied!';btn.style.background='linear-gradient(135deg,#1b5e20,#2e7d32)';
setTimeout(()=>{btn.textContent='üìã Copy Table';btn.style.background='linear-gradient(135deg,#1565c0,#1e88e5)';},2000);
});
}catch(e){/* silent fail */}
}
function resetGame(){

S.round=0;S.bs=65;S.pg=50;S.vuln=30;S.score=0;S.bestPG=50;
S.selVar=-1;S.selVal=-1;S.activePracticeStreak=0;S.badStreak=0;S.pruneLevel=0;
S.growthSpurt=false;S.winStreak=0;S.won=false;S.gameOver=false;golden=false;
S.vars[0].c=2;S.vars[1].c=2;S.vars[2].c=1;S.vars[3].c=2;
document.getElementById('dtBody').innerHTML='';
['reqMsg','extMsg','evBan'].forEach(id=>document.getElementById(id).style.display='none');
document.getElementById('winOv').style.display='none';
document.querySelectorAll('.vb').forEach(b=>b.classList.remove('sel'));
document.getElementById('runBtn').className='run-btn no';
initPaths();updateUI();
}
window.addEventListener('resize',()=>{
if(document.getElementById('app').style.display==='grid'){
const oStr=paths.filter(p=>p.alive);
const aS=oStr.length?oStr.reduce((s,p)=>s+p.str,0)/oStr.length:0.3;
const aM=oStr.length?oStr.reduce((s,p)=>s+p.mye,0)/oStr.length:0.15;
initCanvas();initPaths();
paths.forEach(p=>{p.str=aS;p.mye=aM;});
}
});
</script>
</body>
</html>
