<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation Cell Science ‚Äî Expect the Unexpected</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#0a0e1a;color:#e0e0e0;overflow:hidden;height:100vh;width:100vw;}
#app{display:flex;flex-direction:column;height:100vh;width:100vw;}

/* TITLE BAR */
.title-bar{background:linear-gradient(135deg,#1a237e,#4a148c,#880e4f);padding:8px 20px;text-align:center;font-size:18px;font-weight:700;color:#fff;letter-spacing:1px;flex-shrink:0;text-shadow:0 2px 8px rgba(0,0,0,0.4);border-bottom:2px solid rgba(255,255,255,0.1);}

/* MAIN LAYOUT */
.main{display:flex;flex:1;overflow:hidden;}

/* LEFT SIDEBAR */
.left-sb{width:280px;min-width:280px;background:linear-gradient(180deg,#121828,#0d1220);border-right:1px solid rgba(255,255,255,0.08);display:flex;flex-direction:column;overflow-y:auto;padding:12px;}
.sb-header{font-size:14px;font-weight:700;color:#80cbc4;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;padding:4px 0;}
.scenario-count{font-size:11px;color:#78909c;margin-bottom:10px;}
.scenario-card{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:6px;border-radius:10px;cursor:pointer;transition:all 0.3s;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);}
.scenario-card:hover{background:rgba(128,203,196,0.1);border-color:rgba(128,203,196,0.3);}
.scenario-card.active{background:linear-gradient(135deg,rgba(128,203,196,0.2),rgba(77,182,172,0.15));border-color:#4db6ac;box-shadow:0 0 12px rgba(77,182,172,0.2);}
.scenario-card.completed{opacity:0.7;}
.scenario-card.completed::after{content:'‚úì';position:absolute;right:8px;color:#4caf50;font-weight:700;}
.scenario-card{position:relative;}
.sc-emoji{font-size:28px;flex-shrink:0;}
.sc-name{font-size:13px;font-weight:600;color:#cfd8dc;line-height:1.3;}
.divider{height:1px;background:rgba(255,255,255,0.08);margin:12px 0;}

/* Reading Level */
.rl-tabs{display:flex;gap:4px;margin-bottom:12px;}
.rl-tab{flex:1;padding:8px 4px;text-align:center;font-size:12px;font-weight:700;border-radius:8px;cursor:pointer;transition:all 0.3s;background:rgba(255,255,255,0.05);color:#90a4ae;border:1px solid rgba(255,255,255,0.06);}
.rl-tab.active{background:linear-gradient(135deg,#4db6ac,#26a69a);color:#fff;border-color:#4db6ac;box-shadow:0 2px 8px rgba(77,182,172,0.3);}

/* Key Words */
.kw-list{display:flex;flex-direction:column;gap:4px;}
.kw-item{font-size:12px;padding:5px 10px;border-radius:6px;background:rgba(255,255,255,0.04);color:#90a4ae;transition:all 0.3s;}
.kw-item.highlighted{background:rgba(255,235,59,0.15);color:#fff59d;border:1px solid rgba(255,235,59,0.3);}

/* Bottom buttons */
.sb-buttons{margin-top:auto;padding-top:12px;display:flex;flex-direction:column;gap:6px;}
.btn-reset{padding:10px;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.3s;}
.btn-red{background:linear-gradient(135deg,#c62828,#b71c1c);color:#fff;}
.btn-blue{background:linear-gradient(135deg,#1565c0,#0d47a1);color:#fff;}
.btn-red:hover{box-shadow:0 4px 12px rgba(198,40,40,0.4);}
.btn-blue:hover{box-shadow:0 4px 12px rgba(21,101,192,0.4);}

/* CENTER PANEL */
.center{flex:1;display:flex;flex-direction:column;overflow:hidden;background:linear-gradient(180deg,#0f1525,#0a0e1a);}

/* Step Tabs */
.step-tabs{display:flex;padding:10px 16px 0;gap:4px;flex-shrink:0;}
.step-tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:700;border-radius:10px 10px 0 0;color:#546e7a;background:rgba(255,255,255,0.03);transition:all 0.4s;letter-spacing:0.5px;}
.step-tab.active{color:#fff;background:linear-gradient(135deg,#4db6ac,#00897b);box-shadow:0 0 20px rgba(77,182,172,0.3),0 0 40px rgba(77,182,172,0.1);}
.step-tab.done{color:#4caf50;background:rgba(76,175,80,0.1);}

/* Center Content */
.center-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;overflow-y:auto;}

/* Welcome State */
.welcome{text-align:center;max-width:500px;}
.welcome h2{font-size:26px;color:#80cbc4;margin-bottom:12px;}
.welcome p{font-size:15px;color:#90a4ae;line-height:1.6;}
.welcome .emoji-big{font-size:64px;margin-bottom:16px;display:block;}

/* Predict Card */
.predict-card{background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;max-width:600px;width:100%;text-align:center;}
.predict-card h3{font-size:20px;color:#ffab40;margin-bottom:16px;}
.predict-q{font-size:16px;color:#cfd8dc;margin-bottom:20px;line-height:1.5;}
.predict-opts{display:flex;flex-direction:column;gap:10px;}
.predict-opt{padding:14px 20px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.08);color:#cfd8dc;text-align:left;}
.predict-opt:hover{background:rgba(77,182,172,0.15);border-color:#4db6ac;}
.predict-opt.selected{background:linear-gradient(135deg,rgba(77,182,172,0.25),rgba(0,137,123,0.2));border-color:#4db6ac;color:#fff;}

/* Read Card */
.read-card{background:linear-gradient(135deg,rgba(255,255,255,0.07),rgba(255,255,255,0.03));border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;max-width:650px;width:100%;}
.read-card h3{font-size:18px;color:#4dd0e1;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.passage-text{font-size:17px;line-height:1.8;color:#e0e0e0;letter-spacing:0.2px;}
.passage-text .kw{color:#fff59d;font-weight:700;}
.passage-text .highlight-sentence{background:rgba(255,235,59,0.2);border-radius:4px;padding:1px 2px;}

/* Watch Area */
.watch-area{width:100%;max-width:700px;display:flex;flex-direction:column;align-items:center;gap:16px;}
.arena-container{display:flex;align-items:center;gap:20px;width:100%;}

/* Cell Activity Meter */
.meter-wrap{display:flex;flex-direction:column;align-items:center;width:80px;flex-shrink:0;}
.meter-label{font-size:11px;font-weight:700;color:#ffab40;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;}
.meter{width:50px;height:220px;background:linear-gradient(180deg,#ff6d00 0%,#ff6d00 25%,#4caf50 25%,#4caf50 65%,#f44336 65%,#f44336 100%);border-radius:25px;position:relative;overflow:hidden;box-shadow:0 0 20px rgba(0,0,0,0.4),inset 0 0 10px rgba(0,0,0,0.3);border:2px solid rgba(255,255,255,0.1);}
.meter-zones{position:absolute;width:100%;height:100%;display:flex;flex-direction:column;}
.meter-zone{flex:1;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:rgba(255,255,255,0.7);letter-spacing:1px;}
.needle{position:absolute;width:46px;height:4px;background:#fff;border-radius:2px;left:2px;transition:top 1.5s ease-in-out;box-shadow:0 0 10px rgba(255,255,255,0.8),0 0 20px rgba(255,255,255,0.4);}

/* Cell Arena */
.cell-arena{flex:1;height:280px;background:radial-gradient(ellipse at center,#1a2744,#0d1525);border-radius:20px;border:2px solid rgba(77,182,172,0.2);position:relative;overflow:hidden;box-shadow:0 0 30px rgba(0,0,0,0.3),inset 0 0 40px rgba(0,0,0,0.2);}
.cell-arena canvas{width:100%;height:100%;}

/* Arena Label */
.arena-label{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:11px;color:rgba(255,255,255,0.5);background:rgba(0,0,0,0.4);padding:3px 12px;border-radius:10px;white-space:nowrap;}

/* Record Card */
.record-card{text-align:center;max-width:500px;}
.record-card h3{font-size:22px;color:#4caf50;margin-bottom:10px;}
.record-card p{font-size:15px;color:#90a4ae;}
.record-emoji{font-size:48px;margin-bottom:12px;display:block;}

/* Action Button */
.action-area{padding:12px 20px;flex-shrink:0;display:flex;justify-content:center;gap:12px;}
.action-btn{padding:14px 36px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.3s;color:#fff;letter-spacing:0.5px;}
.action-btn:disabled{opacity:0.4;cursor:not-allowed;}
.action-primary{background:linear-gradient(135deg,#4db6ac,#00897b);box-shadow:0 4px 15px rgba(77,182,172,0.3);}
.action-primary:hover:not(:disabled){box-shadow:0 6px 20px rgba(77,182,172,0.5);transform:translateY(-1px);}
.action-speak{background:linear-gradient(135deg,#7e57c2,#5e35b1);box-shadow:0 4px 15px rgba(126,87,194,0.3);}
.action-speak:hover{box-shadow:0 6px 20px rgba(126,87,194,0.5);transform:translateY(-1px);}

/* RIGHT SIDEBAR */
.right-sb{width:280px;min-width:280px;background:linear-gradient(180deg,#121828,#0d1220);border-left:1px solid rgba(255,255,255,0.08);display:flex;flex-direction:column;overflow-y:auto;padding:12px;}

/* HUD Stats */
.hud-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px;}
.hud-stat{background:rgba(255,255,255,0.04);border-radius:10px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.06);}
.hud-val{font-size:22px;font-weight:800;color:#fff;}
.hud-label{font-size:10px;color:#78909c;text-transform:uppercase;letter-spacing:1px;margin-top:2px;}
.hud-val.score{color:#ffab40;}
.hud-val.streak{color:#ff7043;}
.hud-val.completed{color:#4db6ac;}
.hud-val.accuracy{color:#7e57c2;}

/* Progress Bar */
.progress-wrap{margin-bottom:8px;}
.progress-bar-bg{height:12px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden;}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,#4db6ac,#26a69a);border-radius:6px;transition:width 0.5s ease;box-shadow:0 0 10px rgba(77,182,172,0.3);}
.progress-msg{font-size:12px;color:#80cbc4;text-align:center;margin-top:6px;font-weight:600;}

/* Data Table */
.dt-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.copy-btn{padding:6px 12px;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#4db6ac,#26a69a);color:#fff;transition:all 0.3s;}
.copy-btn:hover{box-shadow:0 2px 8px rgba(77,182,172,0.4);}
.data-table{width:100%;border-collapse:separate;border-spacing:0;font-size:10px;}
.data-table th{background:linear-gradient(135deg,#1a237e,#283593);color:#fff;padding:6px 4px;text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:0.5px;}
.data-table th:first-child{border-radius:6px 0 0 0;}
.data-table th:last-child{border-radius:0 6px 0 0;}
.data-table td{padding:5px 4px;border-bottom:1px solid rgba(255,255,255,0.04);color:#b0bec5;font-size:10px;vertical-align:top;}
.data-table tr:nth-child(even){background:rgba(255,255,255,0.02);}
.data-table tr.filled{color:#e0e0e0;}

/* Extra Credit Message */
.ec-msg{text-align:center;padding:8px;margin-top:8px;border-radius:10px;font-size:13px;font-weight:700;}
.ec-msg.required{background:linear-gradient(135deg,rgba(76,175,80,0.2),rgba(56,142,60,0.15));color:#81c784;border:1px solid rgba(76,175,80,0.3);}
.ec-msg.extra{background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,193,7,0.15));color:#ffd54f;border:1px solid rgba(255,215,0,0.3);}

/* Animations */
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.5;}}
@keyframes glow{0%,100%{box-shadow:0 0 10px rgba(77,182,172,0.3);}50%{box-shadow:0 0 25px rgba(77,182,172,0.6);}}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.fade-in{animation:fadeIn 0.4s ease;}

/* Completion Overlay */
.completion-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px);}
.completion-card{background:linear-gradient(135deg,#1a237e,#4a148c);border-radius:20px;padding:40px;text-align:center;max-width:400px;box-shadow:0 0 60px rgba(74,20,140,0.4);}
.completion-card h2{font-size:28px;color:#fff;margin-bottom:10px;}
.completion-card p{font-size:16px;color:#b39ddb;}
.completion-card .big-emoji{font-size:64px;display:block;margin-bottom:16px;}
.completion-card button{margin-top:20px;padding:12px 30px;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#4db6ac,#00897b);color:#fff;}
.hidden{display:none !important;}
</style>
</head>
<body>
<div id="app">
<div class="title-bar">üî¨ Mr. Jawad Simulation ‚Äî Cell Science: Expect the Unexpected üß¨</div>
<div class="main">
<!-- LEFT SIDEBAR -->
<div class="left-sb">
<div class="sb-header">Pick Any 5 You Like</div>
<div class="scenario-count" id="scenarioCount">8 scenarios ‚Äî choose any 5</div>
<div id="scenarioList"></div>
<div class="divider"></div>
<div class="sb-header">Reading Level</div>
<div class="rl-tabs" id="rlTabs">
<div class="rl-tab active" data-level="low" onclick="setLevel('low')">Low</div>
<div class="rl-tab" data-level="med" onclick="setLevel('med')">Med</div>
<div class="rl-tab" data-level="high" onclick="setLevel('high')">High</div>
</div>
<div class="divider"></div>
<div class="sb-header">Key Words</div>
<div class="kw-list" id="kwList"></div>
<div class="sb-buttons">
<button class="btn-reset btn-red" onclick="resetSim()">Reset</button>
<button class="btn-reset btn-blue" onclick="newRun()">New Run</button>
</div>
</div>

<!-- CENTER PANEL -->
<div class="center">
<div class="step-tabs" id="stepTabs">
<div class="step-tab" data-step="predict">1. PREDICT</div>
<div class="step-tab" data-step="read">2. READ</div>
<div class="step-tab" data-step="watch">3. WATCH</div>
<div class="step-tab" data-step="record">4. RECORD</div>
</div>
<div class="center-content" id="centerContent">
<div class="welcome" id="welcomeMsg">
<span class="emoji-big">üß¨</span>
<h2>Cell Science Investigator</h2>
<p>Your cells are doing wild things right now ‚Äî healing, dividing, making energy, and sometimes self-destructing. Pick a scenario from the left to investigate!</p>
</div>
</div>
<div class="action-area" id="actionArea">
<button class="action-btn action-primary hidden" id="mainAction" onclick="handleAction()">Begin</button>
<button class="action-btn action-speak hidden" id="speakBtn" onclick="handleSpeak()">üîä Read Aloud</button>
</div>
</div>

<!-- RIGHT SIDEBAR -->
<div class="right-sb">
<div class="sb-header">Progress</div>
<div class="hud-grid">
<div class="hud-stat"><div class="hud-val score" id="hudScore">0</div><div class="hud-label">Score</div></div>
<div class="hud-stat"><div class="hud-val streak" id="hudStreak">0</div><div class="hud-label">Streak</div></div>
<div class="hud-stat"><div class="hud-val completed" id="hudCompleted">0/5</div><div class="hud-label">Completed</div></div>
<div class="hud-stat"><div class="hud-val accuracy" id="hudAccuracy">0%</div><div class="hud-label">Accuracy</div></div>
</div>
<div class="progress-wrap">
<div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
<div class="progress-msg" id="progressMsg">Pick 5 scenarios you like!</div>
</div>
<div id="ecMsg"></div>
<div class="divider"></div>
<div class="dt-header">
<div class="sb-header" style="margin:0">Data Table</div>
<button class="copy-btn" id="copyBtn" onclick="copyTable()">üìã Copy Table</button>
</div>
<div style="overflow-x:auto;">
<table class="data-table" id="dataTable">
<thead>
<tr><th>Scenario</th><th>What Changed?</th><th>System Response</th><th>Back to OK?</th></tr>
</thead>
<tbody id="dataBody"></tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Completion Overlay -->
<div class="completion-overlay hidden" id="completionOverlay">
<div class="completion-card" id="completionCard"></div>
</div>

<script>
// ===== DATA =====
const SCENARIOS = [
{id:1,name:"Why Sunburns Peel",emoji:"‚òÄÔ∏è",whatChanges:"UV light damaged skin cell DNA",
readings:{
low:{text:'UV light from the sun smashes into your skin cells and wrecks their <kw>DNA</kw>. The damage is so bad the cells cannot fix themselves. Your body triggers <kw>cell division</kw> to replace them ‚Äî but first, it destroys the wrecked cells. The dead cells peel off, and new ones take their place.',kwUsed:['DNA','cell division']},
med:{text:'UV light from the sun slams into your skin cells like invisible bullets. It smashes the <kw>DNA</kw> inside the <kw>nucleus</kw> ‚Äî the instructions that tell the cell how to work. When the damage is too severe, the cell cannot repair itself. Your body sends a self-destruct signal, killing the damaged cells before they can cause problems. Then <kw>cell division</kw> kicks in ‚Äî healthy cells nearby start splitting through <kw>mitosis</kw> to build replacements. The peeling skin you see is your body dumping the dead cells while fresh ones grow underneath.',kwUsed:['DNA','nucleus','cell division','mitosis']},
high:{text:'UV light from the sun slams into your skin cells and shreds their <kw>DNA</kw> ‚Äî the master instructions stored inside the <kw>nucleus</kw>. Every cell needs intact <kw>DNA</kw> to divide correctly. When UV destroys too much of it, the cell has a choice: try to repair, or shut down. If the damage is beyond repair, your body triggers a self-destruct program ‚Äî the cell dies on purpose. This is actually protection. A cell with broken <kw>DNA</kw> that keeps dividing could become cancer. So your body chooses controlled destruction. Then <kw>cell division</kw> takes over ‚Äî healthy cells nearby go through <kw>mitosis</kw>, splitting into identical copies to patch the gap. The peeling skin is dead cells falling away while a fresh layer grows beneath.',kwUsed:['DNA','nucleus','cell division','mitosis']}
},
response:"Cell division replaced damaged cells",backOk:"Yes ‚Äî new cells replaced old ones",
predictSetup:"UV light from the sun damages the DNA inside skin cells beyond repair.",
correctPredict:"A",meterDir:"high",meterReturn:true,
arenaType:"skinUV"},

{id:2,name:"Plant Grows Toward Light",emoji:"üå±",whatChanges:"Plant only gets sunlight from one side",
readings:{
low:{text:'A plant on a windowsill bends toward the sun because its <kw>chloroplasts</kw> need light to make food. Cells on the shaded side grow longer, pushing the stem toward the light. Without sunlight, the <kw>chloroplasts</kw> cannot produce <kw>energy</kw>. The plant literally reshapes itself to feed its own cells.',kwUsed:['chloroplast','energy']},
med:{text:'A plant sits on a windowsill with sunlight streaming in from one side. The <kw>chloroplasts</kw> inside its cells are like tiny solar panels ‚Äî they capture light and turn it into food. On the shaded side, the <kw>chloroplasts</kw> get almost no light, so those cells produce very little <kw>energy</kw>. The plant responds by making the shaded cells grow longer, which pushes the whole stem toward the window. Now more <kw>chloroplasts</kw> face the sun and can do their job. Block all the light, and the plant slowly starves ‚Äî even with plenty of water and soil.',kwUsed:['chloroplast','energy']},
high:{text:'A plant sits on a windowsill getting sunlight from only one direction. Inside every leaf cell, tiny <kw>chloroplasts</kw> capture that light and use it to build food ‚Äî a process powered by a green pigment called chlorophyll. The cells on the sunny side get plenty of light, so their <kw>chloroplasts</kw> run at full power. The cells on the shaded side get almost nothing. The plant detects this imbalance. It makes the shaded cells grow longer than the sunny cells, which bends the entire stem toward the light. This is not random ‚Äî it is a targeted response to keep the <kw>chloroplasts</kw> fed. If you block all light completely, the <kw>chloroplasts</kw> shut down and the plant starves, even with water and healthy soil, because light is the <kw>energy</kw> source that drives everything.',kwUsed:['chloroplast','energy']}
},
response:"Chloroplasts redirected toward light",backOk:"Yes ‚Äî plant bent toward sunlight",
predictSetup:"A plant sitting on a windowsill only gets sunlight from one direction.",
correctPredict:"B",meterDir:"low",meterReturn:true,
arenaType:"plantLight"},

{id:3,name:"Why Cuts Heal",emoji:"ü©π",whatChanges:"Deep cut destroyed skin cells",
readings:{
low:{text:'A knife slices through your skin and destroys thousands of cells in an instant. Your body responds by cranking up <kw>cell division</kw> ‚Äî skin cells around the wound start splitting fast to close the gap. The replacement cells are built for speed, not perfection. That is why a scar looks different from normal skin ‚Äî the new tissue has a rougher structure.',kwUsed:['cell division']},
med:{text:'A deep cut rips through layers of skin cells, leaving a gap your body needs to close fast. The <kw>nucleus</kw> in each nearby cell holds the <kw>DNA</kw> instructions for building new skin. Your body floods the area with signals that trigger <kw>cell division</kw> ‚Äî healthy cells start splitting through <kw>mitosis</kw> at high speed. The rush job works, but the replacement tissue is not identical to the original. The new cells stack in a simpler pattern, creating a scar. Deep cuts scar more because more layers need replacing, and the faster the build, the rougher the result.',kwUsed:['nucleus','DNA','cell division','mitosis']},
high:{text:'A deep cut destroys thousands of skin cells in a split second. Your body treats this like an emergency. Chemical signals flood the wound site, telling nearby cells to start dividing immediately. The <kw>nucleus</kw> in each healthy cell carries the <kw>DNA</kw> blueprint for skin. <kw>Cell division</kw> through <kw>mitosis</kw> kicks into overdrive ‚Äî one cell splits into two identical copies, then those split again. The speed is impressive, but it comes with a tradeoff. The replacement tissue stacks in a simpler, rougher pattern than the original skin. That rougher patch is a scar ‚Äî your body chose speed over perfection to close the gap before infection sets in. The deeper the cut, the more layers of <kw>cell division</kw> required, and the more visible the scar becomes.',kwUsed:['nucleus','DNA','cell division','mitosis']}
},
response:"Cell division closed the wound",backOk:"Yes ‚Äî new cells filled the gap",
predictSetup:"A deep cut slices through layers of skin cells.",
correctPredict:"A",meterDir:"low",meterReturn:true,
arenaType:"cutHeal"},

{id:4,name:"Athletes at Altitude",emoji:"üèîÔ∏è",whatChanges:"Less oxygen at high altitude",
readings:{
low:{text:'An athlete moves to a mountain training camp where the air has less oxygen. The <kw>mitochondria</kw> inside muscle cells need oxygen to release <kw>energy</kw> from food. With less oxygen arriving, the <kw>mitochondria</kw> cannot keep up. The body responds by making more red blood cells to carry extra oxygen to the muscles.',kwUsed:['mitochondria','energy']},
med:{text:'Olympic athletes train in the mountains on purpose. At high altitude, every breath pulls in less oxygen than at sea level. The <kw>mitochondria</kw> inside their muscle cells need oxygen to release <kw>energy</kw> from food ‚Äî less oxygen means less fuel for training. The body detects the shortage and responds by producing more red blood cells. More red blood cells carry more oxygen to the <kw>mitochondria</kw>, restoring <kw>energy</kw> production. When the athletes return to sea level, those extra red blood cells give them a performance edge ‚Äî their muscles get more oxygen than a competitor who trained at low altitude.',kwUsed:['mitochondria','energy']},
high:{text:'Olympic teams train at high altitude for a reason that starts inside their cells. At 8,000 feet, every breath contains less oxygen than at sea level. The <kw>mitochondria</kw> inside muscle cells depend on oxygen to release <kw>energy</kw> from food ‚Äî they are the power plants that keep muscles firing. With less oxygen reaching them, the <kw>mitochondria</kw> produce less <kw>energy</kw>, and performance drops. The body detects the shortage and begins producing more red blood cells to carry oxygen. More red blood cells mean more oxygen delivery to the <kw>mitochondria</kw>. Over weeks, the athlete\'s body adapts ‚Äî <kw>energy</kw> production climbs back to normal and beyond. When they return to sea level, those extra red blood cells deliver more oxygen than their competitors\' bodies can match.',kwUsed:['mitochondria','energy']}
},
response:"More red blood cells fed mitochondria",backOk:"Yes ‚Äî extra oxygen restored energy",
predictSetup:"An athlete trains at high altitude where there is less oxygen in the air.",
correctPredict:"B",meterDir:"low",meterReturn:true,
arenaType:"altitude"},

{id:5,name:"Why Leaves Change Color",emoji:"üçÇ",whatChanges:"Tree stops sending water to leaves",
readings:{
low:{text:'Green leaves are green because of <kw>chloroplasts</kw> packed with a green pigment called chlorophyll. In autumn, the tree stops sending water to its leaves. The <kw>chloroplasts</kw> break down and the green fades away. Yellow and orange pigments that were hidden underneath finally show through.',kwUsed:['chloroplast']},
med:{text:'All summer, the <kw>chloroplasts</kw> in leaf cells work nonstop ‚Äî capturing sunlight and turning it into food for the tree. The green you see comes from chlorophyll, a pigment packed inside every <kw>chloroplast</kw>. When autumn arrives, shorter days and cooler temperatures signal the tree to shut down its leaves. The tree stops sending water, and the <kw>chloroplasts</kw> start breaking apart. As the green chlorophyll disappears, yellow and orange pigments that were always there ‚Äî hidden under the green ‚Äî finally become visible. The tree is shutting down its solar panels for winter to save <kw>energy</kw>.',kwUsed:['chloroplast','energy']},
high:{text:'All summer long, <kw>chloroplasts</kw> inside leaf cells capture sunlight and convert it into food for the tree. The green color comes from chlorophyll, a light-absorbing pigment packed inside every <kw>chloroplast</kw>. But chlorophyll is not the only pigment in the leaf ‚Äî yellow and orange pigments called carotenoids sit underneath, hidden by the dominant green. When autumn arrives, shorter days signal the tree to prepare for winter. The tree stops sending water and nutrients to the leaves. Without water, the <kw>chloroplasts</kw> cannot function, and the chlorophyll molecules start breaking apart. As the green disappears, the yellow and orange pigments finally show through ‚Äî they were there all along. The tree is shutting down its <kw>energy</kw> factories on purpose, sacrificing leaves to survive the cold months ahead.',kwUsed:['chloroplast','energy']}
},
response:"Chloroplasts shut down, colors revealed",backOk:"No ‚Äî shutdown is permanent",
predictSetup:"Temperatures drop in autumn and the tree stops sending water to its leaves.",
correctPredict:"C",meterDir:"low",meterReturn:false,
arenaType:"leafColor"},

{id:6,name:"Broken Bones Heal Stronger",emoji:"ü¶¥",whatChanges:"Bone fractures from impact",
readings:{
low:{text:'A bone snaps and your body floods the break with special bone-building cells. These cells divide rapidly through <kw>mitosis</kw> to fill the fracture with new bone tissue. The new bone is actually denser than the original ‚Äî your body overbuilds the repair. The <kw>nucleus</kw> in each bone cell carries the instructions for exactly what to construct.',kwUsed:['mitosis','nucleus']},
med:{text:'When a bone breaks, your body treats the fracture site like a construction zone. Special bone-building cells flood the area and start dividing fast through <kw>mitosis</kw>. The <kw>nucleus</kw> in each cell carries the <kw>DNA</kw> blueprint for bone tissue ‚Äî the instructions for what to build and where. The new bone that fills the gap is actually denser and thicker than the original. Your body overbuilds on purpose, reinforcing the weak spot so it will not break there again. This is <kw>cell division</kw> responding to damage ‚Äî and the <kw>mitochondria</kw> inside each bone cell supply the <kw>energy</kw> to power the entire rebuild.',kwUsed:['mitosis','nucleus','DNA','cell division','mitochondria','energy']},
high:{text:'When a bone fractures, your body launches a massive repair operation at the cellular level. Chemical signals rush to the break, telling nearby bone cells to start dividing immediately. These bone-building cells go through <kw>mitosis</kw> ‚Äî each cell copies its chromosomes and splits into two identical cells. The <kw>nucleus</kw> in every cell holds the <kw>DNA</kw> instructions for building bone tissue. The <kw>mitochondria</kw> power the entire process, releasing <kw>energy</kw> from food to fuel thousands of divisions. Over weeks, the new bone fills the fracture gap ‚Äî and it is actually denser than the original. Your body deliberately overbuilds the repair site, reinforcing the weak spot so it is less likely to break there again. This is <kw>cell division</kw> working as an emergency construction crew ‚Äî fast, precise, and designed to make you stronger than before.',kwUsed:['mitosis','nucleus','DNA','mitochondria','energy','cell division']}
},
response:"Mitosis built denser bone at break",backOk:"Yes ‚Äî stronger than original",
predictSetup:"A bone fractures and the body detects the break.",
correctPredict:"A",meterDir:"low",meterReturn:true,
arenaType:"boneHeal"},

{id:7,name:"Lizards Regrow Tails",emoji:"ü¶é",whatChanges:"Lizard lost its tail to escape",
readings:{
low:{text:'A lizard drops its tail to escape a predator. Cells near the wound start <kw>cell division</kw> at incredible speed, building new muscle, bone, and skin. The <kw>nucleus</kw> in each cell carries the instructions for what to build. Human cells can heal wounds, but they cannot regrow entire body parts ‚Äî scientists study lizards to find out why.',kwUsed:['cell division','nucleus']},
med:{text:'A lizard escapes a predator by snapping off its own tail ‚Äî and then grows it back. Special cells near the wound immediately begin rapid <kw>cell division</kw>, building new muscle, bone, and skin from scratch. The <kw>nucleus</kw> in each cell carries the <kw>DNA</kw> instructions for the entire tail blueprint. Through <kw>mitosis</kw>, one cell becomes two, two become four, and the tail rebuilds piece by piece. Human cells can heal cuts and broken bones, but they cannot regrow a whole limb. Scientists study lizard <kw>cell division</kw> because the basic cell machinery ‚Äî <kw>nucleus</kw>, <kw>DNA</kw>, <kw>mitochondria</kw> ‚Äî is surprisingly similar to ours.',kwUsed:['cell division','nucleus','DNA','mitosis','mitochondria']},
high:{text:'A lizard escapes a hawk by snapping off its own tail ‚Äî a survival move that seems extreme until you watch what happens next. Cells near the wound site activate immediately and begin rapid <kw>cell division</kw>. Through <kw>mitosis</kw>, each cell copies its chromosomes and splits into an identical pair. The <kw>nucleus</kw> in every new cell carries the complete <kw>DNA</kw> blueprint for muscle, bone, nerve, and skin. The <kw>mitochondria</kw> supply the <kw>energy</kw> to power thousands of cell divisions over weeks. Layer by layer, the tail rebuilds ‚Äî bone in the center, muscle around it, skin on the outside. Human cells use the same basic machinery ‚Äî <kw>nucleus</kw>, <kw>DNA</kw>, <kw>mitochondria</kw> ‚Äî but cannot regrow lost limbs. Scientists are studying lizard cells to understand what signal tells them to rebuild an entire structure instead of just closing a wound.',kwUsed:['cell division','mitosis','nucleus','DNA','mitochondria','energy']}
},
response:"Rapid cell division regrew the tail",backOk:"Yes ‚Äî full tail regenerated",
predictSetup:"A lizard loses its tail to escape a predator.",
correctPredict:"A",meterDir:"high",meterReturn:true,
arenaType:"lizardTail"},

{id:8,name:"The Oldest Living Thing",emoji:"üå≤",whatChanges:"200-year drought hit ancient tree",
readings:{
low:{text:'A bristlecone pine tree in California is nearly 5,000 years old ‚Äî and a brutal drought just cut off its water supply for years. The tree slows <kw>cell division</kw> to a crawl to save <kw>energy</kw>. Thick cell walls protect the cells that remain, but entire branches die and never grow back. The tree survives, but it is permanently smaller ‚Äî some damage cannot be undone.',kwUsed:['cell division','energy']},
med:{text:'A bristlecone pine in the California mountains is nearly 5,000 years old ‚Äî it was alive before the pyramids existed. Now a 200-year drought is starving it of water. The tree responds by slowing <kw>cell division</kw> through <kw>mitosis</kw> to an absolute crawl ‚Äî adding barely a paper-thin ring of new cells per year. Thick cell walls protect the surviving cells from drying out completely. But the outer branches cannot get enough water. Entire limbs die and never regrow ‚Äî the tree survives the drought, but it loses parts of itself permanently.',kwUsed:['cell division','mitosis']},
high:{text:'A bristlecone pine in California\'s White Mountains is nearly 5,000 years old ‚Äî it was alive before the Egyptian pyramids existed. Now a brutal drought that lasts over 200 years is testing its limits. The tree responds by slowing <kw>cell division</kw> through <kw>mitosis</kw> to an absolute minimum ‚Äî adding barely one paper-thin ring of new cells per year. Slow <kw>mitosis</kw> means the <kw>nucleus</kw> has time to copy <kw>DNA</kw> accurately, avoiding dangerous errors even under stress. Thick cell walls protect the core cells from drying out completely. But the tree cannot save everything. Outer branches starve for water, and entire limbs die permanently ‚Äî the tree sacrifices parts of itself to keep the core alive. The bristlecone survives the drought, but it never fully recovers ‚Äî some damage is permanent, even for the oldest living thing on Earth.',kwUsed:['cell division','mitosis','nucleus','DNA']}
},
response:"Slowed division, sacrificed branches",backOk:"Partial ‚Äî core survived, branches lost",
predictSetup:"A brutal 200-year drought hits a bristlecone pine tree that is already nearly 5,000 years old.",
correctPredict:"C",meterDir:"low",meterReturn:false,
arenaType:"oldTree"}
];

const KEY_WORDS = ['mitochondria','cell division','mitosis','chloroplast','DNA','nucleus','energy'];
const PREDICT_OPTIONS = [
{label:"A) Cells will speed up division",value:"A"},
{label:"B) Cells will activate an organelle",value:"B"},
{label:"C) Cells will shut down",value:"C"}
];

// ===== STATE =====
let state = {
level:'low',
currentScenario:null,
step:null, // null, 'predict','read','watch','record'
prediction:null,
completedIds:[],
score:0,
streak:0,
correctCount:0,
totalPredictions:0,
dataRows:[],
speaking:false,
speechInit:false,
animTimeout:null
};

// ===== INIT =====
function init(){
renderScenarios();
renderKeyWords();
updateHUD();
}

function renderScenarios(){
const el=document.getElementById('scenarioList');
el.innerHTML='';
SCENARIOS.forEach(s=>{
const card=document.createElement('div');
card.className='scenario-card'+(state.completedIds.includes(s.id)?' completed':'')+(state.currentScenario&&state.currentScenario.id===s.id?' active':'');
card.innerHTML=`<span class="sc-emoji">${s.emoji}</span><span class="sc-name">${s.name}</span>`;
card.onclick=()=>selectScenario(s);
el.appendChild(card);
});
}

function renderKeyWords(usedKws=[]){
const el=document.getElementById('kwList');
el.innerHTML='';
KEY_WORDS.forEach(kw=>{
const d=document.createElement('div');
d.className='kw-item'+(usedKws.map(k=>k.toLowerCase()).includes(kw.toLowerCase())?' highlighted':'');
d.textContent=kw.charAt(0).toUpperCase()+kw.slice(1);
el.appendChild(d);
});
}

// ===== SCENARIO SELECTION =====
function selectScenario(s){
if(state.step==='watch')return;
if(state.speaking)stopSpeech();
clearTimeout(state.animTimeout);
state.currentScenario=s;
state.step='predict';
state.prediction=null;
renderScenarios();
renderKeyWords();
setStepTab('predict');
document.getElementById('speakBtn').classList.add('hidden');
showPredict();
}

// ===== READING LEVEL =====
function setLevel(lv){
state.level=lv;
document.querySelectorAll('.rl-tab').forEach(t=>t.classList.toggle('active',t.dataset.level===lv));
if(state.step==='read')showRead();
}

// ===== STEP TABS =====
function setStepTab(active){
document.querySelectorAll('.step-tab').forEach(t=>{
const s=t.dataset.step;
if(s===active)t.className='step-tab active';
else if(getStepOrder(s)<getStepOrder(active))t.className='step-tab done';
else t.className='step-tab';
});
}
function getStepOrder(s){return{predict:0,read:1,watch:2,record:3}[s]||0;}

// ===== PREDICT =====
function showPredict(){
const s=state.currentScenario;
const cc=document.getElementById('centerContent');
cc.innerHTML=`<div class="predict-card fade-in">
<h3>üîÆ Predict</h3>
<p class="predict-q">${s.predictSetup}</p>
<p style="font-size:14px;color:#78909c;margin-bottom:12px;">What do you think the cells will do?</p>
<div class="predict-opts" id="predictOpts">
${PREDICT_OPTIONS.map(o=>`<div class="predict-opt" data-val="${o.value}" onclick="pickPredict('${o.value}')">${o.label}</div>`).join('')}
</div>
</div>`;
const btn=document.getElementById('mainAction');
btn.textContent='Lock Prediction ‚Üí';
btn.classList.remove('hidden');
btn.disabled=true;
document.getElementById('speakBtn').classList.add('hidden');
}

function pickPredict(val){
state.prediction=val;
document.querySelectorAll('.predict-opt').forEach(o=>o.classList.toggle('selected',o.dataset.val===val));
document.getElementById('mainAction').disabled=false;
}

// ===== READ =====
function showRead(){
const s=state.currentScenario;
const reading=s.readings[state.level];
const html=reading.text.replace(/<kw>/g,'<span class="kw">').replace(/<\/kw>/g,'</span>');
renderKeyWords(reading.kwUsed);
const cc=document.getElementById('centerContent');
cc.innerHTML=`<div class="read-card fade-in">
<h3>üìñ Read ‚Äî ${s.name}</h3>
<div class="passage-text" id="passageText">${html}</div>
</div>`;
const btn=document.getElementById('mainAction');
btn.textContent='Done Reading ‚Üí Watch';
btn.classList.remove('hidden');
btn.disabled=false;
const spk=document.getElementById('speakBtn');
spk.classList.remove('hidden');
}

// ===== WATCH =====
function showWatch(){
if(state.speaking)stopSpeech();
document.getElementById('speakBtn').classList.add('hidden');
const btn=document.getElementById('mainAction');
btn.classList.add('hidden');
const s=state.currentScenario;
const cc=document.getElementById('centerContent');
cc.innerHTML=`<div class="watch-area fade-in">
<div class="arena-container">
<div class="meter-wrap">
<div class="meter-label">Cell Activity</div>
<div class="meter">
<div class="meter-zones">
<div class="meter-zone">HIGH</div>
<div class="meter-zone">OK</div>
<div class="meter-zone">LOW</div>
</div>
<div class="needle" id="meterNeedle" style="top:108px;"></div>
</div>
</div>
<div class="cell-arena" id="cellArena">
<canvas id="arenaCanvas"></canvas>
<div class="arena-label" id="arenaLabel">${s.name}</div>
</div>
</div>
</div>`;
try{runAnimation(s);}catch(e){console.error('Animation error:',e);finishWatch();}
state.animTimeout=setTimeout(()=>finishWatch(),8000);
}

function finishWatch(){
clearTimeout(state.animTimeout);
state.step='record';
setStepTab('record');
recordData();
showRecord();
}

// ===== ANIMATION ENGINE =====
function runAnimation(s){
const canvas=document.getElementById('arenaCanvas');
if(!canvas)return;
const rect=canvas.parentElement.getBoundingClientRect();
canvas.width=rect.width;
canvas.height=rect.height;
const ctx=canvas.getContext('2d');
const W=canvas.width,H=canvas.height;
const needle=document.getElementById('meterNeedle');

// Meter positions: HIGH=30, OK=108, LOW=186
const meterOK=108,meterHIGH=30,meterLOW=186,meterPartial=150;

let startTime=null;
const duration=5000;

function animate(timestamp){
if(!startTime)startTime=timestamp;
const elapsed=timestamp-startTime;
const progress=Math.min(elapsed/duration,1);
ctx.clearRect(0,0,W,H);

// Draw based on arena type
switch(s.arenaType){
case 'skinUV': drawSkinUV(ctx,W,H,progress); break;
case 'plantLight': drawPlantLight(ctx,W,H,progress); break;
case 'cutHeal': drawCutHeal(ctx,W,H,progress); break;
case 'altitude': drawAltitude(ctx,W,H,progress); break;
case 'leafColor': drawLeafColor(ctx,W,H,progress); break;
case 'boneHeal': drawBoneHeal(ctx,W,H,progress); break;
case 'lizardTail': drawLizardTail(ctx,W,H,progress); break;
case 'oldTree': drawOldTree(ctx,W,H,progress); break;
}

// Meter animation
if(progress<0.3){
const meterTarget=s.meterDir==='high'?meterHIGH:meterLOW;
needle.style.top=meterOK+(meterTarget-meterOK)*(progress/0.3)+'px';
}else if(progress>=0.3){
const meterTarget=s.meterDir==='high'?meterHIGH:meterLOW;
const returnTarget=s.meterReturn?meterOK:(s.arenaType==='oldTree'?meterPartial:meterLOW);
const returnProgress=Math.min((progress-0.3)/0.7,1);
needle.style.top=meterTarget+(returnTarget-meterTarget)*returnProgress+'px';
}

if(progress<1)requestAnimationFrame(animate);
else{
// Update arena label
const label=document.getElementById('arenaLabel');
if(label){
if(s.meterReturn)label.textContent='‚úì Response Complete';
else if(s.arenaType==='leafColor')label.textContent='Shutdown ‚Äî permanent';
else label.textContent='Survived ‚Äî partial damage';
label.style.color='#fff';label.style.background='rgba(0,0,0,0.6)';
}
setTimeout(()=>finishWatch(),1500);
}
}
requestAnimationFrame(animate);
}

// ===== ARENA DRAWING FUNCTIONS =====
function drawCell(ctx,cx,cy,r,color,glow,label,labelY){
ctx.save();
if(glow){ctx.shadowColor=color;ctx.shadowBlur=20;}
ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);
const g=ctx.createRadialGradient(cx,cy,r*0.2,cx,cy,r);
g.addColorStop(0,lighten(color,40));g.addColorStop(1,color);
ctx.fillStyle=g;ctx.fill();
ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=2;ctx.stroke();
ctx.restore();
if(label){ctx.fillStyle='rgba(255,255,255,0.8)';ctx.font='bold 11px sans-serif';ctx.textAlign='center';ctx.fillText(label,cx,labelY||cy+r+14);}
}
function drawNucleus(ctx,cx,cy,r,glowing){
ctx.save();
if(glowing){ctx.shadowColor='#ff5252';ctx.shadowBlur=15;}
ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);
ctx.fillStyle=glowing?'#ef5350':'#5c6bc0';ctx.fill();
ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=1.5;ctx.stroke();
ctx.restore();
ctx.fillStyle='rgba(255,255,255,0.7)';ctx.font='bold 9px sans-serif';ctx.textAlign='center';ctx.fillText('Nucleus',cx,cy+r+10);
}
function drawMitochondria(ctx,x,y,w,h,glow){
ctx.save();
if(glow){ctx.shadowColor='#ff9800';ctx.shadowBlur=12;}
ctx.beginPath();
ctx.ellipse(x,y,w,h,0,0,Math.PI*2);
const g=ctx.createLinearGradient(x-w,y,x+w,y);
g.addColorStop(0,glow?'#ffb74d':'#6d4c41');g.addColorStop(1,glow?'#ff9800':'#5d4037');
ctx.fillStyle=g;ctx.fill();
ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1;ctx.stroke();
// Inner folds
for(let i=-2;i<=2;i++){
ctx.beginPath();ctx.moveTo(x+i*w*0.3,y-h*0.6);ctx.lineTo(x+i*w*0.3,y+h*0.6);
ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.stroke();
}
ctx.restore();
}
function drawChloroplast(ctx,x,y,w,h,active){
ctx.save();
if(active){ctx.shadowColor='#4caf50';ctx.shadowBlur=15;}
ctx.beginPath();ctx.ellipse(x,y,w,h,0,0,Math.PI*2);
ctx.fillStyle=active?'#66bb6a':'#616161';ctx.fill();
ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1;ctx.stroke();
// Internal thylakoids
for(let i=-1;i<=1;i++){
ctx.beginPath();ctx.ellipse(x,y+i*h*0.3,w*0.6,h*0.15,0,0,Math.PI*2);
ctx.strokeStyle=active?'rgba(255,255,255,0.3)':'rgba(255,255,255,0.1)';ctx.stroke();
}
ctx.restore();
}
function drawParticles(ctx,particles,t){
particles.forEach(p=>{
const age=(t-p.born)%p.life/p.life;
if(age<0||age>1)return;
ctx.save();ctx.globalAlpha=1-age;
ctx.beginPath();ctx.arc(p.x+Math.sin(age*Math.PI*2+p.phase)*p.drift,p.y-age*p.rise,p.size*(1-age*0.5),0,Math.PI*2);
ctx.fillStyle=p.color;ctx.fill();ctx.restore();
});
}
function lighten(hex,amt){return hex;}
function lerpColor(a,b,t){
const ah=parseInt(a.replace('#',''),16),bh=parseInt(b.replace('#',''),16);
const ar=(ah>>16)&0xff,ag=(ah>>8)&0xff,ab=ah&0xff;
const br=(bh>>16)&0xff,bg=(bh>>8)&0xff,bb=bh&0xff;
const rr=Math.round(ar+(br-ar)*t),rg=Math.round(ag+(bg-ag)*t),rb=Math.round(ab+(bb-ab)*t);
return `rgb(${rr},${rg},${rb})`;
}

// SCENARIO ARENA DRAWINGS
function drawSkinUV(ctx,W,H,p){
// Background: skin layers
const skinTop=H*0.25, skinBot=H*0.85;
// Epidermis
ctx.fillStyle='#ffccbc';ctx.fillRect(0,skinTop,W,skinBot-skinTop);
// UV rays (phase 1)
if(p<0.35){
const rayAlpha=1-p/0.35;
ctx.save();ctx.globalAlpha=rayAlpha;
for(let i=0;i<5;i++){
const rx=W*0.15+i*W*0.17;
ctx.strokeStyle='#ffd54f';ctx.lineWidth=3;ctx.setLineDash([8,6]);
ctx.beginPath();ctx.moveTo(rx,0);ctx.lineTo(rx,skinTop+30);ctx.stroke();
ctx.fillStyle='#fff59d';ctx.beginPath();ctx.arc(rx,skinTop+30,4,0,Math.PI*2);ctx.fill();
}
ctx.setLineDash([]);ctx.restore();
}
// Draw cells in a grid
const cols=6,rows=3;
const cellW=W/(cols+1),cellH=(skinBot-skinTop)/(rows+1);
for(let r=0;r<rows;r++){
for(let c=0;c<cols;c++){
const cx=cellW*(c+0.8),cy=skinTop+cellH*(r+0.7);
const cellRadius=Math.min(cellW,cellH)*0.35;
const isDamaged=(r===0)&&(c>=1&&c<=3);
if(isDamaged&&p>0.15&&p<0.55){
// Damaged cell grays out and peels
const dmgP=Math.min((p-0.15)/0.3,1);
ctx.save();ctx.globalAlpha=1-dmgP;
drawCell(ctx,cx,cy-dmgP*20,cellRadius*(1-dmgP*0.3),'#9e9e9e',false);
ctx.restore();
}else if(isDamaged&&p>=0.55){
// New cell divides in
const newP=Math.min((p-0.55)/0.4,1);
ctx.save();ctx.globalAlpha=newP;
drawCell(ctx,cx,cy,cellRadius,'#66bb6a',true);
ctx.restore();
}else{
drawCell(ctx,cx,cy,cellRadius,'#ef9a9a',false);
}
// Nucleus in each cell
if(!(isDamaged&&p>0.15&&p<0.55)){
const nucGlow=isDamaged&&p<0.2;
drawNucleus(ctx,cx,cy,cellRadius*0.3,nucGlow);
}
}
}
// Labels
ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font='bold 13px sans-serif';ctx.textAlign='center';
if(p<0.3)ctx.fillText('UV Damage',W/2,20);
else if(p<0.6)ctx.fillText('Cell Destruction',W/2,20);
else ctx.fillText('Cell Division ‚Äî New Cells',W/2,20);
// DNA label
ctx.font='bold 10px sans-serif';ctx.fillStyle='#ffcdd2';
if(p<0.3)ctx.fillText('DNA breaking',W*0.35,skinTop-5);
}

function drawPlantLight(ctx,W,H,p){
// Sun on right
const sunX=W*0.85,sunY=H*0.15;
ctx.save();ctx.shadowColor='#ffd54f';ctx.shadowBlur=30;
ctx.beginPath();ctx.arc(sunX,sunY,25,0,Math.PI*2);ctx.fillStyle='#ffd54f';ctx.fill();
ctx.restore();
// Sun rays
for(let i=0;i<8;i++){
const angle=i*Math.PI/4+p*0.5;
ctx.beginPath();ctx.moveTo(sunX+Math.cos(angle)*30,sunY+Math.sin(angle)*30);
ctx.lineTo(sunX+Math.cos(angle)*50,sunY+Math.sin(angle)*50);
ctx.strokeStyle='rgba(255,213,79,0.4)';ctx.lineWidth=2;ctx.stroke();
}
// Pot
ctx.fillStyle='#8d6e63';
ctx.fillRect(W*0.3,H*0.75,W*0.2,H*0.15);
ctx.fillStyle='#6d4c41';ctx.fillRect(W*0.27,H*0.73,W*0.26,H*0.04);
// Stem bends toward light
const bendAmount=p*0.3;
const stemBase={x:W*0.4,y:H*0.75};
const stemMid={x:W*0.4+bendAmount*W*0.15,y:H*0.5};
const stemTop={x:W*0.4+bendAmount*W*0.25,y:H*0.3};
ctx.beginPath();ctx.moveTo(stemBase.x,stemBase.y);
ctx.quadraticCurveTo(stemMid.x,stemMid.y,stemTop.x,stemTop.y);
ctx.strokeStyle='#66bb6a';ctx.lineWidth=6;ctx.stroke();
// Leaves
const leafPositions=[{t:0.3,side:1},{t:0.5,side:-1},{t:0.7,side:1}];
leafPositions.forEach(lp=>{
const lx=stemBase.x+(stemTop.x-stemBase.x)*lp.t+bendAmount*W*0.05*lp.t;
const ly=stemBase.y+(stemTop.y-stemBase.y)*lp.t;
const sunFacing=lp.side===1;
const leafActive=sunFacing||p>0.5;
ctx.save();
ctx.translate(lx,ly);ctx.rotate(lp.side*0.4-bendAmount*0.3);
ctx.beginPath();ctx.ellipse(lp.side*20,0,22,8,0,0,Math.PI*2);
ctx.fillStyle=leafActive?'#66bb6a':'#9e9e9e';ctx.fill();
// Chloroplast dots
if(leafActive){
ctx.shadowColor='#4caf50';ctx.shadowBlur=5;
for(let d=0;d<3;d++){
ctx.beginPath();ctx.arc(lp.side*(12+d*6),0,3,0,Math.PI*2);
ctx.fillStyle='#2e7d32';ctx.fill();
}
}
ctx.restore();
});
// Labels
ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font='bold 12px sans-serif';ctx.textAlign='center';
if(p<0.4)ctx.fillText('Chloroplasts need light',W/2,H*0.12);
else ctx.fillText('Plant bends toward light',W/2,H*0.12);
// Energy particles when active
if(p>0.5){
const ep=Math.min((p-0.5)/0.5,1);
for(let i=0;i<5;i++){
const px=stemTop.x+Math.sin(p*10+i)*15;
const py=stemTop.y-10-i*8;
ctx.save();ctx.globalAlpha=ep*(0.5+Math.sin(p*8+i)*0.3);
ctx.beginPath();ctx.arc(px,py,3,0,Math.PI*2);
ctx.fillStyle='#ffd54f';ctx.fill();ctx.restore();
}
}
}

function drawCutHeal(ctx,W,H,p){
const skinTop=H*0.2,skinBot=H*0.85;
ctx.fillStyle='#ffccbc';ctx.fillRect(0,skinTop,W,skinBot-skinTop);
// Wound gap
const gapX=W*0.4,gapW=40;
const gapClose=p>0.4?Math.min((p-0.4)/0.5,1):0;
const currentGap=gapW*(1-gapClose);
// Draw gap
ctx.fillStyle='#d32f2f';ctx.fillRect(gapX-currentGap/2,skinTop,currentGap,(skinBot-skinTop)*0.7);
// Cells around wound
const cols=8;
for(let c=0;c<cols;c++){
const cx=c*W/cols+W/cols/2;
const cy=skinTop+(skinBot-skinTop)*0.5;
const nearWound=Math.abs(cx-gapX)<gapW*1.2;
if(cx>gapX-currentGap/2&&cx<gapX+currentGap/2)continue;
const cellR=18;
if(nearWound&&p>0.3){
// Dividing cells
const divP=Math.min((p-0.3)/0.4,1);
ctx.save();ctx.shadowColor='#4caf50';ctx.shadowBlur=10;
drawCell(ctx,cx-5*divP,cy,cellR,'#66bb6a',true);
if(divP>0.5)drawCell(ctx,cx+5*divP,cy,cellR,'#81c784',true);
ctx.restore();
}else{
drawCell(ctx,cx,cy,cellR,'#ef9a9a',false);
}
}
// Scar tissue
if(p>0.7){
const scarP=(p-0.7)/0.3;
ctx.save();ctx.globalAlpha=scarP;
ctx.fillStyle='#d7ccc8';ctx.fillRect(gapX-gapW*0.3,skinTop,gapW*0.6,(skinBot-skinTop)*0.5);
ctx.restore();
}
ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font='bold 12px sans-serif';ctx.textAlign='center';
if(p<0.3)ctx.fillText('Wound Detected',W/2,skinTop-8);
else if(p<0.7)ctx.fillText('Cell Division ‚Äî Closing Gap',W/2,skinTop-8);
else ctx.fillText('Healed ‚Äî Scar Tissue',W/2,skinTop-8);
}

function drawAltitude(ctx,W,H,p){
// Mountain background
ctx.fillStyle='#37474f';
ctx.beginPath();ctx.moveTo(0,H);ctx.lineTo(W*0.3,H*0.15);ctx.lineTo(W*0.6,H);ctx.fill();
ctx.fillStyle='#455a64';
ctx.beginPath();ctx.moveTo(W*0.4,H);ctx.lineTo(W*0.7,H*0.1);ctx.lineTo(W,H);ctx.fill();
// Snow caps
ctx.fillStyle='#eceff1';
ctx.beginPath();ctx.moveTo(W*0.25,H*0.2);ctx.lineTo(W*0.3,H*0.15);ctx.lineTo(W*0.35,H*0.2);ctx.fill();
ctx.beginPath();ctx.moveTo(W*0.65,H*0.15);ctx.lineTo(W*0.7,H*0.1);ctx.lineTo(W*0.75,H*0.15);ctx.fill();
// Muscle cell box
const boxX=W*0.15,boxY=H*0.45,boxW=W*0.7,boxH=H*0.35;
ctx.fillStyle='rgba(0,0,0,0.4)';
ctx.roundRect(boxX,boxY,boxW,boxH,12);ctx.fill();
ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.lineWidth=1;ctx.roundRect(boxX,boxY,boxW,boxH,12);ctx.stroke();
ctx.fillStyle='rgba(255,255,255,0.8)';ctx.font='bold 11px sans-serif';ctx.textAlign='center';
ctx.fillText('Muscle Cell',boxX+boxW/2,boxY-5);
// Mitochondria inside
const mitoGlow=p>0.5;
const mitoCount=4;
for(let i=0;i<mitoCount;i++){
const mx=boxX+boxW*0.2+i*boxW*0.2;
const my=boxY+boxH*0.5;
const brightness=p<0.3?0.3:Math.min(0.3+(p-0.3)*2,1);
ctx.save();
if(mitoGlow&&brightness>0.7){ctx.shadowColor='#ff9800';ctx.shadowBlur=brightness*15;}
ctx.beginPath();ctx.ellipse(mx,my,18,10,0,0,Math.PI*2);
const mgr=ctx.createLinearGradient(mx-18,my,mx+18,my);
mgr.addColorStop(0,`rgba(255,${Math.round(152*brightness)},0,${brightness})`);
mgr.addColorStop(1,`rgba(255,${Math.round(183*brightness)},77,${brightness})`);
ctx.fillStyle=mgr;ctx.fill();
ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1;ctx.stroke();
ctx.restore();
}
ctx.fillStyle='rgba(255,255,255,0.6)';ctx.font='10px sans-serif';ctx.fillText('Mitochondria',boxX+boxW/2,boxY+boxH*0.5+22);
// Oxygen particles (red blood cells)
const oxyFlow=p>0.35?Math.min((p-0.35)/0.3,1):0;
for(let i=0;i<6;i++){
const ox=boxX-10+oxyFlow*(boxW*0.3+i*15);
const oy=boxY+boxH*0.3+Math.sin(p*8+i)*10;
ctx.save();ctx.globalAlpha=oxyFlow;
ctx.beginPath();ctx.arc(ox,oy,5,0,Math.PI*2);ctx.fillStyle='#ef5350';ctx.fill();
ctx.restore();
}
if(oxyFlow>0.5){
ctx.fillStyle='rgba(255,255,255,0.6)';ctx.font='10px sans-serif';
ctx.fillText('Red Blood Cells ‚Üí O‚ÇÇ',boxX+boxW/2,boxY+boxH*0.15);
}
// Energy bursts
if(p>0.7){
const eP=(p-0.7)/0.3;
for(let i=0;i<3;i++){
ctx.save();ctx.globalAlpha=eP*Math.abs(Math.sin(p*12+i));
ctx.beginPath();ctx.arc(boxX+boxW*0.3+i*boxW*0.15,boxY+boxH*0.5-15,4+eP*3,0,Math.PI*2);
ctx.fillStyle='#ffd54f';ctx.fill();ctx.restore();
}
ctx.fillStyle='#ffd54f';ctx.font='bold 11px sans-serif';ctx.fillText('‚ö° Energy Restored',boxX+boxW/2,boxY+boxH+15);
}
ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font='bold 12px sans-serif';
if(p<0.35)ctx.fillText('Low Oxygen ‚Äî Mitochondria Dimming',W/2,H*0.08);
else if(p<0.65)ctx.fillText('More Red Blood Cells Arriving',W/2,H*0.08);
else ctx.fillText('Energy Production Restored',W/2,H*0.08);
}

function drawLeafColor(ctx,W,H,p){
// Draw large leaf shape
const cx=W/2,cy=H/2;
const leafW=W*0.35,leafH=H*0.4;
// Color transition
const green='#4caf50',yellow='#fdd835',orange='#ff9800';
let fillColor;
if(p<0.4)fillColor=lerpColor(green,yellow,p/0.4);
else fillColor=lerpColor(yellow,orange,(p-0.4)/0.6);
ctx.save();
ctx.beginPath();
ctx.moveTo(cx,cy-leafH);
ctx.bezierCurveTo(cx+leafW,cy-leafH*0.5,cx+leafW,cy+leafH*0.5,cx,cy+leafH);
ctx.bezierCurveTo(cx-leafW,cy+leafH*0.5,cx-leafW,cy-leafH*0.5,cx,cy-leafH);
ctx.fillStyle=fillColor;ctx.fill();
ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=2;ctx.stroke();
// Leaf vein
ctx.beginPath();ctx.moveTo(cx,cy-leafH);ctx.lineTo(cx,cy+leafH);
ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=1.5;ctx.stroke();
for(let i=-2;i<=2;i++){
if(i===0)continue;
ctx.beginPath();ctx.moveTo(cx,cy+i*leafH*0.25);
ctx.lineTo(cx+(i>0?1:-1)*leafW*0.6,cy+i*leafH*0.25-(i>0?1:-1)*leafH*0.1);
ctx.stroke();
}
ctx.restore();
// Chloroplasts fading
const chlAlpha=1-p;
for(let i=0;i<6;i++){
const cpx=cx-leafW*0.3+i*leafW*0.12;
const cpy=cy-10+Math.sin(i)*20;
ctx.save();ctx.globalAlpha=chlAlpha;
ctx.beginPath();ctx.ellipse(cpx,cpy,8,5,0,0,Math.PI*2);
ctx.fillStyle='#2e7d32';ctx.fill();ctx.restore();
}
// Hidden pigments appearing
if(p>0.4){
const pigP=(p-0.4)/0.6;
for(let i=0;i<5;i++){
ctx.save();ctx.globalAlpha=pigP;
const ppx=cx-leafW*0.2+i*leafW*0.1;
const ppy=cy+Math.cos(i)*15;
ctx.beginPath();ctx.arc(ppx,ppy,4+pigP*2,0,Math.PI*2);
ctx.fillStyle=i%2===0?'#ffd54f':'#ff9800';ctx.fill();ctx.restore();
}
}
// Water flow stopping
if(p<0.3){
const waterAlpha=1-p/0.3;
ctx.save();ctx.globalAlpha=waterAlpha;
for(let i=0;i<3;i++){
ctx.beginPath();ctx.arc(cx,cy+leafH+10+i*8,3,0,Math.PI*2);
ctx.fillStyle='#42a5f5';ctx.fill();
}
ctx.restore();
}
// Labels
ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font='bold 12px sans-serif';ctx.textAlign='center';
if(p<0.3)ctx.fillText('Water Flow Stopping',W/2,H*0.08);
else if(p<0.6)ctx.fillText('Chloroplasts Breaking Down',W/2,H*0.08);
else ctx.fillText('Shutdown ‚Äî Hidden Colors Revealed',W/2,H*0.08);
if(p>0.7){
ctx.fillStyle='#ff7043';ctx.font='bold 14px sans-serif';
ctx.fillText('üîª SHUTDOWN',W/2,H*0.95);
}
}

function drawBoneHeal(ctx,W,H,p){
const boneY=H*0.3,boneH=H*0.4;
const gapX=W*0.45,gapW=30;
// Left bone
ctx.fillStyle='#eceff1';ctx.fillRect(W*0.1,boneY,gapX-gapW/2-W*0.1,boneH);
ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.strokeRect(W*0.1,boneY,gapX-gapW/2-W*0.1,boneH);
// Right bone
ctx.fillStyle='#eceff1';ctx.fillRect(gapX+gapW/2,boneY,W*0.9-gapX-gapW/2,boneH);
ctx.strokeRect(gapX+gapW/2,boneY,W*0.9-gapX-gapW/2,boneH);
// Fracture gap filling
if(p>0.2){
const fillP=Math.min((p-0.2)/0.5,1);
const fillW=gapW*fillP;
// New bone is denser (brighter)
ctx.save();
if(p>0.6){ctx.shadowColor='#ffd54f';ctx.shadowBlur=10;}
ctx.fillStyle=p>0.6?'#fff9c4':'#cfd8dc';
ctx.fillRect(gapX-fillW/2,boneY,fillW,boneH);
ctx.restore();
}
// Dividing cells
if(p>0.15&&p<0.7){
const divP=(p-0.15)/0.55;
for(let i=0;i<4;i++){
const dx=gapX-gapW/2+i*gapW/3;
const dy=boneY+boneH*0.3+i*boneH*0.15;
ctx.save();ctx.shadowColor='#4caf50';ctx.shadowBlur=8;
ctx.beginPath();ctx.arc(dx,dy,5+divP*3,0,Math.PI*2);
ctx.fillStyle='#66bb6a';ctx.fill();
if(divP>0.4){ctx.beginPath();ctx.arc(dx+8,dy,4+divP*2,0,Math.PI*2);ctx.fill();}
ctx.restore();
}
}
// Mitochondria energy
if(p>0.4){
const eP=(p-0.4)/0.3;
for(let i=0;i<3;i++){
drawMitochondria(ctx,W*0.25+i*W*0.1,boneY+boneH+25,12,7,eP>0.5);
}
ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='10px sans-serif';ctx.textAlign='center';
ctx.fillText('Mitochondria powering repair',W*0.35,boneY+boneH+45);
}
// Reinforced label
if(p>0.75){
ctx.fillStyle='#ffd54f';ctx.font='bold 12px sans-serif';ctx.textAlign='center';
ctx.fillText('üõ°Ô∏è Reinforced ‚Äî Stronger Than Before',W/2,boneY-10);
}
ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font='bold 12px sans-serif';ctx.textAlign='center';
if(p<0.2)ctx.fillText('Fracture Detected',W/2,H*0.08);
else if(p<0.6)ctx.fillText('Mitosis ‚Äî Bone Cells Dividing',W/2,H*0.08);
else ctx.fillText('Denser Bone Fills Gap',W/2,H*0.08);
}

function drawLizardTail(ctx,W,H,p){
// Lizard body
const bodyX=W*0.15,bodyY=H*0.45,bodyW=W*0.25,bodyH=H*0.15;
ctx.fillStyle='#66bb6a';
ctx.beginPath();ctx.ellipse(bodyX+bodyW/2,bodyY+bodyH/2,bodyW/2,bodyH/2,0,0,Math.PI*2);ctx.fill();
// Head
ctx.beginPath();ctx.ellipse(bodyX,bodyY+bodyH/2,bodyW*0.25,bodyH*0.35,0,0,Math.PI*2);ctx.fill();
// Eye
ctx.beginPath();ctx.arc(bodyX-bodyW*0.1,bodyY+bodyH*0.35,3,0,Math.PI*2);ctx.fillStyle='#212121';ctx.fill();
// Legs
ctx.strokeStyle='#66bb6a';ctx.lineWidth=4;
ctx.beginPath();ctx.moveTo(bodyX+bodyW*0.3,bodyY+bodyH);ctx.lineTo(bodyX+bodyW*0.2,bodyY+bodyH+15);ctx.stroke();
ctx.beginPath();ctx.moveTo(bodyX+bodyW*0.7,bodyY+bodyH);ctx.lineTo(bodyX+bodyW*0.8,bodyY+bodyH+15);ctx.stroke();
// Tail regrowth
const tailStart=bodyX+bodyW;
const tailMaxLen=W*0.5;
const tailGrowth=p<0.15?0:Math.min((p-0.15)/0.7,1);
const tailLen=tailMaxLen*tailGrowth;
if(tailLen>0){
// Bone layer
ctx.fillStyle='#eceff1';
ctx.fillRect(tailStart,bodyY+bodyH*0.4,tailLen,bodyH*0.15);
// Muscle layer
ctx.fillStyle='#ef5350';ctx.globalAlpha=0.6;
ctx.fillRect(tailStart,bodyY+bodyH*0.25,tailLen,bodyH*0.5);ctx.globalAlpha=1;
// Skin layer
ctx.fillStyle='#66bb6a';
ctx.beginPath();
ctx.moveTo(tailStart,bodyY+bodyH*0.15);
ctx.lineTo(tailStart+tailLen,bodyY+bodyH*0.35);
ctx.lineTo(tailStart+tailLen,bodyY+bodyH*0.65);
ctx.lineTo(tailStart,bodyY+bodyH*0.85);
ctx.closePath();ctx.fill();
// Growing tip glow
if(tailGrowth<1){
ctx.save();ctx.shadowColor='#4caf50';ctx.shadowBlur=15;
ctx.beginPath();ctx.arc(tailStart+tailLen,bodyY+bodyH/2,6,0,Math.PI*2);
ctx.fillStyle='#b9f6ca';ctx.fill();ctx.restore();
}
// Dividing cells at tip
if(tailGrowth<0.9){
for(let i=0;i<3;i++){
ctx.save();ctx.globalAlpha=0.6+Math.sin(p*10+i)*0.3;
ctx.beginPath();ctx.arc(tailStart+tailLen-i*8,bodyY+bodyH*0.3+i*bodyH*0.15,4,0,Math.PI*2);
ctx.fillStyle='#81c784';ctx.fill();ctx.restore();
}
}
}
// Break point marker
if(p<0.2){
ctx.strokeStyle='#f44336';ctx.lineWidth=2;ctx.setLineDash([4,4]);
ctx.beginPath();ctx.moveTo(tailStart,bodyY);ctx.lineTo(tailStart,bodyY+bodyH);ctx.stroke();
ctx.setLineDash([]);
ctx.fillStyle='#f44336';ctx.font='10px sans-serif';ctx.textAlign='center';
ctx.fillText('Break',tailStart,bodyY-5);
}
// Labels
ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font='bold 12px sans-serif';ctx.textAlign='center';
if(p<0.2)ctx.fillText('Tail Lost ‚Äî Cells Activating',W/2,H*0.08);
else if(p<0.7)ctx.fillText('Rapid Cell Division ‚Äî Regrowing',W/2,H*0.08);
else ctx.fillText('Tail Regenerated',W/2,H*0.08);
// Layer labels
if(tailGrowth>0.4){
ctx.font='9px sans-serif';ctx.fillStyle='rgba(255,255,255,0.6)';
ctx.fillText('Bone',tailStart+tailLen*0.5,bodyY+bodyH*0.5+2);
ctx.fillText('Muscle',tailStart+tailLen*0.3,bodyY+bodyH*0.2);
ctx.fillText('Skin',tailStart+tailLen*0.7,bodyY+bodyH*0.1);
}
}

function drawOldTree(ctx,W,H,p){
// Ground
ctx.fillStyle='#5d4037';ctx.fillRect(0,H*0.8,W,H*0.2);
// Tree trunk
const trunkX=W*0.4,trunkW=W*0.12;
ctx.fillStyle='#6d4c41';ctx.fillRect(trunkX,H*0.3,trunkW,H*0.5);
// Rings visible (cross-section hint)
ctx.strokeStyle='rgba(255,255,255,0.1)';
for(let i=0;i<5;i++){
ctx.beginPath();ctx.arc(trunkX+trunkW/2,H*0.55,trunkW*0.2+i*3,0,Math.PI*2);ctx.stroke();
}
// Branches ‚Äî some die
const branches=[
{x:trunkX,y:H*0.35,dx:-W*0.2,dy:-H*0.1,alive:true},
{x:trunkX+trunkW,y:H*0.38,dx:W*0.22,dy:-H*0.12,alive:p<0.4},
{x:trunkX,y:H*0.5,dx:-W*0.15,dy:-H*0.05,alive:true},
{x:trunkX+trunkW,y:H*0.48,dx:W*0.18,dy:-H*0.08,alive:p<0.3},
{x:trunkX+trunkW/2,y:H*0.3,dx:0,dy:-H*0.15,alive:true}
];
branches.forEach(b=>{
ctx.beginPath();ctx.moveTo(b.x,b.y);ctx.lineTo(b.x+b.dx,b.y+b.dy);
ctx.strokeStyle=b.alive?'#8d6e63':'#616161';ctx.lineWidth=b.alive?4:3;ctx.stroke();
// Foliage
if(b.alive){
ctx.save();ctx.shadowColor='#2e7d32';ctx.shadowBlur=5;
ctx.beginPath();ctx.arc(b.x+b.dx,b.y+b.dy,15,0,Math.PI*2);
ctx.fillStyle='#4caf50';ctx.fill();ctx.restore();
}else{
// Crumbling effect
const crumbleP=p<0.3?0:Math.min((p-0.3)/0.3,1);
ctx.save();ctx.globalAlpha=1-crumbleP;
ctx.beginPath();ctx.arc(b.x+b.dx,b.y+b.dy+crumbleP*20,12*(1-crumbleP*0.5),0,Math.PI*2);
ctx.fillStyle='#9e9e9e';ctx.fill();ctx.restore();
}
});
// Cell wall protection glow
if(p>0.3){
const shieldP=Math.min((p-0.3)/0.3,1);
ctx.save();ctx.globalAlpha=shieldP*0.3;
ctx.strokeStyle='#ffd54f';ctx.lineWidth=4;
ctx.strokeRect(trunkX-3,H*0.4,trunkW+6,H*0.35);
ctx.restore();
ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='10px sans-serif';ctx.textAlign='center';
ctx.fillText('Cell Walls Protecting Core',trunkX+trunkW/2,H*0.78);
}
// Water particles disappearing
if(p<0.4){
const waterAlpha=1-p/0.4;
ctx.save();ctx.globalAlpha=waterAlpha;
for(let i=0;i<4;i++){
ctx.beginPath();ctx.arc(trunkX-10-i*8,H*0.7-i*10,3,0,Math.PI*2);
ctx.fillStyle='#42a5f5';ctx.fill();
}
ctx.restore();
}
// Labels
ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font='bold 12px sans-serif';ctx.textAlign='center';
if(p<0.3)ctx.fillText('Drought ‚Äî Water Disappearing',W/2,H*0.08);
else if(p<0.6)ctx.fillText('Branches Dying ‚Äî Core Protected',W/2,H*0.08);
else ctx.fillText('Survived ‚Äî But Permanently Damaged',W/2,H*0.08);
// Slow division indicator
if(p>0.2){
ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='10px sans-serif';
ctx.fillText('Cell division: near zero',trunkX+trunkW/2,H*0.25);
}
}

// ===== RECORD =====
function recordData(){
const s=state.currentScenario;
if(state.completedIds.includes(s.id))return;
state.completedIds.push(s.id);
// Check prediction accuracy
state.totalPredictions++;
const correct=state.prediction===s.correctPredict;
if(correct){state.correctCount++;state.streak++;state.score+=100+state.streak*20;}
else{state.streak=0;state.score+=50;}
state.dataRows.push({
scenario:s.name,
whatChanged:s.whatChanges,
response:s.response,
backOk:s.backOk
});
updateHUD();
renderScenarios();
updateDataTable();
}

function showRecord(){
const cc=document.getElementById('centerContent');
const s=state.currentScenario;
const correct=state.prediction===s.correctPredict;
cc.innerHTML=`<div class="record-card fade-in">
<span class="record-emoji">${correct?'üéØ':'üìù'}</span>
<h3>${correct?'Prediction Correct!':'Data Recorded!'}</h3>
<p>${correct?'Nice prediction ‚Äî your data is logged!':'Not quite, but great observation ‚Äî data logged!'}</p>
<p style="margin-top:12px;font-size:14px;color:#78909c;">Pick your next scenario from the left sidebar.</p>
</div>`;
const btn=document.getElementById('mainAction');
btn.classList.add('hidden');
// Check milestones
checkMilestones();
}

function checkMilestones(){
const count=state.completedIds.length;
const ecEl=document.getElementById('ecMsg');
if(count===5){
ecEl.innerHTML='<div class="ec-msg required">‚úÖ Required Complete! Continue for Extra Credit?</div>';
showCompletion('required');
}else if(count===8){
ecEl.innerHTML='<div class="ec-msg extra">üèÜ Extra Credit Complete!</div>';
showCompletion('extra');
}
}

function showCompletion(type){
const overlay=document.getElementById('completionOverlay');
const card=document.getElementById('completionCard');
if(type==='required'){
card.innerHTML=`<span class="big-emoji">üéâ</span><h2>Required Complete!</h2><p>You finished 5 scenarios! Want to keep going for extra credit?</p><button onclick="closeCompletion()">Keep Going!</button>`;
}else{
card.innerHTML=`<span class="big-emoji">üèÜ</span><h2>Extra Credit Complete!</h2><p>All 8 scenarios done! Amazing work, investigator!</p><button onclick="closeCompletion()">View Data</button>`;
}
overlay.classList.remove('hidden');
}
function closeCompletion(){document.getElementById('completionOverlay').classList.add('hidden');}

// ===== HUD =====
function updateHUD(){
const count=state.completedIds.length;
document.getElementById('hudScore').textContent=state.score;
document.getElementById('hudStreak').textContent=state.streak;
document.getElementById('hudCompleted').textContent=count+'/5';
document.getElementById('hudAccuracy').textContent=state.totalPredictions?Math.round(state.correctCount/state.totalPredictions*100)+'%':'0%';
document.getElementById('progressFill').style.width=Math.min(count/5*100,100)+'%';
const remaining=Math.max(5-count,0);
if(count>=8)document.getElementById('progressMsg').textContent='All 8 complete! üèÜ';
else if(count>=5)document.getElementById('progressMsg').textContent=`Extra credit: ${8-count} more available!`;
else document.getElementById('progressMsg').textContent=`Pick ${remaining} more you like!`;
}

function updateDataTable(){
const body=document.getElementById('dataBody');
body.innerHTML='';
state.dataRows.forEach(r=>{
const tr=document.createElement('tr');tr.className='filled';
tr.innerHTML=`<td>${r.scenario}</td><td>${r.whatChanged}</td><td>${r.response}</td><td>${r.backOk}</td>`;
body.appendChild(tr);
});
}

// ===== COPY TABLE =====
function copyTable(){
try{
let text='Scenario\tWhat Changed?\tSystem Response\tBack Toward OK/Target?\n';
state.dataRows.forEach(r=>{text+=`${r.scenario}\t${r.whatChanged}\t${r.response}\t${r.backOk}\n`;});
navigator.clipboard.writeText(text).then(()=>{
const btn=document.getElementById('copyBtn');btn.textContent='Copied!';
setTimeout(()=>btn.textContent='üìã Copy Table',2000);
});
}catch(e){
const btn=document.getElementById('copyBtn');btn.textContent='Copy failed';
setTimeout(()=>btn.textContent='üìã Copy Table',2000);
}
}

// ===== ACTION HANDLER =====
function handleAction(){
if(!state.currentScenario)return;
try{
if(state.step==='predict'){
if(!state.prediction)return;
state.step='read';
setStepTab('read');
showRead();
}else if(state.step==='read'){
state.step='watch';
setStepTab('watch');
showWatch();
}
}catch(e){console.error('Action error:',e);}
}

// ===== SPEECH =====
let speechResumeInterval=null;
function handleSpeak(){
if(state.speaking){stopSpeech();return;}
try{
if(!state.speechInit){
state.speechInit=true;
if(!window.speechSynthesis){
document.getElementById('speakBtn').textContent='Text Only';return;
}
}
const passageEl=document.getElementById('passageText');
if(!passageEl)return;
const text=passageEl.innerText;
const utterance=new SpeechSynthesisUtterance(text);
utterance.rate=0.9;
utterance.onend=()=>{stopSpeech();};
utterance.onerror=()=>{stopSpeech();};
speechSynthesis.cancel();
speechSynthesis.speak(utterance);
state.speaking=true;
document.getElementById('speakBtn').textContent='‚èπÔ∏è Stop';
// Chrome 15s bug workaround
speechResumeInterval=setInterval(()=>{
if(state.speaking&&speechSynthesis.speaking)speechSynthesis.resume();
},10000);
// Sentence highlighting
const sentences=text.match(/[^.!?]+[.!?]+/g)||[text];
let idx=0;
utterance.onboundary=function(e){
if(e.name==='sentence'||e.charIndex>0){
// Simple highlight approach
}
};
}catch(e){
console.error('Speech error:',e);
document.getElementById('speakBtn').textContent='Text Only';
state.speaking=false;
}
}
function stopSpeech(){
try{speechSynthesis.cancel();}catch(e){}
clearInterval(speechResumeInterval);
state.speaking=false;
const btn=document.getElementById('speakBtn');
if(btn)btn.textContent='üîä Read Aloud';
}

// ===== RESET / NEW RUN =====
function resetSim(){
if(state.speaking)stopSpeech();
clearTimeout(state.animTimeout);
state={level:state.level,currentScenario:null,step:null,prediction:null,completedIds:[],score:0,streak:0,correctCount:0,totalPredictions:0,dataRows:[],speaking:false,speechInit:state.speechInit,animTimeout:null};
renderScenarios();renderKeyWords();updateHUD();updateDataTable();
document.getElementById('ecMsg').innerHTML='';
document.getElementById('centerContent').innerHTML=`<div class="welcome"><span class="emoji-big">üß¨</span><h2>Cell Science Investigator</h2><p>Your cells are doing wild things right now ‚Äî healing, dividing, making energy, and sometimes self-destructing. Pick a scenario from the left to investigate!</p></div>`;
document.querySelectorAll('.step-tab').forEach(t=>t.className='step-tab');
document.getElementById('mainAction').classList.add('hidden');
document.getElementById('speakBtn').classList.add('hidden');
}
function newRun(){resetSim();}

// Canvas roundRect polyfill
if(!CanvasRenderingContext2D.prototype.roundRect){
CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
if(typeof r==='number')r={tl:r,tr:r,br:r,bl:r};
this.beginPath();this.moveTo(x+r.tl,y);this.lineTo(x+w-r.tr,y);
this.quadraticCurveTo(x+w,y,x+w,y+r.tr);this.lineTo(x+w,y+h-r.br);
this.quadraticCurveTo(x+w,y+h,x+w-r.br,y+h);this.lineTo(x+r.bl,y+h);
this.quadraticCurveTo(x,y+h,x,y+h-r.bl);this.lineTo(x,y+r.tl);
this.quadraticCurveTo(x,y,x+r.tl,y);this.closePath();return this;
};
}

// Start
init();
</script>
</body>
</html>
