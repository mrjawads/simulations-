<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Science Department Simulation: What Happens to Lungs When Air Quality Drops or You Vape</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .mission {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .win-conditions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .win-condition {
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            gap: 15px;
            min-height: 520px;
        }

        /* Control Panel */
        .control-panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .year-challenge {
            background: linear-gradient(135deg, rgba(234, 88, 12, 0.3) 0%, rgba(220, 38, 38, 0.3) 100%);
            border: 1px solid rgba(234, 88, 12, 0.5);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            text-align: center;
            font-size: 0.85rem;
        }

        .year-challenge.wildfire {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.5) 0%, rgba(234, 88, 12, 0.5) 100%);
            animation: pulse-challenge 1.5s ease-in-out infinite;
        }

        @keyframes pulse-challenge {
            0%, 100% { box-shadow: 0 0 10px rgba(234, 88, 12, 0.3); }
            50% { box-shadow: 0 0 20px rgba(234, 88, 12, 0.6); }
        }

        .challenge-title {
            font-weight: bold;
            color: #fb923c;
            margin-bottom: 4px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-label.locked {
            color: #9ca3af;
        }

        .control-icon {
            font-size: 1.1rem;
        }

        .button-group {
            display: flex;
            gap: 4px;
        }

        .control-btn {
            flex: 1;
            padding: 8px 4px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 2px solid transparent;
        }

        .control-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .control-btn.selected {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.3);
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.4);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .control-btn.locked-choice {
            border-color: #f87171;
            background: rgba(248, 113, 113, 0.3);
            opacity: 1;
        }

        /* Interaction Warning */
        .interaction-warning {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.5);
            border-radius: 8px;
            padding: 8px;
            margin-top: 10px;
            font-size: 0.75rem;
            display: none;
        }

        .interaction-warning.active {
            display: block;
            animation: pulse-warn 2s ease-in-out infinite;
        }

        @keyframes pulse-warn {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Visual Arena */
        .visual-arena {
            background: linear-gradient(180deg, #0d1b2a 0%, #1b263b 100%);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            min-height: 480px;
        }

        .lung-container {
            position: relative;
            width: 380px;
            height: 320px;
        }

        .lung-svg {
            width: 100%;
            height: 100%;
        }

        .lung-fill {
            transition: fill 0.8s ease;
        }

        /* Alveoli */
        .alveoli-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .alveolus {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            transition: all 0.6s ease;
        }

        .alveolus.healthy {
            background: radial-gradient(circle at 30% 30%, #fda4af, #fb7185);
            animation: breathe 3s ease-in-out infinite;
        }

        .alveolus.inflamed {
            background: radial-gradient(circle at 30% 30%, #fdba74, #f97316);
            animation: pulse-inflamed 1.2s ease-in-out infinite;
        }

        .alveolus.scarred {
            background: radial-gradient(circle at 30% 30%, #4b5563, #1f2937);
            animation: none;
            transform: scale(0.6);
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes pulse-inflamed {
            0%, 100% { transform: scale(1); box-shadow: 0 0 8px rgba(249, 115, 22, 0.5); }
            50% { transform: scale(0.85); box-shadow: 0 0 4px rgba(249, 115, 22, 0.3); }
        }

        /* Inflammation Ring */
        .inflammation-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 260px;
            border-radius: 50%;
            border: 4px solid transparent;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .inflammation-ring.low {
            border-color: rgba(251, 191, 36, 0.3);
        }

        .inflammation-ring.medium {
            border-color: rgba(249, 115, 22, 0.5);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.3);
        }

        .inflammation-ring.high {
            border-color: rgba(239, 68, 68, 0.7);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            animation: danger-pulse 1s ease-in-out infinite;
        }

        @keyframes danger-pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 50px rgba(239, 68, 68, 0.8); }
        }

        /* Particles */
        .particle-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
        }

        .smoke-particle {
            background: radial-gradient(circle, rgba(107,114,128,0.8) 0%, transparent 70%);
            animation: float-smoke 3s ease-out forwards;
        }

        .heal-particle {
            background: radial-gradient(circle, rgba(74,222,128,0.9) 0%, transparent 70%);
            animation: float-heal 2s ease-out forwards;
        }

        .damage-particle {
            background: radial-gradient(circle, rgba(248,113,113,0.9) 0%, transparent 70%);
            animation: float-damage 1.5s ease-out forwards;
        }

        @keyframes float-smoke {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            100% { transform: translateY(-80px) scale(2); opacity: 0; }
        }

        @keyframes float-heal {
            0% { transform: translateY(0) scale(0.5); opacity: 1; }
            100% { transform: translateY(-60px) scale(1.5); opacity: 0; }
        }

        @keyframes float-damage {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        /* Effect Preview */
        .effect-preview {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: none;
            text-align: center;
            min-width: 280px;
        }

        .effect-preview.active {
            display: block;
        }

        .effect-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }

        .effect-positive { color: #4ade80; }
        .effect-negative { color: #f87171; }
        .effect-warning { color: #fbbf24; }

        /* Year Badge */
        .year-badge {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            padding: 8px 25px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        /* HUD Panel */
        .hud-panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .hud-title {
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .hud-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .hud-stat {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .stat-value.capacity { color: #60a5fa; }
        .stat-value.scar { color: #f87171; }
        .stat-value.year { color: #4ade80; }
        .stat-value.inflam { color: #fb923c; }

        /* Meter Bars */
        .meter-section {
            margin-bottom: 12px;
        }

        .meter-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 4px;
        }

        .meter-bar {
            height: 18px;
            background: rgba(0,0,0,0.4);
            border-radius: 9px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            border-radius: 9px;
            transition: width 0.6s ease, background 0.6s ease;
            position: relative;
        }

        .meter-fill.capacity {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
        }

        .meter-fill.scar {
            background: linear-gradient(90deg, #7f1d1d 0%, #dc2626 100%);
        }

        .meter-fill.inflammation {
            background: linear-gradient(90deg, #c2410c 0%, #fb923c 100%);
        }

        .meter-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, transparent 100%);
            border-radius: 9px 9px 0 0;
        }

        .threshold-line {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: #fbbf24;
            box-shadow: 0 0 8px #fbbf24;
        }

        /* Consecutive High Inflammation Warning */
        .consecutive-warning {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 0.75rem;
            text-align: center;
            display: none;
        }

        .consecutive-warning.active {
            display: block;
            animation: pulse-danger 1s ease-in-out infinite;
        }

        @keyframes pulse-danger {
            0%, 100% { background: rgba(239, 68, 68, 0.2); }
            50% { background: rgba(239, 68, 68, 0.4); }
        }

        /* Progress Section */
        .progress-section {
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 0.8rem;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .progress-bar {
            height: 22px;
            background: rgba(0,0,0,0.4);
            border-radius: 11px;
            overflow: hidden;
            display: flex;
        }

        .progress-segment {
            height: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
        }

        .progress-segment.complete { background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%); }
        .progress-segment.extra { background: linear-gradient(180deg, #a855f7 0%, #9333ea 100%); }
        .progress-segment.current { background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%); }
        .progress-segment.empty { background: rgba(255,255,255,0.1); }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .action-btn.run {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .action-btn.run:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.6);
        }

        .action-btn.next {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .action-btn.next:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .small-btn-row {
            display: flex;
            gap: 8px;
        }

        .small-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .small-btn.reset {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .small-btn.new-run {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        /* Status Messages */
        .status-message {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .status-message.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: #4ade80;
        }

        .status-message.warning {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.5);
            color: #fbbf24;
        }

        .status-message.danger {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #f87171;
        }

        /* Data Table */
        .data-section {
            margin-top: 15px;
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .data-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .data-table th {
            background: rgba(99, 102, 241, 0.3);
            padding: 8px 6px;
            text-align: center;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .data-table td {
            padding: 6px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .data-table tr:nth-child(even) {
            background: rgba(255,255,255,0.03);
        }

        .data-table tr.highlight {
            background: rgba(34, 197, 94, 0.2);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            padding: 35px;
            border-radius: 20px;
            text-align: center;
            max-width: 450px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 12px;
        }

        .modal-text {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .modal-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .modal-stat {
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .modal-stat-label {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .modal-stat-value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .modal-btn.continue {
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
        }

        /* Flash effects */
        .flash-green { animation: flash-g 0.5s ease; }
        .flash-red { animation: flash-r 0.5s ease; }

        @keyframes flash-g {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 25px rgba(34, 197, 94, 0.8); }
        }

        @keyframes flash-r {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.8); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .lung-container {
                width: 300px;
                height: 260px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>ü´Å Science Department Simulation: Lung Damage</h1>
            <p class="mission">Survive 8 years with healthy lungs ‚Äî but every choice has tradeoffs!</p>
            <div class="win-conditions">
                <span class="win-condition">üéØ Capacity > 4.0 L</span>
                <span class="win-condition">‚ö´ Scar < 40%</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="panel-title">‚ö° Your Choices</div>
                
                <div class="year-challenge" id="year-challenge">
                    <div class="challenge-title">üìÖ Year 1</div>
                    <div id="challenge-text">Make your choices wisely!</div>
                </div>

                <div class="control-group">
                    <div class="control-label" id="vaping-label">
                        <span class="control-icon">üö¨</span>
                        <span>Vaping</span>
                    </div>
                    <div class="button-group" id="vaping-controls">
                        <button class="control-btn selected" data-var="vaping" data-val="never">Never</button>
                        <button class="control-btn" data-var="vaping" data-val="sometimes">Sometimes</button>
                        <button class="control-btn" data-var="vaping" data-val="daily">Daily</button>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-label" id="pollution-label">
                        <span class="control-icon">üå´Ô∏è</span>
                        <span>Pollution Level</span>
                    </div>
                    <div class="button-group" id="pollution-controls">
                        <button class="control-btn selected" data-var="pollution" data-val="low">Low</button>
                        <button class="control-btn" data-var="pollution" data-val="medium">Medium</button>
                        <button class="control-btn" data-var="pollution" data-val="high">High</button>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-label" id="exercise-label">
                        <span class="control-icon">üèÉ</span>
                        <span>Exercise</span>
                    </div>
                    <div class="button-group" id="exercise-controls">
                        <button class="control-btn" data-var="exercise" data-val="none">None</button>
                        <button class="control-btn selected" data-var="exercise" data-val="some">Some</button>
                        <button class="control-btn" data-var="exercise" data-val="daily">Daily</button>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-label" id="indoors-label">
                        <span class="control-icon">üè†</span>
                        <span>Stay Indoors</span>
                    </div>
                    <div class="button-group" id="indoors-controls">
                        <button class="control-btn" data-var="indoors" data-val="none">None</button>
                        <button class="control-btn selected" data-var="indoors" data-val="some">Some</button>
                        <button class="control-btn" data-var="indoors" data-val="allday">All Day</button>
                    </div>
                </div>

                <div class="interaction-warning" id="interaction-warning">
                    <strong>‚ö†Ô∏è TRADEOFF:</strong> <span id="warning-text"></span>
                </div>
            </div>

            <!-- Visual Arena -->
            <div class="visual-arena">
                <div class="year-badge" id="year-badge">Year 1 of 8</div>

                <div class="lung-container">
                    <svg class="lung-svg" viewBox="0 0 400 350">
                        <defs>
                            <linearGradient id="lungGradientLeft" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" id="lung-left-stop1" style="stop-color:#fecaca"/>
                                <stop offset="100%" id="lung-left-stop2" style="stop-color:#fca5a5"/>
                            </linearGradient>
                            <linearGradient id="lungGradientRight" x1="100%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" id="lung-right-stop1" style="stop-color:#fecaca"/>
                                <stop offset="100%" id="lung-right-stop2" style="stop-color:#fca5a5"/>
                            </linearGradient>
                        </defs>
                        
                        <path d="M200 30 L200 90" stroke="#f0abfc" stroke-width="18" stroke-linecap="round"/>
                        <path d="M200 90 Q160 120 120 150" stroke="#f0abfc" stroke-width="10" fill="none" stroke-linecap="round"/>
                        <path d="M200 90 Q240 120 280 150" stroke="#f0abfc" stroke-width="10" fill="none" stroke-linecap="round"/>
                        <ellipse cx="110" cy="210" rx="80" ry="105" class="lung-fill" fill="url(#lungGradientLeft)"/>
                        <ellipse cx="290" cy="210" rx="80" ry="105" class="lung-fill" fill="url(#lungGradientRight)"/>
                    </svg>

                    <div class="alveoli-container" id="alveoli-container"></div>
                    <div class="inflammation-ring" id="inflammation-ring"></div>
                    <div class="particle-container" id="particle-container"></div>
                </div>

                <div class="effect-preview" id="effect-preview">
                    <div id="preview-content"></div>
                </div>
            </div>

            <!-- HUD Panel -->
            <div class="hud-panel">
                <div class="hud-title">üìä Lung Health</div>
                
                <div class="hud-grid">
                    <div class="hud-stat" id="stat-capacity">
                        <div class="stat-label">Capacity</div>
                        <div class="stat-value capacity" id="capacity-value">6.0 L</div>
                    </div>
                    <div class="hud-stat" id="stat-scar">
                        <div class="stat-label">Scar %</div>
                        <div class="stat-value scar" id="scar-value">0%</div>
                    </div>
                    <div class="hud-stat" id="stat-year">
                        <div class="stat-label">Year</div>
                        <div class="stat-value year" id="year-value">1</div>
                    </div>
                    <div class="hud-stat" id="stat-inflam">
                        <div class="stat-label">Inflam</div>
                        <div class="stat-value inflam" id="inflam-value">0%</div>
                    </div>
                </div>

                <div class="consecutive-warning" id="consecutive-warning">
                    ‚ö†Ô∏è <strong>DANGER!</strong> High inflammation 2+ years = PERMANENT SCAR!
                </div>

                <div class="meter-section">
                    <div class="meter-label">
                        <span>üéà Lung Capacity</span>
                        <span id="capacity-text">6.0 / 6.0 L</span>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill capacity" id="capacity-bar" style="width: 100%"></div>
                        <div class="threshold-line" style="left: 66.7%" title="4.0L minimum"></div>
                    </div>
                </div>

                <div class="meter-section">
                    <div class="meter-label">
                        <span>‚ö´ Scar Level</span>
                        <span id="scar-text">0%</span>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill scar" id="scar-bar" style="width: 0%"></div>
                        <div class="threshold-line" style="left: 40%" title="40% maximum"></div>
                    </div>
                </div>

                <div class="meter-section">
                    <div class="meter-label">
                        <span>üî• Inflammation</span>
                        <span id="inflammation-text">0%</span>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill inflammation" id="inflammation-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-label">
                        <span>Progress</span>
                        <span id="progress-text">0 / 5 Required</span>
                    </div>
                    <div class="progress-bar" id="progress-bar"></div>
                </div>

                <div class="action-buttons">
                    <button class="action-btn run" id="run-btn">‚ñ∂Ô∏è Run Year</button>
                    <button class="action-btn next" id="next-btn" disabled>‚û°Ô∏è Next Year</button>
                    <div class="small-btn-row">
                        <button class="small-btn reset" id="reset-btn">üîÑ Reset</button>
                        <button class="small-btn new-run" id="new-btn">üÜï New Run</button>
                    </div>
                </div>

                <div class="status-message" id="status-message" style="display: none;"></div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-section">
            <div class="data-title">üìã Data Table ‚Äî Copy your results!</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Round</th>
                        <th>Choice Made</th>
                        <th>Lung Capacity (L)</th>
                        <th>Scar Level (%)</th>
                    </tr>
                </thead>
                <tbody id="data-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon" id="modal-icon">üéâ</div>
            <div class="modal-title" id="modal-title">Great Job!</div>
            <div class="modal-text" id="modal-text">You completed 5 years!</div>
            <div class="modal-stats">
                <div class="modal-stat">
                    <div class="modal-stat-label">Capacity</div>
                    <div class="modal-stat-value" id="modal-capacity">5.2 L</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Scar</div>
                    <div class="modal-stat-value" id="modal-scar">15%</div>
                </div>
            </div>
            <div id="modal-buttons">
                <button class="modal-btn" id="modal-done">Done</button>
                <button class="modal-btn continue" id="modal-continue">Extra Credit</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GAME STATE ====================
        const state = {
            year: 1,
            maxYears: 8,
            requiredYears: 5,
            lungCapacity: 6.0,
            maxCapacity: 6.0,
            scarLevel: 0,
            inflammation: 0,
            highInflammationYears: 0,
            gamePhase: 'select',
            completedRequired: false,
            dataRows: [],
            
            selections: {
                vaping: 'never',
                pollution: 'low',
                exercise: 'some',
                indoors: 'some'
            },
            
            constraints: {
                vaping: null,
                pollution: null,
                exercise: null,
                indoors: null
            },
            
            challengeType: null
        };

        // ==================== YEAR CHALLENGES ====================
        const yearChallenges = [
            { type: 'normal', text: 'Make your choices wisely!' },
            { type: 'normal', text: 'What will you prioritize?' },
            { type: 'wildfire', text: 'üî• WILDFIRE SEASON! Pollution locked HIGH.', lock: { pollution: 'high' } },
            { type: 'gym_closed', text: 'üè´ Gym closed this year! Exercise locked NONE.', lock: { exercise: 'none' } },
            { type: 'summer', text: '‚òÄÔ∏è Summer break! Hard to stay indoors.', lock: { indoors: 'none' } },
            { type: 'peer_pressure', text: 'üë• Friends offering vapes constantly...', hint: 'vaping' },
            { type: 'wildfire', text: 'üî• Another wildfire! Pollution HIGH.', lock: { pollution: 'high' } },
            { type: 'final', text: 'üèÅ Final year! Make it count!' }
        ];

        // ==================== ALVEOLI POSITIONS ====================
        const alveoliPositions = [
            {x: 55, y: 140}, {x: 85, y: 130}, {x: 115, y: 145}, {x: 140, y: 160},
            {x: 45, y: 180}, {x: 75, y: 175}, {x: 105, y: 185}, {x: 135, y: 180}, {x: 160, y: 190},
            {x: 40, y: 220}, {x: 70, y: 215}, {x: 100, y: 225}, {x: 130, y: 220}, {x: 155, y: 230},
            {x: 50, y: 260}, {x: 80, y: 255}, {x: 115, y: 265}, {x: 145, y: 260},
            {x: 70, y: 295}, {x: 105, y: 290}, {x: 135, y: 295},
            {x: 250, y: 140}, {x: 280, y: 130}, {x: 310, y: 145}, {x: 340, y: 160},
            {x: 240, y: 180}, {x: 270, y: 175}, {x: 300, y: 185}, {x: 330, y: 180}, {x: 355, y: 190},
            {x: 245, y: 220}, {x: 275, y: 215}, {x: 305, y: 225}, {x: 335, y: 220}, {x: 360, y: 230},
            {x: 255, y: 260}, {x: 285, y: 255}, {x: 320, y: 265}, {x: 350, y: 260},
            {x: 270, y: 295}, {x: 305, y: 290}, {x: 335, y: 295}
        ];

        let alveoliStates = alveoliPositions.map(() => 'healthy');

        // ==================== DOM ELEMENTS ====================
        const el = {
            capacityValue: document.getElementById('capacity-value'),
            scarValue: document.getElementById('scar-value'),
            yearValue: document.getElementById('year-value'),
            inflamValue: document.getElementById('inflam-value'),
            capacityBar: document.getElementById('capacity-bar'),
            scarBar: document.getElementById('scar-bar'),
            inflammationBar: document.getElementById('inflammation-bar'),
            capacityText: document.getElementById('capacity-text'),
            scarText: document.getElementById('scar-text'),
            inflammationText: document.getElementById('inflammation-text'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            runBtn: document.getElementById('run-btn'),
            nextBtn: document.getElementById('next-btn'),
            resetBtn: document.getElementById('reset-btn'),
            newBtn: document.getElementById('new-btn'),
            statusMessage: document.getElementById('status-message'),
            yearChallenge: document.getElementById('year-challenge'),
            challengeText: document.getElementById('challenge-text'),
            yearBadge: document.getElementById('year-badge'),
            alveoliContainer: document.getElementById('alveoli-container'),
            particleContainer: document.getElementById('particle-container'),
            inflammationRing: document.getElementById('inflammation-ring'),
            dataBody: document.getElementById('data-body'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalIcon: document.getElementById('modal-icon'),
            modalTitle: document.getElementById('modal-title'),
            modalText: document.getElementById('modal-text'),
            modalCapacity: document.getElementById('modal-capacity'),
            modalScar: document.getElementById('modal-scar'),
            modalDone: document.getElementById('modal-done'),
            modalContinue: document.getElementById('modal-continue'),
            statCapacity: document.getElementById('stat-capacity'),
            statScar: document.getElementById('stat-scar'),
            interactionWarning: document.getElementById('interaction-warning'),
            warningText: document.getElementById('warning-text'),
            effectPreview: document.getElementById('effect-preview'),
            previewContent: document.getElementById('preview-content'),
            consecutiveWarning: document.getElementById('consecutive-warning')
        };

        // ==================== INITIALIZATION ====================
        function init() {
            createAlveoli();
            setupEventListeners();
            applyYearChallenge();
            updateUI();
            updateEffectPreview();
        }

        function createAlveoli() {
            el.alveoliContainer.innerHTML = '';
            alveoliPositions.forEach((pos, i) => {
                const alv = document.createElement('div');
                alv.className = 'alveolus healthy';
                alv.style.left = pos.x + 'px';
                alv.style.top = pos.y + 'px';
                el.alveoliContainer.appendChild(alv);
            });
        }

        function setupEventListeners() {
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', () => handleControlClick(btn));
            });
            el.runBtn.addEventListener('click', runYear);
            el.nextBtn.addEventListener('click', nextYear);
            el.resetBtn.addEventListener('click', () => location.reload());
            el.newBtn.addEventListener('click', newRun);
            el.modalDone.addEventListener('click', closeModal);
            el.modalContinue.addEventListener('click', continueForBonus);
        }

        // ==================== CONTROL HANDLING ====================
        function handleControlClick(btn) {
            if (state.gamePhase !== 'select' || btn.disabled) return;

            const variable = btn.dataset.var;
            const value = btn.dataset.val;

            document.querySelectorAll(`[data-var="${variable}"]`).forEach(b => {
                b.classList.remove('selected');
            });
            btn.classList.add('selected');
            state.selections[variable] = value;

            checkInteractions();
            updateEffectPreview();
        }

        // ==================== INTERACTION SYSTEM ====================
        function checkInteractions() {
            const { vaping, pollution, exercise, indoors } = state.selections;
            let warnings = [];

            if (exercise === 'daily' && pollution === 'high') {
                warnings.push('Daily exercise + high pollution = MORE particles inhaled!');
            }
            if (exercise === 'daily' && pollution === 'medium') {
                warnings.push('Heavy breathing pulls in more pollution particles.');
            }
            if (indoors === 'allday') {
                warnings.push('All day indoors = less lung strength over time.');
            }
            if (vaping !== 'never' && exercise === 'daily') {
                warnings.push('Vaping + exercise = inflamed lungs work harder!');
            }

            if (warnings.length > 0) {
                el.warningText.textContent = warnings[0];
                el.interactionWarning.classList.add('active');
            } else {
                el.interactionWarning.classList.remove('active');
            }
        }

        // ==================== EFFECT CALCULATION ====================
        function calculateEffects() {
            const { vaping, pollution, exercise, indoors } = state.selections;
            
            let capacityChange = 0;
            let inflammationChange = 0;
            let scarChange = 0;

            // VAPING
            if (vaping === 'never') {
                inflammationChange -= 5;
            } else if (vaping === 'sometimes') {
                inflammationChange += 12;
                capacityChange -= 0.1;
                if (state.inflammation > 40) scarChange += 3;
            } else if (vaping === 'daily') {
                inflammationChange += 25;
                capacityChange -= 0.3;
                scarChange += 5;
            }

            // POLLUTION
            if (pollution === 'low') {
                inflammationChange -= 3;
            } else if (pollution === 'medium') {
                inflammationChange += 8;
                capacityChange -= 0.1;
            } else if (pollution === 'high') {
                inflammationChange += 20;
                capacityChange -= 0.2;
            }

            // EXERCISE (tradeoff with pollution)
            if (exercise === 'none') {
                capacityChange -= 0.15;
                inflammationChange += 3;
            } else if (exercise === 'some') {
                capacityChange += 0.1;
            } else if (exercise === 'daily') {
                capacityChange += 0.25;
                if (pollution === 'high') {
                    inflammationChange += 15;
                    capacityChange -= 0.1;
                } else if (pollution === 'medium') {
                    inflammationChange += 8;
                }
            }

            // INDOORS (tradeoff: protects but sedentary)
            if (indoors === 'none') {
                if (pollution === 'high') inflammationChange += 10;
                else if (pollution === 'medium') inflammationChange += 5;
            } else if (indoors === 'some') {
                if (pollution === 'high') inflammationChange -= 5;
            } else if (indoors === 'allday') {
                if (pollution === 'high') inflammationChange -= 12;
                else if (pollution === 'medium') inflammationChange -= 6;
                capacityChange -= 0.08;
            }

            // CONSECUTIVE HIGH INFLAMMATION = SCAR
            const projectedInflammation = Math.max(0, Math.min(100, state.inflammation + inflammationChange));
            if (projectedInflammation > 50) {
                if (state.highInflammationYears >= 1) {
                    scarChange += 8;
                }
            }

            const maxRecoverable = state.maxCapacity * (1 - state.scarLevel / 100);
            
            return {
                capacityChange,
                inflammationChange,
                scarChange,
                maxRecoverable,
                choiceString: buildChoiceString()
            };
        }

        function buildChoiceString() {
            const { vaping, pollution, exercise, indoors } = state.selections;
            const parts = [];
            
            if (vaping !== 'never') parts.push(`Vape: ${vaping}`);
            if (pollution !== 'low') parts.push(`Poll: ${pollution}`);
            if (exercise !== 'some') parts.push(`Exer: ${exercise}`);
            if (indoors !== 'some') parts.push(`In: ${indoors}`);
            
            if (parts.length === 0) return 'Balanced choices';
            return parts.slice(0, 2).join(', ');
        }

        // ==================== EFFECT PREVIEW ====================
        function updateEffectPreview() {
            const effects = calculateEffects();
            
            let html = '';
            
            const capSign = effects.capacityChange >= 0 ? '+' : '';
            const capClass = effects.capacityChange >= 0 ? 'effect-positive' : 'effect-negative';
            html += `<div class="effect-row"><span>Capacity:</span><span class="${capClass}">${capSign}${effects.capacityChange.toFixed(2)} L</span></div>`;
            
            const infSign = effects.inflammationChange >= 0 ? '+' : '';
            const infClass = effects.inflammationChange <= 0 ? 'effect-positive' : 'effect-negative';
            html += `<div class="effect-row"><span>Inflammation:</span><span class="${infClass}">${infSign}${effects.inflammationChange}%</span></div>`;
            
            if (effects.scarChange > 0) {
                html += `<div class="effect-row"><span>‚ö†Ô∏è Scar:</span><span class="effect-negative">+${effects.scarChange}%</span></div>`;
            }
            
            el.previewContent.innerHTML = html;
            el.effectPreview.classList.add('active');
        }

        // ==================== RUN YEAR ====================
        function runYear() {
            state.gamePhase = 'run';
            el.runBtn.disabled = true;
            el.effectPreview.classList.remove('active');

            const effects = calculateEffects();
            
            state.lungCapacity = Math.max(0.5, Math.min(effects.maxRecoverable, state.lungCapacity + effects.capacityChange));
            state.inflammation = Math.max(0, Math.min(100, state.inflammation + effects.inflammationChange));
            state.scarLevel = Math.min(100, state.scarLevel + effects.scarChange);
            
            if (state.inflammation > 50) {
                state.highInflammationYears++;
            } else {
                state.highInflammationYears = 0;
            }

            recordData(effects.choiceString);
            
            updateAlveoliStates();
            updateAlveoli();
            updateLungColors();
            updateUI();
            animateEffects(effects);

            setTimeout(() => {
                el.nextBtn.disabled = false;
                checkWinLose();
            }, 1200);
        }

        function checkWinLose() {
            const failed = state.lungCapacity < 4.0 || state.scarLevel >= 40;
            
            if (state.year === state.requiredYears && !state.completedRequired) {
                state.completedRequired = true;
                if (failed) {
                    showModal('warning', '‚ö†Ô∏è', 'Goal Not Met!', 
                        `Capacity: ${state.lungCapacity.toFixed(1)}L or Scar: ${Math.round(state.scarLevel)}%. Keep trying!`);
                } else {
                    showModal('success', 'üéâ', 'Required Complete!', 
                        'Great job! Continue for extra credit?');
                }
            } else if (state.year === state.maxYears) {
                if (failed) {
                    showModal('fail', 'üòî', 'Simulation Complete', 
                        `Final: ${state.lungCapacity.toFixed(1)}L capacity, ${Math.round(state.scarLevel)}% scarring.`);
                } else {
                    showModal('bonus', 'üèÜ', 'Extra Credit Complete!', 
                        'Amazing work protecting your lungs!');
                }
            } else if (failed) {
                showStatus('‚ö†Ô∏è Warning: Below healthy levels!', 'danger');
            }
        }

        // ==================== VISUAL UPDATES ====================
        function updateAlveoliStates() {
            const scarCount = Math.floor(alveoliStates.length * state.scarLevel / 100);
            const inflamedCount = Math.floor(alveoliStates.length * state.inflammation / 150);
            
            alveoliStates = alveoliPositions.map((_, i) => {
                if (i < scarCount) return 'scarred';
                if (i < scarCount + inflamedCount) return 'inflamed';
                return 'healthy';
            });
        }

        function updateAlveoli() {
            const alveoli = el.alveoliContainer.querySelectorAll('.alveolus');
            alveoli.forEach((alv, i) => {
                alv.className = 'alveolus ' + alveoliStates[i];
            });
        }

        function updateLungColors() {
            const health = state.lungCapacity / state.maxCapacity;
            const scar = state.scarLevel / 100;
            
            let r1, g1, b1;
            if (scar > 0.4) {
                r1 = 120; g1 = 120; b1 = 120;
            } else if (health > 0.7) {
                r1 = 254; g1 = 200; b1 = 200;
            } else if (health > 0.5) {
                r1 = 220; g1 = 180; b1 = 180;
            } else {
                r1 = 180; g1 = 160; b1 = 160;
            }
            
            ['lung-left-stop1', 'lung-left-stop2', 'lung-right-stop1', 'lung-right-stop2'].forEach(id => {
                document.getElementById(id).style.stopColor = `rgb(${r1},${g1},${b1})`;
            });
        }

        function animateEffects(effects) {
            if (effects.capacityChange > 0) {
                el.statCapacity.classList.add('flash-green');
                spawnParticles('heal', 4);
            } else if (effects.capacityChange < 0) {
                el.statCapacity.classList.add('flash-red');
                spawnParticles('damage', 4);
            }

            if (effects.scarChange > 0) {
                el.statScar.classList.add('flash-red');
                spawnParticles('smoke', 6);
            }

            if (state.inflammation > 60) {
                el.inflammationRing.className = 'inflammation-ring high';
            } else if (state.inflammation > 30) {
                el.inflammationRing.className = 'inflammation-ring medium';
            } else if (state.inflammation > 10) {
                el.inflammationRing.className = 'inflammation-ring low';
            } else {
                el.inflammationRing.className = 'inflammation-ring';
            }

            setTimeout(() => {
                el.statCapacity.classList.remove('flash-green', 'flash-red');
                el.statScar.classList.remove('flash-red');
            }, 500);
        }

        function spawnParticles(type, count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const p = document.createElement('div');
                    p.className = `particle ${type}-particle`;
                    p.style.left = (120 + Math.random() * 140) + 'px';
                    p.style.top = (80 + Math.random() * 160) + 'px';
                    p.style.width = p.style.height = (8 + Math.random() * 12) + 'px';
                    el.particleContainer.appendChild(p);
                    setTimeout(() => p.remove(), 3000);
                }, i * 80);
            }
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            el.capacityValue.textContent = state.lungCapacity.toFixed(1) + ' L';
            el.scarValue.textContent = Math.round(state.scarLevel) + '%';
            el.yearValue.textContent = state.year;
            el.inflamValue.textContent = Math.round(state.inflammation) + '%';
            
            el.capacityBar.style.width = (state.lungCapacity / state.maxCapacity * 100) + '%';
            el.scarBar.style.width = state.scarLevel + '%';
            el.inflammationBar.style.width = state.inflammation + '%';
            
            el.capacityText.textContent = `${state.lungCapacity.toFixed(1)} / ${state.maxCapacity} L`;
            el.scarText.textContent = Math.round(state.scarLevel) + '%';
            el.inflammationText.textContent = Math.round(state.inflammation) + '%';
            
            el.yearBadge.textContent = `Year ${state.year} of ${state.maxYears}`;
            
            if (state.highInflammationYears >= 1 && state.inflammation > 40) {
                el.consecutiveWarning.classList.add('active');
            } else {
                el.consecutiveWarning.classList.remove('active');
            }
            
            el.capacityValue.style.color = state.lungCapacity < 4 ? '#f87171' : 
                                           state.lungCapacity < 4.5 ? '#fbbf24' : '#60a5fa';
            el.scarValue.style.color = state.scarLevel >= 40 ? '#f87171' : 
                                       state.scarLevel >= 30 ? '#fbbf24' : '#f87171';
            
            updateProgressBar();
        }

        function updateProgressBar() {
            let html = '';
            for (let i = 1; i <= state.maxYears; i++) {
                let cls = 'empty';
                if (i < state.year || (i === state.year && state.dataRows.length >= state.year)) {
                    cls = i <= state.requiredYears ? 'complete' : 'extra';
                } else if (i === state.year) {
                    cls = 'current';
                }
                html += `<div class="progress-segment ${cls}" style="width: 12.5%">${i}</div>`;
            }
            el.progressBar.innerHTML = html;
            
            const done = state.dataRows.length;
            el.progressText.textContent = done >= state.requiredYears ? 
                `${done} / ${state.maxYears} (Extra Credit!)` : 
                `${done} / ${state.requiredYears} Required`;
        }

        function recordData(choiceStr) {
            const row = {
                round: state.year,
                choice: choiceStr,
                capacity: state.lungCapacity.toFixed(1),
                scar: Math.round(state.scarLevel)
            };
            state.dataRows.push(row);
            
            const tr = document.createElement('tr');
            tr.className = 'highlight';
            tr.innerHTML = `<td>${row.round}</td><td>${row.choice}</td><td>${row.capacity}</td><td>${row.scar}</td>`;
            el.dataBody.appendChild(tr);
            setTimeout(() => tr.classList.remove('highlight'), 1000);
        }

        // ==================== YEAR PROGRESSION ====================
        function nextYear() {
            if (state.year >= state.maxYears) return;
            
            state.year++;
            state.gamePhase = 'select';
            
            state.selections = { vaping: 'never', pollution: 'low', exercise: 'some', indoors: 'some' };
            
            applyYearChallenge();
            
            el.runBtn.disabled = false;
            el.nextBtn.disabled = true;
            updateUI();
            updateEffectPreview();
        }

        function applyYearChallenge() {
            const challenge = yearChallenges[state.year - 1] || yearChallenges[0];
            state.challengeType = challenge.type;
            
            state.constraints = { vaping: null, pollution: null, exercise: null, indoors: null };
            
            if (challenge.lock) {
                Object.keys(challenge.lock).forEach(variable => {
                    state.constraints[variable] = challenge.lock[variable];
                    state.selections[variable] = challenge.lock[variable];
                });
            }
            
            el.challengeText.textContent = challenge.text;
            el.yearChallenge.querySelector('.challenge-title').textContent = `üìÖ Year ${state.year}`;
            
            if (challenge.type === 'wildfire') {
                el.yearChallenge.classList.add('wildfire');
            } else {
                el.yearChallenge.classList.remove('wildfire');
            }
            
            document.querySelectorAll('.control-btn').forEach(btn => {
                const variable = btn.dataset.var;
                const value = btn.dataset.val;
                
                btn.classList.remove('selected', 'locked-choice');
                btn.disabled = false;
                
                if (state.constraints[variable]) {
                    if (state.constraints[variable] === value) {
                        btn.classList.add('selected', 'locked-choice');
                    } else {
                        btn.disabled = true;
                    }
                } else if (state.selections[variable] === value) {
                    btn.classList.add('selected');
                }
            });
            
            ['vaping', 'pollution', 'exercise', 'indoors'].forEach(v => {
                const label = document.getElementById(`${v}-label`);
                if (state.constraints[v]) {
                    label.classList.add('locked');
                } else {
                    label.classList.remove('locked');
                }
            });
            
            checkInteractions();
        }

        // ==================== MODALS & MESSAGES ====================
        function showModal(type, icon, title, text) {
            el.modalIcon.textContent = icon;
            el.modalTitle.textContent = title;
            el.modalText.textContent = text;
            el.modalCapacity.textContent = state.lungCapacity.toFixed(1) + ' L';
            el.modalScar.textContent = Math.round(state.scarLevel) + '%';
            
            el.modalContinue.style.display = (type === 'success' && state.year < state.maxYears) ? 'inline-block' : 'none';
            el.modalOverlay.classList.add('active');
        }

        function closeModal() {
            el.modalOverlay.classList.remove('active');
        }

        function continueForBonus() {
            closeModal();
            nextYear();
        }

        function showStatus(text, type) {
            el.statusMessage.textContent = text;
            el.statusMessage.className = 'status-message ' + type;
            el.statusMessage.style.display = 'block';
            setTimeout(() => el.statusMessage.style.display = 'none', 3000);
        }

        function newRun() {
            state.year = 1;
            state.lungCapacity = 6.0;
            state.scarLevel = 0;
            state.inflammation = 0;
            state.highInflammationYears = 0;
            state.gamePhase = 'select';
            state.completedRequired = false;
            state.dataRows = [];
            state.selections = { vaping: 'never', pollution: 'low', exercise: 'some', indoors: 'some' };
            
            alveoliStates = alveoliPositions.map(() => 'healthy');
            el.dataBody.innerHTML = '';
            el.inflammationRing.className = 'inflammation-ring';
            el.consecutiveWarning.classList.remove('active');
            
            createAlveoli();
            updateLungColors();
            applyYearChallenge();
            el.runBtn.disabled = false;
            el.nextBtn.disabled = true;
            updateUI();
            updateEffectPreview();
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
