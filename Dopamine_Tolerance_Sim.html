<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad's Simulation: Dopamine Tolerance</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#0a0620;color:#e2e0ff;font-family:'Rajdhani',sans-serif;overflow:hidden;height:100vh;width:100vw;}

/* ===== INTRO SCREEN ===== */
#intro{position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 30%,rgba(88,28,135,0.25) 0%,#0a0620 70%);transition:opacity 0.6s ease;overflow-y:auto;}
#intro.hidden{opacity:0;pointer-events:none;}
.intro-inner{max-width:580px;width:90%;padding:30px 0;text-align:center;}
.intro-title{font-family:'Orbitron',sans-serif;font-size:clamp(28px,5vw,40px);font-weight:900;background:linear-gradient(135deg,#c084fc,#818cf8,#60a5fa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:4px;line-height:1.1;}
.intro-sub{font-size:14px;color:rgba(196,181,253,0.6);margin-bottom:22px;}

.hook-box{background:linear-gradient(135deg,rgba(99,102,241,0.25),rgba(139,92,246,0.2));border:1px solid rgba(139,92,246,0.3);border-radius:16px;padding:18px 24px;margin-bottom:24px;position:relative;overflow:hidden;}
.hook-box::before{content:'';position:absolute;inset:-2px;border-radius:18px;background:linear-gradient(135deg,rgba(139,92,246,0.4),rgba(96,165,250,0.3),rgba(139,92,246,0.4));z-index:-1;filter:blur(1px);}
.hook-text{font-size:clamp(16px,2.5vw,20px);font-weight:600;color:#e2e0ff;line-height:1.4;}

.vocab-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;}
.vocab-card{background:rgba(15,12,40,0.8);border-radius:14px;padding:16px 10px 14px;border:2px solid;position:relative;transition:transform 0.3s,box-shadow 0.3s;}
.vocab-card:hover{transform:translateY(-3px);}
.vocab-card.c1{border-color:rgba(250,204,21,0.35);}
.vocab-card.c1:hover{box-shadow:0 0 20px rgba(250,204,21,0.15);}
.vocab-card.c2{border-color:rgba(96,165,250,0.35);}
.vocab-card.c2:hover{box-shadow:0 0 20px rgba(96,165,250,0.15);}
.vocab-card.c3{border-color:rgba(248,113,113,0.35);}
.vocab-card.c3:hover{box-shadow:0 0 20px rgba(248,113,113,0.15);}
.vocab-icon{font-size:28px;margin-bottom:6px;}
.vocab-term{font-family:'Orbitron',sans-serif;font-size:15px;font-weight:700;margin-bottom:3px;}
.vocab-card.c1 .vocab-term{color:#facc15;}
.vocab-card.c2 .vocab-term{color:#60a5fa;}
.vocab-card.c3 .vocab-term{color:#f87171;}
.vocab-def{font-size:12px;color:rgba(196,181,253,0.65);line-height:1.3;}

.nuance-box{background:rgba(15,12,40,0.6);border:1px solid rgba(139,92,246,0.15);border-radius:14px;padding:16px;margin-bottom:20px;text-align:left;}
.nuance-title{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;color:#c084fc;letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;text-align:center;}
.nuance-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:13px;font-weight:600;}
.nuance-row:last-child{margin-bottom:0;}
.nuance-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.nuance-dot.red{background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4);}
.nuance-dot.blue{background:#3b82f6;box-shadow:0 0 8px rgba(59,130,246,0.4);}
.nuance-dot.green{background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,0.4);}
.nuance-text{color:rgba(226,224,255,0.8);}
.nuance-text strong{color:#fff;}

.mission-badge{display:inline-block;padding:10px 28px;border-radius:30px;font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(16,185,129,0.15));border:1px solid rgba(34,197,94,0.35);color:#4ade80;letter-spacing:1px;margin-bottom:18px;}

.begin-btn{display:inline-block;padding:14px 48px;border-radius:14px;font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;cursor:pointer;border:none;background:linear-gradient(135deg,#7c3aed,#6366f1,#7c3aed);color:#fff;box-shadow:0 4px 25px rgba(124,58,237,0.4),inset 0 1px 0 rgba(255,255,255,0.15);transition:all 0.3s;letter-spacing:1px;position:relative;overflow:hidden;}
.begin-btn:hover{transform:translateY(-2px);box-shadow:0 8px 35px rgba(124,58,237,0.5);}
.begin-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transform:translateX(-100%);animation:btnShine 3s ease-in-out infinite;}
@keyframes btnShine{0%,100%{transform:translateX(-100%);}50%{transform:translateX(100%);}}

/* ===== SIM SCREEN ===== */
#sim{display:none;flex-direction:column;height:100vh;width:100vw;}
#sim.active{display:flex;}

.header{text-align:center;padding:5px 16px;background:linear-gradient(135deg,rgba(88,28,135,0.5) 0%,rgba(15,10,40,0.9) 50%,rgba(88,28,135,0.5) 100%);border-bottom:2px solid rgba(139,92,246,0.3);box-shadow:0 4px 30px rgba(88,28,135,0.4);z-index:10;}
.header h1{font-family:'Orbitron',sans-serif;font-size:15px;font-weight:900;color:#fff;text-shadow:0 0 20px rgba(139,92,246,0.6);}
.header .sub{font-size:10px;color:rgba(196,181,253,0.6);}
.header .goal{display:inline-block;margin-top:2px;padding:2px 10px;border-radius:20px;font-size:9px;font-weight:700;background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.35);color:#c4b5fd;}

.main{flex:1;display:flex;gap:7px;padding:7px;min-height:0;}
.left{width:180px;min-width:180px;display:flex;flex-direction:column;gap:5px;}
.pbox{background:rgba(15,10,35,0.8);border:1px solid rgba(139,92,246,0.15);border-radius:11px;padding:9px;backdrop-filter:blur(10px);}
.plabel{font-family:'Orbitron',sans-serif;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:#c084fc;text-align:center;margin-bottom:3px;}
.rdisp{text-align:center;margin-bottom:5px;}
.rdisp .hint{font-size:9px;color:rgba(167,139,250,0.45);}
.rdisp .num{font-family:'Orbitron',sans-serif;font-size:30px;font-weight:900;color:#fff;text-shadow:0 0 15px rgba(139,92,246,0.5);}
.rdisp .of{font-size:14px;color:rgba(167,139,250,0.4);font-weight:700;}

.dbtn{display:block;width:100%;padding:8px 5px;margin-bottom:4px;border-radius:8px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;border:2px solid;text-align:center;}
.dbtn:disabled{opacity:0.3;cursor:not-allowed;filter:grayscale(0.5);}
.dbtn .ds{display:block;font-size:9px;font-weight:500;opacity:0.75;}
.dbtn.n{border-color:#6b7280;color:#9ca3af;background:rgba(107,114,128,0.08);}
.dbtn.n:hover:not(:disabled){background:rgba(107,114,128,0.25);box-shadow:0 0 12px rgba(107,114,128,0.3);}
.dbtn.l{border-color:#22c55e;color:#4ade80;background:rgba(34,197,94,0.06);}
.dbtn.l:hover:not(:disabled){background:rgba(34,197,94,0.25);box-shadow:0 0 12px rgba(34,197,94,0.3);}
.dbtn.m{border-color:#eab308;color:#facc15;background:rgba(234,179,8,0.06);}
.dbtn.m:hover:not(:disabled){background:rgba(234,179,8,0.25);box-shadow:0 0 12px rgba(234,179,8,0.3);}
.dbtn.h{border-color:#ef4444;color:#f87171;background:rgba(239,68,68,0.06);}
.dbtn.h:hover:not(:disabled){background:rgba(239,68,68,0.25);box-shadow:0 0 12px rgba(239,68,68,0.3);}

.nbtn{display:block;width:100%;padding:8px;border-radius:8px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;border:none;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;box-shadow:0 4px 12px rgba(34,197,94,0.3);margin-top:2px;transition:all 0.2s;}
.nbtn:disabled{background:rgba(50,40,80,0.3);color:rgba(150,140,180,0.3);box-shadow:none;opacity:0.4;cursor:not-allowed;}
.rbtn{display:block;width:100%;padding:5px;border-radius:8px;font-size:10px;font-weight:700;cursor:pointer;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.1);color:#f87171;margin-top:2px;}

.msgbox{text-align:center;font-size:11px;font-weight:600;color:#c4b5fd;min-height:48px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1px;line-height:1.25;}
.msgbox .w{color:#f87171;font-weight:700;font-size:10px;}
.msgbox .ho{color:#38bdf8;font-weight:700;font-size:10px;}
.msgbox .dep{color:#60a5fa;font-weight:700;font-size:10px;}

.center{flex:1;display:flex;flex-direction:column;gap:5px;min-width:0;}
.arena{flex:1;position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(139,92,246,0.2);box-shadow:0 0 30px rgba(88,28,135,0.3);}
.arena canvas{display:block;width:100%;height:100%;}

/* Mood Meter */
.mood-box{border-radius:10px;padding:6px 12px;background:rgba(15,10,35,0.8);border:1px solid rgba(139,92,246,0.15);display:flex;gap:12px;align-items:center;}
.meter-col{flex:1;}
.meter-label-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;}
.meter-lbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;transition:color 0.5s;}
.meter-val{font-family:'Orbitron',sans-serif;font-size:15px;font-weight:900;transition:color 0.5s;}
.meter-track{height:12px;border-radius:20px;background:rgba(30,20,60,0.8);box-shadow:inset 0 2px 4px rgba(0,0,0,0.4);overflow:hidden;position:relative;}
.meter-fill{height:100%;border-radius:20px;transition:width 0.8s cubic-bezier(0.34,1.56,0.64,1),background 0.5s;position:relative;}
.meter-fill::after{content:'';position:absolute;inset:0;border-radius:20px;background:linear-gradient(180deg,rgba(255,255,255,0.15) 0%,transparent 50%);}

.right{width:195px;min-width:195px;display:flex;flex-direction:column;gap:5px;}
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.sbox{text-align:center;padding:5px 2px;border-radius:9px;background:rgba(15,10,35,0.7);border:1px solid rgba(139,92,246,0.12);}
.sv{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;transition:color 0.5s;}
.sl{font-size:7px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:rgba(167,139,250,0.5);margin-top:1px;}

.progbox{padding:6px 8px;}
.progtop{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;}
.progl{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:rgba(167,139,250,0.5);}
.progc{font-size:9px;font-weight:700;}
.progtrack{height:5px;border-radius:10px;background:rgba(30,20,60,0.8);overflow:hidden;}
.progfill{height:100%;border-radius:10px;transition:width 0.5s,background 0.5s;}
.progmsg{text-align:center;font-size:8px;font-weight:700;color:#4ade80;margin-top:2px;}

.dbox{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0;}
.dhdr{padding:5px;text-align:center;font-family:'Orbitron',sans-serif;font-size:8px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#c4b5fd;background:rgba(88,28,135,0.35);border-bottom:1px solid rgba(139,92,246,0.15);}
.dscroll{flex:1;overflow-y:auto;}
.dscroll table{width:100%;border-collapse:collapse;font-size:10px;}
.dscroll th{padding:4px 2px;font-weight:700;color:#c084fc;background:rgba(88,28,135,0.2);border-bottom:1px solid rgba(139,92,246,0.15);position:sticky;top:0;text-align:center;font-size:9px;}
.dscroll td{padding:4px 2px;text-align:center;font-weight:600;border-bottom:1px solid rgba(139,92,246,0.06);}
.dscroll tr:nth-child(even) td{background:rgba(30,20,60,0.2);}
.dempty{padding:20px;text-align:center;color:rgba(167,139,250,0.25);font-size:10px;}

.qover{position:absolute;inset:0;background:rgba(5,3,17,0.88);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:20;border-radius:12px;}
.qover.show{display:flex;}
.qcard{text-align:center;padding:22px;border-radius:16px;background:linear-gradient(135deg,rgba(88,28,135,0.7) 0%,rgba(20,15,50,0.9) 100%);border:1px solid rgba(139,92,246,0.3);box-shadow:0 0 40px rgba(139,92,246,0.25);max-width:260px;}
.qbadge{font-family:'Orbitron',sans-serif;font-size:8px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#c084fc;margin-bottom:6px;}
.qtxt{font-size:14px;font-weight:700;color:#fff;margin-bottom:12px;line-height:1.3;}
.qdismiss{padding:6px 20px;border-radius:30px;border:none;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;box-shadow:0 4px 15px rgba(124,58,237,0.4);}

@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}
@keyframes pulse{0%,100%{opacity:0.6}50%{opacity:1}}
</style>
</head>
<body>

<!-- ===== INTRO SCREEN ===== -->
<div id="intro">
  <div class="intro-inner">
    <div class="intro-title">Dopamine Tolerance</div>
    <div class="intro-sub">Mr. Jawad's Simulation</div>

    <div class="hook-box">
      <div class="hook-text">Why does the first hit feel amazing but the tenth feels like nothing?</div>
    </div>

    <div class="vocab-grid">
      <div class="vocab-card c1">
        <div class="vocab-icon">âœ¨</div>
        <div class="vocab-term">Dopamine</div>
        <div class="vocab-def">Feel-good chemical your brain releases</div>
      </div>
      <div class="vocab-card c2">
        <div class="vocab-icon">ðŸŽ¯</div>
        <div class="vocab-term">Receptors</div>
        <div class="vocab-def">Brain catchers that grab dopamine</div>
      </div>
      <div class="vocab-card c3">
        <div class="vocab-icon">ðŸ“‰</div>
        <div class="vocab-term">Tolerance</div>
        <div class="vocab-def">Needing more to feel the same</div>
      </div>
    </div>

    <div class="nuance-box">
      <div class="nuance-title">The Challenge</div>
      <div class="nuance-row">
        <div class="nuance-dot red"></div>
        <div class="nuance-text"><strong>Too much dopamine</strong> â†’ brain removes receptors (tolerance)</div>
      </div>
      <div class="nuance-row">
        <div class="nuance-dot blue"></div>
        <div class="nuance-text"><strong>Too little dopamine</strong> â†’ mood crashes (depression risk)</div>
      </div>
      <div class="nuance-row">
        <div class="nuance-dot green"></div>
        <div class="nuance-text"><strong>Find the balance</strong> â†’ keep your brain healthy</div>
      </div>
    </div>

    <div class="mission-badge">MISSION: Keep receptors balanced</div>
    <br>
    <button class="begin-btn" onclick="startSim()">BEGIN SIMULATION</button>
  </div>
</div>

<!-- ===== SIM SCREEN ===== -->
<div id="sim">
  <div class="header">
    <h1>Mr. Jawad's Simulation: Dopamine Tolerance</h1>
    <div class="sub">How repeated flooding changes your brain</div>
    <div class="goal">Goal: Keep receptors balanced â€” avoid tolerance AND depression</div>
  </div>
  <div class="main">
    <div class="left">
      <div class="pbox">
        <div class="plabel">Dose Control</div>
        <div class="rdisp"><div class="hint">Round</div><span class="num" id="rNum">1</span><span class="of">/ 8</span></div>
        <button class="dbtn n" id="bN" onclick="go('NONE')">NONE<span class="ds">(+1 receptor, mood drops)</span></button>
        <button class="dbtn l" id="bL" onclick="go('LOW')">LOW<span class="ds">(safe, steady mood)</span></button>
        <button class="dbtn m" id="bM" onclick="go('MEDIUM')">MEDIUM<span class="ds">(âˆ’1 receptor)</span></button>
        <button class="dbtn h" id="bH" onclick="go('HIGH')">HIGH<span class="ds">(âˆ’2 receptors)</span></button>
        <button class="nbtn" id="bNext" onclick="nextRound()" disabled>NEXT ROUND</button>
        <button class="rbtn" onclick="resetSim()">RESET</button>
      </div>
      <div class="pbox msgbox" id="msg">Choose your dose level</div>
    </div>
    <div class="center">
      <div class="arena" id="arenaBox">
        <canvas id="C"></canvas>
        <div class="qover" id="qOver">
          <div class="qcard">
            <div class="qbadge">Question</div>
            <div class="qtxt" id="qTxt"></div>
            <button class="qdismiss" onclick="dismissQ()">Got It!</button>
          </div>
        </div>
      </div>
      <!-- Two meters: Feel Good + Mood -->
      <div class="mood-box">
        <div class="meter-col">
          <div class="meter-label-row"><span class="meter-lbl" id="fL" style="color:#6b7280">Feel Good</span><span class="meter-val" id="fV" style="color:#6b7280">0</span></div>
          <div class="meter-track"><div class="meter-fill" id="fF" style="width:0%;background:#374151"></div></div>
        </div>
        <div class="meter-col">
          <div class="meter-label-row"><span class="meter-lbl" id="mL" style="color:#60a5fa">Mood</span><span class="meter-val" id="mV" style="color:#60a5fa">7</span></div>
          <div class="meter-track"><div class="meter-fill" id="mF" style="width:70%;background:linear-gradient(90deg,#3b82f6,#60a5fa)"></div></div>
        </div>
      </div>
    </div>
    <div class="right">
      <div class="sgrid">
        <div class="sbox"><div class="sv" id="sScore" style="color:#4ade80">0</div><div class="sl">Score</div></div>
        <div class="sbox"><div class="sv" id="sRec" style="color:#a78bfa">10</div><div class="sl">Receptors</div></div>
        <div class="sbox"><div class="sv" id="sStrk" style="color:#38bdf8">0</div><div class="sl">Streak</div></div>
        <div class="sbox"><div class="sv" id="sComp" style="color:#c084fc">0</div><div class="sl">Complete</div></div>
      </div>
      <div class="pbox progbox">
        <div class="progtop"><span class="progl">Progress</span><span class="progc" id="pC" style="color:#c4b5fd">0/5 req</span></div>
        <div class="progtrack"><div class="progfill" id="pF" style="width:0%;background:linear-gradient(90deg,#7c3aed,#a78bfa)"></div></div>
        <div class="progmsg" id="pM" style="display:none"></div>
      </div>
      <div class="pbox dbox">
        <div class="dhdr">Your Data</div>
        <div class="dscroll"><table><thead><tr><th>Rnd</th><th>Dose</th><th>Feel</th><th>Rec</th><th>Mood</th></tr></thead><tbody id="dB"><tr><td colspan="5" class="dempty">No data yet</td></tr></tbody></table></div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== INTRO =====
function startSim(){
  document.getElementById("intro").classList.add("hidden");
  setTimeout(()=>{document.getElementById("intro").style.display="none";document.getElementById("sim").classList.add("active");resize();},600);
}

// ===== STATE =====
const MR=8,REQ=5,IR=10;
const DC={
  NONE:{label:"None",color:"#9ca3af",dop:0,feel:0,rd:1,moodD:-2,glow:"#6b7280"},
  LOW:{label:"Low",color:"#4ade80",dop:5,feel:3,rd:0,moodD:1,glow:"#22c55e"},
  MEDIUM:{label:"Medium",color:"#facc15",dop:8,feel:6,rd:-1,moodD:0,glow:"#eab308"},
  HIGH:{label:"High",color:"#f87171",dop:14,feel:10,rd:-2,moodD:-1,glow:"#ef4444"},
};
const QS={3:"What happens with HIGH doses?",5:"Can LOW doses keep you safe?",7:"What's the BEST strategy?"};
let S={rnd:1,rec:IR,fg:0,mood:7,sc:0,str:0,comp:0,data:[],phase:"choose",over:false,noneStreak:0};

// ===== CANVAS =====
const cv=document.getElementById("C"),cx=cv.getContext("2d");
let W,H,dpr;
const BX=0.50,BY=0.47,BSX=0.42,BSY=0.42;
const RWX=0.50,RWY=0.51,RWR=0.13;
const RP=[[0.43,0.43],[0.50,0.40],[0.57,0.43],[0.41,0.51],[0.50,0.49],[0.59,0.51],[0.43,0.59],[0.57,0.59],[0.47,0.55],[0.53,0.55]];
const SULCI=[{y:0.27,w:0.65},{y:0.37,w:0.60},{y:0.49,w:0.55},{y:0.59,w:0.58},{y:0.69,w:0.50}];

let recs=[],dops=[],sparks=[],pws=[],hbolts=[],ftexts=[],ambients=[],raindrops=[];
let bgc={r:139,g:92,b:246,a:0.18};
let rwPulse=0,shake={x:0,y:0,d:0};
let brainState="healthy"; // healthy, stressed, critical, depressed
let depGlow=0; // depression blue overlay intensity

function resize(){
  const r=cv.parentElement.getBoundingClientRect();
  dpr=window.devicePixelRatio||1;
  W=r.width;H=r.height;
  cv.width=W*dpr;cv.height=H*dpr;
  cv.style.width=W+"px";cv.style.height=H+"px";
  cx.setTransform(dpr,0,0,dpr,0,0);
  initE();
}
function px(rx){return rx*W;}
function py(ry){return ry*H;}

function initE(){
  recs=RP.map((p,i)=>({x:p[0],y:p[1],alive:i<S.rec,sc:i<S.rec?1:0,ts:i<S.rec?1:0,glow:0,da:0,ph:Math.random()*6.28}));
  dops=[];sparks=[];pws=[];hbolts=[];ftexts=[];raindrops=[];
  ambients=Array.from({length:25},()=>({x:Math.random(),y:Math.random(),vx:(Math.random()-0.5)*0.0003,vy:(Math.random()-0.5)*0.0003,r:Math.random()*1.5+0.5,o:Math.random()*0.12+0.04,ph:Math.random()*6.28}));
}

function brainPt(a,sx,sy){const l=1+0.03*Math.sin(a*3)+0.02*Math.cos(a*5)+0.015*Math.sin(a*7);return[BX+Math.cos(a)*sx*l,BY+Math.sin(a)*sy*l*0.95];}

// ===== DRAW =====
let lt=0;
function draw(now){
  if(!W)return requestAnimationFrame(draw);
  const dt=Math.min((now-lt)/16.67,3);lt=now;
  cx.clearRect(0,0,W,H);

  // BG
  const bgG=cx.createRadialGradient(px(BX),py(BY),0,px(BX),py(BY),py(0.65));
  bgG.addColorStop(0,`rgba(${bgc.r},${bgc.g},${bgc.b},${bgc.a*0.4})`);
  bgG.addColorStop(0.5,"rgba(15,10,40,0.12)");bgG.addColorStop(1,"rgba(5,3,17,0)");
  cx.fillStyle=bgG;cx.fillRect(0,0,W,H);

  // Depression blue overlay
  if(depGlow>0){
    const dg=cx.createRadialGradient(px(BX),py(BY),0,px(BX),py(BY),px(0.5));
    dg.addColorStop(0,`rgba(30,58,138,${depGlow*0.25})`);
    dg.addColorStop(1,`rgba(30,58,138,${depGlow*0.08})`);
    cx.fillStyle=dg;cx.fillRect(0,0,W,H);
    depGlow+=(0-depGlow)*0.01*dt;
  }

  if(shake.d>0){shake.x=(Math.random()-0.5)*shake.d*8;shake.y=(Math.random()-0.5)*shake.d*8;shake.d-=0.018*dt;}else{shake.x=0;shake.y=0;}
  cx.save();cx.translate(shake.x,shake.y);

  drawAmbient(dt);
  drawRaindrops(dt);
  drawBrain(now,dt);
  drawFolds();
  drawRewardCenter(dt);
  drawRecs(dt);
  drawDop(now,dt);
  drawHBolts(dt);
  drawSparks(dt);
  drawPWs(dt);
  drawFTexts(dt);
  drawLabels();

  cx.restore();
  requestAnimationFrame(draw);
}

function drawAmbient(dt){ambients.forEach(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.ph+=0.013*dt;if(p.x<-0.05)p.x=1.05;if(p.x>1.05)p.x=-0.05;if(p.y<-0.05)p.y=1.05;if(p.y>1.05)p.y=-0.05;cx.beginPath();cx.arc(px(p.x),py(p.y),p.r,0,Math.PI*2);cx.fillStyle=`rgba(139,92,246,${p.o*(0.5+0.5*Math.sin(p.ph))})`;cx.fill();});}

// Depression rain effect
function drawRaindrops(dt){
  if(brainState==="depressed"){
    if(Math.random()<0.3)raindrops.push({x:Math.random(),y:-0.02,sp:0.004+Math.random()*0.003,life:1});
  }
  for(let i=raindrops.length-1;i>=0;i--){
    const r=raindrops[i];r.y+=r.sp*dt;
    if(r.y>1.05){raindrops.splice(i,1);continue;}
    cx.strokeStyle="rgba(96,165,250,0.15)";cx.lineWidth=1;
    cx.beginPath();cx.moveTo(px(r.x),py(r.y));cx.lineTo(px(r.x),py(r.y+0.015));cx.stroke();
  }
}

function drawBrain(now,dt){
  cx.save();
  // Outer glow
  const og=cx.createRadialGradient(px(BX),py(BY),px(0.15),px(BX),py(BY),px(BSX+0.1));
  og.addColorStop(0,`rgba(${bgc.r},${bgc.g},${bgc.b},${bgc.a*0.6})`);og.addColorStop(1,"transparent");
  cx.fillStyle=og;cx.beginPath();cx.ellipse(px(BX),py(BY),px(BSX+0.1),py(BSY+0.1),0,0,Math.PI*2);cx.fill();

  // Brain body
  cx.beginPath();
  const pts=[];for(let a=0;a<Math.PI*2;a+=0.04)pts.push(brainPt(a,BSX,BSY));
  cx.moveTo(px(pts[0][0]),py(pts[0][1]));
  for(let i=1;i<pts.length;i++){const p=pts[i],pp=pts[i-1];cx.quadraticCurveTo(px(pp[0]),py(pp[1]),(px(pp[0])+px(p[0]))/2,(py(pp[1])+py(p[1]))/2);}
  cx.closePath();

  // Tissue fill color based on state
  const bg2=cx.createRadialGradient(px(BX),py(BY-0.03),px(0.03),px(BX),py(BY),px(BSX));
  if(brainState==="depressed"){
    bg2.addColorStop(0,"rgba(100,130,200,0.20)");bg2.addColorStop(0.4,"rgba(70,100,170,0.14)");bg2.addColorStop(1,"rgba(40,60,120,0.05)");
  }else if(brainState==="critical"){
    bg2.addColorStop(0,"rgba(220,140,140,0.20)");bg2.addColorStop(0.4,"rgba(180,100,100,0.14)");bg2.addColorStop(1,"rgba(120,50,50,0.05)");
  }else if(brainState==="stressed"){
    bg2.addColorStop(0,"rgba(210,180,140,0.20)");bg2.addColorStop(0.4,"rgba(180,150,110,0.14)");bg2.addColorStop(1,"rgba(120,90,50,0.05)");
  }else{
    bg2.addColorStop(0,"rgba(200,170,220,0.22)");bg2.addColorStop(0.4,"rgba(170,130,200,0.14)");bg2.addColorStop(1,"rgba(80,50,130,0.05)");
  }
  cx.fillStyle=bg2;cx.fill();

  // Outline with state color
  const outColor=brainState==="depressed"?"rgba(96,165,250,"+(.35+rwPulse*.15)+")":brainState==="critical"?"rgba(248,113,113,"+(.35+rwPulse*.15)+")":brainState==="stressed"?"rgba(250,204,21,"+(.30+rwPulse*.12)+")":"rgba(200,170,230,"+(.35+rwPulse*.15)+")";
  cx.strokeStyle=outColor;cx.lineWidth=2.5;cx.stroke();
  cx.strokeStyle=outColor.replace(/[\d.]+\)$/,(parseFloat(outColor.match(/[\d.]+\)$/)[0])*0.3)+")");cx.lineWidth=6;cx.stroke();

  // Fissure
  cx.beginPath();cx.moveTo(px(BX),py(BY-BSY+0.02));cx.lineTo(px(BX),py(BY+BSY-0.04));
  cx.strokeStyle="rgba(139,92,246,0.08)";cx.lineWidth=1;cx.setLineDash([5,7]);cx.stroke();cx.setLineDash([]);

  // Cerebellum + stem
  cx.beginPath();cx.ellipse(px(BX),py(BY+BSY-0.02),px(0.10),py(0.04),0,0,Math.PI*2);
  cx.strokeStyle="rgba(180,150,210,0.12)";cx.lineWidth=1;cx.stroke();cx.fillStyle="rgba(139,92,246,0.03)";cx.fill();
  cx.beginPath();cx.moveTo(px(BX-0.025),py(BY+BSY-0.01));cx.quadraticCurveTo(px(BX-0.015),py(BY+BSY+0.06),px(BX),py(BY+BSY+0.09));cx.quadraticCurveTo(px(BX+0.015),py(BY+BSY+0.06),px(BX+0.025),py(BY+BSY-0.01));
  cx.strokeStyle="rgba(180,150,210,0.15)";cx.lineWidth=2;cx.stroke();

  // Depression tears
  if(brainState==="depressed"){
    const tearY=BY+BSY*0.3;
    [BX-0.12,BX+0.12].forEach(tx=>{
      cx.beginPath();cx.ellipse(px(tx),py(tearY),2,4,0,0,Math.PI*2);
      cx.fillStyle=`rgba(96,165,250,${0.3+0.15*Math.sin(now/400)})`;cx.fill();
    });
  }

  cx.restore();
}

function drawFolds(){
  cx.save();
  SULCI.forEach(s=>{
    cx.beginPath();const sx=BX-s.w/2,ex=BX+s.w/2;
    cx.moveTo(px(sx),py(s.y));
    for(let i=1;i<=8;i++){const t=i/8;cx.lineTo(px(sx+s.w*t),py(s.y+Math.sin(t*Math.PI*3)*0.012));}
    cx.strokeStyle="rgba(180,150,210,0.11)";cx.lineWidth=1.5;cx.stroke();
  });
  cx.restore();
}

function drawRewardCenter(dt){
  rwPulse+=(0-rwPulse)*0.015*dt;
  cx.save();
  const rg=cx.createRadialGradient(px(RWX),py(RWY),0,px(RWX),py(RWY),px(RWR+0.03));
  const ri=0.10+rwPulse*0.35;
  rg.addColorStop(0,`rgba(${bgc.r},${bgc.g},${bgc.b},${ri})`);rg.addColorStop(0.6,`rgba(${bgc.r},${bgc.g},${bgc.b},${ri*0.3})`);rg.addColorStop(1,"transparent");
  cx.fillStyle=rg;cx.beginPath();cx.ellipse(px(RWX),py(RWY),px(RWR+0.03),py(RWR+0.01),0,0,Math.PI*2);cx.fill();
  cx.beginPath();cx.ellipse(px(RWX),py(RWY),px(RWR),py(RWR-0.01),0,0,Math.PI*2);
  cx.strokeStyle=`rgba(167,139,250,${0.15+rwPulse*0.25})`;cx.lineWidth=1.5;cx.setLineDash([4,6]);cx.stroke();cx.setLineDash([]);
  cx.restore();
}

function drawRecs(dt){
  recs.forEach(r=>{
    r.sc+=(r.ts-r.sc)*0.05*dt;if(r.glow>0)r.glow-=0.018*dt;r.ph+=0.025*dt;
    const x=px(r.x),y=py(r.y);
    if(r.sc<0.05&&!r.alive){
      cx.save();cx.strokeStyle="rgba(239,68,68,0.18)";cx.setLineDash([2,3]);cx.lineWidth=1;
      cx.beginPath();cx.arc(x,y,9,0,Math.PI*2);cx.stroke();cx.setLineDash([]);
      cx.strokeStyle="rgba(239,68,68,0.22)";cx.lineWidth=1.5;
      cx.beginPath();cx.moveTo(x-4,y-4);cx.lineTo(x+4,y+4);cx.moveTo(x+4,y-4);cx.lineTo(x-4,y+4);cx.stroke();cx.restore();return;
    }
    cx.save();cx.translate(x,y);cx.scale(r.sc,r.sc);
    const gi=0.12+r.glow*0.6+Math.sin(r.ph)*0.04;
    const gg=cx.createRadialGradient(0,0,0,0,0,22);gg.addColorStop(0,`rgba(167,139,250,${gi})`);gg.addColorStop(1,"transparent");
    cx.fillStyle=gg;cx.beginPath();cx.arc(0,0,22,0,Math.PI*2);cx.fill();
    const bright=r.glow>0.3;cx.lineWidth=3.5;cx.lineCap="round";
    cx.strokeStyle=bright?`rgba(220,200,255,${0.75+r.glow*0.25})`:"rgba(167,139,250,0.65)";
    cx.beginPath();cx.moveTo(0,10);cx.lineTo(0,-1);cx.stroke();
    cx.beginPath();cx.moveTo(0,-1);cx.quadraticCurveTo(-4,-7,-10,-12);cx.stroke();
    cx.beginPath();cx.moveTo(0,-1);cx.quadraticCurveTo(4,-7,10,-12);cx.stroke();
    const bgi=0.5+r.glow*0.5+Math.sin(r.ph)*0.12;
    cx.fillStyle=`rgba(220,200,255,${bgi})`;cx.beginPath();cx.arc(-10,-12,3.5,0,Math.PI*2);cx.fill();cx.beginPath();cx.arc(10,-12,3.5,0,Math.PI*2);cx.fill();
    cx.fillStyle=`rgba(139,92,246,${0.35+r.glow*0.4})`;cx.beginPath();cx.arc(0,1,3,0,Math.PI*2);cx.fill();
    cx.restore();
  });
}

function drawDop(now,dt){
  for(let i=dops.length-1;i>=0;i--){
    const m=dops[i];if(now<m.st)continue;m.p+=m.spd*dt;
    if(m.p>=1){if(m.slot&&m.slot.alive){m.slot.glow=1.0;rwPulse=0.9;for(let s=0;s<7;s++)sparks.push({x:px(m.tx),y:py(m.ty),vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,life:1,color:m.color,sz:2+Math.random()*2});}pws.push({x:px(m.tx),y:py(m.ty),r:0,life:1,color:m.color});dops.splice(i,1);continue;}
    const t=m.p,ease=t<0.5?2*t*t:-1+(4-2*t)*t;
    const wb=Math.sin(t*Math.PI*4+m.wph)*m.wamp*(1-t);
    const mx=m.sx+(m.tx-m.sx)*ease+wb/W,my=m.sy+(m.ty-m.sy)*ease;
    m.trail.push({x:mx,y:my,life:1});if(m.trail.length>10)m.trail.shift();
    m.trail.forEach(tp=>{tp.life-=0.06*dt;if(tp.life<=0)return;cx.beginPath();cx.arc(px(tp.x),py(tp.y),m.sz*0.35*tp.life,0,Math.PI*2);cx.fillStyle=m.color+Math.floor(tp.life*45).toString(16).padStart(2,'0');cx.fill();});
    const xx=px(mx),yy=py(my);
    const gg2=cx.createRadialGradient(xx,yy,0,xx,yy,m.sz*3.5);gg2.addColorStop(0,m.color+"50");gg2.addColorStop(1,"transparent");cx.fillStyle=gg2;cx.beginPath();cx.arc(xx,yy,m.sz*3.5,0,Math.PI*2);cx.fill();
    cx.save();cx.translate(xx,yy);cx.rotate(t*Math.PI*2);cx.beginPath();
    for(let v=0;v<6;v++){const a=(Math.PI*2/6)*v-Math.PI/2;v===0?cx.moveTo(Math.cos(a)*m.sz,Math.sin(a)*m.sz):cx.lineTo(Math.cos(a)*m.sz,Math.sin(a)*m.sz);}
    cx.closePath();cx.fillStyle=m.color;cx.shadowColor=m.color;cx.shadowBlur=12;cx.fill();cx.shadowBlur=0;
    cx.fillStyle="rgba(255,255,255,0.30)";cx.beginPath();cx.arc(-m.sz*0.2,-m.sz*0.2,m.sz*0.3,0,Math.PI*2);cx.fill();cx.restore();
  }
}

function drawHBolts(dt){for(let i=hbolts.length-1;i>=0;i--){const b=hbolts[i];b.life-=0.01*dt;if(b.life<=0){hbolts.splice(i,1);continue;}const a=Math.min(b.life,1);cx.save();cx.strokeStyle=`rgba(${b.cr},${b.cg},${b.cb},${a*0.85})`;cx.lineWidth=3*a;cx.shadowColor=`rgba(${b.cr},${b.cg},${b.cb},0.7)`;cx.shadowBlur=14*a;cx.lineCap="round";cx.beginPath();cx.moveTo(px(b.pts[0][0]),py(b.pts[0][1]));for(let j=1;j<b.pts.length;j++)cx.lineTo(px(b.pts[j][0]),py(b.pts[j][1]));cx.stroke();cx.shadowBlur=0;const tip=b.pts[b.pts.length-1];const sg=cx.createRadialGradient(px(tip[0]),py(tip[1]),0,px(tip[0]),py(tip[1]),10*a);sg.addColorStop(0,`rgba(${b.cr},${b.cg},${b.cb},${a*0.6})`);sg.addColorStop(1,"transparent");cx.fillStyle=sg;cx.beginPath();cx.arc(px(tip[0]),py(tip[1]),10*a,0,Math.PI*2);cx.fill();cx.restore();}}
function drawSparks(dt){for(let i=sparks.length-1;i>=0;i--){const s=sparks[i];s.x+=s.vx*dt;s.y+=s.vy*dt;s.vy+=0.1*dt;s.life-=0.022*dt;if(s.life<=0){sparks.splice(i,1);continue;}cx.beginPath();cx.arc(s.x,s.y,s.sz*s.life,0,Math.PI*2);cx.fillStyle=s.color+Math.floor(s.life*255).toString(16).padStart(2,'0');cx.shadowColor=s.color;cx.shadowBlur=6;cx.fill();cx.shadowBlur=0;}}
function drawPWs(dt){for(let i=pws.length-1;i>=0;i--){const p=pws[i];p.r+=1.5*dt;p.life-=0.022*dt;if(p.life<=0){pws.splice(i,1);continue;}cx.beginPath();cx.arc(p.x,p.y,p.r,0,Math.PI*2);cx.strokeStyle=p.color+Math.floor(p.life*70).toString(16).padStart(2,'0');cx.lineWidth=2*p.life;cx.stroke();}}
function drawFTexts(dt){for(let i=ftexts.length-1;i>=0;i--){const f=ftexts[i];f.y-=0.35*dt;f.life-=0.01*dt;if(f.life<=0){ftexts.splice(i,1);continue;}cx.save();cx.font=`bold ${f.size}px 'Rajdhani',sans-serif`;cx.textAlign="center";cx.fillStyle=f.color+Math.floor(Math.min(f.life,1)*255).toString(16).padStart(2,'0');cx.shadowColor=f.color;cx.shadowBlur=8*Math.min(f.life,1);cx.fillText(f.text,f.x,f.y);cx.shadowBlur=0;cx.restore();}}

function drawLabels(){
  cx.save();cx.font="900 12px 'Orbitron',sans-serif";cx.textAlign="center";
  // Brain state emoji + label
  let stateLabel,stateColor;
  if(brainState==="depressed"){stateLabel="ðŸ˜”  YOUR BRAIN  ðŸ˜”";stateColor="rgba(96,165,250,0.6)";}
  else if(brainState==="critical"){stateLabel="ðŸ˜°  YOUR BRAIN  ðŸ˜°";stateColor="rgba(248,113,113,0.6)";}
  else if(brainState==="stressed"){stateLabel="ðŸ˜Ÿ  YOUR BRAIN  ðŸ˜Ÿ";stateColor="rgba(250,204,21,0.6)";}
  else{stateLabel="ðŸ§   YOUR BRAIN  ðŸ§ ";stateColor="rgba(220,200,255,0.5)";}
  cx.fillStyle=stateColor;cx.fillText(stateLabel,px(BX),py(0.04)+10);

  cx.font="bold 9px 'Orbitron',sans-serif";
  cx.fillStyle=`rgba(167,139,250,${0.3+rwPulse*0.35})`;cx.fillText("REWARD CENTER",px(RWX),py(RWY-RWR-0.025));

  cx.font="bold 11px 'Rajdhani',sans-serif";
  cx.fillStyle=S.rec<=3?"rgba(248,113,113,0.85)":S.rec<=6?"rgba(250,204,21,0.85)":"rgba(167,139,250,0.7)";
  cx.fillText(S.rec+" receptor"+(S.rec!==1?"s":"")+" active",px(BX),py(BY+BSY+0.055));

  // State warning
  if(brainState==="depressed"){
    cx.font="bold 10px 'Rajdhani',sans-serif";cx.fillStyle="rgba(96,165,250,0.7)";
    cx.fillText("LOW MOOD â€” Brain needs dopamine",px(BX),py(BY+BSY+0.08));
  }else if(brainState==="critical"){
    cx.font="bold 10px 'Rajdhani',sans-serif";cx.fillStyle="rgba(248,113,113,0.7)";
    cx.fillText("TOLERANCE â€” Too few receptors left",px(BX),py(BY+BSY+0.08));
  }
  cx.restore();
}

// ===== ACTIONS =====
function relDop(key){const cfg=DC[key];if(cfg.dop===0)return;const alive=recs.filter(r=>r.alive);for(let i=0;i<cfg.dop;i++){const sx=BX+(Math.random()-0.5)*0.25,sy=BY-BSY+0.02+Math.random()*0.05;let slot=null,tx,ty;if(alive.length>0){slot=alive[i%alive.length];tx=slot.x+(Math.random()-0.5)*0.015;ty=slot.y-0.015;}else{tx=RWX+(Math.random()-0.5)*0.1;ty=RWY+(Math.random()-0.5)*0.06;}dops.push({sx,sy,tx,ty,p:0,spd:0.006+Math.random()*0.004,st:performance.now()+i*50,color:cfg.color,slot,sz:4.5+Math.random()*2,wph:Math.random()*6.28,wamp:12+Math.random()*12,trail:[]});}}

function makeBolt(r,cr,cg,cb){
  const ea=Math.atan2(r.y-BY,r.x-BX);
  const ex=BX+Math.cos(ea)*(BSX+0.02),ey=BY+Math.sin(ea)*(BSY+0.01);
  const pts=[[ex,ey]];const steps=6+Math.floor(Math.random()*3);
  for(let s=1;s<=steps;s++){const t=s/steps;pts.push([ex+(r.x-ex)*t+(Math.random()-0.5)*0.04,ey+(r.y-ey)*t+(Math.random()-0.5)*0.03]);}
  hbolts.push({pts,life:1.4,cr,cg,cb});
}

function killR(count){
  let k=0;
  for(let i=recs.length-1;i>=0&&k<count;i--){
    if(!recs[i].alive)continue;const r=recs[i];r.alive=false;r.ts=0;r.da=1;
    makeBolt(r,56,189,248);
    for(let s=0;s<12;s++)sparks.push({x:px(r.x),y:py(r.y),vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:1,color:"#f87171",sz:2+Math.random()*2});
    ftexts.push({x:px(r.x),y:py(r.y)-12,text:"REMOVED",size:11,color:"#38bdf8",life:1.3});k++;
  }
  shake.d=0.5+count*0.25;
  ftexts.push({x:px(BX),y:py(BY-BSY+0.08),text:"âš¡ HOMEOSTASIS âš¡",size:16,color:"#38bdf8",life:1.6});
  ftexts.push({x:px(BX),y:py(BY-BSY+0.08)+18,text:"Brain removes receptors to protect itself",size:10,color:"#7dd3fc",life:1.6});
}

function revR(count){
  let v=0;
  for(let i=0;i<recs.length&&v<count;i++){
    if(recs[i].alive)continue;recs[i].alive=true;recs[i].ts=1;
    for(let s=0;s<9;s++)sparks.push({x:px(recs[i].x),y:py(recs[i].y),vx:(Math.random()-0.5)*3.5,vy:(Math.random()-0.5)*3.5,life:1,color:"#4ade80",sz:2+Math.random()*2});
    ftexts.push({x:px(recs[i].x),y:py(recs[i].y)-12,text:"+1 RECOVERED",size:11,color:"#4ade80",life:1.2});v++;
  }
  ftexts.push({x:px(BX),y:py(BY-BSY+0.08),text:"ðŸ§  BRAIN HEALING",size:14,color:"#4ade80",life:1.3});
}

function calcFG(key){if(key==="NONE")return 0;return Math.max(1,Math.round(DC[key].feel*(S.rec/IR)));}

function updateBrainState(){
  if(S.mood<=3)brainState="depressed";
  else if(S.rec<=3)brainState="critical";
  else if(S.rec<=6)brainState="stressed";
  else brainState="healthy";

  if(brainState==="healthy"){bgc={r:139,g:92,b:246,a:0.18};}
  else if(brainState==="stressed"){bgc={r:200,g:150,b:50,a:0.15};}
  else if(brainState==="critical"){bgc={r:220,g:60,b:60,a:0.15};}
  else{bgc={r:60,g:100,b:200,a:0.18};depGlow=0.8;}
}

// ===== UI =====
function setBtns(on){["bN","bL","bM","bH"].forEach(id=>document.getElementById(id).disabled=!on);}
function updUI(){
  document.getElementById("rNum").textContent=S.rnd;
  document.getElementById("sScore").textContent=S.sc;
  document.getElementById("sStrk").textContent=S.str;
  document.getElementById("sComp").textContent=S.comp;
  const re=document.getElementById("sRec");re.textContent=S.rec;
  re.style.color=S.rec<=3?"#f87171":S.rec<=6?"#facc15":"#a78bfa";

  // Feel Good
  const pct=Math.min(Math.max((S.fg/10)*100,0),100);
  const ff=document.getElementById("fF"),fl=document.getElementById("fL"),fv=document.getElementById("fV");
  fv.textContent=S.fg;ff.style.width=pct+"%";
  if(pct>=70){ff.style.background="linear-gradient(90deg,#22c55e,#4ade80,#86efac)";fl.style.color=fv.style.color="#4ade80";}
  else if(pct>=40){ff.style.background="linear-gradient(90deg,#eab308,#facc15,#fde047)";fl.style.color=fv.style.color="#facc15";}
  else if(pct>0){ff.style.background="linear-gradient(90deg,#ef4444,#f87171,#fca5a5)";fl.style.color=fv.style.color="#f87171";}
  else{ff.style.background="#374151";fl.style.color=fv.style.color="#6b7280";}

  // Mood
  const mPct=Math.min(Math.max((S.mood/10)*100,0),100);
  const mf=document.getElementById("mF"),ml=document.getElementById("mL"),mv=document.getElementById("mV");
  mv.textContent=S.mood;mf.style.width=mPct+"%";
  if(mPct>=60){mf.style.background="linear-gradient(90deg,#3b82f6,#60a5fa,#93c5fd)";ml.style.color=mv.style.color="#60a5fa";}
  else if(mPct>=30){mf.style.background="linear-gradient(90deg,#6366f1,#818cf8)";ml.style.color=mv.style.color="#818cf8";}
  else{mf.style.background="linear-gradient(90deg,#1e3a8a,#1e40af)";ml.style.color=mv.style.color="#3b82f6";}

  // Progress
  const pp=Math.min((S.comp/MR)*100,100);
  document.getElementById("pF").style.width=pp+"%";
  const pc=document.getElementById("pC");pc.textContent=S.comp+"/"+REQ+" req";
  const pm=document.getElementById("pM");
  if(S.comp>=REQ){document.getElementById("pF").style.background="linear-gradient(90deg,#22c55e,#4ade80)";pc.style.color="#4ade80";pm.style.display="block";pm.textContent=S.comp<MR?"Required done! Extra credit!":"All 8 complete!";}
  else{document.getElementById("pF").style.background="linear-gradient(90deg,#7c3aed,#a78bfa)";pc.style.color="#c4b5fd";pm.style.display="none";}

  updateBrainState();
}
function addRow(row){
  const tb=document.getElementById("dB");if(S.data.length===1)tb.innerHTML="";
  const tr=document.createElement("tr");
  const dc=row.dose==="High"?"#f87171":row.dose==="Medium"?"#facc15":row.dose==="Low"?"#4ade80":"#9ca3af";
  const rc=row.rec<=3?"#f87171":row.rec<=6?"#facc15":"#a78bfa";
  const mc=row.mood<=3?"#3b82f6":row.mood<=6?"#818cf8":"#60a5fa";
  tr.innerHTML=`<td style="color:#e2e8f0;font-weight:700">${row.rnd}</td><td style="color:${dc};font-weight:600">${row.dose}</td><td style="color:#e2e8f0;font-weight:700">${row.feel}</td><td style="color:${rc};font-weight:700">${row.rec}</td><td style="color:${mc};font-weight:700">${row.mood}</td>`;
  tr.style.animation="fadeIn 0.3s ease forwards";tb.appendChild(tr);
}
function setMsg(txt,warn,ho,dep){
  const b=document.getElementById("msg");b.innerHTML=txt;
  if(warn)b.innerHTML+=`<div class="w">${warn}</div>`;
  if(ho)b.innerHTML+=`<div class="ho">${ho}</div>`;
  if(dep)b.innerHTML+=`<div class="dep">${dep}</div>`;
}

// ===== GAME =====
function go(key){
  if(S.phase!=="choose"||S.over)return;
  S.phase="anim";setBtns(false);document.getElementById("bNext").disabled=true;
  const cfg=DC[key];

  if(key==="NONE"){
    S.noneStreak++;
    setMsg("No dose â€” brain recovering...");S.fg=0;
    // Mood drops
    S.mood=Math.max(0,S.mood+cfg.moodD);
    updUI();

    setTimeout(()=>{
      const nr=Math.min(S.rec+1,IR);revR(1);S.rec=nr;
      const row={rnd:S.rnd,dose:cfg.label,feel:0,rec:nr,mood:S.mood};
      S.data.push(row);S.comp++;S.sc+=5;S.str++;addRow(row);updUI();
      const depWarn=S.mood<=3?"ðŸ˜” Mood is crashing â€” brain needs some dopamine":"";
      setMsg("+1 receptor recovered!","","Brain heals when resting",depWarn);
      setTimeout(()=>finish(),800);
    },1200);
  } else {
    S.noneStreak=0;
    setMsg("Dopamine flooding your brain...");relDop(key);
    // Mood changes
    S.mood=Math.min(10,Math.max(0,S.mood+cfg.moodD));
    const arrT=1400+cfg.dop*50;
    setTimeout(()=>{
      const fg=calcFG(key);S.fg=fg;updUI();
      let w="",h="",d="";
      if(cfg.rd<0){w=S.rec+cfg.rd<=3?"Warning: Low receptors!":"";h=`âš¡ Homeostasis removing ${Math.abs(cfg.rd)} receptor(s)`;}
      if(key==="LOW")d="Steady and safe â€” nice choice";
      setMsg(`Feel Good: ${fg}`,w,h,d);
      setTimeout(()=>{
        if(cfg.rd<0)killR(Math.abs(cfg.rd));
        S.rec=Math.max(0,S.rec+cfg.rd);
        const row={rnd:S.rnd,dose:cfg.label,feel:fg,rec:S.rec,mood:S.mood};
        S.data.push(row);S.comp++;S.sc+=fg*2;
        if(key==="LOW"){S.str++;S.sc+=3;} // bonus for safe choice
        else S.str=0;
        addRow(row);updUI();
        setTimeout(()=>finish(),800);
      },900);
    },arrT);
  }
}
function finish(){if(QS[S.rnd]){showQ(QS[S.rnd]);return;}if(S.rnd>=MR){S.over=true;S.phase="done";setMsg("Simulation complete!");return;}S.phase="wait";document.getElementById("bNext").disabled=false;setMsg("Choose your dose level");}
function showQ(t){S.phase="q";document.getElementById("qTxt").textContent=t;document.getElementById("qOver").classList.add("show");}
function dismissQ(){document.getElementById("qOver").classList.remove("show");if(S.rnd>=MR){S.over=true;S.phase="done";setMsg("Simulation complete!");return;}S.phase="wait";document.getElementById("bNext").disabled=false;setMsg("Choose your dose level");}
function nextRound(){if(S.rnd>=MR)return;S.rnd++;S.phase="choose";setBtns(true);document.getElementById("bNext").disabled=true;updUI();setMsg("Choose your dose level");}
function resetSim(){
  S={rnd:1,rec:IR,fg:0,mood:7,sc:0,str:0,comp:0,data:[],phase:"choose",over:false,noneStreak:0};
  brainState="healthy";depGlow=0;
  document.getElementById("dB").innerHTML='<tr><td colspan="5" class="dempty">No data yet</td></tr>';
  setBtns(true);document.getElementById("bNext").disabled=true;initE();updUI();setMsg("Choose your dose level");
}

// ===== INIT =====
window.addEventListener("resize",resize);
lt=performance.now();requestAnimationFrame(draw);
</script>
</body>
</html>
