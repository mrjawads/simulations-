<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Mr. Jawad's Escape Room ‚Äî Respiratory System v2</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
--bg:#1a1a2e;--bg2:#16213e;--text:#e0e0e0;--text-bright:#ffffff;
--r1:#e63946;--r1a:#ff8c42;--r1bg:rgba(230,57,70,0.08);
--r2:#0077b6;--r2a:#00e5ff;--r2bg:rgba(0,119,182,0.08);
--r3:#2d6a4f;--r3a:#95d5b2;--r3bg:rgba(45,106,79,0.08);
--teal:#00b4d8;--green:#2ecc71;--red:#e74c3c;
--glow-r1:0 0 15px rgba(230,57,70,0.5);--glow-r2:0 0 15px rgba(0,119,182,0.5);--glow-r3:0 0 15px rgba(45,106,79,0.5);
}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--text);}
button{cursor:pointer;border:none;outline:none;font-family:inherit;}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0;flex-direction:column;}
.screen.active{display:flex;}

/* START SCREEN */
#startScreen{justify-content:center;align-items:center;background:radial-gradient(ellipse at center,#16213e 0%,#0f0f23 70%,#0a0a1a 100%);}
.start-brand{font-size:clamp(10px,1.2vw,14px);letter-spacing:4px;text-transform:uppercase;color:var(--teal);margin-bottom:12px;font-weight:600;}
.start-title{font-size:clamp(32px,5vw,64px);font-weight:800;color:var(--text-bright);text-shadow:0 0 30px rgba(0,180,216,0.4),0 0 60px rgba(0,180,216,0.15);line-height:1.1;text-align:center;margin-bottom:8px;}
.start-divider{width:80px;height:2px;background:var(--teal);margin:16px auto;box-shadow:0 0 10px var(--teal);}
.start-subtitle{font-size:clamp(14px,2vw,20px);color:rgba(255,255,255,0.6);margin-bottom:40px;letter-spacing:2px;}
.start-btn{padding:16px 48px;font-size:clamp(16px,2vw,22px);font-weight:700;color:#fff;background:linear-gradient(135deg,var(--teal),#0077b6);border-radius:12px;box-shadow:0 0 25px rgba(0,180,216,0.4);transition:all 0.3s ease;letter-spacing:1px;}
.start-btn:hover{transform:scale(1.05);box-shadow:0 0 40px rgba(0,180,216,0.6);}
.start-footer{position:absolute;bottom:24px;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.2);}

/* TOP BAR */
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;background:rgba(0,0,0,0.4);border-bottom:1px solid rgba(255,255,255,0.05);min-height:48px;flex-shrink:0;z-index:10;position:relative;}
.top-bar .room-label{font-size:clamp(14px,1.8vw,18px);font-weight:700;display:flex;align-items:center;gap:8px;}
.top-bar .room-progress{font-size:clamp(12px,1.4vw,14px);color:rgba(255,255,255,0.5);}
.top-bar .streak-icon{font-size:20px;display:none;}
.top-bar .streak-icon.active{display:inline-block;animation:fireFlicker 0.5s ease infinite alternate;}
.top-bar .counter{margin-left:auto;font-size:clamp(12px,1.4vw,15px);font-weight:600;padding:4px 12px;border-radius:20px;background:rgba(255,255,255,0.08);white-space:nowrap;}
.counter.pulse{animation:counterPulse 0.4s ease;}

/* MISSION LINE */
.mission-line{text-align:center;padding:8px 16px;font-size:clamp(12px,1.4vw,15px);color:rgba(255,255,255,0.55);font-style:italic;flex-shrink:0;}

/* PUZZLE AREA */
.puzzle-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 16px;overflow-y:auto;position:relative;}
.puzzle-instruction{font-size:clamp(13px,1.5vw,16px);color:rgba(255,255,255,0.6);margin-bottom:12px;text-align:center;}
.puzzle-question{font-size:clamp(18px,2.5vw,28px);font-weight:700;color:var(--text-bright);text-align:center;margin-bottom:20px;line-height:1.3;}
.micro-progress{font-size:clamp(11px,1.2vw,13px);color:rgba(255,255,255,0.4);margin-bottom:8px;letter-spacing:1px;}

/* BOTTOM BAR */
.bottom-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;flex-shrink:0;min-height:56px;}
.scanner-btn{display:flex;align-items:center;gap:6px;padding:10px 18px;font-size:clamp(13px,1.5vw,16px);font-weight:600;color:#fff;background:rgba(255,255,255,0.08);border-radius:10px;border:1px solid rgba(255,255,255,0.15);transition:all 0.3s;min-width:48px;min-height:48px;}
.scanner-btn:hover{background:rgba(255,255,255,0.15);}
.scanner-btn.glow{animation:scannerPulse 1.5s ease infinite;border-color:var(--teal);}
.progress-dots{display:flex;gap:8px;align-items:center;}
.progress-dot{width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,0.15);transition:all 0.3s;}
.progress-dot.filled{box-shadow:0 0 10px currentColor;}

/* CODE VAULT */
.code-vault{position:fixed;top:56px;right:8px;background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:8px 10px;z-index:20;display:none;backdrop-filter:blur(4px);max-width:120px;}
.code-vault.visible{display:block;}
.vault-title{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.35);margin-bottom:6px;text-align:center;}
.vault-slots{display:flex;flex-direction:column;gap:4px;}
.vault-slot{display:flex;align-items:center;gap:4px;font-size:clamp(12px,1.3vw,14px);}
.vault-slot .slot-code{font-weight:700;font-family:monospace;letter-spacing:1px;min-width:16px;text-align:center;font-size:clamp(14px,1.5vw,16px);}
.vault-slot .slot-code.locked{color:rgba(255,255,255,0.25);}
.vault-slot .slot-code.unlocked{animation:slotReveal 0.5s ease;}

/* PUZZLE CARDS */
.option-cards{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;max-width:700px;}
.option-card{padding:14px 20px;font-size:clamp(14px,1.6vw,18px);font-weight:600;color:var(--text-bright);background:rgba(255,255,255,0.06);border:2px solid rgba(255,255,255,0.15);border-radius:12px;cursor:pointer;transition:all 0.3s ease;min-width:48px;min-height:48px;display:flex;align-items:center;justify-content:center;gap:8px;text-align:center;position:relative;}
.option-card:hover:not(.disabled):not(.matched):not(.locked){transform:translateY(-2px);border-color:rgba(255,255,255,0.35);background:rgba(255,255,255,0.1);}
.option-card.selected{transform:scale(1.05);border-width:3px;box-shadow:0 0 20px rgba(255,255,255,0.2);}
.option-card .selected-badge{display:none;position:absolute;top:-8px;right:-8px;background:var(--teal);color:#fff;font-size:9px;padding:2px 6px;border-radius:4px;font-weight:700;letter-spacing:0.5px;}
.option-card.selected .selected-badge{display:block;}
.option-card.correct{border-color:var(--green)!important;background:rgba(46,204,113,0.15)!important;box-shadow:0 0 20px rgba(46,204,113,0.4)!important;}
.option-card.wrong{border-color:var(--red)!important;background:rgba(231,76,60,0.12)!important;animation:wrongShake 0.4s ease;}
.option-card.disabled{opacity:0.3;pointer-events:none;}
.option-card.dimmed{opacity:0.35;pointer-events:none;border-style:dashed;}
.option-card.matched{border-color:var(--green);background:rgba(46,204,113,0.1);pointer-events:none;}
.option-card.locked{pointer-events:none;}
.feedback-icon{font-size:18px;margin-left:4px;}

/* MATCH LOCK LAYOUT */
.match-container{display:flex;gap:24px;align-items:center;justify-content:center;flex-wrap:wrap;max-width:700px;width:100%;}
.match-side{display:flex;flex-direction:column;gap:10px;min-width:140px;}
.match-side.left .option-card{border-left:4px solid;padding-left:16px;}
.match-side.right .option-card{border-right:4px solid;padding-right:16px;}
.match-arrow{font-size:28px;color:rgba(255,255,255,0.2);}
.matched-pairs-area{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;max-width:600px;width:100%;}
.matched-pair{display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.25);border-radius:8px;font-size:clamp(12px,1.3vw,14px);color:var(--green);animation:pairSlideIn 0.4s ease;}
.matched-pair .pair-check{color:var(--green);font-weight:700;}

/* SEQUENCE LOCK */
.sequence-container{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;max-width:600px;}
.sequence-slots{display:flex;gap:12px;margin-bottom:16px;width:100%;justify-content:center;}
.sequence-slot{min-width:120px;min-height:60px;border:2px dashed rgba(255,255,255,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:clamp(12px,1.3vw,15px);color:rgba(255,255,255,0.3);padding:8px;text-align:center;transition:all 0.3s;}
.sequence-slot.filled{border-style:solid;border-color:var(--green);color:var(--green);background:rgba(46,204,113,0.08);}
.sequence-slot.active{border-color:rgba(255,255,255,0.5);box-shadow:0 0 10px rgba(255,255,255,0.1);}
.sequence-arrow{font-size:20px;color:rgba(255,255,255,0.15);align-self:center;}
.sequence-picks{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}

/* GAUGES */
.gauges-panel{display:flex;gap:clamp(16px,3vw,32px);justify-content:center;margin-bottom:16px;padding:16px;background:rgba(0,0,0,0.3);border-radius:12px;border:1px solid rgba(255,255,255,0.08);}
.gauge{display:flex;flex-direction:column;align-items:center;gap:6px;}
.gauge-label{font-size:clamp(11px,1.2vw,13px);font-weight:600;letter-spacing:0.5px;}
.gauge-bar{width:clamp(36px,5vw,50px);height:clamp(100px,15vh,160px);border-radius:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);position:relative;overflow:hidden;}
.gauge-fill{position:absolute;bottom:0;width:100%;border-radius:0 0 5px 5px;transition:height 1s ease;}
.gauge-arrow{font-size:16px;font-weight:700;}
.gauge-setting{font-size:clamp(10px,1.1vw,12px);color:rgba(255,255,255,0.5);text-align:center;margin-top:4px;letter-spacing:1px;text-transform:uppercase;padding:4px 10px;background:rgba(255,255,255,0.05);border-radius:4px;}

/* CHAIN (Mystery Input) */
.chain-container{display:flex;align-items:center;gap:clamp(8px,1.5vw,16px);justify-content:center;flex-wrap:wrap;margin-bottom:20px;}
.chain-panel{padding:clamp(10px,1.5vw,16px) clamp(14px,2vw,24px);background:rgba(255,255,255,0.06);border:2px solid rgba(255,255,255,0.12);border-radius:10px;font-size:clamp(13px,1.5vw,17px);font-weight:600;text-align:center;min-width:clamp(100px,15vw,160px);transition:all 0.5s;}
.chain-panel.mystery{border-style:dashed;color:rgba(255,255,255,0.4);animation:mysteryPulse 1.5s ease infinite;}
.chain-panel.revealed{border-style:solid;border-color:var(--green);color:var(--green);background:rgba(46,204,113,0.1);animation:none;}
.chain-arrow-icon{font-size:clamp(18px,2.5vw,28px);color:rgba(255,255,255,0.2);}

/* QUICK FIRE */
.qf-statement{font-size:clamp(16px,2vw,22px);font-weight:600;color:var(--text-bright);text-align:center;margin-bottom:20px;padding:16px 24px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:10px;min-height:60px;display:flex;align-items:center;justify-content:center;}
.qf-buttons{display:flex;gap:16px;justify-content:center;}
.qf-btn{padding:14px 32px;font-size:clamp(16px,2vw,20px);font-weight:700;border-radius:10px;min-width:clamp(100px,15vw,140px);min-height:48px;transition:all 0.3s;}
.qf-btn.confirm{background:rgba(46,204,113,0.15);border:2px solid var(--green);color:var(--green);}
.qf-btn.deny{background:rgba(231,76,60,0.15);border:2px solid var(--red);color:var(--red);}
.qf-btn:hover{transform:scale(1.05);}
.qf-btn.correct-flash{background:rgba(46,204,113,0.3)!important;box-shadow:0 0 20px rgba(46,204,113,0.5)!important;}
.qf-btn.wrong-flash{background:rgba(231,76,60,0.3)!important;box-shadow:0 0 20px rgba(231,76,60,0.5)!important;}

/* VISUAL RECALL SCENE */
.vr-scene{width:100%;max-width:500px;aspect-ratio:4/3;background:linear-gradient(180deg,#87ceeb 0%,#4a90d9 15%,#1a3a6e 40%,#0a1628 100%);border-radius:12px;border:2px solid rgba(255,255,255,0.1);position:relative;overflow:hidden;margin-bottom:16px;}
.vr-diver{position:absolute;left:50%;top:55%;transform:translate(-50%,-50%);width:40px;height:70px;display:flex;flex-direction:column;align-items:center;}
.vr-diver-body{width:20px;height:35px;background:rgba(255,255,255,0.85);border-radius:8px 8px 4px 4px;position:relative;}
.vr-diver-head{width:16px;height:16px;background:rgba(255,255,255,0.85);border-radius:50%;margin-bottom:2px;}
.vr-diver-legs{display:flex;gap:4px;margin-top:2px;}
.vr-diver-leg{width:6px;height:18px;background:rgba(255,255,255,0.7);border-radius:0 0 3px 3px;}
.vr-lungs{position:absolute;left:50%;top:55%;transform:translate(-50%,-50%);}
.vr-lung-ghost{width:50px;height:30px;border:2px dashed rgba(255,255,255,0.25);border-radius:50%;position:absolute;top:-15px;left:-25px;}
.vr-lung-solid{width:20px;height:14px;background:rgba(255,150,150,0.7);border-radius:50%;position:absolute;top:-7px;left:-10px;box-shadow:0 0 6px rgba(255,100,100,0.5);}
.vr-arrow{position:absolute;color:#e74c3c;font-weight:900;font-size:clamp(11px,1.3vw,14px);display:flex;align-items:center;gap:2px;text-shadow:0 0 8px rgba(231,76,60,0.8);}
.vr-arrow.top{top:30%;left:50%;transform:translateX(-50%) rotate(180deg);}
.vr-arrow.left{left:15%;top:55%;transform:rotate(0deg);}
.vr-arrow.right{right:15%;top:55%;transform:rotate(180deg);}
.vr-arrow.bottom{bottom:20%;left:50%;transform:translateX(-50%);}
.vr-pressure{position:absolute;color:rgba(255,255,255,0.5);font-size:22px;}
.vr-pressure.p-top{top:8%;left:50%;transform:translateX(-50%);}
.vr-pressure.p-left{left:5%;top:50%;transform:translateY(-50%);}
.vr-pressure.p-right{right:5%;top:50%;transform:translateY(-50%);}
.vr-pressure.p-bottom{bottom:8%;left:50%;transform:translateX(-50%);}
.vr-label{position:absolute;font-size:clamp(9px,1.1vw,11px);color:rgba(255,255,255,0.6);font-weight:600;letter-spacing:0.5px;background:rgba(0,0,0,0.5);padding:2px 6px;border-radius:3px;}
.vr-label.depth{top:45%;right:8%;}
.vr-label.lung-size{bottom:12%;left:50%;transform:translateX(-50%);}
.vr-surface{position:absolute;top:0;left:0;right:0;height:12%;background:linear-gradient(180deg,rgba(135,206,235,0.6),transparent);border-bottom:1px solid rgba(255,255,255,0.15);}
.vr-surface-label{position:absolute;top:2%;left:8%;font-size:9px;color:rgba(255,255,255,0.45);letter-spacing:1px;}

/* CODE ENTRY */
.code-entry-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:50;justify-content:center;align-items:center;flex-direction:column;}
.code-entry-overlay.active{display:flex;}
.code-entry-box{background:var(--bg2);border:2px solid rgba(255,255,255,0.15);border-radius:16px;padding:32px;text-align:center;max-width:360px;width:90%;}
.code-entry-title{font-size:clamp(18px,2.5vw,24px);font-weight:700;color:var(--text-bright);margin-bottom:8px;}
.code-entry-sub{font-size:13px;color:rgba(255,255,255,0.4);margin-bottom:20px;}
.code-digits{display:flex;gap:12px;justify-content:center;margin-bottom:20px;}
.code-digit-box{width:56px;height:64px;border:2px solid rgba(255,255,255,0.2);border-radius:10px;font-size:28px;font-weight:700;color:var(--text-bright);background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;transition:all 0.3s;}
.code-digit-box.filled{border-color:rgba(255,255,255,0.4);}
.code-digit-box.correct-digit{border-color:var(--green);box-shadow:0 0 15px rgba(46,204,113,0.4);color:var(--green);}
.code-numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:240px;margin:0 auto;}
.numpad-btn{padding:12px;font-size:20px;font-weight:600;color:var(--text-bright);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;min-height:48px;transition:all 0.2s;}
.numpad-btn:hover{background:rgba(255,255,255,0.12);}
.numpad-btn.backspace{font-size:16px;grid-column:span 1;}

/* SCANNER OVERLAY */
.scanner-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:40;justify-content:center;align-items:center;}
.scanner-overlay.active{display:flex;}
.scanner-box{background:var(--bg2);border:2px solid var(--teal);border-radius:16px;padding:24px;max-width:420px;width:90%;text-align:center;box-shadow:0 0 30px rgba(0,180,216,0.2);}
.scanner-title{font-size:14px;letter-spacing:2px;text-transform:uppercase;color:var(--teal);margin-bottom:12px;}
.scanner-text{font-size:clamp(14px,1.6vw,17px);color:var(--text);line-height:1.5;margin-bottom:16px;}
.scanner-dismiss{padding:8px 20px;font-size:13px;color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;transition:all 0.2s;}
.scanner-dismiss:hover{color:#fff;background:rgba(255,255,255,0.12);}

/* DIGIT REVEAL */
.digit-reveal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:45;justify-content:center;align-items:center;flex-direction:column;}
.digit-reveal-overlay.active{display:flex;}
.digit-reveal-num{font-size:clamp(72px,12vw,120px);font-weight:900;color:var(--text-bright);animation:digitReveal 0.8s ease;text-shadow:0 0 40px currentColor;}
.digit-reveal-label{font-size:clamp(14px,1.6vw,18px);color:rgba(255,255,255,0.5);margin-top:12px;}
.digit-continue{margin-top:24px;padding:12px 32px;font-size:16px;font-weight:600;color:#fff;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:10px;transition:all 0.3s;}
.digit-continue:hover{background:rgba(255,255,255,0.2);}

/* PASS THE LAPTOP */
.pass-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:55;justify-content:center;align-items:center;flex-direction:column;}
.pass-overlay.active{display:flex;}
.pass-text{font-size:clamp(32px,6vw,56px);font-weight:900;color:var(--text-bright);letter-spacing:3px;animation:passTextPulse 0.8s ease;margin-bottom:8px;}
.pass-emoji{font-size:48px;margin-bottom:24px;}
.pass-ready{padding:14px 40px;font-size:clamp(16px,2vw,20px);font-weight:700;color:#fff;border-radius:12px;transition:all 0.3s;}
.pass-ready:hover{transform:scale(1.05);}

/* DOOR TRANSITION */
.door-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:60;display:flex;justify-content:center;align-items:center;pointer-events:none;}
.door-panel{width:60%;max-width:300px;height:70%;border:3px solid rgba(255,255,255,0.3);border-radius:16px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:12px;background:rgba(0,0,0,0.8);}
.door-lock{font-size:48px;}
.door-room-name{font-size:clamp(14px,2vw,20px);font-weight:700;color:var(--text-bright);letter-spacing:2px;text-transform:uppercase;}

/* SCAN PREVIEW */
.scan-preview{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:35;justify-content:center;align-items:center;flex-direction:column;}
.scan-preview.active{display:flex;}
.scan-preview-content{max-width:500px;width:90%;text-align:center;}
.scan-preview-title{font-size:14px;letter-spacing:3px;text-transform:uppercase;margin-bottom:16px;animation:scanPulseText 1s ease infinite alternate;}
.scan-preview-visual{margin:0 auto 16px;padding:20px;border-radius:12px;border:2px solid rgba(255,255,255,0.1);}

/* FINAL LOCK */
.final-lock-intro{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:65;display:flex;justify-content:center;align-items:center;flex-direction:column;}
.final-lock-text{font-size:clamp(36px,6vw,60px);font-weight:900;color:var(--text-bright);letter-spacing:4px;text-shadow:0 0 30px rgba(255,255,255,0.3);animation:finalLockSlam 0.6s ease;}
.final-match-container{display:flex;gap:clamp(16px,4vw,40px);align-items:flex-start;justify-content:center;flex-wrap:wrap;max-width:700px;}
.final-match-side{display:flex;flex-direction:column;gap:10px;}
.final-card{padding:14px 20px;font-size:clamp(13px,1.5vw,17px);font-weight:600;color:var(--text-bright);background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.15);border-radius:12px;cursor:pointer;transition:all 0.3s;min-width:clamp(120px,18vw,200px);min-height:48px;display:flex;align-items:center;justify-content:center;gap:6px;text-align:center;position:relative;}
.final-card:hover:not(.matched):not(.disabled){background:rgba(255,255,255,0.1);}
.final-card.selected{transform:scale(1.05);box-shadow:0 0 20px rgba(255,255,255,0.2);}
.final-card .selected-badge{display:none;position:absolute;top:-8px;right:-8px;background:var(--teal);color:#fff;font-size:9px;padding:2px 6px;border-radius:4px;font-weight:700;}
.final-card.selected .selected-badge{display:block;}
.final-card.matched{pointer-events:none;opacity:0.85;}

/* ESCAPE REPORT */
#escapeReport{background:radial-gradient(ellipse at center,#16213e 0%,#0f0f23 70%,#0a0a1a 100%);justify-content:flex-start;align-items:center;overflow-y:auto;padding:24px 16px;}
.report-brand{font-size:clamp(9px,1vw,11px);letter-spacing:3px;text-transform:uppercase;color:var(--teal);margin-top:12px;margin-bottom:8px;}
.escaped-header{font-size:clamp(40px,7vw,72px);font-weight:900;color:var(--text-bright);text-shadow:0 0 40px rgba(0,180,216,0.5);margin-bottom:4px;animation:escapedGlow 2s ease infinite alternate;}
.report-emojis{font-size:32px;letter-spacing:12px;margin-bottom:24px;}
.report-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;max-width:480px;width:100%;margin-bottom:16px;}
.report-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.report-row:last-child{border-bottom:none;}
.report-label{color:rgba(255,255,255,0.5);font-size:clamp(13px,1.4vw,15px);}
.report-value{font-weight:700;color:var(--text-bright);font-size:clamp(14px,1.5vw,16px);}
.report-stars{font-size:28px;letter-spacing:4px;}
.report-star{opacity:0.2;transition:opacity 0.5s;}
.report-star.earned{opacity:1;}
.report-badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.report-badge{padding:6px 12px;font-size:clamp(11px,1.2vw,13px);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;display:flex;align-items:center;gap:4px;}
.report-actions{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;justify-content:center;}
.report-btn{padding:12px 28px;font-size:15px;font-weight:600;border-radius:10px;transition:all 0.3s;}
.report-btn.primary{color:#fff;background:linear-gradient(135deg,var(--teal),#0077b6);box-shadow:0 0 15px rgba(0,180,216,0.3);}
.report-btn.secondary{color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);}
.report-btn:hover{transform:scale(1.05);}
.report-copied{font-size:13px;color:var(--green);margin-top:8px;display:none;}

/* ANIMATIONS */
@keyframes fireFlicker{0%{transform:scale(1);}100%{transform:scale(1.15);filter:brightness(1.2);}}
@keyframes counterPulse{0%{transform:scale(1);}50%{transform:scale(1.15);box-shadow:0 0 12px rgba(255,255,255,0.2);}100%{transform:scale(1);}}
@keyframes scannerPulse{0%,100%{box-shadow:0 0 5px rgba(0,180,216,0.2);}50%{box-shadow:0 0 20px rgba(0,180,216,0.5);}}
@keyframes digitReveal{0%{transform:scale(0);opacity:0;}60%{transform:scale(1.2);opacity:1;}100%{transform:scale(1);}}
@keyframes wrongShake{0%,100%{transform:translateX(0);}20%{transform:translateX(-6px);}40%{transform:translateX(6px);}60%{transform:translateX(-4px);}80%{transform:translateX(4px);}}
@keyframes passTextPulse{0%{transform:scale(0.8);opacity:0;}100%{transform:scale(1);opacity:1;}}
@keyframes mysteryPulse{0%,100%{border-color:rgba(255,255,255,0.12);}50%{border-color:rgba(255,255,255,0.3);}}
@keyframes pairSlideIn{0%{transform:translateY(-10px);opacity:0;}100%{transform:translateY(0);opacity:1;}}
@keyframes slotReveal{0%{transform:scale(0.5);opacity:0;}60%{transform:scale(1.2);}100%{transform:scale(1);opacity:1;}}
@keyframes scanPulseText{0%{opacity:0.4;}100%{opacity:1;}}
@keyframes finalLockSlam{0%{transform:scale(2);opacity:0;}70%{transform:scale(0.9);}100%{transform:scale(1);opacity:1;}}
@keyframes escapedGlow{0%{text-shadow:0 0 30px rgba(0,180,216,0.3);}100%{text-shadow:0 0 60px rgba(0,180,216,0.6);}}
@keyframes doorAnim{0%{opacity:0;transform:scale(0.9);}25%{opacity:1;transform:scale(1);}55%{opacity:1;transform:scale(1);}60%{opacity:1;transform:translateX(0);}95%{opacity:0.8;transform:translateX(-110%);}100%{opacity:0;transform:translateX(-120%);}}
@keyframes particleBurst{0%{transform:translate(0,0) scale(1);opacity:1;}100%{opacity:0;}}
@keyframes confettiFall{0%{transform:translateY(-10px) rotate(0deg);opacity:1;}100%{transform:translateY(100vh) rotate(720deg);opacity:0;}}
@keyframes starFill{0%{transform:scale(0);opacity:0;}60%{transform:scale(1.3);}100%{transform:scale(1);opacity:1;}}
</style>
</head>
<body>

<!-- START SCREEN -->
<div id="startScreen" class="screen active">
<div class="start-brand">Mr. Jawad's Escape Room Simulations</div>
<div class="start-title">Respiratory System</div>
<div class="start-divider"></div>
<div class="start-subtitle">Unit Review</div>
<button class="start-btn" onclick="startGame()">BEGIN ESCAPE</button>
<div class="start-footer">DESIGNED BY MR. JAWAD</div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
<div class="top-bar" id="topBar">
<div>
<span class="room-label" id="roomLabel"></span>
<span class="room-progress" id="roomProgress"></span>
</div>
<span class="streak-icon" id="streakIcon">üî•</span>
<div class="counter" id="puzzleCounter">Locks Cracked: 0 / 6</div>
</div>
<div class="mission-line" id="missionLine"></div>
<div class="puzzle-area" id="puzzleArea"></div>
<div class="bottom-bar" id="bottomBar">
<button class="scanner-btn" id="scannerBtn" onclick="openScanner()">üîç Scanner</button>
<div class="progress-dots" id="progressDots"></div>
<div style="width:48px;"></div>
</div>
</div>

<!-- CODE VAULT -->
<div class="code-vault" id="codeVault">
<div class="vault-title">Code Vault</div>
<div class="vault-slots" id="vaultSlots">
<div class="vault-slot"><span style="color:var(--r1);">üèöÔ∏è</span><span class="slot-code locked" id="vault0d0">?</span><span class="slot-code locked" id="vault0d1">?</span></div>
<div class="vault-slot"><span style="color:var(--r2);">ü´Å</span><span class="slot-code locked" id="vault1d0">?</span><span class="slot-code locked" id="vault1d1">?</span></div>
<div class="vault-slot"><span style="color:var(--r3);">‚öñÔ∏è</span><span class="slot-code locked" id="vault2d0">?</span><span class="slot-code locked" id="vault2d1">?</span></div>
</div>
</div>

<!-- SCANNER OVERLAY -->
<div class="scanner-overlay" id="scannerOverlay">
<div class="scanner-box" id="scannerBox">
<div class="scanner-title">üîç Scanner Active</div>
<div class="scanner-text" id="scannerText"></div>
<button class="scanner-dismiss" onclick="closeScanner()">Dismiss</button>
</div>
</div>

<!-- DIGIT REVEAL OVERLAY -->
<div class="digit-reveal-overlay" id="digitReveal">
<div class="digit-reveal-num" id="digitNum"></div>
<div class="digit-reveal-label" id="digitLabel">Code digit unlocked</div>
<button class="digit-continue" id="digitContinue">Continue</button>
</div>

<!-- CODE ENTRY OVERLAY -->
<div class="code-entry-overlay" id="codeEntry">
<div class="code-entry-box" id="codeEntryBox">
<div class="code-entry-title">Enter Exit Code</div>
<div class="code-entry-sub">Use the Code Vault digits</div>
<div class="code-digits" id="codeDigits"></div>
<div class="code-numpad" id="codeNumpad"></div>
</div>
</div>

<!-- PASS THE LAPTOP OVERLAY -->
<div class="pass-overlay" id="passOverlay">
<div class="pass-text">PASS THE LAPTOP</div>
<div class="pass-emoji" id="passEmoji"></div>
<button class="pass-ready" id="passReady">Ready</button>
</div>

<!-- SCAN PREVIEW -->
<div class="scan-preview" id="scanPreview">
<div class="scan-preview-content" id="scanPreviewContent"></div>
</div>

<!-- ESCAPE REPORT -->
<div id="escapeReport" class="screen">
<div class="report-brand">Mr. Jawad's Escape Room Simulations</div>
<div class="escaped-header">ESCAPED!</div>
<div class="report-emojis">üèöÔ∏è ü´Å ‚öñÔ∏è</div>
<div class="report-card" id="reportCard"></div>
<div class="report-actions">
<button class="report-btn primary" onclick="copyReport()">üìã Copy Report</button>
<button class="report-btn secondary" onclick="resetGame()">üîÑ Play Again</button>
</div>
<div class="report-copied" id="reportCopied">‚úî Copied to clipboard!</div>
</div>

<script>
/* ============================================================
   MR. JAWAD'S ESCAPE ROOM ‚Äî RESPIRATORY SYSTEM v1
   Single-file, offline, Chromebook-safe
   ============================================================ */

// ===== GAME DATA =====
const ROOMS = [
  {
    name:"THE TRIGGER ZONE", emoji:"üèöÔ∏è", color:"#e63946", accent:"#ff8c42",
    bg:"rgba(230,57,70,0.06)", code:"47",
    mission:"Identify the respiratory threats before the airways shut down.",
    puzzles:[
      {
        type:"match", digit:"4",
        pairs:[
          {term:"Trigger",correct:"Mold, smoke, pollution üí®",wrongs:["Airways swell shut üî¥","Opens airways fast üíä"]},
          {term:"Inflammation",correct:"Airways swell shut üî¥",wrongs:["Opens airways fast üíä"]},
          {term:"Inhaler",correct:"Opens airways fast üíä",wrongs:[]}
        ],
        scannerText:"üîç Scan detected: South Bronx apartment ‚Äî mold and smoke caused the airways to react.",
        scanPreview:{title:"SCANNING ROOM...",desc:"Airway comparison detected",visual:"airway"}
      },
      {
        type:"sequence", digit:"7",
        steps:[
          {label:"Mold in apartment üèöÔ∏è"},
          {label:"Airways swell shut ü´Å"},
          {label:"Weekly asthma attacks üè•"}
        ],
        scannerText:"üîç Scan detected: South Bronx apartment ‚Äî the mold was already there before the airways started swelling.",
        scanPreview:{title:"SCANNING ROOM...",desc:"South Bronx scenario detected",visual:"apartment"}
      }
    ]
  },
  {
    name:"THE OXYGEN LAB", emoji:"ü´Å", color:"#0077b6", accent:"#00e5ff",
    bg:"rgba(0,119,182,0.06)", code:"29",
    mission:"Recalibrate the oxygen systems before the organs shut down.",
    puzzles:[
      {
        type:"scanner", digit:"2",
        gauges:[
          {label:"Brain O‚ÇÇ",fill:35,zone:"amber",arrow:"‚¨áÔ∏è"},
          {label:"Muscle O‚ÇÇ",fill:40,zone:"amber",arrow:"‚¨áÔ∏è"},
          {label:"CO‚ÇÇ Level",fill:80,zone:"red",arrow:"‚¨ÜÔ∏è"}
        ],
        setting:"BREATHING SET TO: SHALLOW",
        question:"What happens when breathing goes shallow?",
        options:[
          {text:"O‚ÇÇ drops, CO‚ÇÇ rises üß†ü´Å",correct:true},
          {text:"O‚ÇÇ rises, CO‚ÇÇ drops ‚¨ÜÔ∏è",correct:false},
          {text:"Only CO‚ÇÇ changes üìä",correct:false}
        ],
        scannerText:"üîç Scan detected: Oxygen Delivery sim ‚Äî shallow breathing dropped Brain O‚ÇÇ and raised CO‚ÇÇ.",
        narrowTo:["O‚ÇÇ drops, CO‚ÇÇ rises üß†ü´Å","Only CO‚ÇÇ changes üìä"],
        scanPreview:{title:"SCANNING ROOM...",desc:"Gas exchange dashboard detected",visual:"gauges"}
      },
      {
        type:"mystery", digit:"9",
        chain:[
          {text:"Daily vaping üö¨",hidden:false},
          {text:"Inflammation spikes üî¥",hidden:true},
          {text:"Lung capacity drops üìâ",hidden:false}
        ],
        question:"What's the missing step?",
        options:[
          {text:"Inflammation spikes üî¥",correct:true},
          {text:"Airways expand üü¢",correct:false},
          {text:"Scars heal üíö",correct:false}
        ],
        scannerText:"üîç Scan detected: Lung Damage sim ‚Äî vaping caused the alveoli to swell before any permanent damage.",
        narrowTo:["Inflammation spikes üî¥","Airways expand üü¢"],
        scanPreview:{title:"SCANNING ROOM...",desc:"Lung damage simulation detected",visual:"alveoli"}
      }
    ]
  },
  {
    name:"THE CONTROL ROOM", emoji:"‚öñÔ∏è", color:"#2d6a4f", accent:"#95d5b2",
    bg:"rgba(45,106,79,0.06)", code:"53",
    mission:"Override the final security protocols to reach the exit.",
    puzzles:[
      {
        type:"visual", digit:"5",
        question:"What protects lungs at depth?",
        options:[
          {text:"Blood rushes to chest üî¥",correct:true},
          {text:"Lungs grow thicker ü´Å",correct:false},
          {text:"Air pressure fills lungs üí®",correct:false}
        ],
        scannerText:"üîç Scan detected: Extreme Lungs sim ‚Äî the body moved blood into the chest to cushion the crushed lungs.",
        narrowTo:["Blood rushes to chest üî¥","Air pressure fills lungs üí®"],
        scanPreview:{title:"SCANNING ROOM...",desc:"Deep dive scenario detected",visual:"diver"}
      },
      {
        type:"quickfire", digit:"3",
        checks:[
          {statement:"Vape detectors cut bathroom vaping 70%",answer:true},
          {statement:"All schools can afford HEPA filters",answer:false},
          {statement:"FDA flavor ban dropped teen vaping",answer:true},
          {statement:"Only personal choices affect lung health",answer:false}
        ],
        scannerHints:[
          "Schools with detectors saw a big drop.",
          "Underfunded schools were left out.",
          "Teen vaping went from 20% to 6%.",
          "Systems and policies matter too."
        ],
        scannerText:"üîç Scan detected: Policy sim ‚Äî some policies cut vaping and improved air, others left communities unprotected.",
        scanPreview:{title:"SCANNING ROOM...",desc:"Policy dashboard detected",visual:"policy"}
      }
    ]
  }
];

const FINAL_LOCK = {
  pairs:[
    {term:"Trigger üèöÔ∏è",target:"Mold, smoke, pollution",roomColor:"#e63946",roomIdx:0},
    {term:"Shallow breathing ü´Å",target:"O‚ÇÇ drops, CO‚ÇÇ rises",roomColor:"#0077b6",roomIdx:1},
    {term:"FDA flavor ban ‚öñÔ∏è",target:"Teen vaping dropped",roomColor:"#2d6a4f",roomIdx:2}
  ]
};

// ===== STATE =====
let state = {
  screen:'start', currentRoom:0, currentPuzzle:0,
  puzzlesSolved:0, firstTrySolves:0, streak:0,
  roomDigits:[[null,null],[null,null],[null,null]],
  roomCleared:[false,false,false],
  roomSkipped:[false,false,false],
  roomFirstTries:[[null,null],[null,null],[null,null]],
  roomScannerUsed:[[false,false],[false,false],[false,false]],
  startTime:null, endTime:null,
  wrongCount:0, scannerActive:false, overrideTriggered:false,
  puzzleSolving:false, codeInput:'',
  // Quick Fire state
  qfIndex:0, qfCorrect:0, qfMissed:[], qfCumulativeWrong:0, qfRetrying:false, qfHints:[],
  // Match state
  matchPairIndex:0, matchSelected:null,
  // Sequence state
  seqStep:0,
  // Diagnostic state (not used this pack but included for safety)
  diagSlot:0,
  // Final lock
  finalSelected:null, finalWrongCount:0, finalMatched:0,
  // Badges
  badges:[],
  // Emergency skip
  longPressTimer:null, shiftSTimer:null, shiftSHeld:false,
  // Intervals to track
  intervals:[]
};

function clearAllIntervals(){state.intervals.forEach(id=>clearInterval(id));state.intervals=[];}

// ===== UTILITIES =====
function $(id){return document.getElementById(id);}
function closeAllOverlays(){
  try{
    ['scannerOverlay','digitReveal','codeEntry','passOverlay','scanPreview'].forEach(id=>{
      const el=$(id);if(el){el.classList.remove('active');el.style.display='none';}
    });
    document.querySelectorAll('.door-overlay').forEach(el=>el.remove());
    document.querySelectorAll('.final-lock-intro').forEach(el=>el.remove());
  }catch(e){}
}
function closeScanner(){
  try{const o=$('scannerOverlay');if(o){o.classList.remove('active');o.style.display='none';}}catch(e){}
}
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const s=$(id);if(s)s.classList.add('active');
}

function spawnParticles(x,y,color,count){
  try{
    const ct=Math.min(count||8,12);
    for(let i=0;i<ct;i++){
      const p=document.createElement('div');
      const angle=Math.random()*Math.PI*2;
      const dist=40+Math.random()*60;
      const dx=Math.cos(angle)*dist;
      const dy=Math.sin(angle)*dist;
      const size=4+Math.random()*6;
      Object.assign(p.style,{
        position:'fixed',left:x+'px',top:y+'px',width:size+'px',height:size+'px',
        background:color,borderRadius:Math.random()>0.5?'50%':'2px',
        zIndex:'100',pointerEvents:'none',
        animation:`particleBurst 0.6s ease forwards`
      });
      p.style.setProperty('--dx',dx+'px');
      p.style.setProperty('--dy',dy+'px');
      document.body.appendChild(p);
      p.addEventListener('animationend',()=>p.remove());
      setTimeout(()=>{if(p.parentNode)p.remove();},1000);
    }
  }catch(e){}
}

// Patch particleBurst to use CSS variables
(function(){
  const sheet=document.styleSheets[0];
  try{
    sheet.deleteRule(sheet.cssRules.length-4);// remove placeholder particleBurst
  }catch(e){}
  try{
    sheet.insertRule(`@keyframes particleBurst{0%{transform:translate(0,0) scale(1);opacity:1;}100%{transform:translate(var(--dx,30px),var(--dy,-30px)) scale(0);opacity:0;}}`,sheet.cssRules.length);
  }catch(e){}
})();

// ===== EMERGENCY SKIP =====
document.addEventListener('keydown',function(e){
  if(e.key==='S'&&e.shiftKey&&!state.shiftSHeld){
    state.shiftSHeld=true;
    state.shiftSTimer=setTimeout(()=>{
      try{triggerEmergencySkip();}catch(er){}
    },2000);
  }
});
document.addEventListener('keyup',function(e){
  if(e.key==='S'||e.key==='Shift'){
    state.shiftSHeld=false;
    if(state.shiftSTimer){clearTimeout(state.shiftSTimer);state.shiftSTimer=null;}
  }
});

function setupLongPress(el){
  let timer=null;let confirmed=false;
  function startPress(e){
    e.preventDefault();
    if(confirmed){
      triggerEmergencySkip();
      confirmed=false;
      return;
    }
    timer=setTimeout(()=>{
      confirmed=true;
      el.title='Hold again to reveal';
      try{el.style.textShadow='0 0 10px rgba(255,255,255,0.5)';}catch(ex){}
      setTimeout(()=>{confirmed=false;try{el.style.textShadow='';}catch(ex){}},4000);
    },5000);
  }
  function endPress(){if(timer){clearTimeout(timer);timer=null;}}
  el.addEventListener('mousedown',startPress);
  el.addEventListener('mouseup',endPress);
  el.addEventListener('mouseleave',endPress);
  el.addEventListener('touchstart',startPress,{passive:false});
  el.addEventListener('touchend',endPress);
}

function triggerEmergencySkip(){
  try{
    // Detect screen state
    if(state.screen==='finalLock'){
      closeAllOverlays();
      showEscapeReport();
      return;
    }
    if(state.screen==='room'&&state.currentRoom<3){
      const room=ROOMS[state.currentRoom];
      state.roomSkipped[state.currentRoom]=true;
      // Reveal both digits
      for(let p=0;p<2;p++){
        if(state.roomDigits[state.currentRoom][p]===null){
          state.roomDigits[state.currentRoom][p]=room.puzzles[p].digit;
          state.puzzlesSolved++;
        }
      }
      updateCounter();
      updateVault(state.currentRoom,room.code);
      state.roomCleared[state.currentRoom]=true;
      closeAllOverlays();
      if(state.currentRoom<2){
        state.currentRoom++;
        showPassTheLaptop();
      }else{
        showFinalLock();
      }
    }
  }catch(e){}
}

// ===== START GAME =====
function startGame(){
  try{
    state.startTime=Date.now();
    showScreen('gameScreen');
    $('codeVault').classList.add('visible');
    showTutorial();
  }catch(e){showScreen('gameScreen');showTutorial();}
}

// ===== TUTORIAL =====
function showTutorial(){
  state.screen='tutorial';
  $('roomLabel').innerHTML='üéì TUTORIAL';
  $('roomLabel').style.color='#00b4d8';
  $('roomProgress').textContent='';
  $('missionLine').textContent='Learn the controls before entering Room 1.';
  $('bottomBar').style.display='none';
  updateCounter();

  const area=$('puzzleArea');
  area.innerHTML='';
  area.innerHTML=`
    <div class="puzzle-instruction">üëÜ Tap a word on the LEFT, then tap its match on the RIGHT.</div>
    <div class="micro-progress" id="tutProgress">Pair 1 of 2</div>
    <div class="matched-pairs-area" id="tutMatched"></div>
    <div class="match-container" id="tutMatch">
      <div class="match-side left" id="tutLeft"></div>
      <div class="match-arrow">‚Üí</div>
      <div class="match-side right" id="tutRight"></div>
    </div>
    <button style="margin-top:24px;padding:10px 24px;font-size:14px;color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;" onclick="skipTutorial()">Skip Tutorial</button>
  `;

  const tutPairs=[
    {term:"Sun ‚òÄÔ∏è",correct:"Hot"},
    {term:"Ice üßä",correct:"Cold"}
  ];
  let tutStep=0;let tutSel=null;
  const allRights=["Hot","Cold"];

  function renderTutPair(){
    if(tutStep>=tutPairs.length){
      // Tutorial complete
      area.innerHTML='<div style="font-size:24px;font-weight:700;color:var(--text-bright);text-align:center;">Systems online.<br>Entering Room 1...</div>';
      setTimeout(()=>{beginRoom(0);},1500);
      return;
    }
    $('tutProgress').textContent=`Pair ${tutStep+1} of 2`;
    const pair=tutPairs[tutStep];
    const left=$('tutLeft');
    const right=$('tutRight');
    left.innerHTML='';right.innerHTML='';
    tutSel=null;

    const lc=document.createElement('div');
    lc.className='option-card';
    lc.style.borderColor='var(--teal)';
    lc.innerHTML=pair.term+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
    lc.onclick=function(){
      if(lc.classList.contains('selected')){lc.classList.remove('selected');tutSel=null;}
      else{left.querySelectorAll('.option-card').forEach(c=>c.classList.remove('selected'));lc.classList.add('selected');tutSel='left';}
    };
    left.appendChild(lc);

    const remaining=allRights.filter((_,i)=>i>=tutStep);
    remaining.forEach(rt=>{
      const rc=document.createElement('div');
      rc.className='option-card';
      rc.style.borderColor='var(--teal)';
      rc.innerHTML=rt+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
      rc.onclick=function(){
        if(!tutSel){
          // Auto-select the left card
          lc.classList.add('selected');tutSel='left';
        }
        if(rt===pair.correct){
          rc.classList.add('correct');
          rc.innerHTML=rt+' <span class="feedback-icon">‚úî</span>';
          lc.classList.add('correct','locked');
          const mp=$('tutMatched');
          mp.innerHTML+=`<div class="matched-pair"><span class="pair-check">‚úî</span>${pair.term} ‚Üí ${pair.correct}</div>`;
          tutStep++;
          setTimeout(renderTutPair,600);
        }else{
          rc.classList.add('wrong');
          rc.innerHTML=rt+' <span class="feedback-icon">‚úñ</span>';
          setTimeout(()=>{rc.classList.remove('wrong');rc.innerHTML=rt+'<span class="selected-badge">‚ñ∂ SELECTED</span>';},500);
        }
      };
      right.appendChild(rc);
    });
  }
  renderTutPair();
}

function skipTutorial(){beginRoom(0);}

// ===== ROOM SYSTEM =====
function beginRoom(roomIdx){
  try{
    state.currentRoom=roomIdx;
    state.currentPuzzle=0;
    state.screen='room';
    closeAllOverlays();
    const room=ROOMS[roomIdx];

    // Update UI chrome
    $('roomLabel').innerHTML=`${room.emoji} ${room.name}`;
    $('roomLabel').style.color=room.color;
    $('roomProgress').textContent=`Room ${roomIdx+1} of 3`;
    $('missionLine').textContent=room.mission;
    $('bottomBar').style.display='flex';
    document.body.style.background=`radial-gradient(ellipse at center, ${room.bg} 0%, var(--bg) 100%)`;

    setupLongPress($('roomLabel'));
    updateProgressDots(room);
    showScanPreview(room,0);
  }catch(e){
    // Safety: just load the puzzle
    loadPuzzle();
  }
}

function updateProgressDots(room){
  const dots=$('progressDots');
  dots.innerHTML='';
  for(let i=0;i<2;i++){
    const d=document.createElement('div');
    d.className='progress-dot'+(state.roomDigits[state.currentRoom][i]!==null?' filled':'');
    d.style.color=room.color;
    d.style.background=state.roomDigits[state.currentRoom][i]!==null?room.color:'rgba(255,255,255,0.15)';
    dots.appendChild(d);
  }
}

function showScanPreview(room,puzzleIdx){
  try{
    const puzzle=room.puzzles[puzzleIdx];
    if(!puzzle||!puzzle.scanPreview){loadPuzzle();return;}
    const sp=$('scanPreview');
    const content=$('scanPreviewContent');
    closeAllOverlays();
    let previewDone=false;
    function finishPreview(){
      if(previewDone)return;
      previewDone=true;
      sp.classList.remove('active');sp.style.display='none';
      loadPuzzle();
    }

    let visualHTML='';
    const v=puzzle.scanPreview.visual;
    if(v==='airway'){
      visualHTML=`<div style="display:flex;gap:20px;justify-content:center;align-items:center;">
        <div style="text-align:center;"><div style="width:40px;height:80px;border:3px solid ${room.color};border-radius:20px;margin:0 auto 6px;"></div><span style="font-size:11px;color:rgba(255,255,255,0.5);">Normal</span></div>
        <div style="text-align:center;"><div style="width:20px;height:80px;border:3px solid #e74c3c;border-radius:10px;margin:0 auto 6px;background:rgba(231,76,60,0.15);box-shadow:0 0 10px rgba(231,76,60,0.3);"></div><span style="font-size:11px;color:rgba(255,255,255,0.5);">Triggered</span></div>
      </div>`;
    }else if(v==='apartment'){
      visualHTML=`<div style="position:relative;width:200px;height:120px;margin:0 auto;background:rgba(0,0,0,0.4);border-radius:8px;border:2px solid ${room.accent};overflow:hidden;">
        <div style="position:absolute;top:10px;left:10px;font-size:28px;">üèöÔ∏è</div>
        <div style="position:absolute;bottom:10px;right:10px;font-size:24px;">ü´Å</div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;color:rgba(255,255,255,0.4);">Mold detected</div>
      </div>`;
    }else if(v==='gauges'){
      visualHTML=`<div style="display:flex;gap:16px;justify-content:center;">
        <div style="text-align:center;"><div style="width:24px;height:60px;background:linear-gradient(to top,#f39c12 40%,rgba(255,255,255,0.1) 40%);border-radius:4px;margin:0 auto 4px;"></div><span style="font-size:10px;color:rgba(255,255,255,0.4);">O‚ÇÇ</span></div>
        <div style="text-align:center;"><div style="width:24px;height:60px;background:linear-gradient(to top,#e74c3c 80%,rgba(255,255,255,0.1) 80%);border-radius:4px;margin:0 auto 4px;"></div><span style="font-size:10px;color:rgba(255,255,255,0.4);">CO‚ÇÇ</span></div>
      </div>`;
    }else if(v==='alveoli'){
      visualHTML=`<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
        <div style="width:30px;height:30px;border-radius:50%;background:rgba(255,150,150,0.4);border:2px solid rgba(255,100,100,0.5);"></div>
        <div style="width:30px;height:30px;border-radius:50%;background:rgba(255,165,0,0.3);border:2px solid rgba(255,165,0,0.5);"></div>
        <div style="width:30px;height:30px;border-radius:50%;background:rgba(128,128,128,0.3);border:2px solid rgba(128,128,128,0.5);"></div>
        <div style="position:relative;margin-left:16px;font-size:24px;">üö¨</div>
      </div>`;
    }else if(v==='diver'){
      visualHTML=`<div style="width:160px;height:100px;background:linear-gradient(180deg,#4a90d9 0%,#0a1628 100%);border-radius:8px;margin:0 auto;position:relative;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:32px;">ü§ø</div>
        <div style="position:absolute;top:15%;left:20%;color:#e74c3c;font-size:14px;font-weight:700;">‚Üí</div>
        <div style="position:absolute;top:15%;right:20%;color:#e74c3c;font-size:14px;font-weight:700;">‚Üê</div>
      </div>`;
    }else if(v==='policy'){
      visualHTML=`<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;font-size:24px;">üö® üç¨ üè´ ‚öñÔ∏è</div>`;
    }

    content.innerHTML=`
      <div class="scan-preview-title" style="color:${room.color};">${puzzle.scanPreview.title}</div>
      <div class="scan-preview-visual" style="border-color:${room.color}40;">${visualHTML}</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.35);margin-top:8px;">${puzzle.scanPreview.desc}</div>
    `;

    sp.classList.add('active');
    sp.style.display='flex';

    const timeout=setTimeout(finishPreview,3500);

    // Safety timeout
    setTimeout(finishPreview,5500);
  }catch(e){loadPuzzle();}
}

// ===== LOAD PUZZLE =====
function loadPuzzle(){
  try{
    // Reset guards
    state.puzzleSolving=false;
    state.overrideTriggered=false;
    state.wrongCount=0;
    state.scannerActive=false;

    const room=ROOMS[state.currentRoom];
    const puzzle=room.puzzles[state.currentPuzzle];
    const area=$('puzzleArea');
    area.innerHTML='';

    // Scanner button reset
    $('scannerBtn').classList.remove('glow');
    $('scannerBtn').style.borderColor='rgba(255,255,255,0.15)';

    switch(puzzle.type){
      case 'match': renderMatchLock(puzzle,room); break;
      case 'sequence': renderSequenceLock(puzzle,room); break;
      case 'scanner': renderSystemScanner(puzzle,room); break;
      case 'mystery': renderMysteryInput(puzzle,room); break;
      case 'visual': renderVisualRecall(puzzle,room); break;
      case 'quickfire': renderQuickFire(puzzle,room); break;
    }
  }catch(e){
    $('puzzleArea').innerHTML='<div style="text-align:center;padding:20px;"><p style="color:var(--red);margin-bottom:12px;">Something went wrong</p><button class="option-card" onclick="loadPuzzle()">Click to retry this puzzle</button></div>';
  }
}

// ===== MATCH LOCK =====
function renderMatchLock(puzzle,room){
  state.matchPairIndex=0;
  state.matchSelected=null;
  const area=$('puzzleArea');

  area.innerHTML=`
    <div class="puzzle-instruction">üëÜ Tap a word on the LEFT, then tap its match on the RIGHT.</div>
    <div class="micro-progress" id="matchProgress">Pair 1 of 3</div>
    <div class="matched-pairs-area" id="matchedArea"></div>
    <div class="match-container">
      <div class="match-side left" id="matchLeft"></div>
      <div class="match-arrow">‚Üí</div>
      <div class="match-side right" id="matchRight"></div>
    </div>
  `;
  renderMatchPair(puzzle,room);
}

function renderMatchPair(puzzle,room){
  try{
    const idx=state.matchPairIndex;
    if(idx>=puzzle.pairs.length){
      puzzleSolved(puzzle.digit,room);
      return;
    }

    const pair=puzzle.pairs[idx];
    $('matchProgress').textContent=`Pair ${idx+1} of 3`;

    // Auto-place last pair
    if(pair.wrongs.length===0){
      const mp=$('matchedArea');
      mp.innerHTML+=`<div class="matched-pair"><span class="pair-check">‚úî</span>${pair.term} ‚Üí ${pair.correct}</div>`;
      state.matchPairIndex++;
      setTimeout(()=>renderMatchPair(puzzle,room),500);
      return;
    }

    const left=$('matchLeft');
    const right=$('matchRight');
    left.innerHTML='';right.innerHTML='';

    // Left term
    const lc=document.createElement('div');
    lc.className='option-card';
    lc.style.borderLeftColor=room.color;
    lc.innerHTML=pair.term+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
    lc.onclick=function(){
      lc.classList.toggle('selected');
      state.matchSelected=lc.classList.contains('selected')?'left':null;
    };
    left.appendChild(lc);

    // Right options (correct + wrongs shuffled)
    let opts=[pair.correct,...pair.wrongs];
    opts=shuffleArray(opts);

    // If scanner narrowed, filter
    if(state.scannerActive&&puzzle.pairs[idx]){
      // Keep correct + 1 wrong (narrow to 2)
      if(opts.length>2){
        opts=[pair.correct,pair.wrongs[0]];
        opts=shuffleArray(opts);
      }
    }

    opts.forEach(opt=>{
      const rc=document.createElement('div');
      rc.className='option-card';
      rc.style.borderRightColor=room.color;
      rc.dataset.value=opt;
      rc.innerHTML=opt+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
      rc.onclick=function(){
        if(rc.classList.contains('disabled')||rc.classList.contains('dimmed'))return;
        // Auto-select left if not selected
        if(!lc.classList.contains('selected')){lc.classList.add('selected');state.matchSelected='left';}

        if(opt===pair.correct){
          rc.classList.add('correct');
          rc.innerHTML=opt+' <span class="feedback-icon">‚úî</span>';
          lc.classList.add('correct','locked');
          const mp=$('matchedArea');
          mp.innerHTML+=`<div class="matched-pair"><span class="pair-check">‚úî</span>${pair.term} ‚Üí ${pair.correct}</div>`;
          spawnParticles(rc.getBoundingClientRect().x+rc.offsetWidth/2,rc.getBoundingClientRect().y,room.color,8);
          state.matchPairIndex++;
          if(state.wrongCount===0&&!state.scannerActive){}// first try tracking handled in puzzleSolved
          setTimeout(()=>renderMatchPair(puzzle,room),600);
        }else{
          rc.classList.add('wrong');
          rc.innerHTML=opt+' <span class="feedback-icon">‚úñ</span>';
          state.wrongCount++;
          handleWrongAnswer(puzzle,room,rc,opt);
        }
      };
      right.appendChild(rc);
    });
  }catch(e){
    $('puzzleArea').innerHTML='<div style="text-align:center;padding:20px;"><p style="color:var(--red);">Something went wrong</p><button class="option-card" onclick="loadPuzzle()">Click to retry this puzzle</button></div>';
  }
}

// ===== SEQUENCE LOCK =====
function renderSequenceLock(puzzle,room){
  state.seqStep=0;
  const area=$('puzzleArea');
  const steps=puzzle.steps;

  area.innerHTML=`
    <div class="puzzle-instruction">Tap the steps in the correct order.</div>
    <div class="micro-progress" id="seqProgress">Step 1 of 3</div>
    <div class="puzzle-question" id="seqPrompt">What happens FIRST?</div>
    <div class="sequence-container">
      <div class="sequence-slots" id="seqSlots"></div>
      <div class="sequence-picks" id="seqPicks"></div>
    </div>
  `;

  // Render slots
  const slotsEl=$('seqSlots');
  for(let i=0;i<3;i++){
    const s=document.createElement('div');
    s.className='sequence-slot'+(i===0?' active':'');
    s.id='seqSlot'+i;
    s.textContent=(i===0)?'?':'';
    s.style.borderColor=i===0?room.accent:'rgba(255,255,255,0.15)';
    if(i<2){
      const arrow=document.createElement('div');
      arrow.className='sequence-arrow';
      arrow.textContent='‚Üí';
      slotsEl.appendChild(s);
      slotsEl.appendChild(arrow);
    }else{
      slotsEl.appendChild(s);
    }
  }

  // Render pick cards (shuffled)
  const picks=$('seqPicks');
  let shuffled=shuffleArray([...steps]);

  // If scanner active, narrow options
  if(state.scannerActive&&shuffled.length>2){
    // Keep correct step for current position + 1 wrong
    const correctLabel=steps[state.seqStep].label;
    const wrongs=shuffled.filter(s=>s.label!==correctLabel);
    shuffled=[steps[state.seqStep],...wrongs.slice(0,1)];
    shuffled=shuffleArray(shuffled);
  }

  shuffled.forEach(step=>{
    const c=document.createElement('div');
    c.className='option-card';
    c.style.borderColor=room.accent;
    c.dataset.label=step.label;
    c.innerHTML=step.label+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
    c.onclick=function(){
      if(c.classList.contains('disabled')||c.classList.contains('locked'))return;
      handleSeqPick(c,step,puzzle,room);
    };
    picks.appendChild(c);
  });
}

function handleSeqPick(card,step,puzzle,room){
  try{
    const correctStep=puzzle.steps[state.seqStep];
    if(step.label===correctStep.label){
      // Correct
      card.classList.add('correct','locked');
      card.innerHTML=step.label+' <span class="feedback-icon">‚úî</span>';
      const slot=$('seqSlot'+state.seqStep);
      slot.textContent=step.label;
      slot.classList.add('filled');
      slot.style.borderColor='var(--green)';
      spawnParticles(card.getBoundingClientRect().x+card.offsetWidth/2,card.getBoundingClientRect().y,room.color,6);
      state.seqStep++;

      if(state.seqStep>=3){
        // All done
        setTimeout(()=>puzzleSolved(puzzle.digit,room),600);
      }else if(state.seqStep===2){
        // Auto-place last
        $('seqProgress').textContent='Complete!';
        $('seqPrompt').textContent='';
        const remaining=document.querySelectorAll('#seqPicks .option-card:not(.locked)');
        if(remaining.length>=1){
          setTimeout(()=>{
            // Un-dim all remaining cards first
            remaining.forEach(c=>{c.classList.remove('dimmed');c.style.pointerEvents='';});
            const lastCard=document.querySelector('#seqPicks .option-card:not(.locked)');
            if(lastCard){
              lastCard.classList.add('correct','locked');
              lastCard.innerHTML=lastCard.dataset.label+' <span class="feedback-icon">‚úî</span>';
              const slot=$('seqSlot2');
              slot.textContent=lastCard.dataset.label;
              slot.classList.add('filled');
              slot.style.borderColor='var(--green)';
            }
            state.seqStep=3;
            setTimeout(()=>puzzleSolved(puzzle.digit,room),600);
          },400);
        }
      }else{
        $('seqProgress').textContent=`Step ${state.seqStep+1} of 3`;
        $('seqPrompt').textContent='What happens NEXT?';
        const nextSlot=$('seqSlot'+state.seqStep);
        if(nextSlot){nextSlot.classList.add('active');nextSlot.textContent='?';nextSlot.style.borderColor=room.accent;}
        // Un-dim all non-locked cards so student can pick any remaining
        document.querySelectorAll('#seqPicks .option-card:not(.locked)').forEach(c=>{
          c.classList.remove('dimmed','wrong');
          c.style.pointerEvents='';
          // Restore clean text
          const label=c.dataset.label;
          c.innerHTML=label+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
        });
      }
    }else{
      // Wrong
      card.classList.add('wrong');
      card.innerHTML=step.label+' <span class="feedback-icon">‚úñ</span>';
      state.wrongCount++;
      handleWrongAnswer(puzzle,room,card,step.label);
    }
  }catch(e){}
}

// ===== SYSTEM SCANNER =====
function renderSystemScanner(puzzle,room){
  const area=$('puzzleArea');
  let gaugesHTML='<div class="gauges-panel">';
  puzzle.gauges.forEach(g=>{
    const colors={green:'#2ecc71',amber:'#f39c12',red:'#e74c3c'};
    const fillColor=colors[g.zone]||room.color;
    gaugesHTML+=`<div class="gauge">
      <div class="gauge-label" style="color:${room.accent};">${g.label}</div>
      <div class="gauge-bar">
        <div class="gauge-fill" style="height:${g.fill}%;background:${fillColor};box-shadow:0 0 8px ${fillColor};"></div>
      </div>
      <div class="gauge-arrow">${g.arrow}</div>
    </div>`;
  });
  gaugesHTML+='</div>';
  if(puzzle.setting)gaugesHTML+=`<div class="gauge-setting">${puzzle.setting}</div>`;

  area.innerHTML=`
    ${gaugesHTML}
    <div class="puzzle-question">${puzzle.question}</div>
    <div class="option-cards" id="scannerOpts"></div>
  `;

  let opts=[...puzzle.options];
  // If scanner narrowed
  if(state.scannerActive&&puzzle.narrowTo){
    opts=puzzle.options.filter(o=>puzzle.narrowTo.includes(o.text));
  }
  opts=shuffleArray(opts);

  const container=$('scannerOpts');
  opts.forEach(opt=>{
    const c=document.createElement('div');
    c.className='option-card';
    c.style.borderColor=room.accent;
    c.innerHTML=opt.text+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
    if(opt.correct)c.dataset.correct="true";
    c.onclick=()=>handleTapSelect(c,opt,puzzle,room);
    container.appendChild(c);
  });
}

// ===== MYSTERY INPUT =====
function renderMysteryInput(puzzle,room){
  const area=$('puzzleArea');
  let chainHTML='<div class="chain-container">';
  puzzle.chain.forEach((panel,i)=>{
    if(i>0)chainHTML+='<div class="chain-arrow-icon">‚Üí</div>';
    if(panel.hidden){
      chainHTML+=`<div class="chain-panel mystery" id="mysteryPanel">???</div>`;
    }else{
      chainHTML+=`<div class="chain-panel">${panel.text}</div>`;
    }
  });
  chainHTML+='</div>';

  area.innerHTML=`
    ${chainHTML}
    <div class="puzzle-question">${puzzle.question}</div>
    <div class="option-cards" id="mysteryOpts"></div>
  `;

  let opts=[...puzzle.options];
  if(state.scannerActive&&puzzle.narrowTo){
    opts=puzzle.options.filter(o=>puzzle.narrowTo.includes(o.text));
  }
  opts=shuffleArray(opts);

  const container=$('mysteryOpts');
  opts.forEach(opt=>{
    const c=document.createElement('div');
    c.className='option-card';
    c.style.borderColor=room.accent;
    c.innerHTML=opt.text+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
    if(opt.correct)c.dataset.correct="true";
    c.onclick=()=>handleTapSelect(c,opt,puzzle,room);
    container.appendChild(c);
  });
}

// ===== VISUAL RECALL =====
function renderVisualRecall(puzzle,room){
  const area=$('puzzleArea');

  area.innerHTML=`
    <div class="vr-scene">
      <div class="vr-surface"></div>
      <div class="vr-surface-label">SURFACE</div>
      <div class="vr-diver">
        <div class="vr-diver-head"></div>
        <div class="vr-diver-body"></div>
        <div class="vr-diver-legs"><div class="vr-diver-leg"></div><div class="vr-diver-leg"></div></div>
      </div>
      <div class="vr-lungs">
        <div class="vr-lung-ghost"></div>
        <div class="vr-lung-solid"></div>
      </div>
      <div class="vr-arrow left" style="left:12%;top:52%;">BLOOD ‚Üí </div>
      <div class="vr-arrow right" style="right:12%;top:52%;">‚Üê BLOOD</div>
      <div class="vr-arrow" style="left:35%;bottom:25%;transform:rotate(-45deg);">BLOOD ‚Üí</div>
      <div class="vr-arrow" style="right:30%;bottom:25%;transform:rotate(45deg);">‚Üê BLOOD</div>
      <div class="vr-pressure p-top">‚¨á</div>
      <div class="vr-pressure p-left">‚û°</div>
      <div class="vr-pressure p-right">‚¨Ö</div>
      <div class="vr-pressure p-bottom">‚¨Ü</div>
      <div class="vr-label depth">Deep Water</div>
      <div class="vr-label lung-size">Lungs at 1/5 size</div>
    </div>
    <div class="puzzle-question">${puzzle.question}</div>
    <div class="option-cards" id="vrOpts"></div>
  `;

  let opts=[...puzzle.options];
  if(state.scannerActive&&puzzle.narrowTo){
    opts=puzzle.options.filter(o=>puzzle.narrowTo.includes(o.text));
  }
  opts=shuffleArray(opts);

  const container=$('vrOpts');
  opts.forEach(opt=>{
    const c=document.createElement('div');
    c.className='option-card';
    c.style.borderColor=room.accent;
    c.innerHTML=opt.text+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
    if(opt.correct)c.dataset.correct="true";
    c.onclick=()=>handleTapSelect(c,opt,puzzle,room);
    container.appendChild(c);
  });
}

// ===== QUICK FIRE =====
function renderQuickFire(puzzle,room){
  state.qfIndex=0;state.qfCorrect=0;state.qfMissed=[];state.qfCumulativeWrong=0;state.qfRetrying=false;state.qfHints=[];
  const area=$('puzzleArea');
  area.innerHTML=`
    <div class="puzzle-instruction">Verify each system check ‚Äî CONFIRM ‚úî or DENY ‚úñ</div>
    <div class="micro-progress" id="qfProgress">Check 1 of 4</div>
    <div class="qf-statement" id="qfStatement"></div>
    <div class="qf-buttons">
      <button class="qf-btn confirm" id="qfConfirm" onclick="handleQF(true)">CONFIRM ‚úî</button>
      <button class="qf-btn deny" id="qfDeny" onclick="handleQF(false)">DENY ‚úñ</button>
    </div>
  `;
  const checkIndices=puzzle.checks.map((_,i)=>i);
  showQFCheckAt(puzzle,room,checkIndices);
}


function handleQF(isConfirm){
  try{
    const puzzle=ROOMS[state.currentRoom].puzzles[state.currentPuzzle];
    const room=ROOMS[state.currentRoom];
    // Snapshot the checks list for this pass
    const checkIndices=state.qfRetrying?[...state.qfMissed]:puzzle.checks.map((_,i)=>i);
    if(state.qfIndex>=checkIndices.length)return;

    const origIdx=checkIndices[state.qfIndex];
    const check=puzzle.checks[origIdx];
    const isCorrect=(isConfirm===check.answer);

    if(isCorrect){
      const btn=isConfirm?$('qfConfirm'):$('qfDeny');
      btn.classList.add('correct-flash');
      $('qfStatement').innerHTML=check.statement+' <span style="color:var(--green);font-size:20px;">‚úî</span>';
      state.qfCorrect++;
      // Mark as no longer missed
      const mi=state.qfMissed.indexOf(origIdx);
      if(mi>-1)state.qfMissed.splice(mi,1);
      state.qfIndex++;
      setTimeout(()=>{
        if(state.qfIndex>=checkIndices.length){finishQFPass(puzzle,room);}
        else{showQFCheckAt(puzzle,room,checkIndices);}
      },600);
    }else{
      const btn=isConfirm?$('qfConfirm'):$('qfDeny');
      btn.classList.add('wrong-flash');
      $('qfStatement').innerHTML=check.statement+' <span style="color:var(--red);font-size:20px;">‚úñ</span>';
      state.qfCumulativeWrong++;
      state.wrongCount++;
      if(!state.qfMissed.includes(origIdx)){
        state.qfMissed.push(origIdx);
      }

      // After 1st wrong on QF, activate scanner
      if(state.wrongCount===1&&!state.scannerActive){
        state.scannerActive=true;
        $('scannerBtn').classList.add('glow');
        state.roomScannerUsed[state.currentRoom][state.currentPuzzle]=true;
        openScannerAuto(puzzle);
      }

      state.qfIndex++;
      setTimeout(()=>{
        if(state.qfCumulativeWrong>=3){
          // Override
          $('qfStatement').textContent='System override ‚Äî protocols accepted';
          $('qfStatement').style.borderColor=room.color;
          $('qfConfirm').style.display='none';
          $('qfDeny').style.display='none';
          state.qfCorrect=3;
          setTimeout(()=>puzzleSolved(puzzle.digit,room),1200);
          return;
        }
        if(state.qfIndex>=checkIndices.length){finishQFPass(puzzle,room);}
        else{showQFCheckAt(puzzle,room,checkIndices);}
      },600);
    }
  }catch(e){}
}

function finishQFPass(puzzle,room){
  if(state.qfCorrect>=3){
    puzzleSolved(puzzle.digit,room);
  }else if(state.qfMissed.length===0){
    puzzleSolved(puzzle.digit,room);
  }else{
    state.qfRetrying=true;
    state.qfIndex=0;
    const checkIndices=[...state.qfMissed];
    showQFCheckAt(puzzle,room,checkIndices);
  }
}

function showQFCheckAt(puzzle,room,checkIndices){
  try{
    if(state.qfIndex>=checkIndices.length){finishQFPass(puzzle,room);return;}

    if(state.qfCumulativeWrong>=3){
      $('qfStatement').textContent='System override ‚Äî protocols accepted';
      $('qfConfirm').style.display='none';
      $('qfDeny').style.display='none';
      state.qfCorrect=3;
      setTimeout(()=>puzzleSolved(puzzle.digit,room),1200);
      return;
    }

    const origIdx=checkIndices[state.qfIndex];
    const check=puzzle.checks[origIdx];
    $('qfProgress').textContent=state.qfRetrying?`Retry: Check ${state.qfIndex+1} of ${checkIndices.length}`:`Check ${state.qfIndex+1} of ${checkIndices.length}`;
    $('qfStatement').textContent=check.statement;
    $('qfStatement').style.borderColor='rgba(255,255,255,0.1)';

    if(state.scannerActive&&puzzle.scannerHints&&puzzle.scannerHints[origIdx]){
      $('qfStatement').innerHTML=check.statement+`<div style="font-size:12px;color:var(--teal);margin-top:8px;">üîç ${puzzle.scannerHints[origIdx]}</div>`;
    }

    $('qfConfirm').style.display='';
    $('qfDeny').style.display='';
    $('qfConfirm').className='qf-btn confirm';
    $('qfDeny').className='qf-btn deny';
  }catch(e){}
}

// ===== TAP-TO-SELECT HANDLER (System Scanner, Visual Recall, Mystery Input) =====
function handleTapSelect(card,opt,puzzle,room){
  try{
    if(card.classList.contains('disabled')||card.classList.contains('dimmed'))return;

    if(opt.correct){
      card.classList.add('correct');
      card.innerHTML=opt.text+' <span class="feedback-icon">‚úî</span>';
      // If mystery, reveal panel
      if(puzzle.type==='mystery'){
        const mp=$('mysteryPanel');
        if(mp){
          const hidden=puzzle.chain.find(c=>c.hidden);
          mp.textContent=hidden?hidden.text:'';
          mp.classList.remove('mystery');
          mp.classList.add('revealed');
        }
      }
      spawnParticles(card.getBoundingClientRect().x+card.offsetWidth/2,card.getBoundingClientRect().y,room.color,8);
      setTimeout(()=>puzzleSolved(puzzle.digit,room),600);
    }else{
      card.classList.add('wrong');
      card.innerHTML=opt.text+' <span class="feedback-icon">‚úñ</span>';
      state.wrongCount++;
      handleWrongAnswer(puzzle,room,card,opt.text);
    }
  }catch(e){}
}

// ===== WRONG ANSWER HANDLER =====
function handleWrongAnswer(puzzle,room,card,value){
  try{
    if(state.wrongCount===1){
      // 1st wrong: scanner auto-activates + narrow to 2 choices
      state.scannerActive=true;
      state.roomScannerUsed[state.currentRoom][state.currentPuzzle]=true;
      $('scannerBtn').classList.add('glow');

      // Dim the wrong card
      setTimeout(()=>{
        card.classList.remove('wrong');
        card.classList.add('dimmed');
        card.innerHTML=value+' <span class="feedback-icon">‚úñ</span>';
      },400);

      // Auto-open scanner
      openScannerAuto(puzzle);

      // For tap-select puzzles, dim options not in the narrowTo list
      if(['scanner','mystery','visual'].includes(puzzle.type)&&puzzle.narrowTo){
        setTimeout(()=>{
          const containerId=puzzle.type==='scanner'?'scannerOpts':puzzle.type==='mystery'?'mysteryOpts':'vrOpts';
          const container=document.getElementById(containerId);
          if(container){
            container.querySelectorAll('.option-card:not(.dimmed)').forEach(c=>{
              const txt=c.textContent.replace('‚ñ∂ SELECTED','').replace('‚úñ','').replace('‚úî','').trim();
              // Check if this option text starts with any narrowTo option text
              const inNarrow=puzzle.narrowTo.some(n=>txt.startsWith(n.split(' ')[0]));
              if(!inNarrow){
                c.classList.add('dimmed');
                c.style.opacity='0.3';
                c.style.pointerEvents='none';
              }
            });
          }
        },500);
      }

      // For match, just leave the dimmed card ‚Äî don't re-render
      if(puzzle.type==='match'){
        setTimeout(()=>{
          card.classList.remove('wrong');
          card.classList.add('dimmed');
          card.innerHTML=value+' <span class="feedback-icon">‚úñ</span>';
        },400);
      }
      if(puzzle.type==='sequence'){
        setTimeout(()=>{
          card.classList.remove('wrong');
          card.classList.add('dimmed');
          card.innerHTML=value+' <span class="feedback-icon">‚úñ</span>';
        },400);
      }
    }
    else if(state.wrongCount>=2&&!state.overrideTriggered){
      // 2nd wrong: LOCK OVERRIDE
      state.overrideTriggered=true;
      setTimeout(()=>{
        card.classList.remove('wrong');
        card.classList.add('dimmed');
      },300);

      setTimeout(()=>triggerOverride(puzzle,room),600);
    }else{
      // Already overriding or post-override
      setTimeout(()=>{
        card.classList.remove('wrong');
        card.classList.add('dimmed');
      },400);
    }
  }catch(e){}
}

function openScannerAuto(puzzle){
  try{
    $('scannerText').textContent=puzzle.scannerText||'Scanner analyzing...';
    $('scannerOverlay').classList.add('active');
    $('scannerOverlay').style.display='flex';
  }catch(e){}
}

function openScanner(){
  try{
    const puzzle=ROOMS[state.currentRoom]?.puzzles[state.currentPuzzle];
    if(puzzle){
      $('scannerText').textContent=puzzle.scannerText||'No data available.';
      $('scannerOverlay').classList.add('active');
      $('scannerOverlay').style.display='flex';
    }
  }catch(e){}
}

// ===== LOCK OVERRIDE =====
function triggerOverride(puzzle,room){
  try{
    closeScanner();

    if(['scanner','mystery','visual'].includes(puzzle.type)){
      // Highlight correct answer
      const containerId=puzzle.type==='scanner'?'scannerOpts':puzzle.type==='mystery'?'mysteryOpts':'vrOpts';
      const container=document.getElementById(containerId);
      if(container){
        const correctOpt=puzzle.options.find(o=>o.correct);
        container.querySelectorAll('.option-card').forEach(c=>{
          if(c.dataset.correct==='true'){
            c.classList.remove('dimmed','disabled','wrong');
            c.classList.add('selected');
            c.style.borderColor=room.color;
            c.style.boxShadow=`0 0 20px ${room.color}50`;
            c.style.opacity='1';
            c.style.pointerEvents='auto';
            c.innerHTML=correctOpt.text+' <span style="font-size:11px;color:'+room.accent+';">Scanner locked on</span>';
            // Let student tap to proceed
            c.onclick=()=>{
              c.classList.add('correct');
              if(puzzle.type==='mystery'){
                const mp=$('mysteryPanel');
                if(mp){const h=puzzle.chain.find(ch=>ch.hidden);mp.textContent=h?h.text:'';mp.classList.remove('mystery');mp.classList.add('revealed');}
              }
              setTimeout(()=>puzzleSolved(puzzle.digit,room),400);
            };
          }else{
            c.classList.add('disabled');
            c.style.opacity='0.2';
            c.style.pointerEvents='none';
          }
        });
      }
    }
    else if(puzzle.type==='match'){
      // Auto-solve cascade
      autoSolveMatch(puzzle,room);
    }
    else if(puzzle.type==='sequence'){
      autoSolveSequence(puzzle,room);
    }
    else if(puzzle.type==='quickfire'){
      // Handled in QF logic
    }
  }catch(e){
    // Safety: just solve
    setTimeout(()=>puzzleSolved(puzzle.digit,room),500);
  }
}

function autoSolveMatch(puzzle,room){
  try{
    let idx=state.matchPairIndex;
    function solveNext(){
      if(idx>=puzzle.pairs.length){
        setTimeout(()=>puzzleSolved(puzzle.digit,room),500);
        return;
      }
      const pair=puzzle.pairs[idx];
      const mp=$('matchedArea');
      mp.innerHTML+=`<div class="matched-pair"><span class="pair-check">‚úî</span>${pair.term} ‚Üí ${pair.correct} <span style="font-size:10px;color:var(--teal);">Lock override</span></div>`;
      idx++;
      setTimeout(solveNext,500);
    }
    solveNext();
  }catch(e){puzzleSolved(puzzle.digit,room);}
}

function autoSolveSequence(puzzle,room){
  try{
    let step=state.seqStep;
    function solveNext(){
      if(step>=3){
        setTimeout(()=>puzzleSolved(puzzle.digit,room),500);
        return;
      }
      const slot=$('seqSlot'+step);
      if(slot){
        slot.textContent=puzzle.steps[step].label;
        slot.classList.add('filled');
        slot.style.borderColor='var(--green)';
      }
      // Lock card
      document.querySelectorAll('#seqPicks .option-card').forEach(c=>{
        if(c.dataset.label===puzzle.steps[step].label){
          c.classList.add('correct','locked');
          c.innerHTML=puzzle.steps[step].label+' <span class="feedback-icon">‚úî</span>';
        }
      });
      step++;
      setTimeout(solveNext,500);
    }
    solveNext();
  }catch(e){puzzleSolved(puzzle.digit,room);}
}

// ===== PUZZLE SOLVED =====
function puzzleSolved(digit,room){
  try{
    if(state.puzzleSolving)return;
    state.puzzleSolving=true;
    closeScanner();
    closeAllOverlays();

    const ri=state.currentRoom;
    const pi=state.currentPuzzle;

    // Record digit
    state.roomDigits[ri][pi]=digit;
    state.puzzlesSolved++;

    // Update vault with this digit immediately
    updateVaultDigit(ri,pi,digit);

    // First try tracking
    if(state.wrongCount===0&&!state.scannerActive){
      state.roomFirstTries[ri][pi]=true;
      state.firstTrySolves++;
      state.streak++;
    }else{
      state.roomFirstTries[ri][pi]=false;
      state.streak=0;
    }

    updateCounter();
    updateStreak();
    updateProgressDots(room);

    // Show digit reveal
    showDigitReveal(digit,room,ri,pi);
  }catch(e){
    // Safety: advance anyway
    state.puzzleSolving=false;
    advanceAfterPuzzle();
  }
}

function showDigitReveal(digit,room,ri,pi){
  try{
    closeAllOverlays();
    const dr=$('digitReveal');
    $('digitNum').textContent=digit;
    $('digitNum').style.color=room.color;
    $('digitNum').style.textShadow=`0 0 40px ${room.color}`;
    $('digitLabel').textContent=`Code digit ${pi+1} of 2 unlocked`;
    dr.classList.add('active');
    dr.style.display='flex';

    $('digitContinue').onclick=function(){
      dr.classList.remove('active');
      dr.style.display='none';
      advanceAfterPuzzle();
    };

    // Safety timeout
    setTimeout(()=>{
      if(dr.classList.contains('active')){
        dr.classList.remove('active');dr.style.display='none';
        advanceAfterPuzzle();
      }
    },10000);
  }catch(e){advanceAfterPuzzle();}
}

function advanceAfterPuzzle(){
  try{
    state.puzzleSolving=false;
    const ri=state.currentRoom;
    const pi=state.currentPuzzle;
    const room=ROOMS[ri];

    if(pi===0){
      // Show next puzzle in same room
      state.currentPuzzle=1;
      showScanPreview(room,1);
    }else{
      // Room complete ‚Äî show code entry
      showCodeEntry(room,ri);
    }
  }catch(e){}
}

// ===== CODE ENTRY =====
function showCodeEntry(room,ri){
  try{
    closeAllOverlays();
    state.codeInput='';
    const ce=$('codeEntry');
    const box=$('codeEntryBox');
    box.style.borderColor=room.color;

    // Show the digits the student earned
    const d0=state.roomDigits[ri][0]||'?';
    const d1=state.roomDigits[ri][1]||'?';
    const hintText=`Your digits: ${d0} ${d1}`;

    // Build digits display
    const digits=$('codeDigits');
    digits.innerHTML='';
    for(let i=0;i<2;i++){
      const d=document.createElement('div');
      d.className='code-digit-box';
      d.id='codeDigitBox'+i;
      d.style.borderColor=room.color+'50';
      digits.appendChild(d);
    }

    // Update subtitle with earned digits
    ce.querySelector('.code-entry-sub').textContent=hintText;

    // Build numpad
    const numpad=$('codeNumpad');
    numpad.innerHTML='';
    for(let i=1;i<=9;i++){
      const b=document.createElement('button');
      b.className='numpad-btn';
      b.textContent=i;
      b.onclick=()=>codeDigitInput(i.toString(),room,ri);
      numpad.appendChild(b);
    }
    // Row 4: empty, 0, backspace
    const empty=document.createElement('div');
    numpad.appendChild(empty);
    const b0=document.createElement('button');
    b0.className='numpad-btn';b0.textContent='0';b0.onclick=()=>codeDigitInput('0',room,ri);
    numpad.appendChild(b0);
    const bk=document.createElement('button');
    bk.className='numpad-btn backspace';bk.textContent='‚å´';bk.onclick=()=>{
      if(state.codeInput.length>0){
        state.codeInput=state.codeInput.slice(0,-1);
        updateCodeDisplay();
      }
    };
    numpad.appendChild(bk);

    ce.classList.add('active');
    ce.style.display='flex';
  }catch(e){}
}

function codeDigitInput(d,room,ri){
  try{
    if(state.codeInput.length>=2)return;
    state.codeInput+=d;
    updateCodeDisplay();

    if(state.codeInput.length===2){
      const correct=room.code;
      if(state.codeInput===correct){
        // Correct!
        for(let i=0;i<2;i++){
          const box=$('codeDigitBox'+i);
          if(box){box.classList.add('correct-digit');box.style.borderColor='var(--green)';}
        }
        updateVault(ri,correct);
        state.roomCleared[ri]=true;

        setTimeout(()=>{
          closeAllOverlays();
          if(ri<2){
            state.currentRoom=ri+1;
            showPassTheLaptop();
          }else{
            showFinalLock();
          }
        },800);
      }else{
        // Wrong code
        for(let i=0;i<2;i++){
          const box=$('codeDigitBox'+i);
          if(box){box.style.borderColor='var(--red)';box.style.animation='wrongShake 0.4s ease';}
        }
        setTimeout(()=>{
          state.codeInput='';
          updateCodeDisplay();
          for(let i=0;i<2;i++){
            const box=$('codeDigitBox'+i);
            if(box){box.style.borderColor=room.color+'50';box.style.animation='';}
          }
        },600);
      }
    }
  }catch(e){}
}

function updateCodeDisplay(){
  for(let i=0;i<2;i++){
    const box=$('codeDigitBox'+i);
    if(box){
      box.textContent=state.codeInput[i]||'';
      box.classList.toggle('filled',!!state.codeInput[i]);
    }
  }
}

// ===== CODE VAULT =====
function updateVaultDigit(ri,pi,digit){
  try{
    const el=$('vault'+ri+'d'+pi);
    if(el){
      el.textContent=digit;
      el.classList.remove('locked');
      el.classList.add('unlocked');
      el.style.color=ROOMS[ri].color;
    }
  }catch(e){}
}

function updateVault(ri,code){
  try{
    for(let i=0;i<2;i++){
      const el=$('vault'+ri+'d'+i);
      if(el){
        el.textContent=code[i];
        el.classList.remove('locked');
        el.classList.add('unlocked');
        el.style.color=ROOMS[ri].color;
      }
    }
  }catch(e){}
}

// ===== COUNTER & STREAK =====
function updateCounter(){
  try{
    const el=$('puzzleCounter');
    el.textContent=`Locks Cracked: ${state.puzzlesSolved} / 6`;
    el.classList.remove('pulse');
    void el.offsetWidth;
    el.classList.add('pulse');
  }catch(e){}
}

function updateStreak(){
  try{
    const icon=$('streakIcon');
    if(state.streak>=2){icon.classList.add('active');}
    else{icon.classList.remove('active');}
  }catch(e){}
}

// ===== PASS THE LAPTOP =====
function showPassTheLaptop(){
  try{
    closeAllOverlays();
    const nextRoom=ROOMS[state.currentRoom];
    const po=$('passOverlay');
    po.style.background=nextRoom.color;
    $('passEmoji').textContent=nextRoom.emoji;
    $('passReady').style.background=nextRoom.accent;
    $('passReady').style.color='#000';
    $('passReady').onclick=function(){
      po.classList.remove('active');
      po.style.display='none';
      showDoorTransition(nextRoom);
    };
    po.classList.add('active');
    po.style.display='flex';
  }catch(e){
    beginRoom(state.currentRoom);
  }
}

// ===== DOOR TRANSITION =====
function showDoorTransition(room){
  try{
    // Remove any existing door overlays
    document.querySelectorAll('.door-overlay').forEach(el=>el.remove());

    const overlay=document.createElement('div');
    overlay.className='door-overlay';
    overlay.style.background='rgba(0,0,0,0.95)';
    overlay.style.animation='doorAnim 1.2s ease forwards';

    const panel=document.createElement('div');
    panel.className='door-panel';
    panel.style.borderColor=room.color;

    const lock=document.createElement('div');
    lock.className='door-lock';
    lock.textContent='üîì';

    const name=document.createElement('div');
    name.className='door-room-name';
    name.style.color=room.color;
    name.textContent=room.name;

    panel.appendChild(lock);
    panel.appendChild(name);
    overlay.appendChild(panel);
    document.body.appendChild(overlay);

    overlay.addEventListener('animationend',()=>{
      try{overlay.remove();}catch(e){}
    });

    // Safety timeout
    setTimeout(()=>{
      try{overlay.remove();}catch(e){}
    },2000);

    // Load room while animation plays
    setTimeout(()=>{
      beginRoom(state.currentRoom);
    },600);
  }catch(e){
    beginRoom(state.currentRoom);
  }
}

// ===== FINAL LOCK =====
function showFinalLock(){
  try{
    state.screen='finalLock';
    state.finalSelected=null;
    state.finalWrongCount=0;
    state.finalMatched=0;
    closeAllOverlays();

    // Intro animation
    const intro=document.createElement('div');
    intro.className='final-lock-intro';
    const txt=document.createElement('div');
    txt.className='final-lock-text';
    txt.textContent='FINAL LOCK';
    intro.appendChild(txt);
    document.body.appendChild(intro);

    setTimeout(()=>{
      try{intro.remove();}catch(e){}
      renderFinalLock();
    },1500);

    // Safety
    setTimeout(()=>{
      try{intro.remove();}catch(e){}
      if(state.screen==='finalLock'&&state.finalMatched===0)renderFinalLock();
    },2500);
  }catch(e){renderFinalLock();}
}

function renderFinalLock(){
  try{
    showScreen('gameScreen');
    $('roomLabel').innerHTML='üîí FINAL LOCK';
    $('roomLabel').style.color='var(--text-bright)';
    $('roomProgress').textContent='';
    $('missionLine').textContent='MATCH THE SYSTEMS TO ESCAPE';
    $('bottomBar').style.display='none';
    document.body.style.background='radial-gradient(ellipse at center,#1a1a2e 0%,#0a0a1a 100%)';

    setupLongPress($('roomLabel'));

    const area=$('puzzleArea');
    area.innerHTML=`
      <div class="puzzle-instruction">üëÜ Tap a term on the LEFT, then tap its match on the RIGHT.</div>
      <div class="final-match-container">
        <div class="final-match-side" id="finalLeft"></div>
        <div style="font-size:28px;color:rgba(255,255,255,0.15);align-self:center;">‚Üí</div>
        <div class="final-match-side" id="finalRight"></div>
      </div>
    `;

    const left=$('finalLeft');
    const right=$('finalRight');

    // Terms (in order)
    FINAL_LOCK.pairs.forEach((p,i)=>{
      const c=document.createElement('div');
      c.className='final-card';
      c.style.borderColor=p.roomColor;
      c.dataset.idx=i;c.dataset.side='term';
      c.innerHTML=p.term+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
      c.onclick=()=>handleFinalSelect(c,'term',i);
      left.appendChild(c);
    });

    // Targets (shuffled)
    let targets=FINAL_LOCK.pairs.map((p,i)=>({text:p.target,idx:i,color:p.roomColor}));
    targets=shuffleArray(targets);
    targets.forEach(t=>{
      const c=document.createElement('div');
      c.className='final-card';
      c.style.borderColor='rgba(255,255,255,0.15)';
      c.dataset.idx=t.idx;c.dataset.side='target';
      c.innerHTML=t.text+'<span class="selected-badge">‚ñ∂ SELECTED</span>';
      c.onclick=()=>handleFinalSelect(c,'target',t.idx);
      right.appendChild(c);
    });
  }catch(e){}
}

function handleFinalSelect(card,side,idx){
  try{
    if(card.classList.contains('matched'))return;

    if(!state.finalSelected){
      // First selection
      document.querySelectorAll('.final-card').forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected');
      state.finalSelected={side,idx,card};
    }else{
      // Second selection
      if(state.finalSelected.side===side){
        // Same side ‚Äî switch selection
        state.finalSelected.card.classList.remove('selected');
        card.classList.add('selected');
        state.finalSelected={side,idx,card};
        return;
      }

      const termIdx=side==='term'?idx:state.finalSelected.idx;
      const targetIdx=side==='target'?idx:state.finalSelected.idx;

      if(termIdx===targetIdx){
        // Correct match!
        const pair=FINAL_LOCK.pairs[termIdx];
        card.classList.add('matched');
        card.style.borderColor=pair.roomColor;
        card.style.boxShadow=`0 0 15px ${pair.roomColor}50`;
        state.finalSelected.card.classList.remove('selected');
        state.finalSelected.card.classList.add('matched');
        state.finalSelected.card.style.boxShadow=`0 0 15px ${pair.roomColor}50`;
        state.finalMatched++;
        state.finalSelected=null;

        if(state.finalMatched>=3){
          setTimeout(showEscapeAnimation,500);
        }
      }else{
        // Wrong match
        card.classList.add('wrong');
        state.finalSelected.card.classList.add('wrong');
        state.finalWrongCount++;
        const prevCard=state.finalSelected.card;
        state.finalSelected=null;

        setTimeout(()=>{
          card.classList.remove('wrong','selected');
          prevCard.classList.remove('wrong','selected');
        },500);

        if(state.finalWrongCount>=2){
          // Auto-solve
          setTimeout(autoSolveFinalLock,700);
        }
      }
    }
  }catch(e){}
}

function autoSolveFinalLock(){
  try{
    let unmatched=[];
    FINAL_LOCK.pairs.forEach((p,i)=>{
      const termCard=document.querySelector(`#finalLeft .final-card[data-idx="${i}"]`);
      const targetCard=document.querySelector(`#finalRight .final-card[data-idx="${i}"]`);
      if(termCard&&!termCard.classList.contains('matched')){
        unmatched.push({termCard,targetCard,pair:p,idx:i});
      }
    });

    let delay=0;
    unmatched.forEach(u=>{
      setTimeout(()=>{
        u.termCard.classList.add('matched');
        u.termCard.style.borderColor=u.pair.roomColor;
        u.termCard.style.boxShadow=`0 0 15px ${u.pair.roomColor}50`;
        u.targetCard.classList.add('matched');
        u.targetCard.style.borderColor=u.pair.roomColor;
        u.targetCard.style.boxShadow=`0 0 15px ${u.pair.roomColor}50`;
        state.finalMatched++;
        if(state.finalMatched>=3){
          setTimeout(showEscapeAnimation,500);
        }
      },delay);
      delay+=600;
    });
  }catch(e){showEscapeAnimation();}
}

// ===== ESCAPE ANIMATION =====
function showEscapeAnimation(){
  try{
    closeAllOverlays();
    const area=$('puzzleArea');
    area.innerHTML='';
    $('roomLabel').innerHTML='';
    $('missionLine').textContent='';
    $('topBar').style.display='none';

    // Confetti
    for(let i=0;i<30;i++){
      const c=document.createElement('div');
      const colors=[ROOMS[0].color,ROOMS[1].color,ROOMS[2].color,ROOMS[0].accent,ROOMS[1].accent,ROOMS[2].accent];
      const col=colors[i%colors.length];
      const size=4+Math.random()*8;
      Object.assign(c.style,{
        position:'fixed',left:Math.random()*100+'%',top:'-20px',
        width:size+'px',height:size+'px',background:col,
        borderRadius:Math.random()>0.5?'50%':'2px',
        zIndex:'100',pointerEvents:'none',
        animation:`confettiFall ${1.5+Math.random()*2}s ease ${Math.random()*0.5}s forwards`
      });
      document.body.appendChild(c);
      c.addEventListener('animationend',()=>c.remove());
      setTimeout(()=>{if(c.parentNode)c.remove();},5000);
    }

    setTimeout(showEscapeReport,3000);
  }catch(e){showEscapeReport();}
}

// ===== ESCAPE REPORT =====
function showEscapeReport(){
  try{
    state.endTime=Date.now();
    closeAllOverlays();
    $('codeVault').classList.remove('visible');
    $('topBar').style.display='flex';
    showScreen('escapeReport');
    document.body.style.background='';

    const elapsed=state.endTime-state.startTime;
    const mins=Math.floor(elapsed/60000);
    const secs=Math.floor((elapsed%60000)/1000);

    // Calculate badges
    const badges=[];
    for(let r=0;r<3;r++){
      const ft=state.roomFirstTries[r];
      const sc=state.roomScannerUsed[r];
      // Clean Room: both puzzles on first or second try (wrongCount<=1 approximation via firstTry tracking)
      if(ft[0]!==false||ft[1]!==false){
        if((ft[0]===true||ft[0]===null)&&(ft[1]===true||ft[1]===null)&&!state.roomSkipped[r]){
          // At least not-false
        }
      }
      if(ft[0]===true&&ft[1]===true&&!state.roomSkipped[r]){
        badges.push({icon:'üßπ',name:'Clean Room',desc:`Room ${r+1}`});
      }
      // No Scanner
      if(!sc[0]&&!sc[1]&&!state.roomSkipped[r]&&ft[0]!==null&&ft[1]!==null){
        badges.push({icon:'üîï',name:'No Scanner',desc:`Room ${r+1}`});
      }
      // Comeback: scanner used but still solved
      for(let p=0;p<2;p++){
        if(sc[p]&&ft[p]!==null&&!state.roomSkipped[r]){
          badges.push({icon:'üîÑ',name:'Comeback',desc:`R${r+1}P${p+1}`});
        }
      }
      // Deep Scan: scanner used and got it right on next try
      for(let p=0;p<2;p++){
        if(sc[p]&&ft[p]===false&&!state.roomSkipped[r]){
          badges.push({icon:'üîç',name:'Deep Scan',desc:`R${r+1}P${p+1}`});
        }
      }
    }

    // Star rating
    let stars=1;
    if(state.firstTrySolves>=2)stars=2;
    if(state.firstTrySolves>=4)stars=3;

    // Deduplicate badges by name (keep first)
    const uniqueBadges=[];
    const seenNames=new Set();
    badges.forEach(b=>{
      if(!seenNames.has(b.name)){uniqueBadges.push(b);seenNames.add(b.name);}
    });

    const card=$('reportCard');
    let starsHTML='';
    for(let i=0;i<3;i++){
      starsHTML+=`<span class="report-star ${i<stars?'earned':''}" style="${i<stars?'animation:starFill 0.5s ease '+(i*0.3)+'s both;':''}">‚≠ê</span>`;
    }

    let badgesHTML='';
    if(uniqueBadges.length>0){
      badgesHTML=uniqueBadges.map(b=>`<div class="report-badge">${b.icon} ${b.name}</div>`).join('');
    }else{
      badgesHTML='<div style="color:rgba(255,255,255,0.3);font-size:13px;">Keep practicing!</div>';
    }

    const roomsCleared=state.roomCleared.filter(Boolean).length;

    card.innerHTML=`
      <div class="report-row"><span class="report-label">Chambers Breached</span><span class="report-value">${roomsCleared} / 3</span></div>
      <div class="report-row"><span class="report-label">Locks Cracked</span><span class="report-value">${state.puzzlesSolved} / 6</span></div>
      <div class="report-row"><span class="report-label">Clean Solves (first-try)</span><span class="report-value">${state.firstTrySolves} / 6</span></div>
      <div class="report-row"><span class="report-label">Crew Rating</span><span class="report-value"><div class="report-stars">${starsHTML}</div></span></div>
      <div class="report-row" style="flex-direction:column;align-items:flex-start;gap:4px;"><span class="report-label">Badges Earned</span><div class="report-badges">${badgesHTML}</div></div>
      <div class="report-row"><span class="report-label">Escape Time</span><span class="report-value">${mins}:${secs.toString().padStart(2,'0')}</span></div>
      ${state.roomSkipped.some(Boolean)?'<div class="report-row"><span class="report-label" style="color:rgba(255,255,255,0.3);">Rooms Skipped</span><span class="report-value" style="color:rgba(255,255,255,0.3);">'+state.roomSkipped.filter(Boolean).length+'</span></div>':''}
    `;
  }catch(e){}
}

function copyReport(){
  try{
    const elapsed=state.endTime-state.startTime;
    const mins=Math.floor(elapsed/60000);
    const secs=Math.floor((elapsed%60000)/1000);
    let stars=1;if(state.firstTrySolves>=2)stars=2;if(state.firstTrySolves>=4)stars=3;

    const text=`Mr. Jawad's Escape Room Simulations ‚Äî Respiratory System\nChambers Breached:\t${state.roomCleared.filter(Boolean).length}/3\nLocks Cracked:\t${state.puzzlesSolved}/6\nClean Solves:\t${state.firstTrySolves}/6\nCrew Rating:\t${'‚≠ê'.repeat(stars)}\nEscape Time:\t${mins}:${secs.toString().padStart(2,'0')}`;

    navigator.clipboard.writeText(text).then(()=>{
      $('reportCopied').style.display='block';
      setTimeout(()=>{$('reportCopied').style.display='none';},2000);
    }).catch(()=>{});
  }catch(e){}
}

function resetGame(){
  try{
    state={
      screen:'start',currentRoom:0,currentPuzzle:0,
      puzzlesSolved:0,firstTrySolves:0,streak:0,
      roomDigits:[[null,null],[null,null],[null,null]],
      roomCleared:[false,false,false],
      roomSkipped:[false,false,false],
      roomFirstTries:[[null,null],[null,null],[null,null]],
      roomScannerUsed:[[false,false],[false,false],[false,false]],
      startTime:null,endTime:null,
      wrongCount:0,scannerActive:false,overrideTriggered:false,
      puzzleSolving:false,codeInput:'',
      qfIndex:0,qfCorrect:0,qfMissed:[],qfCumulativeWrong:0,qfRetrying:false,qfHints:[],
      matchPairIndex:0,matchSelected:null,
      seqStep:0,diagSlot:0,
      finalSelected:null,finalWrongCount:0,finalMatched:0,
      badges:[],
      longPressTimer:null,shiftSTimer:null,shiftSHeld:false,
      intervals:[]
    };
    closeAllOverlays();
    $('codeVault').classList.remove('visible');
    $('topBar').style.display='flex';
    ['vault0d0','vault0d1','vault1d0','vault1d1','vault2d0','vault2d1'].forEach(id=>{
      const el=$(id);if(el){el.textContent='?';el.classList.remove('unlocked');el.classList.add('locked');el.style.color='';}
    });
    document.body.style.background='';
    showScreen('startScreen');
  }catch(e){location.reload();}
}

// ===== SHUFFLE =====
function shuffleArray(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

// Initial style fix
document.addEventListener('DOMContentLoaded',function(){
  try{$('topBar').style.display='flex';}catch(e){}
});
</script>
</body>
</html>
