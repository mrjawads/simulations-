<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation Antibiotic Resistance</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#0a0e1a 0%,#121832 50%,#0a1628 100%);color:#fff;height:100vh;overflow:hidden;user-select:none;}
#startScreen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;background:linear-gradient(135deg,#0a0e1a,#1a1a4e);padding:40px;}
.startGerm{font-size:130px;animation:germBob 3s ease-in-out infinite;}
@keyframes germBob{0%,100%{transform:translateY(0) rotate(0deg);}50%{transform:translateY(-18px) rotate(5deg);}}
#startScreen h1{font-size:48px;font-weight:900;background:linear-gradient(135deg,#4CAF50,#00BCD4,#7E57C2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:12px 0 4px;}
.startSub{font-size:20px;color:#90A4AE;margin-bottom:24px;}
.startMission{font-size:16px;color:#B0BEC5;max-width:500px;line-height:1.7;margin-bottom:32px;}
#startBtn{padding:18px 56px;border:none;border-radius:16px;font-size:24px;font-weight:900;cursor:pointer;background:linear-gradient(135deg,#4CAF50,#2E7D32);color:#fff;box-shadow:0 8px 30px rgba(76,175,80,0.5);transition:all .3s;}
#startBtn:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 12px 40px rgba(76,175,80,0.6);}
#app{display:none;height:100vh;flex-direction:column;padding:6px 8px;}
#topBar{display:flex;justify-content:space-between;align-items:center;padding:6px 16px;background:rgba(255,255,255,0.06);border-radius:12px;margin-bottom:6px;flex-shrink:0;}
#topBar h1{font-size:16px;font-weight:800;background:linear-gradient(90deg,#4CAF50,#00BCD4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.topBtns{display:flex;gap:6px;}
.topBtns button{padding:5px 14px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;}
#resetBtn{background:#ef5350;color:#fff;}
#newRunBtn{background:#42A5F5;color:#fff;}
#mainRow{display:flex;flex:1;gap:8px;min-height:0;}
#leftPanel{width:240px;display:flex;flex-direction:column;gap:6px;flex-shrink:0;}
.card{background:rgba(255,255,255,0.06);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.08);}
#roundCard{text-align:center;padding:10px 12px;}
#roundDisplay{font-size:44px;font-weight:900;background:linear-gradient(135deg,#FFD54F,#FF9800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;}
.roundSub{font-size:12px;color:#90A4AE;margin-top:2px;}
.missionTag{font-size:10px;color:#B0BEC5;margin-top:4px;font-style:italic;}
.varSection{margin-bottom:8px;}
.varLabel{font-size:12px;font-weight:700;color:#B0BEC5;margin-bottom:6px;display:flex;align-items:center;gap:6px;}
.lockIcon{font-size:10px;color:#FF9800;display:none;}
.varLabel.locked .lockIcon{display:inline;}
.optRow{display:flex;gap:4px;}
.optBtn{flex:1;padding:10px 2px;border:2px solid rgba(255,255,255,0.12);border-radius:10px;background:rgba(255,255,255,0.04);color:#ccc;font-size:12px;font-weight:700;cursor:pointer;transition:all .25s;text-align:center;}
.optBtn:hover:not(.locked):not(.selected){background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.25);}
.optBtn.selected{border-color:#4CAF50;background:rgba(76,175,80,0.2);color:#fff;box-shadow:0 0 14px rgba(76,175,80,0.3);}
.optBtn.locked{opacity:0.25;cursor:not-allowed;border-style:dashed;border-color:rgba(255,255,255,0.08);}
#treatBtn{width:100%;padding:13px;border:none;border-radius:12px;font-size:18px;font-weight:900;cursor:pointer;background:linear-gradient(135deg,#4CAF50,#2E7D32);color:#fff;box-shadow:0 4px 16px rgba(76,175,80,0.4);transition:all .3s;margin-top:2px;letter-spacing:1px;}
#treatBtn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 22px rgba(76,175,80,0.5);}
#treatBtn:disabled{opacity:0.35;cursor:not-allowed;transform:none;box-shadow:none;}
#treatBtn.active{background:linear-gradient(135deg,#FF9800,#E65100);animation:treatPulse .6s infinite;}
@keyframes treatPulse{0%,100%{box-shadow:0 0 12px rgba(255,152,0,0.5);}50%{box-shadow:0 0 28px rgba(255,152,0,0.8);}}
.toggleRow{display:flex;gap:6px;margin-top:auto;}
.togBtn{flex:1;padding:7px 4px;border:2px solid rgba(255,255,255,0.1);border-radius:8px;background:rgba(255,255,255,0.03);color:#78909C;font-size:10px;font-weight:700;cursor:pointer;text-align:center;transition:all .2s;}
.togBtn.on{border-color:#FF9800;color:#FFB74D;background:rgba(255,152,0,0.12);}
#centerCol{flex:1;display:flex;flex-direction:column;min-width:0;}
#arenaBox{flex:1;position:relative;border-radius:16px;overflow:hidden;background:radial-gradient(ellipse at center,#111a33 0%,#0a1020 100%);border:2px solid rgba(100,150,255,0.1);min-height:100px;}
#petri{position:absolute;border-radius:50%;border:3px solid rgba(180,200,230,0.25);background:radial-gradient(ellipse at 35% 30%,rgba(200,220,255,0.1) 0%,rgba(80,120,180,0.04) 60%,transparent 100%);box-shadow:0 0 50px rgba(100,160,255,0.08),inset 0 0 40px rgba(100,160,255,0.04);overflow:hidden;}
#bCanvas,#mCanvas{position:absolute;top:0;left:0;}
#mCanvas{z-index:5;}
#floatLayer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;}
@keyframes ftUp{0%{opacity:1;transform:translate(-50%,0);}100%{opacity:0;transform:translate(-50%,-50px);}}
#arenaLegend{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:14px;background:rgba(0,0,0,0.55);padding:5px 16px;border-radius:20px;font-size:11px;font-weight:600;z-index:6;}
.legDot{width:9px;height:9px;border-radius:50%;display:inline-block;margin-right:4px;vertical-align:middle;}
#sbAlert{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:20;background:rgba(198,40,40,0.94);padding:18px 36px;border-radius:16px;text-align:center;box-shadow:0 0 50px rgba(211,47,47,0.6);animation:sbPulse 1s infinite;}
@keyframes sbPulse{0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.04);}}
.sbMain{font-size:22px;font-weight:900;}.sbSub{font-size:12px;color:#ffcdd2;margin-top:4px;}
#endOverlay{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.88);z-index:25;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:24px;border-radius:16px;}
#rightPanel{width:220px;display:flex;flex-direction:column;gap:6px;flex-shrink:0;}
.hudItem{text-align:center;padding:8px 10px;}
.hudLabel{font-size:10px;color:#78909C;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;}
.hudVal{font-size:30px;font-weight:900;line-height:1.1;margin-top:2px;}
#rPct{transition:color .3s;}#rPct.g{color:#4CAF50;}#rPct.y{color:#FFB74D;}#rPct.r{color:#ef5350;}
#hpBar{width:100%;height:12px;background:rgba(255,255,255,0.08);border-radius:6px;overflow:hidden;margin-top:6px;}
#hpFill{height:100%;border-radius:6px;transition:width .6s,background .6s;width:95%;}
#scoreV{color:#42A5F5;}#streakV{color:#FFD54F;}
#badgePill{display:inline-block;padding:3px 12px;border-radius:16px;font-size:11px;font-weight:800;margin-top:4px;background:linear-gradient(135deg,#FFD54F,#FF9800);color:#333;}
#tBar{width:100%;height:16px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;margin-top:4px;}
#tFill{height:100%;border-radius:8px;width:0%;transition:width .4s;}
.progWrap{margin-top:6px;}.progLabel{font-size:10px;color:#78909C;margin-bottom:3px;}
.progTrack{width:100%;height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;}
.progBar{height:100%;border-radius:4px;background:linear-gradient(90deg,#4CAF50,#81C784);transition:width .4s;width:0%;}
#comboDisp{margin-top:4px;font-size:12px;font-weight:700;color:#CE93D8;min-height:18px;}
#dataArea{flex-shrink:0;padding:4px 0;margin-top:4px;}
#dataHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
#dataHead h3{font-size:13px;color:#B0BEC5;}
#cpyBtn{padding:5px 14px;border:none;border-radius:8px;background:linear-gradient(135deg,#7E57C2,#5E35B1);color:#fff;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;}
#cpyBtn:hover{box-shadow:0 4px 12px rgba(126,87,194,0.4);}
.tblWrap{max-height:140px;overflow-y:auto;border-radius:8px;border:1px solid rgba(255,255,255,0.06);}
#dTable{width:100%;border-collapse:collapse;font-size:11px;}
#dTable th{background:rgba(255,255,255,0.08);padding:5px 6px;text-align:center;font-weight:700;color:#90A4AE;position:sticky;top:0;z-index:2;}
#dTable td{padding:4px 6px;text-align:center;border-top:1px solid rgba(255,255,255,0.04);color:#ccc;}
#dTable tr.flash{animation:rFlash .8s;}
@keyframes rFlash{0%{background:rgba(255,235,59,0.25);}100%{background:transparent;}}
.reqNote{font-size:10px;color:#78909C;text-align:center;margin-top:3px;}
#ecMsg{display:none;text-align:center;padding:6px;background:rgba(76,175,80,0.15);border-radius:8px;margin-top:4px;font-size:12px;font-weight:700;color:#81C784;}
#ecBdg{display:none;text-align:center;padding:8px;background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,152,0,0.15));border-radius:8px;margin-top:4px;font-size:14px;font-weight:900;color:#FFD54F;}
.evTag{display:inline-block;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:700;margin-left:3px;}
.evTag.mut{background:rgba(156,39,176,0.25);color:#CE93D8;}
.evTag.bst{background:rgba(0,150,136,0.25);color:#80CBC4;}
</style>
</head>
<body>
<div id="startScreen">
<div class="startGerm">ü¶†</div>
<h1>SUPERBUG SHOWDOWN</h1>
<div class="startSub">Mr. Jawad's Antibiotic Resistance Lab</div>
<div class="startMission">Tough germs are growing in a patient ‚Äî your antibiotic choices decide what survives. Keep resistant bacteria below 50%!</div>
<button id="startBtn">START</button>
</div>
<div id="app">
<div id="topBar">
<h1>Mr. Jawad Simulation Antibiotic Resistance</h1>
<div class="topBtns"><button id="resetBtn">Reset</button><button id="newRunBtn">New Run</button></div>
</div>
<div id="mainRow">
<div id="leftPanel">
<div class="card" id="roundCard">
<div class="roundSub">ROUND</div><div id="roundDisplay">1</div><div class="roundSub">of 8</div>
<div class="missionTag">Keep resistance below 50%</div>
</div>
<div class="card">
<div class="varSection">
<div class="varLabel" id="doseLabel">Dose <span class="lockIcon">üîí</span></div>
<div class="optRow" id="doseRow">
<button class="optBtn" data-v="Low">Low</button>
<button class="optBtn" data-v="Medium">Med</button>
<button class="optBtn" data-v="High">High</button>
</div>
</div>
<div class="varSection">
<div class="varLabel" id="durLabel">Duration <span class="lockIcon">üîí</span></div>
<div class="optRow" id="durRow">
<button class="optBtn" data-v="Stop Early">Stop Early</button>
<button class="optBtn" data-v="Partial">Partial</button>
<button class="optBtn" data-v="Full Course">Full</button>
</div>
</div>
<button id="treatBtn" disabled>TREAT</button>
</div>
<div class="toggleRow">
<button class="togBtn" id="mutTog">Mutation OFF</button>
<button class="togBtn" id="bstTog">Boost OFF</button>
</div>
</div>
<div id="centerCol">
<div id="arenaBox">
<div id="petri"><canvas id="bCanvas"></canvas><canvas id="mCanvas"></canvas></div>
<div id="floatLayer"></div>
<div id="arenaLegend">
<span><span class="legDot" style="background:#4CAF50;"></span>Killable</span>
<span><span class="legDot" style="background:#ef5350;"></span>Resistant</span>
<span><span class="legDot" style="background:#42A5F5;"></span>Antibiotic</span>
</div>
<div id="sbAlert"><div class="sbMain">‚ö†Ô∏è SUPERBUG ALERT ‚ö†Ô∏è</div><div class="sbSub">This is what happens when treatment is incomplete.</div></div>
<div id="endOverlay"></div>
</div>
</div>
<div id="rightPanel">
<div class="card hudItem"><div class="hudLabel">Resistant %</div><div class="hudVal" id="rPct">5%</div><div id="hpBar"><div id="hpFill"></div></div></div>
<div class="card hudItem"><div class="hudLabel">Patient Health</div><div class="hudVal" id="healthV" style="color:#4CAF50;">95</div></div>
<div class="card hudItem"><div class="hudLabel">Score</div><div class="hudVal" id="scoreV">0</div></div>
<div class="card hudItem"><div class="hudLabel">Streak</div><div class="hudVal" id="streakV">0</div><div id="badgePill">Rookie</div><div id="comboDisp"></div></div>
<div class="card"><div class="hudLabel">Treatment Timer</div><div id="tBar"><div id="tFill"></div></div><div class="progWrap"><div class="progLabel">Rounds Done</div><div class="progTrack"><div class="progBar" id="progBar"></div></div></div></div>
</div>
</div>
<div id="dataArea">
<div id="dataHead"><h3>Results Table</h3><button id="cpyBtn">üìã Copy Table</button></div>
<div class="tblWrap"><table id="dTable"><thead><tr><th>Round</th><th>Antibiotic Dose</th><th>Treatment Duration</th><th>Resistant Bacteria %</th></tr></thead><tbody id="dBody"></tbody></table></div>
<div class="reqNote">Complete 5 rounds minimum (all 8 = extra credit)</div>
<div id="ecMsg">‚úÖ Required Complete! Continue for Extra Credit?</div>
<div id="ecBdg"></div>
</div>
</div>
<script>
(function(){
"use strict";
try{

var BACT=80, ready=false;
var G={round:1,dose:null,dur:null,prevDose:null,prevDur:null,resistPct:5,score:0,streak:0,treating:false,done:false,mutOn:false,bstOn:false,firstVar:null,bacteria:[],molecules:[],particles:[],results:[],cvW:0,cvH:0};

function EL(id){return document.getElementById(id);}
function safeR(v){return Math.max(1,v);}

/* ========== START ========== */
EL('startBtn').onclick=function(){
  EL('startScreen').style.display='none';
  EL('app').style.display='flex';
  setTimeout(function(){
    setTimeout(function(){
      sizeDish();
      if(G.cvW>10){spawn();ready=true;loop();}
      else{setTimeout(function(){sizeDish();spawn();ready=true;loop();},200);}
      refreshHUD();
    },100);
  },50);
};
EL('resetBtn').onclick=resetAll;
EL('newRunBtn').onclick=resetAll;

function resetAll(){
  G.round=1;G.dose=null;G.dur=null;G.prevDose=null;G.prevDur=null;
  G.resistPct=5;G.score=0;G.streak=0;G.treating=false;G.done=false;G.firstVar=null;
  G.bacteria=[];G.molecules=[];G.particles=[];G.results=[];
  EL('dBody').innerHTML='';EL('ecMsg').style.display='none';EL('ecBdg').style.display='none';
  EL('endOverlay').style.display='none';EL('sbAlert').style.display='none';
  EL('roundDisplay').textContent='1';EL('treatBtn').disabled=true;EL('treatBtn').textContent='TREAT';
  EL('treatBtn').classList.remove('active');EL('tFill').style.width='0%';EL('tFill').style.background='';
  EL('comboDisp').textContent='';unlockAll();
  sizeDish();spawn();refreshHUD();
}

function unlockAll(){
  document.querySelectorAll('#doseRow .optBtn,#durRow .optBtn').forEach(function(b){b.classList.remove('selected','locked');});
  EL('doseLabel').classList.remove('locked');EL('durLabel').classList.remove('locked');
}

/* ========== SIZING ========== */
function sizeDish(){
  try{
    var box=EL('arenaBox');
    var bw=box.clientWidth||300, bh=box.clientHeight||300;
    var d=Math.max(80,Math.min(bw,bh)*0.88);
    var petri=EL('petri');
    petri.style.width=d+'px';petri.style.height=d+'px';
    petri.style.top=Math.max(0,(bh-d)/2)+'px';
    petri.style.left=Math.max(0,(bw-d)/2)+'px';
    var cW=Math.round(d*2),cH=Math.round(d*2);
    ['bCanvas','mCanvas'].forEach(function(id){
      var c=EL(id);c.width=cW;c.height=cH;c.style.width=d+'px';c.style.height=d+'px';
    });
    G.cvW=cW;G.cvH=cH;
  }catch(e){}
}

window.addEventListener('resize',function(){if(ready){try{sizeDish();clampB();}catch(e){}}});

/* ========== BACTERIA ========== */
function spawn(){
  G.bacteria=[];
  var cx=G.cvW/2,cy=G.cvH/2,r=safeR(G.cvW/2-50);
  var nR=Math.round(BACT*G.resistPct/100);
  for(var i=0;i<BACT;i++){
    var a=Math.random()*Math.PI*2,dist=Math.random()*r*0.85;
    G.bacteria.push(mkB(cx+Math.cos(a)*dist,cy+Math.sin(a)*dist,i<nR));
  }
}

function mkB(x,y,res){
  return{x:x,y:y,vx:(Math.random()-0.5)*1,vy:(Math.random()-0.5)*1,res:res,alive:true,dying:false,dA:0,born:false,bA:0,sz:res?20:15,ang:Math.random()*Math.PI*2,wig:Math.random()*Math.PI*2,fP:Math.random()*Math.PI*2,shP:0};
}

function clampB(){
  var cx=G.cvW/2,cy=G.cvH/2,r=safeR(G.cvW/2-50);
  G.bacteria.forEach(function(b){
    var dx=b.x-cx,dy=b.y-cy,d=Math.sqrt(dx*dx+dy*dy);
    if(d>r){var a=Math.atan2(dy,dx);b.x=cx+Math.cos(a)*r;b.y=cy+Math.sin(a)*r;}
  });
}

/* ========== RENDER LOOP ========== */
function loop(){
  try{if(ready){drawB();drawM();}}catch(e){}
  requestAnimationFrame(loop);
}

function drawB(){
  var cv=EL('bCanvas');if(!cv)return;
  var ctx=cv.getContext('2d'),w=cv.width,h=cv.height;
  if(w<20||h<20)return;
  ctx.clearRect(0,0,w,h);
  var cx=w/2,cy=h/2,R=safeR(w/2-30);

  // ambient glow
  try{
    ctx.save();
    var ag=ctx.createRadialGradient(cx,cy,R*0.2,cx,cy,R);
    ag.addColorStop(0,'rgba(76,175,80,0.03)');ag.addColorStop(1,'rgba(76,175,80,0)');
    ctx.fillStyle=ag;ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fill();ctx.restore();
  }catch(e){}

  G.bacteria.forEach(function(b){
    try{
    if(!b.alive&&!b.dying)return;
    if(b.alive&&!b.dying){
      b.wig+=0.06;b.x+=b.vx+Math.sin(b.wig)*0.25;b.y+=b.vy+Math.cos(b.wig)*0.25;
      var dx=b.x-cx,dy=b.y-cy,d=Math.sqrt(dx*dx+dy*dy);
      if(d>R-b.sz){var a=Math.atan2(dy,dx);b.x=cx+Math.cos(a)*(R-b.sz);b.y=cy+Math.sin(a)*(R-b.sz);b.vx*=-0.6;b.vy*=-0.6;}
      b.ang=Math.atan2(b.vy+Math.cos(b.wig)*0.25,b.vx+Math.sin(b.wig)*0.25);
    }
    if(b.dying){
      b.dA+=0.035;if(b.dA>=1){b.dying=false;b.alive=false;return;}
      ctx.save();ctx.globalAlpha=1-b.dA;ctx.translate(b.x,b.y);ctx.rotate(b.ang);
      ctx.scale(1+b.dA*0.6,1+b.dA*0.6);rndB(ctx,b);ctx.restore();return;
    }
    if(b.born){
      b.bA+=0.025;if(b.bA>=1)b.born=false;
      ctx.save();ctx.globalAlpha=Math.min(b.bA*1.5,1);ctx.translate(b.x,b.y);ctx.rotate(b.ang);
      var sc=0.2+b.bA*0.8;ctx.scale(sc,sc);rndB(ctx,b);ctx.restore();return;
    }
    if(b.res&&b.shP>0){
      b.shP-=0.015;ctx.save();ctx.globalAlpha=b.shP*0.5;
      ctx.strokeStyle='#FFD54F';ctx.lineWidth=4;ctx.shadowColor='#FFD54F';ctx.shadowBlur=16;
      ctx.beginPath();ctx.arc(b.x,b.y,safeR(b.sz+16),0,Math.PI*2);ctx.stroke();ctx.restore();
    }
    ctx.save();ctx.translate(b.x,b.y);ctx.rotate(b.ang);rndB(ctx,b);ctx.restore();
    }catch(e){}
  });

  // particles
  G.particles=G.particles.filter(function(p){return p.life>0;});
  G.particles.forEach(function(p){
    try{
    p.x+=p.vx;p.y+=p.vy;p.life-=0.03;p.vy+=0.1;
    ctx.save();ctx.globalAlpha=Math.max(0,p.life);ctx.fillStyle=p.col;ctx.shadowColor=p.col;ctx.shadowBlur=8;
    ctx.beginPath();ctx.arc(p.x,p.y,safeR(p.sz*p.life),0,Math.PI*2);ctx.fill();ctx.restore();
    }catch(e){}
  });
}

function rndB(ctx,b){
  try{
  var col=b.res?'#ef5350':'#4CAF50';
  var colL=b.res?'#ff8a80':'#81C784';
  var colD=b.res?'#b71c1c':'#1B5E20';
  var sz=b.sz,bW=sz*2.4,bH=sz*1.15;
  var gr=ctx.createLinearGradient(-bW/2,-bH,bW/2,bH);
  gr.addColorStop(0,colL);gr.addColorStop(0.4,col);gr.addColorStop(1,colD);
  ctx.fillStyle=gr;ctx.beginPath();ctx.ellipse(0,0,safeR(bW/2),safeR(bH/2),0,0,Math.PI*2);ctx.fill();
  // membrane
  ctx.save();ctx.globalAlpha=0.12;ctx.strokeStyle='#fff';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.ellipse(0,0,safeR(bW/2-4),safeR(bH/2-3),0,0,Math.PI*2);ctx.stroke();ctx.restore();
  // highlight
  ctx.save();ctx.globalAlpha=0.25;ctx.fillStyle='#fff';
  ctx.beginPath();ctx.ellipse(-bW*0.12,-bH*0.18,safeR(bW*0.22),safeR(bH*0.18),-0.3,0,Math.PI*2);ctx.fill();ctx.restore();
  // flagella
  b.fP+=0.08;ctx.save();ctx.globalAlpha=0.6;ctx.strokeStyle=col;ctx.lineWidth=2;
  for(var i=0;i<3;i++){
    ctx.beginPath();var sy=(i-1)*bH*0.3;ctx.moveTo(-bW/2,sy);
    ctx.quadraticCurveTo(-bW/2-sz*0.6,sy+Math.sin(b.fP+i)*sz*0.4,-bW/2-sz*1.4,sy+Math.sin(b.fP+i*1.8)*sz*0.7);
    ctx.stroke();
  }
  ctx.restore();
  // shield icon on resistant
  if(b.res){ctx.save();ctx.globalAlpha=0.7;ctx.font=Math.round(sz*0.85)+'px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('\u{1F6E1}\uFE0F',bW*0.15,0);ctx.restore();}
  }catch(e){}
}

function drawM(){
  try{
  var cv=EL('mCanvas');if(!cv)return;
  var ctx=cv.getContext('2d');ctx.clearRect(0,0,cv.width,cv.height);
  G.molecules=G.molecules.filter(function(m){return m.life>0;});
  G.molecules.forEach(function(m){
    m.x+=m.vx;m.y+=m.vy;m.life-=0.008;
    ctx.save();ctx.globalAlpha=Math.min(m.life*1.2,0.8);
    var gr=ctx.createRadialGradient(m.x,m.y,0,m.x,m.y,safeR(m.sz));
    gr.addColorStop(0,'#E3F2FD');gr.addColorStop(0.5,'#42A5F5');gr.addColorStop(1,'#0D47A1');
    ctx.fillStyle=gr;ctx.shadowColor='#42A5F5';ctx.shadowBlur=10;
    ctx.beginPath();ctx.ellipse(m.x,m.y,safeR(m.sz*1.4),safeR(m.sz*0.8),m.ang||0,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=Math.min(m.life,0.5);ctx.strokeStyle='#fff';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(m.x-m.sz*0.4,m.y);ctx.lineTo(m.x+m.sz*0.4,m.y);
    ctx.moveTo(m.x,m.y-m.sz*0.4);ctx.lineTo(m.x,m.y+m.sz*0.4);ctx.stroke();
    ctx.restore();
  });
  }catch(e){}
}

/* ========== CONTROLS ========== */
document.querySelectorAll('#doseRow .optBtn').forEach(function(btn){
  btn.onclick=function(){
    if(G.treating||G.done)return;
    if(G.firstVar==='dur')return;
    var nv=btn.dataset.v;
    if(!G.firstVar&&G.prevDose&&nv!==G.prevDose){
      G.firstVar='dose';
      document.querySelectorAll('#durRow .optBtn').forEach(function(b){b.classList.add('locked');});
      EL('durLabel').classList.add('locked');
    }
    G.dose=nv;
    document.querySelectorAll('#doseRow .optBtn').forEach(function(b){b.classList.remove('selected');});
    btn.classList.add('selected');showDP();chkR();
  };
});

document.querySelectorAll('#durRow .optBtn').forEach(function(btn){
  btn.onclick=function(){
    if(G.treating||G.done)return;
    if(G.firstVar==='dose')return;
    var nv=btn.dataset.v;
    if(!G.firstVar&&G.prevDur&&nv!==G.prevDur){
      G.firstVar='dur';
      document.querySelectorAll('#doseRow .optBtn').forEach(function(b){b.classList.add('locked');});
      EL('doseLabel').classList.add('locked');
    }
    G.dur=nv;
    document.querySelectorAll('#durRow .optBtn').forEach(function(b){b.classList.remove('selected');});
    btn.classList.add('selected');showDurP();chkR();
  };
});

function chkR(){EL('treatBtn').disabled=!(G.dose&&G.dur);}

function showDP(){
  var n=G.dose==='Low'?12:G.dose==='Medium'?30:55;
  var cx=G.cvW/2,cy=G.cvH/2,MR=safeR(G.cvW/2);
  for(var i=0;i<n;i++){var a=Math.random()*Math.PI*2;G.molecules.push({x:cx+Math.cos(a)*(MR+30),y:cy+Math.sin(a)*(MR+30),vx:Math.cos(a+Math.PI)*(1.5+Math.random()),vy:Math.sin(a+Math.PI)*(1.5+Math.random()),sz:6+Math.random()*5,ang:a,life:1.5});}
}

function showDurP(){
  var tf=EL('tFill');
  if(G.dur==='Stop Early'){tf.style.width='33%';tf.style.background='linear-gradient(90deg,#FF9800,#F57C00)';}
  else if(G.dur==='Partial'){tf.style.width='66%';tf.style.background='linear-gradient(90deg,#FDD835,#F9A825)';}
  else{tf.style.width='100%';tf.style.background='linear-gradient(90deg,#66BB6A,#43A047)';}
}

/* ========== TREATMENT ========== */
EL('treatBtn').onclick=doTreat;

function doTreat(){
  if(G.treating||!G.dose||!G.dur||G.done)return;
  G.treating=true;
  var btn=EL('treatBtn');btn.disabled=true;btn.classList.add('active');btn.textContent='TREATING...';
  document.querySelectorAll('#doseRow .optBtn,#durRow .optBtn').forEach(function(b){b.classList.add('locked');});

  var doseEff=G.dose==='Low'?0.30:G.dose==='Medium'?0.60:0.90;
  var durEff=G.dur==='Stop Early'?0.33:G.dur==='Partial'?0.66:1.0;
  var totalEff=doseEff*durEff;

  var normals=G.bacteria.filter(function(b){return b.alive&&!b.res;});
  var resists=G.bacteria.filter(function(b){return b.alive&&b.res;});
  var killN=Math.round(normals.length*totalEff);
  var killR=Math.round(resists.length*totalEff*0.08);

  var mutH=false;
  if(G.mutOn&&G.round>=6&&Math.random()<0.25){
    mutH=true;
    var picks=normals.filter(function(b){return b.alive;});
    if(picks.length>0){var p=picks[Math.floor(Math.random()*picks.length)];p.res=true;p.sz=20;p.shP=1;fTxt(p.x,p.y,'MUTATED!','#CE93D8');}
  }

  var cx=G.cvW/2,cy=G.cvH/2,MR=safeR(G.cvW/2);
  var swN=G.dose==='Low'?25:G.dose==='Medium'?50:80;
  for(var i=0;i<swN;i++){var a=Math.random()*Math.PI*2;G.molecules.push({x:cx+Math.cos(a)*(MR+40),y:cy+Math.sin(a)*(MR+40),vx:Math.cos(a+Math.PI)*(2+Math.random()*2.5),vy:Math.sin(a+Math.PI)*(2+Math.random()*2.5),sz:5+Math.random()*6,ang:a,life:2.8});}

  var shN=normals.slice().sort(function(){return Math.random()-0.5;}).slice(0,killN);
  var shR=resists.slice().sort(function(){return Math.random()-0.5;}).slice(0,killR);

  shN.forEach(function(b,i){setTimeout(function(){if(!b.alive)return;b.dying=true;b.dA=0;burst(b.x,b.y,'#4CAF50',8);},300+i*50);});
  shR.forEach(function(b,i){setTimeout(function(){if(!b.alive)return;b.dying=true;b.dA=0;burst(b.x,b.y,'#ef5350',6);},400+i*80);});

  setTimeout(function(){
    G.bacteria.filter(function(b){return b.alive&&b.res&&!b.dying;}).forEach(function(b){b.shP=1;});
    fTxt(cx,cy-G.cvW*0.25,'Resistant survive!','#FFD54F');
  },600+killN*30);

  var treatTime=1800+killN*35;

  // Safety timeout: if treatment hangs, force finish after 8 seconds
  var safetyTimer=setTimeout(function(){if(G.treating)finishRound(mutH,false);},8000);

  setTimeout(function(){
    clearTimeout(safetyTimer);
    multiplyPhase();
    var bstU=false;
    if(G.bstOn&&G.round>=6&&Math.random()<0.3){
      bstU=true;var rA=G.bacteria.filter(function(b){return b.alive&&b.res;});
      var tk=rA.slice(0,Math.min(3,rA.length));tk.forEach(function(b){b.dying=true;b.dA=0;burst(b.x,b.y,'#80CBC4',6);});
      fTxt(cx,cy+G.cvW*0.2,'Immune Boost!','#80CBC4');
    }
    setTimeout(function(){finishRound(mutH,bstU);},800);
  },treatTime);
}

function burst(x,y,col,n){
  for(var i=0;i<n;i++){var a=Math.random()*Math.PI*2;var sp=2+Math.random()*4;G.particles.push({x:x,y:y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-1,sz:4+Math.random()*4,col:col,life:1});}
}

function fTxt(x,y,text,color){
  try{
    var layer=EL('floatLayer');var d=document.createElement('div');
    d.style.cssText='position:absolute;left:'+(x/Math.max(1,G.cvW)*100)+'%;top:'+(y/Math.max(1,G.cvH)*100)+'%;color:'+color+';font-size:15px;font-weight:900;pointer-events:none;white-space:nowrap;text-shadow:0 2px 8px rgba(0,0,0,0.7);animation:ftUp 1.5s forwards;transform:translateX(-50%);z-index:20;';
    d.textContent=text;layer.appendChild(d);setTimeout(function(){try{d.remove();}catch(e){}},1500);
  }catch(e){}
}

function multiplyPhase(){
  G.bacteria=G.bacteria.filter(function(b){return b.alive||b.dying;});
  var alive=G.bacteria.filter(function(b){return b.alive;});
  var deadSlots=BACT-alive.length;if(deadSlots<=0)return;
  var rA=alive.filter(function(b){return b.res;});
  var nA=alive.filter(function(b){return !b.res;});
  var rNew=Math.round(deadSlots*0.70);var nNew=deadSlots-rNew;
  var cx=G.cvW/2,cy=G.cvH/2,R=safeR(G.cvW/2-60);
  for(var i=0;i<rNew;i++){
    var par=rA.length>0?rA[Math.floor(Math.random()*rA.length)]:{x:cx,y:cy};
    var a=Math.random()*Math.PI*2;var nx=par.x+Math.cos(a)*(20+Math.random()*35);var ny=par.y+Math.sin(a)*(20+Math.random()*35);
    var dx=nx-cx,dy=ny-cy,d=Math.sqrt(dx*dx+dy*dy);if(d>R){nx=cx+dx/d*R;ny=cy+dy/d*R;}
    var nb=mkB(nx,ny,true);nb.born=true;nb.bA=0;G.bacteria.push(nb);
  }
  for(var j=0;j<nNew;j++){
    var par2=nA.length>0?nA[Math.floor(Math.random()*nA.length)]:{x:cx,y:cy};
    var a2=Math.random()*Math.PI*2;var nx2=par2.x+Math.cos(a2)*(20+Math.random()*35);var ny2=par2.y+Math.sin(a2)*(20+Math.random()*35);
    var dx2=nx2-cx,dy2=ny2-cy,d2=Math.sqrt(dx2*dx2+dy2*dy2);if(d2>R){nx2=cx+dx2/d2*R;ny2=cy+dy2/d2*R;}
    var nb2=mkB(nx2,ny2,false);nb2.born=true;nb2.bA=0;G.bacteria.push(nb2);
  }
}

function finishRound(mutH,bstU){
  if(!G.treating)return; // prevent double-fire from safety timeout
  G.bacteria=G.bacteria.filter(function(b){return b.alive||b.dying;});
  var alive=G.bacteria.filter(function(b){return b.alive;});
  var rA=alive.filter(function(b){return b.res;});
  var newPct=alive.length>0?Math.round(rA.length/alive.length*100):0;
  G.resistPct=newPct;

  var good=newPct<=50;
  if(good){G.score+=100+G.streak*25+(G.streak>=3?50:0);G.streak++;if(G.streak>=3)EL('comboDisp').textContent='x'+G.streak+' COMBO!';}
  else{G.streak=0;EL('comboDisp').textContent='';}

  var tag='';if(mutH)tag='mutation';if(bstU)tag+=(tag?' ':'')+'boost';
  G.results.push({round:G.round,dose:G.dose,dur:G.dur,pct:newPct,tag:tag});
  addRow(G.round,G.dose,G.dur,newPct,tag);

  if(newPct>50){EL('sbAlert').style.display='block';setTimeout(function(){EL('sbAlert').style.display='none';},3500);}
  refreshHUD();

  if(G.results.length===5)EL('ecMsg').style.display='block';
  if(G.round>=8){
    G.done=true;EL('ecMsg').style.display='none';
    EL('ecBdg').textContent=newPct<50?'üèÜ EXTRA CREDIT COMPLETE! Superbug Stopper! üèÜ':'üèÜ EXTRA CREDIT COMPLETE! üèÜ';
    EL('ecBdg').style.display='block';showEnd(newPct);
  }

  if(!G.done){G.round++;EL('roundDisplay').textContent=G.round;}
  G.prevDose=G.dose;G.prevDur=G.dur;G.firstVar=null;G.treating=false;
  var btn=EL('treatBtn');btn.classList.remove('active');btn.textContent='TREAT';
  unlockAll();
  if(G.prevDose){document.querySelectorAll('#doseRow .optBtn').forEach(function(b){if(b.dataset.v===G.prevDose)b.classList.add('selected');});}
  if(G.prevDur){document.querySelectorAll('#durRow .optBtn').forEach(function(b){if(b.dataset.v===G.prevDur)b.classList.add('selected');});}
  if(G.done){btn.disabled=true;}else{chkR();}
}

function showEnd(pct){
  var ov=EL('endOverlay');ov.style.display='flex';
  ov.innerHTML='<div style="font-size:64px;margin-bottom:12px;">'+(pct<50?'üèÜ':'ü¶†')+'</div>'
    +'<div style="font-size:30px;font-weight:900;margin-bottom:6px;">'+(pct<50?'Superbug Stopper!':'Simulation Complete')+'</div>'
    +'<div style="font-size:18px;color:#ccc;">Final Resistance: '+pct+'%</div>'
    +'<div style="font-size:14px;color:#90A4AE;max-width:420px;margin-top:12px;line-height:1.6;">Resistant bacteria can spread to other patients. Proper antibiotic use matters.</div>'
    +'<div style="font-size:13px;color:#78909C;margin-top:16px;">Copy your data table for your worksheet!</div>';
}

/* ========== HUD ========== */
function refreshHUD(){
  try{
  var rp=EL('rPct');rp.textContent=G.resistPct+'%';
  rp.className=G.resistPct<=25?'g':G.resistPct<=50?'y':'r';
  var health=Math.max(0,100-G.resistPct);
  EL('healthV').textContent=health;
  EL('healthV').style.color=health>60?'#4CAF50':health>30?'#FFB74D':'#ef5350';
  var hf=EL('hpFill');hf.style.width=health+'%';
  hf.style.background=health>60?'linear-gradient(90deg,#4CAF50,#81C784)':health>30?'linear-gradient(90deg,#FF9800,#FFB74D)':'linear-gradient(90deg,#ef5350,#ff8a80)';
  EL('scoreV').textContent=G.score;EL('streakV').textContent=G.streak;
  var bp=EL('badgePill');
  if(G.streak>=6)bp.textContent='Legend';else if(G.streak>=4)bp.textContent='Expert';else if(G.streak>=2)bp.textContent='Doctor';else bp.textContent='Rookie';
  EL('progBar').style.width=Math.min(100,G.results.length/5*100)+'%';
  }catch(e){}
}

/* ========== DATA TABLE ========== */
function addRow(rnd,dose,dur,pct,tag){
  var tb=EL('dBody');var tr=document.createElement('tr');tr.className='flash';
  var tH='';if(tag.indexOf('mutation')>=0)tH+='<span class="evTag mut">MUTATION</span>';if(tag.indexOf('boost')>=0)tH+='<span class="evTag bst">BOOST</span>';
  tr.innerHTML='<td>'+rnd+'</td><td>'+dose+'</td><td>'+dur+'</td><td>'+pct+'%'+tH+'</td>';
  tb.appendChild(tr);try{var wrap=tr.closest('.tblWrap');if(wrap)wrap.scrollTop=wrap.scrollHeight;}catch(e){}
}

/* ========== COPY ========== */
EL('cpyBtn').onclick=function(){
  var lines=['Round\tAntibiotic Dose\tTreatment Duration\tResistant Bacteria %'];
  G.results.forEach(function(r){lines.push(r.round+'\t'+r.dose+'\t'+r.dur+'\t'+r.pct+'%');});
  var text=lines.join('\n');
  try{navigator.clipboard.writeText(text).then(cpyOK).catch(function(){cpyFB(text);});}catch(e){cpyFB(text);}
};
function cpyFB(text){try{var ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;opacity:0;';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);cpyOK();}catch(e){}}
function cpyOK(){var b=EL('cpyBtn');b.textContent='‚úÖ Copied!';setTimeout(function(){b.textContent='üìã Copy Table';},2000);}

/* ========== TOGGLES ========== */
EL('mutTog').onclick=function(){G.mutOn=!G.mutOn;this.textContent='Mutation '+(G.mutOn?'ON':'OFF');this.classList.toggle('on',G.mutOn);};
EL('bstTog').onclick=function(){G.bstOn=!G.bstOn;this.textContent='Boost '+(G.bstOn?'ON':'OFF');this.classList.toggle('on',G.bstOn);};

}catch(e){console.error('Sim init error:',e);}
})();
</script>
</body>
</html>
