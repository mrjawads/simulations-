<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation How Arteries Get Blocked</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@400;600;700&display=swap');
body{font-family:'Rajdhani',sans-serif;background:#080812;color:#fff;min-height:100vh;overflow-x:hidden}
.game-container{display:grid;grid-template-columns:250px 1fr 280px;gap:10px;padding:10px;max-width:1440px;margin:0 auto;min-height:100vh}
/* HEADER */
.header{grid-column:1/-1;text-align:center;padding:10px 16px;background:linear-gradient(90deg,#b71c1c,#d32f2f,#e53935,#d32f2f,#b71c1c);border-radius:14px;box-shadow:0 0 30px rgba(229,57,53,.35),inset 0 1px 0 rgba(255,255,255,.15);border:1px solid rgba(255,100,100,.2);position:relative;overflow:hidden}
.header::before{content:'';position:absolute;top:0;left:-50%;width:200%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation:headerShine 4s infinite}
@keyframes headerShine{0%{transform:translateX(-50%)}100%{transform:translateX(50%)}}
.header h1{font-family:'Orbitron',sans-serif;font-size:1.15em;font-weight:700;text-shadow:0 2px 8px rgba(0,0,0,.5);letter-spacing:1px}
/* LEFT PANEL */
.left-panel{display:flex;flex-direction:column;gap:8px}
.panel-box{background:linear-gradient(160deg,rgba(255,255,255,.07),rgba(255,255,255,.02));border-radius:14px;padding:12px;backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.08);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.panel-title{font-size:.8em;font-weight:700;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;color:#ff9800;text-shadow:0 0 8px rgba(255,152,0,.3)}
.round-badge{text-align:center;font-family:'Orbitron',sans-serif;font-size:1.3em;font-weight:700;background:linear-gradient(135deg,#ffb300,#ff8f00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none}
.mission-line{font-size:.72em;color:#888;text-align:center;margin-top:2px;letter-spacing:1px}
/* Fuel buttons */
.fuel-btn{width:100%;padding:10px 12px;margin:3px 0;border:2px solid rgba(255,255,255,.1);border-radius:12px;background:linear-gradient(135deg,rgba(255,255,255,.04),rgba(255,255,255,.01));color:#ccc;font-family:'Rajdhani',sans-serif;font-size:.95em;font-weight:600;cursor:pointer;transition:all .3s cubic-bezier(.25,.8,.25,1);display:flex;align-items:center;gap:10px;position:relative;overflow:hidden}
.fuel-btn::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,transparent,rgba(255,255,255,.03));opacity:0;transition:opacity .3s}
.fuel-btn:hover:not(.locked){border-color:rgba(255,193,7,.4);color:#fff;transform:translateX(4px)}
.fuel-btn:hover:not(.locked)::before{opacity:1}
.fuel-btn.selected{border-color:#ffc107;background:linear-gradient(135deg,rgba(255,193,7,.15),rgba(255,152,0,.08));color:#fff;box-shadow:0 0 20px rgba(255,193,7,.2),inset 0 0 15px rgba(255,193,7,.05)}
.fuel-btn.locked{opacity:.3;cursor:not-allowed;filter:grayscale(.5)}
.fuel-icon{font-size:1.4em;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
.fuel-label{font-weight:700}
/* Activity buttons */
.activity-btn{width:100%;padding:9px 12px;margin:3px 0;border:2px solid rgba(255,255,255,.1);border-radius:12px;background:linear-gradient(135deg,rgba(255,255,255,.04),rgba(255,255,255,.01));color:#ccc;font-family:'Rajdhani',sans-serif;font-size:.9em;font-weight:600;cursor:pointer;transition:all .3s cubic-bezier(.25,.8,.25,1);display:flex;align-items:center;gap:8px}
.activity-btn:hover:not(.locked){border-color:rgba(46,204,113,.4);color:#fff;transform:translateX(4px)}
.activity-btn.selected{border-color:#2ecc71;background:linear-gradient(135deg,rgba(46,204,113,.15),rgba(39,174,96,.08));color:#fff;box-shadow:0 0 20px rgba(46,204,113,.2)}
.activity-btn.locked{opacity:.3;cursor:not-allowed;filter:grayscale(.5)}
.lock-overlay{font-size:.7em;color:#e74c3c;margin-left:auto}
.lock-icon{font-size:1.2em}
/* ACTION */
.action-area{display:flex;flex-direction:column;gap:5px}
.go-btn{width:100%;padding:13px;border:none;border-radius:12px;font-family:'Orbitron',sans-serif;font-size:.95em;font-weight:700;cursor:pointer;transition:all .3s;letter-spacing:1px}
.go-btn.ready{background:linear-gradient(135deg,#2e7d32,#43a047,#2e7d32);color:#fff;box-shadow:0 0 25px rgba(46,125,50,.4);border:1px solid rgba(76,175,80,.3)}
.go-btn.ready:hover{transform:translateY(-2px);box-shadow:0 4px 30px rgba(46,125,50,.6)}
.go-btn.waiting{background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(255,255,255,.02));color:#555;cursor:not-allowed;border:1px solid rgba(255,255,255,.05)}
.next-btn{width:100%;padding:11px;border:none;border-radius:12px;font-family:'Orbitron',sans-serif;font-size:.85em;font-weight:700;background:linear-gradient(135deg,#1565c0,#1e88e5,#1565c0);color:#fff;cursor:pointer;box-shadow:0 0 25px rgba(21,101,192,.4);display:none;letter-spacing:1px;border:1px solid rgba(33,150,243,.3)}
.next-btn:hover{transform:translateY(-2px);box-shadow:0 4px 30px rgba(21,101,192,.6)}
.reset-row{display:flex;gap:6px;margin-top:2px}
.reset-btn,.newrun-btn{flex:1;padding:8px;border:none;border-radius:10px;font-family:'Rajdhani',sans-serif;font-size:.8em;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all .2s}
.reset-btn{background:linear-gradient(135deg,#b71c1c,#c62828);color:#fff;border:1px solid rgba(183,28,28,.3)}
.newrun-btn{background:linear-gradient(135deg,#0d47a1,#1565c0);color:#fff;border:1px solid rgba(13,71,161,.3)}
.reset-btn:hover,.newrun-btn:hover{transform:translateY(-1px)}
/* CENTER ARENA */
.center-panel{display:flex;flex-direction:column;gap:8px}
.arena-container{flex:1;background:radial-gradient(ellipse at center,#0d0d1a,#060610);border-radius:18px;border:2px solid rgba(255,255,255,.06);position:relative;overflow:hidden;min-height:440px;box-shadow:inset 0 0 60px rgba(0,0,0,.5),0 0 40px rgba(0,0,0,.3)}
.arena-canvas{width:100%;height:100%;display:block}
/* Vignette */
.arena-container::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,.4) 100%);pointer-events:none;border-radius:18px}
/* Warning overlay */
.warning-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0;transition:opacity .4s;z-index:1;border-radius:18px}
.warning-overlay.yellow{background:radial-gradient(circle,transparent 35%,rgba(255,193,7,.12));animation:pulseWarn 1.8s ease-in-out infinite;opacity:1}
.warning-overlay.red{background:radial-gradient(circle,transparent 25%,rgba(211,47,47,.2));animation:pulseRed .5s ease-in-out infinite;opacity:1}
@keyframes pulseWarn{0%,100%{opacity:.4}50%{opacity:1}}
@keyframes pulseRed{0%,100%{opacity:.4}50%{opacity:1}}
/* Event banner */
.event-banner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,rgba(0,0,0,.95),rgba(20,20,40,.95));border:2px solid;border-radius:18px;padding:22px 36px;text-align:center;font-size:1.2em;font-weight:700;z-index:12;display:none;animation:bannerPop .4s cubic-bezier(.175,.885,.32,1.275);backdrop-filter:blur(10px);box-shadow:0 0 40px rgba(0,0,0,.5)}
@keyframes bannerPop{from{transform:translate(-50%,-50%) scale(.6);opacity:0}to{transform:translate(-50%,-50%) scale(1);opacity:1}}
/* Feedback flash */
.feedback-flash{position:absolute;top:12px;right:12px;padding:10px 18px;border-radius:10px;font-weight:700;font-size:.85em;z-index:8;display:none;animation:flashIn .3s cubic-bezier(.25,.8,.25,1);backdrop-filter:blur(8px);letter-spacing:.5px}
@keyframes flashIn{from{transform:translateY(-15px) scale(.9);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
/* Completion */
.completion-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at center,rgba(0,0,0,.92),rgba(0,0,0,.97));display:none;flex-direction:column;align-items:center;justify-content:center;z-index:20;border-radius:18px}
.completion-screen h2{font-family:'Orbitron',sans-serif;font-size:1.8em;margin-bottom:8px}
.completion-screen p{font-size:1.05em;color:#999;margin:3px 0}
.completion-emoji{font-size:3.5em;margin-bottom:8px;filter:drop-shadow(0 0 20px rgba(255,100,100,.5))}
/* RIGHT PANEL */
.right-panel{display:flex;flex-direction:column;gap:8px}
.hud-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.hud-stat{background:linear-gradient(160deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-radius:12px;padding:10px 8px;text-align:center;border:1px solid rgba(255,255,255,.06)}
.hud-label{font-size:.6em;text-transform:uppercase;letter-spacing:2px;color:#777;margin-bottom:3px}
.hud-value{font-family:'Orbitron',sans-serif;font-size:1.2em;font-weight:700;transition:color .5s}
.hud-value.green{color:#4caf50}
.hud-value.yellow{color:#ffc107}
.hud-value.red{color:#f44336}
/* Blockage meter */
.meter-container{background:linear-gradient(160deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,.06)}
.meter-label{font-size:.7em;color:#888;margin-bottom:5px;text-transform:uppercase;letter-spacing:2px}
.meter-bar-outer{height:22px;background:rgba(255,255,255,.06);border-radius:11px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.05)}
.meter-bar-inner{height:100%;border-radius:11px;transition:width 1.2s cubic-bezier(.25,.8,.25,1),background .8s;position:relative;overflow:hidden}
.meter-bar-inner::after{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(180deg,rgba(255,255,255,.2),transparent);border-radius:11px 11px 0 0}
.meter-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',sans-serif;font-weight:700;font-size:.75em;text-shadow:0 1px 4px rgba(0,0,0,.7)}
/* Flow indicator */
.flow-indicator{text-align:center;padding:8px;border-radius:12px;font-family:'Orbitron',sans-serif;font-weight:700;font-size:1em;transition:all .6s;letter-spacing:1px;border:1px solid rgba(255,255,255,.06)}
/* Progress */
.progress-outer{height:10px;background:rgba(255,255,255,.06);border-radius:5px;overflow:hidden;border:1px solid rgba(255,255,255,.03)}
.progress-inner{height:100%;background:linear-gradient(90deg,#2e7d32,#4caf50);border-radius:5px;transition:width .6s}
.progress-label{font-size:.65em;color:#888;margin-top:3px;text-align:center;letter-spacing:1px}
/* Badge */
.badge{display:none;text-align:center;padding:10px;border-radius:12px;font-weight:700;font-size:.85em;animation:badgePop .5s cubic-bezier(.175,.885,.32,1.275);letter-spacing:.5px}
.badge.powerup{background:linear-gradient(135deg,rgba(255,152,0,.2),rgba(245,124,0,.15));border:1px solid rgba(255,152,0,.3);color:#ffb300;display:block}
.badge.complete{background:linear-gradient(135deg,rgba(76,175,80,.2),rgba(56,142,60,.15));border:1px solid rgba(76,175,80,.3);color:#66bb6a;display:block}
.badge.extra{background:linear-gradient(135deg,rgba(156,39,176,.2),rgba(123,31,162,.15));border:1px solid rgba(156,39,176,.3);color:#ce93d8;display:block}
@keyframes badgePop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
/* Data table */
.data-section{background:linear-gradient(160deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-radius:12px;padding:8px;border:1px solid rgba(255,255,255,.06);max-height:230px;overflow-y:auto}
.data-section::-webkit-scrollbar{width:4px}
.data-section::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px}
.copy-btn{display:block;margin:0 auto 6px;padding:5px 14px;background:linear-gradient(135deg,#1565c0,#1e88e5);color:#fff;border:1px solid rgba(33,150,243,.3);border-radius:8px;font-family:'Rajdhani',sans-serif;font-size:.78em;font-weight:700;cursor:pointer;transition:all .3s;letter-spacing:1px}
.copy-btn:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(33,150,243,.3)}
.data-table{width:100%;border-collapse:collapse;font-size:.72em}
.data-table th{background:rgba(183,28,28,.25);padding:5px 3px;text-align:center;font-size:.8em;text-transform:uppercase;letter-spacing:1px;border-bottom:2px solid rgba(183,28,28,.4);color:#ef9a9a}
.data-table td{padding:4px 3px;text-align:center;border-bottom:1px solid rgba(255,255,255,.04);color:#ccc}
.data-table tr:nth-child(even){background:rgba(255,255,255,.02)}
.data-table tr.new-row{animation:rowFlash .8s}
@keyframes rowFlash{0%{background:rgba(255,193,7,.2)}100%{background:transparent}}
/* Status */
.status-msg{text-align:center;font-size:.8em;font-weight:700;padding:8px;border-radius:10px;margin-top:2px;letter-spacing:1px;border:1px solid rgba(255,255,255,.05)}
/* Responsive */
@media(max-width:1100px){.game-container{grid-template-columns:1fr;max-width:600px}.arena-container{min-height:380px}}
</style>
</head>
<body>
<div class="game-container">
  <div class="header"><h1>Mr. Jawad Simulation ‚Äî How Arteries Get Blocked</h1></div>
  <!-- LEFT -->
  <div class="left-panel">
    <div class="panel-box">
      <div class="round-badge" id="roundBadge">Round 1 / 8</div>
      <div class="mission-line">Find the tipping point</div>
    </div>
    <div class="panel-box">
      <div class="panel-title">üçî Fuel Type</div>
      <button class="fuel-btn" data-fuel="High-Fat" onclick="selectFuel(this)"><span class="fuel-icon">üçü</span><span class="fuel-label">High-Fat</span></button>
      <button class="fuel-btn" data-fuel="Mixed" onclick="selectFuel(this)"><span class="fuel-icon">ü•ó</span><span class="fuel-label">Mixed</span></button>
      <button class="fuel-btn" data-fuel="Heart-Healthy" onclick="selectFuel(this)"><span class="fuel-icon">ü•¶</span><span class="fuel-label">Heart-Healthy</span></button>
    </div>
    <div class="panel-box" id="activityPanel">
      <div class="panel-title">üèÉ Activity Level</div>
      <button class="activity-btn locked" data-activity="Sedentary" onclick="selectActivity(this)"><span class="lock-icon">üõãÔ∏è</span><span>Sedentary</span><span class="lock-overlay" id="lockSed">üîí</span></button>
      <button class="activity-btn locked" data-activity="Moderate" onclick="selectActivity(this)"><span class="lock-icon">üö∂</span><span>Moderate</span><span class="lock-overlay" id="lockMod">üîí</span></button>
      <button class="activity-btn locked" data-activity="Active" onclick="selectActivity(this)"><span class="lock-icon">üèÉ</span><span>Active</span><span class="lock-overlay" id="lockAct">üîí</span></button>
      <div id="activityLockMsg" style="font-size:.68em;color:#ef5350;text-align:center;margin-top:5px;letter-spacing:1px">üîí Unlocks Round 5</div>
    </div>
    <div class="action-area">
      <button class="go-btn waiting" id="goBtn" onclick="runRound()">Pick Fuel</button>
      <button class="next-btn" id="nextBtn" onclick="nextRound()">Next Round ‚ñ∂</button>
      <div class="reset-row">
        <button class="reset-btn" onclick="resetGame()">Reset</button>
        <button class="newrun-btn" onclick="newRun()">New Run</button>
      </div>
    </div>
  </div>
  <!-- CENTER -->
  <div class="center-panel">
    <div class="arena-container" id="arenaContainer">
      <canvas class="arena-canvas" id="arenaCanvas"></canvas>
      <div class="warning-overlay" id="warnOverlay"></div>
      <div class="event-banner" id="eventBanner"></div>
      <div class="feedback-flash" id="feedbackFlash"></div>
      <div class="completion-screen" id="completionScreen">
        <div class="completion-emoji">ü´Ä</div>
        <h2 id="completionTitle">Mission Complete!</h2>
        <p id="completionMsg">You discovered the tipping point.</p>
      </div>
    </div>
  </div>
  <!-- RIGHT -->
  <div class="right-panel">
    <div class="hud-grid">
      <div class="hud-stat"><div class="hud-label">Score</div><div class="hud-value" id="hudScore">0</div></div>
      <div class="hud-stat"><div class="hud-label">Streak</div><div class="hud-value" id="hudStreak">0</div></div>
      <div class="hud-stat"><div class="hud-label">Rounds</div><div class="hud-value" id="hudRounds">0/8</div></div>
      <div class="hud-stat"><div class="hud-label">Warning</div><div class="hud-value green" id="hudWarning">OK</div></div>
    </div>
    <div class="meter-container">
      <div class="meter-label">Blockage %</div>
      <div class="meter-bar-outer"><div class="meter-bar-inner" id="blockageMeter" style="width:10%;background:linear-gradient(90deg,#2e7d32,#4caf50)"></div><div class="meter-text" id="blockageText">10%</div></div>
    </div>
    <div class="flow-indicator" id="flowIndicator" style="background:rgba(76,175,80,.12);color:#4caf50;border-color:rgba(76,175,80,.2)">Strong</div>
    <div class="panel-box" style="padding:8px">
      <div class="meter-label">Progress</div>
      <div class="progress-outer"><div class="progress-inner" id="progressBar" style="width:0%"></div></div>
      <div class="progress-label" id="progressLabel">Complete 5 rounds</div>
    </div>
    <div class="badge" id="badgeArea"></div>
    <div class="status-msg" id="statusMsg" style="background:rgba(33,150,243,.1);color:#42a5f5;border-color:rgba(33,150,243,.15)">Pick your fuel to begin!</div>
    <div class="data-section">
      <button class="copy-btn" onclick="copyTable()">üìã Copy Table</button>
      <table class="data-table"><thead><tr><th>Fuel</th><th>Activity</th><th>Block %</th><th>Flow</th></tr></thead><tbody id="dataBody"></tbody></table>
    </div>
  </div>
</div>

<script>
// ===== STATE =====
let S={round:1,blockage:10,displayBlockage:10,score:0,streak:0,healthyStreak:0,
selectedFuel:null,selectedActivity:'Moderate',previousFuel:null,previousActivity:'Moderate',
activityUnlocked:false,changedVar:null,powerUpAvailable:false,powerUpUsed:false,
stressApplied:false,animating:false,gameOver:false,data:[],
bloodCells:[],fatGlobs:[],dissolveParts:[],floaters:[],shockwave:null,
pulseRings:[]};

// ===== CANVAS =====
const C=document.getElementById('arenaCanvas'),X=C.getContext('2d');
let W,H,CX,CY,AR;
function resize(){const c=document.getElementById('arenaContainer');C.width=c.clientWidth;C.height=c.clientHeight;W=C.width;H=C.height;CX=W/2;CY=H/2;AR=Math.min(W,H)*.37;initBloodCells();initFloaters()}
window.addEventListener('resize',resize);

// ===== BLOOD CELLS (biconcave discs) =====
function initBloodCells(){S.bloodCells=[];for(let i=0;i<30;i++)S.bloodCells.push(mkCell())}
function mkCell(){const openR=AR*.85*(1-S.blockage/100)*.82;const a=Math.random()*Math.PI*2;const d=Math.random()*Math.max(openR,4);return{x:CX+Math.cos(a)*d,y:CY+Math.sin(a)*d,sz:3+Math.random()*5,spd:.2+Math.random()*1.4,ang:Math.random()*Math.PI*2,drift:(Math.random()-.5)*.015,rot:Math.random()*Math.PI*2,rotSpd:(Math.random()-.5)*.03,wobble:Math.random()*Math.PI*2}}

// ===== AMBIENT FLOATERS (tiny light specks in blood) =====
function initFloaters(){S.floaters=[];for(let i=0;i<50;i++){const openR=AR*.85*(1-S.blockage/100)*.8;const a=Math.random()*Math.PI*2;const d=Math.random()*Math.max(openR,3);S.floaters.push({x:CX+Math.cos(a)*d,y:CY+Math.sin(a)*d,sz:.5+Math.random()*1.5,spd:.1+Math.random()*.6,ang:Math.random()*Math.PI*2,drift:(Math.random()-.5)*.01,alpha:.15+Math.random()*.25})}}

// ===== PARTICLES =====
function spawnFat(n){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2;const startR=AR*.15+Math.random()*AR*.2;S.fatGlobs.push({x:CX+Math.cos(a)*startR,y:CY+Math.sin(a)*startR,a,sz:2+Math.random()*4,life:1,spd:.8+Math.random()*1.5,glow:Math.random()>.5,trail:[]})}}
function spawnDissolve(n){for(let i=0;i<n;i++){const plaqueR=AR*.85*(S.blockage/100);const innerR=AR*.85-plaqueR;const a=Math.random()*Math.PI*2;const r=innerR+plaqueR*.4+Math.random()*plaqueR*.4;S.dissolveParts.push({x:CX+Math.cos(a)*r,y:CY+Math.sin(a)*r,vx:(Math.random()-.5)*3,vy:(Math.random()-.5)*3,sz:1.5+Math.random()*3,life:1,hue:160+Math.random()*40})}}
function spawnShockwave(color){S.shockwave={r:0,maxR:AR*1.3,life:1,color}}
function spawnPulseRing(color){S.pulseRings.push({r:AR*.3,maxR:AR*1.1,life:1,color})}

// ===== HEARTBEAT =====
let hPhase=0,hRate=1;

// ===== RENDER =====
let lastT=0;
function render(t){
const dt=Math.min((t-lastT)/1000,.05);lastT=t;
X.clearRect(0,0,W,H);

// Deep background
const bg=X.createRadialGradient(CX,CY,0,CX,CY,W*.8);
bg.addColorStop(0,'#100818');bg.addColorStop(.5,'#0a0612');bg.addColorStop(1,'#050308');
X.fillStyle=bg;X.fillRect(0,0,W,H);

// Subtle grid pattern
X.globalAlpha=.03;
for(let i=0;i<W;i+=30){X.beginPath();X.moveTo(i,0);X.lineTo(i,H);X.strokeStyle='#fff';X.lineWidth=.5;X.stroke()}
for(let i=0;i<H;i+=30){X.beginPath();X.moveTo(0,i);X.lineTo(W,i);X.stroke()}
X.globalAlpha=1;

// Heartbeat
hRate=S.blockage>80?2.2:S.blockage>50?1.4:1;
hPhase+=dt*hRate*Math.PI*2;
const hb=.5+.5*Math.sin(hPhase);
const hScale=1+hb*(S.blockage>80?.018:.007);

X.save();X.translate(CX,CY);X.scale(hScale,hScale);X.translate(-CX,-CY);

drawGlow(hb);
drawArtery(hb);
drawPlaqueDeposits();
drawFloaters(dt);
drawBloodCells(dt);
drawFatGlobs(dt);
drawDissolve(dt);
drawLabels(hb);

X.restore();

drawShockwave(dt);
drawPulseRings(dt);

// Screen shake
if(S.blockage>=90&&!S.gameOver){const sx=(Math.random()-.5)*5,sy=(Math.random()-.5)*5;C.style.transform=`translate(${sx}px,${sy}px)`}
else C.style.transform='';

requestAnimationFrame(render)}

function drawGlow(hb){
// Outer glow ring
const glowA=(.1+hb*.15)*(S.blockage>70?2:1);
const gc=S.blockage>80?[211,47,47]:S.blockage>50?[255,193,7]:[76,175,80];
for(let i=3;i>=0;i--){
X.beginPath();X.arc(CX,CY,AR+20+i*12,0,Math.PI*2);
X.strokeStyle=`rgba(${gc[0]},${gc[1]},${gc[2]},${glowA*(1-i*.2)*.12})`;
X.lineWidth=8-i*1.5;X.stroke()}}

function drawArtery(hb){
const outerR=AR;
const wallT=AR*.16;
const muscR=outerR-wallT*.35;
const innerR=outerR-wallT;
const plaqueT=innerR*(S.displayBlockage/100);
const openR=Math.max(innerR-plaqueT,1);

// Health color
let wH,wS,wL;
if(S.displayBlockage<25){wH=345;wS=55;wL=58}
else if(S.displayBlockage<50){wH=10;wS=60;wL=52}
else if(S.displayBlockage<75){wH=25;wS=65;wL=48}
else{wH=0;wS=72;wL=38}

// Outer wall with tissue texture
X.save();
X.beginPath();X.arc(CX,CY,outerR,0,Math.PI*2);X.clip();
const owg=X.createRadialGradient(CX-outerR*.2,CY-outerR*.2,0,CX,CY,outerR);
owg.addColorStop(0,`hsl(${wH},${wS}%,${wL+8}%)`);
owg.addColorStop(.5,`hsl(${wH},${wS}%,${wL}%)`);
owg.addColorStop(1,`hsl(${wH},${wS-5}%,${wL-12}%)`);
X.fillStyle=owg;X.fillRect(CX-outerR,CY-outerR,outerR*2,outerR*2);

// Tissue texture (tiny bumps)
for(let i=0;i<120;i++){
const a=(i/120)*Math.PI*2+Math.sin(i*.7)*.1;
const r=innerR+(outerR-innerR)*(.2+Math.random()*.7);
const px=CX+Math.cos(a)*r,py=CY+Math.sin(a)*r;
X.beginPath();X.arc(px,py,.5+Math.random()*1.5,0,Math.PI*2);
X.fillStyle=`hsla(${wH},${wS-10}%,${wL+10}%,${.08+Math.random()*.12})`;X.fill()}
X.restore();

// Muscle layer ring
X.beginPath();X.arc(CX,CY,muscR,0,Math.PI*2);
X.arc(CX,CY,innerR,0,Math.PI*2,true);
const mg=X.createRadialGradient(CX,CY,innerR,CX,CY,muscR);
mg.addColorStop(0,`hsl(${wH},${wS-5}%,${wL+6}%)`);
mg.addColorStop(1,`hsl(${wH},${wS}%,${wL+2}%)`);
X.fillStyle=mg;X.fill();

// Inner lining (smooth endothelium)
X.beginPath();X.arc(CX,CY,innerR,0,Math.PI*2);
X.arc(CX,CY,innerR-3,0,Math.PI*2,true);
X.fillStyle=`hsla(${wH},30%,${wL+18}%,.6)`;X.fill();

// === PLAQUE ===
if(S.displayBlockage>1){
X.save();
X.beginPath();X.arc(CX,CY,innerR,0,Math.PI*2);
X.arc(CX,CY,Math.max(openR,1),0,Math.PI*2,true);X.clip();

// Base plaque gradient
const pg=X.createRadialGradient(CX,CY,openR,CX,CY,innerR);
pg.addColorStop(0,'rgba(255,210,60,.92)');
pg.addColorStop(.3,'rgba(240,180,40,.88)');
pg.addColorStop(.6,'rgba(210,150,25,.82)');
pg.addColorStop(.85,'rgba(180,120,15,.75)');
pg.addColorStop(1,'rgba(150,100,10,.65)');
X.fillStyle=pg;X.fillRect(CX-innerR,CY-innerR,innerR*2,innerR*2);

// Lumpy deposits (irregular plaque buildup)
for(let i=0;i<24;i++){
const a=(i/24)*Math.PI*2;
const bumpSize=plaqueT*(.15+Math.sin(i*3.7)*.1+Math.sin(i*7.3)*.05);
const bR=openR+bumpSize;
const bx=CX+Math.cos(a)*(openR+plaqueT*.5)+Math.sin(i*2)*3;
const by=CY+Math.sin(a)*(openR+plaqueT*.5)+Math.cos(i*3)*3;
X.beginPath();X.arc(bx,by,3+bumpSize*.15,0,Math.PI*2);
X.fillStyle=`rgba(200,160,30,${.2+Math.random()*.15})`;X.fill()}

// Fat streak patterns
for(let i=0;i<16;i++){
const a1=(i/16)*Math.PI*2;const a2=a1+.15;
const r1=openR+plaqueT*.2,r2=openR+plaqueT*.8;
X.beginPath();
X.moveTo(CX+Math.cos(a1)*r1,CY+Math.sin(a1)*r1);
X.quadraticCurveTo(CX+Math.cos((a1+a2)/2)*(r1+r2)/2+Math.sin(i)*5,CY+Math.sin((a1+a2)/2)*(r1+r2)/2+Math.cos(i)*5,CX+Math.cos(a2)*r2,CY+Math.sin(a2)*r2);
X.strokeStyle=`rgba(255,240,100,${.06+Math.random()*.06})`;X.lineWidth=1+Math.random()*2;X.stroke()}

// Calcification spots (white hard deposits at high blockage)
if(S.displayBlockage>50){
for(let i=0;i<Math.floor(S.displayBlockage/10);i++){
const a=Math.random()*Math.PI*2;
const r=openR+plaqueT*(.3+Math.random()*.5);
const sx=CX+Math.cos(a)*r,sy=CY+Math.sin(a)*r;
X.beginPath();X.arc(sx,sy,1+Math.random()*2.5,0,Math.PI*2);
X.fillStyle=`rgba(255,255,240,${.15+Math.random()*.15})`;X.fill()}}

X.restore()}

// Blood channel
X.beginPath();X.arc(CX,CY,Math.max(openR,1),0,Math.PI*2);
const bg2=X.createRadialGradient(CX,CY,0,CX,CY,Math.max(openR,1));
bg2.addColorStop(0,'#3a0015');bg2.addColorStop(.4,'#2a000e');bg2.addColorStop(.8,'#1a0008');bg2.addColorStop(1,'#100005');
X.fillStyle=bg2;X.fill();

// Inner highlight ring
X.beginPath();X.arc(CX,CY,Math.max(openR,1),0,Math.PI*2);
X.strokeStyle=`rgba(255,100,100,${.08+hb*.06})`;X.lineWidth=2;X.stroke()}

function drawPlaqueDeposits(){
// Animated fat accumulation particles stuck in plaque
if(S.displayBlockage>15){
const innerR=AR*.85;const plaqueT=innerR*(S.displayBlockage/100);const openR=innerR-plaqueT;
const time=performance.now()*.0005;
for(let i=0;i<Math.min(S.displayBlockage*.3,20);i++){
const a=(i/20)*Math.PI*2+Math.sin(time+i)*0.05;
const r=openR+plaqueT*(.2+Math.sin(time*1.5+i*2.1)*.15);
const px=CX+Math.cos(a)*r,py=CY+Math.sin(a)*r;
const pulse=.3+.2*Math.sin(time*3+i);
X.beginPath();X.arc(px,py,1+Math.sin(time+i)*.5,0,Math.PI*2);
X.fillStyle=`rgba(255,200,50,${pulse})`;X.fill();
// glow
X.beginPath();X.arc(px,py,3+Math.sin(time+i),0,Math.PI*2);
X.fillStyle=`rgba(255,180,30,${pulse*.15})`;X.fill()}}}

function drawFloaters(dt){
const openR=AR*.85*(1-S.displayBlockage/100)*.8;
const sm=S.displayBlockage>85?.08:S.displayBlockage>60?.3:S.displayBlockage>40?.6:1;
S.floaters.forEach(f=>{
f.ang+=f.drift;
f.x+=Math.cos(f.ang)*f.spd*sm*dt*60;
f.y+=Math.sin(f.ang)*f.spd*sm*dt*60;
const dx=f.x-CX,dy=f.y-CY,dist=Math.sqrt(dx*dx+dy*dy);
if(dist>Math.max(openR-2,2)){const a=Math.random()*Math.PI*2;const d=Math.random()*Math.max(openR-3,1);f.x=CX+Math.cos(a)*d;f.y=CY+Math.sin(a)*d;f.ang=Math.random()*Math.PI*2}
X.beginPath();X.arc(f.x,f.y,f.sz,0,Math.PI*2);
X.fillStyle=`rgba(255,180,180,${f.alpha*sm})`;X.fill()})}

function drawBloodCells(dt){
const innerR=AR*.85;const plaqueT=innerR*(S.displayBlockage/100);
const openR=Math.max(innerR-plaqueT,2)*.82;
const sm=S.displayBlockage>85?.08:S.displayBlockage>70?.25:S.displayBlockage>50?.5:1;

S.bloodCells.forEach(c=>{
c.ang+=c.drift;c.rot+=c.rotSpd;c.wobble+=.03;
c.x+=Math.cos(c.ang)*c.spd*sm*dt*60;
c.y+=Math.sin(c.ang)*c.spd*sm*dt*60;
const dx=c.x-CX,dy=c.y-CY,dist=Math.sqrt(dx*dx+dy*dy);
if(dist>Math.max(openR-2,2)){const a=Math.random()*Math.PI*2;const d=Math.random()*Math.max(openR-4,1);c.x=CX+Math.cos(a)*d;c.y=CY+Math.sin(a)*d;c.ang=Math.random()*Math.PI*2}

// Biconcave disc shape
X.save();X.translate(c.x,c.y);X.rotate(c.rot);
const wobSz=c.sz*(1+Math.sin(c.wobble)*.08);
X.beginPath();X.ellipse(0,0,wobSz,wobSz*.6,0,0,Math.PI*2);
const cg=X.createRadialGradient(-wobSz*.2,-wobSz*.15,0,0,0,wobSz);
cg.addColorStop(0,'#ff5555');cg.addColorStop(.3,'#dd3333');cg.addColorStop(.6,'#bb2222');cg.addColorStop(1,'#881515');
X.fillStyle=cg;X.fill();

// Dimple highlight
X.beginPath();X.ellipse(0,0,wobSz*.35,wobSz*.2,0,0,Math.PI*2);
X.fillStyle='rgba(80,10,10,.3)';X.fill();

// Specular highlight
X.beginPath();X.ellipse(-wobSz*.25,-wobSz*.15,wobSz*.2,wobSz*.12,-.3,0,Math.PI*2);
X.fillStyle='rgba(255,150,150,.2)';X.fill();

X.restore()})}

function drawFatGlobs(dt){
S.fatGlobs=S.fatGlobs.filter(g=>{
g.life-=dt*.6;
const innerR=AR*.85;const plaqueEdge=innerR-innerR*(S.displayBlockage/100);
const currDist=Math.sqrt((g.x-CX)**2+(g.y-CY)**2);
const moveR=currDist+g.spd*dt*60;
g.x=CX+Math.cos(g.a)*moveR;g.y=CY+Math.sin(g.a)*moveR;

// Trail
g.trail.push({x:g.x,y:g.y,a:g.life});
if(g.trail.length>8)g.trail.shift();
g.trail.forEach((tp,i)=>{
X.beginPath();X.arc(tp.x,tp.y,g.sz*(i/g.trail.length)*.5,0,Math.PI*2);
X.fillStyle=`rgba(255,200,50,${tp.a*.08})`;X.fill()});

// Main glob
X.beginPath();X.arc(g.x,g.y,g.sz,0,Math.PI*2);
const gg=X.createRadialGradient(g.x-1,g.y-1,0,g.x,g.y,g.sz);
gg.addColorStop(0,`rgba(255,240,120,${g.life*.8})`);
gg.addColorStop(.5,`rgba(255,200,60,${g.life*.7})`);
gg.addColorStop(1,`rgba(200,150,30,${g.life*.4})`);
X.fillStyle=gg;X.fill();

// Glow
if(g.glow){X.beginPath();X.arc(g.x,g.y,g.sz*2.5,0,Math.PI*2);X.fillStyle=`rgba(255,200,50,${g.life*.06})`;X.fill()}
return g.life>0})}

function drawDissolve(dt){
S.dissolveParts=S.dissolveParts.filter(p=>{
p.life-=dt*.5;p.x+=p.vx*dt*60;p.y+=p.vy*dt*60;
p.vx*=.97;p.vy*=.97;p.sz*=.998;
// Sparkle
X.beginPath();X.arc(p.x,p.y,p.sz+Math.sin(performance.now()*.01+p.hue)*1,0,Math.PI*2);
X.fillStyle=`hsla(${p.hue},80%,70%,${p.life*.5})`;X.fill();
// Glow
X.beginPath();X.arc(p.x,p.y,p.sz*3,0,Math.PI*2);
X.fillStyle=`hsla(${p.hue},80%,60%,${p.life*.06})`;X.fill();
return p.life>0})}

function drawShockwave(dt){
if(!S.shockwave)return;
const sw=S.shockwave;sw.life-=dt*1.5;sw.r+=(sw.maxR-sw.r)*.08;
X.beginPath();X.arc(CX,CY,sw.r,0,Math.PI*2);
X.strokeStyle=sw.color.replace('1)',`${sw.life*.3})`);X.lineWidth=3;X.stroke();
if(sw.life<=0)S.shockwave=null}

function drawPulseRings(dt){
S.pulseRings=S.pulseRings.filter(pr=>{
pr.life-=dt*1.2;pr.r+=(pr.maxR-pr.r)*.06;
X.beginPath();X.arc(CX,CY,pr.r,0,Math.PI*2);
X.strokeStyle=pr.color.replace('1)',`${pr.life*.2})`);X.lineWidth=2;X.stroke();
return pr.life>0})}

function drawLabels(hb){
const time=performance.now()*.001;

// Connecting lines to labels
X.setLineDash([3,3]);X.lineWidth=1;

// Artery Wall
const awLabelY=CY-AR-28;
X.beginPath();X.moveTo(CX,CY-AR);X.lineTo(CX,awLabelY+8);
X.strokeStyle='rgba(255,255,255,.2)';X.stroke();
X.setLineDash([]);
X.font='bold 12px Rajdhani,sans-serif';X.textAlign='center';
X.fillStyle='rgba(255,255,255,.65)';X.fillText('Artery Wall',CX,awLabelY);

// Plaque
if(S.displayBlockage>8){
const innerR=AR*.85;const openR=innerR*(1-S.displayBlockage/100);
const plaqueR=(innerR+openR)/2;
const plLabelX=CX+plaqueR*.72+50;const plLabelY=CY-plaqueR*.72;
X.setLineDash([3,3]);
X.beginPath();X.moveTo(CX+Math.cos(-Math.PI/4)*plaqueR,CY+Math.sin(-Math.PI/4)*plaqueR);
X.lineTo(plLabelX-20,plLabelY+4);X.strokeStyle='rgba(255,200,80,.3)';X.stroke();
X.setLineDash([]);
X.fillStyle=`rgba(255,200,80,${.6+Math.sin(time*2)*.15})`;
X.fillText('Plaque',plLabelX,plLabelY)}

// Blood Flow
const bfLabelY=CY+AR+24;
X.setLineDash([3,3]);
X.beginPath();X.moveTo(CX,CY+AR*.5);X.lineTo(CX,bfLabelY-8);
X.strokeStyle='rgba(255,100,100,.2)';X.stroke();
X.setLineDash([]);
X.fillStyle='rgba(255,120,120,.7)';
X.fillText('Blood Flow ‚Üí',CX,bfLabelY);

// Efficiency gauge
const eff=S.displayBlockage<30?'High':S.displayBlockage<60?'Med':'Low';
const eCol=S.displayBlockage<30?'#4caf50':S.displayBlockage<60?'#ffc107':'#f44336';
X.font='bold 13px Rajdhani,sans-serif';X.fillStyle=eCol;
X.fillText(`‚ö° Efficiency: ${eff}`,CX,bfLabelY+18)}

// ===== GAME LOGIC =====
function selectFuel(btn){
if(S.animating||S.gameOver||btn.classList.contains('locked'))return;
if(S.round>=5&&S.changedVar==='activity')return;
const fuel=btn.dataset.fuel;
document.querySelectorAll('.fuel-btn').forEach(b=>b.classList.remove('selected'));
btn.classList.add('selected');S.selectedFuel=fuel;
if(S.round>=5){
if(fuel!==S.previousFuel){S.changedVar='fuel';S.selectedActivity=S.previousActivity;lockActBtns(true,S.previousActivity)}
else{S.changedVar=null;if(S.activityUnlocked)unlockActBtns()}}
updateGo()}

function selectActivity(btn){
if(S.animating||S.gameOver||btn.classList.contains('locked')||S.round<5)return;
if(S.changedVar==='fuel')return;
const act=btn.dataset.activity;
document.querySelectorAll('.activity-btn').forEach(b=>b.classList.remove('selected'));
btn.classList.add('selected');S.selectedActivity=act;
if(act!==S.previousActivity){S.changedVar='activity';S.selectedFuel=S.previousFuel;lockFuelBtns(true,S.previousFuel)}
else{S.changedVar=null;unlockFuelBtns()}
updateGo()}

function lockFuelBtns(lock,keep){document.querySelectorAll('.fuel-btn').forEach(b=>{if(lock){b.classList.add('locked');b.classList.remove('selected');if(b.dataset.fuel===keep)b.classList.add('selected')}else b.classList.remove('locked')})}
function lockActBtns(lock,keep){document.querySelectorAll('.activity-btn').forEach(b=>{if(lock){b.classList.add('locked');b.classList.remove('selected');if(b.dataset.activity===keep)b.classList.add('selected')}else b.classList.remove('locked')})}
function unlockFuelBtns(){document.querySelectorAll('.fuel-btn').forEach(b=>b.classList.remove('locked'))}
function unlockActBtns(){document.querySelectorAll('.activity-btn').forEach(b=>{b.classList.remove('locked');b.querySelector('.lock-overlay').textContent=''});document.getElementById('activityLockMsg').textContent='Change ONE variable'}

function updateGo(){
const btn=document.getElementById('goBtn');
if(S.round<5){if(S.selectedFuel){btn.className='go-btn ready';btn.textContent='Run Round ‚ñ∂'}else{btn.className='go-btn waiting';btn.textContent='Pick Fuel'}}
else{if(S.selectedFuel&&S.selectedActivity){btn.className='go-btn ready';btn.textContent='Run Round ‚ñ∂'}else{btn.className='go-btn waiting';btn.textContent='Pick Variable'}}}

function runRound(){
if(S.animating||S.gameOver)return;
if(S.round<5&&!S.selectedFuel)return;
if(S.round>=5&&(!S.selectedFuel||!S.selectedActivity))return;
S.animating=true;document.getElementById('goBtn').style.display='none';

if(S.round===4&&!S.stressApplied){S.stressApplied=true;showBanner('‚ö° Stress Spike!','Plaque +5%','#f44336');setTimeout(()=>processRound(),2200);return}
if(S.round===8&&S.data.length===7){S.blockage=50;S.displayBlockage=50;updateMeterVal(50);spawnShockwave('rgba(255,193,7,1)');showBanner('üîÑ Reversal Challenge','Start: 50%','#ff9800');setTimeout(()=>processRound(),2200);return}
processRound()}

function processRound(){
const fuel=S.selectedFuel,act=S.selectedActivity;
let chg=0;
if(fuel==='High-Fat')chg+=10+Math.floor(Math.random()*6);
else if(fuel==='Mixed')chg+=2+Math.floor(Math.random()*4);
else chg-=5-Math.floor(Math.random()*3);
if(S.round>=5){if(act==='Active')chg-=5-Math.floor(Math.random()*2);else if(act==='Sedentary')chg+=3+Math.floor(Math.random()*3)}
if(S.round===4&&S.stressApplied)chg+=5;

// Power-up
let boosted=false;
if(S.powerUpAvailable&&fuel==='Heart-Healthy'){chg*=2;S.powerUpAvailable=false;S.powerUpUsed=true;boosted=true;showFeedback('‚ú® Clean Flow 2x!','#ff9800')}

const oldB=S.blockage;
S.blockage=Math.max(0,Math.min(100,S.blockage+chg));

// Particles
if(chg>0){spawnFat(Math.abs(chg)*3);spawnPulseRing('rgba(255,150,50,1)')}
else if(chg<0){spawnDissolve(Math.abs(chg)*4);spawnPulseRing('rgba(100,200,255,1)')}
if(boosted)spawnShockwave('rgba(255,200,50,1)');

let flow;if(S.blockage<40)flow='Strong';else if(S.blockage<70)flow='Reduced';else flow='Critical';

if(fuel==='Heart-Healthy'){S.healthyStreak++;S.streak++;S.score+=100+S.streak*20}
else{S.healthyStreak=0;if(fuel==='Mixed'){S.streak=Math.max(0,S.streak-1);S.score+=50}else{S.streak=0;S.score+=10}}
if(S.healthyStreak>=3&&!S.powerUpUsed){S.powerUpAvailable=true;showBadge('powerup','‚ú® Clean Flow Boost!')}

S.data.push({fuel,activity:act,blockage:S.blockage,flow});

animateBlockage(oldB,S.blockage,()=>{
updateHUD(flow);addRow(fuel,act,S.blockage,flow);updateWarnings();
S.previousFuel=fuel;S.previousActivity=act;
if(S.data.length===5){showBadge('complete','‚úÖ Required Complete!');setStatus('Extra credit? Keep going!','rgba(76,175,80,.12)','#66bb6a','rgba(76,175,80,.15)')}
if(S.round>=8){S.gameOver=true;showBadge('extra','üèÜ All 8 Complete!');setTimeout(()=>showEnd(),1500)}
S.animating=false;
if(!S.gameOver)document.getElementById('nextBtn').style.display='block'})}

function animateBlockage(from,to,cb){
const dur=1400,start=performance.now();
function tick(now){const t=Math.min((now-start)/dur,1);const e=t<.5?2*t*t:-1+(4-2*t)*t;
S.displayBlockage=from+(to-from)*e;updateMeterVal(S.displayBlockage);
if(t<1)requestAnimationFrame(tick);else{S.displayBlockage=to;updateMeterVal(to);if(cb)cb()}}
requestAnimationFrame(tick)}

function updateMeterVal(v){
const m=document.getElementById('blockageMeter'),t=document.getElementById('blockageText');
const p=Math.round(v);m.style.width=p+'%';t.textContent=p+'%';
if(p<30)m.style.background='linear-gradient(90deg,#2e7d32,#4caf50)';
else if(p<60)m.style.background='linear-gradient(90deg,#f9a825,#fbc02d)';
else if(p<80)m.style.background='linear-gradient(90deg,#e65100,#ef6c00)';
else m.style.background='linear-gradient(90deg,#c62828,#e53935)'}

function updateHUD(flow){
document.getElementById('hudScore').textContent=S.score;
document.getElementById('hudStreak').textContent=S.streak;
document.getElementById('hudRounds').textContent=S.data.length+'/8';
const fi=document.getElementById('flowIndicator');fi.textContent=flow;
if(flow==='Strong'){fi.style.background='rgba(76,175,80,.12)';fi.style.color='#4caf50';fi.style.borderColor='rgba(76,175,80,.2)'}
else if(flow==='Reduced'){fi.style.background='rgba(255,193,7,.12)';fi.style.color='#ffc107';fi.style.borderColor='rgba(255,193,7,.2)'}
else{fi.style.background='rgba(244,67,54,.12)';fi.style.color='#f44336';fi.style.borderColor='rgba(244,67,54,.2)'}
const pct=S.data.length<5?S.data.length/5*100:S.data.length/8*100;
document.getElementById('progressBar').style.width=pct+'%';
if(S.data.length<5)document.getElementById('progressLabel').textContent=`${S.data.length}/5 required`;
else if(S.data.length<8){document.getElementById('progressLabel').textContent=`${S.data.length}/8 extra credit!`;document.getElementById('progressBar').style.background='linear-gradient(90deg,#7b1fa2,#ab47bc)'}
else{document.getElementById('progressLabel').textContent='8/8 all done!';document.getElementById('progressBar').style.width='100%'}
document.getElementById('roundBadge').textContent=`Round ${Math.min(S.round,8)} / 8`}

function updateWarnings(){
const w=document.getElementById('hudWarning'),o=document.getElementById('warnOverlay');
if(S.blockage>=90){w.textContent='CRITICAL';w.className='hud-value red';o.className='warning-overlay red'}
else if(S.blockage>=70){w.textContent='WARNING';w.className='hud-value yellow';o.className='warning-overlay yellow'}
else{w.textContent='OK';w.className='hud-value green';o.className='warning-overlay'}}

function addRow(fuel,act,block,flow){
const tb=document.getElementById('dataBody'),tr=document.createElement('tr');tr.className='new-row';
const fc=flow==='Strong'?'#4caf50':flow==='Reduced'?'#ffc107':'#f44336';
tr.innerHTML=`<td>${fuel}</td><td>${act}</td><td>${Math.round(block)}%</td><td style="color:${fc};font-weight:700">${flow}</td>`;tb.appendChild(tr)}

function nextRound(){
if(S.gameOver)return;S.round++;S.selectedFuel=null;S.changedVar=null;
document.getElementById('nextBtn').style.display='none';document.getElementById('goBtn').style.display='block';
document.querySelectorAll('.fuel-btn').forEach(b=>{b.classList.remove('selected','locked')});
document.querySelectorAll('.activity-btn').forEach(b=>b.classList.remove('selected'));
if(S.round>=5&&!S.activityUnlocked){S.activityUnlocked=true;unlockActBtns();showBanner('üîì Activity Unlocked!','Change ONE variable','#4caf50')}
if(S.round>=5){S.selectedActivity=null;unlockFuelBtns();unlockActBtns()}else S.selectedActivity='Moderate';
updateGo();updateStatus();document.getElementById('roundBadge').textContent=`Round ${S.round} / 8`;
setTimeout(()=>{document.getElementById('eventBanner').style.display='none'},100)}

function updateStatus(){
if(S.data.length>=5&&S.round<=8)setStatus('Extra credit rounds!','rgba(156,39,176,.12)','#ce93d8','rgba(156,39,176,.15)');
else if(S.round>=5)setStatus('Change ONE variable','rgba(33,150,243,.1)','#42a5f5','rgba(33,150,243,.15)');
else setStatus('Pick your fuel!','rgba(33,150,243,.1)','#42a5f5','rgba(33,150,243,.15)')}

function setStatus(txt,bg,col,bc){const m=document.getElementById('statusMsg');m.textContent=txt;m.style.background=bg;m.style.color=col;m.style.borderColor=bc}

function showBanner(title,sub,color){const b=document.getElementById('eventBanner');b.innerHTML=`<div style="color:${color};font-family:Orbitron,sans-serif">${title}</div><div style="font-size:.7em;color:#999;margin-top:5px;font-family:Rajdhani,sans-serif">${sub}</div>`;b.style.display='block';b.style.borderColor=color;setTimeout(()=>{b.style.display='none'},2500)}
function showFeedback(txt,color){const f=document.getElementById('feedbackFlash');f.textContent=txt;f.style.background=color;f.style.color='#fff';f.style.display='block';setTimeout(()=>{f.style.display='none'},2000)}
function showBadge(type,txt){const b=document.getElementById('badgeArea');b.className=`badge ${type}`;b.textContent=txt;setTimeout(()=>{b.className='badge'},4000)}
function showEnd(){const s=document.getElementById('completionScreen');s.style.display='flex';
const t=document.getElementById('completionTitle'),m=document.getElementById('completionMsg');
if(S.blockage<30){t.textContent='ü´Ä Artery Saved!';m.textContent='You reversed the damage!'}
else if(S.blockage>=90){t.textContent='üíî Critical Blockage!';m.textContent='The artery hit the danger zone.'}
else{t.textContent='ü´Ä Mission Complete!';m.textContent=`Final blockage: ${Math.round(S.blockage)}%`}}

function copyTable(){
if(!S.data.length)return;
let t='Fuel Type\tActivity Level\tBlockage %\tBlood Flow\n';
S.data.forEach(d=>{t+=`${d.fuel}\t${d.activity}\t${Math.round(d.blockage)}%\t${d.flow}\n`});
try{navigator.clipboard.writeText(t).then(()=>{const b=document.querySelector('.copy-btn');b.textContent='‚úÖ Copied!';setTimeout(()=>{b.textContent='üìã Copy Table'},2000)})}
catch(e){const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);const b=document.querySelector('.copy-btn');b.textContent='‚úÖ Copied!';setTimeout(()=>{b.textContent='üìã Copy Table'},2000)}}

function resetGame(){
Object.assign(S,{round:1,blockage:10,displayBlockage:10,score:0,streak:0,healthyStreak:0,
selectedFuel:null,selectedActivity:'Moderate',previousFuel:null,previousActivity:'Moderate',
activityUnlocked:false,changedVar:null,powerUpAvailable:false,powerUpUsed:false,
stressApplied:false,animating:false,gameOver:false,data:[],fatGlobs:[],dissolveParts:[],
shockwave:null,pulseRings:[]});
document.getElementById('dataBody').innerHTML='';
document.querySelectorAll('.fuel-btn').forEach(b=>{b.classList.remove('selected','locked')});
document.querySelectorAll('.activity-btn').forEach(b=>{b.classList.remove('selected');b.classList.add('locked');const l=b.querySelector('.lock-overlay');if(l)l.textContent='üîí'});
document.getElementById('activityLockMsg').textContent='üîí Unlocks Round 5';
document.getElementById('completionScreen').style.display='none';
document.getElementById('nextBtn').style.display='none';
document.getElementById('goBtn').style.display='block';
document.getElementById('eventBanner').style.display='none';
document.getElementById('warnOverlay').className='warning-overlay';
document.getElementById('badgeArea').className='badge';
updateMeterVal(10);updateGo();updateWarnings();updateStatus();
document.getElementById('hudScore').textContent='0';document.getElementById('hudStreak').textContent='0';
document.getElementById('hudRounds').textContent='0/8';
document.getElementById('progressBar').style.width='0%';
document.getElementById('progressBar').style.background='linear-gradient(90deg,#2e7d32,#4caf50)';
document.getElementById('progressLabel').textContent='Complete 5 rounds';
document.getElementById('roundBadge').textContent='Round 1 / 8';
const fi=document.getElementById('flowIndicator');fi.textContent='Strong';fi.style.background='rgba(76,175,80,.12)';fi.style.color='#4caf50';fi.style.borderColor='rgba(76,175,80,.2)';
initBloodCells();initFloaters()}
function newRun(){resetGame()}

// ===== INIT =====
resize();initBloodCells();initFloaters();updateMeterVal(10);updateGo();requestAnimationFrame(render);
</script>
</body>
</html>
