<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation The Disease Nobody Could Solve</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#1a1a2e;color:#e0e0e0;overflow:hidden;height:100vh;}
.app{display:flex;height:100vh;width:100vw;}
.left-sb{width:280px;min-width:280px;background:linear-gradient(180deg,#1e1e3a,#16213e);border-right:2px solid #2a2a5a;display:flex;flex-direction:column;overflow-y:auto;padding:10px;}
.left-sb::-webkit-scrollbar{width:6px;}.left-sb::-webkit-scrollbar-thumb{background:#444;border-radius:3px;}
.pick-hdr{text-align:center;font-size:15px;font-weight:700;color:#ffd54f;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;}
.pick-count{text-align:center;font-size:13px;color:#aaa;margin-bottom:10px;}
.sc-card{display:flex;align-items:center;gap:8px;padding:10px;margin-bottom:6px;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s;background:rgba(255,255,255,.05);position:relative;}
.sc-card:hover{background:rgba(255,255,255,.1);border-color:#ffd54f;}
.sc-card.active{background:rgba(255,215,0,.15);border-color:#ffd54f;box-shadow:0 0 12px rgba(255,215,0,.3);}
.sc-card.done{border-color:#4caf50;}.sc-card.done .sc-check{display:block;}
.sc-check{display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);color:#4caf50;font-weight:700;font-size:16px;}
.sc-emoji{font-size:28px;flex-shrink:0;}.sc-name{font-size:13px;font-weight:600;color:#e0e0e0;line-height:1.3;}
.divider{height:1px;background:linear-gradient(90deg,transparent,#555,transparent);margin:12px 0;}
.rl-section{margin-bottom:10px;}
.rl-label{font-size:12px;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;text-align:center;}
.rl-tabs{display:flex;gap:4px;}
.rl-tab{flex:1;text-align:center;padding:6px 0;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;border:2px solid #444;color:#aaa;transition:all .2s;background:transparent;}
.rl-tab:hover{border-color:#ffd54f;color:#ffd54f;}
.rl-tab.active{background:#ffd54f;color:#1a1a2e;border-color:#ffd54f;}
.kw-section{margin-top:6px;}.kw-label{font-size:12px;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;text-align:center;}
.kw-list{display:flex;flex-direction:column;gap:4px;}
.kw-item{font-size:13px;padding:4px 8px;border-radius:6px;background:rgba(255,255,255,.05);color:#bbb;transition:all .2s;}
.kw-item.highlighted{background:rgba(255,215,0,.2);color:#ffd54f;font-weight:600;}
.btn-reset{width:100%;padding:8px;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;margin-top:6px;transition:all .2s;}
.btn-reset.red{background:linear-gradient(135deg,#e53935,#c62828);color:#fff;}
.btn-reset.blue{background:linear-gradient(135deg,#1e88e5,#1565c0);color:#fff;}
.btn-reset:hover{transform:scale(1.02);filter:brightness(1.1);}
.center{flex:1;display:flex;flex-direction:column;overflow:hidden;background:linear-gradient(180deg,#0f0f2a,#1a1a35);}
.title-bar{text-align:center;padding:10px;background:linear-gradient(135deg,#4a148c,#880e4f);font-size:16px;font-weight:700;color:#fff;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,.5);}
.step-tabs{display:flex;padding:6px 16px;gap:6px;background:rgba(0,0,0,.3);}
.step-tab{flex:1;text-align:center;padding:8px 4px;border-radius:8px;font-size:12px;font-weight:700;color:#666;background:rgba(255,255,255,.05);transition:all .3s;text-transform:uppercase;letter-spacing:.5px;}
.step-tab.active{color:#ffd54f;background:rgba(255,215,0,.15);box-shadow:0 0 15px rgba(255,215,0,.3);animation:glow 1.5s ease-in-out infinite alternate;}
.step-tab.completed{color:#4caf50;background:rgba(76,175,80,.15);}
@keyframes glow{from{box-shadow:0 0 10px rgba(255,215,0,.2);}to{box-shadow:0 0 20px rgba(255,215,0,.4);}}
.center-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;overflow-y:auto;position:relative;}
.welcome-screen{text-align:center;max-width:600px;}
.welcome-screen h2{font-size:28px;color:#ffd54f;margin-bottom:12px;text-shadow:0 2px 8px rgba(255,215,0,.3);}
.welcome-screen p{font-size:16px;color:#bbb;line-height:1.6;margin-bottom:8px;}
.welcome-screen .hook{font-size:20px;color:#ff8a65;font-style:italic;margin:16px 0;padding:12px;border-left:4px solid #ff8a65;background:rgba(255,138,101,.1);border-radius:0 8px 8px 0;}
.mission-badge{display:inline-block;padding:8px 20px;background:linear-gradient(135deg,#ffd54f,#ffb300);color:#1a1a2e;font-weight:700;border-radius:20px;font-size:14px;margin-top:12px;}
.predict-card{background:linear-gradient(135deg,rgba(255,213,79,.1),rgba(255,179,0,.05));border:2px solid #ffd54f;border-radius:16px;padding:24px;max-width:600px;width:100%;text-align:center;}
.predict-card h3{color:#ffd54f;font-size:22px;margin-bottom:12px;}
.predict-card p{color:#ddd;font-size:16px;line-height:1.5;margin-bottom:8px;}
.predict-options{display:flex;flex-direction:column;gap:8px;margin-top:16px;}
.predict-btn{padding:12px 16px;border:2px solid #555;border-radius:10px;background:rgba(255,255,255,.05);color:#e0e0e0;font-size:14px;cursor:pointer;transition:all .2s;text-align:left;}
.predict-btn:hover{border-color:#ffd54f;background:rgba(255,215,0,.1);transform:translateX(4px);}
.predict-btn.selected{border-color:#4caf50;background:rgba(76,175,80,.15);color:#4caf50;}
.read-card{background:linear-gradient(135deg,rgba(30,136,229,.08),rgba(21,101,192,.04));border:2px solid #1e88e5;border-radius:16px;padding:24px;max-width:650px;width:100%;position:relative;}
.read-card h3{color:#1e88e5;font-size:20px;margin-bottom:12px;text-align:center;}
.passage-text{font-size:17px;line-height:1.8;color:#e0e0e0;background:rgba(255,255,255,.03);padding:16px;border-radius:10px;}
.passage-text .kw{color:#ffd54f;font-weight:700;}
.passage-text .sentence-hl{background:rgba(255,215,0,.2);border-radius:3px;transition:background .3s;}
.read-aloud-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:2px solid #1e88e5;border-radius:8px;background:transparent;color:#1e88e5;font-size:13px;font-weight:600;cursor:pointer;margin-top:12px;transition:all .2s;}
.read-aloud-btn:hover{background:rgba(30,136,229,.15);}
.read-aloud-btn.speaking{background:#1e88e5;color:#fff;animation:pulse 1s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.7;}}
.watch-area{width:100%;max-width:750px;text-align:center;}
.watch-area h3{color:#e040fb;font-size:20px;margin-bottom:10px;}
.watch-canvas-wrap{position:relative;width:100%;border-radius:16px;overflow:hidden;border:2px solid #333;background:linear-gradient(180deg,#0d0d25,#141430);}
.watch-canvas-wrap canvas{display:block;width:100%;height:auto;}
.watch-status{margin-top:8px;font-size:14px;color:#aaa;min-height:20px;transition:color .3s;}
.record-card{text-align:center;max-width:500px;}
.record-card h3{color:#4caf50;font-size:22px;margin-bottom:12px;}
.record-card p{color:#bbb;font-size:15px;margin-bottom:8px;}
.record-badge{font-size:48px;margin:12px 0;animation:bounce .6s ease-out;}
@keyframes bounce{0%{transform:scale(0);}60%{transform:scale(1.2);}100%{transform:scale(1);}}
.ec-banner{text-align:center;padding:8px;background:linear-gradient(135deg,#ffd54f,#ff8f00);color:#1a1a2e;font-weight:700;font-size:14px;border-radius:8px;margin:8px 0;animation:ecPulse 2s ease-in-out infinite;}
@keyframes ecPulse{0%,100%{box-shadow:0 0 8px rgba(255,215,0,.3);}50%{box-shadow:0 0 20px rgba(255,215,0,.6);}}
.completion-screen{text-align:center;max-width:500px;}
.completion-screen h2{font-size:32px;color:#ffd54f;margin-bottom:12px;}
.completion-screen p{font-size:16px;color:#bbb;margin-bottom:8px;}
.trophy{font-size:72px;animation:trophySpin 1s ease-out;}
@keyframes trophySpin{from{transform:rotateY(180deg) scale(0);}to{transform:rotateY(0) scale(1);}}
.action-area{padding:12px;text-align:center;background:rgba(0,0,0,.3);}
.action-btn{padding:12px 32px;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:1px;}
.action-btn.primary{background:linear-gradient(135deg,#ffd54f,#ffb300);color:#1a1a2e;}
.action-btn.primary:hover{transform:scale(1.03);filter:brightness(1.1);box-shadow:0 4px 15px rgba(255,213,79,.4);}
.action-btn:disabled{opacity:.4;cursor:not-allowed;transform:none !important;filter:none !important;}
.right-sb{width:280px;min-width:280px;background:linear-gradient(180deg,#1e1e3a,#16213e);border-left:2px solid #2a2a5a;display:flex;flex-direction:column;overflow-y:auto;padding:10px;}
.right-sb::-webkit-scrollbar{width:6px;}.right-sb::-webkit-scrollbar-thumb{background:#444;border-radius:3px;}
.hud-title{text-align:center;font-size:14px;font-weight:700;color:#e040fb;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.hud-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}
.hud-stat{background:rgba(255,255,255,.05);border-radius:10px;padding:10px 8px;text-align:center;border:1px solid #333;}
.hud-stat-val{font-size:22px;font-weight:700;color:#ffd54f;}
.hud-stat-label{font-size:10px;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}
.progress-section{margin-bottom:10px;}
.progress-bar-bg{width:100%;height:14px;background:#333;border-radius:7px;overflow:hidden;margin:6px 0;}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,#4caf50,#81c784);border-radius:7px;transition:width .5s;width:0%;}
.progress-msg{text-align:center;font-size:12px;color:#81c784;font-weight:600;}
.data-title{display:flex;align-items:center;justify-content:space-between;margin-top:6px;margin-bottom:6px;}
.data-title span{font-size:14px;font-weight:700;color:#1e88e5;text-transform:uppercase;letter-spacing:1px;}
.copy-btn{padding:4px 10px;border:1px solid #1e88e5;border-radius:6px;background:transparent;color:#1e88e5;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;}
.copy-btn:hover{background:rgba(30,136,229,.15);}
.copy-btn.copied{background:#4caf50;color:#fff;border-color:#4caf50;}
.data-table{width:100%;border-collapse:collapse;font-size:10px;}
.data-table th{background:#1e88e5;color:#fff;padding:5px 3px;text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:.3px;}
.data-table td{padding:4px 3px;border-bottom:1px solid #333;color:#ccc;font-size:10px;vertical-align:top;word-break:break-word;}
.data-table tr:nth-child(even){background:rgba(255,255,255,.02);}
.data-table tr.new-row{animation:rowFlash .8s ease-out;}
@keyframes rowFlash{from{background:rgba(255,215,0,.3);}to{background:transparent;}}
.safety-rules{margin-top:auto;padding-top:10px;border-top:1px solid #333;}
.safety-rules p{font-size:10px;color:#777;margin-bottom:3px;line-height:1.3;}
</style>
</head>
<body>
<div class="app">
<div class="left-sb">
<div class="pick-hdr">Pick Any 5 You Like</div>
<div class="pick-count" id="pickCount">8 stories available</div>
<div id="scenarioList"></div>
<div class="divider"></div>
<div class="rl-section">
<div class="rl-label">Reading Level</div>
<div class="rl-tabs">
<div class="rl-tab active" data-level="low" onclick="setLevel('low')">Low</div>
<div class="rl-tab" data-level="med" onclick="setLevel('med')">Med</div>
<div class="rl-tab" data-level="high" onclick="setLevel('high')">High</div>
</div>
</div>
<div class="divider"></div>
<div class="kw-section">
<div class="kw-label">Key Words</div>
<div class="kw-list" id="kwList"></div>
</div>
<div class="divider"></div>
<button class="btn-reset red" onclick="resetSim()">Reset</button>
<button class="btn-reset blue" onclick="newRun()" style="margin-top:4px;">New Run</button>
</div>
<div class="center">
<div class="title-bar">Mr. Jawad Simulation The Disease Nobody Could Solve</div>
<div class="step-tabs" id="stepTabs">
<div class="step-tab" data-step="predict">1. Predict</div>
<div class="step-tab" data-step="read">2. Read</div>
<div class="step-tab" data-step="watch">3. Watch</div>
<div class="step-tab" data-step="record">4. Record</div>
</div>
<div class="center-content" id="centerContent"></div>
<div class="action-area" id="actionArea"></div>
</div>
<div class="right-sb">
<div class="hud-title">Progress</div>
<div class="hud-grid">
<div class="hud-stat"><div class="hud-stat-val" id="hudScore">0</div><div class="hud-stat-label">Score</div></div>
<div class="hud-stat"><div class="hud-stat-val" id="hudStreak">0</div><div class="hud-stat-label">Streak</div></div>
<div class="hud-stat"><div class="hud-stat-val" id="hudCompleted">0/8</div><div class="hud-stat-label">Completed</div></div>
<div class="hud-stat"><div class="hud-stat-val" id="hudAccuracy">--</div><div class="hud-stat-label">Accuracy</div></div>
</div>
<div class="progress-section">
<div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
<div class="progress-msg" id="progressMsg">Pick your first story!</div>
</div>
<div class="data-title"><span>Data Table</span><button class="copy-btn" id="copyBtn" onclick="copyTable()">üìã Copy Table</button></div>
<table class="data-table"><thead><tr><th>Scenario</th><th>What Happened?</th><th>Response</th><th>Connection?</th></tr></thead><tbody id="dataBody"></tbody></table>
<div class="safety-rules">
<p>1. Every person in these stories was real ‚Äî treat their experiences with respect.</p>
<p>2. Complete 5 scenarios before claiming extra credit.</p>
<p>3. Record your data honestly each round.</p>
<p>4. If you finish early, try a harder reading level on a new scenario.</p>
</div>
</div>
</div>

<script>
// ===================== SCENARIO DATA =====================
const SCENARIOS=[
{id:1,name:"The Orphans",emoji:"üèöÔ∏è",premise:"In 1914, over half the children in a Mississippi orphanage have cracking skin and confusion, but none of the adult staff are sick.",
readings:{
low:{text:'Over half the children in a Mississippi orphanage have red, cracking skin. It is a <kw>symptom</kw> of a mystery disease called pellagra. The kids eat only corn grits and syrup, but staff who eat meat and milk are fine. Dr. Goldberger adds better food, and the <kw>symptoms</kw> disappear.',
anim:{startPos:.35,endPos:.08,dir:'heal',rash:2,gut:0,brain:1,extras:[]}},
med:{text:'Something terrible is happening to children in a Mississippi orphanage. Over half the kids have red, cracking skin and constant confusion ‚Äî <kw>symptoms</kw> of a disease called pellagra. Not a single adult staff member is sick, even though they live in the same building. Dr. Joseph Goldberger discovers that children aged 7‚Äì11 eat only corn grits and syrup. Younger kids get milk, and older kids sneak better food from the kitchen. He suspects a <kw>nutrient</kw> <kw>deficiency</kw> and adds meat, milk, and eggs to every child\'s meals. Within months, the <kw>symptoms</kw> vanish ‚Äî the missing <kw>nutrient</kw> was the answer all along.',
anim:{startPos:.35,endPos:.08,dir:'heal',rash:2,gut:0,brain:2,extras:[]}},
high:{text:'Children are dying in orphanages across Mississippi, and an <kw>epidemic</kw> is spreading. Over half the kids in one orphanage have red, cracking skin that peels in the sun. They have constant diarrhea, and some cannot remember their own names. These are the <kw>symptoms</kw> of pellagra ‚Äî a disease killing thousands across the South. Not one adult staff member is sick, even though they touch the same children every day. Dr. Goldberger finds the answer in the cafeteria. Kids aged 7‚Äì11 eat only corn grits and syrup, while younger kids get milk and older kids sneak real food. He adds meat, milk, and eggs to every child\'s meals ‚Äî the skin heals, diarrhea stops, and the missing <kw>nutrient</kw> was <kw>niacin</kw>.',
anim:{startPos:.38,endPos:.08,dir:'heal',rash:3,gut:2,brain:1,extras:['niacin']}}},
dataRow:{happened:'Kids ate only corn grits and syrup',response:'Goldberger added meat, milk, eggs ‚Äî symptoms disappeared',connection:'Missing niacin caused pellagra; better food reversed it'}},

{id:2,name:"The Pellagra Squad",emoji:"‚õìÔ∏è",premise:"In 1915, eleven prisoners volunteer to eat nothing but corn grits and syrup for six months in exchange for a full pardon.",
readings:{
low:{text:'Eleven prisoners make a deal to walk free. They eat only corn grits, pork fat, and syrup for six months. By month five, six men can barely walk ‚Äî rashes and confusion take over. The moment they get real food, the <kw>symptoms</kw> start to disappear.',
anim:{startPos:.08,endPos:.55,dir:'worsen',rash:2,gut:1,brain:0,extras:[]}},
med:{text:'Eleven prisoners at Rankin Prison Farm volunteer for a dangerous experiment. The deal is simple: eat nothing but corn grits, pork fat, and syrup for six months, and the governor will grant a full pardon. Dr. Goldberger wants to prove that a <kw>nutrient</kw> <kw>deficiency</kw> ‚Äî not germs ‚Äî causes pellagra. By month five, six men have cracking skin, constant diarrhea, and confusion so bad they cannot follow simple instructions. One prisoner says he has been through a thousand hells. The moment the experiment ends and they eat real food, the <kw>symptoms</kw> start reversing ‚Äî proof that diet alone caused the disease.',
anim:{startPos:.08,endPos:.6,dir:'worsen',rash:2,gut:2,brain:1,extras:[]}},
high:{text:'Dr. Goldberger needs undeniable proof that pellagra is a <kw>nutrient</kw> <kw>deficiency</kw>. He strikes a deal with eleven prisoners at Rankin Prison Farm in Mississippi. Eat nothing but corn grits, pork fat, and syrup for six months ‚Äî and walk free. For the first few months, the men feel fine. Then <kw>symptoms</kw> hit ‚Äî cracking skin, constant diarrhea, and confusion. By month five, six men can barely walk ‚Äî one says he has been through a thousand hells. The moment they eat real food, the <kw>symptoms</kw> reverse. Change the food, change the disease ‚Äî the missing <kw>nutrient</kw> is <kw>niacin</kw>.',
anim:{startPos:.08,endPos:.62,dir:'worsen',rash:3,gut:2,brain:1,extras:['timeline']}}},
dataRow:{happened:'Prisoners ate only corn for 6 months',response:'6 of 11 got rashes, diarrhea, confusion by month 5',connection:'Corn-only diet missing niacin caused pellagra symptoms'}},

{id:3,name:"The Filth Party",emoji:"üß™",premise:"In 1916, Dr. Goldberger swallows pills made from pellagra patients' skin and blood to prove it is not contagious.",
readings:{
low:{text:'Nobody believes Dr. Goldberger when he says pellagra comes from food, not germs. He collects skin scabs, blood, and stool from pellagra patients. He swallows them as pills ‚Äî his wife Mary and 15 others do the same. Nobody gets pellagra, proving it is a <kw>deficiency</kw>, not an infection.',
anim:{startPos:.08,endPos:.08,dir:'stay',rash:0,gut:0,brain:0,extras:['stamp']}},
med:{text:'By 1916, Dr. Goldberger is desperate. He has proven twice that diet causes pellagra, but doctors across the South still insist it is a germ. So he does something nobody expects ‚Äî he collects skin scabs, blood, and stool from patients dying of pellagra and mixes them into pills. He swallows the pills himself, injects pellagra blood into his own arm, and convinces his wife Mary and 15 other volunteers to do the same. Weeks pass ‚Äî nobody develops a single <kw>symptom</kw>. Pellagra is not contagious; it is a <kw>nutrient</kw> <kw>deficiency</kw>, and Goldberger has just proven it with his own body.',
anim:{startPos:.08,endPos:.08,dir:'stay',rash:0,gut:0,brain:0,extras:['stamp','calendar']}},
high:{text:'By 1916, Dr. Goldberger has run two experiments proving pellagra is a <kw>nutrient</kw> <kw>deficiency</kw> ‚Äî but Southern doctors refuse to believe him. They insist the disease is caused by germs, not diet. Goldberger decides to settle the argument with the most extreme test he can think of. He collects skin scabs, blood, nasal secretions, and stool from patients dying of pellagra and grinds them into pills. He swallows the pills himself and injects pellagra blood directly into his own arm. His wife Mary and 15 other volunteers join what they call the "filth party" and do the same. Weeks pass, then months ‚Äî not a single person develops any <kw>symptom</kw> of pellagra. The <kw>epidemic</kw> killing thousands is not an infection you can catch from another person; it is a <kw>deficiency</kw> of a <kw>nutrient</kw> called <kw>niacin</kw>, hidden in the food people eat.',
anim:{startPos:.08,endPos:.08,dir:'stay',rash:0,gut:0,brain:0,extras:['stamp','calendar']}}},
dataRow:{happened:'Goldberger swallowed pellagra blood/skin pills',response:'Nobody got pellagra ‚Äî zero symptoms',connection:'Proved pellagra is not contagious ‚Äî it is a niacin deficiency'}},

{id:4,name:"The Cotton Family",emoji:"üåæ",premise:"In the 1920s, a Black tenant farming family eats almost nothing but cornmeal because every acre grows cotton for the landowner.",
readings:{
low:{text:'A Black tenant farming family in 1920s Georgia eats almost nothing but cornmeal, molasses, and cheap pork fat. Every acre of their land grows cotton for the landowner, leaving no room for food crops. The mother develops a butterfly-shaped rash on her face, and the children have constant diarrhea ‚Äî classic <kw>symptoms</kw> of pellagra. When cotton prices crash and the family starts growing their own vegetables, the <kw>symptoms</kw> slowly disappear.',
anim:{startPos:.55,endPos:.08,dir:'heal',rash:2,gut:2,brain:0,extras:['cotton']}},
med:{text:'In the 1920s, a Black tenant farming family in rural Georgia is trapped in a cycle that is making them sick. Every acre of their land grows cotton for the landowner, leaving no space for a vegetable garden. The family survives on the cheapest food available ‚Äî cornmeal, molasses, and fatback ‚Äî all missing the <kw>nutrient</kw> <kw>niacin</kw>. The mother develops the telltale butterfly-shaped rash of pellagra on her face, and the children have diarrhea so bad they cannot focus in school. When cotton prices crash, the family finally plants their own food. As vegetables, eggs, and milk enter their diet, the <kw>symptoms</kw> slowly fade.',
anim:{startPos:.55,endPos:.08,dir:'heal',rash:3,gut:2,brain:0,extras:['cotton']}},
high:{text:'In the 1920s, a Black tenant farming family in rural Georgia is caught in a system designed to keep them poor ‚Äî and it is destroying their health. Every acre of their land grows cotton for the white landowner, and the family gets no say in what is planted. With no garden space, they survive on the only food they can afford: cornmeal, molasses, and fatback. None of these foods contain the <kw>nutrient</kw> <kw>niacin</kw> in a form the body can use. The mother develops the telltale butterfly-shaped rash of pellagra on her face. The children have constant diarrhea and cannot concentrate in school ‚Äî both classic <kw>symptoms</kw> of <kw>niacin</kw> <kw>deficiency</kw>. When cotton prices crash, the landowner abandons the farm, and the family plants their own vegetables for the first time. As fresh food enters their diet, the rash fades, the diarrhea stops, and the children return to school clear-headed ‚Äî the <kw>deficiency</kw> is reversing.',
anim:{startPos:.58,endPos:.08,dir:'heal',rash:3,gut:2,brain:1,extras:['cotton']}}},
dataRow:{happened:'Family ate only cornmeal ‚Äî all land grew cotton',response:'Mother got butterfly rash; children had diarrhea',connection:'No niacin in corn diet; vegetables reversed symptoms'}},

{id:5,name:"The Mill Worker's Wife",emoji:"üßµ",premise:"In 1916, women in textile mill towns get pellagra at ten times the rate of their husbands.",
readings:{
low:{text:'Women in South Carolina mill towns get pellagra at ten times the rate of their husbands. Mill mothers give the best food to those who work and eat only cheap leftovers. The mothers develop cracking skin and diarrhea ‚Äî <kw>symptoms</kw> of <kw>niacin</kw> <kw>deficiency</kw>. Pregnancy makes it worse because the baby uses up the mother\'s <kw>niacin</kw>.',
anim:{startPos:.3,endPos:.55,dir:'worsen',rash:2,gut:1,brain:0,extras:['pregnancy']}},
med:{text:'Something strange is happening in South Carolina\'s textile mill towns. Women are getting pellagra at ten times the rate of their husbands, even though they live in the same house and breathe the same air. Dr. Goldberger finds the answer at the dinner table. Mill mothers give the best food ‚Äî meat, eggs, milk ‚Äî to those who work and eat only cheap cornmeal leftovers. The <kw>nutrient</kw> <kw>niacin</kw> goes to everyone but the mother. Her skin cracks, her digestion fails, and confusion sets in ‚Äî the <kw>symptoms</kw> of <kw>deficiency</kw>. Pregnancy makes it even worse because the growing baby uses up whatever <kw>niacin</kw> her body has stored.',
anim:{startPos:.3,endPos:.6,dir:'worsen',rash:2,gut:2,brain:1,extras:['pregnancy','niacinbar']}},
high:{text:'Women in Spartanburg, South Carolina\'s textile mill towns get pellagra at ten times the rate of their husbands ‚Äî and the <kw>epidemic</kw> reveals a disturbing pattern. The couples live in the same house, drink the same water, and breathe the same air ‚Äî so if pellagra were caused by germs, both should be sick. Dr. Goldberger investigates and finds the answer at the dinner table. Mill mothers give the best food ‚Äî meat, eggs, milk ‚Äî to the family members who earn wages, and survive on cheap cornmeal and molasses themselves. The <kw>nutrient</kw> <kw>niacin</kw> goes to everyone in the family except the mother. Her skin begins to crack, diarrhea sets in, and confusion follows ‚Äî the textbook <kw>symptoms</kw> of <kw>niacin</kw> <kw>deficiency</kw>. Pregnancy makes the crisis worse because the growing baby pulls whatever <kw>niacin</kw> the mother has stored, leaving her body running on empty. Women made up more than two-thirds of all pellagra victims across the South ‚Äî their sacrifice at the dinner table was killing them.',
anim:{startPos:.3,endPos:.65,dir:'worsen',rash:3,gut:2,brain:2,extras:['pregnancy','niacinbar','comparison']}}},
dataRow:{happened:'Mothers gave best food to workers, ate cheap leftovers',response:'Women got pellagra 10x more; pregnancy made it worse',connection:'Niacin went to everyone except the mother'}},

{id:6,name:"The Evidence Ignored",emoji:"üìã",premise:"By 1915, Goldberger proved pellagra is caused by diet ‚Äî but Southern doctors refused to accept it for 25 more years.",
readings:{
low:{text:'Dr. Goldberger proves it: better food cured sick orphans. A corn-only diet made healthy prisoners sick ‚Äî same disease, opposite results. But Southern doctors refuse to accept a <kw>nutrient</kw> <kw>deficiency</kw>. The <kw>epidemic</kw> continues for 25 more years while the proof sits ignored.',
anim:{startPos:.08,endPos:.08,dir:'dual',rash:0,gut:0,brain:0,extras:['ignored']}},
med:{text:'By 1915, Dr. Goldberger has data that should end the pellagra argument forever. In orphanages and asylums, only the people eating corn-only diets get pellagra. Doctors and staff eating better food never get sick, even though they touch patients every day. He runs two experiments back to back: feeding better food to sick orphans cures pellagra; feeding only corn to healthy prisoners causes it. Same disease ‚Äî change the food, change the result. But Southern politicians and doctors refuse to accept a <kw>deficiency</kw> explanation because it means admitting that widespread poverty ‚Äî not germs ‚Äî is killing their own citizens. The <kw>epidemic</kw> rages on for 25 more years while Goldberger\'s biological proof sits ignored.',
anim:{startPos:.08,endPos:.08,dir:'dual',rash:0,gut:0,brain:0,extras:['ignored']}},
high:{text:'Dr. Goldberger proved it twice ‚Äî and they still said he was wrong. In orphanages and asylums across the South, only the people eating corn-only diets develop pellagra. The doctors and staff eating meat, milk, and vegetables never get sick ‚Äî even though they handle patients every day. He runs two back-to-back experiments that should end the debate: feeding better food to orphans with pellagra cures them; feeding only corn to healthy prisoners gives them pellagra. Same disease, switched on and off by food. The missing <kw>nutrient</kw> is <kw>niacin</kw>, and the cause is <kw>deficiency</kw>, not infection. But Southern leaders refuse to accept the results ‚Äî admitting pellagra is a <kw>deficiency</kw> means admitting that poverty is killing their own citizens. The <kw>epidemic</kw> continues for 25 more years, killing thousands, while the proof sits on the shelf.',
anim:{startPos:.08,endPos:.08,dir:'dual',rash:0,gut:0,brain:0,extras:['ignored','deaths']}}},
dataRow:{happened:'Two experiments proved diet causes pellagra',response:'Southern doctors refused to accept results for 25 years',connection:'Politics delayed the cure ‚Äî poverty caused the deficiency'}},

{id:7,name:"The Asylum Patients",emoji:"üè•",premise:"In 1914, hundreds of patients at Georgia's mental hospital have pellagra ‚Äî many were locked up because dementia made families think they were going crazy.",
readings:{
low:{text:'Hundreds of patients in Georgia\'s state mental hospital have pellagra. Many were locked up because the dementia <kw>symptom</kw> made their families think they were going crazy. Dr. Goldberger changes only the food ‚Äî he adds fresh meat, vegetables, and milk to every meal. Patients improve so fast that some are released ‚Äî their "mental illness" was actually a <kw>niacin</kw> <kw>deficiency</kw> all along.',
anim:{startPos:.75,endPos:.08,dir:'heal',rash:2,gut:2,brain:3,extras:['released']}},
med:{text:'Hundreds of patients at Georgia\'s state mental hospital are diagnosed with "insanity." Many of them have the same <kw>symptoms</kw>: cracking skin, diarrhea, and confusion so severe they cannot recognize their own families. These are the <kw>symptoms</kw> of pellagra, not mental illness ‚Äî but nobody realizes it yet. Dr. Goldberger arrives and changes only one thing: he adds fresh meat, vegetables, and milk to every patient\'s meals. He changes nothing else ‚Äî same beds, same building, same staff. Patients improve so dramatically that some are released ‚Äî their "mental illness" was a <kw>niacin</kw> <kw>deficiency</kw> that disappeared the moment they got the missing <kw>nutrient</kw>.',
anim:{startPos:.75,endPos:.08,dir:'heal',rash:3,gut:2,brain:3,extras:['released']}},
high:{text:'The state mental hospital in Milledgeville, Georgia is overflowing with patients. Hundreds share the same <kw>symptoms</kw>: cracking skin, constant diarrhea, and confusion so severe they cannot recognize their families. Their families brought them here believing they had gone insane ‚Äî and the hospital agreed. But Dr. Goldberger suspects something else entirely. Patients eat only corn grits and syrup while staff eat meat and vegetables ‚Äî the same pattern from orphanages. He changes only the food, adding fresh meat, milk, and vegetables to every meal. Patients begin to recover ‚Äî skin heals, digestion returns, and minds clear. Some are released ‚Äî their "madness" was a <kw>niacin</kw> <kw>deficiency</kw>, a missing <kw>nutrient</kw>.',
anim:{startPos:.8,endPos:.08,dir:'heal',rash:3,gut:3,brain:3,extras:['released','niacin']}}},
dataRow:{happened:'Patients ate only corn; diagnosed as "insane"',response:'Better food cured them ‚Äî some were released',connection:'Dementia was niacin deficiency, not mental illness'}},

{id:8,name:"30,000 Sick",emoji:"üíÄ",premise:"In 1912, South Carolina reports 30,000 pellagra cases with a 40% death rate.",
readings:{
low:{text:'South Carolina reports 30,000 pellagra cases in a single year. Nearly 40% die ‚Äî the <kw>epidemic</kw> is the state\'s second leading killer. Across the South, pellagra kills at least 10 people every day. Nobody knows the cause, and <kw>niacin</kw> <kw>deficiency</kw> will not be proven for 25 years.',
anim:{startPos:.08,endPos:.95,dir:'worsen',rash:3,gut:3,brain:3,extras:['massdeath']}},
med:{text:'South Carolina is being destroyed by an <kw>epidemic</kw> nobody understands. The state reports 30,000 cases of pellagra in a single year, and nearly 40% of those patients die ‚Äî making pellagra the second leading cause of death in the entire state. Across the South, at least 10 people die from pellagra every single day, and hospitals overflow. Some hospitals refuse to admit pellagra patients at all because they fear the disease is contagious. Doctors blame everything from spoiled corn to germs to bad air, but nothing they try stops the spread. The real cause ‚Äî <kw>niacin</kw> <kw>deficiency</kw> from a diet lacking this essential <kw>nutrient</kw> ‚Äî will not be proven for 25 more years.',
anim:{startPos:.08,endPos:.95,dir:'worsen',rash:3,gut:3,brain:3,extras:['massdeath']}},
high:{text:'Forty percent of pellagra patients in South Carolina die. The state reports 30,000 cases in a single year ‚Äî the second leading cause of death. Across 15 Southern states, pellagra kills at least 10 people every day. By the time it ends, the total death toll reaches 100,000 Americans. Hospitals overflow with the 4 Ds ‚Äî dermatitis, diarrhea, dementia, death ‚Äî and some refuse patients entirely. Doctors argue over the cause: some blame spoiled corn, others blame germs. Every theory is wrong ‚Äî the real answer is a <kw>deficiency</kw> of the <kw>nutrient</kw> <kw>niacin</kw>. The proof exists by 1915, but politics and pride delay action for decades.',
anim:{startPos:.08,endPos:.95,dir:'worsen',rash:3,gut:3,brain:3,extras:['massdeath','timeline']}}},
dataRow:{happened:'30,000 cases in one year, 40% death rate',response:'Epidemic was 2nd leading cause of death in SC',connection:'Niacin deficiency killed 100,000 ‚Äî proof delayed by politics'}}
];

const KEY_WORDS=[{word:'Niacin',starred:true},{word:'Deficiency',starred:true},{word:'Nutrient',starred:true},{word:'Epidemic',starred:true},{word:'Symptom',starred:false}];
const PREDICT_OPTIONS=["They will get very sick from the food they eat","They will stay healthy because germs cause disease","Their symptoms will get worse over time","Better food will fix the problem"];

// ===================== STATE =====================
let state={currentScenario:null,currentStep:null,readingLevel:'low',completedScenarios:[],predictions:{},score:0,streak:0,totalPredictions:0,correctPredictions:0,dataRows:[],isSpeaking:false,speechResumeInterval:null,animFrameId:null,watchId:0};

// ===================== CANVAS RENDERER =====================
class BodyDiagram {
constructor(canvas){
this.canvas=canvas;
this.ctx=canvas.getContext('2d');
this.W=canvas.width;
this.H=canvas.height;
this.meterPos=0.08;
this.targetMeterPos=0.08;
this.rashIntensity=0;this.targetRash=0;
this.gutIntensity=0;this.targetGut=0;
this.brainIntensity=0;this.targetBrain=0;
this.particles=[];
this.healParticles=[];
this.time=0;
this.statusText='';
this.extras={stamp:false,stampText:'',calendar:'',released:false,niacinIcon:false,
  cotton:0,pregnancy:0,niacinBar:1,comparison:false,
  dualMode:false,dualLeftPos:.35,dualRightPos:.08,dualTargetLeft:.08,dualTargetRight:.55,
  ignored:false,ignoredText:'',
  massdeath:false,caseCount:0,deathCount:0,targetCases:30000,targetDeaths:12000,
  mapGlow:0,silhouettes:0,timelineShow:false,timelineYear:1906};
this.running=true;
}

lerp(a,b,t){return a+(b-a)*Math.min(t,1);}

update(){
this.time+=0.016;
const s=0.025;
this.meterPos=this.lerp(this.meterPos,this.targetMeterPos,s);
this.rashIntensity=this.lerp(this.rashIntensity,this.targetRash,s*0.8);
this.gutIntensity=this.lerp(this.gutIntensity,this.targetGut,s*0.8);
this.brainIntensity=this.lerp(this.brainIntensity,this.targetBrain,s*0.8);
if(this.extras.dualMode){
  this.extras.dualLeftPos=this.lerp(this.extras.dualLeftPos,this.extras.dualTargetLeft,s);
  this.extras.dualRightPos=this.lerp(this.extras.dualRightPos,this.extras.dualTargetRight,s);
}
if(this.extras.massdeath){
  this.extras.caseCount=this.lerp(this.extras.caseCount,this.extras.targetCases,s*0.5);
  this.extras.deathCount=this.lerp(this.extras.deathCount,this.extras.targetDeaths,s*0.3);
}
// spawn particles
if(this.rashIntensity>0.3||this.gutIntensity>0.3||this.brainIntensity>0.3){
  if(Math.random()<0.15&&this.particles.length<80) this.particles.push(this.makeParticle());
}
if(this.targetRash<this.rashIntensity-0.1||this.targetGut<this.gutIntensity-0.1){
  if(Math.random()<0.2&&this.healParticles.length<60) this.healParticles.push(this.makeHealParticle());
}
this.particles=this.particles.filter(p=>{p.life-=0.012;p.y-=p.vy;p.x+=Math.sin(this.time*3+p.phase)*0.3;return p.life>0;});
this.healParticles=this.healParticles.filter(p=>{p.life-=0.015;p.y-=p.vy;p.x+=Math.sin(this.time*4+p.phase)*0.5;return p.life>0;});
}

makeParticle(){
const cx=this.W*0.5, cy=this.H*0.35;
return{x:cx+(Math.random()-0.5)*80,y:cy+(Math.random()-0.5)*120,vy:0.3+Math.random()*0.5,life:1,phase:Math.random()*6.28,
  color:Math.random()>0.5?'rgba(255,60,60,':'rgba(255,150,50,'};
}
makeHealParticle(){
const cx=this.W*0.5, cy=this.H*0.35;
return{x:cx+(Math.random()-0.5)*100,y:cy+60+Math.random()*40,vy:0.5+Math.random()*0.8,life:1,phase:Math.random()*6.28,
  color:'rgba(100,255,150,'};
}

draw(){
const ctx=this.ctx, W=this.W, H=this.H;
ctx.clearRect(0,0,W,H);

// Background gradient
const bg=ctx.createLinearGradient(0,0,0,H);
bg.addColorStop(0,'#0d0d25');bg.addColorStop(1,'#141430');
ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);

// Subtle grid
ctx.strokeStyle='rgba(255,255,255,0.03)';ctx.lineWidth=1;
for(let i=0;i<W;i+=30){ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,H);ctx.stroke();}
for(let i=0;i<H;i+=30){ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(W,i);ctx.stroke();}

if(this.extras.dualMode){this.drawDualMode(ctx,W,H);return;}

// === DRAW BODY ===
const bx=W*0.5, by=H*0.3;

// Body glow (health aura)
const healthColor = this.meterPos<0.2?'rgba(76,175,80,':'rgba(255,80,80,';
const glowR=80+this.meterPos*40;
const auraG=ctx.createRadialGradient(bx,by+20,10,bx,by+20,glowR);
auraG.addColorStop(0,healthColor+(0.15-this.meterPos*0.1).toFixed(2)+')');
auraG.addColorStop(1,'rgba(0,0,0,0)');
ctx.fillStyle=auraG;ctx.fillRect(bx-glowR,by+20-glowR,glowR*2,glowR*2);

// Head
const headR=24;
const skinBase=this.meterPos<0.2?[220,190,170]:[220-this.rashIntensity*60,190-this.rashIntensity*80,170-this.rashIntensity*60];
ctx.fillStyle=`rgb(${skinBase[0]},${skinBase[1]},${skinBase[2]})`;
ctx.beginPath();ctx.arc(bx,by-40,headR,0,Math.PI*2);ctx.fill();
ctx.strokeStyle='rgba(200,160,140,0.5)';ctx.lineWidth=2;ctx.stroke();

// Eyes
ctx.fillStyle='#333';
ctx.beginPath();ctx.arc(bx-8,by-44,3,0,Math.PI*2);ctx.fill();
ctx.beginPath();ctx.arc(bx+8,by-44,3,0,Math.PI*2);ctx.fill();

// Mouth (changes with health)
ctx.strokeStyle='#555';ctx.lineWidth=2;ctx.beginPath();
if(this.meterPos<0.25){ctx.arc(bx,by-30,6,Math.PI*1.2,Math.PI*1.8);}// smile
else if(this.meterPos<0.5){ctx.moveTo(bx-6,by-30);ctx.lineTo(bx+6,by-30);}// neutral
else{ctx.arc(bx,by-25,6,Math.PI*0.2,Math.PI*0.8);}// frown
ctx.stroke();

// Neck
ctx.fillStyle=`rgb(${skinBase[0]},${skinBase[1]},${skinBase[2]})`;
ctx.fillRect(bx-6,by-16,12,16);

// Torso
const torsoG=ctx.createLinearGradient(bx-30,by,bx+30,by+80);
torsoG.addColorStop(0,`rgba(${skinBase[0]},${skinBase[1]},${skinBase[2]},1)`);
torsoG.addColorStop(1,`rgba(${Math.max(0,skinBase[0]-20)},${Math.max(0,skinBase[1]-20)},${Math.max(0,skinBase[2]-20)},1)`);
ctx.fillStyle=torsoG;
ctx.beginPath();ctx.moveTo(bx-30,by);ctx.quadraticCurveTo(bx-35,by+40,bx-25,by+80);
ctx.lineTo(bx+25,by+80);ctx.quadraticCurveTo(bx+35,by+40,bx+30,by);ctx.closePath();ctx.fill();
ctx.strokeStyle='rgba(180,140,120,0.4)';ctx.lineWidth=1.5;ctx.stroke();

// Arms
ctx.lineWidth=12;ctx.lineCap='round';
ctx.strokeStyle=`rgb(${skinBase[0]},${skinBase[1]},${skinBase[2]})`;
const armDroop=this.meterPos>0.5?15:0;
ctx.beginPath();ctx.moveTo(bx-30,by+10);ctx.quadraticCurveTo(bx-55,by+30,bx-50,by+65+armDroop);ctx.stroke();
ctx.beginPath();ctx.moveTo(bx+30,by+10);ctx.quadraticCurveTo(bx+55,by+30,bx+50,by+65+armDroop);ctx.stroke();

// Legs
ctx.lineWidth=14;
ctx.beginPath();ctx.moveTo(bx-12,by+80);ctx.lineTo(bx-18,by+120);ctx.stroke();
ctx.beginPath();ctx.moveTo(bx+12,by+80);ctx.lineTo(bx+18,by+120);ctx.stroke();

// === RASH PATCHES ===
if(this.rashIntensity>0.05){
  const rashAlpha=Math.min(this.rashIntensity/3,1);
  const spots=[
    [bx-40,by+20,8],[bx-48,by+35,6],[bx-35,by+50,7],// left arm
    [bx+40,by+20,8],[bx+48,by+35,6],[bx+35,by+50,7],// right arm
    [bx-15,by-50,5],[bx+15,by-50,5],[bx,by-55,6],// face butterfly
    [bx-10,by+15,5],[bx+10,by+15,5],[bx,by+30,6],// torso
  ];
  const numSpots=Math.ceil(spots.length*Math.min(this.rashIntensity/3,1));
  for(let i=0;i<numSpots;i++){
    const sp=spots[i];
    const pulseR=sp[2]+Math.sin(this.time*3+i)*1.5;
    const rg=ctx.createRadialGradient(sp[0],sp[1],0,sp[0],sp[1],pulseR);
    rg.addColorStop(0,`rgba(220,50,50,${rashAlpha*0.8})`);
    rg.addColorStop(0.5,`rgba(200,80,60,${rashAlpha*0.5})`);
    rg.addColorStop(1,`rgba(180,60,60,0)`);
    ctx.fillStyle=rg;ctx.beginPath();ctx.arc(sp[0],sp[1],pulseR,0,Math.PI*2);ctx.fill();
  }
  // Rash label
  ctx.fillStyle=`rgba(255,100,80,${rashAlpha})`;ctx.font='bold 11px Segoe UI';ctx.textAlign='right';
  ctx.fillText('Skin Rash',bx-55,by+10);
  // Butterfly rash on face for scenario 4
  if(this.rashIntensity>1.5){
    ctx.save();ctx.globalAlpha=rashAlpha*0.6;
    ctx.fillStyle='rgba(200,50,50,0.4)';
    ctx.beginPath();ctx.ellipse(bx-10,by-48,8,5,-.3,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(bx+10,by-48,8,5,.3,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

// === GUT DISTRESS ===
if(this.gutIntensity>0.05){
  const gutAlpha=Math.min(this.gutIntensity/3,1);
  const gutCx=bx, gutCy=by+55;
  // Swirling gut effect
  for(let r=0;r<3;r++){
    const angle=this.time*2+r*2.09;
    const dist=10+r*5;
    const gx=gutCx+Math.cos(angle)*dist;
    const gy=gutCy+Math.sin(angle)*dist*0.6;
    const gg=ctx.createRadialGradient(gx,gy,0,gx,gy,8);
    gg.addColorStop(0,`rgba(255,152,0,${gutAlpha*0.7})`);
    gg.addColorStop(1,`rgba(255,100,0,0)`);
    ctx.fillStyle=gg;ctx.beginPath();ctx.arc(gx,gy,8,0,Math.PI*2);ctx.fill();
  }
  // Distress waves
  ctx.strokeStyle=`rgba(255,152,0,${gutAlpha*0.4})`;ctx.lineWidth=1.5;
  for(let w=0;w<2;w++){
    const waveR=15+w*10+Math.sin(this.time*4)*3;
    ctx.beginPath();ctx.arc(gutCx,gutCy,waveR,0,Math.PI*2);ctx.stroke();
  }
  ctx.fillStyle=`rgba(255,152,0,${gutAlpha})`;ctx.font='bold 11px Segoe UI';ctx.textAlign='left';
  ctx.fillText('Gut Distress',bx+55,by+60);
}

// === BRAIN CONFUSION ===
if(this.brainIntensity>0.05){
  const brainAlpha=Math.min(this.brainIntensity/3,1);
  // Electric sparks around head
  for(let s=0;s<Math.ceil(this.brainIntensity*3);s++){
    const angle=this.time*5+s*1.5;
    const dist=headR+5+Math.sin(this.time*8+s)*8;
    const sx=bx+Math.cos(angle)*dist;
    const sy=(by-40)+Math.sin(angle)*dist*0.7;
    ctx.strokeStyle=`rgba(100,150,255,${brainAlpha*(0.5+Math.sin(this.time*10+s)*0.3)})`;
    ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(sx,sy);
    ctx.lineTo(sx+Math.cos(angle+1)*6,sy+Math.sin(angle+1)*6);
    ctx.lineTo(sx+Math.cos(angle-0.5)*10,sy+Math.sin(angle-0.5)*10);
    ctx.stroke();
  }
  // Confusion swirl
  ctx.strokeStyle=`rgba(150,100,255,${brainAlpha*0.5})`;ctx.lineWidth=1.5;
  ctx.beginPath();
  for(let a=0;a<Math.PI*4;a+=0.1){
    const r=3+a*2;
    const px=bx+Math.cos(a+this.time*2)*r;
    const py=(by-55)+Math.sin(a+this.time*2)*r*0.4;
    a===0?ctx.moveTo(px,py):ctx.lineTo(px,py);
  }
  ctx.stroke();
  ctx.fillStyle=`rgba(130,100,255,${brainAlpha})`;ctx.font='bold 11px Segoe UI';ctx.textAlign='center';
  ctx.fillText('Confusion',bx,by-72);
  // Question marks
  if(this.brainIntensity>1){
    ctx.font=`bold ${12+Math.sin(this.time*3)*3}px Segoe UI`;
    ctx.fillStyle=`rgba(180,150,255,${brainAlpha*0.6})`;
    ctx.fillText('?',bx-20,by-60+Math.sin(this.time*2)*4);
    ctx.fillText('?',bx+22,by-65+Math.cos(this.time*2.5)*4);
  }
}

// === PARTICLES ===
this.particles.forEach(p=>{
  ctx.fillStyle=p.color+(p.life*0.6).toFixed(2)+')';
  ctx.beginPath();ctx.arc(p.x,p.y,2+p.life*2,0,Math.PI*2);ctx.fill();
});
this.healParticles.forEach(p=>{
  ctx.fillStyle=p.color+(p.life*0.8).toFixed(2)+')';
  const sz=3+p.life*3;
  ctx.beginPath();ctx.moveTo(p.x,p.y-sz);ctx.lineTo(p.x+sz*0.3,p.y-sz*0.3);ctx.lineTo(p.x+sz,p.y);
  ctx.lineTo(p.x+sz*0.3,p.y+sz*0.3);ctx.lineTo(p.x,p.y+sz);ctx.lineTo(p.x-sz*0.3,p.y+sz*0.3);
  ctx.lineTo(p.x-sz,p.y);ctx.lineTo(p.x-sz*0.3,p.y-sz*0.3);ctx.closePath();ctx.fill();
});

// === EXTRAS ===
if(this.extras.stamp){
  ctx.save();ctx.translate(W*0.72,H*0.25);ctx.rotate(-0.15);
  ctx.font='bold 16px Segoe UI';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.strokeStyle='rgba(76,200,80,0.9)';ctx.lineWidth=3;
  const tw=ctx.measureText(this.extras.stampText).width;
  ctx.strokeRect(-tw/2-12,-18,tw+24,36);
  ctx.fillStyle='rgba(76,200,80,0.15)';ctx.fillRect(-tw/2-12,-18,tw+24,36);
  ctx.fillStyle='#4caf50';
  ctx.fillText(this.extras.stampText,0,0);
  ctx.restore();
}
if(this.extras.calendar){
  ctx.fillStyle='rgba(0,0,0,0.5)';ctx.font='bold 12px Segoe UI';ctx.textAlign='left';ctx.textBaseline='top';
  const bg2=ctx.createLinearGradient(15,10,150,10);bg2.addColorStop(0,'rgba(30,30,60,0.8)');bg2.addColorStop(1,'rgba(30,30,60,0)');
  ctx.fillStyle=bg2;ctx.fillRect(10,8,140,24);
  ctx.fillStyle='#aaa';ctx.fillText('üìÖ '+this.extras.calendar,15,14);
}
if(this.extras.released){
  ctx.save();ctx.translate(W*0.75,H*0.15);
  const rg2=ctx.createLinearGradient(-50,0,50,0);rg2.addColorStop(0,'#2e7d32');rg2.addColorStop(1,'#4caf50');
  ctx.fillStyle=rg2;
  this.roundRect(ctx,-55,-15,110,30,8);ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 14px Segoe UI';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('‚úÖ Released',0,0);
  ctx.restore();
}
if(this.extras.niacinIcon){
  ctx.save();ctx.translate(W*0.78,H*0.45);
  ctx.fillStyle='rgba(76,175,80,0.2)';this.roundRect(ctx,-30,-12,60,24,6);ctx.fill();
  ctx.fillStyle='#81c784';ctx.font='bold 11px Segoe UI';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('üß¨ Niacin',0,0);ctx.restore();
}
if(this.extras.cotton>0){
  // Cotton plant fading, vegetables appearing
  ctx.save();ctx.translate(W*0.18,H*0.25);
  if(this.extras.cotton<0.5){
    ctx.globalAlpha=1-this.extras.cotton*2;
    ctx.font='36px serif';ctx.fillText('üåø',0,0);
    ctx.font='10px Segoe UI';ctx.fillStyle='#aaa';ctx.fillText('Cotton',0,40);
  } else {
    ctx.globalAlpha=(this.extras.cotton-0.5)*2;
    ctx.font='24px serif';ctx.fillText('ü•¨',-10,0);ctx.fillText('ü•ö',15,0);ctx.fillText('ü•õ',0,28);
    ctx.font='10px Segoe UI';ctx.fillStyle='#81c784';ctx.fillText('Fresh Food',0,52);
  }
  ctx.restore();
}
if(this.extras.pregnancy>0){
  ctx.save();ctx.translate(bx,by+70);ctx.globalAlpha=this.extras.pregnancy;
  ctx.font='22px serif';ctx.textAlign='center';ctx.fillText('ü§∞',0,0);
  ctx.restore();
}
if(this.extras.niacinBar<1){
  ctx.save();ctx.translate(W*0.12,H*0.3);
  ctx.fillStyle='#333';this.roundRect(ctx,-8,0,16,100,8);ctx.fill();
  ctx.strokeStyle='#555';this.roundRect(ctx,-8,0,16,100,8);ctx.stroke();
  const fillH=Math.max(this.extras.niacinBar*100,0);
  if(fillH>4){
    const nbG=ctx.createLinearGradient(0,100-fillH,0,100);
    nbG.addColorStop(0,'#4caf50');nbG.addColorStop(1,'#81c784');
    ctx.fillStyle=nbG;this.roundRect(ctx,-6,100-fillH+2,12,fillH-4,6);ctx.fill();
  }
  ctx.fillStyle='#aaa';ctx.font='9px Segoe UI';ctx.textAlign='center';ctx.fillText('Niacin',0,115);
  ctx.restore();
}
if(this.extras.comparison){
  ctx.save();
  // Husband (healthy)
  ctx.translate(W*0.2,H*0.15);
  ctx.fillStyle='rgba(76,175,80,0.15)';this.roundRect(ctx,-30,-10,60,55,8);ctx.fill();
  ctx.strokeStyle='rgba(76,175,80,0.5)';this.roundRect(ctx,-30,-10,60,55,8);ctx.stroke();
  ctx.font='28px serif';ctx.textAlign='center';ctx.fillText('üßç‚Äç‚ôÇÔ∏è',0,20);
  ctx.fillStyle='#4caf50';ctx.font='bold 9px Segoe UI';ctx.fillText('Husband: Healthy',0,48);
  ctx.restore();
  ctx.save();
  ctx.translate(W*0.8,H*0.15);
  ctx.fillStyle='rgba(244,67,54,0.15)';this.roundRect(ctx,-30,-10,60,55,8);ctx.fill();
  ctx.strokeStyle='rgba(244,67,54,0.5)';this.roundRect(ctx,-30,-10,60,55,8);ctx.stroke();
  ctx.font='28px serif';ctx.textAlign='center';ctx.fillText('üßç‚Äç‚ôÄÔ∏è',0,20);
  ctx.fillStyle='#f44336';ctx.font='bold 9px Segoe UI';ctx.fillText('Wife: Sick',0,48);
  ctx.restore();
}
if(this.extras.massdeath){
  // Case counter
  ctx.save();ctx.translate(W*0.82,H*0.12);
  ctx.fillStyle='rgba(0,0,0,0.5)';this.roundRect(ctx,-50,-8,100,52,6);ctx.fill();
  ctx.fillStyle='#ff6b6b';ctx.font='bold 18px monospace';ctx.textAlign='center';
  ctx.fillText(Math.floor(this.extras.caseCount).toLocaleString(),0,10);
  ctx.fillStyle='#aaa';ctx.font='9px Segoe UI';ctx.fillText('Cases',0,24);
  ctx.fillStyle='#f44336';ctx.font='bold 14px monospace';
  ctx.fillText(Math.floor(this.extras.deathCount).toLocaleString(),0,40);
  ctx.fillStyle='#888';ctx.font='9px Segoe UI';ctx.fillText('Deaths',0,52);
  ctx.restore();
  // Map glow
  if(this.extras.mapGlow>0){
    ctx.save();ctx.globalAlpha=this.extras.mapGlow*0.4;
    ctx.translate(W*0.18,H*0.2);ctx.font='50px serif';ctx.fillText('üó∫Ô∏è',0,0);
    ctx.restore();
  }
  // Falling silhouettes
  if(this.extras.silhouettes>0){
    ctx.save();ctx.globalAlpha=this.extras.silhouettes*0.5;
    const sils=['üßç','üßç','üßç','üßç','üßç'];
    sils.forEach((s,i)=>{
      ctx.font='16px serif';
      ctx.fillText(s,W*0.15+i*22,H*0.75+Math.sin(this.time+i)*3);
    });
    ctx.restore();
  }
  if(this.extras.timelineShow){
    ctx.save();ctx.translate(W*0.1,H*0.88);
    ctx.fillStyle='rgba(0,0,0,0.4)';this.roundRect(ctx,0,-8,W*0.8,18,6);ctx.fill();
    const years=[1906,1912,1915,1937];
    years.forEach((y,i)=>{
      const xp=i/(years.length-1)*W*0.76+10;
      ctx.fillStyle=y<=this.extras.timelineYear?'#ffd54f':'#555';
      ctx.font=y<=this.extras.timelineYear?'bold 10px Segoe UI':'10px Segoe UI';
      ctx.textAlign='center';ctx.fillText(y.toString(),xp,4);
    });
    ctx.restore();
  }
}

// === HEALTH METER ===
this.drawMeter(ctx,W,H);

// === STATUS TEXT ===
if(this.statusText){
  ctx.fillStyle='rgba(0,0,0,0.6)';
  this.roundRect(ctx,W*0.25,H-38,W*0.5,26,8);ctx.fill();
  ctx.fillStyle='#ffd54f';ctx.font='bold 12px Segoe UI';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(this.statusText,W*0.5,H-25);
}
}

drawDualMode(ctx,W,H){
// Draw two body figures side by side with separate meters
const leftX=W*0.25, rightX=W*0.75, figY=H*0.35;
// Left figure (Better Food ‚Üí Cured)
this.drawMiniFigure(ctx,leftX,figY,this.extras.dualLeftPos,'#4caf50','Better Food');
// Right figure (Corn Only ‚Üí Sick)
this.drawMiniFigure(ctx,rightX,figY,this.extras.dualRightPos,'#f44336','Corn Only');
// VS divider
ctx.fillStyle='rgba(255,255,255,0.1)';ctx.fillRect(W*0.5-1,H*0.1,2,H*0.6);
ctx.fillStyle='#ffd54f';ctx.font='bold 20px Segoe UI';ctx.textAlign='center';ctx.textBaseline='middle';
ctx.fillText('VS',W*0.5,H*0.4);

// Arrows
ctx.fillStyle='#4caf50';ctx.font='bold 13px Segoe UI';ctx.textAlign='center';
ctx.fillText('‚Üê CURED',leftX,H*0.73);
ctx.fillStyle='#f44336';ctx.fillText('SICK ‚Üí',rightX,H*0.73);

// Mini meters
this.drawMiniMeter(ctx,leftX-80,H*0.78,160,20,this.extras.dualLeftPos);
this.drawMiniMeter(ctx,rightX-80,H*0.78,160,20,this.extras.dualRightPos);

// Ignored stamp
if(this.extras.ignored){
  ctx.save();ctx.translate(W*0.5,H*0.9);ctx.rotate(-0.08);
  ctx.strokeStyle='#f44336';ctx.lineWidth=3;
  const txt=this.extras.ignoredText||'IGNORED';
  ctx.font='bold 18px Segoe UI';
  const tw=ctx.measureText(txt).width;
  ctx.strokeRect(-tw/2-15,-16,tw+30,32);
  ctx.fillStyle='rgba(244,67,54,0.15)';ctx.fillRect(-tw/2-15,-16,tw+30,32);
  ctx.fillStyle='#f44336';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(txt,0,0);
  ctx.restore();
}
}

drawMiniFigure(ctx,cx,cy,meterPos,color,label){
const skinR=meterPos<0.3?220:220-meterPos*80;
const skinG=meterPos<0.3?190:190-meterPos*100;
const skinB=meterPos<0.3?170:170-meterPos*80;
// Head
ctx.fillStyle=`rgb(${skinR},${skinG},${skinB})`;
ctx.beginPath();ctx.arc(cx,cy-30,16,0,Math.PI*2);ctx.fill();
// Body
ctx.fillRect(cx-15,cy-14,30,45);
// Arms
ctx.lineWidth=8;ctx.lineCap='round';ctx.strokeStyle=`rgb(${skinR},${skinG},${skinB})`;
ctx.beginPath();ctx.moveTo(cx-15,cy);ctx.lineTo(cx-30,cy+25);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx+15,cy);ctx.lineTo(cx+30,cy+25);ctx.stroke();
// Legs
ctx.lineWidth=10;
ctx.beginPath();ctx.moveTo(cx-8,cy+31);ctx.lineTo(cx-12,cy+55);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx+8,cy+31);ctx.lineTo(cx+12,cy+55);ctx.stroke();
// Rash if sick
if(meterPos>0.3){
  const a=Math.min((meterPos-0.3)/0.5,1);
  ctx.fillStyle=`rgba(220,50,50,${a*0.6})`;
  [[cx-25,cy+5,5],[cx+25,cy+5,5],[cx-8,cy-38,4],[cx+8,cy-38,4]].forEach(s=>{
    ctx.beginPath();ctx.arc(s[0],s[1],s[2],0,Math.PI*2);ctx.fill();
  });
}
// Label
ctx.fillStyle=color;ctx.font='bold 12px Segoe UI';ctx.textAlign='center';
ctx.fillText(label,cx,cy-55);
}

drawMiniMeter(ctx,x,y,w,h,pos){
const zones=[{c:'#4caf50',w:.2},{c:'#fdd835',w:.2},{c:'#ff9800',w:.2},{c:'#f44336',w:.2},{c:'#8b0000',w:.2}];
ctx.save();
this.roundRect(ctx,x,y,w,h,h/2);ctx.clip();
let cx=x;
zones.forEach(z=>{
  ctx.fillStyle=z.c;ctx.fillRect(cx,y,w*z.w,h);cx+=w*z.w;
});
ctx.restore();
ctx.strokeStyle='rgba(255,255,255,0.3)';this.roundRect(ctx,x,y,w,h,h/2);ctx.stroke();
// Indicator
const ix=x+pos*w;
ctx.fillStyle='#fff';ctx.shadowColor='#fff';ctx.shadowBlur=8;
ctx.beginPath();ctx.arc(ix,y+h/2,h/2+2,0,Math.PI*2);ctx.fill();
ctx.shadowBlur=0;
}

drawMeter(ctx,W,H){
const mY=H-32, mH=22, mX=W*0.08, mW=W*0.84;
const zones=[
  {label:'Healthy',color:'#4caf50',w:.2},
  {label:'Dermatitis',color:'#fdd835',w:.2},
  {label:'Diarrhea',color:'#ff9800',w:.2},
  {label:'Dementia',color:'#f44336',w:.2},
  {label:'Death',color:'#8b0000',w:.2}
];
// Draw rounded meter bg
ctx.save();
this.roundRect(ctx,mX,mY,mW,mH,mH/2);ctx.clip();
let cx=mX;
zones.forEach(z=>{
  const zw=mW*z.w;
  ctx.fillStyle=z.color;ctx.fillRect(cx,mY,zw,mH);
  ctx.fillStyle='rgba(255,255,255,0.7)';ctx.font='bold 8px Segoe UI';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(z.label,cx+zw/2,mY+mH/2);
  cx+=zw;
});
ctx.restore();
ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=1;
this.roundRect(ctx,mX,mY,mW,mH,mH/2);ctx.stroke();
// Indicator
const indX=mX+this.meterPos*mW;
ctx.fillStyle='#fff';ctx.shadowColor='rgba(255,255,255,0.8)';ctx.shadowBlur=12;
this.roundRect(ctx,indX-5,mY-4,10,mH+8,5);ctx.fill();
ctx.shadowBlur=0;
// OK zone bracket
ctx.strokeStyle='rgba(76,175,80,0.6)';ctx.lineWidth=2;
ctx.beginPath();ctx.moveTo(mX+2,mY-6);ctx.lineTo(mX+mW*0.2-2,mY-6);ctx.stroke();
ctx.fillStyle='rgba(76,175,80,0.8)';ctx.font='bold 9px Segoe UI';ctx.textAlign='center';
ctx.fillText('OK',mX+mW*0.1,mY-10);
}

roundRect(ctx,x,y,w,h,r){
ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

loop(){
if(!this.running)return;
this.update();this.draw();
state.animFrameId=requestAnimationFrame(()=>this.loop());
}
stop(){this.running=false;}
}

let bodyDiagram=null;

// ===================== INIT =====================
function init(){renderScenarioList();renderKeyWords();showWelcome();updateHUD();}

function renderScenarioList(){
const c=document.getElementById('scenarioList');c.innerHTML='';
SCENARIOS.forEach(sc=>{
  const d=document.createElement('div');
  d.className='sc-card'+(state.completedScenarios.includes(sc.id)?' done':'')+(state.currentScenario===sc.id?' active':'');
  d.innerHTML=`<span class="sc-emoji">${sc.emoji}</span><span class="sc-name">${sc.name}</span><span class="sc-check">‚úì</span>`;
  d.onclick=()=>selectScenario(sc.id);c.appendChild(d);
});
}

function renderKeyWords(hl){
const c=document.getElementById('kwList');c.innerHTML='';
const hla=(hl||[]).map(w=>w.toLowerCase());
KEY_WORDS.forEach(kw=>{
  const d=document.createElement('div');
  d.className='kw-item'+(hla.includes(kw.word.toLowerCase())?' highlighted':'');
  d.textContent=(kw.starred?'‚òÖ ':'')+kw.word;c.appendChild(d);
});
}

function selectScenario(id){
if(state.currentStep==='watch')return;
stopSpeech();stopAnimation();state.watchId++;
state.currentScenario=id;state.currentStep='predict';
renderScenarioList();updateStepTabs();showPredict();
const sc=SCENARIOS.find(s=>s.id===id);const r=sc.readings[state.readingLevel];
const fw=KEY_WORDS.filter(kw=>r.text.toLowerCase().includes(kw.word.toLowerCase())).map(kw=>kw.word);
renderKeyWords(fw);
}

function setLevel(lv){
state.readingLevel=lv;
document.querySelectorAll('.rl-tab').forEach(t=>t.classList.toggle('active',t.dataset.level===lv));
if(state.currentStep==='read'&&state.currentScenario)showRead();
}

function updateStepTabs(){
const tabs=document.querySelectorAll('.step-tab');
const steps=['predict','read','watch','record'];
const ci=steps.indexOf(state.currentStep);
tabs.forEach((t,i)=>{t.classList.remove('active','completed');if(i===ci)t.classList.add('active');else if(i<ci)t.classList.add('completed');});
}

function showWelcome(){
state.currentStep=null;
document.querySelectorAll('.step-tab').forEach(t=>t.classList.remove('active','completed'));
document.getElementById('centerContent').innerHTML=`
<div class="welcome-screen">
<h2>üîç Disease Detective</h2>
<div class="hook">In the early 1900s, a mystery disease killed 100,000 Americans ‚Äî and the answer was hiding in their breakfast.</div>
<p>Investigate 8 real stories of pellagra to discover what caused the disease and why doctors missed it for decades.</p>
<div class="mission-badge">üéØ Crack 5 real cases ‚Äî solve all 8 for full honors</div>
</div>`;
document.getElementById('actionArea').innerHTML=`<span style="color:#888;font-size:13px;">‚Üê Pick a story from the left sidebar to begin</span>`;
}

function showPredict(){
const sc=SCENARIOS.find(s=>s.id===state.currentScenario);
document.getElementById('centerContent').innerHTML=`
<div class="predict-card">
<h3>üîÆ What do you predict?</h3>
<p>You picked: <strong>${sc.emoji} ${sc.name}</strong></p>
<p style="font-size:14px;color:#aaa;margin-top:8px;">${sc.premise}</p>
<div class="predict-options">${PREDICT_OPTIONS.map((o,i)=>`<div class="predict-btn" onclick="makePrediction(${i},this)">${o}</div>`).join('')}</div>
</div>`;
document.getElementById('actionArea').innerHTML=`<button class="action-btn primary" id="predictNext" onclick="goToRead()" disabled>Continue to Read ‚Üí</button>`;
}

function makePrediction(idx,el){
state.predictions[state.currentScenario]=idx;
document.querySelectorAll('.predict-btn').forEach((b,i)=>b.classList.toggle('selected',i===idx));
document.getElementById('predictNext').disabled=false;
}

function goToRead(){state.currentStep='read';updateStepTabs();showRead();}

function showRead(){
const sc=SCENARIOS.find(s=>s.id===state.currentScenario);
const r=sc.readings[state.readingLevel];
let pt=r.text.replace(/<kw>(.*?)<\/kw>/g,'<span class="kw">$1</span>');
const sents=pt.split(/(?<=\.)\s+/);
const wt=sents.map((s,i)=>`<span class="sentence" data-si="${i}">${s}</span>`).join(' ');
const fw=KEY_WORDS.filter(kw=>r.text.toLowerCase().includes(kw.word.toLowerCase())).map(kw=>kw.word);
renderKeyWords(fw);
document.getElementById('centerContent').innerHTML=`
<div class="read-card">
<h3>üìñ ${sc.emoji} ${sc.name}</h3>
<div class="passage-text" id="passageText">${wt}</div>
<button class="read-aloud-btn" id="readAloudBtn" onclick="toggleReadAloud()">üîä Read Aloud</button>
</div>`;
document.getElementById('actionArea').innerHTML=`<button class="action-btn primary" onclick="goToWatch()">Continue to Watch ‚Üí</button>`;
}

// ===================== SPEECH =====================
function toggleReadAloud(){
try{
if(state.isSpeaking){stopSpeech();return;}
if(!('speechSynthesis' in window)){document.getElementById('readAloudBtn').textContent='üìù Text Only';return;}
const sc=SCENARIOS.find(s=>s.id===state.currentScenario);
const r=sc.readings[state.readingLevel];
const plain=r.text.replace(/<kw>(.*?)<\/kw>/g,'$1');
const u=new SpeechSynthesisUtterance(plain);u.rate=0.9;
const sents=document.querySelectorAll('.sentence');
u.onboundary=function(e){
  if(e.charIndex>0){const spoken=plain.substring(0,e.charIndex);const dots=(spoken.match(/\./g)||[]).length;
  sents.forEach((s,i)=>s.classList.toggle('sentence-hl',i===dots));}
};
u.onend=function(){stopSpeech();sents.forEach(s=>s.classList.remove('sentence-hl'));};
u.onerror=function(){stopSpeech();};
window.speechSynthesis.cancel();window.speechSynthesis.speak(u);state.isSpeaking=true;
state.speechResumeInterval=setInterval(()=>{if(window.speechSynthesis.speaking)window.speechSynthesis.resume();},10000);
const btn=document.getElementById('readAloudBtn');if(btn){btn.classList.add('speaking');btn.textContent='‚èπ Stop Reading';}
}catch(e){const btn=document.getElementById('readAloudBtn');if(btn)btn.textContent='üìù Text Only';}
}

function stopSpeech(){
try{if(window.speechSynthesis)window.speechSynthesis.cancel();}catch(e){}
state.isSpeaking=false;
if(state.speechResumeInterval){clearInterval(state.speechResumeInterval);state.speechResumeInterval=null;}
const btn=document.getElementById('readAloudBtn');if(btn){btn.classList.remove('speaking');btn.textContent='üîä Read Aloud';}
}

function stopAnimation(){
if(bodyDiagram){bodyDiagram.stop();bodyDiagram=null;}
if(state.animFrameId){cancelAnimationFrame(state.animFrameId);state.animFrameId=null;}
}

// ===================== WATCH =====================
function goToWatch(){
stopSpeech();state.currentStep='watch';updateStepTabs();showWatch();
}

function showWatch(){
const sc=SCENARIOS.find(s=>s.id===state.currentScenario);
if(!sc)return;
const a=sc.readings[state.readingLevel].anim;
stopAnimation();
state.watchId++;
const myWatchId=state.watchId;
const myScenarioId=state.currentScenario;

document.getElementById('centerContent').innerHTML=`
<div class="watch-area">
<h3>üëÅÔ∏è Watch: ${sc.emoji} ${sc.name}</h3>
<div class="watch-canvas-wrap"><canvas id="watchCanvas" width="700" height="380"></canvas></div>
<div class="watch-status" id="watchStatus"></div>
</div>`;
document.getElementById('actionArea').innerHTML='';

const canvas=document.getElementById('watchCanvas');
if(!canvas)return;
bodyDiagram=new BodyDiagram(canvas);

if(a.dir==='dual'){
  bodyDiagram.extras.dualMode=true;
  bodyDiagram.extras.dualLeftPos=0.35;bodyDiagram.extras.dualRightPos=0.08;
  bodyDiagram.extras.dualTargetLeft=0.08;bodyDiagram.extras.dualTargetRight=0.55;
} else {
  bodyDiagram.meterPos=a.startPos;bodyDiagram.targetMeterPos=a.startPos;
}

bodyDiagram.loop();

// Animate through phases
const totalDur = a.dir==='stay'? 5000 : 6000;
const phases = a.dir==='dual'?4: a.dir==='stay'?3:4;

for(let p=0;p<phases;p++){
  const delay=p*(totalDur/phases);
  setTimeout(()=>{
    try{
      if(state.watchId!==myWatchId||!bodyDiagram)return;
      const progress=(p+1)/phases;
      const statusEl=document.getElementById('watchStatus');

      if(a.dir==='heal'){
        bodyDiagram.targetMeterPos=a.startPos+(a.endPos-a.startPos)*progress;
        bodyDiagram.targetRash=a.rash*(1-progress);
        bodyDiagram.targetGut=a.gut*(1-progress);
        bodyDiagram.targetBrain=a.brain*(1-progress);
        if(p===0){
          bodyDiagram.targetRash=a.rash;bodyDiagram.targetGut=a.gut;bodyDiagram.targetBrain=a.brain;
          if(statusEl)statusEl.textContent='Symptoms present...';
        }else if(p===1){
          if(statusEl)statusEl.textContent='Better food introduced...';
          if(a.extras.includes('cotton'))bodyDiagram.extras.cotton=0.3;
        }else if(p===2){
          if(statusEl)statusEl.textContent='Symptoms fading...';
          if(a.extras.includes('cotton'))bodyDiagram.extras.cotton=0.7;
        }else{
          if(statusEl){statusEl.textContent='Recovery!';statusEl.style.color='#4caf50';}
          if(a.extras.includes('cotton'))bodyDiagram.extras.cotton=1;
          if(a.extras.includes('released'))bodyDiagram.extras.released=true;
          if(a.extras.includes('niacin'))bodyDiagram.extras.niacinIcon=true;
        }
      } else if(a.dir==='worsen'){
        bodyDiagram.targetMeterPos=a.startPos+(a.endPos-a.startPos)*progress;
        bodyDiagram.targetRash=a.rash*progress;
        bodyDiagram.targetGut=a.gut*progress;
        bodyDiagram.targetBrain=a.brain*progress;
        if(p===0&&statusEl)statusEl.textContent='Starting healthy...';
        else if(p===1){if(statusEl)statusEl.textContent='Skin rashes appearing...';}
        else if(p===2){
          if(statusEl)statusEl.textContent='Gut distress + confusion...';
          if(a.extras.includes('pregnancy')){bodyDiagram.extras.pregnancy=1;}
          if(a.extras.includes('niacinbar')){bodyDiagram.extras.niacinBar=0.4;}
          if(a.extras.includes('timeline'))bodyDiagram.extras.timelineShow=true;
        }else{
          if(statusEl){statusEl.textContent='Severe symptoms';statusEl.style.color='#f44336';}
          if(a.extras.includes('niacinbar'))bodyDiagram.extras.niacinBar=0.1;
          if(a.extras.includes('comparison'))bodyDiagram.extras.comparison=true;
          if(a.extras.includes('massdeath')){
            bodyDiagram.extras.massdeath=true;
            bodyDiagram.extras.targetCases=state.readingLevel==='high'?100000:30000;
            bodyDiagram.extras.targetDeaths=state.readingLevel==='high'?100000:12000;
            bodyDiagram.extras.mapGlow=1;bodyDiagram.extras.silhouettes=1;
            if(a.extras.includes('timeline')){bodyDiagram.extras.timelineShow=true;bodyDiagram.extras.timelineYear=1937;}
          }
        }
      } else if(a.dir==='stay'){
        if(p===0&&statusEl)statusEl.textContent='Exposed to pellagra material...';
        if(p===1){
          if(statusEl)statusEl.textContent='Weeks pass ‚Äî watching for symptoms...';
          if(a.extras.includes('calendar'))bodyDiagram.extras.calendar='Week 4';
        }
        if(p===2){
          if(statusEl){statusEl.textContent='NO symptoms ‚Äî NOT CONTAGIOUS';statusEl.style.color='#4caf50';}
          bodyDiagram.extras.stamp=true;bodyDiagram.extras.stampText='NOT CONTAGIOUS';
          if(a.extras.includes('calendar'))bodyDiagram.extras.calendar='Week 8 ‚Äî Still Healthy';
        }
      } else if(a.dir==='dual'){
        if(p===0&&statusEl)statusEl.textContent='Two experiments side by side...';
        if(p===1&&statusEl)statusEl.textContent='Better food ‚Üí healing...  Corn only ‚Üí sickening...';
        if(p===2&&statusEl)statusEl.textContent='Opposite results ‚Äî same disease, different food';
        if(p===3){
          bodyDiagram.extras.ignored=true;
          bodyDiagram.extras.ignoredText=a.extras.includes('deaths')?'IGNORED ‚Äî 25 More Years':'IGNORED';
          if(statusEl){statusEl.textContent='Proof ignored for 25 years';statusEl.style.color='#f44336';}
        }
      }

      if(a.extras.includes('massdeath')&&a.dir==='worsen'&&p>=1){
        bodyDiagram.extras.massdeath=true;
        const mp=p/phases;
        bodyDiagram.extras.targetCases=(state.readingLevel==='high'?100000:30000)*mp;
        bodyDiagram.extras.targetDeaths=(state.readingLevel==='high'?100000:12000)*Math.max(0,mp-0.2);
        if(p>=2)bodyDiagram.extras.mapGlow=1;
        if(p>=2)bodyDiagram.extras.silhouettes=1;
        if(a.extras.includes('timeline')&&p>=2){bodyDiagram.extras.timelineShow=true;bodyDiagram.extras.timelineYear=[1906,1912,1915,1937][Math.min(p,3)];}
      }

    }catch(e){console.log('Anim error:',e);}
  },delay);
}

// Auto advance with stale guard
setTimeout(()=>{if(state.watchId===myWatchId&&state.currentScenario===myScenarioId)goToRecord();},totalDur+2000);
}

// ===================== RECORD =====================
function goToRecord(){
stopAnimation();
state.currentStep='record';updateStepTabs();
const sc=SCENARIOS.find(s=>s.id===state.currentScenario);
if(!sc){showWelcome();return;}
if(!state.completedScenarios.includes(sc.id)){
  state.completedScenarios.push(sc.id);state.score+=100;state.streak++;
  state.totalPredictions++;state.correctPredictions++;
  state.dataRows.push({scenario:sc.name,happened:sc.dataRow.happened,response:sc.dataRow.response,connection:sc.dataRow.connection});
  addDataRow(sc);updateHUD();renderScenarioList();
}
const comp=state.completedScenarios.length;
const cc=document.getElementById('centerContent');
if(comp===8){
  cc.innerHTML=`<div class="completion-screen"><div class="trophy">üèÜ</div><h2>Extra Credit Complete!</h2><p>You investigated all 8 real pellagra stories.</p><p>Full honors earned ‚Äî you cracked every case!</p><p style="margin-top:12px;color:#ffd54f;">Copy your data table using the üìã button ‚Üí</p></div>`;
  document.getElementById('actionArea').innerHTML='';
}else if(comp===5){
  cc.innerHTML=`<div class="record-card"><div class="record-badge">üéâ</div><h3>Required Complete!</h3><p>${sc.emoji} ${sc.name} ‚Äî recorded!</p><div class="ec-banner">Continue for Extra Credit? ${8-comp} stories left!</div></div>`;
  document.getElementById('actionArea').innerHTML=`<span style="color:#81c784;font-size:13px;">‚Üê Pick another story for extra credit!</span>`;
}else{
  cc.innerHTML=`<div class="record-card"><div class="record-badge">‚úÖ</div><h3>Data Recorded!</h3><p>${sc.emoji} ${sc.name} ‚Äî case filed!</p><p style="color:#aaa;font-size:14px;margin-top:8px;">${5-comp} more to go!</p></div>`;
  document.getElementById('actionArea').innerHTML=`<span style="color:#ffd54f;font-size:13px;">‚Üê Pick your next story!</span>`;
}
}

// ===================== HUD =====================
function updateHUD(){
const c=state.completedScenarios.length;
document.getElementById('hudScore').textContent=state.score;
document.getElementById('hudStreak').textContent=state.streak;
document.getElementById('hudCompleted').textContent=c+'/8';
document.getElementById('hudAccuracy').textContent=state.totalPredictions>0?Math.round(state.correctPredictions/state.totalPredictions*100)+'%':'--';
document.getElementById('progressFill').style.width=Math.min(c/5*100,100)+'%';
document.getElementById('progressMsg').textContent=c===0?'Pick your first story!':c<5?`${5-c} more to go!`:c<8?`‚úÖ Required done! ${8-c} for extra credit`:'üèÜ All 8 complete!';
document.getElementById('pickCount').textContent=c<5?`Pick ${5-c} more you like!`:c<8?`${8-c} left for extra credit!`:'All 8 investigated!';
}

function addDataRow(sc){
const tr=document.createElement('tr');tr.className='new-row';
tr.innerHTML=`<td><strong>${sc.name}</strong></td><td>${sc.dataRow.happened}</td><td>${sc.dataRow.response}</td><td>${sc.dataRow.connection}</td>`;
document.getElementById('dataBody').appendChild(tr);
}

function copyTable(){
try{
let t='Scenario\tWhat Happened?\tPerson/Situation Response\tConnection to Pellagra?\n';
state.dataRows.forEach(r=>t+=`${r.scenario}\t${r.happened}\t${r.response}\t${r.connection}\n`);
navigator.clipboard.writeText(t).then(()=>{
  const b=document.getElementById('copyBtn');b.textContent='‚úÖ Copied!';b.classList.add('copied');
  setTimeout(()=>{b.textContent='üìã Copy Table';b.classList.remove('copied');},2000);
}).catch(()=>{
  const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
  const b=document.getElementById('copyBtn');b.textContent='‚úÖ Copied!';b.classList.add('copied');
  setTimeout(()=>{b.textContent='üìã Copy Table';b.classList.remove('copied');},2000);
});
}catch(e){alert('Copy failed ‚Äî please copy manually.');}
}

function resetSim(){
stopSpeech();stopAnimation();
state.watchId++;
state={currentScenario:null,currentStep:null,readingLevel:state.readingLevel,completedScenarios:[],predictions:{},score:0,streak:0,totalPredictions:0,correctPredictions:0,dataRows:[],isSpeaking:false,speechResumeInterval:null,animFrameId:null,watchId:state.watchId};
document.getElementById('dataBody').innerHTML='';
renderScenarioList();renderKeyWords();updateHUD();showWelcome();
}
function newRun(){resetSim();}

try{init();}catch(e){document.body.innerHTML='<h1 style="color:red;padding:20px;">Error: '+e.message+'</h1>';}
</script>
</body>
</html>
