<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation ‚Äî Mutations: When the Code Changes</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',system-ui,sans-serif;background:linear-gradient(135deg,#0a0a2e 0%,#1a1a4e 50%,#0d0d3a 100%);color:#fff;overflow:hidden;height:100vh;}

/* TOP BAR */
.top-bar{background:linear-gradient(90deg,#4CAF50,#2196F3,#9C27B0);padding:6px 16px;text-align:center;font-size:16px;font-weight:700;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,.4);}

/* STEP GUIDE - the hero accessibility feature */
.step-guide{background:linear-gradient(135deg,#1a237e,#283593);border:3px solid #ffd54f;border-radius:10px;padding:10px 12px;margin:6px 0;text-align:center;position:relative;min-height:60px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.step-guide.glow{animation:guideGlow 1.5s infinite;border-color:#ffd54f;}
@keyframes guideGlow{0%,100%{box-shadow:0 0 10px rgba(255,213,79,.3);border-color:#ffd54f}50%{box-shadow:0 0 25px rgba(255,213,79,.7);border-color:#fff176}}
.step-number{font-size:11px;color:#ffd54f;text-transform:uppercase;letter-spacing:2px;font-weight:800;}
.step-instruction{font-size:15px;color:#fff;font-weight:700;margin-top:2px;line-height:1.3;}
.step-dots{display:flex;gap:6px;margin-top:6px;justify-content:center;}
.step-dot{width:10px;height:10px;border-radius:50%;background:#37474f;border:2px solid #546e7a;transition:all .3s;}
.step-dot.active{background:#ffd54f;border-color:#ffd54f;box-shadow:0 0 8px rgba(255,213,79,.5);}
.step-dot.done{background:#69f0ae;border-color:#69f0ae;}

/* MAIN LAYOUT */
.main{display:flex;height:calc(100vh - 36px);gap:0;}

/* LEFT PANEL */
.left-panel{width:270px;min-width:270px;background:rgba(15,15,50,.95);border-right:2px solid rgba(100,100,255,.2);display:flex;flex-direction:column;padding:6px 8px;overflow-y:auto;}

.mission-card{background:linear-gradient(135deg,#1a237e,#283593);border:2px solid #5c6bc0;border-radius:10px;padding:6px;margin-bottom:4px;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px;}
.mission-round{font-size:18px;font-weight:800;color:#fff;}
.mission-unlock{font-size:12px;color:#69f0ae;font-weight:600;}

.control-section{margin-bottom:4px;transition:all .3s;border-radius:8px;padding:2px;}
.control-section.highlight{background:rgba(255,213,79,.08);border:2px solid rgba(255,213,79,.4);animation:sectionPulse 1.5s infinite;}
.control-section:not(.highlight){border:2px solid transparent;}
@keyframes sectionPulse{0%,100%{border-color:rgba(255,213,79,.3);box-shadow:0 0 8px rgba(255,213,79,.1)}50%{border-color:rgba(255,213,79,.7);box-shadow:0 0 18px rgba(255,213,79,.3)}}
.control-title{font-size:10px;color:#b0bec5;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px;display:flex;align-items:center;gap:4px;}
.control-title .unlock-badge{background:#ffd54f;color:#1a237e;font-size:8px;font-weight:800;padding:1px 6px;border-radius:10px;text-transform:uppercase;}
.control-group{background:rgba(30,30,80,.6);border-radius:8px;padding:3px;border:1px solid rgba(100,100,255,.15);}
.control-btn{display:block;width:100%;padding:7px 8px;margin:2px 0;border:2px solid rgba(100,100,255,.3);border-radius:6px;background:rgba(40,40,100,.5);color:#ccc;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;text-align:left;position:relative;}
.control-btn:hover:not(.locked):not(.selected){background:rgba(60,60,140,.6);border-color:rgba(100,100,255,.5);color:#fff;}
.control-btn.selected{background:linear-gradient(135deg,#1565c0,#1976d2);border-color:#42a5f5;color:#fff;box-shadow:0 0 12px rgba(33,150,243,.4);}
.control-btn.locked{opacity:.35;cursor:not-allowed;}
.control-btn.locked::after{content:'üîí';position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:12px;}

.predict-section{margin-top:2px;transition:all .3s;border-radius:8px;padding:2px;}
.predict-section.highlight{background:rgba(255,213,79,.08);border:2px solid rgba(255,213,79,.4);animation:sectionPulse 1.5s infinite;}
.predict-section:not(.highlight){border:2px solid transparent;}
.predict-btn{display:block;width:100%;padding:8px;margin:2px 0;border:2px solid;border-radius:6px;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;text-align:center;}
.predict-btn.thrive{border-color:#4caf50;background:rgba(76,175,80,.15);color:#69f0ae;}
.predict-btn.survive{border-color:#ff9800;background:rgba(255,152,0,.15);color:#ffb74d;}
.predict-btn.struggle{border-color:#f44336;background:rgba(244,67,54,.15);color:#ef9a9a;}
.predict-btn:hover{transform:scale(1.02);}
.predict-btn.chosen{transform:scale(1.03);box-shadow:0 0 12px rgba(255,255,255,.2);}
.predict-btn.chosen.thrive{background:rgba(76,175,80,.5);}
.predict-btn.chosen.survive{background:rgba(255,152,0,.5);}
.predict-btn.chosen.struggle{background:rgba(244,67,54,.5);}

.action-btns{margin-top:auto;padding-top:4px;}
.mutate-btn{width:100%;padding:12px;border:none;border-radius:8px;font-size:16px;font-weight:800;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:2px;}
.mutate-btn.ready{background:linear-gradient(135deg,#e91e63,#f44336);color:#fff;box-shadow:0 4px 20px rgba(233,30,99,.4);animation:mutateGlow 1.5s infinite;}
.mutate-btn.disabled{background:#37474f;color:#78909c;cursor:not-allowed;box-shadow:none;animation:none;}
@keyframes mutateGlow{0%,100%{box-shadow:0 4px 20px rgba(233,30,99,.4)}50%{box-shadow:0 4px 35px rgba(233,30,99,.7)}}
.reset-row{display:flex;gap:6px;margin-top:6px;}
.reset-btn,.newrun-btn{flex:1;padding:7px;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;}
.reset-btn{background:#c62828;color:#fff;}
.newrun-btn{background:#1565c0;color:#fff;}

/* CENTER ARENA */
.center-panel{flex:1;display:flex;flex-direction:column;padding:6px;overflow:hidden;}
.arena{flex:1;background:rgba(10,10,40,.8);border-radius:14px;border:2px solid rgba(100,100,255,.2);position:relative;overflow:hidden;display:flex;flex-direction:column;}

/* Gene Sequence Zone */
.gene-zone{height:20%;background:linear-gradient(180deg,rgba(20,20,60,.9),rgba(15,15,50,.9));border-bottom:1px solid rgba(100,100,255,.15);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;padding:4px;}
.zone-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;margin-bottom:3px;}
.gene-label{color:#90caf9;}
.gene-strand{display:flex;gap:3px;justify-content:center;flex-wrap:nowrap;}
.gene-letter{width:36px;height:40px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;border-radius:6px;transition:all .4s;position:relative;}
.gene-letter.A{background:linear-gradient(135deg,#e53935,#c62828);color:#fff;}
.gene-letter.T{background:linear-gradient(135deg,#1e88e5,#1565c0);color:#fff;}
.gene-letter.G{background:linear-gradient(135deg,#43a047,#2e7d32);color:#fff;}
.gene-letter.C{background:linear-gradient(135deg,#f9a825,#f57f17);color:#fff;}
.gene-letter.mutated{animation:mutateLetter .5s;box-shadow:0 0 15px rgba(255,255,255,.6);}
@keyframes mutateLetter{0%{transform:scale(1)}30%{transform:scale(1.4) rotate(10deg)}60%{transform:scale(.8) rotate(-5deg)}100%{transform:scale(1) rotate(0)}}
.gene-letter.shifting{animation:shiftLetter .6s;}
@keyframes shiftLetter{0%{transform:translateX(0);opacity:1}30%{transform:translateX(10px);opacity:.5}100%{transform:translateX(0);opacity:1}}
/* Mutation site marker */
.mut-site-marker{position:absolute;bottom:-2px;width:100%;height:4px;border-radius:2px;background:#e91e63;animation:markerPulse 1s infinite;}
@keyframes markerPulse{0%,100%{opacity:.6}50%{opacity:1}}

/* Protein Zone */
.protein-zone{height:30%;background:linear-gradient(180deg,rgba(15,15,50,.9),rgba(20,20,70,.9));border-bottom:1px solid rgba(100,100,255,.15);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;}
.protein-label{color:#ce93d8;}
.protein-machine{position:relative;width:85%;height:85%;display:flex;align-items:center;justify-content:center;}
.protein-shape{position:relative;transition:all .8s;}
/* Arrow between zones */
.zone-arrow{position:absolute;left:50%;transform:translateX(-50%);font-size:24px;z-index:5;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));}
.gene-zone .zone-arrow{bottom:-14px;}
.protein-zone .zone-arrow{bottom:-14px;}

/* Environment Zone */
.env-zone{height:50%;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;}
.env-bg{position:absolute;inset:0;transition:all 1s;}
.env-bg.normal{background:linear-gradient(180deg,#81c784 0%,#4caf50 40%,#388e3c 100%);}
.env-bg.malaria{background:linear-gradient(180deg,#5d4037 0%,#4e342e 40%,#3e2723 80%,#1b0000 100%);}
.env-bg.altitude{background:linear-gradient(180deg,#90caf9 0%,#64b5f6 30%,#bbdefb 60%,#e3f2fd 100%);}
.env-bg.arctic{background:linear-gradient(180deg,#b3e5fc 0%,#e1f5fe 40%,#ffffff 80%,#e0e0e0 100%);}
.env-name-badge{position:absolute;top:8px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:4px 14px;border-radius:20px;font-size:13px;font-weight:700;z-index:10;letter-spacing:1px;border:2px solid rgba(255,255,255,.2);}

/* Organism */
.organism{position:relative;z-index:10;transition:all .8s;display:flex;flex-direction:column;align-items:center;}
.organism-body{font-size:80px;transition:all .8s;filter:drop-shadow(0 4px 8px rgba(0,0,0,.3));}
.organism.thriving .organism-body{filter:drop-shadow(0 0 25px rgba(76,175,80,.7));transform:scale(1.3);}
.organism.struggling .organism-body{filter:drop-shadow(0 0 25px rgba(244,67,54,.7));transform:scale(.6);animation:strugglePulse 1s infinite;}
.organism.neutral .organism-body{filter:drop-shadow(0 0 15px rgba(255,193,7,.5));}
@keyframes strugglePulse{0%,100%{opacity:1}50%{opacity:.5}}
.organism-state-label{font-size:16px;font-weight:800;padding:6px 16px;border-radius:20px;margin-top:6px;text-shadow:0 1px 3px rgba(0,0,0,.5);}

/* Env particles */
.env-particle{position:absolute;pointer-events:none;z-index:3;}
.mosquito{font-size:20px;animation:buzz 2s infinite;}
@keyframes buzz{0%,100%{transform:translate(0,0) rotate(0deg)}25%{transform:translate(8px,-5px) rotate(10deg)}50%{transform:translate(-5px,3px) rotate(-5deg)}75%{transform:translate(3px,-8px) rotate(5deg)}}
.snowflake{font-size:16px;animation:snowfall linear infinite;}
@keyframes snowfall{0%{transform:translateY(-20px) rotate(0deg);opacity:.8}100%{transform:translateY(250px) rotate(360deg);opacity:.2}}
.grass{font-size:22px;position:absolute;bottom:0;}
.wisp{font-size:11px;color:rgba(255,255,255,.4);animation:wispFloat 4s infinite;}
@keyframes wispFloat{0%,100%{transform:translateX(0) translateY(0);opacity:.3}50%{transform:translateX(20px) translateY(-10px);opacity:.6}}

/* Particles */
.particle{position:absolute;border-radius:50%;pointer-events:none;animation:particleFade .8s forwards;}
@keyframes particleFade{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(0) translateY(-30px)}}

/* RESULT SUMMARY - big accessible popup after each round */
.result-summary{position:absolute;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:60;padding:20px;text-align:center;}
.result-summary.show{display:flex;animation:fadeIn .4s;}
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}
.result-icon{font-size:80px;margin-bottom:6px;}
.result-title{font-size:28px;font-weight:800;margin-bottom:6px;}
.result-title.helpful{color:#69f0ae;}
.result-title.harmful{color:#ef9a9a;}
.result-title.neutral{color:#ffd54f;}
.result-explain{font-size:18px;color:#cfd8dc;line-height:1.5;max-width:500px;margin-bottom:4px;}
.result-explain strong{color:#fff;}
.result-prediction{font-size:22px;font-weight:700;margin:8px 0;}
.result-prediction.correct{color:#69f0ae;}
.result-prediction.wrong{color:#ef9a9a;}
.result-data-preview{background:rgba(30,30,80,.6);border-radius:8px;padding:10px 18px;margin:8px 0;font-size:15px;color:#b0bec5;border:1px solid rgba(100,100,255,.2);}
.result-data-preview span{color:#fff;font-weight:700;}
.result-continue{padding:12px 32px;background:linear-gradient(135deg,#1565c0,#1976d2);border:none;border-radius:8px;color:#fff;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px;transition:all .2s;}
.result-continue:hover{background:linear-gradient(135deg,#1976d2,#1e88e5);transform:scale(1.05);}

/* RIGHT PANEL */
.right-panel{width:260px;min-width:260px;background:rgba(15,15,50,.95);border-left:2px solid rgba(100,100,255,.2);display:flex;flex-direction:column;padding:8px;overflow-y:auto;}
.hud-section{margin-bottom:6px;}
.hud-title{font-size:10px;color:#b0bec5;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.stat-box{background:rgba(30,30,80,.6);border-radius:6px;padding:6px;text-align:center;border:1px solid rgba(100,100,255,.15);}
.stat-value{font-size:20px;font-weight:800;}
.stat-label{font-size:9px;color:#90a4ae;text-transform:uppercase;}
.stat-box.score .stat-value{color:#69f0ae;}
.stat-box.streak .stat-value{color:#ffd54f;}
.stat-box.round .stat-value{color:#90caf9;}
.stat-box.accuracy .stat-value{color:#ce93d8;}

/* Survival Meter */
.meter-container{background:rgba(30,30,80,.6);border-radius:8px;padding:6px;border:1px solid rgba(100,100,255,.15);}
.meter-label{font-size:9px;color:#90a4ae;text-transform:uppercase;text-align:center;margin-bottom:3px;}
.meter-bar{height:18px;background:#263238;border-radius:9px;overflow:hidden;}
.meter-fill{height:100%;border-radius:9px;transition:all .8s;width:50%;}
.meter-fill.green{background:linear-gradient(90deg,#43a047,#69f0ae);}
.meter-fill.yellow{background:linear-gradient(90deg,#f9a825,#fff176);}
.meter-fill.red{background:linear-gradient(90deg,#c62828,#ef5350);}

/* Classification */
.classification{text-align:center;padding:6px;border-radius:8px;font-weight:700;font-size:13px;min-height:36px;display:flex;align-items:center;justify-content:center;transition:all .5s;}
.classification.helpful{background:rgba(76,175,80,.2);border:2px solid #4caf50;color:#69f0ae;}
.classification.harmful{background:rgba(244,67,54,.2);border:2px solid #f44336;color:#ef9a9a;}
.classification.neutral{background:rgba(255,193,7,.2);border:2px solid #ffc107;color:#ffd54f;}
.classification.waiting{background:rgba(100,100,255,.1);border:2px solid rgba(100,100,255,.2);color:#78909c;}

.progress-container{margin-top:4px;}
.progress-bar{height:12px;background:#263238;border-radius:6px;overflow:hidden;}
.progress-fill{height:100%;background:linear-gradient(90deg,#4caf50,#69f0ae);border-radius:6px;transition:width .5s;}
.progress-text{font-size:10px;color:#81c784;text-align:center;margin-top:2px;}

.extra-msg{text-align:center;padding:6px;background:rgba(255,193,7,.15);border:1px solid #ffc107;border-radius:8px;margin-bottom:4px;display:none;}
.extra-msg .label{font-size:11px;color:#ffd54f;font-weight:700;}

.powerup-bar{background:rgba(156,39,176,.2);border:1px solid #9c27b0;border-radius:6px;padding:4px;text-align:center;margin-top:4px;display:none;}
.powerup-bar.active{display:block;animation:powerGlow 2s infinite;}
@keyframes powerGlow{0%,100%{box-shadow:0 0 8px rgba(156,39,176,.3)}50%{box-shadow:0 0 20px rgba(156,39,176,.6)}}
.powerup-label{font-size:9px;color:#ce93d8;text-transform:uppercase;}
.powerup-name{font-size:12px;font-weight:700;color:#e1bee7;}

.challenge-info{background:rgba(255,152,0,.15);border:1px solid #ff9800;border-radius:6px;padding:6px;margin-bottom:4px;display:none;text-align:center;}
.challenge-info .target{font-size:12px;color:#ffb74d;font-weight:600;}

/* Data Table */
.data-section{margin-top:auto;}
.copy-btn{display:block;width:100%;padding:5px;background:linear-gradient(135deg,#1565c0,#1976d2);border:none;border-radius:6px;color:#fff;font-size:11px;font-weight:700;cursor:pointer;margin-bottom:3px;}
.data-table{width:100%;border-collapse:collapse;font-size:9px;}
.data-table th{background:#1a237e;color:#fff;padding:3px 2px;text-align:center;font-size:8px;text-transform:uppercase;}
.data-table td{background:rgba(30,30,80,.4);color:#cfd8dc;padding:3px 2px;text-align:center;border:1px solid rgba(100,100,255,.1);font-size:9px;}
.data-table tr:nth-child(even) td{background:rgba(40,40,90,.4);}
.data-table tr.new-row td{animation:rowFlash .5s;}
@keyframes rowFlash{0%{background:rgba(255,213,79,.3)}100%{}}

/* Random event */
.random-event{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.9);border:3px solid #ff9800;border-radius:16px;padding:20px;text-align:center;z-index:50;display:none;animation:eventPop .4s;}
@keyframes eventPop{0%{transform:translate(-50%,-50%) scale(0)}60%{transform:translate(-50%,-50%) scale(1.1)}100%{transform:translate(-50%,-50%) scale(1)}}
.random-event-icon{font-size:48px;}
.random-event-label{font-size:14px;color:#ffb74d;font-weight:700;margin-top:6px;}

/* Replay overlay */
.replay-overlay{position:absolute;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:40;padding:20px;}
.replay-overlay.show{display:flex;animation:fadeIn .3s;}
.replay-title{font-size:14px;color:#ce93d8;text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;}
.replay-content{font-size:15px;color:#fff;text-align:center;max-width:90%;line-height:1.5;}
.replay-close{margin-top:10px;padding:8px 20px;background:#9c27b0;border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer;}

/* End screen */
.end-screen{position:absolute;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:100;}
.end-screen.show{display:flex;animation:fadeIn .5s;}
.end-badge{font-size:80px;margin-bottom:8px;}
.end-title{font-size:28px;font-weight:800;color:#69f0ae;margin-bottom:4px;}
.end-sub{font-size:14px;color:#b0bec5;}

/* Science note popup */
.science-note{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(20,20,60,.97);border:2px solid #5c6bc0;border-radius:12px;padding:20px 24px;font-size:12px;color:#c5cae9;text-align:center;z-index:200;display:none;max-width:480px;box-shadow:0 8px 40px rgba(0,0,0,.6);line-height:1.5;}
.science-note.show{display:block;animation:fadeIn .3s;}
.science-note-close{background:#5c6bc0;border:none;color:#fff;cursor:pointer;font-size:13px;font-weight:700;padding:6px 16px;border-radius:6px;margin-top:12px;display:inline-block;}

/* How-to-play overlay */
.how-to-play{position:fixed;inset:0;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;z-index:300;}
.how-to-play.hidden{display:none;}
.htp-card{background:linear-gradient(135deg,#1a237e,#283593);border:3px solid #5c6bc0;border-radius:16px;padding:28px 32px;max-width:520px;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,.5);}
.htp-title{font-size:28px;font-weight:800;color:#fff;margin-bottom:6px;}
.htp-sub{font-size:14px;color:#9fa8da;margin-bottom:16px;}
.htp-steps{text-align:left;margin-bottom:16px;}
.htp-step{display:flex;align-items:center;gap:10px;margin:8px 0;font-size:15px;color:#e8eaf6;}
.htp-step-num{width:32px;height:32px;background:linear-gradient(135deg,#e91e63,#c2185b);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;flex-shrink:0;}
.htp-start{padding:14px 36px;background:linear-gradient(135deg,#4caf50,#388e3c);border:none;border-radius:10px;color:#fff;font-size:18px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:2px;transition:all .2s;}
.htp-start:hover{transform:scale(1.05);box-shadow:0 4px 20px rgba(76,175,80,.4);}
</style>
</head>
<body>
<div class="top-bar">Mr. Jawad Simulation ‚Äî Mutations: When the Code Changes</div>

<!-- HOW TO PLAY -->
<div class="how-to-play" id="howToPlay">
<div class="htp-card">
<div class="htp-title">üß¨ Mutation Lab</div>
<div class="htp-sub">Change DNA. Watch what happens.</div>
<div class="htp-steps">
<div class="htp-step"><div class="htp-step-num">1</div>Pick the glowing option</div>
<div class="htp-step"><div class="htp-step-num">2</div>Guess what happens</div>
<div class="htp-step"><div class="htp-step-num">3</div>Hit MUTATE and watch!</div>
</div>
<button class="htp-start" onclick="startGame()">Start Lab</button>
</div>
</div>

<div class="main">
<!-- LEFT PANEL -->
<div class="left-panel">
<div class="mission-card" id="missionCard">
<div class="mission-round" id="missionRound">Round 1/8</div>
<div class="mission-unlock" id="missionUnlock">Change: Mutation Type</div>
</div>

<!-- STEP GUIDE -->
<div class="step-guide glow" id="stepGuide">
<div class="step-number" id="stepNumber">Step 1 of 3</div>
<div class="step-instruction" id="stepInstruction">Pick a mutation type below üëá</div>
<div class="step-dots">
<div class="step-dot active" id="dot1"></div>
<div class="step-dot" id="dot2"></div>
<div class="step-dot" id="dot3"></div>
</div>
</div>

<div class="control-section highlight" id="mutTypeSection">
<div class="control-title">Mutation Type <span class="unlock-badge" id="mutTypeBadge">Pick One</span></div>
<div class="control-group" id="mutTypeGroup">
<button class="control-btn" data-var="mutType" data-val="substitution" onclick="selectControl(this)">Substitution</button>
<button class="control-btn" data-var="mutType" data-val="insertion" onclick="selectControl(this)">Insertion</button>
<button class="control-btn" data-var="mutType" data-val="deletion" onclick="selectControl(this)">Deletion</button>
</div>
</div>

<div class="control-section" id="envSection">
<div class="control-title">Environment <span class="unlock-badge" id="envBadge" style="display:none">Pick One</span></div>
<div class="control-group" id="envGroup">
<button class="control-btn" data-var="env" data-val="normal" onclick="selectControl(this)">Normal</button>
<button class="control-btn" data-var="env" data-val="malaria" onclick="selectControl(this)">Malaria Zone</button>
<button class="control-btn" data-var="env" data-val="altitude" onclick="selectControl(this)">High Altitude</button>
<button class="control-btn" data-var="env" data-val="arctic" onclick="selectControl(this)">Arctic Cold</button>
</div>
</div>

<div class="control-section" id="locSection">
<div class="control-title">Mutation Location <span class="unlock-badge" id="locBadge" style="display:none">Pick One</span></div>
<div class="control-group" id="locGroup">
<button class="control-btn" data-var="loc" data-val="beginning" onclick="selectControl(this)">Beginning</button>
<button class="control-btn" data-var="loc" data-val="middle" onclick="selectControl(this)">Middle</button>
<button class="control-btn" data-var="loc" data-val="end" onclick="selectControl(this)">End</button>
</div>
</div>

<div class="predict-section" id="predictSection">
<div class="control-title">Predict Outcome</div>
<button class="predict-btn thrive" onclick="setPrediction('thrive')">üëç Thrive</button>
<button class="predict-btn survive" onclick="setPrediction('survive')">‚úã Survive</button>
<button class="predict-btn struggle" onclick="setPrediction('struggle')">üëé Struggle</button>
</div>

<div class="action-btns">
<button class="mutate-btn disabled" id="mutateBtn" onclick="runMutation()">‚ö° Mutate</button>
<div class="reset-row">
<button class="reset-btn" onclick="resetSim()">Reset</button>
<button class="newrun-btn" onclick="newRun()">New Run</button>
</div>
</div>
</div>

<!-- CENTER ARENA -->
<div class="center-panel">
<div class="arena" id="arena">
<div class="gene-zone">
<div class="zone-label gene-label">Gene Sequence</div>
<div class="gene-strand" id="geneStrand"></div>
<div class="zone-arrow">‚¨áÔ∏è</div>
</div>
<div class="protein-zone">
<div class="zone-label protein-label" style="position:absolute;top:4px;left:10px;">Protein Builder</div>
<div class="protein-machine" id="proteinMachine">
<div class="protein-shape" id="proteinShape"></div>
</div>
<div class="zone-arrow">‚¨áÔ∏è</div>
</div>
<div class="env-zone" id="envZone">
<div class="env-bg normal" id="envBg"></div>
<div class="env-name-badge" id="envNameBadge">üåø Normal</div>
<div class="organism" id="organism">
<div class="organism-body" id="orgBody">üß´</div>
<div class="organism-state-label" id="orgState"></div>
</div>
</div>

<!-- Result summary overlay -->
<div class="result-summary" id="resultSummary">
<div class="result-icon" id="resultIcon"></div>
<div class="result-title" id="resultTitle"></div>
<div class="result-explain" id="resultExplain"></div>
<div class="result-prediction" id="resultPrediction"></div>
<div class="result-data-preview" id="resultDataPreview"></div>
<button class="result-continue" id="resultContinue" onclick="closeResult()">Next Round ‚Üí</button>
</div>

<!-- Random event -->
<div class="random-event" id="randomEvent">
<div class="random-event-icon">üß¨üß¨</div>
<div class="random-event-label">Spontaneous Duplication!</div>
</div>

<!-- Replay overlay -->
<div class="replay-overlay" id="replayOverlay">
<div class="replay-title">‚ö° Protein Replay</div>
<div class="replay-content" id="replayContent"></div>
<button class="replay-close" onclick="closeReplay()">Got It</button>
</div>

<!-- End screen -->
<div class="end-screen" id="endScreen">
<div class="end-badge" id="endBadge">üß¨</div>
<div class="end-title" id="endTitle"></div>
<div class="end-sub" id="endSub"></div>
</div>
</div>
</div>

<!-- RIGHT PANEL -->
<div class="right-panel">
<div class="hud-section">
<div class="hud-title">Stats</div>
<div class="stats-grid">
<div class="stat-box score"><div class="stat-value" id="scoreVal">0</div><div class="stat-label">Score</div></div>
<div class="stat-box streak"><div class="stat-value" id="streakVal">0</div><div class="stat-label">Streak</div></div>
<div class="stat-box round"><div class="stat-value" id="roundVal">0/8</div><div class="stat-label">Rounds</div></div>
<div class="stat-box accuracy"><div class="stat-value" id="accuracyVal">‚Äî</div><div class="stat-label">Accuracy</div></div>
</div>
</div>
<div class="hud-section">
<div class="hud-title">Survival Meter</div>
<div class="meter-container">
<div class="meter-bar"><div class="meter-fill yellow" id="meterFill" style="width:50%"></div></div>
<div class="meter-label" id="meterLabel">Waiting</div>
</div>
</div>
<div class="hud-section">
<div class="hud-title">Result</div>
<div class="classification waiting" id="classLabel">Waiting...</div>
</div>
<div class="extra-msg" id="extraMsg"><div class="label"></div></div>
<div class="powerup-bar" id="powerupBar"><div class="powerup-label">Power-Up Ready</div><div class="powerup-name">‚ö° Protein Replay</div></div>
<div class="challenge-info" id="challengeInfo"><div class="target" id="challengeTarget"></div></div>
<div class="hud-section">
<div class="hud-title">Progress</div>
<div class="progress-container">
<div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
<div class="progress-text" id="progressText">0 / 5 required</div>
</div>
</div>
<div class="data-section">
<div class="hud-title">Data Table</div>
<button class="copy-btn" onclick="copyTable()">üìã Copy Table</button>
<table class="data-table" id="dataTable">
<thead><tr><th>Rnd</th><th>Changed</th><th>Protein</th><th>Survival</th></tr></thead>
<tbody id="dataBody"></tbody>
</table>
</div>
</div>
</div>

<!-- Science Note -->
<div class="science-note" id="scienceNote">
In this lab, we observe DNA, genes, and mutations ‚Äî changes within a population. We report only what the data shows and do not make conclusions beyond what we can observe.
<br><button class="science-note-close" onclick="document.getElementById('scienceNote').classList.remove('show')">Got It</button>
</div>

<script>
// ---- STATE ----
const BASE_GENE = ['A','T','G','C','A','T','G','C','T','A','G','C','A','T','G','C'];
let currentRound = 1;
let score = 0;
let streak = 0;
let totalPredictions = 0;
let correctPredictions = 0;
let completedRounds = 0;
let prediction = null;
let selectedMutType = null;
let selectedEnv = null;
let selectedLoc = null;
let isAnimating = false;
let powerUpReady = false;
let powerUpUsed = false;
let gameData = [];
let duplicationFired = false;
let challengeEnv = null;
let currentStep = 1; // 1=pick variable, 2=predict, 3=mutate

const ROUND_CONFIG = [
  {unlock:'mutType', lockEnv:'normal', lockLoc:'middle'},
  {unlock:'mutType', lockEnv:'normal', lockLoc:'middle'},
  {unlock:'mutType', lockEnv:'normal', lockLoc:'middle'},
  {unlock:'env', lockMut:'substitution', lockLoc:'middle'},
  {unlock:'env', lockMut:'substitution', lockLoc:'middle'},
  {unlock:'loc', lockMut:'substitution', lockEnv:'normal'},
  {unlock:'loc', lockMut:'substitution', lockEnv:'normal'},
  {unlock:'challenge'}
];

const ENV_NAMES = {normal:'Normal',malaria:'Malaria Zone',altitude:'High Altitude',arctic:'Arctic Cold'};
const ENV_EMOJIS = {normal:'üåø',malaria:'ü¶ü',altitude:'üèîÔ∏è',arctic:'‚ùÑÔ∏è'};
const MUT_NAMES = {substitution:'Substitution',insertion:'Insertion',deletion:'Deletion'};
const LOC_NAMES = {beginning:'Beginning',middle:'Middle',end:'End'};

function startGame(){
  document.getElementById('howToPlay').classList.add('hidden');
  document.getElementById('scienceNote').classList.add('show');
  init();
}

function init(){
  buildGeneDisplay();
  buildProtein('normal');
  setupRound();
}

function buildGeneDisplay(){
  const strand = document.getElementById('geneStrand');
  strand.innerHTML = '';
  BASE_GENE.forEach((l,i)=>{
    const el = document.createElement('div');
    el.className = 'gene-letter ' + l;
    el.textContent = l;
    el.id = 'gene-' + i;
    strand.appendChild(el);
  });
}

function buildProtein(state){
  const shape = document.getElementById('proteinShape');
  if(state === 'normal'){
    shape.innerHTML = `<svg viewBox="0 0 220 130" width="220" height="130">
      <defs><linearGradient id="pg1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#4fc3f7"/><stop offset="100%" stop-color="#0288d1"/></linearGradient></defs>
      <path d="M30,80 Q50,20 80,50 T130,40 T170,70 Q180,90 160,100 Q120,110 80,100 Q40,95 30,80Z" fill="url(#pg1)" stroke="#01579b" stroke-width="2" opacity=".9"/>
      <circle cx="80" cy="60" r="8" fill="#b3e5fc" opacity=".6"/>
      <circle cx="130" cy="55" r="6" fill="#b3e5fc" opacity=".5"/>
      <text x="110" y="125" text-anchor="middle" fill="#90caf9" font-size="13" font-weight="700">Normal Protein</text>
    </svg>`;
  } else if(state === 'changed'){
    shape.innerHTML = `<svg viewBox="0 0 220 130" width="220" height="130">
      <defs><linearGradient id="pg2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ffb74d"/><stop offset="100%" stop-color="#e65100"/></linearGradient></defs>
      <path d="M30,70 Q60,10 100,55 T150,30 Q180,50 165,80 Q140,110 100,100 Q50,95 30,70Z" fill="url(#pg2)" stroke="#bf360c" stroke-width="2" opacity=".9"/>
      <circle cx="95" cy="50" r="10" fill="#ffe0b2" opacity=".6"/>
      <circle cx="140" cy="50" r="7" fill="#ffe0b2" opacity=".5"/>
      <text x="110" y="125" text-anchor="middle" fill="#ffb74d" font-size="13" font-weight="700">Changed Shape!</text>
    </svg>`;
  } else if(state === 'broken'){
    shape.innerHTML = `<svg viewBox="0 0 220 130" width="220" height="130">
      <defs><linearGradient id="pg3" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ef5350"/><stop offset="100%" stop-color="#b71c1c"/></linearGradient></defs>
      <path d="M25,75 Q35,40 55,60 L70,30 Q80,50 95,45 L110,65 Q120,35 140,55 L155,40 Q175,60 170,85 Q150,105 100,100 Q45,98 25,75Z" fill="url(#pg3)" stroke="#7f0000" stroke-width="2" opacity=".9"/>
      <line x1="60" y1="50" x2="80" y2="70" stroke="#ffcdd2" stroke-width="2" opacity=".6"/>
      <line x1="120" y1="45" x2="140" y2="65" stroke="#ffcdd2" stroke-width="2" opacity=".6"/>
      <text x="110" y="125" text-anchor="middle" fill="#ef9a9a" font-size="13" font-weight="700">Broken!</text>
    </svg>`;
  }
}

// ---- STEP GUIDE SYSTEM ----
function updateStepGuide(step, unlockType){
  currentStep = step;
  const num = document.getElementById('stepNumber');
  const inst = document.getElementById('stepInstruction');
  const d1 = document.getElementById('dot1');
  const d2 = document.getElementById('dot2');
  const d3 = document.getElementById('dot3');

  // Reset dots
  [d1,d2,d3].forEach(d=>{d.className='step-dot';});

  // Reset section highlights
  ['mutTypeSection','envSection','locSection','predictSection'].forEach(id=>{
    document.getElementById(id).classList.remove('highlight');
  });

  // Hide all badges
  ['mutTypeBadge','envBadge','locBadge'].forEach(id=>{document.getElementById(id).style.display='none';});

  if(step === 1){
    num.textContent = 'Step 1 of 3';
    d1.className = 'step-dot active';
    let sectionId, badgeId, label;
    if(unlockType === 'mutType'){sectionId='mutTypeSection';badgeId='mutTypeBadge';label='Pick a mutation üëá';}
    else if(unlockType === 'env'){sectionId='envSection';badgeId='envBadge';label='Pick an environment üëá';}
    else if(unlockType === 'loc'){sectionId='locSection';badgeId='locBadge';label='Pick a location üëá';}
    else if(unlockType === 'challenge'){sectionId='locSection';badgeId='locBadge';label='Pick location to help! üëá';}
    inst.textContent = label;
    document.getElementById(sectionId).classList.add('highlight');
    document.getElementById(badgeId).style.display = 'inline';
  } else if(step === 2){
    num.textContent = 'Step 2 of 3';
    d1.className = 'step-dot done';
    d2.className = 'step-dot active';
    inst.textContent = 'Guess what happens üëá';
    document.getElementById('predictSection').classList.add('highlight');
  } else if(step === 3){
    num.textContent = 'Step 3 of 3';
    d1.className = 'step-dot done';
    d2.className = 'step-dot done';
    d3.className = 'step-dot active';
    inst.textContent = 'Hit MUTATE! ‚ö°';
  }
}

function setupRound(){
  if(currentRound > 8) return showEnd();
  const cfg = ROUND_CONFIG[currentRound - 1];

  document.getElementById('missionRound').textContent = 'Round ' + currentRound + '/8';

  prediction = null;
  selectedMutType = null;
  selectedEnv = null;
  selectedLoc = null;

  document.querySelectorAll('.predict-btn').forEach(b=>b.classList.remove('chosen'));
  document.querySelectorAll('.control-btn').forEach(b=>{b.classList.remove('selected');b.classList.remove('locked');});

  if(cfg.unlock === 'challenge'){
    setupChallenge();
    return;
  }

  document.getElementById('challengeInfo').style.display = 'none';

  const mutBtns = document.querySelectorAll('#mutTypeGroup .control-btn');
  const envBtns = document.querySelectorAll('#envGroup .control-btn');
  const locBtns = document.querySelectorAll('#locGroup .control-btn');

  if(cfg.unlock === 'mutType'){
    document.getElementById('missionUnlock').textContent = 'Change: Mutation Type';
    envBtns.forEach(b=>{b.classList.add('locked'); if(b.dataset.val===cfg.lockEnv){b.classList.add('selected');selectedEnv=cfg.lockEnv;}});
    locBtns.forEach(b=>{b.classList.add('locked'); if(b.dataset.val===cfg.lockLoc){b.classList.add('selected');selectedLoc=cfg.lockLoc;}});
    updateStepGuide(1, 'mutType');
  } else if(cfg.unlock === 'env'){
    document.getElementById('missionUnlock').textContent = 'Change: Environment';
    mutBtns.forEach(b=>{b.classList.add('locked'); if(b.dataset.val===cfg.lockMut){b.classList.add('selected');selectedMutType=cfg.lockMut;}});
    locBtns.forEach(b=>{b.classList.add('locked'); if(b.dataset.val===cfg.lockLoc){b.classList.add('selected');selectedLoc=cfg.lockLoc;}});
    updateStepGuide(1, 'env');
  } else if(cfg.unlock === 'loc'){
    document.getElementById('missionUnlock').textContent = 'Change: Location';
    mutBtns.forEach(b=>{b.classList.add('locked'); if(b.dataset.val===cfg.lockMut){b.classList.add('selected');selectedMutType=cfg.lockMut;}});
    envBtns.forEach(b=>{b.classList.add('locked'); if(b.dataset.val===cfg.lockEnv){b.classList.add('selected');selectedEnv=cfg.lockEnv;}});
    updateStepGuide(1, 'loc');
  }

  updateMutateBtn();
  updateClassLabel('waiting');

  if(currentRound === 6){
    const em = document.getElementById('extraMsg');
    em.style.display = 'block';
    em.querySelector('.label').textContent = '5 Done! Extra Credit Rounds!';
  }

  buildGeneDisplay();
  buildProtein('normal');
  resetOrganism();
  setEnvironmentVisuals(selectedEnv || 'normal');
}

function setupChallenge(){
  const envs = ['malaria','altitude','arctic'];
  challengeEnv = envs[Math.floor(Math.random()*envs.length)];
  selectedMutType = 'substitution';
  selectedEnv = challengeEnv;
  selectedLoc = null;

  document.getElementById('missionUnlock').textContent = 'Challenge Round!';

  const mutBtns = document.querySelectorAll('#mutTypeGroup .control-btn');
  const envBtns = document.querySelectorAll('#envGroup .control-btn');
  const locBtns = document.querySelectorAll('#locGroup .control-btn');

  mutBtns.forEach(b=>{b.classList.add('locked');if(b.dataset.val==='substitution')b.classList.add('selected');});
  envBtns.forEach(b=>{b.classList.add('locked');if(b.dataset.val===challengeEnv)b.classList.add('selected');});
  locBtns.forEach(b=>{b.classList.remove('locked');b.classList.remove('selected');});

  document.getElementById('challengeInfo').style.display = 'block';
  document.getElementById('challengeTarget').textContent = 'üéØ Help organism in ' + ENV_NAMES[challengeEnv] + '!';

  updateStepGuide(1, 'challenge');
  updateMutateBtn();
  updateClassLabel('waiting');
  buildGeneDisplay();
  buildProtein('normal');
  resetOrganism();
  setEnvironmentVisuals(challengeEnv);
}

function selectControl(btn){
  if(btn.classList.contains('locked') || isAnimating) return;
  const group = btn.parentElement;
  group.querySelectorAll('.control-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');

  if(btn.dataset.var === 'mutType') selectedMutType = btn.dataset.val;
  if(btn.dataset.var === 'env'){
    selectedEnv = btn.dataset.val;
    setEnvironmentVisuals(selectedEnv);
  }
  if(btn.dataset.var === 'loc') selectedLoc = btn.dataset.val;

  // Show mutation site on gene
  if(selectedLoc) showMutationSite();

  // Advance step guide to predict
  if(selectedMutType && selectedEnv && selectedLoc && currentStep === 1){
    const cfg = ROUND_CONFIG[currentRound - 1];
    updateStepGuide(2, cfg.unlock);
  }

  updateMutateBtn();
}

function showMutationSite(){
  // Remove old markers
  document.querySelectorAll('.mut-site-marker').forEach(m=>m.remove());
  const idx = selectedLoc === 'beginning' ? 2 : selectedLoc === 'middle' ? 8 : 13;
  const el = document.getElementById('gene-' + idx);
  if(el){
    const marker = document.createElement('div');
    marker.className = 'mut-site-marker';
    el.style.position = 'relative';
    el.appendChild(marker);
  }
}

function setPrediction(p){
  if(isAnimating) return;
  prediction = p;
  document.querySelectorAll('.predict-btn').forEach(b=>b.classList.remove('chosen'));
  document.querySelector('.predict-btn.' + p).classList.add('chosen');

  // Advance step guide to mutate
  if(currentStep === 2){
    const cfg = ROUND_CONFIG[currentRound - 1];
    updateStepGuide(3, cfg.unlock);
  }

  updateMutateBtn();
}

function updateMutateBtn(){
  const btn = document.getElementById('mutateBtn');
  if(selectedMutType && selectedEnv && selectedLoc && prediction && !isAnimating){
    btn.classList.remove('disabled');
    btn.classList.add('ready');
  } else {
    btn.classList.add('disabled');
    btn.classList.remove('ready');
  }
}

function updateClassLabel(type, text){
  const el = document.getElementById('classLabel');
  el.className = 'classification ' + type;
  if(text) el.textContent = text;
  else if(type === 'waiting') el.textContent = 'Waiting...';
}

function setEnvironmentVisuals(env){
  const bg = document.getElementById('envBg');
  bg.className = 'env-bg ' + env;
  document.getElementById('envNameBadge').textContent = ENV_EMOJIS[env] + ' ' + ENV_NAMES[env];
  document.querySelectorAll('.env-particle').forEach(e=>e.remove());
  const zone = document.getElementById('envZone');

  if(env === 'malaria'){
    for(let i=0;i<5;i++){const m=document.createElement('div');m.className='env-particle mosquito';m.textContent='ü¶ü';m.style.left=(15+Math.random()*70)+'%';m.style.top=(10+Math.random()*50)+'%';m.style.animationDelay=(Math.random()*2)+'s';zone.appendChild(m);}
  } else if(env === 'arctic'){
    for(let i=0;i<10;i++){const s=document.createElement('div');s.className='env-particle snowflake';s.textContent='‚ùÑ';s.style.left=(Math.random()*100)+'%';s.style.top='-20px';s.style.animationDuration=(2+Math.random()*3)+'s';s.style.animationDelay=(Math.random()*3)+'s';zone.appendChild(s);}
  } else if(env === 'altitude'){
    for(let i=0;i<6;i++){const w=document.createElement('div');w.className='env-particle wisp';w.textContent='„Ä∞Ô∏è';w.style.left=(Math.random()*80)+'%';w.style.top=(20+Math.random()*50)+'%';w.style.animationDelay=(Math.random()*3)+'s';zone.appendChild(w);}
  } else {
    for(let i=0;i<7;i++){const g=document.createElement('div');g.className='env-particle grass';g.textContent='üåø';g.style.left=(i*13+Math.random()*5)+'%';zone.appendChild(g);}
  }
}

// ---- OUTCOME LOGIC ----
function getOutcome(mutType, env, loc){
  let proteinResult, survival;
  if(mutType === 'substitution'){
    proteinResult = 'changed';
  } else {
    proteinResult = 'broken'; // frameshift for insertion/deletion
  }

  let severity = loc === 'beginning' ? 'high' : loc === 'end' ? 'low' : 'medium';

  if(proteinResult === 'broken'){
    if(severity === 'low' && env === 'normal') survival = 'neutral';
    else survival = 'harmful';
  } else {
    if(env === 'normal') survival = 'neutral';
    else if(env === 'malaria') survival = 'helpful';
    else if(env === 'altitude') survival = severity === 'high' ? 'harmful' : 'neutral';
    else if(env === 'arctic') survival = 'harmful';
  }

  let proteinLabel = proteinResult === 'changed' ? 'Changed shape' : 'Broken';

  if(mutType === 'substitution' && loc === 'end'){
    proteinLabel = 'Slightly changed';
    if(env === 'normal' || env === 'altitude' || env === 'arctic') survival = 'neutral';
  }

  const survivalLabel = survival.charAt(0).toUpperCase() + survival.slice(1) + ' IN ' + ENV_NAMES[env];
  return {proteinResult, proteinLabel, survival, survivalLabel};
}

function mapSurvivalToPrediction(s){return s==='helpful'?'thrive':s==='harmful'?'struggle':'survive';}

// ---- PLAIN LANGUAGE EXPLANATIONS ----
function getExplanation(mutType, env, loc, outcome){
  const e = ENV_NAMES[env];
  if(outcome.survival === 'helpful'){
    return `The ${mutType} <strong>changed the protein</strong> ‚Üí new shape <strong>helped</strong> in ${e}!`;
  } else if(outcome.survival === 'harmful' && outcome.proteinResult === 'broken'){
    return `The ${mutType} <strong>broke the protein</strong> ‚Üí organism <strong>can't survive</strong> in ${e}.`;
  } else if(outcome.survival === 'harmful'){
    return `The ${mutType} <strong>changed the protein</strong> ‚Üí new shape <strong>doesn't work</strong> in ${e}.`;
  } else {
    return `The ${mutType} <strong>changed the protein</strong> ‚Üí but it <strong>didn't matter</strong> in ${e}.`;
  }
}

// ---- ANIMATION ENGINE ----
async function runMutation(){
  try {
    const btn = document.getElementById('mutateBtn');
    if(btn.classList.contains('disabled') || isAnimating) return;
    isAnimating = true;
    btn.classList.add('disabled');
    btn.classList.remove('ready');

    // Clear step guide during animation
    document.getElementById('stepNumber').textContent = '';
    document.getElementById('stepInstruction').textContent = 'Watch! üëÄ';
    ['mutTypeSection','envSection','locSection','predictSection'].forEach(id=>{
      document.getElementById(id).classList.remove('highlight');
    });

    const mutType = selectedMutType;
    const env = selectedEnv;
    const loc = selectedLoc;

    let doubled = false;
    if(currentRound >= 6 && currentRound <= 8 && !duplicationFired && Math.random() < 0.35){
      duplicationFired = true;
      doubled = true;
    }

    // 1. Animate gene
    await animateGeneMutation(mutType, loc);

    const outcome = getOutcome(mutType, env, loc);
    if(doubled){
      await showRandomEvent();
      if(outcome.survival === 'helpful') outcome.survivalLabel = 'Very Helpful IN ' + ENV_NAMES[env];
      else if(outcome.survival === 'harmful') outcome.survivalLabel = 'Very Harmful IN ' + ENV_NAMES[env];
    }

    // 2. Animate protein
    await animateProtein(outcome.proteinResult);

    // 3. Animate organism
    await animateOrganism(outcome.survival);

    // 4. Update HUD
    updateMeter(outcome.survival);
    const classType = outcome.survival;
    updateClassLabel(classType, outcome.survivalLabel);

    // 5. Check prediction
    totalPredictions++;
    const correct = prediction === mapSurvivalToPrediction(outcome.survival);
    if(correct){correctPredictions++;streak++;score+=10+(streak>1?streak*2:0);}
    else{streak=0;score+=2;}

    document.getElementById('scoreVal').textContent = score;
    document.getElementById('streakVal').textContent = streak;
    completedRounds++;
    document.getElementById('roundVal').textContent = completedRounds + '/8';
    document.getElementById('accuracyVal').textContent = totalPredictions>0?Math.round((correctPredictions/totalPredictions)*100)+'%':'‚Äî';

    const reqDone = Math.min(completedRounds, 5);
    document.getElementById('progressFill').style.width = (reqDone/5*100) + '%';
    document.getElementById('progressText').textContent = reqDone >= 5 ? '5/5 Complete!' : reqDone + ' / 5 required';

    // Record data
    const cfg = ROUND_CONFIG[currentRound - 1];
    let changedLabel;
    if(cfg.unlock === 'mutType') changedLabel = MUT_NAMES[mutType];
    else if(cfg.unlock === 'env') changedLabel = ENV_NAMES[env];
    else if(cfg.unlock === 'loc') changedLabel = LOC_NAMES[loc];
    else changedLabel = LOC_NAMES[loc];

    gameData.push({round:currentRound,changed:changedLabel,protein:outcome.proteinLabel,survival:outcome.survivalLabel});
    addDataRow(currentRound, changedLabel, outcome.proteinLabel, outcome.survivalLabel);

    // Power-up check
    if(correctPredictions >= 3 && !powerUpReady && !powerUpUsed){
      powerUpReady = true;
      document.getElementById('powerupBar').classList.add('active');
      document.getElementById('powerupBar').style.display = 'block';
    }

    // Extra credit message
    if(completedRounds === 5 && currentRound <= 5){
      const em = document.getElementById('extraMsg');
      em.style.display = 'block';
      em.querySelector('.label').textContent = 'Required Done! Extra Credit?';
    }

    // Show protein replay before result if powerup ready
    if(powerUpReady && !powerUpUsed){
      powerUpUsed = true;
      powerUpReady = false;
      document.getElementById('powerupBar').style.display = 'none';
      await showReplay(mutType, loc, outcome);
    }

    // Show result summary
    await delay(300);
    showResultSummary(mutType, env, loc, outcome, correct);

  } catch(err){
    console.error('Error:', err);
    isAnimating = false;
    currentRound++;
    if(currentRound > 8) showEnd();
    else setupRound();
  }
}

function delay(ms){return new Promise(r=>setTimeout(r,ms));}

function showResultSummary(mutType, env, loc, outcome, correct){
  const summary = document.getElementById('resultSummary');
  const icon = document.getElementById('resultIcon');
  const title = document.getElementById('resultTitle');
  const explain = document.getElementById('resultExplain');
  const pred = document.getElementById('resultPrediction');
  const dataPreview = document.getElementById('resultDataPreview');
  const continueBtn = document.getElementById('resultContinue');

  if(outcome.survival === 'helpful'){
    icon.textContent = 'üåü';
    title.textContent = outcome.survivalLabel;
    title.className = 'result-title helpful';
  } else if(outcome.survival === 'harmful'){
    icon.textContent = '‚ö†Ô∏è';
    title.textContent = outcome.survivalLabel;
    title.className = 'result-title harmful';
  } else {
    icon.textContent = '‚û°Ô∏è';
    title.textContent = outcome.survivalLabel;
    title.className = 'result-title neutral';
  }

  explain.innerHTML = getExplanation(mutType, env, loc, outcome);

  if(correct){
    pred.textContent = '‚úì You got it!';
    pred.className = 'result-prediction correct';
  } else {
    pred.textContent = '‚úó Not this time ‚Äî keep going!';
    pred.className = 'result-prediction wrong';
  }

  const lastData = gameData[gameData.length - 1];
  dataPreview.innerHTML = `<span>${lastData.changed}</span> ‚Üí <span>${lastData.protein}</span> ‚Üí <span>${lastData.survival}</span>`;

  if(currentRound >= 8){
    continueBtn.textContent = completedRounds >= 8 ? 'Finish Lab! üèÜ' : 'Finish Lab!';
  } else if(completedRounds === 5){
    continueBtn.textContent = 'Extra Credit Round ‚Üí';
  } else {
    continueBtn.textContent = 'Next Round ‚Üí';
  }

  summary.classList.add('show');
}

function closeResult(){
  document.getElementById('resultSummary').classList.remove('show');
  isAnimating = false;
  currentRound++;
  if(currentRound > 8) showEnd();
  else setupRound();
}

async function animateGeneMutation(mutType, loc){
  const idx = loc === 'beginning' ? 2 : loc === 'middle' ? 8 : 13;
  const letters = ['A','T','G','C'];
  const strand = document.getElementById('geneStrand');

  if(mutType === 'substitution'){
    const el = document.getElementById('gene-' + idx);
    if(!el) return;
    const oldLetter = el.textContent;
    let newLetter = letters.filter(l=>l!==oldLetter)[Math.floor(Math.random()*3)];
    el.classList.add('mutated');
    await delay(300);
    el.textContent = newLetter;
    el.className = 'gene-letter ' + newLetter + ' mutated';
    spawnParticles(el, '#ff9800', 10);
    await delay(500);
  } else if(mutType === 'insertion'){
    const newLetter = letters[Math.floor(Math.random()*4)];
    const newEl = document.createElement('div');
    newEl.className = 'gene-letter ' + newLetter + ' mutated';
    newEl.textContent = newLetter;
    newEl.style.width = '0px';
    newEl.style.overflow = 'hidden';
    const ref = document.getElementById('gene-' + idx);
    if(ref) strand.insertBefore(newEl, ref);
    await delay(100);
    newEl.style.width = '36px';
    spawnParticles(newEl, '#e91e63', 12);
    await delay(300);
    for(let i=idx;i<BASE_GENE.length;i++){const e=document.getElementById('gene-'+i);if(e)e.classList.add('shifting');}
    await delay(600);
  } else {
    const el = document.getElementById('gene-' + idx);
    if(!el) return;
    spawnParticles(el, '#f44336', 14);
    el.style.transform = 'scale(0)';
    el.style.opacity = '0';
    await delay(400);
    el.remove();
    for(let i=idx+1;i<BASE_GENE.length;i++){const e=document.getElementById('gene-'+i);if(e)e.classList.add('shifting');}
    await delay(600);
  }
}

function spawnParticles(target, color, count){
  try {
    const rect = target.getBoundingClientRect();
    const arena = document.getElementById('arena');
    const arenaRect = arena.getBoundingClientRect();
    for(let i=0;i<count;i++){
      const p = document.createElement('div');
      p.className = 'particle';
      const size = 4 + Math.random()*10;
      p.style.width = size+'px';
      p.style.height = size+'px';
      p.style.background = color;
      p.style.left = (rect.left-arenaRect.left+rect.width/2+(Math.random()-.5)*40)+'px';
      p.style.top = (rect.top-arenaRect.top+rect.height/2+(Math.random()-.5)*40)+'px';
      p.style.boxShadow = '0 0 8px '+color;
      arena.appendChild(p);
      setTimeout(()=>p.remove(), 800);
    }
  } catch(e){}
}

async function animateProtein(result){
  const machine = document.getElementById('proteinMachine');
  machine.style.opacity = '0.4';
  machine.style.transform = 'scale(0.85)';
  await delay(400);
  buildProtein(result === 'changed' ? 'changed' : 'broken');
  machine.style.opacity = '1';
  machine.style.transform = 'scale(1)';
  const shape = document.getElementById('proteinShape');
  spawnParticles(shape, result === 'changed' ? '#ff9800' : '#f44336', 14);
  await delay(600);
}

async function animateOrganism(survival){
  const org = document.getElementById('organism');
  const body = document.getElementById('orgBody');
  const state = document.getElementById('orgState');

  org.className = 'organism';
  org.style.transform = 'translateY(40px)';
  org.style.opacity = '0';
  await delay(100);
  org.style.transition = 'all .7s';
  org.style.transform = 'translateY(0)';
  org.style.opacity = '1';
  await delay(500);

  if(survival === 'helpful'){
    org.classList.add('thriving');
    state.textContent = 'üíö Thriving!';
    state.style.background = 'rgba(76,175,80,.4)';
    state.style.color = '#69f0ae';
    spawnParticles(body, '#4caf50', 18);
  } else if(survival === 'harmful'){
    org.classList.add('struggling');
    state.textContent = 'üíî Struggling';
    state.style.background = 'rgba(244,67,54,.4)';
    state.style.color = '#ef9a9a';
    spawnParticles(body, '#f44336', 18);
  } else {
    org.classList.add('neutral');
    state.textContent = 'üíõ Unchanged';
    state.style.background = 'rgba(255,193,7,.4)';
    state.style.color = '#ffd54f';
    spawnParticles(body, '#ffc107', 10);
  }
  await delay(600);
}

function resetOrganism(){
  const org = document.getElementById('organism');
  org.className = 'organism';
  org.style.transform = '';
  org.style.opacity = '1';
  org.style.transition = '';
  document.getElementById('orgState').textContent = '';
  document.getElementById('orgState').style.background = 'transparent';
}

function updateMeter(survival){
  const fill = document.getElementById('meterFill');
  const label = document.getElementById('meterLabel');
  if(survival === 'helpful'){fill.style.width='90%';fill.className='meter-fill green';label.textContent='Thriving';}
  else if(survival === 'harmful'){fill.style.width='15%';fill.className='meter-fill red';label.textContent='Struggling';}
  else{fill.style.width='50%';fill.className='meter-fill yellow';label.textContent='Stable';}
}

async function showRandomEvent(){
  const el = document.getElementById('randomEvent');
  el.style.display = 'block';
  await delay(1500);
  el.style.display = 'none';
}

async function showReplay(mutType, loc, outcome){
  const overlay = document.getElementById('replayOverlay');
  const content = document.getElementById('replayContent');
  let info = '';
  if(mutType === 'substitution') info = 'Swapped one letter ‚Üí <strong>one amino acid changed</strong> ‚Üí protein got a <strong>new shape</strong>.';
  else if(mutType === 'insertion') info = 'Added a letter ‚Üí everything after it <strong>shifted</strong> ‚Üí protein <strong>broke</strong>!';
  else info = 'Removed a letter ‚Üí everything after it <strong>shifted</strong> ‚Üí protein <strong>broke</strong>!';
  content.innerHTML = info;
  overlay.classList.add('show');
  await new Promise(r=>{window._replayResolve=r;});
}

function closeReplay(){
  document.getElementById('replayOverlay').classList.remove('show');
  if(window._replayResolve) window._replayResolve();
}

function addDataRow(round, changed, protein, survival){
  const body = document.getElementById('dataBody');
  const row = document.createElement('tr');
  row.className = 'new-row';
  row.innerHTML = `<td>${round}</td><td>${changed}</td><td>${protein}</td><td>${survival}</td>`;
  body.appendChild(row);
}

function showEnd(){
  const screen = document.getElementById('endScreen');
  screen.classList.add('show');
  if(correctPredictions >= 5){
    document.getElementById('endBadge').textContent = 'üèÜ';
    document.getElementById('endTitle').textContent = 'Gene Genius!';
  } else {
    document.getElementById('endBadge').textContent = 'üß¨';
    document.getElementById('endTitle').textContent = 'Lab Complete!';
  }
  document.getElementById('endSub').textContent = `Score: ${score} | Accuracy: ${totalPredictions>0?Math.round((correctPredictions/totalPredictions)*100):0}% | Rounds: ${completedRounds}`;
  if(completedRounds >= 8) document.getElementById('endTitle').textContent += ' + Extra Credit!';
}

function copyTable(){
  try {
    let text = 'Round\tWhat I Changed\tProtein Result\tOrganism Survival\n';
    gameData.forEach(d=>{text += `${d.round}\t${d.changed}\t${d.protein}\t${d.survival}\n`;});
    navigator.clipboard.writeText(text).then(()=>{
      const btn = document.querySelector('.copy-btn');
      btn.textContent = '‚úì Copied!';
      setTimeout(()=>{btn.textContent='üìã Copy Table';},2000);
    }).catch(()=>{
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      const btn = document.querySelector('.copy-btn');
      btn.textContent = '‚úì Copied!';
      setTimeout(()=>{btn.textContent='üìã Copy Table';},2000);
    });
  } catch(e){}
}

function resetSim(){
  currentRound=1;score=0;streak=0;totalPredictions=0;correctPredictions=0;completedRounds=0;
  prediction=null;gameData=[];duplicationFired=false;powerUpReady=false;powerUpUsed=false;isAnimating=false;
  document.getElementById('scoreVal').textContent='0';
  document.getElementById('streakVal').textContent='0';
  document.getElementById('roundVal').textContent='0/8';
  document.getElementById('accuracyVal').textContent='‚Äî';
  document.getElementById('progressFill').style.width='0%';
  document.getElementById('progressText').textContent='0 / 5 required';
  document.getElementById('dataBody').innerHTML='';
  document.getElementById('endScreen').classList.remove('show');
  document.getElementById('resultSummary').classList.remove('show');
  document.getElementById('extraMsg').style.display='none';
  document.getElementById('powerupBar').style.display='none';
  document.getElementById('challengeInfo').style.display='none';
  updateMeter('neutral');
  updateClassLabel('waiting');
  buildGeneDisplay();
  buildProtein('normal');
  resetOrganism();
  setEnvironmentVisuals('normal');
  setupRound();
}

function newRun(){resetSim();}
</script>
</body>
</html>
