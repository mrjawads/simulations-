<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation ‚Äî The Vitamin That Changed Everything</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#1a1a2e;color:#e0e0e0;overflow:hidden;height:100vh;}
#app{display:flex;height:100vh;width:100vw;}

/* LEFT SIDEBAR */
#left{width:280px;min-width:280px;background:linear-gradient(180deg,#1e1e3a,#16213e);border-right:2px solid #2a2a5a;display:flex;flex-direction:column;overflow-y:auto;}
#left::-webkit-scrollbar{width:6px;}
#left::-webkit-scrollbar-thumb{background:#444;border-radius:3px;}
.sidebar-header{padding:12px 14px 8px;font-size:15px;font-weight:700;color:#ffd54f;text-align:center;border-bottom:1px solid #2a2a5a;}
.scenario-list{padding:8px;flex:1;overflow-y:auto;}
.scenario-card{padding:10px 12px;margin-bottom:6px;border-radius:10px;cursor:pointer;transition:all .2s;border:2px solid transparent;background:rgba(255,255,255,.05);display:flex;align-items:center;gap:10px;font-size:13px;}
.scenario-card:hover{background:rgba(255,255,255,.12);border-color:#ffd54f55;}
.scenario-card.selected{background:rgba(255,215,0,.15);border-color:#ffd54f;box-shadow:0 0 12px rgba(255,215,0,.2);}
.scenario-card.completed{opacity:.85;cursor:default;}
.scenario-card.completed::after{content:'‚úÖ';margin-left:auto;font-size:14px;}
.sc-emoji{font-size:24px;min-width:30px;text-align:center;}
.sc-name{font-weight:600;line-height:1.3;}
.divider{height:1px;background:#2a2a5a;margin:10px 8px;}
.reading-lvl-section{padding:8px 12px;}
.reading-lvl-section h4{font-size:12px;color:#aaa;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;}
.reading-tabs{display:flex;gap:4px;}
.reading-tab{flex:1;padding:6px 0;text-align:center;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s;border:1px solid #444;}
.reading-tab.low{background:#2e7d32;color:#fff;border-color:#2e7d32;}
.reading-tab.med{background:#f57f17;color:#fff;border-color:#f57f17;}
.reading-tab.high{background:#c62828;color:#fff;border-color:#c62828;}
.reading-tab:not(.active){opacity:.4;}
.reading-tab.active{opacity:1;box-shadow:0 0 8px rgba(255,255,255,.3);}
.keywords-section{padding:8px 12px;}
.keywords-section h4{font-size:12px;color:#aaa;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;}
.keyword-tag{display:inline-block;padding:3px 8px;margin:2px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(255,255,255,.08);color:#bbb;transition:all .2s;}
.keyword-tag.active{background:rgba(76,175,80,.3);color:#81c784;border:1px solid #4caf50;}
.bottom-btns{padding:10px;display:flex;gap:6px;}
.btn-reset{flex:1;padding:8px;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px;background:#c62828;color:#fff;transition:all .2s;}
.btn-newrun{flex:1;padding:8px;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px;background:#1565c0;color:#fff;transition:all .2s;}
.btn-reset:hover,.btn-newrun:hover{transform:scale(1.03);filter:brightness(1.2);}

/* CENTER PANEL */
#center{flex:1;display:flex;flex-direction:column;background:linear-gradient(180deg,#0d1b2a,#1b2838);overflow:hidden;}
.title-bar{padding:10px 20px;background:linear-gradient(90deg,#1565c0,#7b1fa2);text-align:center;font-size:16px;font-weight:700;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.5);}
.step-tabs{display:flex;padding:8px 16px;gap:6px;background:rgba(0,0,0,.2);}
.step-tab{flex:1;text-align:center;padding:8px 4px;border-radius:8px;font-size:13px;font-weight:700;color:#666;background:rgba(255,255,255,.05);transition:all .3s;cursor:default;}
.step-tab.active{color:#ffd54f;background:rgba(255,215,0,.15);box-shadow:0 0 12px rgba(255,215,0,.25);animation:glow 2s ease-in-out infinite;}
.step-tab.done{color:#4caf50;background:rgba(76,175,80,.1);}
@keyframes glow{0%,100%{box-shadow:0 0 8px rgba(255,215,0,.2);}50%{box-shadow:0 0 20px rgba(255,215,0,.4);}}
.center-content{flex:1;display:flex;flex-direction:column;padding:16px;overflow-y:auto;position:relative;}
.center-content::-webkit-scrollbar{width:6px;}
.center-content::-webkit-scrollbar-thumb{background:#444;border-radius:3px;}

/* Welcome */
.welcome-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;gap:20px;}
.welcome-screen .big-emoji{font-size:80px;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-12px);}}
.welcome-screen h2{font-size:22px;color:#ffd54f;max-width:500px;}
.welcome-screen p{color:#aaa;font-size:14px;max-width:400px;line-height:1.5;}

/* PREDICT */
.predict-card{background:linear-gradient(135deg,#1a237e,#283593);border-radius:16px;padding:28px;text-align:center;max-width:600px;margin:auto;box-shadow:0 8px 32px rgba(0,0,0,.4);}
.predict-card h3{color:#ffd54f;font-size:20px;margin-bottom:16px;}
.predict-card p{color:#e0e0e0;font-size:16px;margin-bottom:20px;line-height:1.5;}
.predict-btns{display:flex;gap:12px;justify-content:center;}
.predict-btn{padding:14px 28px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:all .25s;min-width:180px;}
.predict-btn.toward{background:linear-gradient(135deg,#2e7d32,#4caf50);color:#fff;}
.predict-btn.away{background:linear-gradient(135deg,#c62828,#e53935);color:#fff;}
.predict-btn:hover{transform:scale(1.06);box-shadow:0 4px 20px rgba(0,0,0,.4);}
.predict-btn:disabled{opacity:.5;cursor:default;transform:none!important;box-shadow:none!important;}

/* READ */
.read-card{background:rgba(255,255,255,.06);border-radius:16px;padding:24px;max-width:680px;margin:0 auto;border:1px solid rgba(255,255,255,.1);}
.read-card h3{color:#64b5f6;font-size:18px;margin-bottom:14px;text-align:center;}
.passage-text{font-size:17px;line-height:1.75;color:#e8e8e8;text-align:left;}
.passage-text .kw{color:#81c784;font-weight:700;}
.passage-text .sent-highlight{background:rgba(255,215,0,.22);border-radius:4px;padding:1px 3px;transition:background .3s;}
.read-controls{display:flex;gap:10px;justify-content:center;margin-top:18px;}
.btn-action{padding:12px 28px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;background:linear-gradient(135deg,#1565c0,#42a5f5);color:#fff;}
.btn-action:hover{transform:scale(1.04);box-shadow:0 4px 16px rgba(21,101,192,.4);}
.btn-action:disabled{opacity:.5;cursor:default;transform:none!important;}
.btn-readaloud{padding:12px 20px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;background:linear-gradient(135deg,#6a1b9a,#ab47bc);color:#fff;}
.btn-readaloud:hover{transform:scale(1.04);}
.btn-readaloud.speaking{background:linear-gradient(135deg,#e65100,#ff9800);animation:pulse-speak 1s infinite;}
@keyframes pulse-speak{0%,100%{box-shadow:0 0 4px rgba(255,152,0,.3);}50%{box-shadow:0 0 16px rgba(255,152,0,.6);}}

/* WATCH */
.watch-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;}
.arena-wrap{position:relative;width:100%;max-width:700px;}
.arena-canvas{width:100%;border-radius:16px;display:block;box-shadow:0 8px 32px rgba(0,0,0,.5);}
.arena-hud{display:flex;gap:12px;width:100%;max-width:700px;align-items:center;}
.meter-wrap{flex:1;position:relative;}
.meter-zone-labels{display:flex;justify-content:space-between;font-size:10px;color:#888;margin-bottom:3px;padding:0 2px;}
.meter-outer{height:28px;background:#1a1a2a;border-radius:14px;overflow:hidden;border:2px solid #444;position:relative;}
.meter-inner{height:100%;border-radius:12px;transition:width 1.8s cubic-bezier(.4,0,.2,1);width:0%;position:relative;overflow:hidden;}
.meter-inner::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(255,255,255,.2),transparent);border-radius:12px;}
.meter-ok-zone{position:absolute;right:0;top:0;bottom:0;width:30%;background:rgba(76,175,80,.15);border-left:2px dashed rgba(76,175,80,.4);}
.body-icons-row{display:flex;gap:8px;}
.body-icon{width:54px;height:54px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:22px;background:rgba(0,0,0,.4);border:2px solid #444;transition:all .8s ease;}
.body-icon span{font-size:8px;color:#aaa;margin-top:1px;font-weight:700;text-transform:uppercase;}
.body-icon.ok{border-color:#4caf50;background:rgba(76,175,80,.2);box-shadow:0 0 14px rgba(76,175,80,.5);}
.body-icon.warn{border-color:#f9a825;background:rgba(249,168,37,.15);box-shadow:0 0 10px rgba(249,168,37,.4);}
.body-icon.bad{border-color:#ef5350;background:rgba(239,83,80,.2);box-shadow:0 0 14px rgba(239,83,80,.5);animation:pulse-red 1s ease-in-out infinite;}
@keyframes pulse-red{0%,100%{box-shadow:0 0 8px rgba(239,83,80,.3);}50%{box-shadow:0 0 22px rgba(239,83,80,.7);}}
.phase-label{text-align:center;font-size:15px;font-weight:700;color:#ffd54f;min-height:22px;text-shadow:0 1px 6px rgba(0,0,0,.6);transition:opacity .4s;}

/* RECORD */
.record-card{background:linear-gradient(135deg,#1b5e20,#2e7d32);border-radius:16px;padding:28px;text-align:center;max-width:500px;margin:auto;box-shadow:0 8px 32px rgba(0,0,0,.4);}
.record-card h3{color:#fff;font-size:22px;margin-bottom:10px;}
.record-card p{color:#c8e6c9;font-size:15px;margin-bottom:16px;}

/* RIGHT SIDEBAR */
#right{width:280px;min-width:280px;background:linear-gradient(180deg,#1e1e3a,#16213e);border-left:2px solid #2a2a5a;display:flex;flex-direction:column;overflow-y:auto;}
#right::-webkit-scrollbar{width:6px;}
#right::-webkit-scrollbar-thumb{background:#444;border-radius:3px;}
.progress-header{padding:12px 14px 8px;font-size:15px;font-weight:700;color:#64b5f6;text-align:center;border-bottom:1px solid #2a2a5a;}
.hud-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:10px;}
.hud-stat{background:rgba(255,255,255,.06);border-radius:10px;padding:10px 8px;text-align:center;}
.hud-stat .val{font-size:22px;font-weight:800;color:#ffd54f;}
.hud-stat .lbl{font-size:10px;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}
.progress-bar-wrap{padding:0 12px;margin:8px 0;}
.progress-bar-outer{height:14px;background:#222;border-radius:7px;overflow:hidden;border:1px solid #444;}
.progress-bar-inner{height:100%;background:linear-gradient(90deg,#4caf50,#81c784);border-radius:6px;transition:width .5s;width:0%;}
.progress-msg{text-align:center;font-size:12px;color:#aaa;padding:4px 12px 8px;}
.data-header{padding:8px 12px;font-size:14px;font-weight:700;color:#64b5f6;border-top:1px solid #2a2a5a;display:flex;justify-content:space-between;align-items:center;}
.btn-copy{padding:4px 10px;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;background:#ffd54f;color:#222;transition:all .2s;}
.btn-copy:hover{background:#ffee58;}
.data-table-wrap{flex:1;overflow-y:auto;padding:0 8px 8px;}
.data-table{width:100%;border-collapse:collapse;font-size:10px;}
.data-table th{background:#2a2a5a;color:#aaa;padding:5px 4px;text-align:left;position:sticky;top:0;font-size:9px;text-transform:uppercase;z-index:1;}
.data-table td{padding:5px 4px;border-bottom:1px solid #2a2a5a;color:#ccc;vertical-align:top;font-size:10px;line-height:1.3;}
.data-table tr:nth-child(even) td{background:rgba(255,255,255,.02);}
.data-table tr.new-row td{animation:row-flash .8s;}
@keyframes row-flash{0%{background:rgba(255,215,0,.3);}100%{background:transparent;}}

/* Banners */
.completion-banner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1b5e20,#2e7d32);padding:40px 60px;border-radius:20px;text-align:center;z-index:100;box-shadow:0 12px 48px rgba(0,0,0,.6);animation:pop-in .4s;display:none;}
.completion-banner h2{color:#ffd54f;font-size:28px;margin-bottom:10px;}
.completion-banner p{color:#c8e6c9;font-size:16px;}
.completion-banner .badge{font-size:64px;margin-bottom:12px;}
@keyframes pop-in{from{transform:translate(-50%,-50%) scale(.7);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}
.overlay-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:99;display:none;cursor:pointer;}
.close-banner{margin-top:16px;padding:10px 24px;border:none;border-radius:8px;background:#ffd54f;color:#222;font-weight:700;font-size:14px;cursor:pointer;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.fade-in{animation:fadeIn .4s ease-out;}
</style>
</head>
<body>
<div id="app">
<div id="left">
<div class="sidebar-header">Pick Any 5 You Like üî¨<br><span style="font-size:11px;color:#aaa;font-weight:400;">8 scenarios ‚Äî 5 required</span></div>
<div class="scenario-list" id="scenarioList"></div>
<div class="divider"></div>
<div class="reading-lvl-section">
<h4>Reading Level</h4>
<div class="reading-tabs">
<div class="reading-tab low active" onclick="setLevel('low')">Low</div>
<div class="reading-tab med" onclick="setLevel('med')">Med</div>
<div class="reading-tab high" onclick="setLevel('high')">High</div>
</div>
</div>
<div class="divider"></div>
<div class="keywords-section">
<h4>Key Words</h4>
<div id="keywordTags"></div>
</div>
<div class="divider"></div>
<div class="bottom-btns">
<button class="btn-reset" onclick="resetSim()">Reset</button>
<button class="btn-newrun" onclick="newRun()">New Run</button>
</div>
</div>
<div id="center">
<div class="title-bar">Mr. Jawad Simulation ‚Äî The Vitamin That Changed Everything</div>
<div class="step-tabs">
<div class="step-tab" id="tab-predict">1. PREDICT</div>
<div class="step-tab" id="tab-read">2. READ</div>
<div class="step-tab" id="tab-watch">3. WATCH</div>
<div class="step-tab" id="tab-record">4. RECORD</div>
</div>
<div class="center-content" id="centerContent">
<div class="welcome-screen" id="welcomeScreen">
<div class="big-emoji">ü•£üíäüî¨</div>
<h2>A vitamin hidden in your breakfast cereal once killed 100,000 Americans</h2>
<p>Pick any scenario from the left sidebar to start investigating. Each one reveals a new piece of the niacin puzzle. Complete 5 for full credit ‚Äî all 8 for extra credit!</p>
</div>
</div>
</div>
<div id="right">
<div class="progress-header">Progress</div>
<div class="hud-grid">
<div class="hud-stat"><div class="val" id="hudScore">0</div><div class="lbl">Score</div></div>
<div class="hud-stat"><div class="val" id="hudStreak">0</div><div class="lbl">Streak</div></div>
<div class="hud-stat"><div class="val" id="hudCompleted">0/8</div><div class="lbl">Done</div></div>
<div class="hud-stat"><div class="val" id="hudAccuracy">--%</div><div class="lbl">Accuracy</div></div>
</div>
<div class="progress-bar-wrap">
<div class="progress-bar-outer"><div class="progress-bar-inner" id="progressBar"></div></div>
</div>
<div class="progress-msg" id="progressMsg">Pick 5 scenarios you like!</div>
<div class="data-header">
<span>Data Table</span>
<button class="btn-copy" id="copyBtn" onclick="copyTable()">üìã Copy Table</button>
</div>
<div class="data-table-wrap">
<table class="data-table">
<thead><tr><th>Scenario</th><th>What Changed?</th><th>System Response</th><th>Back Toward OK?</th></tr></thead>
<tbody id="dataBody"></tbody>
</table>
</div>
</div>
</div>
<div class="overlay-bg" id="overlayBg" onclick="closeBanner()"></div>
<div class="completion-banner" id="requiredBanner">
<div class="badge">üèÜ</div><h2>Required Complete!</h2><p>You finished 5 scenarios! Continue for Extra Credit?</p>
<button class="close-banner" onclick="closeBanner()">Keep Going!</button>
</div>
<div class="completion-banner" id="ecBanner">
<div class="badge">‚≠ê</div><h2>Extra Credit Complete!</h2><p>All 8 scenarios investigated! Amazing work!</p>
<button class="close-banner" onclick="closeBanner()">Close</button>
</div>

<script>
"use strict";

// Global error handler ‚Äî prevents any uncaught error from crashing the page
window.onerror=function(msg,src,line,col,err){console.warn('Caught error:',msg,'at line',line);return true;};
window.addEventListener('unhandledrejection',function(e){e.preventDefault();console.warn('Caught promise rejection:',e.reason);});

/* ================================================================
   SCENARIO DATA
   ================================================================ */
const SCENARIOS=[
{id:1,name:"Your Cereal Box",emoji:"ü•£",direction:"toward",
whatChanged:"Fortification law adds niacin to grain",
sysResponse:"Meter rises to OK; skin, gut, brain light green",
backOK:"Yes ‚Äî meter moved into OK zone",
meterEnd:85,bodyEnd:[2,2,2],
readings:{
low:{text:'You have probably seen the word <span class="kw">niacin</span> on a cereal box. In 1942, a law forced companies to add this <span class="kw">nutrient</span> back into all flour, bread, and cereal. A <span class="kw">deficiency</span> of <span class="kw">niacin</span> was killing 7,000 Americans every year. Once <span class="kw">fortification</span> started, the disease almost disappeared within ten years.'},
med:{text:'You have probably seen the word <span class="kw">niacin</span> on a cereal box \u2014 that tiny line of text exists because of a deadly epidemic. Before 1942, a <span class="kw">deficiency</span> (not getting enough) of this single <span class="kw">nutrient</span> caused a disease called pellagra that killed 7,000 Americans every single year. Their skin cracked, their stomachs failed, and their brains shut down \u2014 all because the <span class="kw">niacin</span> in their corn had been stripped out by machines. The government passed a <span class="kw">fortification</span> (adding nutrients back in) law requiring companies to add <span class="kw">niacin</span> back into flour, bread, and cereal. Within a decade, pellagra nearly vanished \u2014 and your breakfast this morning proved the fix still works.'},
high:{text:'You have probably seen the word <span class="kw">niacin</span> on a cereal box \u2014 that tiny line of text exists because of a deadly epidemic most people have never heard of. Before 1942, a <span class="kw">deficiency</span> (not getting enough) of this single <span class="kw">nutrient</span> caused a disease called pellagra that killed at least 7,000 Americans every year across fifteen states. Their skin cracked open in the sun, their digestive systems failed, their brains shut down \u2014 and doctors argued for decades about the cause. The answer turned out to be simple: industrial machines had stripped <span class="kw">niacin</span> out of corn, and poverty kept people from eating anything else. In 1942, the government passed a <span class="kw">fortification</span> (adding nutrients back in) law requiring companies to add <span class="kw">niacin</span> back into all flour, bread, and cereal. The <span class="kw">nutrient</span> was now <span class="kw">bioavailable</span> (the body could actually absorb it) in every grain product on the shelf. Within ten years, pellagra nearly disappeared, and your breakfast this morning is quiet proof that the fix still works.'}}},
{id:2,name:"The Ancient Recipe",emoji:"üåΩ",direction:"toward",
whatChanged:"Ash water treatment unlocks niacin in corn",
sysResponse:"Meter rises to OK; body icons light green",
backOK:"Yes ‚Äî treated corn made niacin bioavailable",
meterEnd:80,bodyEnd:[2,2,2],
readings:{
low:{text:'Three thousand years ago, people in Mexico soaked corn in ash water before cooking it. That step unlocked the <span class="kw">niacin</span> trapped inside and made it <span class="kw">bioavailable</span>. When Europeans brought corn home but skipped the soaking, <span class="kw">deficiency</span> diseases spread fast. The <span class="kw">processing</span> method made all the difference between health and disease.'},
med:{text:'Three thousand years ago, people in Mexico discovered something brilliant: soak corn in ash water before cooking it. That one step of <span class="kw">processing</span> (how you prepare food) breaks open the corn. It makes the <span class="kw">niacin</span> inside <span class="kw">bioavailable</span> (the body can actually absorb it) instead of passing it straight through. They ate corn every day and stayed perfectly healthy. When Spanish explorers brought corn to Europe but skipped the soaking, pellagra swept across Italy, Spain, and France for two hundred years. Millions of people ate corn thinking it was good food, never knowing the <span class="kw">niacin</span> was locked inside and their bodies were starving for it.'},
high:{text:'Three thousand years ago, people in Mexico and Central America discovered something that would save millions of lives: soak corn in ash water before cooking it. This <span class="kw">processing</span> (how you prepare food) step \u2014 called nixtamalization \u2014 breaks the corn\u2019s outer shell and makes the <span class="kw">niacin</span> locked inside <span class="kw">bioavailable</span> (the body can actually absorb it). Indigenous peoples ate corn as their main food for centuries and never developed <span class="kw">deficiency</span> diseases. When Spanish colonizers brought corn back to Europe, they took the grain but ignored the soaking step. Within decades, a disease called pellagra exploded across Italy, Spain, and France, killing thousands every year. Doctors in Europe had no idea the cause was sitting in their kitchens \u2014 the corn looked the same, tasted fine, and seemed like perfectly good food. The only difference was one missing step of <span class="kw">processing</span> that determined whether the <span class="kw">niacin</span> fed the body or passed straight through it.'}}},
{id:3,name:"The Machine",emoji:"‚öôÔ∏è",direction:"away",
whatChanged:"Degerminator strips 90% of niacin from corn",
sysResponse:"Meter drops to Dangerous; skin icon turns red",
backOK:"No ‚Äî niacin stripped, nothing replaced it",
meterEnd:12,bodyEnd:[0,0,1],
readings:{
low:{text:'In 1901, a new machine called the degerminator changed corn forever. It ripped out the part of the kernel where most of the <span class="kw">niacin</span> hides. The <span class="kw">processing</span> cut the <span class="kw">nutrient</span> by 90 percent. Within a few years, tens of thousands of people developed a deadly <span class="kw">deficiency</span>.'},
med:{text:'In 1901, a company in Illinois invented a machine that would accidentally start an epidemic. The Beall degerminator strips the germ out of every corn kernel so the cornmeal lasts longer on store shelves. The problem is that the germ is exactly where most of the <span class="kw">niacin</span> lives. That one <span class="kw">processing</span> (how the food is prepared) step cuts the <span class="kw">nutrient</span> content by up to 90 percent. Within a few years, pellagra cases in the South surged from almost zero to tens of thousands per year. The same machine still mills 90 percent of the world\u2019s corn \u2014 but now <span class="kw">fortification</span> (adding nutrients back in) adds the <span class="kw">niacin</span> back.'},
high:{text:'In 1901, an Illinois company patented a machine that solved one problem and accidentally created a catastrophe. The Beall degerminator strips the germ \u2014 the tiny nutrient-rich core \u2014 out of every corn kernel so the cornmeal stays fresh on store shelves for months instead of weeks. What nobody realized was that the germ holds up to 90 percent of the corn\u2019s <span class="kw">niacin</span>. That one <span class="kw">processing</span> (how the food is prepared) step destroyed almost all of the <span class="kw">nutrient</span> that kept people healthy. Cheap degermed cornmeal flooded the South, where millions of poor families ate corn at nearly every meal. Pellagra surged to tens of thousands of cases per year \u2014 skin cracking, stomachs failing, minds breaking. All of it traced to a <span class="kw">deficiency</span> (not getting enough) of one vitamin a machine had quietly removed. The same technology still mills most of the world\u2019s corn, but now <span class="kw">fortification</span> (adding nutrients back in) laws add the <span class="kw">niacin</span> back, making it <span class="kw">bioavailable</span> (the body can absorb it).'}}},
{id:4,name:"The Blocked Gut",emoji:"üö´",direction:"away",
whatChanged:"Damaged gut blocks niacin absorption",
sysResponse:"Meter stays in Deficient; gut icon red",
backOK:"No ‚Äî niacin present but not bioavailable",
meterEnd:25,bodyEnd:[1,0,1],
readings:{
low:{text:'Some people eat food with <span class="kw">niacin</span> in it but still get sick. Heavy alcohol use damages the gut lining so badly that the <span class="kw">nutrient</span> passes straight through. The <span class="kw">niacin</span> is in the food, but it is not <span class="kw">bioavailable</span>. This is why pellagra still shows up even in countries with <span class="kw">fortification</span> laws.'},
med:{text:'Even in countries where <span class="kw">fortification</span> (adding nutrients back in) puts <span class="kw">niacin</span> in every loaf of bread, some people still get pellagra. Heavy alcohol use wrecks the gut lining \u2014 the thin layer of cells that absorbs <span class="kw">nutrients</span> from food into the blood. When that lining is damaged, <span class="kw">niacin</span> passes straight through the digestive system without ever being absorbed. The vitamin is technically in the food, but it is not <span class="kw">bioavailable</span> (the body cannot use it) because the body\u2019s lock is broken. Certain illnesses like Crohn\u2019s disease and some medications can block absorption the same way. The result is a <span class="kw">deficiency</span> (not getting enough) even when the diet looks fine on paper.'},
high:{text:'Here is a puzzle: a person eats fortified bread and cereal every day \u2014 food with <span class="kw">niacin</span> printed right on the label \u2014 and still develops pellagra. The answer is that the <span class="kw">nutrient</span> (substance the body needs) is in the food, but the body cannot absorb it. Chronic alcohol use destroys the gut lining \u2014 the thin wall of cells responsible for pulling <span class="kw">nutrients</span> out of food and into the bloodstream. When that lining is too damaged, <span class="kw">niacin</span> passes straight through the digestive system like water through a broken pipe. The vitamin is present but not <span class="kw">bioavailable</span> (the body cannot use it) \u2014 the absorption system has shut down. This is why doctors still see pellagra today, even in countries with strict <span class="kw">fortification</span> (added nutrients) laws. Crohn\u2019s disease and certain medications can damage the gut lining the same way, causing a <span class="kw">deficiency</span> (not getting enough) that has nothing to do with diet. The <span class="kw">processing</span> of the food was fine \u2014 the problem was inside the body all along.'}}},
{id:5,name:"The 4 Ds",emoji:"üíÄ",direction:"away",
whatChanged:"Niacin drops to zero; body fails system by system",
sysResponse:"Skin\u2192Gut\u2192Brain fail in order (4 Ds)",
backOK:"Only if niacin restored in time",
meterEnd:8,bodyEnd:[0,0,0],
readings:{
low:{text:'When <span class="kw">niacin</span> drops to zero, the body breaks down in a specific order called the 4 Ds. First comes dermatitis \u2014 red, cracking skin where the sun hits. Then diarrhea and dementia as the gut and brain fail. If a person gets enough <span class="kw">niacin</span> in time, the <span class="kw">deficiency</span> reverses within days.'},
med:{text:'Doctors have a grim name for what happens when the body runs out of <span class="kw">niacin</span>: the 4 Ds. First comes dermatitis \u2014 skin cracks and peels in a butterfly pattern across the face and hands, worst wherever the sun hits. Next is diarrhea, because the gut lining replaces its cells faster than almost any other tissue, and without <span class="kw">niacin</span>, those cells cannot rebuild. Then dementia takes hold as the brain \u2014 which burns more energy than any other organ \u2014 loses the <span class="kw">nutrient</span> it needs to send signals. The final D is death, the result of total system <span class="kw">deficiency</span> (not getting enough of a nutrient) with no recovery. The order is not random: the body parts that replace cells fastest break down first when the fuel runs out.'},
high:{text:'Doctors gave pellagra a brutal nickname: the disease of the 4 Ds. First comes dermatitis \u2014 the skin cracks, peels, and turns dark red in a butterfly pattern across the face and hands, worst wherever sunlight hits. Next is diarrhea, because the cells lining the gut replace themselves every few days, and without <span class="kw">niacin</span> those new cells cannot form \u2014 the lining falls apart. Then dementia sets in as the brain, which burns more energy than any organ in the body, loses the <span class="kw">nutrient</span> that powers its chemical signals. The fourth D is death, the end point of total <span class="kw">deficiency</span> (not getting enough) with no treatment. The order is not random \u2014 it reveals exactly how the body prioritizes <span class="kw">niacin</span>. Cells that replace themselves fastest \u2014 skin and gut \u2014 fail first because they need the most constant fuel. The brain holds out longest but eventually breaks down too \u2014 which is why some pellagra patients were locked in asylums when the real problem was a missing vitamin.'}}},
{id:6,name:"Malawi Today",emoji:"üåç",direction:"toward",
whatChanged:"Families eat untreated corn; health workers teach ash soak",
sysResponse:"Meter starts Deficient; rises after treatment",
backOK:"Yes ‚Äî ash water processing restores bioavailability",
meterEnd:70,bodyEnd:[2,2,1],
readings:{
low:{text:'Right now in Malawi, doctors still see the same pellagra symptoms from a century ago. Families eat mostly untreated corn, so the <span class="kw">niacin</span> stays locked inside the grain. The body develops a <span class="kw">deficiency</span> because the <span class="kw">nutrient</span> is not <span class="kw">bioavailable</span>. Health workers are teaching a 3,000-year-old <span class="kw">processing</span> fix: soak the corn in ash water.'},
med:{text:'In Malawi, dried corn porridge is the main food for most families. Doctors still see hundreds of pellagra cases there every year \u2014 the same symptoms from a century ago. The pattern looks a lot like the American South: people eat untreated corn with almost no other food. The <span class="kw">niacin</span> stays locked, so the body develops a <span class="kw">deficiency</span> (not getting enough) of this <span class="kw">nutrient</span> (substance the body needs). The fix is the same: health workers teach families to soak corn in ash water before cooking. That one <span class="kw">processing</span> (food preparation) step makes the <span class="kw">niacin</span> <span class="kw">bioavailable</span> (the body can use it).'},
high:{text:'In Malawi, a country in southeastern Africa, dried corn porridge called nsima is the center of nearly every meal for most families. Doctors there still diagnose hundreds of pellagra cases every year \u2014 the same cracking skin, diarrhea, and confusion that swept across the American South more than a century ago. The biology is identical: families eat mostly untreated corn, so the <span class="kw">niacin</span> stays locked inside the grain and passes through the body. The <span class="kw">nutrient</span> (substance the body needs) is in the food but not <span class="kw">bioavailable</span> (the body cannot use it), creating a <span class="kw">deficiency</span> (not getting enough). Health workers are teaching families a <span class="kw">processing</span> (food preparation) technique from 3,000 years ago: soak the corn in ash water. This simple step breaks the grain open and frees the <span class="kw">niacin</span> so the body can use it \u2014 no factory, no pills, just a handful of ash. The science has not changed in three millennia \u2014 what changed was whether people knew to use it.'}}},
{id:7,name:"Niacin Budget",emoji:"‚ö°",direction:"toward",
whatChanged:"Different foods fill or fail daily niacin need",
sysResponse:"Diverse food fills meter; cornmeal leaves it red",
backOK:"Depends ‚Äî diverse diet yes, corn-only no",
meterEnd:75,bodyEnd:[2,2,1],
readings:{
low:{text:'Your body needs <span class="kw">niacin</span> every single day to keep your skin, gut, and brain working. Chicken and tuna give you plenty of this <span class="kw">nutrient</span>. Degermed cornmeal gives you almost nothing because <span class="kw">processing</span> stripped the <span class="kw">niacin</span> out. The difference between health and <span class="kw">deficiency</span> is whether your daily food fills that need.'},
med:{text:'Every cell in your body runs on <span class="kw">niacin</span> \u2014 it turns food into energy, rebuilds skin, and sends brain signals. You need about 15 milligrams of this <span class="kw">nutrient</span> (substance the body needs) every day to keep all of those systems running. A chicken breast delivers almost enough and a can of tuna packs more than a full day\u2019s worth, so one serving can nearly cover you. A bowl of degermed cornmeal delivers almost nothing because the <span class="kw">processing</span> (how the food is prepared) that makes it shelf-stable strips the <span class="kw">niacin</span> out. When your daily intake drops below the minimum, the body starts shutting down systems in order \u2014 skin first, then gut, then brain. The <span class="kw">deficiency</span> (not getting enough) is not about one bad meal \u2014 it is about missing <span class="kw">niacin</span> day after day.'},
high:{text:'<span class="kw">Niacin</span> powers over 400 chemical reactions in every cell \u2014 turning food into energy, rebuilding skin, replacing gut lining, and sending brain signals. You need about 15 milligrams of this <span class="kw">nutrient</span> (substance the body needs) every single day to keep all of those processes running. A chicken breast delivers about 10 mg, and a can of tuna packs over 20 mg \u2014 one serving and you are covered. A bowl of degermed cornmeal delivers almost nothing because industrial <span class="kw">processing</span> (how the food is prepared) stripped out the part of the kernel where <span class="kw">niacin</span> lives. Your body can also make its own <span class="kw">niacin</span> from a building block called tryptophan, found in meat, eggs, and dairy. That is why a diverse diet prevents <span class="kw">deficiency</span> (not getting enough) even when the corn is bad. When daily intake drops below the minimum day after day, the body starts shutting down the systems that burn <span class="kw">niacin</span> fastest \u2014 skin cells first, gut lining next, brain last. That is exactly the pattern of the 4 Ds, and it only reverses when the <span class="kw">nutrient</span> is <span class="kw">bioavailable</span> (the body can absorb it) again.'}}},
{id:8,name:"Food Desert",emoji:"üè™",direction:"toward",
whatChanged:"Limited food access reduces nutrient variety",
sysResponse:"Meter reaches Low but not OK; icons dim yellow",
backOK:"Partially ‚Äî fortification helps but not enough",
meterEnd:42,bodyEnd:[1,1,1],
readings:{
low:{text:'Some neighborhoods have no stores selling fresh meat, eggs, or vegetables. People there eat cheap processed food that has <span class="kw">fortification</span> \u2014 added <span class="kw">niacin</span>. That prevents the worst <span class="kw">deficiency</span>, but the diet still misses many <span class="kw">nutrients</span>. The pattern is less extreme than pellagra, but the biology is the same.'},
med:{text:'Neighborhoods without fresh meat, eggs, or vegetables are called food deserts \u2014 and the pattern looks a lot like the 1900s South. People in these communities often rely on cheap processed foods that are fortified by law with <span class="kw">niacin</span> and other <span class="kw">nutrients</span> (substances the body needs). That <span class="kw">fortification</span> (adding nutrients back in) prevents the worst outcome: full-blown pellagra is rare because the basic <span class="kw">deficiency</span> (not getting enough) is covered. But a diet built mostly on processed food still misses the full range of vitamins and minerals that come from fresh, diverse meals. The body gets enough <span class="kw">niacin</span> to avoid the 4 Ds, but not enough of everything else to thrive. Pellagra showed the extreme end of limited food access \u2014 now science asks what happens at the less extreme end.'},
high:{text:'Neighborhoods without fresh meat, eggs, or vegetables are called food deserts \u2014 and the nutritional pattern looks a lot like the 1900s South. In these communities, people often depend on cheap processed foods that are fortified by law, meaning <span class="kw">niacin</span> and other <span class="kw">nutrients</span> (substances the body needs) have been added back in. That <span class="kw">fortification</span> (adding nutrients back in) prevents the extreme outcome: full-blown pellagra is rare today because the basic <span class="kw">deficiency</span> (not getting enough) is covered. But <span class="kw">fortification</span> only adds back certain vitamins \u2014 it does not replace the full range of <span class="kw">nutrients</span> that come from fresh, diverse meals. The body gets enough <span class="kw">niacin</span> to avoid the 4 Ds, but not enough of everything else to operate at full strength. Food deserts form when grocery stores close or never open in low-income areas, leaving corner stores and fast food as the main options \u2014 a pattern driven by economics, not biology. The pellagra epidemic proved that when food access collapses completely, biology hits back with deadly force. Modern nutrition science asks a harder question: what happens when food access is limited \u2014 not enough to cause a named disease, but enough to keep the body below its best?'}}}
];

const KEYWORDS=["niacin","deficiency","nutrient","bioavailable","processing","fortification"];

/* ================================================================
   STATE + TIMER MANAGEMENT
   ================================================================ */
let state={currentScenario:null,currentStep:null,readingLevel:'low',completed:new Set(),predictions:{},score:0,streak:0,correctPredictions:0,totalPredictions:0,dataRows:[],speechActive:false,speechResumeInterval:null};
let animTimers=[];   // track all animation timeouts so we can cancel
let animFrame=null;  // requestAnimationFrame id
let canvasCtx=null;
let canvasW=700,canvasH=360;

function clearAllTimers(){
  animTimers.forEach(t=>{try{clearTimeout(t);}catch(e){}});
  animTimers=[];
  if(animFrame){try{cancelAnimationFrame(animFrame);}catch(e){}}
  animFrame=null;
}
function safeTimeout(fn,ms){const t=setTimeout(()=>{try{fn();}catch(e){console.warn('Timer error:',e);}},ms);animTimers.push(t);return t;}

/* ================================================================
   INIT + RENDERING
   ================================================================ */
function init(){renderScenarioList();renderKeywords();updateHUD();}

function renderScenarioList(){
  const list=document.getElementById('scenarioList');
  list.innerHTML='';
  SCENARIOS.forEach(s=>{
    const card=document.createElement('div');
    card.className='scenario-card'+(state.completed.has(s.id)?' completed':'')+(state.currentScenario&&state.currentScenario.id===s.id?' selected':'');
    card.innerHTML='<span class="sc-emoji">'+s.emoji+'</span><span class="sc-name">'+s.name+'</span>';
    card.onclick=()=>selectScenario(s);
    list.appendChild(card);
  });
}

function renderKeywords(activeWords){
  const c=document.getElementById('keywordTags');c.innerHTML='';
  KEYWORDS.forEach(kw=>{
    const t=document.createElement('span');
    t.className='keyword-tag'+(activeWords&&activeWords.has(kw)?' active':'');
    t.textContent=kw;c.appendChild(t);
  });
}

function setLevel(level){
  if(state.currentStep==='read'||state.currentStep==='watch'||state.currentStep==='record')return;
  state.readingLevel=level;
  document.querySelectorAll('.reading-tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('.reading-tab.'+level).classList.add('active');
  if(state.currentStep==='predict'&&state.currentScenario)showPredict();
}

function selectScenario(scenario){
  if(state.completed.has(scenario.id))return;
  if(state.currentStep==='read'||state.currentStep==='watch')return;
  clearAllTimers();stopSpeech();
  state.currentScenario=scenario;state.currentStep='predict';
  renderScenarioList();
  const passageText=scenario.readings[state.readingLevel].text;
  const activeKW=new Set();
  KEYWORDS.forEach(kw=>{if(passageText.toLowerCase().includes(kw.toLowerCase()))activeKW.add(kw);});
  renderKeywords(activeKW);
  updateTabs();showPredict();
}

function updateTabs(){
  const steps=['predict','read','watch','record'];
  steps.forEach(s=>{document.getElementById('tab-'+s).className='step-tab';});
  if(state.currentStep){
    document.getElementById('tab-'+state.currentStep).classList.add('active');
    const idx=steps.indexOf(state.currentStep);
    for(let i=0;i<idx;i++)document.getElementById('tab-'+steps[i]).classList.add('done');
  }
}

/* ================================================================
   PREDICT
   ================================================================ */
function showPredict(){
  state.currentStep='predict';updateTabs();
  const s=state.currentScenario,content=document.getElementById('centerContent');
  content.innerHTML='<div class="predict-card fade-in"><h3>'+s.emoji+' '+s.name+'</h3><p>Will the niacin level move <strong>toward</strong> the OK zone or <strong>away</strong> from it?</p><div class="predict-btns"><button class="predict-btn toward" id="btnToward" onclick="makePrediction(\'toward\')">‚¨ÜÔ∏è Toward OK</button><button class="predict-btn away" id="btnAway" onclick="makePrediction(\'away\')">‚¨áÔ∏è Away from OK</button></div></div>';
}

function makePrediction(choice){
  // Prevent double click
  const b1=document.getElementById('btnToward'),b2=document.getElementById('btnAway');
  if(b1)b1.disabled=true;if(b2)b2.disabled=true;
  state.predictions[state.currentScenario.id]=choice;
  state.totalPredictions++;
  if(choice===state.currentScenario.direction){state.correctPredictions++;state.score+=100;state.streak++;}
  else{state.streak=0;state.score+=25;}
  updateHUD();
  safeTimeout(()=>showRead(),300);
}

/* ================================================================
   READ + READ ALOUD
   ================================================================ */
function showRead(){
  state.currentStep='read';updateTabs();
  const s=state.currentScenario,reading=s.readings[state.readingLevel];
  const content=document.getElementById('centerContent');
  content.innerHTML='<div class="read-card fade-in"><h3>'+s.emoji+' '+s.name+'</h3><div class="passage-text" id="passageText">'+reading.text+'</div><div class="read-controls"><button class="btn-readaloud" id="btnReadAloud" onclick="toggleReadAloud()">üîä Read Aloud</button><button class="btn-action" id="btnNextWatch" onclick="showWatch()">Next \u2192 Watch</button></div></div>';
}

function toggleReadAloud(){
  try{
    if(!('speechSynthesis' in window)){return;}
    if(state.speechActive){stopSpeech();return;}
    const passageEl=document.getElementById('passageText');
    if(!passageEl)return;
    const rawText=passageEl.innerText;
    const sentences=rawText.match(/[^.!?]+[.!?]+/g)||[rawText];
    let idx=0;
    state.speechActive=true;
    const btn=document.getElementById('btnReadAloud');
    if(btn){btn.textContent='‚èπ Stop';btn.classList.add('speaking');}

    // Chrome 15-sec resume workaround
    state.speechResumeInterval=setInterval(()=>{try{if(window.speechSynthesis.speaking)window.speechSynthesis.resume();}catch(e){}},10000);

    function speakNext(){
      if(idx>=sentences.length||!state.speechActive){stopSpeech();return;}
      const utt=new SpeechSynthesisUtterance(sentences[idx].trim());
      utt.rate=0.9;
      utt.onend=()=>{idx++;speakNext();};
      utt.onerror=()=>{idx++;speakNext();};
      // Highlight current sentence
      try{
        const spans=passageEl.querySelectorAll('.sent-highlight');
        spans.forEach(sp=>{
          const parent=sp.parentNode;
          parent.replaceChild(document.createTextNode(sp.textContent),sp);
          parent.normalize();
        });
      }catch(e){}
      try{
        const textContent=passageEl.innerHTML;
        const sentText=sentences[idx].trim();
        // Find approximate match in innerHTML (strip tags for matching)
        const plainSent=sentText.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        // Just highlight by finding the text node
      }catch(e){}
      window.speechSynthesis.speak(utt);
    }
    speakNext();
  }catch(e){stopSpeech();}
}

function stopSpeech(){
  try{window.speechSynthesis.cancel();}catch(e){}
  state.speechActive=false;
  if(state.speechResumeInterval){clearInterval(state.speechResumeInterval);state.speechResumeInterval=null;}
  const btn=document.getElementById('btnReadAloud');
  if(btn){btn.textContent='üîä Read Aloud';btn.classList.remove('speaking');}
}

/* ================================================================
   WATCH ‚Äî CANVAS-BASED ARENA
   ================================================================ */
function showWatch(){
  clearAllTimers();stopSpeech();
  state.currentStep='watch';updateTabs();
  const s=state.currentScenario,content=document.getElementById('centerContent');
  // Measure available width
  const cw=document.getElementById('center').clientWidth-32;
  canvasW=Math.min(700,cw);canvasH=Math.round(canvasW*0.514);

  content.innerHTML='<div class="watch-area fade-in">'+
    '<div class="phase-label" id="phaseLabel"></div>'+
    '<div class="arena-wrap"><canvas id="arenaCanvas" class="arena-canvas" width="'+canvasW+'" height="'+canvasH+'"></canvas></div>'+
    '<div class="arena-hud">'+
      '<div class="meter-wrap">'+
        '<div class="meter-zone-labels"><span>Dangerous</span><span>Deficient</span><span>Low</span><span style="color:#4caf50;">OK Zone</span></div>'+
        '<div class="meter-outer"><div class="meter-ok-zone"></div><div class="meter-inner" id="meterInner"></div></div>'+
      '</div>'+
      '<div class="body-icons-row">'+
        '<div class="body-icon" id="biSkin"><div>üß¥</div><span>Skin</span></div>'+
        '<div class="body-icon" id="biGut"><div>ü´Å</div><span>Gut</span></div>'+
        '<div class="body-icon" id="biBrain"><div>üß†</div><span>Brain</span></div>'+
      '</div>'+
    '</div>'+
    '<button class="btn-action" id="watchNextBtn" onclick="finishWatch()" disabled style="opacity:.4;">Next \u2192 Record</button>'+
  '</div>';

  const canvas=document.getElementById('arenaCanvas');
  if(!canvas)return;
  canvasCtx=canvas.getContext('2d');
  runCanvasAnimation(s);
}

/* ---- Canvas animation engine ---- */
function runCanvasAnimation(scenario){
  const ctx=canvasCtx;if(!ctx)return;
  const W=canvasW,H=canvasH;
  let phase=0; // 0=initial, 1=change, 2=result
  let t=0; // animation time in ms
  const startTime=performance.now();
  const particles=[];
  const labels=[];
  const startMeter=scenario.direction==='toward'?15:75;

  // Set initial meter + body
  setMeterWidth(startMeter);
  const initBody=scenario.direction==='toward'?[0,0,1]:[2,2,2];
  setBodyIcons(initBody);

  // Phase timing
  const PHASE1_END=2000,PHASE2_END=5000,PHASE3_END=7500,BTN_SHOW=6500;

  // Color palette
  const BG_TOP='#0a1628',BG_BOT='#111d35';
  const GREEN='#4caf50',RED='#ef5350',GOLD='#ffd54f',BLUE='#42a5f5',PURPLE='#ab47bc',ORANGE='#ff9800';

  // Scenario-specific visual config
  const vis=getVisualConfig(scenario.id);

  function getVisualConfig(id){
    switch(id){
      case 1:return{title:'ü•£ Fortification Law (1942)',
        p1:'Before: No niacin in food supply',p2:'Law passes \u2014 niacin added to ALL grain!',p3:'Niacin restored \u2014 OK zone reached!',
        drawScene:drawCerealScene};
      case 2:return{title:'üåΩ Ancient Ash Water Recipe',
        p1:'Corn kernel: niacin locked inside',p2:'Ash water cracks the shell open!',p3:'Niacin unlocked \u2014 bioavailable!',
        drawScene:drawAshScene};
      case 3:return{title:'‚öôÔ∏è The Degerminator (1901)',
        p1:'Whole corn kernel with niacin',p2:'Machine strips the germ \u2014 90% lost!',p3:'Deficiency spreading across the South',
        drawScene:drawMachineScene};
      case 4:return{title:'üö´ Damaged Gut Lining',
        p1:'Fortified food enters the body',p2:'Niacin bounces off \u2014 cannot absorb!',p3:'Deficiency despite eating \u2014 not bioavailable',
        drawScene:drawGutScene};
      case 5:return{title:'üíÄ The 4 Ds',
        p1:'Niacin level dropping...',p2:'D1: Skin \u2192 D2: Gut \u2192 D3: Brain',p3:'Systems fail fastest-first: 4 Ds',
        drawScene:draw4DsScene};
      case 6:return{title:'üåç Malawi Today',
        p1:'Untreated corn diet \u2014 niacin locked',p2:'Health workers teach ash water soak!',p3:'Ancient fix works \u2014 niacin rising!',
        drawScene:drawMalawiScene};
      case 7:return{title:'‚ö° Daily Niacin Budget',
        p1:'Body needs 15mg niacin daily',p2:'Comparing foods: tuna vs chicken vs corn',p3:'Right food = right niacin level',
        drawScene:drawBudgetScene};
      case 8:return{title:'üè™ Food Desert',
        p1:'No grocery store \u2014 only processed food',p2:'Fortification covers basics, not everything',p3:'Nutrient gap \u2014 better than nothing, worse than diverse',
        drawScene:drawDesertScene};
      default:return{title:'üî¨ Simulation',p1:'',p2:'',p3:'',drawScene:()=>{}};
    }
  }

  function loop(now){
    // Bail if canvas was removed (user switched scenarios)
    if(!document.getElementById('arenaCanvas')){animFrame=null;return;}
    t=now-startTime;
    if(phase===0&&t>=PHASE1_END){phase=1;onPhase1();}
    if(phase===1&&t>=PHASE2_END){phase=2;onPhase2();}

    // Draw ‚Äî each subsystem isolated so one failure doesn't kill the loop
    try{ctx.clearRect(0,0,W,H);}catch(e){}
    try{ctx.save();drawBackground(ctx,W,H,t);ctx.restore();}catch(e){try{ctx.restore();}catch(x){}}
    try{ctx.save();vis.drawScene(ctx,W,H,t,phase,particles,scenario);ctx.restore();}catch(e){try{ctx.restore();}catch(x){}}
    try{ctx.save();drawParticles(ctx,particles,t);ctx.restore();}catch(e){try{ctx.restore();}catch(x){}}
    try{ctx.save();drawTitle(ctx,W,vis.title);ctx.restore();}catch(e){try{ctx.restore();}catch(x){}}

    if(t<PHASE3_END+1000){
      animFrame=requestAnimationFrame(loop);
    }
  }

  function onPhase1(){
    setPhaseLabel(vis.p2);
    setBodyIcons(scenario.direction==='toward'?[1,1,1]:[1,0,1]);
    // Spawn flowing particles
    for(let i=0;i<20;i++){
      const delay=i*80;
      const color=scenario.direction==='toward'?GREEN:RED;
      particles.push(createParticle(W,H,scenario.direction,color,delay));
    }
  }

  function onPhase2(){
    setPhaseLabel(vis.p3);
    setMeterWidth(scenario.meterEnd);
    setBodyIcons(scenario.bodyEnd);
    // Spawn final burst
    for(let i=0;i<15;i++){
      const color=scenario.meterEnd>60?GREEN:scenario.meterEnd>30?ORANGE:RED;
      particles.push(createBurstParticle(W/2,H/2,color,i*60));
    }
  }

  // Show button
  safeTimeout(()=>{
    const btn=document.getElementById('watchNextBtn');
    if(btn){btn.disabled=false;btn.style.opacity='1';}
  },BTN_SHOW);

  // Safety fallback
  safeTimeout(()=>{
    const btn=document.getElementById('watchNextBtn');
    if(btn&&btn.disabled){btn.disabled=false;btn.style.opacity='1';}
  },9000);

  // Start
  setPhaseLabel(vis.p1);
  animFrame=requestAnimationFrame(loop);
}

/* ---- Canvas drawing helpers ---- */
function drawBackground(ctx,W,H,t){
  const grd=ctx.createLinearGradient(0,0,0,H);
  grd.addColorStop(0,'#0a1628');grd.addColorStop(1,'#111d35');
  ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
  // Subtle grid
  ctx.strokeStyle='rgba(255,255,255,.03)';ctx.lineWidth=1;
  for(let x=0;x<W;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  // Ambient floating dots
  ctx.fillStyle='rgba(255,255,255,.04)';
  for(let i=0;i<8;i++){
    const x=(W*0.1+i*W*0.11+Math.sin(t/2000+i)*20)%W;
    const y=(H*0.2+i*H*0.1+Math.cos(t/3000+i*2)*15)%H;
    ctx.beginPath();ctx.arc(x,y,2+Math.sin(t/1000+i)*1,0,Math.PI*2);ctx.fill();
  }
}

function drawTitle(ctx,W,title){
  ctx.fillStyle='rgba(0,0,0,.5)';
  roundRect(ctx,W/2-180,6,360,28,8,true,false);
  ctx.font='bold 14px Segoe UI, sans-serif';ctx.fillStyle='#ffd54f';
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(title,W/2,20);
}

function roundRect(ctx,x,y,w,h,r,fill,stroke){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();if(fill)ctx.fill();if(stroke)ctx.stroke();
}

function drawEmoji(ctx,emoji,x,y,size){
  ctx.font=size+'px serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(emoji,x,y);
}

function drawLabel(ctx,text,x,y,color,size){
  ctx.font='bold '+(size||12)+'px Segoe UI, sans-serif';
  ctx.fillStyle=color||'#ccc';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(text,x,y);
}

function drawGlowCircle(ctx,x,y,r,color,alpha){
  const a=Math.max(0,Math.min(1,alpha||0));
  const hex=(Math.round(a*255)).toString(16).padStart(2,'0');
  const grd=ctx.createRadialGradient(x,y,0,x,y,r);
  grd.addColorStop(0,color+hex);
  grd.addColorStop(1,color+'00');
  ctx.fillStyle=grd;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();
}

function drawArrow(ctx,x1,y1,x2,y2,color,width){
  ctx.strokeStyle=color;ctx.lineWidth=width||3;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
  const angle=Math.atan2(y2-y1,x2-x1);const hl=10;
  ctx.beginPath();ctx.moveTo(x2,y2);
  ctx.lineTo(x2-hl*Math.cos(angle-0.4),y2-hl*Math.sin(angle-0.4));
  ctx.moveTo(x2,y2);
  ctx.lineTo(x2-hl*Math.cos(angle+0.4),y2-hl*Math.sin(angle+0.4));
  ctx.stroke();
}

function drawMeterBar(ctx,x,y,w,h,pct,t){
  // Background
  ctx.fillStyle='#1a1a2a';roundRect(ctx,x,y,w,h,h/2,true,false);
  // OK zone marker
  ctx.fillStyle='rgba(76,175,80,.12)';
  roundRect(ctx,x+w*0.7,y,w*0.3,h,0,true,false);
  ctx.strokeStyle='rgba(76,175,80,.3)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
  ctx.beginPath();ctx.moveTo(x+w*0.7,y);ctx.lineTo(x+w*0.7,y+h);ctx.stroke();
  ctx.setLineDash([]);
  // Fill
  const fillW=w*(pct/100);
  if(fillW>0){
    const clr=pct>70?'#4caf50':pct>40?'#ff9800':'#ef5350';
    const grd=ctx.createLinearGradient(x,0,x+fillW,0);
    grd.addColorStop(0,clr+'88');grd.addColorStop(1,clr);
    ctx.fillStyle=grd;roundRect(ctx,x,y,fillW,h,h/2,true,false);
    // Shine
    ctx.fillStyle='rgba(255,255,255,.15)';roundRect(ctx,x,y,fillW,h/2,h/4,true,false);
  }
}

/* ---- Particle system ---- */
function createParticle(W,H,direction,color,delay){
  const startX=direction==='toward'?W*0.2+Math.random()*W*0.2:W*0.5+Math.random()*W*0.2;
  const startY=H*0.3+Math.random()*H*0.3;
  const targetX=direction==='toward'?W*0.65+Math.random()*40:W*0.15+Math.random()*40;
  const targetY=H*0.4+Math.random()*H*0.15;
  return{x:startX,y:startY,tx:targetX,ty:targetY,color:color,born:performance.now()+delay,life:1800,size:4+Math.random()*4,trail:[]};
}

function createBurstParticle(cx,cy,color,delay){
  const angle=Math.random()*Math.PI*2;const dist=40+Math.random()*80;
  return{x:cx,y:cy,tx:cx+Math.cos(angle)*dist,ty:cy+Math.sin(angle)*dist,color:color,born:performance.now()+delay,life:1200,size:3+Math.random()*5,trail:[]};
}

function drawParticles(ctx,particles,t){
  const now=performance.now();
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    if(now<p.born)continue;
    const age=now-p.born;
    if(age>p.life){particles.splice(i,1);continue;}
    const progress=Math.min(age/p.life,1);
    const ease=1-Math.pow(1-progress,3);
    const px=p.x+(p.tx-p.x)*ease;
    const py=p.y+(p.ty-p.y)*ease;
    const alpha=1-progress;
    // Glow
    drawGlowCircle(ctx,px,py,p.size*3,p.color,alpha*0.3);
    // Core
    ctx.globalAlpha=alpha;
    ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(px,py,p.size,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
    // Trail
    p.trail.push({x:px,y:py,a:alpha});
    if(p.trail.length>8)p.trail.shift();
    ctx.lineWidth=1;
    for(let j=0;j<p.trail.length-1;j++){
      const ta=Math.max(0,Math.min(1,p.trail[j].a||0));
      ctx.strokeStyle=p.color+(Math.round(ta*80).toString(16).padStart(2,'0'));
      ctx.beginPath();ctx.moveTo(p.trail[j].x,p.trail[j].y);
      ctx.lineTo(p.trail[j+1].x,p.trail[j+1].y);ctx.stroke();
    }
  }
}

/* ================================================================
   PER-SCENARIO CANVAS DRAWINGS
   ================================================================ */
function drawCerealScene(ctx,W,H,t,phase){
  const cx=W/2,cy=H/2+10;
  // Cereal box
  drawEmoji(ctx,'ü•£',cx-120,cy-30,60);
  drawEmoji(ctx,'üçû',cx-40,cy-30,50);
  drawEmoji(ctx,'üåæ',cx+40,cy-30,50);
  // Body outline on right
  drawBodyOutline(ctx,cx+160,cy,phase>=2?'#4caf50':'#666',t);
  if(phase>=1){
    // Flow arrows
    const pulse=0.5+0.5*Math.sin(t/300);
    ctx.globalAlpha=0.6+pulse*0.4;
    drawArrow(ctx,cx-60,cy,cx+110,cy,'#4caf50',3);
    ctx.globalAlpha=1;
    drawLabel(ctx,'Niacin Added',cx+30,cy-50,'#81c784',14);
    if(phase>=2){
      drawLabel(ctx,'Fortified!',cx-80,cy+50,'#ffd54f',16);
      drawGlowCircle(ctx,cx+160,cy,50,'#4caf50',0.15+0.1*Math.sin(t/500));
    }
  }else{
    drawLabel(ctx,'Before 1942',cx,cy+50,'#ef5350',14);
    ctx.strokeStyle='#ef535066';ctx.lineWidth=2;ctx.setLineDash([6,6]);
    ctx.beginPath();ctx.moveTo(cx-60,cy);ctx.lineTo(cx+110,cy);ctx.stroke();
    ctx.setLineDash([]);
  }
}

function drawAshScene(ctx,W,H,t,phase){
  const cx=W/2,cy=H/2+10;
  // Corn kernel
  drawEmoji(ctx,'üåΩ',cx-140,cy-10,56);
  drawLabel(ctx,'Corn',cx-140,cy+35,'#aaa',12);
  if(phase>=1){
    // Ash water
    drawEmoji(ctx,'ü´ß',cx-30,cy-10,48);
    drawLabel(ctx,'Ash Water',cx-30,cy+35,'#64b5f6',12);
    const pulse=0.5+0.5*Math.sin(t/400);
    drawArrow(ctx,cx-100,cy,cx-55,cy,'#64b5f6',2+pulse);
    if(phase>=2){
      drawEmoji(ctx,'üîì',cx+100,cy-10,52);
      drawLabel(ctx,'Bioavailable!',cx+100,cy+38,'#81c784',14);
      drawArrow(ctx,cx+5,cy,cx+70,cy,'#4caf50',3);
      drawGlowCircle(ctx,cx+100,cy,40,'#4caf50',0.2+0.1*Math.sin(t/500));
    }else{
      drawEmoji(ctx,'üîí',cx+100,cy-10,48);
      drawLabel(ctx,'Locked',cx+100,cy+35,'#ef5350',12);
    }
  }else{
    drawEmoji(ctx,'üîí',cx+60,cy-10,48);
    drawLabel(ctx,'Niacin Locked',cx+60,cy+35,'#ef5350',12);
    // Cage bars
    ctx.strokeStyle='#ef535044';ctx.lineWidth=2;
    for(let i=-15;i<=15;i+=10){
      ctx.beginPath();ctx.moveTo(cx+60+i,cy-35);ctx.lineTo(cx+60+i,cy+15);ctx.stroke();
    }
  }
}

function drawMachineScene(ctx,W,H,t,phase){
  const cx=W/2,cy=H/2+10;
  // Whole corn
  drawEmoji(ctx,'üåΩ',cx-160,cy-10,52);
  drawLabel(ctx,'Whole Kernel',cx-160,cy+35,'#aaa',11);
  // Machine
  drawEmoji(ctx,'‚öôÔ∏è',cx-20,cy-20,56);
  const spin=t/800;
  ctx.save();ctx.translate(cx+30,cy-20);ctx.rotate(spin);
  drawEmoji(ctx,'‚öôÔ∏è',0,0,36);ctx.restore();
  drawLabel(ctx,'Degerminator',cx,cy+35,'#ef5350',13);
  drawArrow(ctx,cx-120,cy,cx-45,cy,'#aaa',2);
  if(phase>=1){
    // Stripped corn
    drawEmoji(ctx,'üü°',cx+140,cy-10,44);
    drawLabel(ctx,'-90% Niacin!',cx+140,cy+35,'#ef5350',13);
    drawArrow(ctx,cx+35,cy,cx+110,cy,'#ef5350',2);
    // Scatter particles (red, escaping)
    if(phase===1){
      for(let i=0;i<5;i++){
        const age=(t-2000+i*200)%2000;
        const a=Math.max(0,1-age/1500);
        const px=cx+50+age/15+i*12;
        const py=cy-40-age/8+Math.sin(i)*20;
        ctx.globalAlpha=a;ctx.fillStyle='#ef5350';
        ctx.beginPath();ctx.arc(px,py,3,0,Math.PI*2);ctx.fill();
        ctx.globalAlpha=1;
      }
    }
    if(phase>=2){
      drawLabel(ctx,'Epidemic!',cx+140,cy+55,'#ff5252',15);
      // Counter
      const count=Math.min(Math.floor((t-5000)/50),30000);
      drawLabel(ctx,'Cases: '+count.toLocaleString()+'+',cx,cy+65,'#ff9800',12);
    }
  }
}

function drawGutScene(ctx,W,H,t,phase){
  const cx=W/2,cy=H/2;
  // Food on left
  drawEmoji(ctx,'üçû',cx-180,cy-20,48);
  drawLabel(ctx,'Fortified',cx-180,cy+25,'#81c784',11);
  // Gut in center
  const gutX=cx+20,gutY=cy;
  // Draw gut lining
  ctx.strokeStyle=phase>=1?'#ef5350':'#666';ctx.lineWidth=3;
  ctx.beginPath();
  for(let i=0;i<200;i+=4){
    const x=gutX-80+i;
    const y=gutY+15+Math.sin(i/12)*8+(phase>=1?Math.random()*3:0);
    if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
  }
  ctx.stroke();
  drawLabel(ctx,'Gut Lining',gutX,gutY+40,phase>=1?'#ef5350':'#aaa',12);
  if(phase>=1){
    // Cracks
    ctx.strokeStyle='#ef535088';ctx.lineWidth=2;
    [gutX-30,gutX+10,gutX+50].forEach(x=>{
      ctx.beginPath();ctx.moveTo(x,gutY+8);ctx.lineTo(x+5,gutY+25);ctx.stroke();
    });
    drawLabel(ctx,'DAMAGED',gutX,gutY-30,'#ef5350',14);
    // Niacin particles bouncing off
    drawArrow(ctx,cx-130,cy-10,gutX-90,cy-5,'#4caf50',2);
    for(let i=0;i<4;i++){
      const age=(t-2000+i*300)%2000;
      const bx=gutX-60+i*30;
      const by=gutY+10-age/20;
      const a=Math.max(0,1-age/1500);
      ctx.globalAlpha=a;
      drawEmoji(ctx,'üíä',bx,by+Math.abs(Math.sin(age/200))*15,16);
      ctx.globalAlpha=1;
    }
    if(phase>=2){
      drawLabel(ctx,'NOT Bioavailable',gutX,gutY+60,'#ff5252',14);
      // X marks
      ctx.strokeStyle='#ef5350';ctx.lineWidth=3;
      ctx.beginPath();ctx.moveTo(gutX-8,gutY-8);ctx.lineTo(gutX+8,gutY+8);ctx.stroke();
      ctx.beginPath();ctx.moveTo(gutX+8,gutY-8);ctx.lineTo(gutX-8,gutY+8);ctx.stroke();
    }
  }else{
    drawArrow(ctx,cx-130,cy,gutX-90,cy,'#4caf5066',2);
    drawLabel(ctx,'Niacin in food',cx-80,cy-30,'#81c784',12);
  }
}

function draw4DsScene(ctx,W,H,t,phase){
  const cx=W/2,cy=H/2;
  const stages=[
    {emoji:'üß¥',label:'D1: Skin',x:cx-180,color:'#ef5350'},
    {emoji:'ü´Å',label:'D2: Gut',x:cx-60,color:'#ff9800'},
    {emoji:'üß†',label:'D3: Brain',x:cx+60,color:'#ffd54f'},
    {emoji:'üíÄ',label:'D4: Death',x:cx+180,color:'#b71c1c'}
  ];
  // Speed label
  drawLabel(ctx,'Fastest cell replacement \u2192 Slowest',cx,cy-70,'#888',11);
  drawArrow(ctx,cx-140,cy-55,cx+140,cy-55,'#555',1);
  stages.forEach((st,i)=>{
    const active=phase>=1&&(phase===1?i<2:true);
    const glowing=phase>=2&&i<3;
    // Card background
    ctx.fillStyle=active?st.color+'22':'rgba(255,255,255,.04)';
    ctx.strokeStyle=active?st.color:'#444';ctx.lineWidth=2;
    roundRect(ctx,st.x-40,cy-35,80,90,12,true,true);
    drawEmoji(ctx,st.emoji,st.x,cy-5,36);
    drawLabel(ctx,st.label,st.x,cy+40,active?st.color:'#666',12);
    if(active&&phase>=1){
      // Pulse glow
      const pulse=0.3+0.3*Math.sin(t/400+i);
      drawGlowCircle(ctx,st.x,cy,50,st.color,pulse*0.2);
    }
    // Connecting arrow
    if(i<3){
      const nextX=stages[i+1].x;
      const arrowColor=active?'#ef535088':'#333';
      drawArrow(ctx,st.x+40,cy,nextX-40,cy,arrowColor,2);
    }
  });
  if(phase>=2){
    drawLabel(ctx,'Systems fail in ORDER \u2014 fastest cells first',cx,cy+80,'#ffd54f',13);
  }
}

function drawMalawiScene(ctx,W,H,t,phase){
  const cx=W/2,cy=H/2;
  // Map icon
  drawEmoji(ctx,'üåç',cx-160,cy-30,48);
  drawLabel(ctx,'Malawi',cx-160,cy+15,'#ffa726',12);
  if(phase<1){
    drawEmoji(ctx,'üåΩ',cx,cy-10,48);
    drawLabel(ctx,'Untreated Corn',cx,cy+35,'#ef5350',13);
    drawEmoji(ctx,'üîí',cx+80,cy-30,32);
    drawLabel(ctx,'Niacin Locked',cx+80,cy+5,'#ef5350',11);
  }else{
    // Before + After split
    const ly=cy-40,ry=cy+40;
    // Before
    ctx.fillStyle='rgba(239,83,80,.08)';roundRect(ctx,cx-100,ly-25,200,45,8,true,false);
    drawLabel(ctx,'Before: Locked',cx,ly,'#ef5350',13);
    // Arrow down
    drawArrow(ctx,cx,ly+20,cx,ry-20,'#ffd54f',2);
    // After
    ctx.fillStyle='rgba(76,175,80,.08)';roundRect(ctx,cx-100,ry-20,200,45,8,true,false);
    drawEmoji(ctx,'ü´ß',cx-60,ry+2,28);
    drawLabel(ctx,'After: Ash Water Fix!',cx+20,ry+2,'#81c784',13);
    if(phase>=2){
      drawGlowCircle(ctx,cx,ry,50,'#4caf50',0.15+0.1*Math.sin(t/500));
      drawLabel(ctx,'3,000-Year-Old Solution',cx,ry+35,'#ffd54f',12);
    }
  }
}

function drawBudgetScene(ctx,W,H,t,phase){
  const cx=W/2,cy=H/2+15;
  // Budget target line
  const barTop=cy-80,barH=120,barW=50;
  drawLabel(ctx,'Daily Need: 15mg',cx,barTop-20,'#ffd54f',14);
  const foods=[
    {emoji:'üçó',name:'Chicken',mg:10,x:cx-100,color:'#4caf50'},
    {emoji:'üêü',name:'Tuna',mg:22,x:cx,color:'#2196f3'},
    {emoji:'üåΩ',name:'Cornmeal',mg:1,x:cx+100,color:'#ef5350'}
  ];
  foods.forEach(f=>{
    // Bar background
    ctx.fillStyle='#1a1a2a';roundRect(ctx,f.x-barW/2,barTop,barW,barH,6,true,false);
    // Target line
    ctx.strokeStyle='#ffd54f44';ctx.lineWidth=1;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(f.x-barW/2,barTop+barH*(1-15/25));ctx.lineTo(f.x+barW/2,barTop+barH*(1-15/25));ctx.stroke();
    ctx.setLineDash([]);
    // Fill
    const fillPct=phase>=1?Math.min(f.mg/25,1):0;
    const fillH=barH*fillPct;
    if(fillH>0){
      const grd=ctx.createLinearGradient(0,barTop+barH-fillH,0,barTop+barH);
      grd.addColorStop(0,f.color);grd.addColorStop(1,f.color+'88');
      ctx.fillStyle=grd;roundRect(ctx,f.x-barW/2,barTop+barH-fillH,barW,fillH,0,true,false);
    }
    drawEmoji(ctx,f.emoji,f.x,barTop-45,36);
    drawLabel(ctx,f.name,f.x,barTop+barH+18,'#aaa',11);
    if(phase>=1)drawLabel(ctx,f.mg+'mg',f.x,barTop+barH-fillH-10,f.color,11);
  });
  if(phase>=2){
    drawLabel(ctx,'Diverse diet = enough niacin',cx,barTop+barH+40,'#81c784',13);
  }
}

function drawDesertScene(ctx,W,H,t,phase){
  const cx=W/2,cy=H/2;
  // Left: food desert
  const lx=cx-120,rx=cx+120;
  ctx.fillStyle='rgba(239,83,80,.06)';roundRect(ctx,lx-70,cy-60,140,120,12,true,false);
  drawEmoji(ctx,'üè™',lx,cy-25,44);
  drawLabel(ctx,'Food Desert',lx,cy+25,'#ef5350',13);
  drawLabel(ctx,'Processed Only',lx,cy+42,'#888',10);
  // Right: full access
  ctx.fillStyle='rgba(76,175,80,.06)';roundRect(ctx,rx-70,cy-60,140,120,12,true,false);
  drawEmoji(ctx,'üè¨',rx,cy-25,44);
  drawLabel(ctx,'Full Access',rx,cy+25,'#4caf50',13);
  drawLabel(ctx,'Fresh + Diverse',rx,cy+42,'#888',10);
  // VS
  drawLabel(ctx,'vs',cx,cy,'#ffa726',18);
  if(phase>=1){
    // Meter comparison bars
    const bw=90,bh=12,by1=cy+65,by2=cy+65;
    drawMeterBar(ctx,lx-45,by1,bw,bh,phase>=2?42:20,t);
    drawMeterBar(ctx,rx-45,by2,bw,bh,phase>=2?85:50,t);
    drawLabel(ctx,'Low',lx,by1+bh+12,phase>=2?'#ff9800':'#aaa',11);
    drawLabel(ctx,'OK',rx,by2+bh+12,phase>=2?'#4caf50':'#aaa',11);
    if(phase>=2){
      // Gap line
      ctx.strokeStyle='#ffa72666';ctx.lineWidth=2;ctx.setLineDash([4,4]);
      ctx.beginPath();ctx.moveTo(lx+50,by1+bh/2);ctx.lineTo(rx-50,by2+bh/2);ctx.stroke();
      ctx.setLineDash([]);
      drawLabel(ctx,'Nutrient Gap',cx,by1-8,'#ffa726',12);
    }
  }
}

function drawBodyOutline(ctx,x,y,color,t){
  // Simple human figure
  ctx.strokeStyle=color;ctx.lineWidth=2;
  // Head
  ctx.beginPath();ctx.arc(x,y-35,14,0,Math.PI*2);ctx.stroke();
  // Body
  ctx.beginPath();ctx.moveTo(x,y-21);ctx.lineTo(x,y+15);ctx.stroke();
  // Arms
  ctx.beginPath();ctx.moveTo(x-18,y-8);ctx.lineTo(x+18,y-8);ctx.stroke();
  // Legs
  ctx.beginPath();ctx.moveTo(x,y+15);ctx.lineTo(x-14,y+38);ctx.stroke();
  ctx.beginPath();ctx.moveTo(x,y+15);ctx.lineTo(x+14,y+38);ctx.stroke();
}

/* ================================================================
   HUD HELPERS
   ================================================================ */
function setMeterWidth(pct){
  try{
    const el=document.getElementById('meterInner');
    if(!el)return;
    const color=pct>70?'linear-gradient(90deg,#388e3c,#4caf50)':pct>40?'linear-gradient(90deg,#e65100,#ff9800)':'linear-gradient(90deg,#b71c1c,#ef5350)';
    el.style.background=color;el.style.width=pct+'%';
  }catch(e){}
}

function setBodyIcons(states){
  const ids=['biSkin','biGut','biBrain'];
  const cls=['bad','warn','ok'];
  ids.forEach((id,i)=>{
    try{const el=document.getElementById(id);if(el)el.className='body-icon '+cls[states[i]];}catch(e){}
  });
}

function setPhaseLabel(text){
  try{const el=document.getElementById('phaseLabel');if(el)el.textContent=text;}catch(e){}
}

/* ================================================================
   RECORD
   ================================================================ */
function finishWatch(){
  // Guard double-click
  const btn=document.getElementById('watchNextBtn');
  if(btn)btn.disabled=true;
  clearAllTimers();

  state.currentStep='record';updateTabs();
  const s=state.currentScenario;
  const row={scenario:s.name,whatChanged:s.whatChanged,sysResponse:s.sysResponse,backOK:s.backOK};
  state.dataRows.push(row);state.completed.add(s.id);state.score+=50;

  const tbody=document.getElementById('dataBody');
  const tr=document.createElement('tr');tr.className='new-row';
  tr.innerHTML='<td>'+s.emoji+' '+row.scenario+'</td><td>'+row.whatChanged+'</td><td>'+row.sysResponse+'</td><td>'+row.backOK+'</td>';
  tbody.appendChild(tr);

  updateHUD();renderScenarioList();

  const completed=state.completed.size;
  let msg='Great work! '+completed+'/8 scenarios done.';
  if(completed<5)msg+=' Pick '+(5-completed)+' more you like!';
  else if(completed===5)msg+=' Required complete! Keep going for extra credit!';
  else if(completed<8)msg+=' '+(8-completed)+' more for extra credit!';
  else msg+=' All 8 complete \u2014 extra credit earned!';

  document.getElementById('centerContent').innerHTML='<div class="record-card fade-in"><h3>\u2705 Data Recorded!</h3><p>'+msg+'</p><button class="btn-action" onclick="returnToWelcome()" style="margin-top:12px;">Pick Next Scenario</button></div>';

  state.currentScenario=null;state.currentStep=null;

  if(completed===5)safeTimeout(()=>showBanner('required'),600);
  else if(completed===8)safeTimeout(()=>showBanner('ec'),600);
}

function returnToWelcome(){
  state.currentScenario=null;state.currentStep=null;updateTabs();
  const content=document.getElementById('centerContent');
  const done=state.completed.size;
  let html;
  if(done>=8)html='<div class="welcome-screen"><div class="big-emoji">\u2B50\uD83C\uDFC6\u2B50</div><h2>All 8 scenarios complete! Extra Credit Earned!</h2><p>Your data table is ready. Click \uD83D\uDCCB Copy Table on the right to copy it to your worksheet.</p></div>';
  else if(done>=5)html='<div class="welcome-screen"><div class="big-emoji">\uD83C\uDFC6</div><h2>Required Complete! '+(8-done)+' scenarios left for extra credit.</h2><p>Pick another scenario from the left, or click \uD83D\uDCCB Copy Table to save your data.</p></div>';
  else html='<div class="welcome-screen"><div class="big-emoji">\uD83E\uDD63\uD83D\uDC8A\uD83D\uDD2C</div><h2>'+done+' done \u2014 pick '+(5-done)+' more you like!</h2><p>Each scenario reveals a new piece of the niacin puzzle.</p></div>';
  content.innerHTML=html;
  renderKeywords();
}

/* ================================================================
   HUD / COPY / BANNERS / RESET
   ================================================================ */
function updateHUD(){
  try{
    document.getElementById('hudScore').textContent=state.score;
    document.getElementById('hudStreak').textContent=state.streak;
    document.getElementById('hudCompleted').textContent=state.completed.size+'/8';
    document.getElementById('hudAccuracy').textContent=state.totalPredictions>0?Math.round((state.correctPredictions/state.totalPredictions)*100)+'%':'--%';
    document.getElementById('progressBar').style.width=Math.min((state.completed.size/5)*100,100)+'%';
    const d=state.completed.size;
    document.getElementById('progressMsg').textContent=d>=8?'\u2B50 All 8 complete! Extra credit earned!':d>=5?'\u2705 Required done! '+(8-d)+' more for extra credit.':'Pick '+(5-d)+' more you like!';
  }catch(e){}
}

function copyTable(){
  try{
    if(state.dataRows.length===0)return;
    let text="Scenario\tWhat Changed?\tSystem Response\tBack Toward OK?\n";
    state.dataRows.forEach(r=>{text+=r.scenario+"\t"+r.whatChanged+"\t"+r.sysResponse+"\t"+r.backOK+"\n";});
    if(navigator.clipboard&&navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(()=>flashCopy()).catch(()=>fallbackCopy(text));
    }else{fallbackCopy(text);}
  }catch(e){}
}
function fallbackCopy(text){try{const ta=document.createElement('textarea');ta.value=text;ta.style.position='fixed';ta.style.opacity='0';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);flashCopy();}catch(e){}}
function flashCopy(){const btn=document.getElementById('copyBtn');if(btn){btn.textContent='\u2705 Copied!';setTimeout(()=>{btn.textContent='\uD83D\uDCCB Copy Table';},2000);}}

function showBanner(type){
  document.getElementById('overlayBg').style.display='block';
  document.getElementById(type==='required'?'requiredBanner':'ecBanner').style.display='block';
}
function closeBanner(){
  document.getElementById('overlayBg').style.display='none';
  document.getElementById('requiredBanner').style.display='none';
  document.getElementById('ecBanner').style.display='none';
}

function resetSim(){
  clearAllTimers();stopSpeech();
  state={currentScenario:null,currentStep:null,readingLevel:state.readingLevel,completed:new Set(),predictions:{},score:0,streak:0,correctPredictions:0,totalPredictions:0,dataRows:[],speechActive:false,speechResumeInterval:null};
  document.getElementById('dataBody').innerHTML='';
  renderScenarioList();renderKeywords();updateHUD();returnToWelcome();
}
function newRun(){resetSim();}

/* ================================================================
   START
   ================================================================ */
init();
</script>
</body>
</html>
