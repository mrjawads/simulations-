<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mr. Jawad's Simulation â€” Volcano</title>
<style>
:root {
  --bg1:#F0F4F8;--bg2:#E8EEF4;
  --accent1:#3B82F6;--accent2:#10B981;--accent3:#8B5CF6;
  --text:#1E293B;--textLight:#64748B;--white:#FFFFFF;--card:#FFFFFF;
  --correct:#10B981;--wrong:#EF4444;--warn:#F59E0B;
  --hintBg1:#FFF9C4;--hintBg2:#FFE0B2;
  --shadow:0 2px 12px rgba(0,0,0,0.08);--radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{height:100%;}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;overflow-x:hidden;display:flex;flex-direction:column;}
button{cursor:pointer;font-family:inherit;border:none;outline:none;touch-action:manipulation;-webkit-tap-highlight-color:transparent;}
button:focus-visible{outline:3px solid var(--accent1);outline-offset:2px;}

/* ===== TOP BAR ===== */
.top-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--white);border-bottom:2px solid #E2E8F0;position:sticky;top:0;z-index:100;gap:8px;flex-wrap:wrap;min-height:44px;}
.tb-left{display:flex;align-items:center;gap:8px;flex-shrink:1;min-width:0;}
.phase-badge{background:var(--accent1);color:#fff;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700;letter-spacing:0.5px;white-space:nowrap;flex-shrink:0;}
.round-name{font-weight:700;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tb-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.score-display{font-weight:700;font-size:15px;color:var(--accent1);white-space:nowrap;}
.progress-wrap{width:110px;height:8px;background:#E2E8F0;border-radius:4px;overflow:hidden;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width 0.5s;border-radius:4px;}

/* ===== MAIN LAYOUT ===== */
.main-area{display:flex;flex:1;min-height:0;overflow:hidden;}
.left-panel{width:220px;min-width:180px;background:var(--white);border-right:2px solid #E2E8F0;padding:12px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;}
.center-panel{flex:1;display:flex;flex-direction:column;min-width:0;min-height:0;overflow:hidden;}
.right-panel{width:240px;min-width:200px;background:var(--white);border-left:2px solid #E2E8F0;padding:12px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;}

/* ===== ARENA ===== */
.arena-wrap{flex:1;position:relative;background:#F8FAFC;min-height:200px;overflow:hidden;}
#volcanoCanvas{width:100%;height:100%;display:block;}
.focus-prompt{position:absolute;top:8px;left:50%;transform:translateX(-50%);background:rgba(59,130,246,0.92);color:#fff;padding:7px 16px;border-radius:8px;font-size:13px;font-weight:600;max-width:88%;text-align:center;z-index:20;transition:opacity 1.5s;pointer-events:none;line-height:1.4;}
.focus-prompt.fade{opacity:0.25;font-size:11px;top:4px;}

/* ===== SLIDER CONTROLS ===== */
.slider-group{display:flex;flex-direction:column;gap:3px;}
.slider-label{font-weight:700;font-size:13px;color:var(--text);display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.lock-icon{color:var(--warn);font-size:11px;font-weight:600;}
.slider-wrap{position:relative;}
.slider-wrap input[type=range]{width:100%;height:36px;-webkit-appearance:none;appearance:none;background:transparent;cursor:pointer;}
.slider-wrap input[type=range]::-webkit-slider-track{height:8px;border-radius:4px;background:linear-gradient(90deg,#FFA94D,#E03131);}
.slider-wrap input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:#fff;border:3px solid var(--accent1);margin-top:-9px;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
.slider-wrap input[type=range]::-moz-range-track{height:8px;border-radius:4px;background:linear-gradient(90deg,#FFA94D,#E03131);}
.slider-wrap input[type=range]::-moz-range-thumb{width:26px;height:26px;border-radius:50%;background:#fff;border:3px solid var(--accent1);box-shadow:0 2px 6px rgba(0,0,0,0.15);}
.slider-wrap.gas input[type=range]::-webkit-slider-track{background:linear-gradient(90deg,#A5D8FF,#7048E8);}
.slider-wrap.gas input[type=range]::-moz-range-track{background:linear-gradient(90deg,#A5D8FF,#7048E8);}
.slider-wrap.locked{opacity:0.4;pointer-events:none;}
.slider-ticks{display:flex;justify-content:space-between;font-size:11px;color:var(--textLight);font-weight:600;padding:0 2px;}
.slider-value{text-align:center;font-weight:700;font-size:13px;color:var(--accent1);margin-top:1px;}
.test-btn{width:100%;padding:12px;font-size:15px;font-weight:700;border-radius:var(--radius);color:#fff;background:linear-gradient(135deg,var(--accent2),#059669);transition:all 0.2s;margin-top:6px;}
.test-btn:disabled{background:#CBD5E1;color:#94A3B8;cursor:not-allowed;}
.test-btn:not(:disabled):hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(16,185,129,0.3);}
.guided-overlay{background:var(--hintBg1);border:2px solid var(--warn);border-radius:8px;padding:8px 10px;font-size:12px;color:#92400E;font-weight:600;line-height:1.4;}

/* ===== DATA TABLE ===== */
.dt-title{font-weight:700;font-size:13px;color:var(--text);padding-bottom:4px;border-bottom:2px solid #E2E8F0;}
.data-table{width:100%;border-collapse:collapse;font-size:11px;}
.data-table th{background:#F1F5F9;padding:4px 3px;text-align:left;font-weight:700;color:var(--textLight);border-bottom:2px solid #E2E8F0;position:sticky;top:0;font-size:10px;}
.data-table td{padding:4px 3px;border-bottom:1px solid #F1F5F9;font-size:11px;transition:background 0.3s;}
.data-table tr.current td{background:#EFF6FF;font-weight:600;}
.data-table tr.verified td{background:#F0FDF4;}
.data-table td.error-cell{background:#FEF3C7;cursor:pointer;animation:pulse-yellow 1s infinite;}
.data-table td.corrected{background:#D1FAE5;animation:none;}
@keyframes pulse-yellow{0%,100%{box-shadow:inset 0 0 0 2px transparent}50%{box-shadow:inset 0 0 0 2px var(--warn)}}

/* ===== INTERACTION ZONE (KEY FIX: scrollable, always visible) ===== */
.interaction-zone{background:var(--white);border-top:2px solid #E2E8F0;padding:14px;display:flex;flex-direction:column;align-items:center;gap:10px;overflow-y:auto;max-height:50vh;min-height:100px;}
.iz-prompt{font-size:15px;font-weight:600;color:var(--text);text-align:center;max-width:620px;line-height:1.5;}
.iz-options{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;width:100%;max-width:700px;}

/* ===== OPTION CARDS (bigger, clearer) ===== */
.opt-card{padding:12px 16px;border-radius:var(--radius);border:2px solid #E2E8F0;background:var(--white);font-size:14px;font-weight:600;transition:all 0.2s;min-height:52px;display:flex;align-items:center;cursor:pointer;user-select:none;flex:1 1 200px;justify-content:center;text-align:center;line-height:1.4;}
.opt-card:hover{border-color:var(--accent1);background:#EFF6FF;}
.opt-card.selected{border-color:var(--accent1);background:#DBEAFE;color:var(--accent1);box-shadow:0 0 0 3px rgba(59,130,246,0.15);}
.opt-card.correct-reveal{border-color:var(--correct);background:#D1FAE5;color:#065F46;box-shadow:0 0 0 3px rgba(16,185,129,0.2);}
.opt-card.wrong-reveal{border-color:var(--wrong);background:#FEE2E2;color:#991B1B;}
.opt-card.dimmed{opacity:0.3;pointer-events:none;text-decoration:line-through;}
.opt-card.eliminated{opacity:0.25;pointer-events:none;border-style:dashed;}

/* ===== BUTTONS ===== */
.lock-in-btn{padding:14px 36px;font-size:16px;font-weight:700;border-radius:var(--radius);color:#fff;background:linear-gradient(135deg,var(--accent1),#2563EB);transition:all 0.2s;min-height:52px;}
.lock-in-btn:disabled{background:#CBD5E1;color:#94A3B8;cursor:not-allowed;}
.lock-in-btn:not(:disabled):hover{transform:scale(1.02);}
.try-again-btn{padding:14px 32px;font-size:15px;font-weight:700;border-radius:var(--radius);color:#fff;background:linear-gradient(135deg,var(--accent1),var(--accent3));min-height:52px;margin-top:4px;}
.try-again-btn:hover{transform:scale(1.02);}
.reset-round-btn{padding:8px 16px;font-size:12px;font-weight:600;border-radius:8px;color:var(--textLight);background:#F1F5F9;border:1px solid #E2E8F0;margin-top:4px;}
.reset-round-btn:hover{background:#E2E8F0;color:var(--text);}

/* ===== COACHING BAR ===== */
.coaching-bar{background:var(--hintBg1);border:2px solid #FDE68A;border-radius:var(--radius);padding:10px 14px;font-size:13px;color:#92400E;font-weight:600;max-width:620px;text-align:center;line-height:1.5;animation:slideUp 0.3s;width:100%;}
.coaching-bar.hint2{background:var(--hintBg2);border-color:#FDBA74;color:#9A3412;}
@keyframes slideUp{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}

/* ===== DRAG-TO-MATCH ===== */
.dtm-container{display:flex;flex-direction:column;gap:14px;width:100%;max-width:700px;align-items:center;}
.dtm-items{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
.dtm-drag{padding:10px 14px;background:#EFF6FF;border:2px solid var(--accent1);border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;touch-action:manipulation;min-height:48px;display:flex;align-items:center;user-select:none;text-align:center;transition:all 0.2s;}
.dtm-drag.placed{opacity:0.3;pointer-events:none;}
.dtm-drag.sel{box-shadow:0 0 0 3px var(--accent3);background:#EDE9FE;}
.dtm-zones{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;width:100%;}
.dtm-zone{flex:1;min-width:160px;min-height:80px;border:2px dashed #CBD5E1;border-radius:8px;padding:8px;display:flex;flex-direction:column;align-items:center;gap:4px;background:#F8FAFC;transition:all 0.2s;cursor:pointer;}
.dtm-zone:hover{border-color:var(--accent1);background:#EFF6FF;}
.dtm-zone-label{font-size:12px;font-weight:700;color:var(--textLight);text-align:center;}
.dtm-placed-item{padding:6px 10px;background:#DBEAFE;border:2px solid var(--accent1);border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;}

/* ===== SEQUENCE BUILDER ===== */
.seq-container{display:flex;flex-direction:column;gap:10px;width:100%;max-width:620px;}
.seq-source{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;min-height:52px;}
.seq-slots{display:flex;flex-direction:column;gap:6px;width:100%;}
.seq-slot{min-height:48px;border:2px dashed #CBD5E1;border-radius:8px;display:flex;align-items:center;padding:8px 12px;font-size:13px;color:var(--textLight);font-weight:600;background:#F8FAFC;transition:all 0.2s;cursor:pointer;gap:8px;}
.seq-slot.filled{border-style:solid;border-color:var(--accent1);background:#DBEAFE;color:var(--text);}
.seq-slot .slot-num{font-weight:800;color:var(--accent1);font-size:15px;min-width:22px;}
.seq-card{padding:10px 14px;background:#EFF6FF;border:2px solid var(--accent1);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;min-height:48px;display:flex;align-items:center;text-align:center;user-select:none;transition:all 0.2s;}
.seq-card:hover{background:#DBEAFE;}
.seq-card.selected{border-color:var(--accent3);background:#EDE9FE;box-shadow:0 0 0 3px rgba(139,92,246,0.2);}
.seq-card.placed{opacity:0.3;pointer-events:none;}
.seq-card.locked{border-color:var(--correct);background:#D1FAE5;pointer-events:none;}

/* ===== CLAIM BUILDER ===== */
.claim-container{display:flex;flex-direction:column;gap:12px;width:100%;max-width:650px;}
.claim-frame{border:2px solid var(--accent3);border-radius:var(--radius);padding:12px;background:#FAF5FF;min-height:70px;}
.claim-frame-label{font-size:13px;font-weight:700;color:var(--accent3);margin-bottom:6px;}
.claim-evidence-area{display:flex;flex-wrap:wrap;gap:6px;min-height:40px;font-size:13px;color:var(--textLight);}
.claim-card{padding:10px 14px;border-radius:8px;border:2px solid #E2E8F0;background:var(--white);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;min-height:48px;display:flex;align-items:center;text-align:center;}
.claim-card:hover{border-color:var(--accent3);background:#FAF5FF;}
.claim-card.selected{border-color:var(--accent3);background:#EDE9FE;}
.claim-card.in-frame{border-color:var(--accent3);background:#EDE9FE;font-size:11px;min-height:36px;}
.claim-card.eliminated{opacity:0.25;pointer-events:none;text-decoration:line-through;}

/* ===== PREDICTION ===== */
.predict-container{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;max-width:620px;}
.predict-prompt{font-size:15px;font-weight:600;text-align:center;line-height:1.5;}
.predict-cards{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;width:100%;}
.predict-card{padding:14px 18px;border-radius:var(--radius);border:2px solid #E2E8F0;background:var(--white);font-size:14px;font-weight:600;cursor:pointer;min-height:56px;flex:1;min-width:200px;display:flex;align-items:center;text-align:center;justify-content:center;transition:all 0.2s;line-height:1.4;}
.predict-card:hover{border-color:var(--accent3);background:#FAF5FF;}
.predict-card.selected{border-color:var(--accent3);background:#EDE9FE;color:var(--accent3);box-shadow:0 0 0 3px rgba(139,92,246,0.15);}

/* ===== RECORD ===== */
.record-zone{display:flex;flex-direction:column;align-items:center;gap:10px;}
.record-msg{font-size:14px;font-weight:600;color:var(--text);text-align:center;line-height:1.5;}
.confirm-btn{padding:12px 30px;font-size:15px;font-weight:700;border-radius:var(--radius);color:#fff;background:linear-gradient(135deg,var(--accent2),#059669);min-height:48px;transition:all 0.2s;}
.confirm-btn:disabled{background:#CBD5E1;color:#94A3B8;cursor:not-allowed;}
.confirm-btn:not(:disabled):hover{transform:scale(1.02);}

/* ===== BOTTOM BAR ===== */
.bottom-bar{display:flex;align-items:center;justify-content:space-between;padding:6px 14px;background:var(--white);border-top:2px solid #E2E8F0;gap:6px;flex-wrap:wrap;flex-shrink:0;}
.bb-left{display:flex;gap:6px;flex-wrap:wrap;}
.bb-btn{padding:7px 12px;border-radius:8px;font-size:12px;font-weight:600;background:#F1F5F9;color:var(--text);border:1px solid #E2E8F0;min-height:36px;display:flex;align-items:center;gap:4px;}
.bb-btn:hover{background:#E2E8F0;}
.bb-center{font-size:12px;color:var(--textLight);font-weight:600;}

/* ===== OVERLAYS ===== */
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:400;display:none;align-items:center;justify-content:center;}
.overlay.show{display:flex;}
.overlay-bg{background:rgba(0,0,0,0.4);}
.overlay-solid{background:linear-gradient(135deg,var(--bg1),var(--bg2));}

/* ===== VOCAB ===== */
.vocab-panel{background:var(--white);border-radius:16px;padding:22px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.2);}
.vocab-title{font-size:17px;font-weight:700;margin-bottom:14px;color:var(--text);}
.vocab-item{padding:10px;border-radius:8px;background:#F8FAFC;margin-bottom:8px;border-left:4px solid var(--accent1);}
.vocab-term{font-weight:700;font-size:14px;color:var(--accent1);}
.vocab-def{font-size:13px;color:var(--textLight);margin-top:2px;line-height:1.4;}
.vocab-close{padding:10px 22px;border-radius:8px;background:var(--accent1);color:#fff;font-weight:700;font-size:14px;margin-top:10px;}

/* ===== CELEBRATION ===== */
.celeb-card{background:var(--white);border-radius:20px;padding:28px;text-align:center;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.2);animation:celebPop 0.4s;}
@keyframes celebPop{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.celeb-title{font-size:20px;font-weight:800;color:var(--accent1);margin-bottom:6px;}
.celeb-msg{font-size:14px;color:var(--text);margin-bottom:4px;line-height:1.5;}
.celeb-affirmation{font-size:16px;color:var(--accent2);font-weight:700;margin-top:6px;opacity:0;animation:fadeAff 1.5s 0.4s forwards;}
@keyframes fadeAff{0%{opacity:0;transform:translateY(6px)}30%{opacity:1;transform:translateY(0)}100%{opacity:1}}
.celeb-btns{display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap;}
.celeb-btn{padding:12px 22px;border-radius:var(--radius);font-size:15px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--accent1),var(--accent2));min-height:48px;}
.celeb-btn.secondary{background:linear-gradient(135deg,var(--accent3),#7C3AED);}

/* ===== SBS MODAL ===== */
.sbs-panel{background:var(--white);border-radius:16px;padding:22px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.2);}
.sbs-title{font-size:16px;font-weight:700;margin-bottom:10px;color:var(--accent1);}
.sbs-step{font-size:14px;line-height:1.6;color:var(--text);margin-bottom:10px;padding:10px;background:#F8FAFC;border-radius:8px;border-left:3px solid var(--accent1);display:none;}
.sbs-step.active{display:block;}
.sbs-nav{display:flex;gap:10px;justify-content:flex-end;}
.sbs-btn{padding:10px 20px;border-radius:8px;font-weight:700;font-size:14px;color:#fff;background:var(--accent1);min-height:44px;}

/* ===== ANTI-GUESS ===== */
.ag-card{background:var(--white);border-radius:16px;padding:26px;max-width:380px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.2);}
.ag-card h3{font-size:17px;font-weight:700;color:var(--text);margin-bottom:8px;}
.ag-card p{font-size:14px;color:var(--textLight);line-height:1.6;}
.ag-timer{font-size:28px;font-weight:800;color:var(--accent1);margin-top:10px;}

/* ===== START SCREEN ===== */
.start-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--bg1),var(--bg2));z-index:700;display:flex;align-items:center;justify-content:center;}
.start-overlay.hidden{display:none;}
.start-card{background:var(--white);border-radius:20px;padding:32px;max-width:460px;width:92%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.12);}
.start-card h1{font-size:20px;font-weight:800;color:var(--text);margin-bottom:4px;}
.start-card .subtitle{font-size:15px;color:var(--accent1);margin-bottom:14px;font-weight:600;}
.start-card p{font-size:14px;color:var(--textLight);line-height:1.5;margin-bottom:16px;}
.start-card label{display:flex;flex-direction:column;text-align:left;font-weight:700;font-size:13px;color:var(--text);gap:4px;}
.start-card input{width:100%;padding:10px;border:2px solid #E2E8F0;border-radius:8px;font-size:15px;font-family:inherit;}
.start-card input:focus{border-color:var(--accent1);outline:none;}
.start-btn{padding:14px 36px;border-radius:var(--radius);font-size:17px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 4px 16px rgba(59,130,246,0.25);margin-top:16px;}
.start-btn:hover{transform:scale(1.03);}

/* ===== RECEIPT ===== */
.receipt-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--bg1),var(--bg2));z-index:600;display:none;overflow-y:auto;}
.receipt-overlay.show{display:flex;justify-content:center;padding:20px;}
.receipt-card{background:var(--white);border-radius:20px;padding:26px;max-width:580px;width:100%;box-shadow:var(--shadow);margin:auto;}
.receipt-header{text-align:center;margin-bottom:16px;}
.receipt-header h2{font-size:19px;color:var(--text);}
.receipt-header h3{font-size:14px;color:var(--textLight);}
.name-input-wrap{display:flex;gap:8px;margin:14px 0;align-items:center;}
.name-input-wrap input{flex:1;padding:10px;border:2px solid #E2E8F0;border-radius:8px;font-size:15px;font-family:inherit;}
.name-input-wrap button{padding:10px 18px;border-radius:8px;background:var(--accent1);color:#fff;font-weight:700;}
.overall-score{text-align:center;margin:18px 0;}
.overall-pct{font-size:48px;font-weight:800;}
.overall-label{font-size:15px;font-weight:700;margin-top:2px;}
.receipt-table{width:100%;border-collapse:collapse;margin:14px 0;font-size:13px;}
.receipt-table th{background:#F1F5F9;padding:7px;text-align:left;font-weight:700;border-bottom:2px solid #E2E8F0;}
.receipt-table td{padding:7px;border-bottom:1px solid #F1F5F9;}
.receipt-table tr:nth-child(even) td{background:#FAFBFC;}
.receipt-table .bonus-row td{background:#FEF9C3;font-style:italic;}
.receipt-footer{text-align:center;margin-top:14px;font-size:13px;color:var(--text);font-weight:600;line-height:1.5;}
.print-btn{padding:12px 26px;border-radius:var(--radius);background:var(--accent1);color:#fff;font-weight:700;font-size:15px;margin-top:10px;}
.restart-btn{padding:8px 18px;border-radius:8px;background:#F1F5F9;color:var(--text);font-weight:600;font-size:13px;margin-top:8px;border:1px solid #E2E8F0;}
.sc-green{color:var(--correct)}.sc-yellow{color:var(--warn)}.sc-red{color:var(--wrong)}

/* ===== CONFETTI ===== */
#confettiCanvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:410;}

/* ===== PRINT ===== */
@media print{
  .top-bar,.bottom-bar,.main-area,.start-overlay,.overlay,.ag-screen,#confettiCanvas{display:none!important;}
  .receipt-overlay{position:static!important;display:block!important;}
  .receipt-card{box-shadow:none;max-width:100%;}
  .print-btn,.restart-btn{display:none!important;}
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact;}
}

/* ===== MOBILE ===== */
@media(max-width:900px){
  .main-area{flex-direction:column;}
  .left-panel{width:100%;min-width:0;max-height:160px;border:none;border-bottom:2px solid #E2E8F0;flex-direction:row;flex-wrap:wrap;overflow-x:auto;padding:8px 10px;gap:8px;}
  .right-panel{width:100%;min-width:0;max-height:140px;border:none;border-top:2px solid #E2E8F0;padding:8px 10px;}
  .arena-wrap{min-height:220px;}
  .slider-group{min-width:130px;flex:1;}
  .interaction-zone{max-height:55vh;padding:12px 10px;}
}
@media(max-width:500px){
  .opt-card,.predict-card{min-width:100%;font-size:13px;}
  .iz-prompt{font-size:14px;}
  .dtm-drag,.seq-card,.claim-card{font-size:11px;padding:8px 10px;}
  .interaction-zone{max-height:60vh;}
}
</style>
</head>
<body>

<!-- START SCREEN -->
<div class="start-overlay" id="startScreen">
<div class="start-card">
<h1>Volcano â€” Cause-and-Effect Lab</h1>
<div class="subtitle">You control what's inside the volcano â€” can you make it explode on purpose?</div>
<div style="display:flex;flex-direction:column;gap:10px;margin:14px 0">
<label>Your Name<input type="text" id="startStudentName" placeholder="Type your name"></label>
<label>Your Teacher's Name<input type="text" id="startTeacherName" placeholder="e.g. Mr. Jawad" value="Mr. Jawad"></label>
</div>
<p>8 rounds. Adjust the sliders. Watch what happens. Prove what you learned.</p>
<button class="start-btn" onclick="startGame()">Start Lab</button>
</div>
</div>

<!-- TOP BAR -->
<div class="top-bar" id="topBar" style="display:none">
<div class="tb-left">
<span class="phase-badge" id="phaseBadge">CHANGE</span>
<span class="round-name" id="roundName">Round 1</span>
</div>
<div class="tb-right">
<span class="score-display" id="scoreDisplay">Score: 0</span>
<div class="progress-wrap"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
</div>
</div>

<!-- MAIN AREA -->
<div class="main-area" id="mainArea" style="display:none">
<div class="left-panel" id="leftPanel">
<div id="guidedMsg" class="guided-overlay" style="display:none"></div>
<div class="slider-group" id="thickGroup">
<div class="slider-label">THICKNESS <span class="lock-icon" id="thickLock" style="display:none"></span></div>
<div class="slider-wrap" id="thickSliderWrap">
<input type="range" id="thickSlider" min="0" max="2" step="1" value="0">
<div class="slider-ticks"><span>Thin</span><span>Medium</span><span>Thick</span></div>
</div>
<div class="slider-value" id="thickValue">Thin</div>
</div>
<div class="slider-group" id="gasGroup">
<div class="slider-label">GAS AMOUNT <span class="lock-icon" id="gasLock" style="display:none"></span></div>
<div class="slider-wrap gas" id="gasSliderWrap">
<input type="range" id="gasSlider" min="0" max="2" step="1" value="0">
<div class="slider-ticks"><span>Low</span><span>Medium</span><span>High</span></div>
</div>
<div class="slider-value" id="gasValue">Low</div>
</div>
<button class="test-btn" id="testBtn" disabled onclick="pressTest()">TEST</button>
</div>

<div class="center-panel">
<div class="arena-wrap" id="arenaWrap"><canvas id="volcanoCanvas"></canvas><div class="focus-prompt" id="focusPrompt" style="display:none"></div></div>
<div class="interaction-zone" id="interactionZone" style="display:none"></div>
</div>

<div class="right-panel" id="rightPanel">
<div class="dt-title">Data Table</div>
<table class="data-table" id="dataTable">
<thead><tr><th>Rnd</th><th>Thick</th><th>Gas</th><th>Press</th><th>Eruption</th><th>Danger</th></tr></thead>
<tbody id="dataBody"></tbody>
</table>
</div>
</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar" id="bottomBar" style="display:none">
<div class="bb-left">
<button class="bb-btn" onclick="showVocab()">ðŸ“– Vocab</button>
<button class="bb-btn" id="hintBtn" onclick="useHint()" style="display:none">ðŸ’¡ Hint</button>
<button class="bb-btn" id="resetRoundBtn" onclick="resetCurrentRound()" style="display:none">Restart Round</button>
</div>
<div class="bb-center" id="roundCounter">Round 1 of 8</div>
<button class="bb-btn" onclick="toggleReadAloud()">ðŸ”Š</button>
</div>

<!-- VOCAB POPUP -->
<div class="overlay overlay-bg" id="vocabOverlay">
<div class="vocab-panel">
<div class="vocab-title">Key Vocabulary</div>
<div class="vocab-item"><div class="vocab-term">MAGMA</div><div class="vocab-def">Melted rock under Earth's surface</div></div>
<div class="vocab-item" style="border-color:var(--accent3)"><div class="vocab-term" style="color:var(--accent3)">PRESSURE</div><div class="vocab-def">Force pushing outward from inside</div></div>
<div class="vocab-item" style="border-color:var(--warn)"><div class="vocab-term" style="color:var(--warn)">THICKNESS</div><div class="vocab-def">How easily magma flows</div></div>
<div class="vocab-item" style="border-color:var(--wrong)"><div class="vocab-term" style="color:var(--wrong)">ERUPTION</div><div class="vocab-def">Magma escaping to the surface</div></div>
<button class="vocab-close" onclick="hideVocab()">Close</button>
</div>
</div>

<!-- CELEBRATION -->
<div class="overlay overlay-bg" id="celebOverlay"><div class="celeb-card" id="celebCard"></div></div>

<!-- SBS MODAL -->
<div class="overlay overlay-bg" id="sbsOverlay"><div class="sbs-panel" id="sbsPanel"></div></div>

<!-- ANTI-GUESS -->
<div class="overlay overlay-bg" id="agScreen"><div class="ag-card" id="agCard"></div></div>

<!-- CONFETTI -->
<canvas id="confettiCanvas"></canvas>

<!-- RECEIPT -->
<div class="receipt-overlay" id="receiptOverlay"></div>

<script>
// ====== SAFE UTILITIES ======
function safeCall(fn,msg){try{fn();}catch(e){console.error(msg,e);}}
const $=id=>document.getElementById(id);
function show(el){if(typeof el==='string')el=$(el);if(el)el.style.display='';}
function hide(el){if(typeof el==='string')el=$(el);if(el)el.style.display='none';}

// ====== AUDIO (LAZY) ======
let audioCtx=null;
function getAudioContext(){
  if(!audioCtx)try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}
  return audioCtx;
}
function playTone(freq,dur){safeCall(()=>{const c=getAudioContext();if(!c)return;const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=freq;g.gain.value=0.12;o.start();g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+dur);o.stop(c.currentTime+dur);},'audio');}
function playCorrect(){playTone(523,0.1);setTimeout(()=>playTone(659,0.1),100);setTimeout(()=>playTone(784,0.15),200);}
function playWrong(){playTone(200,0.2);}

// ====== SPEECH (LAZY) ======
let speechReady=false,readAloud=true,resumeInterval=null;
function initSpeech(){if(window.speechSynthesis)speechReady=true;}
function speak(text,cb){
  if(!readAloud||!speechReady){if(cb)setTimeout(cb,Math.min(text.length*50,5000));return;}
  safeCall(()=>{
    speechSynthesis.cancel();clearInterval(resumeInterval);
    const u=new SpeechSynthesisUtterance(text);u.rate=0.85;
    const to=setTimeout(()=>{speechSynthesis.cancel();clearInterval(resumeInterval);if(cb)cb();},text.length*80+3000);
    resumeInterval=setInterval(()=>{if(speechSynthesis.speaking)speechSynthesis.resume();},10000);
    u.onend=()=>{clearTimeout(to);clearInterval(resumeInterval);if(cb)cb();};
    u.onerror=()=>{clearTimeout(to);clearInterval(resumeInterval);if(cb)cb();};
    speechSynthesis.speak(u);
  },'speech');
}
function toggleReadAloud(){readAloud=!readAloud;if(!readAloud&&speechReady)try{speechSynthesis.cancel();}catch(e){}}

// ====== TEACHER AFFIRMATIONS ======
let teacherName="Mr. Jawad",studentName="";
const skillAffirmations=[
  (t,s,sk)=>`${s}, that's strong ${sk} â€” ${t} is proud of you!`,
  (t,s,sk)=>`${t} sees you ${sk} like a real scientist, ${s}!`,
  (t,s,sk)=>`Great ${sk}, ${s}! ${t} knew you could do it!`,
  (t,s,sk)=>`${s}, you just nailed ${sk} â€” ${t} is impressed!`,
  (t,s,sk)=>`That's exactly the kind of ${sk} ${t} loves to see, ${s}!`,
  (t,s,sk)=>`${t} says: ${s}, your ${sk} is on point!`,
  (t,s,sk)=>`${s} is showing ${t} what real ${sk} looks like!`,
  (t,s,sk)=>`Keep that ${sk} energy going, ${s} â€” ${t} sees you!`
];
const skillLabels={
  "Observe the effect of one variable while another is controlled":"observation skills",
  "Compare outcomes when one variable changes and the other stays constant":"comparing skills",
  "Observe how changing the second variable affects the outcome":"variable testing",
  "Identify a pattern across multiple data points":"pattern finding",
  "Predict an outcome using observed patterns before testing":"predicting skills",
  "Predict an outcome and confirm using the observed pattern":"predicting skills",
  "Work backward from an outcome to identify the cause":"reverse thinking",
  "Apply the pattern to a real-world decision using data":"real-world thinking"
};
let lastAffIdx=-1;
function getAffirmation(ri){
  const r=ROUNDS[ri!==undefined?ri:GS.currentRound];
  const sk=skillLabels[r.scienceSkill]||"science thinking";
  const s=studentName||"Scientist";const t=teacherName||"Your teacher";
  let i;do{i=Math.floor(Math.random()*skillAffirmations.length);}while(i===lastAffIdx&&skillAffirmations.length>1);
  lastAffIdx=i;return skillAffirmations[i](t,s,sk);
}

// ====== GAME STATE ======
const thickLabels=["Thin","Medium","Thick"];
const gasLabels=["Low","Medium","High"];
const OUTCOME_MATRIX={
  "0-0":{pressure:"Low",eruption:"Gentle Flow",danger:"Low",pressN:0.15,dangerN:0.15},
  "0-1":{pressure:"Low-Medium",eruption:"Moderate Flow",danger:"Low-Medium",pressN:0.3,dangerN:0.3},
  "0-2":{pressure:"Medium",eruption:"Moderate Eruption",danger:"Medium",pressN:0.5,dangerN:0.5},
  "1-0":{pressure:"Medium",eruption:"Slow Buildup",danger:"Medium",pressN:0.45,dangerN:0.45},
  "1-1":{pressure:"Medium-High",eruption:"Moderate Eruption",danger:"Medium-High",pressN:0.6,dangerN:0.6},
  "1-2":{pressure:"High",eruption:"Explosive Eruption",danger:"High",pressN:0.8,dangerN:0.8},
  "2-0":{pressure:"High",eruption:"Warning State",danger:"High",pressN:0.75,dangerN:0.75},
  "2-1":{pressure:"Very High",eruption:"Large Eruption",danger:"Very High",pressN:0.88,dangerN:0.88},
  "2-2":{pressure:"Extreme",eruption:"Violently Explosive",danger:"Extreme",pressN:1.0,dangerN:1.0}
};

const GS={
  studentName:"",currentRound:0,phase:"",
  levels:[],overallScore:0,
  prevThick:-1,prevGas:-1,
  roundStartTime:0,phaseStartTime:0,
  wrongCount:0,hintsUsed:0,resets:0,
  consecutiveFastWrongs:0,
  prediction:null,predictionCorrect:null,
  recordError:null,recordCorrected:false,
  _recordAttempts:0,_lastOutcome:null,_lastTh:0,_lastGs:0,
  confirmDisabledUntil:0,
  animState:{},
  _ccSelection:null,_ccEliminated:[],
  _dtmMap:{},_dtmSel:null,
  _seqSlots:null,_seqSel:null,
  _claimSelected:null,_claimEliminated:null,
  _hsClickCount:0,_hsDone:false
};

// ====== ROUND DATA ======
const ROUNDS=[
// ROUND 1
{
  num:1,name:"First Eruption â€” Thin + High Gas",required:true,
  phase:"explore",scienceSkill:"Observe the effect of one variable while another is controlled",
  focusPrompt:"Watch the pressure gauge on the left â€” how high does it fill when the magma is thin?",
  lockThick:false,lockGas:true,gasLockVal:2,thickLockVal:null,
  guided:"Gas is locked at HIGH. Slide thickness to THIN. Press TEST.",
  guidedThick:0,guidedGas:null,
  expectedThick:0,expectedGas:2,
  recordError:null,
  prove:{
    mechanic:"coach-click",
    prompt:"The magma was thin â€” why wasn't the eruption gentle?",
    options:["High gas still built some pressure","Thin magma always causes explosions","The volcano was too hot"],
    correct:0,
    wrongFeedback:[
      null,
      "Look at the data table. Is thin magma always explosive? You will test more later.",
      "Temperature is not a variable in this lab. Look at the two sliders."
    ],
    arenaHighlight:["gas","thickness","sliders"]
  },
  hintLadder:{
    hint1:{text:"Look at the gas slider â€” it is locked at HIGH. Even thin magma has to deal with all that gas.",target:"gas"},
    hint2:{text:"Temperature is not something you can control here. Focus on the two variables you CAN see.",eliminate:2},
    stepByStep:{panels:[
      {text:"The gas slider is locked at HIGH â€” lots of gas in the magma."},
      {text:"Even thin magma cannot let ALL that gas escape â€” some pressure built up."},
      {text:"Which answer says gas still built pressure? Select it now."}
    ]}
  }
},
// ROUND 2
{
  num:2,name:"Same Gas, Thick Magma",required:true,
  phase:"explore",scienceSkill:"Compare outcomes when one variable changes and the other stays constant",
  focusPrompt:"Watch the pressure gauge again â€” compare how high it fills now with thick magma versus thin magma in Round 1.",
  lockThick:false,lockGas:true,gasLockVal:2,thickLockVal:null,
  guided:"Gas is still locked at HIGH. Now slide thickness to THICK. Press TEST.",
  guidedThick:2,guidedGas:null,
  expectedThick:2,expectedGas:2,
  recordError:{col:"eruption",wrongVal:"Large Eruption",correctVal:"Violently Explosive",
    nudge:"Look at Row 2 again. Does 'Large Eruption' match that massive blast you just saw? Compare it to Round 1's 'Moderate Eruption.'"},
  prove:{
    mechanic:"drag-to-match",
    prompt:"Drag each label to the correct round.",
    items:["Moderate Eruption","Extreme Pressure","Gas Escaped Easily"],
    zones:[
      {label:"Round 1 (Thin + High)",accepts:[0,2]},
      {label:"Round 2 (Thick + High)",accepts:[1]}
    ],
    wrongFeedback:"Look at the pressure column in your data table. Which round had higher pressure?"
  },
  hintLadder:{
    hint1:{text:"Look at the pressure column in your data table â€” which round shows higher pressure?",target:"dataPress"},
    hint2:{text:"Thin magma lets bubbles rise â€” you saw that in Round 1. 'Gas Escaped Easily' locks into Round 1.",lockItem:{item:2,zone:0}},
    stepByStep:{panels:[
      {text:"Round 1 had thin magma â€” gas bubbles escaped, so pressure was only medium."},
      {text:"Round 2 had thick magma â€” gas got trapped, so pressure was extreme."},
      {text:"Drag each label to match. Extreme pressure goes with the thick magma round."}
    ]}
  }
},
// ROUND 3
{num:3,name:"Thick Magma, Low Gas",required:true,phase:"pattern",scienceSkill:"Observe how changing the second variable affects the outcome",
focusPrompt:"Watch the pressure gauge â€” thick magma is still here, but now gas is low. Does the eruption match Round 2?",
lockThick:true,lockGas:false,thickLockVal:2,gasLockVal:null,
guided:"Thickness is locked at THICK. Slide gas to LOW. Press TEST.",
guidedThick:null,guidedGas:0,expectedThick:2,expectedGas:0,recordError:null,
prove:{
  mechanic:"hotspot",
  prompt:"Tap the part of the volcano that proves gas matters.",
  wrongFeedback:[
    "The crater shows the result, not the cause. What is different INSIDE the magma?",
    "The cracks show pressure building â€” but what controls how much pressure? Look inside."
  ]
},
hintLadder:{
  hint1:{text:"Look inside the magma chamber â€” count the gas bubbles. Compare to Round 2.",target:"gas"},
  hint2:{text:"The answer is inside the volcano, not outside. The entire magma chamber interior is where to look.",target:"gas"},
  stepByStep:{panels:[
    {text:"Round 2 had HIGH gas â€” lots of big bubbles trapped in the thick magma."},
    {text:"Round 3 has LOW gas â€” only a few small bubbles. Less gas = less pressure = no eruption yet."},
    {text:"Tap the gas bubbles inside the magma chamber to show gas matters."}
  ]}
}},
// ROUND 4
{num:4,name:"Thick Magma, Medium Gas",required:true,phase:"pattern",scienceSkill:"Identify a pattern across multiple data points",
focusPrompt:"Watch the pressure gauge and the eruption â€” with thick magma, you have now seen low gas and high gas. Where does medium gas land?",
lockThick:true,lockGas:false,thickLockVal:2,gasLockVal:null,
guided:"Thickness is still locked at THICK. Slide gas to MEDIUM. Press TEST.",
guidedThick:null,guidedGas:1,expectedThick:2,expectedGas:1,recordError:null,
prove:{
  mechanic:"sequence",
  prompt:"Put the thick-magma eruptions in order: weakest to strongest.",
  items:["Low Gas: Warning State","Medium Gas: Large Eruption","High Gas: Violently Explosive"],
  correct:[0,1,2],
  wrongFeedback:"Look at the eruption type column for Rounds 2, 3, and 4. Which was the weakest eruption?"
},
hintLadder:{
  hint1:{text:"Look at the Eruption Type column in your data table â€” read down rows 2, 3, and 4.",target:"dataPress"},
  hint2:{text:"'Low Gas: Warning State' is the weakest â€” it did not even erupt. That goes first.",lockFirst:true},
  stepByStep:{panels:[
    {text:"Low gas made the volcano warn but not erupt â€” that is weakest."},
    {text:"Medium gas caused a large eruption â€” stronger. High gas caused a violent explosion â€” strongest."},
    {text:"Drag them in order: Low Gas first, then Medium Gas, then High Gas."}
  ]}
}},
// ROUND 5
{num:5,name:"Predict â€” Medium + Medium",required:true,phase:"predict",scienceSkill:"Predict an outcome using observed patterns before testing",
focusPrompt:"Before you press TEST, look at your data table â€” what pattern do you see about medium settings?",
lockThick:false,lockGas:false,thickLockVal:null,gasLockVal:null,guided:null,guidedThick:null,guidedGas:null,expectedThick:1,expectedGas:1,
prediction:{prompt:"If I set thickness to MEDIUM and gas to MEDIUM, I think...",options:["The volcano will have a moderate eruption","The volcano will have a gentle flow"],correct:0,setThick:1,setGas:1},
recordError:{col:"pressure",wrongVal:"Low",correctVal:"Medium-High",nudge:"Look at Row 5's pressure. You SAW the pressure gauge fill past the middle. Does 'Low' match?"},
prove:{
  mechanic:"coach-click",
  prompt:"Why was this eruption not as strong as thick magma rounds?",
  options:["Medium thickness trapped some gas but not all","Medium gas is always safe","The pressure gauge was broken"],
  correct:0,
  wrongFeedback:[
    null,
    "Look at your data table. In Round 4, thick magma + medium gas caused a large eruption. Medium gas is not always safe â€” thickness matters too.",
    "The pressure gauge worked fine â€” you just corrected the data. Focus on what the magma is doing."
  ],
  arenaHighlight:[null,"dataPress","gas"]
},
hintLadder:{
  hint1:{text:"Look at the magma chamber â€” some bubbles are escaping and some are trapped. Medium thickness does not trap ALL the gas.",target:"gas"},
  hint2:{text:"The gauge is working correctly. Focus on what the magma thickness does to the gas.",eliminate:2},
  stepByStep:{panels:[
    {text:"With thick magma, ALL gas gets trapped â€” extreme pressure."},
    {text:"With medium magma, SOME gas escapes â€” less pressure builds up."},
    {text:"Select the answer that says medium thickness trapped some gas but not all."}
  ]}
}},
// ROUND 6
{num:6,name:"Predict â€” Thin + Low",required:true,phase:"predict",scienceSkill:"Predict an outcome and confirm using the observed pattern",
focusPrompt:"Before you press TEST, look at Round 1 â€” thin magma with high gas was a moderate eruption. What happens with thin magma and LOW gas?",
lockThick:false,lockGas:false,thickLockVal:null,gasLockVal:null,guided:null,guidedThick:null,guidedGas:null,expectedThick:0,expectedGas:0,
prediction:{prompt:"If I set thickness to THIN and gas to LOW, I think...",options:["The volcano will build high pressure","The volcano will have a gentle flow"],correct:1,setThick:0,setGas:0},
recordError:null,
prove:{
  mechanic:"drag-to-match",
  prompt:"Drag each combination to its eruption type.",
  items:["Thin + Low Gas","Medium + Medium Gas","Thick + High Gas"],
  zones:[
    {label:"Gentle Flow",accepts:[0]},
    {label:"Moderate Eruption",accepts:[1]},
    {label:"Violently Explosive",accepts:[2]}
  ],
  wrongFeedback:"Look at Row 6 in your data table. Thin + Low gave you the weakest result."
},
hintLadder:{
  hint1:{text:"Look at the Eruption Type column in your data table â€” match each row's combination to its result.",target:"dataPress"},
  hint2:{text:"'Thick + High Gas' goes with 'Violently Explosive' â€” that is placed. Now match the other two.",lockItem:{item:2,zone:2}},
  stepByStep:{panels:[
    {text:"Thin + Low = everything is low. That is a gentle flow."},
    {text:"Medium + Medium = some trapping. That is a moderate eruption."},
    {text:"Thick + High = everything trapped. That is violently explosive. Drag each to match."}
  ]}
}},
// ROUND 7 (BONUS)
{num:7,name:"Reverse Engineer â€” Moderate Eruption",required:false,phase:"challenge",scienceSkill:"Work backward from an outcome to identify the cause",
focusPrompt:"Look at the eruption result shown at the crater â€” now find a slider combination that matches it.",
lockThick:false,lockGas:false,thickLockVal:null,gasLockVal:null,guided:null,guidedThick:null,guidedGas:null,expectedThick:null,expectedGas:null,
reverseTarget:"Moderate Eruption",
recordError:{col:"gas",wrongVal:"Low",correctVal:null,nudge:"Check the Gas column for Row 7. Does it match where your gas slider is right now?"},
prove:{
  mechanic:"claim-builder",
  prompt:"Build a claim: more than one combination can cause the same eruption.",
  items:["Thin + High Gas = Moderate Eruption","Medium + Medium Gas = Moderate Eruption","Thick + Low Gas = Warning State"],
  correct:[0,1],
  frame:"A moderate eruption can happen because ___.",
  wrongFeedback:"Look at your data table. Did thick + low gas cause a moderate eruption, or something different?"
},
hintLadder:{
  hint1:{text:"Look at the Eruption Type column in your data table â€” find every row that says 'Moderate Eruption.'",target:"dataPress"},
  hint2:{text:"'Thick + Low Gas = Warning State' does not match â€” remove it. Focus on the two that DO say moderate eruption.",eliminateDistractor:2},
  stepByStep:{panels:[
    {text:"Your data table shows two different combinations that both caused moderate eruptions."},
    {text:"Thin + High AND Medium + Medium both produced the same result â€” different paths, same eruption."},
    {text:"Drag both matching evidence cards into the claim frame."}
  ]}
}},
// ROUND 8 (BONUS)
{num:8,name:"Scenario â€” City Near a Volcano",required:false,phase:"challenge",scienceSkill:"Apply the pattern to a real-world decision using data",
focusPrompt:"Look at the scientist's report about this volcano â€” use your data table to predict what eruption the city should prepare for.",
lockThick:false,lockGas:false,thickLockVal:null,gasLockVal:null,guided:null,guidedThick:null,guidedGas:null,expectedThick:1,expectedGas:2,
prediction:{prompt:"A city sits next to a volcano. Scientists report: MEDIUM thickness magma. Gas levels are RISING toward HIGH. Based on your data, what eruption should the city prepare for?",options:["Gentle flow â€” low danger, no evacuation needed","Explosive eruption â€” high danger, evacuate now"],correct:1,setThick:1,setGas:2,isScenario:true},
recordError:null,
prove:{
  mechanic:"sequence",
  prompt:"Put the cause-and-effect chain in order for this city's volcano.",
  items:["Gas levels rise inside the magma","Medium-thick magma traps most of the gas","Pressure builds to dangerous levels","Explosive eruption threatens the city"],
  correct:[0,1,2,3],
  wrongFeedback:"The eruption is the last thing that happens â€” it is the EFFECT. What started the chain?"
},
hintLadder:{
  hint1:{text:"Look inside the magma chamber â€” what happened FIRST? The gas started rising.",target:"gas"},
  hint2:{text:"'Gas levels rise' is the starting event â€” it goes first. Now figure out what happens next inside the thick magma.",lockFirst:true},
  stepByStep:{panels:[
    {text:"First, gas levels rise inside the magma â€” that is what the scientists measured."},
    {text:"The medium-thick magma traps most of that gas, and trapped gas builds pressure."},
    {text:"High pressure causes an explosive eruption. Drag the cards: gas, trapping, pressure, eruption."}
  ]}
}}
];

// ====== HUD ======
function updateHUD(){
  const r=ROUNDS[GS.currentRound];
  $('roundName').textContent='Round '+r.num+': '+r.name;
  $('roundCounter').textContent='Round '+r.num+' of 8';
  const totalScore=GS.levels.reduce((s,l)=>s+(l.score||0),0);
  const completed=GS.levels.filter(l=>l.completed).length;
  $('scoreDisplay').textContent='Score: '+totalScore;
  $('progressFill').style.width=(completed/8*100)+'%';
}
function setPhase(p){
  GS.phase=p;GS.phaseStartTime=Date.now();
  const labels={change:"CHANGE",watch:"WATCH",record:"RECORD",prove:"PROVE",predict:"PREDICT"};
  $('phaseBadge').textContent=labels[p]||(p||'').toUpperCase();
  $('phaseBadge').style.background=p==='watch'?'var(--accent3)':p==='prove'?'var(--accent2)':p==='record'?'var(--warn)':'var(--accent1)';
}
function showFocus(text,dur){
  const fp=$('focusPrompt');if(!fp)return;fp.textContent=text;fp.className='focus-prompt';fp.style.display='';
  setTimeout(()=>{fp.classList.add('fade');},dur||3000);
  setTimeout(()=>{fp.style.display='none';},dur?dur+5000:8000);
}

// ====== VOLCANO CANVAS ======
const canvas=$('volcanoCanvas'),ctx=canvas.getContext('2d');
let cW=800,cH=500,animFrame=null;
let bubbles=[],targetPressure=0,currentPressure=0;
let eruptionPhase=0,eruptTypeLabel="";
let magmaThick=0,magmaGas=0;
let shakeX=0,shakeY=0,shakeIntensity=0;
let dangerLevel=0,targetDanger=0;
let warningCracks=false,cityVisible=false,highlightZone="";

function resizeCanvas(){
  const w=$('arenaWrap');if(!w)return;cW=w.clientWidth;cH=w.clientHeight;
  canvas.width=cW;canvas.height=cH;
}
window.addEventListener('resize',resizeCanvas);

function initBubbles(){
  bubbles=[];
  const count=magmaGas===0?4:magmaGas===1?10:22;
  const cx0=cW*0.3,cy0=cH*0.76,cw0=cW*0.4,ch0=cH*0.18;
  for(let i=0;i<count;i++){
    bubbles.push({x:cx0+Math.random()*cw0,y:cy0+Math.random()*ch0,
      r:(magmaGas===0?3:magmaGas===1?5:8)+Math.random()*4,
      speed:(magmaThick===2?0.15:magmaThick===1?0.4:0.8)+Math.random()*0.3,
      ox:Math.random()*Math.PI*2});
  }
}
function getMagmaColor(){
  if(magmaThick===0)return{main:'#FF8C00',dark:'#FF6600',light:'#FFA500'};
  if(magmaThick===1)return{main:'#D4380D',dark:'#B71C1C',light:'#E65100'};
  return{main:'#8B0000',dark:'#5D0000',light:'#A52A2A'};
}

function drawVolcano(t){
  ctx.save();ctx.translate(shakeX,shakeY);
  // Sky
  const sky=ctx.createLinearGradient(0,0,0,cH*0.4);sky.addColorStop(0,'#B3E5FC');sky.addColorStop(1,'#E1F5FE');
  ctx.fillStyle=sky;ctx.fillRect(0,0,cW,cH*0.4);
  // Ground
  ctx.fillStyle='#8D6E63';ctx.fillRect(0,cH*0.78,cW,cH*0.22);
  const grd=ctx.createLinearGradient(0,cH*0.78,0,cH*0.82);grd.addColorStop(0,'#A1887F');grd.addColorStop(1,'#8D6E63');
  ctx.fillStyle=grd;ctx.fillRect(0,cH*0.78,cW,cH*0.04);
  // Mountain
  const pX=cW*0.5,pY=cH*0.18,bL=cW*0.15,bR=cW*0.85,bY=cH*0.78;
  ctx.beginPath();ctx.moveTo(bL,bY);ctx.lineTo(pX-30,pY);ctx.lineTo(pX+30,pY);ctx.lineTo(bR,bY);ctx.closePath();
  const mg=ctx.createLinearGradient(0,pY,0,bY);mg.addColorStop(0,'#78909C');mg.addColorStop(0.4,'#607D8B');mg.addColorStop(1,'#546E7A');
  ctx.fillStyle=mg;ctx.fill();
  // Snow
  ctx.beginPath();ctx.moveTo(pX-35,pY+15);ctx.lineTo(pX-28,pY);ctx.lineTo(pX+28,pY);ctx.lineTo(pX+35,pY+15);
  ctx.quadraticCurveTo(pX,pY+25,pX-35,pY+15);ctx.fillStyle='rgba(255,255,255,0.7)';ctx.fill();
  // Crater
  ctx.beginPath();ctx.ellipse(pX,pY+5,28,10,0,0,Math.PI*2);ctx.fillStyle='#37474F';ctx.fill();
  // Underground
  const ugT=cH*0.72;
  const ug=ctx.createLinearGradient(0,ugT,0,cH);ug.addColorStop(0,'#5D4037');ug.addColorStop(0.5,'#4E342E');ug.addColorStop(1,'#3E2723');
  ctx.fillStyle=ug;ctx.fillRect(cW*0.2,ugT,cW*0.6,cH-ugT);
  ctx.strokeStyle='#6D4C41';ctx.lineWidth=2;ctx.strokeRect(cW*0.2,ugT,cW*0.6,cH-ugT);
  // Magma chamber
  const mc=getMagmaColor();
  const mcX=cW*0.3,mcY=cH*0.76,mcW=cW*0.4,mcH=cH*0.18;
  const mrg=ctx.createRadialGradient(mcX+mcW/2,mcY+mcH/2,10,mcX+mcW/2,mcY+mcH/2,mcW/2);
  mrg.addColorStop(0,mc.light);mrg.addColorStop(0.6,mc.main);mrg.addColorStop(1,mc.dark);
  ctx.fillStyle=mrg;
  ctx.beginPath();ctx.moveTo(mcX+10,mcY);ctx.lineTo(mcX+mcW-10,mcY);ctx.quadraticCurveTo(mcX+mcW,mcY,mcX+mcW,mcY+10);
  ctx.lineTo(mcX+mcW,mcY+mcH-10);ctx.quadraticCurveTo(mcX+mcW,mcY+mcH,mcX+mcW-10,mcY+mcH);
  ctx.lineTo(mcX+10,mcY+mcH);ctx.quadraticCurveTo(mcX,mcY+mcH,mcX,mcY+mcH-10);
  ctx.lineTo(mcX,mcY+10);ctx.quadraticCurveTo(mcX,mcY,mcX+10,mcY);ctx.fill();
  ctx.shadowColor=mc.light;ctx.shadowBlur=20;ctx.fillStyle='rgba(255,100,0,0.1)';ctx.fill();ctx.shadowBlur=0;
  // Thick texture
  if(magmaThick>=1){for(let i=0;i<(magmaThick===2?20:10);i++){const cx=mcX+20+Math.random()*(mcW-40),cy=mcY+10+Math.random()*(mcH-20);ctx.beginPath();ctx.arc(cx,cy,2+Math.random()*3,0,Math.PI*2);ctx.fillStyle=magmaThick===2?'rgba(80,0,0,0.5)':'rgba(120,30,0,0.4)';ctx.fill();}}
  // Magma label
  ctx.font='bold 11px sans-serif';ctx.fillStyle='#FFCC80';ctx.textAlign='center';ctx.fillText('MAGMA',mcX+mcW/2,mcY+mcH/2+4);
  // Vent
  const vX=pX-12,vW=24;const vg=ctx.createLinearGradient(vX,pY+10,vX,mcY);vg.addColorStop(0,'#37474F');vg.addColorStop(1,'#4E342E');
  ctx.fillStyle=vg;ctx.fillRect(vX,pY+10,vW,mcY-pY-10);
  // Pressure arrows
  const ac=Math.floor(currentPressure*6)+1,as=6+currentPressure*8;
  for(let i=0;i<ac;i++){const ay=pY+20+(mcY-pY-30)*(i/ac)+Math.sin(t*3+i)*5;ctx.beginPath();ctx.moveTo(pX-as/2,ay+as/2);ctx.lineTo(pX,ay-as/2);ctx.lineTo(pX+as/2,ay+as/2);ctx.closePath();ctx.fillStyle=`rgba(255,${180-currentPressure*100|0},0,${0.3+currentPressure*0.7})`;ctx.fill();}
  // Gas bubbles
  const mcBot=mcY+mcH;
  bubbles.forEach(b=>{b.y-=b.speed;b.x+=Math.sin(t*2+b.ox)*0.5;if(b.y<mcY)b.y=mcBot-5;ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,0.35)';ctx.fill();ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=1;ctx.stroke();});
  // Highlight zone
  if(highlightZone==='gas'){ctx.strokeStyle='rgba(255,215,0,0.8)';ctx.lineWidth=3;ctx.setLineDash([5,5]);ctx.strokeRect(mcX+5,mcY+5,mcW-10,mcH-10);ctx.setLineDash([]);}
  // Pressure gauge
  const gX=cW*0.08,gY=cH*0.2,gW=30,gH=cH*0.5;
  ctx.fillStyle='#263238';ctx.fillRect(gX-2,gY-2,gW+4,gH+4);
  [{c:'#22C55E',s:0,e:0.25},{c:'#EAB308',s:0.25,e:0.5},{c:'#F97316',s:0.5,e:0.75},{c:'#EF4444',s:0.75,e:1}].forEach(z=>{ctx.fillStyle=z.c+'40';ctx.fillRect(gX,gY+gH*(1-z.e),gW,gH*(z.e-z.s));});
  const fH=gH*currentPressure;const fg=ctx.createLinearGradient(0,gY+gH-fH,0,gY+gH);
  fg.addColorStop(0,currentPressure>0.75?'#EF4444':currentPressure>0.5?'#F97316':currentPressure>0.25?'#EAB308':'#22C55E');fg.addColorStop(1,'#FF6B00');
  ctx.fillStyle=fg;ctx.fillRect(gX,gY+gH-fH,gW,fH);ctx.fillStyle='rgba(255,255,255,0.6)';ctx.fillRect(gX,gY+gH-fH-2,gW,3);
  ctx.save();ctx.translate(gX-8,gY+gH/2);ctx.rotate(-Math.PI/2);ctx.font='bold 12px sans-serif';ctx.fillStyle='#B0BEC5';ctx.textAlign='center';ctx.fillText('PRESSURE',0,0);ctx.restore();
  if(highlightZone==='dataPress'||highlightZone==='pressure'){ctx.strokeStyle='rgba(255,215,0,0.8)';ctx.lineWidth=3;ctx.setLineDash([5,5]);ctx.strokeRect(gX-4,gY-4,gW+8,gH+8);ctx.setLineDash([]);}
  // Danger meter
  const dmX=cW*0.75,dmY=cH*0.05,dmW=cW*0.2,dmH=14;
  ctx.fillStyle='#263238';ctx.fillRect(dmX-1,dmY-1,dmW+2,dmH+2);ctx.fillStyle='#37474F';ctx.fillRect(dmX,dmY,dmW,dmH);
  const dF=dmW*dangerLevel;ctx.fillStyle=dangerLevel>0.8?'#EF4444':dangerLevel>0.6?'#F97316':dangerLevel>0.3?'#EAB308':'#22C55E';
  ctx.fillRect(dmX,dmY,dF,dmH);ctx.font='bold 10px sans-serif';ctx.fillStyle='#B0BEC5';ctx.textAlign='left';ctx.fillText('DANGER LEVEL',dmX,dmY-3);
  if(dangerLevel>0.8){ctx.fillStyle=`rgba(239,68,68,${0.5+Math.sin(t*5)*0.5})`;ctx.fillText(dangerLevel>=0.95?'EXTREME':'WARNING',dmX+dmW+5,dmY+11);}
  // Eruption
  if(eruptionPhase>0)drawEruption(t,pX,pY);
  // Warning cracks
  if(warningCracks){for(let i=0;i<5;i++){const cx=pX-60+i*30+Math.sin(t+i)*3,cy=pY+40+i*15;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+15+Math.sin(t*2+i)*5,cy+10);ctx.strokeStyle=`rgba(255,${140+Math.sin(t*3)*50|0},0,${0.5+Math.sin(t*4+i)*0.3})`;ctx.lineWidth=2;ctx.stroke();}for(let i=0;i<3;i++){const sx=pX-20+i*20,sy=pY+20-Math.sin(t*2+i)*10;ctx.beginPath();ctx.arc(sx,sy,3+Math.sin(t+i)*2,0,Math.PI*2);ctx.fillStyle='rgba(200,200,200,0.3)';ctx.fill();}}
  // City (R8)
  if(cityVisible){const cx=cW*0.78,cy=cH*0.72;ctx.fillStyle='#455A64';ctx.fillRect(cx,cy-30,12,30);ctx.fillRect(cx+15,cy-20,10,20);ctx.fillRect(cx+28,cy-35,14,35);ctx.fillRect(cx+45,cy-15,10,15);ctx.fillRect(cx+58,cy-25,12,25);ctx.font='bold 9px sans-serif';ctx.fillStyle='#CFD8DC';ctx.textAlign='center';ctx.fillText('CITY',cx+35,cy+12);if(dangerLevel>0.7){ctx.fillStyle=`rgba(239,68,68,${0.3+Math.sin(t*6)*0.3})`;ctx.fillRect(cx-5,cy-40,75,45);ctx.font='bold 11px sans-serif';ctx.fillStyle='#fff';ctx.fillText('EVACUATE',cx+35,cy-44);}}
  // Eruption label
  ctx.font='bold 10px sans-serif';ctx.fillStyle='#FFCC80';ctx.textAlign='center';ctx.fillText('ERUPTION',pX,pY-10);
  ctx.restore();
}

function drawEruption(t,px,py){
  if(eruptTypeLabel==='Gentle Flow'||eruptTypeLabel==='Moderate Flow'){
    const fs=eruptTypeLabel==='Gentle Flow'?1:1.5;ctx.fillStyle='#FF6D00';
    for(let i=0;i<8;i++){const lx=px-15+i*4+Math.sin(t*fs+i)*3,ly=py+10+i*5+Math.sin(t*2+i)*2;ctx.beginPath();ctx.arc(lx,ly,4+Math.sin(t+i)*2,0,Math.PI*2);ctx.fill();}
    ctx.fillStyle='rgba(255,140,0,0.4)';ctx.beginPath();ctx.arc(px,py+5,20,0,Math.PI*2);ctx.fill();
  } else if(eruptTypeLabel==='Moderate Eruption'){
    for(let i=0;i<15;i++){const ax=px+Math.sin(t*3+i*0.7)*30,ay=py-20-i*8+Math.sin(t*2+i)*5;ctx.beginPath();ctx.arc(ax,ay,3+Math.random()*3,0,Math.PI*2);ctx.fillStyle=i%2?'rgba(120,120,120,0.5)':'rgba(255,140,0,0.4)';ctx.fill();}
  } else if(eruptTypeLabel==='Large Eruption'){
    for(let i=0;i<25;i++){const ax=px+Math.sin(t*4+i)*40,ay=py-30-i*10+Math.sin(t*3+i)*8;ctx.beginPath();ctx.arc(ax,ay,4+Math.random()*4,0,Math.PI*2);ctx.fillStyle=i%3===0?'rgba(255,100,0,0.5)':'rgba(100,100,100,0.4)';ctx.fill();}
    for(let i=0;i<10;i++){const fx=px+(i%2?1:-1)*(30+i*8+Math.sin(t*2)*5),fy=py+20+i*3;ctx.beginPath();ctx.arc(fx,fy,5+Math.random()*3,0,Math.PI*2);ctx.fillStyle='rgba(130,130,130,0.4)';ctx.fill();}
    shakeIntensity=Math.max(shakeIntensity,2);
  } else if(eruptTypeLabel==='Explosive Eruption'){
    for(let i=0;i<35;i++){const ax=px+Math.sin(t*5+i)*50,ay=py-40-i*12+Math.sin(t*3+i)*10;ctx.beginPath();ctx.arc(ax,ay,5+Math.random()*5,0,Math.PI*2);ctx.fillStyle=i%2?'rgba(255,80,0,0.5)':'rgba(80,80,80,0.5)';ctx.fill();}
    for(let i=0;i<15;i++){const fx=px+(i%2?1:-1)*(40+i*10),fy=py+15+i*4;ctx.beginPath();ctx.arc(fx,fy,6,0,Math.PI*2);ctx.fillStyle='rgba(110,110,110,0.4)';ctx.fill();}
    shakeIntensity=Math.max(shakeIntensity,4);
  } else if(eruptTypeLabel==='Violently Explosive'){
    for(let i=0;i<50;i++){const ax=px+Math.sin(t*6+i)*70,ay=py-50-i*10+Math.sin(t*4+i)*12;ctx.beginPath();ctx.arc(ax,ay,5+Math.random()*7,0,Math.PI*2);ctx.fillStyle=i%3===0?'rgba(255,60,0,0.6)':i%3===1?'rgba(60,60,60,0.5)':'rgba(200,200,200,0.3)';ctx.fill();}
    for(let i=0;i<20;i++){const fx=px+(i%2?1:-1)*(50+i*12+Math.sin(t*2)*8),fy=py+10+Math.sin(t+i)*5;ctx.beginPath();ctx.arc(fx,fy,6+Math.random()*4,0,Math.PI*2);ctx.fillStyle='rgba(90,90,90,0.5)';ctx.fill();}
    for(let i=0;i<12;i++){ctx.fillStyle='rgba(80,50,30,0.6)';ctx.fillRect(px+(Math.random()-0.5)*cW*0.4,py-20+Math.random()*60,3+Math.random()*4,3+Math.random()*4);}
    shakeIntensity=Math.max(shakeIntensity,6);
  } else if(eruptTypeLabel==='Warning State'){warningCracks=true;
  } else if(eruptTypeLabel==='Slow Buildup'){ctx.fillStyle='rgba(255,180,0,0.3)';ctx.beginPath();ctx.arc(px,py+5,15+Math.sin(t*3)*5,0,Math.PI*2);ctx.fill();}
}

let animT=0;
function animLoop(){
  animT+=0.016;ctx.clearRect(0,0,cW,cH);
  currentPressure+=(targetPressure-currentPressure)*0.03;
  dangerLevel+=(targetDanger-dangerLevel)*0.03;
  if(shakeIntensity>0){shakeX=(Math.random()-0.5)*shakeIntensity;shakeY=(Math.random()-0.5)*shakeIntensity;shakeIntensity*=0.98;if(shakeIntensity<0.1)shakeIntensity=0;}else{shakeX=0;shakeY=0;}
  drawVolcano(animT);animFrame=requestAnimationFrame(animLoop);
}

// ====== SLIDERS ======
$('thickSlider').addEventListener('input',function(){magmaThick=parseInt(this.value);$('thickValue').textContent=thickLabels[magmaThick];initBubbles();checkTestReady();});
$('gasSlider').addEventListener('input',function(){magmaGas=parseInt(this.value);$('gasValue').textContent=gasLabels[magmaGas];initBubbles();checkTestReady();});
function checkTestReady(){
  const th=parseInt($('thickSlider').value),gs=parseInt($('gasSlider').value);
  $('testBtn').disabled=!((th!==GS.prevThick||gs!==GS.prevGas)&&(GS.phase==='change'));
}

// ====== START GAME ======
function startGame(){
  studentName=$('startStudentName').value.trim()||"Scientist";
  teacherName=$('startTeacherName').value.trim()||"Mr. Jawad";
  GS.studentName=studentName;
  document.title=teacherName+"'s Simulation â€” Volcano";
  $('startScreen').classList.add('hidden');show('topBar');show('bottomBar');$('mainArea').style.display='flex';
  safeCall(()=>initSpeech(),'speech init');resizeCanvas();
  ROUNDS.forEach(r=>{GS.levels.push({num:r.num,name:r.name,required:r.required,completed:false,score:0,attempts:0,hintsUsed:0,resets:0,timeMs:0});});
  animLoop();loadRound(0);
}

// ====== LOAD ROUND ======
function loadRound(idx){
  safeCall(()=>{
    GS.currentRound=idx;const r=ROUNDS[idx];
    GS.wrongCount=0;GS.hintsUsed=0;GS.resets=0;GS.consecutiveFastWrongs=0;
    GS.prediction=null;GS.predictionCorrect=null;
    GS.recordCorrected=false;GS.recordError=r.recordError;GS._recordAttempts=0;
    warningCracks=false;eruptionPhase=0;eruptTypeLabel="";highlightZone="";
    cityVisible=(idx===7);canvas.onclick=null;
    GS.roundStartTime=Date.now();
    updateHUD();hide('interactionZone');$('interactionZone').innerHTML='';
    hide('hintBtn');show('resetRoundBtn');
    // Sliders
    if(r.lockThick){$('thickSliderWrap').classList.add('locked');$('thickSlider').value=r.thickLockVal;$('thickValue').textContent=thickLabels[r.thickLockVal];magmaThick=r.thickLockVal;$('thickLock').style.display='';$('thickLock').textContent='ðŸ”’ Locked at '+thickLabels[r.thickLockVal];}
    else{$('thickSliderWrap').classList.remove('locked');$('thickLock').style.display='none';}
    if(r.lockGas){$('gasSliderWrap').classList.add('locked');$('gasSlider').value=r.gasLockVal;$('gasValue').textContent=gasLabels[r.gasLockVal];magmaGas=r.gasLockVal;$('gasLock').style.display='';$('gasLock').textContent='ðŸ”’ Locked at '+gasLabels[r.gasLockVal];}
    else{$('gasSliderWrap').classList.remove('locked');$('gasLock').style.display='none';}
    initBubbles();
    GS.prevThick=r.lockThick?r.thickLockVal:-1;GS.prevGas=r.lockGas?r.gasLockVal:-1;
    if(r.guided){$('guidedMsg').style.display='';$('guidedMsg').textContent=r.guided;}else{hide('guidedMsg');}
    if(r.prediction&&!r.reverseTarget){startPredictPhase(r);}
    else if(r.reverseTarget){startReversePhase(r);}
    else{setPhase('change');$('testBtn').disabled=true;showFocus(r.focusPrompt,3000);}
  },'loadRound');
}

// ====== RESET CURRENT ROUND ======
function resetCurrentRound(){
  const idx=GS.currentRound;const level=GS.levels[idx];
  if(level.completed){
    if(!confirm('This round is already complete. Reset it?'))return;
    level.completed=false;level.score=0;level.attempts=0;level.hintsUsed=0;level.resets=0;level.timeMs=0;
  }
  // Remove data table row for this round
  const row=$('dataRow'+ROUNDS[idx].num);if(row)row.remove();
  canvas.onclick=null;
  try{speechSynthesis.cancel();}catch(e){}
  clearInterval(resumeInterval);
  loadRound(idx);
}

// ====== PREDICTION ======
function startPredictPhase(r){
  setPhase('predict');$('testBtn').disabled=true;
  const iz=$('interactionZone');iz.innerHTML='';
  const pred=r.prediction;
  let h='<div class="predict-container"><div class="predict-prompt">'+pred.prompt+'</div><div class="predict-cards">';
  pred.options.forEach((o,i)=>{h+='<div class="predict-card" data-idx="'+i+'" onclick="selectPrediction('+i+')">'+String.fromCharCode(65+i)+') '+o+'</div>';});
  h+='</div><button class="lock-in-btn" id="predLockBtn" disabled onclick="lockPrediction()">Lock In Prediction</button></div>';
  iz.innerHTML=h;show(iz);showFocus(r.focusPrompt,4000);speak(pred.prompt);
}
function selectPrediction(idx){
  document.querySelectorAll('.predict-card').forEach(c=>c.classList.remove('selected'));
  document.querySelectorAll('.predict-card')[idx].classList.add('selected');
  GS.prediction=idx;const b=$('predLockBtn');if(b)b.disabled=false;
}
function lockPrediction(){
  const r=ROUNDS[GS.currentRound];GS.predictionCorrect=(GS.prediction===r.prediction.correct);
  hide('interactionZone');
  if(r.prediction.setThick!==undefined){$('thickSlider').value=r.prediction.setThick;$('thickValue').textContent=thickLabels[r.prediction.setThick];magmaThick=r.prediction.setThick;}
  if(r.prediction.setGas!==undefined){$('gasSlider').value=r.prediction.setGas;$('gasValue').textContent=gasLabels[r.prediction.setGas];magmaGas=r.prediction.setGas;}
  initBubbles();setPhase('change');GS.prevThick=-1;GS.prevGas=-1;$('testBtn').disabled=false;
  $('guidedMsg').style.display='';$('guidedMsg').textContent="Press TEST to see the result.";
}

// ====== REVERSE ENGINEER ======
function startReversePhase(r){
  setPhase('change');hide('guidedMsg');
  eruptTypeLabel=r.reverseTarget;eruptionPhase=1;showFocus(r.focusPrompt,3000);
  const iz=$('interactionZone');
  iz.innerHTML='<div style="text-align:center;font-size:14px;font-weight:600;color:var(--text)">This volcano produced: <strong>'+r.reverseTarget+'</strong>. Set the sliders to match, then press TEST.</div>';
  show(iz);$('testBtn').disabled=true;GS.prevThick=-1;GS.prevGas=-1;
}
function retryReverse(){
  setPhase('change');GS.prevThick=-1;GS.prevGas=-1;$('testBtn').disabled=true;
  const r=ROUNDS[GS.currentRound];
  $('interactionZone').innerHTML='<div style="text-align:center;font-size:14px;font-weight:600;color:var(--text)">This volcano produced: <strong>'+r.reverseTarget+'</strong>. Set the sliders to match, then press TEST.</div>';
  show('interactionZone');eruptTypeLabel=r.reverseTarget;eruptionPhase=1;
}

// ====== TEST BUTTON ======
function pressTest(){
  const r=ROUNDS[GS.currentRound];const th=parseInt($('thickSlider').value),gs=parseInt($('gasSlider').value);
  if(th===GS.prevThick&&gs===GS.prevGas&&!r.reverseTarget){showAntiGuess("Change at least one slider before testing.",3);return;}
  hide('guidedMsg');$('testBtn').disabled=true;
  if(r.reverseTarget){
    const key=th+'-'+gs,out=OUTCOME_MATRIX[key];
    if(out.eruption!==r.reverseTarget){
      $('interactionZone').innerHTML='<div class="coaching-bar">That combination produced: '+out.eruption+'. Try a different combination.</div><button class="try-again-btn" onclick="retryReverse()">Try Again</button>';
      show('interactionZone');$('testBtn').disabled=true;GS.prevThick=-1;GS.prevGas=-1;return;
    }
  }
  GS.prevThick=th;GS.prevGas=gs;magmaThick=th;magmaGas=gs;initBubbles();startWatchPhase(th,gs);
}

// ====== WATCH ======
function startWatchPhase(th,gs){
  setPhase('watch');const key=th+'-'+gs,out=OUTCOME_MATRIX[key],r=ROUNDS[GS.currentRound];
  showFocus(r.focusPrompt,2000);targetPressure=out.pressN;targetDanger=out.dangerN;
  eruptTypeLabel=out.eruption;warningCracks=(out.eruption==='Warning State');
  setTimeout(()=>{eruptionPhase=1;if(out.pressN>=0.88)shakeIntensity=6;else if(out.pressN>=0.7)shakeIntensity=3;},3000);
  if(GS.predictionCorrect!==null){
    setTimeout(()=>{const iz=$('interactionZone');iz.innerHTML=GS.predictionCorrect?'<div style="color:var(--correct);font-size:16px;font-weight:700;text-align:center">Prediction Correct!</div>':'<div style="color:var(--warn);font-size:16px;font-weight:700;text-align:center">Let\'s see why...</div>';show(iz);},2000);
  }
  const dur=out.pressN>=0.88?8000:6000;
  setTimeout(()=>{GS._lastOutcome=out;GS._lastTh=th;GS._lastGs=gs;startRecordPhase(out,th,gs);},dur);
}

// ====== RECORD ======
function startRecordPhase(out,th,gs){
  setPhase('record');const r=ROUNDS[GS.currentRound],row=r.num;
  let rd={round:row,thick:thickLabels[th],gas:gasLabels[gs],pressure:out.pressure,eruption:out.eruption,danger:out.danger};
  let hasErr=false;
  if(r.recordError){hasErr=true;rd[r.recordError.col]=r.recordError.wrongVal;if(r.recordError.col==='gas'&&r.recordError.correctVal===null)r.recordError.correctVal=gasLabels[gs];}
  const tbody=$('dataBody'),tr=document.createElement('tr');tr.className='current';tr.id='dataRow'+row;
  ['round','thick','gas','pressure','eruption','danger'].forEach(c=>{
    const td=document.createElement('td');td.textContent=rd[c];td.dataset.col=c;
    if(hasErr&&c===r.recordError.col){td.classList.add('error-cell');td.onclick=function(){correctErrorCell(this,r.recordError.correctVal,row);};}
    tr.appendChild(td);
  });
  tbody.appendChild(tr);$('rightPanel').scrollTop=$('rightPanel').scrollHeight;
  GS.confirmDisabledUntil=Date.now()+2000;
  $('interactionZone').innerHTML='<div class="record-zone"><div class="record-msg">Check your data table row. Does everything look right?</div><button class="confirm-btn" id="confirmBtn" disabled onclick="confirmRecord('+row+','+hasErr+')">Confirm</button></div>';
  show('interactionZone');
  setTimeout(()=>{const b=$('confirmBtn');if(b)b.disabled=false;},2000);
}
function correctErrorCell(td,cv,row){td.textContent=cv;td.classList.remove('error-cell');td.classList.add('corrected');td.onclick=null;GS.recordCorrected=true;playCorrect();}
function confirmRecord(row,hasErr){
  if(Date.now()<GS.confirmDisabledUntil+1000&&!GS.recordCorrected){showCoaching("Take a moment to check the newest row in your data table.");return;}
  const r=ROUNDS[GS.currentRound];
  if(hasErr&&!GS.recordCorrected){
    GS._recordAttempts=(GS._recordAttempts||0)+1;
    if(GS._recordAttempts>=3){const tr=$('dataRow'+row);if(tr)tr.className='verified';hide('interactionZone');startProvePhase();return;}
    showCoaching(r.recordError.nudge);
    const tr=$('dataRow'+row);if(tr)tr.querySelectorAll('td').forEach(td=>{if(td.classList.contains('error-cell')){td.style.animation='none';td.offsetHeight;td.style.animation='pulse-yellow 0.5s 3';}});
    return;
  }
  const tr=$('dataRow'+row);if(tr)tr.className='verified';hide('interactionZone');startProvePhase();
}

// ====== PROVE PHASE ======
function startProvePhase(){
  setPhase('prove');GS.wrongCount=0;GS.phaseStartTime=Date.now();show('hintBtn');
  const r=ROUNDS[GS.currentRound],p=r.prove;
  switch(p.mechanic){
    case 'coach-click':renderCoachClick(p,r);break;
    case 'drag-to-match':renderDragToMatch(p,r);break;
    case 'hotspot':renderHotspot(p,r);break;
    case 'sequence':renderSequence(p,r);break;
    case 'claim-builder':renderClaimBuilder(p,r);break;
  }
}

// ====== COACH-CLICK ======
function renderCoachClick(p,r){
  const iz=$('interactionZone');
  let h='<div class="iz-prompt">'+p.prompt+'</div><div class="iz-options">';
  p.options.forEach((o,i)=>{h+='<div class="opt-card" data-idx="'+i+'" onclick="ccSelect(this,'+i+')">'+String.fromCharCode(65+i)+') '+o+'</div>';});
  h+='</div><button class="lock-in-btn" id="ccLockBtn" disabled onclick="ccLockIn()">Lock In</button>';
  iz.innerHTML=h;show(iz);GS._ccSelection=null;GS._ccEliminated=[];
}
function ccSelect(el,idx){
  if(GS._ccEliminated.includes(idx))return;
  document.querySelectorAll('.opt-card').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');GS._ccSelection=idx;
  const b=$('ccLockBtn');if(b)b.disabled=false;
}
function ccLockIn(){
  const r=ROUNDS[GS.currentRound],p=r.prove,sel=GS._ccSelection;if(sel===null)return;
  const timeTaken=Date.now()-GS.phaseStartTime;
  if(sel===p.correct){onProveCorrect();return;}
  if(timeTaken<1500){GS.consecutiveFastWrongs++;if(GS.consecutiveFastWrongs>=2){showAntiGuess("Slow down and read each option carefully.",5);GS.consecutiveFastWrongs=0;return;}}
  GS.wrongCount++;GS.levels[GS.currentRound].attempts++;
  const card=document.querySelectorAll('.opt-card')[sel];card.classList.add('wrong-reveal');playWrong();setTimeout(()=>card.classList.remove('wrong-reveal'),500);
  const fb=p.wrongFeedback[sel]||"Look at the arena and think again.";highlightZone=p.arenaHighlight?p.arenaHighlight[sel]:'';
  const iz=$('interactionZone');let cd=iz.querySelector('.coaching-bar');
  if(!cd){cd=document.createElement('div');cd.className='coaching-bar';iz.appendChild(cd);}cd.textContent=fb;
  let tb=iz.querySelector('.try-again-btn');
  if(!tb){tb=document.createElement('button');tb.className='try-again-btn';tb.textContent='Try Again';tb.onclick=()=>{card.classList.add('dimmed');GS._ccEliminated.push(sel);GS._ccSelection=null;$('ccLockBtn').disabled=true;cd.remove();tb.remove();highlightZone='';checkHintNeeded();};iz.appendChild(tb);}
  if(GS.wrongCount>=3&&GS.resets>=3){forceAdvance();return;}
}

// ====== DRAG-TO-MATCH ======
function renderDragToMatch(p,r){
  const iz=$('interactionZone');GS._dtmMap={};GS._dtmSel=null;
  let h='<div class="iz-prompt">'+p.prompt+'</div><div class="dtm-container"><div class="dtm-items" id="dtmItems">';
  p.items.forEach((it,i)=>{h+='<div class="dtm-drag" data-idx="'+i+'" id="dtmItem'+i+'">'+it+'</div>';});
  h+='</div><div class="dtm-zones" id="dtmZones">';
  p.zones.forEach((z,i)=>{h+='<div class="dtm-zone" data-zone="'+i+'" id="dtmZoneEl'+i+'"><div class="dtm-zone-label">'+z.label+'</div><div id="dtmZone'+i+'"></div></div>';});
  h+='</div></div><button class="lock-in-btn" id="dtmLockBtn" disabled onclick="dtmLockIn()">Lock In</button>';
  iz.innerHTML=h;show(iz);
  p.items.forEach((it,i)=>{$('dtmItem'+i).onclick=()=>dtmTapItem(i,p);});
  p.zones.forEach((z,i)=>{$('dtmZoneEl'+i).onclick=()=>dtmTapZone(i,p);});
}
function dtmTapItem(idx,p){
  if(GS._dtmMap[idx]!==undefined){delete GS._dtmMap[idx];dtmRefresh(p);return;}
  document.querySelectorAll('.dtm-drag').forEach(d=>d.classList.remove('sel'));$('dtmItem'+idx).classList.add('sel');GS._dtmSel=idx;
}
function dtmTapZone(zi,p){if(GS._dtmSel===null)return;GS._dtmMap[GS._dtmSel]=zi;GS._dtmSel=null;dtmRefresh(p);}
function dtmRefresh(p){
  p.zones.forEach((z,i)=>{$('dtmZone'+i).innerHTML='';});
  Object.entries(GS._dtmMap).forEach(([ii,zi])=>{
    const d=document.createElement('div');d.className='dtm-placed-item';d.textContent=p.items[parseInt(ii)];
    d.onclick=()=>{delete GS._dtmMap[parseInt(ii)];dtmRefresh(p);};$('dtmZone'+zi).appendChild(d);
  });
  p.items.forEach((it,i)=>{const el=$('dtmItem'+i);el.classList.toggle('placed',GS._dtmMap[i]!==undefined);el.classList.remove('sel');});
  $('dtmLockBtn').disabled=(Object.keys(GS._dtmMap).length<p.items.length);
}
function dtmLockIn(){
  const r=ROUNDS[GS.currentRound],p=r.prove;let ok=true;
  Object.entries(GS._dtmMap).forEach(([ii,zi])=>{if(!p.zones[zi].accepts.includes(parseInt(ii)))ok=false;});
  if(ok){onProveCorrect();return;}
  GS.wrongCount++;GS.levels[GS.currentRound].attempts++;playWrong();highlightZone='dataPress';
  const iz=$('interactionZone');let cd=iz.querySelector('.coaching-bar');
  if(!cd){cd=document.createElement('div');cd.className='coaching-bar';iz.appendChild(cd);}cd.textContent=p.wrongFeedback||"Check your data table again.";
  let tb=iz.querySelector('.try-again-btn');
  if(!tb){tb=document.createElement('button');tb.className='try-again-btn';tb.textContent='Try Again';tb.onclick=()=>{GS._dtmMap={};GS._dtmSel=null;dtmRefresh(p);cd.remove();tb.remove();highlightZone='';GS.resets++;checkHintNeeded();};iz.appendChild(tb);}
  if(GS.wrongCount>=3&&GS.resets>=3){forceAdvance();return;}
}

// ====== HOTSPOT ======
function renderHotspot(p,r){
  const iz=$('interactionZone');
  iz.innerHTML='<div class="iz-prompt">'+p.prompt+'</div><div style="text-align:center;font-size:13px;color:var(--textLight)">Tap the correct area on the volcano above.</div>';
  show(iz);GS._hsClickCount=0;GS._hsDone=false;
  canvas.onclick=function(e){if(GS._hsDone||GS.phase!=='prove')return;const rect=canvas.getBoundingClientRect();const x=(e.clientX-rect.left)*(cW/rect.width),y=(e.clientY-rect.top)*(cH/rect.height);handleHotspotClick(x,y,p,r);};
}
function handleHotspotClick(x,y,p,r){
  const mcX=cW*0.3,mcY=cH*0.76,mcW=cW*0.4,mcH=cH*0.18;
  const inChamber=(x>=mcX&&x<=mcX+mcW&&y>=mcY&&y<=mcY+mcH);
  const pX=cW*0.5,pY=cH*0.18;const nearCrater=Math.hypot(x-pX,y-pY)<50;
  GS._hsClickCount++;
  if(inChamber){GS._hsDone=true;canvas.onclick=null;onProveCorrect();return;}
  playWrong();GS.wrongCount++;GS.levels[GS.currentRound].attempts++;
  let fb;if(nearCrater)fb=(p.wrongFeedback&&p.wrongFeedback[0])||"The crater shows the result, not the cause. What is different INSIDE the magma?";
  else if(y>cH*0.3&&y<cH*0.5&&x>cW*0.3&&x<cW*0.7)fb=(p.wrongFeedback&&p.wrongFeedback[1])||"The cracks show pressure â€” but what controls it? Look inside.";
  else fb="Look inside the volcano at the magma chamber.";
  highlightZone='gas';showCoaching(fb);
  if(GS._hsClickCount>=3){GS.resets++;checkHintNeeded();}
  if(GS.wrongCount>=3&&GS.resets>=3){canvas.onclick=null;forceAdvance();}
}

// ====== SEQUENCE ======
function renderSequence(p,r){
  const iz=$('interactionZone');GS._seqSlots=new Array(p.items.length).fill(null);GS._seqSel=null;
  let h='<div class="iz-prompt">'+p.prompt+'</div><div class="seq-container"><div class="seq-source" id="seqSource">';
  p.items.forEach((it,i)=>{h+='<div class="seq-card" data-idx="'+i+'" id="seqCard'+i+'">'+it+'</div>';});
  h+='</div><div class="seq-slots" id="seqSlots">';
  for(let i=0;i<p.items.length;i++){h+='<div class="seq-slot" data-slot="'+i+'" id="seqSlot'+i+'"><span class="slot-num">'+(i+1)+'.</span> <span id="seqSlotText'+i+'"></span></div>';}
  h+='</div></div><button class="lock-in-btn" id="seqLockBtn" disabled onclick="seqLockIn()">Lock In</button>';
  iz.innerHTML=h;show(iz);
  p.items.forEach((it,i)=>{$('seqCard'+i).onclick=()=>seqTapCard(i,p);});
  for(let i=0;i<p.items.length;i++){$('seqSlot'+i).onclick=()=>seqTapSlot(i,p);}
}
function seqTapCard(idx,p){
  if(GS._seqSlots.includes(idx)){GS._seqSlots[GS._seqSlots.indexOf(idx)]=null;seqRefresh(p);return;}
  document.querySelectorAll('.seq-card').forEach(c=>c.classList.remove('selected'));$('seqCard'+idx).classList.add('selected');GS._seqSel=idx;
}
function seqTapSlot(si,p){
  if(GS._seqSel===null){if(GS._seqSlots[si]!==null){GS._seqSlots[si]=null;seqRefresh(p);}return;}
  const old=GS._seqSlots.indexOf(GS._seqSel);if(old>=0)GS._seqSlots[old]=null;
  GS._seqSlots[si]=GS._seqSel;GS._seqSel=null;seqRefresh(p);
}
function seqRefresh(p){
  for(let i=0;i<p.items.length;i++){
    const slot=$('seqSlot'+i),txt=$('seqSlotText'+i);
    if(GS._seqSlots[i]!==null){slot.className='seq-slot filled';txt.textContent=p.items[GS._seqSlots[i]];}
    else{slot.className='seq-slot';txt.textContent='';}
  }
  p.items.forEach((it,i)=>{$('seqCard'+i).classList.toggle('placed',GS._seqSlots.includes(i));$('seqCard'+i).classList.remove('selected');});
  $('seqLockBtn').disabled=GS._seqSlots.includes(null);
}
function seqLockIn(){
  const r=ROUNDS[GS.currentRound],p=r.prove;
  if(GS._seqSlots.every((v,i)=>v===p.correct[i])){onProveCorrect();return;}
  GS.wrongCount++;GS.levels[GS.currentRound].attempts++;playWrong();
  const iz=$('interactionZone');let cd=iz.querySelector('.coaching-bar');
  if(!cd){cd=document.createElement('div');cd.className='coaching-bar';iz.appendChild(cd);}cd.textContent=p.wrongFeedback||"Check the order again.";
  let tb=iz.querySelector('.try-again-btn');
  if(!tb){tb=document.createElement('button');tb.className='try-again-btn';tb.textContent='Try Again';tb.onclick=()=>{GS._seqSlots=new Array(p.items.length).fill(null);GS._seqSel=null;seqRefresh(p);cd.remove();tb.remove();highlightZone='';GS.resets++;checkHintNeeded();};iz.appendChild(tb);}
  if(GS.wrongCount>=3&&GS.resets>=3){forceAdvance();return;}
}

// ====== CLAIM BUILDER ======
function renderClaimBuilder(p,r){
  const iz=$('interactionZone');GS._claimSelected=new Set();GS._claimEliminated=new Set();
  let h='<div class="iz-prompt">'+p.prompt+'</div><div class="claim-container"><div class="claim-frame"><div class="claim-frame-label">'+p.frame+'</div><div class="claim-evidence-area" id="claimArea">Tap evidence cards below to add them here.</div></div><div class="iz-options" id="claimCards">';
  p.items.forEach((it,i)=>{h+='<div class="claim-card" data-idx="'+i+'" id="claimCard'+i+'">'+it+'</div>';});
  h+='</div></div><button class="lock-in-btn" id="claimLockBtn" disabled onclick="claimLockIn()">Lock In</button>';
  iz.innerHTML=h;show(iz);
  p.items.forEach((it,i)=>{$('claimCard'+i).onclick=()=>claimToggle(i,p);});
}
function claimToggle(idx,p){if(GS._claimEliminated.has(idx))return;if(GS._claimSelected.has(idx))GS._claimSelected.delete(idx);else GS._claimSelected.add(idx);claimRefresh(p);}
function claimRefresh(p){
  const area=$('claimArea');area.innerHTML='';
  GS._claimSelected.forEach(i=>{const d=document.createElement('div');d.className='claim-card in-frame';d.textContent=p.items[i];d.onclick=()=>{GS._claimSelected.delete(i);claimRefresh(p);};area.appendChild(d);});
  if(GS._claimSelected.size===0)area.textContent='Tap evidence cards below to add them here.';
  p.items.forEach((it,i)=>{const el=$('claimCard'+i);el.classList.toggle('selected',GS._claimSelected.has(i));el.classList.toggle('eliminated',GS._claimEliminated.has(i));});
  $('claimLockBtn').disabled=(GS._claimSelected.size===0);
}
function claimLockIn(){
  const r=ROUNDS[GS.currentRound],p=r.prove;
  const sel=[...GS._claimSelected].sort((a,b)=>a-b),cor=[...p.correct].sort((a,b)=>a-b);
  if(sel.length===cor.length&&sel.every((v,i)=>v===cor[i])){onProveCorrect();return;}
  GS.wrongCount++;GS.levels[GS.currentRound].attempts++;playWrong();
  sel.forEach(i=>{if(!cor.includes(i)){GS._claimEliminated.add(i);GS._claimSelected.delete(i);}});
  const iz=$('interactionZone');let cd=iz.querySelector('.coaching-bar');
  if(!cd){cd=document.createElement('div');cd.className='coaching-bar';iz.appendChild(cd);}cd.textContent=p.wrongFeedback||"Read the data table carefully.";
  claimRefresh(p);
  let tb=iz.querySelector('.try-again-btn');
  if(!tb){tb=document.createElement('button');tb.className='try-again-btn';tb.textContent='Try Again';tb.onclick=()=>{GS._claimSelected=new Set();claimRefresh(p);cd.remove();tb.remove();GS.resets++;checkHintNeeded();};iz.appendChild(tb);}
  if(GS.wrongCount>=3&&GS.resets>=3){forceAdvance();return;}
}

// ====== PROVE CORRECT / SCORING ======
function onProveCorrect(){
  playCorrect();highlightZone='';canvas.onclick=null;hide('hintBtn');
  const level=GS.levels[GS.currentRound];level.completed=true;level.attempts++;level.timeMs=Date.now()-GS.roundStartTime;
  const h=GS.hintsUsed,re=GS.resets;
  if(re>=1)level.score=50;else if(h>=3)level.score=60;else if(h>=2)level.score=70;else if(h>=1)level.score=85;else level.score=100;
  if(GS.predictionCorrect===false&&level.score>85)level.score=85;
  level.hintsUsed=GS.hintsUsed;level.resets=GS.resets;updateHUD();
  const iz=$('interactionZone');const ft=(GS.hintsUsed===0&&GS.resets===0&&level.attempts<=1);
  let html='<div style="text-align:center"><div style="font-size:20px;font-weight:800;color:var(--correct)">Correct! +'+level.score+'</div>';
  if(ft)html+='<div class="celeb-affirmation" style="opacity:1">'+getAffirmation(GS.currentRound)+'</div>';
  html+='</div>';iz.innerHTML=html;show(iz);
  setTimeout(()=>{hide('interactionZone');checkMilestone();},2000);
}
function forceAdvance(){
  canvas.onclick=null;hide('hintBtn');const level=GS.levels[GS.currentRound];
  level.completed=true;level.score=50;level.attempts++;level.hintsUsed=GS.hintsUsed;level.resets=GS.resets;level.timeMs=Date.now()-GS.roundStartTime;
  updateHUD();
  $('interactionZone').innerHTML='<div style="text-align:center;font-size:14px;color:var(--textLight);font-weight:600">Let\'s move on â€” you\'ll see this idea again.</div>';
  show('interactionZone');setTimeout(()=>{hide('interactionZone');checkMilestone();},2000);
}

// ====== MILESTONES ======
function checkMilestone(){
  const idx=GS.currentRound;
  if(idx===1)showCelebration("Two tests done!","Same gas, different thickness â€” did you see the difference?",null,()=>nextRound());
  else if(idx===3)showCelebration("Patterns are forming...","You've tested 4 combinations! Keep going!",null,()=>nextRound());
  else if(idx===5){GS.requiredComplete=true;showCelebration("All required rounds done!","You've mapped the eruption spectrum!",[{text:"See My Score",action:()=>showReceipt()},{text:"Continue to Bonus (+10 pts)",action:()=>nextRound(),secondary:true}]);}
  else if(idx===7){GS.allComplete=true;showCelebration("BONUS COMPLETE!","You mastered the volcano lab!",null,()=>showReceipt(),true);}
  else nextRound();
}
function showCelebration(title,msg,buttons,defaultAction,isBig){
  const ov=$('celebOverlay'),card=$('celebCard');
  let h='<div class="celeb-title">'+title+'</div><div class="celeb-msg">'+msg+'</div><div class="celeb-affirmation">'+getAffirmation(GS.currentRound)+'</div>';
  if(buttons){h+='<div class="celeb-btns">';buttons.forEach((b,i)=>{h+='<button class="celeb-btn '+(b.secondary?'secondary':'')+'" id="celebBtn'+i+'">'+b.text+'</button>';});h+='</div>';}
  card.innerHTML=h;ov.classList.add('show');
  if(buttons){buttons.forEach((b,i)=>{$('celebBtn'+i).onclick=()=>{ov.classList.remove('show');b.action();};});}
  else{setTimeout(()=>{ov.classList.remove('show');if(defaultAction)defaultAction();},isBig?3000:2000);}
  safeCall(()=>fireConfetti(),'confetti');
}
function nextRound(){if(GS.currentRound<ROUNDS.length-1)loadRound(GS.currentRound+1);else showReceipt();}

// ====== HINTS ======
function useHint(){
  const r=ROUNDS[GS.currentRound],h=r.hintLadder;GS.hintsUsed++;
  if(GS.hintsUsed===1&&h.hint1){showCoaching(h.hint1.text,'hint1');if(h.hint1.target)highlightZone=h.hint1.target;}
  else if(GS.hintsUsed===2&&h.hint2){
    showCoaching(h.hint2.text,'hint2');
    if(h.hint2.eliminate!==undefined){const cards=document.querySelectorAll('.opt-card');if(cards[h.hint2.eliminate])cards[h.hint2.eliminate].classList.add('eliminated');}
    if(h.hint2.lockItem&&GS._dtmMap!==undefined){GS._dtmMap[h.hint2.lockItem.item]=h.hint2.lockItem.zone;dtmRefresh(ROUNDS[GS.currentRound].prove);}
    if(h.hint2.lockFirst&&GS._seqSlots){GS._seqSlots[0]=0;seqRefresh(ROUNDS[GS.currentRound].prove);const c=$('seqCard0');if(c)c.classList.add('locked');}
    if(h.hint2.eliminateDistractor!==undefined&&GS._claimEliminated){GS._claimEliminated.add(h.hint2.eliminateDistractor);claimRefresh(ROUNDS[GS.currentRound].prove);}
  } else showStepByStep(h.stepByStep.panels);
}
function checkHintNeeded(){if(GS.wrongCount>=1&&GS.hintsUsed===0)show('hintBtn');}
function showCoaching(text,level){
  const iz=$('interactionZone');let bar=iz.querySelector('.coaching-bar');
  if(!bar){bar=document.createElement('div');iz.appendChild(bar);}
  bar.className='coaching-bar'+(level==='hint2'?' hint2':'');bar.textContent=text;speak(text);
}
function showStepByStep(panels){
  const ov=$('sbsOverlay'),pan=$('sbsPanel');let cs=0;
  let h='<div class="sbs-title">Step-by-Step Help</div>';
  panels.forEach((p,i)=>{h+='<div class="sbs-step '+(i===0?'active':'')+'" id="sbsStep'+i+'">'+p.text+'</div>';});
  h+='<div class="sbs-nav"><button class="sbs-btn" id="sbsNext">Next</button></div>';
  pan.innerHTML=h;ov.classList.add('show');
  $('sbsNext').onclick=()=>{cs++;if(cs>=panels.length){ov.classList.remove('show');return;}document.querySelectorAll('.sbs-step').forEach(s=>s.classList.remove('active'));$('sbsStep'+cs).classList.add('active');if(cs===panels.length-1)$('sbsNext').textContent='Close';};
}

// ====== ANTI-GUESSING ======
function showAntiGuess(msg,dur){
  const s=$('agScreen'),c=$('agCard');
  c.innerHTML='<h3>Hold on!</h3><p>'+msg+'</p><div class="ag-timer" id="agTimer">'+dur+'</div>';s.classList.add('show');
  let rem=dur;const iv=setInterval(()=>{rem--;const t=$('agTimer');if(t)t.textContent=rem;if(rem<=0){clearInterval(iv);s.classList.remove('show');}},1000);
}

// ====== VOCAB ======
function showVocab(){$('vocabOverlay').classList.add('show');}
function hideVocab(){$('vocabOverlay').classList.remove('show');}

// ====== CONFETTI ======
function fireConfetti(){
  const cc=$('confettiCanvas'),cx=cc.getContext('2d');cc.width=window.innerWidth;cc.height=window.innerHeight;
  const ps=[],cols=['#3B82F6','#10B981','#8B5CF6','#F59E0B','#EF4444','#22C55E'];
  for(let i=0;i<60;i++){ps.push({x:cc.width/2+(Math.random()-0.5)*200,y:cc.height/2,vx:(Math.random()-0.5)*12,vy:-Math.random()*15-5,r:3+Math.random()*4,c:cols[Math.floor(Math.random()*cols.length)],life:1,rot:Math.random()*Math.PI*2,rotV:(Math.random()-0.5)*0.2});}
  let fr=0;function draw(){cx.clearRect(0,0,cc.width,cc.height);let alive=false;ps.forEach(p=>{if(p.life<=0)return;alive=true;p.x+=p.vx;p.y+=p.vy;p.vy+=0.4;p.life-=0.012;p.rot+=p.rotV;cx.save();cx.translate(p.x,p.y);cx.rotate(p.rot);cx.globalAlpha=p.life;cx.fillStyle=p.c;cx.fillRect(-p.r,-p.r/2,p.r*2,p.r);cx.restore();});if(alive&&fr<120){fr++;requestAnimationFrame(draw);}else cx.clearRect(0,0,cc.width,cc.height);}draw();
}

// ====== RECEIPT ======
function showReceipt(){
  const ov=$('receiptOverlay');
  const reqS=GS.levels.filter((l,i)=>ROUNDS[i].required&&l.completed).map(l=>l.score);
  const base=reqS.length?Math.round(reqS.reduce((a,b)=>a+b,0)/reqS.length):0;
  const bonusC=GS.levels.filter((l,i)=>!ROUNDS[i].required&&l.completed).length;
  const overall=Math.min(100,base+bonusC*5);
  const cc=overall>=85?'sc-green':overall>=70?'sc-yellow':'sc-red';
  const lab=overall>=85?'Mastery':overall>=70?'Approaching Mastery':'Needs More Practice';
  const totalT=GS.levels.reduce((s,l)=>s+l.timeMs,0);
  const tM=Math.floor(totalT/60000),tS=Math.floor((totalT%60000)/1000);
  let h='<div class="receipt-card"><div class="receipt-header"><h2>'+teacherName+'\'s Simulation</h2><h3>Volcano â€” Wednesday Score Report</h3></div>';
  h+='<div class="name-input-wrap"><input type="text" id="nameInput" placeholder="Type your name here" value="'+(GS.studentName||'')+'"><button onclick="lockName()">Lock</button></div>';
  h+='<div class="overall-score"><div class="overall-pct '+cc+'">'+overall+'%</div><div class="overall-label '+cc+'">'+lab+'</div></div>';
  h+='<table class="receipt-table"><thead><tr><th>#</th><th>Round</th><th>Score</th><th>Attempts</th><th>Time</th></tr></thead><tbody>';
  GS.levels.forEach((l,i)=>{if(!l.completed)return;const t=Math.floor(l.timeMs/1000),m=Math.floor(t/60),s=t%60;const sc=l.score>=85?'sc-green':l.score>=70?'sc-yellow':'sc-red';const bn=!ROUNDS[i].required?' bonus-row':'';
    h+='<tr class="'+bn+'"><td>'+(ROUNDS[i].required?l.num:('â­ '+l.num))+'</td><td>'+l.name+'</td><td class="'+sc+'">'+l.score+'%</td><td>'+l.attempts+'</td><td>'+m+':'+String(s).padStart(2,'0')+'</td></tr>';});
  h+='</tbody></table><div style="font-size:12px;color:var(--textLight)">Total Time: '+tM+':'+String(tS).padStart(2,'0')+'</div>';
  h+='<div class="receipt-footer">Take a screenshot and upload to Google Classroom</div>';
  h+='<button class="print-btn" onclick="window.print()">Print</button><br><button class="restart-btn" onclick="confirmRestart()">Start Over</button></div>';
  ov.innerHTML=h;ov.classList.add('show');
}
function lockName(){const inp=$('nameInput');if(!inp)return;GS.studentName=inp.value;inp.disabled=true;inp.nextElementSibling.disabled=true;inp.nextElementSibling.textContent='Locked';}
function confirmRestart(){if(confirm('Start over? This will reset all your progress.'))location.reload();}

// ====== INIT ======
resizeCanvas();
</script>
</body>
</html>
