<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation: How Corn Processing Affects Niacin Absorption</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#0a0e1a;color:#fff;min-height:100vh;overflow:hidden;user-select:none;}
#app{display:flex;height:100vh;}

/* LEFT PANEL */
#left-panel{width:270px;min-width:270px;background:linear-gradient(180deg,#111827,#0f172a);padding:14px;display:flex;flex-direction:column;gap:8px;overflow-y:auto;border-right:2px solid rgba(99,102,241,0.2);}
#left-panel::-webkit-scrollbar{width:4px;}
#left-panel::-webkit-scrollbar-thumb{background:rgba(99,102,241,0.3);border-radius:4px;}
.panel-title{font-size:20px;font-weight:800;text-align:center;padding:10px 8px;background:linear-gradient(135deg,#f59e0b,#ef4444,#8b5cf6);border-radius:12px;letter-spacing:0.5px;text-shadow:0 2px 8px rgba(0,0,0,0.4);}
.round-badge{text-align:center;font-size:24px;font-weight:900;background:linear-gradient(135deg,#fbbf24,#f59e0b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;padding:4px 0;}
.mission-line{text-align:center;font-size:12px;color:#94a3b8;padding:6px 10px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.05);}

.control-group{background:rgba(255,255,255,0.04);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.06);}
.control-label{font-size:11px;font-weight:700;color:#818cf8;margin-bottom:6px;text-transform:uppercase;letter-spacing:1.5px;}
.selector-options{display:flex;flex-direction:column;gap:5px;}
.sel-btn{padding:10px 12px;border:2px solid rgba(255,255,255,0.08);border-radius:10px;background:rgba(255,255,255,0.03);color:#cbd5e1;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.25s;text-align:left;display:flex;align-items:center;gap:8px;}
.sel-btn .corn-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.sel-btn:hover:not(.locked){background:rgba(255,255,255,0.08);border-color:rgba(99,102,241,0.4);}
.sel-btn.active{background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(22,163,74,0.15));border-color:#22c55e;color:#fff;box-shadow:0 0 16px rgba(34,197,94,0.15);}
.sel-btn.locked{opacity:0.3;cursor:not-allowed;border-style:dashed;border-color:rgba(255,255,255,0.06);}
.lock-tag{font-size:9px;color:#64748b;margin-left:auto;background:rgba(255,255,255,0.06);padding:2px 6px;border-radius:4px;}

.corn-pale{background:#d4c89e;}
.corn-gold{background:#f59e0b;}
.corn-teal{background:#2dd4bf;}

#feed-btn{width:100%;padding:14px;font-size:17px;font-weight:800;border:none;border-radius:12px;cursor:pointer;background:linear-gradient(135deg,#f97316,#ef4444);color:#fff;box-shadow:0 4px 20px rgba(249,115,22,0.3);transition:all 0.25s;text-transform:uppercase;letter-spacing:2px;position:relative;overflow:hidden;}
#feed-btn::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(255,255,255,0.1),transparent);transform:rotate(45deg);transition:all 0.5s;}
#feed-btn:hover:not(:disabled)::after{left:100%;}
#feed-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 25px rgba(249,115,22,0.5);}
#feed-btn:disabled{opacity:0.3;cursor:not-allowed;transform:none;}

#next-btn{width:100%;padding:13px;font-size:16px;font-weight:700;border:none;border-radius:12px;cursor:pointer;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;box-shadow:0 4px 16px rgba(99,102,241,0.3);transition:all 0.25s;display:none;animation:pulse-glow 2s infinite;}
@keyframes pulse-glow{0%,100%{box-shadow:0 4px 16px rgba(99,102,241,0.3);}50%{box-shadow:0 4px 30px rgba(139,92,246,0.6);}}
#next-btn:hover{transform:translateY(-2px);}

.fort-wrap{display:flex;align-items:center;gap:10px;padding:6px 0;}
.toggle-track{width:50px;height:28px;background:#334155;border-radius:14px;cursor:pointer;position:relative;transition:all 0.3s;border:2px solid transparent;}
.toggle-track.on{background:linear-gradient(135deg,#22c55e,#16a34a);border-color:rgba(34,197,94,0.3);}
.toggle-track::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:all 0.3s;box-shadow:0 2px 6px rgba(0,0,0,0.3);}
.toggle-track.on::after{left:25px;}
.toggle-track.locked{opacity:0.25;cursor:not-allowed;}
.toggle-lbl{font-size:13px;font-weight:600;color:#94a3b8;}

.bottom-btns{display:flex;gap:6px;margin-top:auto;padding-top:6px;}
.bottom-btns button{flex:1;padding:8px;font-size:11px;font-weight:700;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s;}
#reset-btn{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;}
#newrun-btn{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;}
#reset-btn:hover,#newrun-btn:hover{transform:translateY(-1px);}

.ec-message{text-align:center;padding:8px;background:linear-gradient(135deg,rgba(251,191,36,0.12),rgba(245,158,11,0.12));border-radius:10px;border:1px solid rgba(251,191,36,0.25);font-size:13px;font-weight:700;color:#fbbf24;display:none;}

/* CENTER ARENA */
#center-panel{flex:1;display:flex;flex-direction:column;padding:12px;overflow:hidden;}
#arena-container{flex:1;position:relative;background:linear-gradient(180deg,#0c1222,#111827,#0f172a);border-radius:16px;border:1px solid rgba(99,102,241,0.15);overflow:hidden;box-shadow:inset 0 0 60px rgba(0,0,0,0.3);}
#arena-canvas{width:100%;height:100%;display:block;}
#status-msg{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-size:32px;font-weight:900;color:#fbbf24;text-shadow:0 0 30px rgba(251,191,36,0.5),0 4px 12px rgba(0,0,0,0.5);display:none;text-align:center;z-index:10;pointer-events:none;letter-spacing:1px;}
#random-event{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ef4444,#dc2626);padding:10px 24px;border-radius:10px;font-size:14px;font-weight:700;display:none;z-index:5;box-shadow:0 4px 20px rgba(239,68,68,0.4);animation:shake 0.5s ease;}
@keyframes shake{0%,100%{transform:translateX(-50%);}25%{transform:translateX(calc(-50% - 6px));}75%{transform:translateX(calc(-50% + 6px));}}
#completion{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.88);z-index:20;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.comp-icon{font-size:72px;animation:bounce-in 0.6s ease;}
@keyframes bounce-in{0%{transform:scale(0);}60%{transform:scale(1.2);}100%{transform:scale(1);}}
.comp-title{font-size:32px;font-weight:900;background:linear-gradient(135deg,#fbbf24,#f59e0b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:10px 0;}
.comp-sub{font-size:15px;color:#94a3b8;max-width:340px;text-align:center;line-height:1.5;}

/* RIGHT PANEL */
#right-panel{width:290px;min-width:290px;background:linear-gradient(180deg,#111827,#0f172a);padding:14px;display:flex;flex-direction:column;gap:8px;overflow-y:auto;border-left:2px solid rgba(99,102,241,0.2);}
#right-panel::-webkit-scrollbar{width:4px;}
#right-panel::-webkit-scrollbar-thumb{background:rgba(99,102,241,0.3);border-radius:4px;}
.hud-title{font-size:15px;font-weight:800;text-align:center;padding:8px;background:linear-gradient(135deg,#6366f1,#a855f7);border-radius:10px;letter-spacing:0.5px;}

.niacin-meter-wrap{background:rgba(0,0,0,0.25);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.06);}
.meter-label{font-size:11px;color:#94a3b8;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;}
.meter-bar-bg{width:100%;height:30px;background:#1e293b;border-radius:15px;overflow:hidden;position:relative;box-shadow:inset 0 2px 8px rgba(0,0,0,0.4);}
.meter-bar-fill{height:100%;border-radius:15px;transition:width 1.8s cubic-bezier(0.4,0,0.2,1),background 1s ease;width:0%;position:relative;}
.meter-bar-fill::after{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(180deg,rgba(255,255,255,0.2),transparent);border-radius:15px 15px 0 0;}
.meter-value{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:15px;font-weight:900;text-shadow:0 1px 4px rgba(0,0,0,0.8);}

.health-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.health-card{background:rgba(255,255,255,0.03);border-radius:10px;padding:10px 6px;text-align:center;border:1.5px solid rgba(255,255,255,0.06);transition:all 0.6s cubic-bezier(0.4,0,0.2,1);}
.health-icon{font-size:26px;margin-bottom:2px;}
.health-name{font-size:10px;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;}
.health-status{font-size:11px;font-weight:800;margin-top:3px;letter-spacing:0.5px;}

.ds-bar-wrap{background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.05);}
.ds-label{font-size:10px;color:#64748b;font-weight:700;margin-bottom:5px;text-transform:uppercase;letter-spacing:1px;}
.ds-bar{display:flex;height:24px;border-radius:6px;overflow:hidden;background:#1e293b;gap:2px;padding:2px;}
.ds-seg{flex:1;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;transition:all 0.6s;opacity:0.2;border-radius:4px;letter-spacing:0.3px;}
.ds-seg.active{opacity:1;}

.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.stat-card{background:rgba(255,255,255,0.03);border-radius:8px;padding:8px;text-align:center;border:1px solid rgba(255,255,255,0.05);}
.stat-val{font-size:22px;font-weight:900;}
.score-v{background:linear-gradient(135deg,#fbbf24,#f59e0b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.streak-v{color:#f97316;}
.stat-name{font-size:9px;color:#64748b;text-transform:uppercase;font-weight:700;letter-spacing:1px;}

/* DATA TABLE */
.data-section{flex:1;display:flex;flex-direction:column;min-height:0;}
.data-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.data-title{font-size:13px;font-weight:700;color:#e2e8f0;}
#copy-btn{padding:5px 12px;font-size:10px;font-weight:700;border:none;border-radius:6px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;}
#copy-btn:hover{transform:translateY(-1px);box-shadow:0 2px 10px rgba(34,197,94,0.3);}
.table-wrap{flex:1;overflow-y:auto;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.15);}
.table-wrap::-webkit-scrollbar{width:3px;}
.table-wrap::-webkit-scrollbar-thumb{background:rgba(99,102,241,0.3);border-radius:3px;}
.table-wrap table{width:100%;border-collapse:collapse;font-size:10px;}
.table-wrap th{background:linear-gradient(135deg,#312e81,#4338ca);padding:7px 4px;text-align:center;font-size:9px;font-weight:700;position:sticky;top:0;z-index:2;letter-spacing:0.5px;text-transform:uppercase;}
.table-wrap td{padding:6px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.04);font-size:11px;font-weight:500;}
.table-wrap tr:nth-child(even){background:rgba(255,255,255,0.02);}
.table-wrap tr.new-row{animation:row-flash 1.2s ease;}
@keyframes row-flash{0%{background:rgba(34,197,94,0.3);}100%{background:transparent;}}

/* Badge overlay */
#badge-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(6px);}
#badge-content{text-align:center;animation:badge-pop 0.5s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes badge-pop{0%{transform:scale(0) rotate(-10deg);opacity:0;}100%{transform:scale(1) rotate(0);opacity:1;}}
.badge-icon{font-size:80px;filter:drop-shadow(0 4px 20px rgba(251,191,36,0.5));}
.badge-title{font-size:30px;font-weight:900;background:linear-gradient(135deg,#fbbf24,#f59e0b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:12px 0 6px;}
.badge-sub{font-size:15px;color:#94a3b8;}
#badge-close{margin-top:18px;padding:10px 32px;font-size:15px;font-weight:700;border:none;border-radius:10px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;cursor:pointer;box-shadow:0 4px 15px rgba(34,197,94,0.3);transition:all 0.2s;}
#badge-close:hover{transform:translateY(-2px);}
</style>
</head>
<body>
<div id="app">
<!-- LEFT PANEL -->
<div id="left-panel">
<div class="panel-title">üåΩ Unlock the Corn</div>
<div class="round-badge" id="round-display">Round 1 of 8</div>
<div class="mission-line">Feed ‚Üí Digest ‚Üí Check Niacin</div>

<div class="control-group">
<div class="control-label">üåΩ Corn Type</div>
<div class="selector-options" id="corn-options">
<button class="sel-btn active" data-val="degermed" onclick="selectCorn(this)"><span class="corn-dot corn-pale"></span>Stripped Corn<span class="lock-tag" style="display:none">LOCKED</span></button>
<button class="sel-btn" data-val="whole" onclick="selectCorn(this)"><span class="corn-dot corn-gold"></span>Whole Corn<span class="lock-tag" style="display:none">LOCKED</span></button>
<button class="sel-btn" data-val="treated" onclick="selectCorn(this)"><span class="corn-dot corn-teal"></span>Lime-Soaked Corn<span class="lock-tag" style="display:none">LOCKED</span></button>
</div>
</div>

<div class="control-group">
<div class="control-label">üçñ Other Foods</div>
<div class="selector-options" id="food-options">
<button class="sel-btn active" data-val="none" onclick="selectFood(this)">None<span class="lock-tag" style="display:none">LOCKED</span></button>
<button class="sel-btn" data-val="some" onclick="selectFood(this)">Meat & Eggs<span class="lock-tag" style="display:none">LOCKED</span></button>
<button class="sel-btn" data-val="full" onclick="selectFood(this)">Full Diet<span class="lock-tag" style="display:none">LOCKED</span></button>
</div>
</div>

<div class="control-group" id="fort-group">
<div class="control-label">‚ú® Fortification</div>
<div class="fort-wrap">
<div class="toggle-track locked" id="fort-toggle" onclick="toggleFort()"></div>
<span class="toggle-lbl" id="fort-label">OFF üîí</span>
</div>
</div>

<button id="feed-btn" onclick="feedRound()">üçΩÔ∏è FEED</button>
<button id="next-btn" onclick="nextRound()">‚û°Ô∏è NEXT ROUND</button>
<div class="ec-message" id="ec-msg">‚≠ê Required Done! Extra Credit?</div>

<div class="bottom-btns">
<button id="reset-btn" onclick="resetSim()">Reset</button>
<button id="newrun-btn" onclick="newRun()">New Run</button>
</div>
</div>

<!-- CENTER ARENA -->
<div id="center-panel">
<div id="arena-container">
<canvas id="arena-canvas"></canvas>
<div id="status-msg"></div>
<div id="random-event"></div>
<div id="completion">
<div class="comp-icon">üèÜ</div>
<div class="comp-title">Simulation Complete!</div>
<div class="comp-sub">Copy your data table and finish your worksheet.</div>
</div>
</div>
</div>

<!-- RIGHT PANEL -->
<div id="right-panel">
<div class="hud-title">üìä Body Status</div>

<div class="niacin-meter-wrap">
<div class="meter-label">Niacin Level</div>
<div class="meter-bar-bg">
<div class="meter-bar-fill" id="niacin-bar"></div>
<div class="meter-value" id="niacin-val">0%</div>
</div>
</div>

<div class="health-grid">
<div class="health-card" id="health-skin"><div class="health-icon">üß¥</div><div class="health-name">Skin</div><div class="health-status" id="skin-status">--</div></div>
<div class="health-card" id="health-gut"><div class="health-icon">ü´Å</div><div class="health-name">Gut</div><div class="health-status" id="gut-status">--</div></div>
<div class="health-card" id="health-brain"><div class="health-icon">üß†</div><div class="health-name">Brain</div><div class="health-status" id="brain-status">--</div></div>
<div class="health-card" id="health-heart"><div class="health-icon">‚ù§Ô∏è</div><div class="health-name">Heart</div><div class="health-status" id="heart-status">--</div></div>
</div>

<div class="ds-bar-wrap">
<div class="ds-label">4 D's Risk</div>
<div class="ds-bar">
<div class="ds-seg" id="ds-0" style="background:#22c55e;">OK</div>
<div class="ds-seg" id="ds-1" style="background:#eab308;">Skin</div>
<div class="ds-seg" id="ds-2" style="background:#f97316;">Gut</div>
<div class="ds-seg" id="ds-3" style="background:#ef4444;">Brain</div>
</div>
</div>

<div class="stats-grid">
<div class="stat-card"><div class="stat-val score-v" id="score-val">0</div><div class="stat-name">Score</div></div>
<div class="stat-card"><div class="stat-val streak-v" id="streak-val">0</div><div class="stat-name">Streak</div></div>
</div>

<div class="data-section">
<div class="data-header">
<span class="data-title">üìã Data Table</span>
<button id="copy-btn" onclick="copyTable()">üìã Copy Table</button>
</div>
<div class="table-wrap">
<table id="data-table">
<thead><tr><th>Rnd</th><th>Corn</th><th>Foods</th><th>Fort.</th><th>Niacin</th></tr></thead>
<tbody id="data-body"></tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Badge Overlay -->
<div id="badge-overlay">
<div id="badge-content">
<div class="badge-icon" id="badge-emoji">üèÖ</div>
<div class="badge-title" id="badge-title">Badge!</div>
<div class="badge-sub" id="badge-sub"></div>
<button id="badge-close" onclick="closeBadge()">Continue</button>
</div>
</div>

<script>
// ===== STATE =====
let S = {
  round:1, corn:'degermed', food:'none', fort:false,
  score:0, streak:0, rounds:[], phase:'pick',
  healthyStreak:0, badges:{}, randEvt:false, done:false
};

const NIACIN = {
  degermed:{base:12,food:{none:0,some:18,full:32},fortB:55},
  whole:{base:35,food:{none:0,some:20,full:30},fortB:30},
  treated:{base:75,food:{none:0,some:12,full:20},fortB:15}
};

const CORN_LABELS = {degermed:'Stripped',whole:'Whole',treated:'Lime-Soaked'};
const FOOD_LABELS = {none:'None',some:'Meat/Eggs',full:'Full Diet'};

// Canvas
let canvas,ctx,W,H,dpr;
let particles=[], floaters=[], sparks=[];
let personHP='healthy', curNiacin=0, targetNiacin=0;
let aPhase='idle', eatT=0, digestT=0, frame=0;
let ambients=[];
// Smooth animated niacin for HUD
let displayNiacin = 0;

function init(){
  try{
    canvas=document.getElementById('arena-canvas');
    ctx=canvas.getContext('2d');
    dpr = Math.min(window.devicePixelRatio||1, 2);
    resize();
    window.addEventListener('resize',resize);
    mkAmbient();
    updateControls();
    loop();
  }catch(e){console.error(e);}
}

function resize(){
  try{
    const el=canvas.parentElement;
    if(!el)return;
    const r=el.getBoundingClientRect();
    if(r.width<10||r.height<10)return;
    W=r.width; H=r.height;
    canvas.width=W*dpr; canvas.height=H*dpr;
    canvas.style.width=W+'px'; canvas.style.height=H+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    mkAmbient();
  }catch(e){}
}

function mkAmbient(){
  ambients=[];
  for(let i=0;i<30;i++) ambients.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-0.5)*0.4,vy:(Math.random()-0.5)*0.3,r:Math.random()*2+0.5,a:Math.random()*0.08+0.02,phase:Math.random()*Math.PI*2});
}

// ===== CONTROLS =====
function selectCorn(btn){
  if(S.phase!=='pick'||btn.classList.contains('locked'))return;
  document.querySelectorAll('#corn-options .sel-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); S.corn=btn.dataset.val;
}
function selectFood(btn){
  if(S.phase!=='pick'||btn.classList.contains('locked'))return;
  document.querySelectorAll('#food-options .sel-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); S.food=btn.dataset.val;
}
function toggleFort(){
  const t=document.getElementById('fort-toggle');
  if(S.phase!=='pick'||t.classList.contains('locked'))return;
  S.fort=!S.fort; t.classList.toggle('on',S.fort);
  document.getElementById('fort-label').textContent=S.fort?'ON':'OFF';
}

function updateControls(){
  try{
    const r=S.round;
    const cBtns=document.querySelectorAll('#corn-options .sel-btn');
    const fBtns=document.querySelectorAll('#food-options .sel-btn');
    const ft=document.getElementById('fort-toggle');
    const fl=document.getElementById('fort-label');

    function lockBtn(b,lock){
      if(lock){b.classList.add('locked');b.querySelector('.lock-tag').style.display='inline';}
      else{b.classList.remove('locked');b.querySelector('.lock-tag').style.display='none';}
    }

    if(r<=3){
      cBtns.forEach(b=>lockBtn(b,false));
      fBtns.forEach(b=>{
        if(b.dataset.val==='none'){b.classList.add('active');lockBtn(b,true);}
        else{b.classList.remove('active');lockBtn(b,true);}
      });
      S.food='none'; S.fort=false;
      ft.classList.add('locked');ft.classList.remove('on');
      fl.innerHTML='OFF üîí';
    } else if(r<=5){
      cBtns.forEach(b=>{
        if(b.dataset.val==='degermed'){b.classList.add('active');lockBtn(b,true);}
        else{b.classList.remove('active');lockBtn(b,true);}
      });
      S.corn='degermed';
      fBtns.forEach(b=>lockBtn(b,false));
      S.fort=false; ft.classList.add('locked');ft.classList.remove('on');
      fl.innerHTML='OFF üîí';
    } else if(r===6){
      cBtns.forEach(b=>{
        if(b.dataset.val==='degermed'){b.classList.add('active');lockBtn(b,true);}
        else{b.classList.remove('active');lockBtn(b,true);}
      });
      S.corn='degermed';
      fBtns.forEach(b=>{
        if(b.dataset.val==='none'){b.classList.add('active');lockBtn(b,true);}
        else{b.classList.remove('active');lockBtn(b,true);}
      });
      S.food='none';
      ft.classList.remove('locked');
      fl.textContent=S.fort?'ON':'OFF';
    } else {
      cBtns.forEach(b=>lockBtn(b,false));
      if(S.randEvt){
        fBtns.forEach(b=>{
          if(b.dataset.val==='full'){lockBtn(b,true);if(b.classList.contains('active')){b.classList.remove('active');}}
          else lockBtn(b,false);
        });
        if(S.food==='full'){S.food='none';fBtns[0].classList.add('active');}
      } else { fBtns.forEach(b=>lockBtn(b,false)); }
      ft.classList.remove('locked');
      fl.textContent=S.fort?'ON':'OFF';
    }

    document.getElementById('round-display').textContent=`Round ${r} of 8`;
    if(r===4&&S.rounds.length===3) showStatus('üçñ Food Tray Unlocked!');
    else if(r===6&&S.rounds.length===5) showStatus('‚ú® Fortification Unlocked!');
    document.getElementById('ec-msg').style.display=(r>5&&S.rounds.length>=5)?'block':'none';

    const re=document.getElementById('random-event');
    if(r>=7&&Math.random()<0.45&&!S.randEvt&&!S._updatingControls){
      S.randEvt=true;
      re.textContent='üí• Price Crash! Full diet unavailable!';
      re.style.display='block';
      setTimeout(()=>{re.style.display='none';},3500);
      S._updatingControls=true;
      updateControls();
      S._updatingControls=false;
      return;
    } else if(r<7){ S.randEvt=false; re.style.display='none'; }
  }catch(e){console.error(e);}
}

// ===== FEED =====
function feedRound(){
  try{
  if(S.phase!=='pick'||S.done)return;
  if(S.round===6&&!S.fort){showStatus('Toggle Fortification ON!');return;}

  S.phase='feeding';
  document.getElementById('feed-btn').disabled=true;

  const cfg=NIACIN[S.corn];
  let n=cfg.base+cfg.food[S.food];
  if(S.fort)n+=cfg.fortB;
  n=Math.min(100,Math.max(5,n+Math.floor(Math.random()*8-4)));
  targetNiacin=n;

  // Start eat
  aPhase='eating'; eatT=0; particles=[]; floaters=[]; sparks=[];

  setTimeout(()=>{ aPhase='digesting'; digestT=0; mkNiacinParts(n); },2000);
  setTimeout(()=>{ aPhase='done'; curNiacin=n; finishRound(n); },5500);
  setTimeout(()=>{ if(S.phase==='feeding'){aPhase='done';curNiacin=n;finishRound(n);} },7500);
  }catch(e){console.error('feedRound error:',e);S.phase='pick';document.getElementById('feed-btn').disabled=false;}
}

function mkNiacinParts(n){
  particles=[];
  const tot=40;
  const green=Math.round((n/100)*tot);
  for(let i=0;i<green;i++){
    particles.push({
      x:W*0.46+Math.random()*50-25, y:H*0.32+Math.random()*20,
      vx:(Math.random()-0.5)*1.5, vy:Math.random()*1.2+0.4,
      c:'#22c55e',g:'#4ade80',type:'g',r:4+Math.random()*3,
      abs:false,t:0,delay:Math.floor(Math.random()*50),trail:[]
    });
  }
  for(let i=0;i<tot-green;i++){
    particles.push({
      x:W*0.46+Math.random()*50-25, y:H*0.32+Math.random()*20,
      vx:(Math.random()-0.5)*1.5, vy:Math.random()*0.8+0.3,
      c:'#ef4444',g:'#f87171',type:'r',r:4+Math.random()*3,
      bounced:false,t:0,delay:Math.floor(Math.random()*50),trail:[]
    });
  }
}

function finishRound(n){
  try{
    S.phase='results';
    const rd={round:S.round,corn:S.corn,food:S.food,fort:S.fort?'ON':'OFF',niacin:n};
    S.rounds.push(rd);

    let pts=0;
    if(n>=60){pts=100;S.streak++;S.healthyStreak++;}
    else if(n>=30){pts=50;S.streak=0;S.healthyStreak=0;}
    else{pts=10;S.streak=0;S.healthyStreak=0;}
    S.score+=pts;

    updateHUD(n); addRow(rd);

    if(S.healthyStreak>=3&&!S.badges.unlock){
      S.badges.unlock=true;
      setTimeout(()=>showBadge('üîì','Niacin Unlocked!','3 healthy rounds in a row!'),600);
    }
    if(n>=60&&S.food==='none'&&!S.fort&&!S.badges.eff){
      S.badges.eff=true;
      setTimeout(()=>showBadge('‚ö°','Efficiency Expert!','Healthy with only corn!'),600);
    }
    if(S.rounds.length===5&&!S.badges.pw){
      S.badges.pw=true;
      setTimeout(()=>showBadge('üó∫Ô∏è','Map Unlocked!','Mexico vs. American South'),900);
    }

    document.getElementById('next-btn').style.display='block';
    document.getElementById('feed-btn').disabled=true;
  }catch(e){console.error(e);}
}

function nextRound(){
  try{
  if(S.round>=8){
    S.done=true;
    document.getElementById('completion').style.display='flex';
    document.getElementById('next-btn').style.display='none';
    if(!S.badges.ec){S.badges.ec=true;showBadge('üèÜ','Extra Credit Complete!','All 8 rounds finished!');}
    return;
  }
  S.round++; S.phase='pick'; S.randEvt=false; aPhase='idle';
  particles=[]; floaters=[]; sparks=[];
  document.getElementById('next-btn').style.display='none';
  document.getElementById('feed-btn').disabled=false;
  document.getElementById('random-event').style.display='none';
  updateControls();
  }catch(e){console.error('nextRound error:',e);S.phase='pick';document.getElementById('feed-btn').disabled=false;}
}

// ===== HUD =====
function updateHUD(n){
  try{
    const bar=document.getElementById('niacin-bar');
    const val=document.getElementById('niacin-val');
    bar.style.width=n+'%'; val.textContent=n+'%';
    if(n>=60) bar.style.background='linear-gradient(90deg,#22c55e,#4ade80)';
    else if(n>=30) bar.style.background='linear-gradient(90deg,#eab308,#facc15)';
    else bar.style.background='linear-gradient(90deg,#ef4444,#f87171)';

    const organs=['skin','gut','brain','heart'];
    const thresh=[50,40,25,15];
    organs.forEach((o,i)=>{
      const c=document.getElementById('health-'+o);
      const s=document.getElementById(o+'-status');
      if(n>=thresh[i]){
        c.style.borderColor='#22c55e';c.style.background='rgba(34,197,94,0.1)';
        c.style.boxShadow='0 0 12px rgba(34,197,94,0.15)';
        s.textContent='Healthy';s.style.color='#22c55e';
      } else if(n>=thresh[i]-15){
        c.style.borderColor='#eab308';c.style.background='rgba(234,179,8,0.1)';
        c.style.boxShadow='0 0 12px rgba(234,179,8,0.15)';
        s.textContent='Stressed';s.style.color='#eab308';
      } else {
        c.style.borderColor='#ef4444';c.style.background='rgba(239,68,68,0.1)';
        c.style.boxShadow='0 0 12px rgba(239,68,68,0.15)';
        s.textContent='Critical';s.style.color='#ef4444';
      }
    });

    personHP=n>=60?'healthy':n>=30?'struggling':'critical';

    let d=0;
    if(n<50)d=1;if(n<35)d=2;if(n<20)d=3;
    for(let i=0;i<4;i++)document.getElementById('ds-'+i).classList.toggle('active',i<=d);

    document.getElementById('score-val').textContent=S.score;
    document.getElementById('streak-val').textContent=S.streak;
  }catch(e){}
}

function addRow(d){
  try{
    const tb=document.getElementById('data-body');
    const tr=document.createElement('tr');tr.className='new-row';
    const cl=CORN_LABELS[d.corn],fl=FOOD_LABELS[d.food];
    const nc=d.niacin>=60?'#22c55e':d.niacin>=30?'#eab308':'#ef4444';
    tr.innerHTML=`<td>${d.round}</td><td>${cl}</td><td>${fl}</td><td>${d.fort}</td><td style="color:${nc};font-weight:800;">${d.niacin}%</td>`;
    tb.appendChild(tr);
    tr.scrollIntoView({behavior:'smooth',block:'nearest'});
  }catch(e){}
}

function copyTable(){
  try{
    let t='Round\tCorn Type\tOther Foods\tFortification\tNiacin Level (%)\n';
    S.rounds.forEach(d=>{
      t+=`${d.round}\t${CORN_LABELS[d.corn]}\t${FOOD_LABELS[d.food]}\t${d.fort}\t${d.niacin}%\n`;
    });
    if(navigator.clipboard&&navigator.clipboard.writeText){
      navigator.clipboard.writeText(t).then(()=>copyFeedback()).catch(()=>fallbackCopy(t));
    } else { fallbackCopy(t); }
  }catch(e){}
}
function fallbackCopy(t){const a=document.createElement('textarea');a.value=t;document.body.appendChild(a);a.select();document.execCommand('copy');document.body.removeChild(a);copyFeedback();}
function copyFeedback(){const b=document.getElementById('copy-btn');b.textContent='‚úÖ Copied!';setTimeout(()=>{b.textContent='üìã Copy Table';},2000);}

function showStatus(m){const e=document.getElementById('status-msg');e.textContent=m;e.style.display='block';setTimeout(()=>{e.style.display='none';},2800);}
function showBadge(e,t,s){document.getElementById('badge-emoji').textContent=e;document.getElementById('badge-title').textContent=t;document.getElementById('badge-sub').textContent=s;document.getElementById('badge-overlay').style.display='flex';}
function closeBadge(){document.getElementById('badge-overlay').style.display='none';}

function resetSim(){
  try{
  S={round:1,corn:'degermed',food:'none',fort:false,score:0,streak:0,rounds:[],phase:'pick',healthyStreak:0,badges:{},randEvt:false,done:false};
  curNiacin=0;targetNiacin=0;aPhase='idle';particles=[];floaters=[];sparks=[];personHP='healthy';displayNiacin=0;
  document.getElementById('data-body').innerHTML='';
  document.getElementById('niacin-bar').style.width='0%';
  document.getElementById('niacin-val').textContent='0%';
  document.getElementById('next-btn').style.display='none';
  document.getElementById('feed-btn').disabled=false;
  document.getElementById('completion').style.display='none';
  document.getElementById('ec-msg').style.display='none';
  document.getElementById('random-event').style.display='none';
  ['skin','gut','brain','heart'].forEach(o=>{
    const c=document.getElementById('health-'+o);
    c.style.borderColor='rgba(255,255,255,0.06)';c.style.background='rgba(255,255,255,0.03)';c.style.boxShadow='none';
    const s=document.getElementById(o+'-status');s.textContent='--';s.style.color='#64748b';
  });
  for(let i=0;i<4;i++)document.getElementById('ds-'+i).classList.remove('active');
  document.getElementById('score-val').textContent='0';
  document.getElementById('streak-val').textContent='0';
  document.querySelectorAll('#corn-options .sel-btn').forEach((b,i)=>b.classList.toggle('active',i===0));
  document.querySelectorAll('#food-options .sel-btn').forEach((b,i)=>b.classList.toggle('active',i===0));
  document.getElementById('fort-toggle').classList.remove('on');
  document.getElementById('fort-label').innerHTML='OFF üîí';
  updateControls();
  }catch(e){console.error('resetSim error:',e);}
}
function newRun(){resetSim();}

// ===== RENDERING =====
function loop(){
  try{
    if(W<10||H<10){requestAnimationFrame(loop);return;}
    frame++;
    ctx.clearRect(0,0,W,H);
    drawBG();
    drawBody();
    drawPlate();
    if(aPhase==='eating') drawEat();
    if(aPhase==='digesting'||aPhase==='done') drawParts();
    drawSparks();
    drawLabels();
    drawAmb();
  }catch(e){}
  requestAnimationFrame(loop);
}

function drawBG(){
  // Subtle radial glow in center
  const grd=ctx.createRadialGradient(W*0.46,H*0.5,50,W*0.46,H*0.5,Math.max(W,H)*0.6);
  grd.addColorStop(0,'rgba(99,102,241,0.03)');
  grd.addColorStop(1,'transparent');
  ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);

  // Grid
  ctx.strokeStyle='rgba(99,102,241,0.04)';ctx.lineWidth=0.5;
  for(let x=0;x<W;x+=50){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=50){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
}

function drawBody(){
  const cx=W*0.46, cy=H*0.5;
  const sc=Math.min(W/900,H/600)*1.1;
  ctx.save();ctx.translate(cx,cy);ctx.scale(sc,sc);

  // Outer glow
  const glowCol=personHP==='healthy'?'rgba(34,197,94,0.12)':personHP==='struggling'?'rgba(234,179,8,0.1)':'rgba(239,68,68,0.12)';
  const pulse=Math.sin(frame*0.04)*0.3+0.7;
  ctx.shadowColor=personHP==='healthy'?'#22c55e':personHP==='struggling'?'#eab308':'#ef4444';
  ctx.shadowBlur=20*pulse;
  ctx.strokeStyle=glowCol;ctx.lineWidth=6;
  ctx.beginPath();ctx.ellipse(0,0,100,200,0,0,Math.PI*2);ctx.stroke();
  ctx.shadowBlur=0;

  // Torso
  const skinGrad=ctx.createLinearGradient(-70,-190,70,180);
  if(personHP==='healthy'){skinGrad.addColorStop(0,'#fcd5b0');skinGrad.addColorStop(1,'#f5c08e');}
  else if(personHP==='struggling'){skinGrad.addColorStop(0,'#f0c097');skinGrad.addColorStop(1,'#dfa578');}
  else{skinGrad.addColorStop(0,'#e09080');skinGrad.addColorStop(1,'#cc7060');}

  // Head
  ctx.fillStyle=skinGrad;
  ctx.beginPath();ctx.arc(0,-165,48,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.1)';ctx.lineWidth=1.5;ctx.stroke();

  // Hair
  ctx.fillStyle='#2d1810';
  ctx.beginPath();ctx.ellipse(0,-195,46,22,0,Math.PI,0);ctx.fill();

  // Face
  if(personHP==='healthy'){
    ctx.fillStyle='#3a2a1a';
    ctx.beginPath();ctx.ellipse(-16,-170,5,6,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(16,-170,5,6,0,0,Math.PI*2);ctx.fill();
    // Eye glint
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(-14,-172,2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(18,-172,2,0,Math.PI*2);ctx.fill();
    // Smile
    ctx.strokeStyle='#5a3a2a';ctx.lineWidth=2.5;
    ctx.beginPath();ctx.arc(0,-152,16,0.15,Math.PI-0.15);ctx.stroke();
    // Blush
    ctx.fillStyle='rgba(255,150,150,0.2)';
    ctx.beginPath();ctx.ellipse(-28,-155,10,6,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(28,-155,10,6,0,0,Math.PI*2);ctx.fill();
  } else if(personHP==='struggling'){
    ctx.fillStyle='#4a3a2a';
    ctx.beginPath();ctx.ellipse(-16,-170,4.5,5,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(16,-170,4.5,5,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#5a4a3a';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(-12,-148);ctx.lineTo(12,-148);ctx.stroke();
    // Skin patches
    ctx.fillStyle='rgba(220,60,60,0.3)';
    ctx.beginPath();ctx.ellipse(-35,-158,12,8,0.3,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(32,-165,10,7,-0.2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(20,-140,8,5,0.1,0,Math.PI*2);ctx.fill();
  } else {
    ctx.fillStyle='#6a5a4a';
    ctx.beginPath();ctx.ellipse(-16,-168,3.5,4,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(16,-168,3.5,4,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#6a5a4a';ctx.lineWidth=2;
    ctx.beginPath();ctx.arc(0,-146,12,Math.PI+0.2,-0.2);ctx.stroke();
    // Severe patches
    ctx.fillStyle='rgba(200,40,40,0.45)';
    ctx.beginPath();ctx.ellipse(-36,-158,15,10,0.3,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(34,-162,14,9,-0.2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(-22,-140,10,7,0.1,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(10,-135,9,6,-0.1,0,Math.PI*2);ctx.fill();
    // Dark circles
    ctx.fillStyle='rgba(80,40,60,0.3)';
    ctx.beginPath();ctx.ellipse(-16,-163,7,4,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(16,-163,7,4,0,0,Math.PI*2);ctx.fill();
  }

  // Neck
  ctx.fillStyle=skinGrad;
  ctx.fillRect(-16,-118,32,22);

  // Torso body
  ctx.beginPath();
  ctx.moveTo(-65,-96);
  ctx.bezierCurveTo(-80,-50,-72,60,-48,140);
  ctx.lineTo(48,140);
  ctx.bezierCurveTo(72,60,80,-50,65,-96);
  ctx.closePath();
  ctx.fillStyle=skinGrad;ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.08)';ctx.lineWidth=1.5;ctx.stroke();

  // ---- INTERNAL ORGANS ----

  // Esophagus
  ctx.strokeStyle='rgba(220,120,120,0.25)';ctx.lineWidth=8;
  ctx.beginPath();ctx.moveTo(0,-96);ctx.quadraticCurveTo(-5,-60,-8,-35);ctx.stroke();

  // Stomach - rounded pouch shape
  const stomachGlow=personHP==='healthy'?'rgba(34,197,94,0.2)':personHP==='struggling'?'rgba(234,179,8,0.2)':'rgba(239,68,68,0.2)';
  ctx.fillStyle=stomachGlow;
  ctx.beginPath();
  ctx.moveTo(-8,-35);
  ctx.bezierCurveTo(-40,-25,-48,5,-35,30);
  ctx.bezierCurveTo(-20,50,15,45,22,25);
  ctx.bezierCurveTo(28,5,15,-20,-8,-35);
  ctx.closePath();
  ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=2;ctx.stroke();

  // Stomach acid bubbles
  for(let i=0;i<4;i++){
    const bx=-15+Math.sin(frame*0.03+i*1.5)*12;
    const by=-5+Math.cos(frame*0.04+i*1.2)*8;
    ctx.fillStyle=`rgba(255,255,200,${0.1+Math.sin(frame*0.05+i)*0.05})`;
    ctx.beginPath();ctx.arc(bx,by,3+Math.sin(frame*0.06+i)*1,0,Math.PI*2);ctx.fill();
  }

  // Gut wall - thicker, more visible dashed line
  const gutY=42;
  ctx.save();
  ctx.strokeStyle='rgba(255,255,255,0.35)';ctx.lineWidth=4;
  ctx.setLineDash([10,5]);
  ctx.beginPath();ctx.moveTo(-55,gutY);ctx.lineTo(55,gutY);ctx.stroke();
  ctx.setLineDash([]);
  ctx.restore();

  // Gut wall membrane glow
  const memGrad=ctx.createLinearGradient(-55,gutY-4,55,gutY+4);
  memGrad.addColorStop(0,'rgba(139,92,246,0.08)');
  memGrad.addColorStop(0.5,'rgba(139,92,246,0.15)');
  memGrad.addColorStop(1,'rgba(139,92,246,0.08)');
  ctx.fillStyle=memGrad;
  ctx.fillRect(-55,gutY-3,110,6);

  // Bloodstream area
  const bsGrad=ctx.createLinearGradient(0,gutY+8,0,gutY+90);
  bsGrad.addColorStop(0,'rgba(220,38,38,0.06)');
  bsGrad.addColorStop(1,'rgba(220,38,38,0.02)');
  ctx.fillStyle=bsGrad;
  ctx.fillRect(-55,gutY+8,110,82);

  // Blood vessel lines - animated flow
  const flowOff=(frame%90)/90;
  ctx.strokeStyle='rgba(220,38,38,0.12)';ctx.lineWidth=1.5;
  for(let i=0;i<6;i++){
    const fy=gutY+18+i*12;
    ctx.beginPath();
    for(let fx=-50;fx<55;fx+=2){
      const w=Math.sin((fx+flowOff*90)*0.08+i*0.5)*4;
      if(fx===-50)ctx.moveTo(fx,fy+w);else ctx.lineTo(fx,fy+w);
    }
    ctx.stroke();
  }

  // Animated blood cells flowing
  for(let i=0;i<8;i++){
    const t=(frame*0.8+i*35)%300;
    const bx=-50+(t/300)*105;
    const by=gutY+22+i*10+Math.sin(t*0.05)*3;
    ctx.fillStyle=`rgba(220,38,38,${0.15+Math.sin(frame*0.03+i)*0.05})`;
    ctx.beginPath();ctx.ellipse(bx,by,4,2.5,0,0,Math.PI*2);ctx.fill();
  }

  // Person posture overlay
  if(personHP==='struggling'){
    // Slight yellow tint
    ctx.fillStyle='rgba(234,179,8,0.03)';
    ctx.beginPath();ctx.ellipse(0,-20,90,180,0,0,Math.PI*2);ctx.fill();
  } else if(personHP==='critical'){
    // Red warning tint
    ctx.fillStyle='rgba(239,68,68,0.05)';
    ctx.beginPath();ctx.ellipse(0,-20,90,180,0,0,Math.PI*2);ctx.fill();
    // Warning ring pulse
    const wp=Math.sin(frame*0.08)*0.5+0.5;
    ctx.strokeStyle=`rgba(239,68,68,${0.1*wp})`;ctx.lineWidth=3;
    ctx.beginPath();ctx.ellipse(0,-20,95+wp*5,185+wp*5,0,0,Math.PI*2);ctx.stroke();
  }

  ctx.restore();
}

function drawPlate(){
  const px=W*0.1, py=H*0.6;
  const sc=Math.min(W/900,H/600)*1.1;
  ctx.save();ctx.translate(px,py);ctx.scale(sc,sc);

  // Plate shadow
  ctx.fillStyle='rgba(0,0,0,0.15)';
  ctx.beginPath();ctx.ellipse(0,8,62,18,0,0,Math.PI*2);ctx.fill();

  // Plate
  const plateGrad=ctx.createRadialGradient(0,-5,10,0,0,60);
  plateGrad.addColorStop(0,'#f5f0e8');plateGrad.addColorStop(1,'#ddd5c5');
  ctx.fillStyle=plateGrad;
  ctx.beginPath();ctx.ellipse(0,0,60,22,0,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='rgba(180,170,150,0.5)';ctx.lineWidth=2;ctx.stroke();
  // Plate rim
  ctx.strokeStyle='rgba(200,190,170,0.3)';ctx.lineWidth=1;
  ctx.beginPath();ctx.ellipse(0,0,50,16,0,0,Math.PI*2);ctx.stroke();

  if(aPhase==='idle'||aPhase==='eating'){
    // CORN - much more detailed
    const cornCfg={
      degermed:{body:'#e8d9b0',kernel:'#d4c89e',outline:'#c4b488',shadow:'rgba(180,160,120,0.3)',lbl:'Stripped'},
      whole:{body:'#f5c842',kernel:'#e8a817',outline:'#c4910a',shadow:'rgba(200,160,0,0.3)',lbl:'Whole'},
      treated:{body:'#80cbc4',kernel:'#4db6ac',outline:'#339e96',shadow:'rgba(50,170,160,0.3)',lbl:'Lime-Soaked'}
    };
    const cc=cornCfg[S.corn];

    // Corn shadow
    ctx.fillStyle=cc.shadow;
    ctx.beginPath();ctx.ellipse(-2,12,20,6,0.1,0,Math.PI*2);ctx.fill();

    // Corn cob body
    const cornGrad=ctx.createLinearGradient(-18,-45,18,-45);
    cornGrad.addColorStop(0,cc.outline);cornGrad.addColorStop(0.3,cc.body);
    cornGrad.addColorStop(0.7,cc.body);cornGrad.addColorStop(1,cc.outline);
    ctx.fillStyle=cornGrad;
    ctx.beginPath();
    ctx.moveTo(-14,-50);
    ctx.bezierCurveTo(-20,-30,-20,10,-12,25);
    ctx.quadraticCurveTo(0,32,12,25);
    ctx.bezierCurveTo(20,10,20,-30,14,-50);
    ctx.quadraticCurveTo(0,-55,-14,-50);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle=cc.outline;ctx.lineWidth=1.5;ctx.stroke();

    // Kernel rows
    for(let row=-42;row<22;row+=7){
      for(let col=-10;col<12;col+=7){
        const kx=col+Math.sin(row*0.2)*2;
        const ky=row;
        // Check if inside corn shape roughly
        if(Math.abs(kx)<14-Math.abs(ky)*0.08){
          ctx.fillStyle=cc.kernel;
          ctx.beginPath();ctx.ellipse(kx,ky,2.8,3.2,0,0,Math.PI*2);ctx.fill();
          // Kernel highlight
          ctx.fillStyle='rgba(255,255,255,0.15)';
          ctx.beginPath();ctx.ellipse(kx-0.8,ky-1,1.2,1.5,0,0,Math.PI*2);ctx.fill();
        }
      }
    }

    // Husk leaves
    ctx.fillStyle='#7cb342';
    ctx.beginPath();
    ctx.moveTo(-8,-48);ctx.quadraticCurveTo(-25,-60,-18,-75);
    ctx.quadraticCurveTo(-10,-65,-5,-50);ctx.closePath();ctx.fill();
    ctx.beginPath();
    ctx.moveTo(8,-48);ctx.quadraticCurveTo(22,-58,16,-72);
    ctx.quadraticCurveTo(12,-62,5,-50);ctx.closePath();ctx.fill();
    // Leaf veins
    ctx.strokeStyle='rgba(100,160,50,0.4)';ctx.lineWidth=0.5;
    ctx.beginPath();ctx.moveTo(-8,-48);ctx.lineTo(-16,-68);ctx.stroke();
    ctx.beginPath();ctx.moveTo(8,-48);ctx.lineTo(14,-66);ctx.stroke();

    // TREATED CORN - lime wash swirl effect
    if(S.corn==='treated'){
      ctx.save();
      for(let i=0;i<8;i++){
        const angle=frame*0.025+i*0.785;
        const rx=Math.cos(angle)*24;
        const ry=Math.sin(angle)*40-12;
        const alpha=0.3+Math.sin(frame*0.06+i)*0.15;
        ctx.fillStyle=`rgba(77,182,172,${alpha})`;
        ctx.beginPath();ctx.arc(rx,ry,2.5+Math.sin(frame*0.08+i)*0.8,0,Math.PI*2);ctx.fill();
        // Trail
        const rx2=Math.cos(angle-0.3)*24;
        const ry2=Math.sin(angle-0.3)*40-12;
        ctx.fillStyle=`rgba(77,182,172,${alpha*0.4})`;
        ctx.beginPath();ctx.arc(rx2,ry2,1.5,0,Math.PI*2);ctx.fill();
      }
      // Glow ring
      ctx.strokeStyle=`rgba(77,182,172,${0.2+Math.sin(frame*0.04)*0.1})`;
      ctx.lineWidth=2;
      ctx.beginPath();ctx.ellipse(0,-12,26,44,0,0,Math.PI*2);ctx.stroke();
      ctx.restore();
    }

    // FORTIFICATION golden overlay
    if(S.fort){
      ctx.save();
      const fPulse=Math.sin(frame*0.05)*0.15+0.85;
      ctx.globalAlpha=0.25*fPulse;
      ctx.fillStyle='#fbbf24';
      ctx.beginPath();
      ctx.moveTo(-14,-50);ctx.bezierCurveTo(-20,-30,-20,10,-12,25);
      ctx.quadraticCurveTo(0,32,12,25);ctx.bezierCurveTo(20,10,20,-30,14,-50);
      ctx.quadraticCurveTo(0,-55,-14,-50);ctx.closePath();ctx.fill();
      ctx.globalAlpha=1;
      // Sparkles
      for(let i=0;i<5;i++){
        const sx=Math.sin(frame*0.04+i*1.2)*18;
        const sy=Math.cos(frame*0.05+i*1.5)*35-12;
        const sa=0.5+Math.sin(frame*0.1+i)*0.3;
        drawStar(sx,sy,3+Math.sin(frame*0.08+i)*1,5,'#fbbf24',sa);
      }
      ctx.restore();
    }

    // FOOD ITEMS
    if(S.food==='some'){
      // Drumstick
      ctx.fillStyle='#a0522d';
      ctx.beginPath();ctx.ellipse(42,0,14,10,0.3,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#8b4513';
      ctx.fillRect(50,-2,10,4);ctx.beginPath();ctx.arc(60,0,3,0,Math.PI*2);ctx.fill();
      // Egg
      ctx.fillStyle='#fff8dc';
      ctx.beginPath();ctx.ellipse(36,-22,9,11,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#ffd700';
      ctx.beginPath();ctx.arc(36,-22,5,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.4)';
      ctx.beginPath();ctx.arc(34,-24,2,0,Math.PI*2);ctx.fill();
    } else if(S.food==='full'){
      ctx.fillStyle='#a0522d';ctx.beginPath();ctx.ellipse(40,2,12,8,0.2,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#4caf50';ctx.beginPath();ctx.ellipse(44,-18,9,7,-0.1,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#ff6347';ctx.beginPath();ctx.arc(32,-12,6,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#fff8dc';ctx.beginPath();ctx.ellipse(52,-10,7,9,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(52,-10,4,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#ff8c00';ctx.beginPath();ctx.arc(28,8,6,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#9c27b0';ctx.beginPath();ctx.arc(50,8,4,0,Math.PI*2);ctx.fill();
    }
  }
  ctx.restore();
}

function drawStar(x,y,r,pts,color,alpha){
  ctx.save();ctx.globalAlpha=alpha;ctx.fillStyle=color;
  ctx.beginPath();
  for(let i=0;i<pts*2;i++){
    const a=Math.PI/pts*i-Math.PI/2;
    const rad=i%2===0?r:r*0.4;
    if(i===0)ctx.moveTo(x+Math.cos(a)*rad,y+Math.sin(a)*rad);
    else ctx.lineTo(x+Math.cos(a)*rad,y+Math.sin(a)*rad);
  }
  ctx.closePath();ctx.fill();ctx.restore();
}

function drawEat(){
  eatT++;
  const progress=Math.min(eatT/70,1);
  const px=W*0.1, py=H*0.6;
  const tx=W*0.46, ty=H*0.5-80;
  const sc=Math.min(W/900,H/600)*1.1;

  // Multiple food particles float toward mouth
  for(let i=0;i<5;i++){
    const t=((progress*1.2+i*0.12)%1);
    if(t>1)continue;
    const x=px+((tx-px)*t);
    const y=py+((ty-py)*t)-Math.sin(t*Math.PI)*40;
    const alpha=(1-t)*0.9;
    const sz=(6-t*3)*sc;

    ctx.save();ctx.globalAlpha=alpha;
    // Corn kernel
    const cols=['#f5c842','#e8a817','#80cbc4'];
    ctx.fillStyle=S.corn==='treated'?cols[2]:S.corn==='whole'?cols[0]:cols[1];
    ctx.beginPath();ctx.arc(x,y,sz,0,Math.PI*2);ctx.fill();
    // Glow trail
    ctx.shadowColor=ctx.fillStyle;ctx.shadowBlur=8;
    ctx.beginPath();ctx.arc(x,y,sz*0.5,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;
    ctx.restore();
  }
}

function drawParts(){
  const sc=Math.min(W/900,H/600)*1.1;
  const cx=W*0.46, cy=H*0.5;
  const gutWallY=cy+42*sc;

  particles.forEach(p=>{
    if(p.delay>0){p.delay--;return;}
    p.t++;

    // Trail
    if(p.t%3===0&&p.trail.length<8) p.trail.push({x:p.x,y:p.y,a:0.4});

    if(p.type==='g'&&!p.abs){
      p.y+=p.vy*sc; p.x+=Math.sin(p.t*0.04)*0.6;
      if(p.y>gutWallY){
        p.abs=true; p.vy*=0.4;
        // Spark on absorption
        for(let i=0;i<3;i++) sparks.push({x:p.x,y:p.y,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,life:20,c:'#4ade80'});
      }
    } else if(p.type==='g'&&p.abs){
      p.y+=p.vy*sc*0.25; p.x+=(Math.random()-0.5)*0.8;
      p.r*=0.997;
    }

    if(p.type==='r'&&!p.bounced){
      p.y+=p.vy*sc; p.x+=Math.sin(p.t*0.06)*0.4;
      if(p.y>gutWallY-4*sc){
        p.bounced=true;
        p.vy=-Math.abs(p.vy)*1.2;
        p.vx=(Math.random()-0.5)*4;
        for(let i=0;i<3;i++) sparks.push({x:p.x,y:p.y,vx:(Math.random()-0.5)*3,vy:-Math.random()*3,life:15,c:'#f87171'});
      }
    } else if(p.type==='r'&&p.bounced){
      p.y+=p.vy*sc*0.4; p.x+=p.vx*sc*0.4;
      p.vy+=0.03; p.r*=0.992;
    }

    // Draw trail
    p.trail.forEach((tr,ti)=>{
      tr.a*=0.88;
      if(tr.a>0.02){
        ctx.fillStyle=p.type==='g'?`rgba(34,197,94,${tr.a})`:`rgba(239,68,68,${tr.a})`;
        ctx.beginPath();ctx.arc(tr.x,tr.y,p.r*sc*0.4,0,Math.PI*2);ctx.fill();
      }
    });
    p.trail=p.trail.filter(tr=>tr.a>0.02);

    // Draw particle
    if(p.r>0.3){
      ctx.save();
      const alpha=Math.max(0,1-p.t/250);
      ctx.globalAlpha=alpha;
      // Glow
      ctx.shadowColor=p.g;ctx.shadowBlur=10;
      ctx.fillStyle=p.c;
      ctx.beginPath();ctx.arc(p.x,p.y,p.r*sc,0,Math.PI*2);ctx.fill();
      // Inner bright core
      ctx.shadowBlur=0;
      ctx.fillStyle=p.type==='g'?'rgba(255,255,255,0.4)':'rgba(255,200,200,0.3)';
      ctx.beginPath();ctx.arc(p.x-p.r*sc*0.2,p.y-p.r*sc*0.2,p.r*sc*0.4,0,Math.PI*2);ctx.fill();
      ctx.restore();
    }
  });
}

function drawSparks(){
  sparks=sparks.filter(s=>{
    s.x+=s.vx;s.y+=s.vy;s.life--;s.vx*=0.92;s.vy*=0.92;
    if(s.life<=0)return false;
    ctx.save();ctx.globalAlpha=s.life/20;
    ctx.fillStyle=s.c;
    ctx.beginPath();ctx.arc(s.x,s.y,2,0,Math.PI*2);ctx.fill();
    ctx.restore();
    return true;
  });
}

function drawLabels(){
  const sc=Math.min(W/900,H/600)*1.1;
  const cx=W*0.46, cy=H*0.5;
  const fs=Math.max(11,12*sc);

  ctx.save();
  ctx.font=`bold ${fs}px 'Segoe UI'`;ctx.textAlign='center';

  // Label backgrounds for readability
  function labelBG(text,x,y,color){
    const m=ctx.measureText(text);
    const pw=6,ph=3;
    ctx.fillStyle='rgba(15,23,42,0.7)';
    ctx.beginPath();
    const rr=4;
    const lx=x-m.width/2-pw,ly=y-fs*0.7-ph,lw=m.width+pw*2,lh=fs+ph*2;
    ctx.roundRect(lx,ly,lw,lh,rr);ctx.fill();
    ctx.fillStyle=color;ctx.fillText(text,x,y);
  }

  labelBG('Stomach',cx-8*sc,cy-28*sc,'rgba(255,255,255,0.7)');
  labelBG('Gut Wall',cx+45*sc,cy+42*sc,'rgba(167,139,250,0.8)');
  labelBG('Bloodstream',cx,cy+88*sc,'rgba(248,113,113,0.7)');

  // Corn type label under plate
  const cornName=CORN_LABELS[S.corn];
  ctx.font=`bold ${Math.max(11,13*sc)}px 'Segoe UI'`;
  labelBG(cornName+' Corn',W*0.1,H*0.6+40*sc,'rgba(255,255,255,0.8)');

  // Key legend top-right
  const kx=W*0.82, ky=20;
  ctx.font=`bold ${Math.max(10,11*sc)}px 'Segoe UI'`;
  ctx.fillStyle='rgba(15,23,42,0.6)';
  ctx.beginPath();ctx.roundRect(kx-12,ky-10,110*sc,50,8);ctx.fill();

  ctx.fillStyle='#22c55e';ctx.beginPath();ctx.arc(kx,ky+4,5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.8)';ctx.textAlign='left';ctx.fillText('Absorbed',kx+10,ky+8);

  ctx.fillStyle='#ef4444';ctx.beginPath();ctx.arc(kx,ky+24,5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.8)';ctx.fillText('Locked',kx+10,ky+28);

  ctx.restore();
}

function drawAmb(){
  ambients.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;
    p.phase+=0.02;
    if(p.x<0)p.x=W;if(p.x>W)p.x=0;
    if(p.y<0)p.y=H;if(p.y>H)p.y=0;
    const a=p.a*(0.7+Math.sin(p.phase)*0.3);
    ctx.fillStyle=`rgba(129,140,248,${a})`;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
  });
}

// Polyfill roundRect
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    if(typeof r==='number')r={tl:r,tr:r,br:r,bl:r};
    this.moveTo(x+r.tl,y);this.lineTo(x+w-r.tr,y);this.quadraticCurveTo(x+w,y,x+w,y+r.tr);
    this.lineTo(x+w,y+h-r.br);this.quadraticCurveTo(x+w,y+h,x+w-r.br,y+h);
    this.lineTo(x+r.bl,y+h);this.quadraticCurveTo(x,y+h,x,y+h-r.bl);
    this.lineTo(x,y+r.tl);this.quadraticCurveTo(x,y,x+r.tl,y);this.closePath();
  };
}

window.addEventListener('load',init);
window.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
