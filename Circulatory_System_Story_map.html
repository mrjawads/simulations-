<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr. Jawad Simulation Circulatory System ‚Äî What Happens When Your Heart Faces Extreme Demands</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#1a1a2e;--bg2:#16213e;--accent:#e94560;--accent2:#0f3460;
--ok:#4caf50;--strain:#ffc107;--danger:#f44336;--stopped:#212121;
--card-bg:rgba(255,255,255,0.06);--text:#f0f0f0;--text-dim:#aaa;
--blue:#2196f3;--purple:#9c27b0;--teal:#00bcd4;
}
html,body{height:100%;overflow:hidden}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
/* HEADER */
.sim-header{background:linear-gradient(135deg,var(--accent),var(--purple));padding:10px 20px;text-align:center;flex-shrink:0;position:relative;overflow:hidden}
.sim-header h1{font-size:20px;font-weight:700;text-shadow:0 2px 8px rgba(0,0,0,.4)}
.sim-header::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.05) 0%,transparent 70%);animation:headerPulse 6s infinite}
@keyframes headerPulse{0%,100%{opacity:.3}50%{opacity:.6}}
/* MAIN LAYOUT */
.main{display:flex;flex:1;overflow:hidden}
/* LEFT SIDEBAR */
.left-sidebar{width:280px;min-width:280px;background:var(--bg2);border-right:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;overflow-y:auto;padding:12px}
.left-sidebar h3{font-size:13px;color:var(--teal);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
.scenario-count{font-size:11px;color:var(--text-dim);margin-bottom:10px}
.scenario-card{background:var(--card-bg);border:2px solid transparent;border-radius:10px;padding:10px 12px;margin-bottom:6px;cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:10px}
.scenario-card:hover{border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.1)}
.scenario-card.active{border-color:var(--teal);background:rgba(0,188,212,.15);box-shadow:0 0 12px rgba(0,188,212,.2)}
.scenario-card.completed{border-color:var(--ok);position:relative}
.scenario-card.completed::after{content:'‚úì';position:absolute;top:4px;right:8px;color:var(--ok);font-weight:700;font-size:14px}
.scenario-card .sc-emoji{font-size:28px;flex-shrink:0}
.scenario-card .sc-name{font-size:13px;font-weight:600;line-height:1.3}
.divider{height:1px;background:rgba(255,255,255,.1);margin:12px 0}
.reading-level-section h3{margin-bottom:6px}
.rl-tabs{display:flex;gap:4px;margin-bottom:4px}
.rl-tab{flex:1;text-align:center;padding:6px 4px;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.06);border:1px solid transparent}
.rl-tab:hover{background:rgba(255,255,255,.12)}
.rl-tab.active-low{background:var(--ok);color:#fff;border-color:var(--ok)}
.rl-tab.active-med{background:var(--strain);color:#000;border-color:var(--strain)}
.rl-tab.active-high{background:var(--accent);color:#fff;border-color:var(--accent)}
.keywords-section{margin-top:4px}
.keywords-section h3{margin-bottom:6px}
.kw-item{font-size:12px;padding:4px 8px;margin-bottom:3px;border-radius:4px;background:rgba(255,255,255,.04);transition:all .3s}
.kw-item.highlighted{background:rgba(0,188,212,.2);color:var(--teal);font-weight:600}
.bottom-btns{margin-top:auto;padding-top:12px;display:flex;gap:8px}
.btn-reset{flex:1;padding:8px;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;transition:all .2s}
.btn-reset.red{background:var(--accent);color:#fff}
.btn-reset.blue{background:var(--blue);color:#fff}
.btn-reset:hover{transform:scale(1.03);filter:brightness(1.15)}
/* CENTER PANEL */
.center-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:12px 16px}
/* STEP TABS */
.step-tabs{display:flex;gap:6px;margin-bottom:12px;flex-shrink:0}
.step-tab{flex:1;text-align:center;padding:8px 4px;border-radius:8px;font-size:13px;font-weight:700;background:rgba(255,255,255,.06);color:var(--text-dim);transition:all .4s;position:relative}
.step-tab.active{color:#fff;box-shadow:0 0 20px rgba(0,188,212,.4)}
.step-tab.active.predict{background:linear-gradient(135deg,#7c4dff,#651fff)}
.step-tab.active.read{background:linear-gradient(135deg,var(--blue),#1565c0)}
.step-tab.active.watch{background:linear-gradient(135deg,var(--accent),#c62828)}
.step-tab.active.record{background:linear-gradient(135deg,var(--ok),#2e7d32)}
.step-tab.done{color:var(--ok)}
/* CENTER CONTENT */
.center-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow-y:auto;position:relative}
/* Welcome */
.welcome-screen{text-align:center;padding:30px}
.welcome-screen .big-heart{font-size:100px;animation:heartbeat 1.2s infinite}
@keyframes heartbeat{0%,100%{transform:scale(1)}15%{transform:scale(1.15)}30%{transform:scale(1)}45%{transform:scale(1.1)}}
.welcome-screen h2{font-size:24px;margin:16px 0 8px;background:linear-gradient(90deg,var(--accent),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.welcome-screen p{color:var(--text-dim);font-size:14px;max-width:500px;margin:0 auto;line-height:1.5}
.mission-box{margin-top:16px;background:rgba(233,69,96,.1);border:1px solid var(--accent);border-radius:12px;padding:14px 20px;font-size:13px;line-height:1.6;text-align:left}
.mission-box strong{color:var(--accent)}
/* PREDICT SCREEN */
.predict-screen,.read-screen,.watch-screen,.record-screen{width:100%;max-width:700px;text-align:center;display:none;flex-direction:column;align-items:center}
.predict-screen.show,.read-screen.show,.watch-screen.show,.record-screen.show{display:flex}
.predict-card{background:linear-gradient(135deg,rgba(124,77,255,.15),rgba(101,31,255,.1));border:2px solid #7c4dff;border-radius:16px;padding:24px;width:100%;text-align:left}
.predict-card h3{color:#b388ff;font-size:15px;margin-bottom:8px}
.predict-card .premise{font-size:14px;line-height:1.6;margin-bottom:16px;color:#e0e0e0}
.predict-card .predict-q{font-size:15px;font-weight:700;color:#fff;margin-bottom:12px}
.predict-options{display:flex;flex-direction:column;gap:8px}
.predict-opt{padding:12px 16px;border-radius:10px;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.1);cursor:pointer;font-size:13px;transition:all .2s;text-align:left}
.predict-opt:hover{border-color:#7c4dff;background:rgba(124,77,255,.15)}
.predict-opt.selected{border-color:#7c4dff;background:rgba(124,77,255,.25)}
/* READ SCREEN */
.read-card{background:rgba(33,150,243,.08);border:2px solid var(--blue);border-radius:16px;padding:24px;width:100%;text-align:left;max-height:55vh;overflow-y:auto}
.read-card h3{color:#90caf9;font-size:15px;margin-bottom:12px}
.passage-text{font-size:16px;line-height:1.8;color:#e8e8e8}
.passage-text .kw{color:var(--teal);font-weight:700}
.passage-text .reading-sentence.highlight{background:rgba(255,235,59,.15);border-radius:4px;padding:1px 2px}
.read-aloud-btn{margin-top:12px;padding:10px 20px;border-radius:10px;background:linear-gradient(135deg,#1565c0,var(--blue));border:none;color:#fff;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.read-aloud-btn:hover{transform:scale(1.03);filter:brightness(1.15)}
.read-aloud-btn.speaking{background:linear-gradient(135deg,var(--accent),#c62828)}
/* WATCH SCREEN */
.watch-arena{width:100%;max-width:680px;height:380px;background:radial-gradient(ellipse at center,rgba(15,52,96,.6),var(--bg));border:2px solid rgba(255,255,255,.1);border-radius:20px;position:relative;overflow:hidden}
.gauge-container{position:absolute;left:30px;top:20px;bottom:20px;width:60px;display:flex;flex-direction:column;border-radius:10px;overflow:hidden;border:2px solid rgba(255,255,255,.2)}
.gauge-zone{display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;letter-spacing:.5px;text-align:center}
.gz-danger{flex:2;background:linear-gradient(180deg,#b71c1c,var(--danger));color:#fff}
.gz-strain{flex:2;background:linear-gradient(180deg,#f57f17,var(--strain));color:#000}
.gz-ok{flex:3;background:linear-gradient(180deg,var(--ok),#1b5e20);color:#fff}
.gz-stopped{flex:1.5;background:var(--stopped);color:#666;font-size:8px}
.gauge-indicator{position:absolute;left:22px;width:76px;height:4px;background:#fff;border-radius:2px;box-shadow:0 0 12px #fff,0 0 24px var(--teal);transition:top 1.5s ease;z-index:5}
.gauge-bpm{position:absolute;left:110px;top:20px;font-size:28px;font-weight:900;color:var(--teal);text-shadow:0 0 16px var(--teal);z-index:5;transition:all .5s}
.gauge-bpm.danger-color{color:var(--danger);text-shadow:0 0 16px var(--danger)}
.gauge-bpm.strain-color{color:var(--strain);text-shadow:0 0 16px var(--strain)}
.gauge-bpm.stopped-color{color:#666;text-shadow:none}
/* Heart animation */
.heart-visual{position:absolute;right:40px;top:50%;transform:translateY(-50%);font-size:100px;filter:drop-shadow(0 0 20px rgba(233,69,96,.5));z-index:3}
.heart-visual.beating{animation:heartPump var(--beat-speed,1s) infinite}
.heart-visual.stopped{filter:grayscale(1) brightness(.4);animation:none}
@keyframes heartPump{0%,100%{transform:translateY(-50%) scale(1)}20%{transform:translateY(-50%) scale(1.15)}40%{transform:translateY(-50%) scale(1)}}
/* Particles */
.particle-container{position:absolute;inset:0;pointer-events:none;z-index:2}
.oxygen-dot{position:absolute;width:8px;height:8px;background:radial-gradient(circle,#64ffda,var(--teal));border-radius:50%;opacity:0}
/* Animation overlays */
.anim-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:4;pointer-events:none}
.anim-label{position:absolute;padding:6px 14px;border-radius:8px;font-size:13px;font-weight:700;background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.2);white-space:nowrap;opacity:0;transition:opacity .5s}
.anim-label.show{opacity:1}
.cpr-icon{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);font-size:50px;opacity:0;z-index:5}
.cpr-icon.active{opacity:1;animation:cprPump .6s infinite}
@keyframes cprPump{0%,100%{transform:translateX(-50%) scaleY(1)}50%{transform:translateX(-50%) scaleY(.8)}}
.defib-flash{position:absolute;inset:0;background:rgba(255,235,59,.4);opacity:0;z-index:6;pointer-events:none;transition:opacity .1s}
.defib-flash.flash{opacity:1}
.warning-flash{position:absolute;inset:0;background:rgba(244,67,54,.3);opacity:0;z-index:6;pointer-events:none}
.warning-flash.flash{animation:warnFlash .8s ease}
@keyframes warnFlash{0%{opacity:.6}100%{opacity:0}}
.watch-timer{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);font-size:14px;color:var(--text-dim);z-index:5}
/* RECORD SCREEN */
.record-card{background:linear-gradient(135deg,rgba(76,175,80,.1),rgba(46,125,50,.08));border:2px solid var(--ok);border-radius:16px;padding:24px;width:100%;text-align:center}
.record-card h3{color:#81c784;font-size:18px;margin-bottom:8px}
.record-card p{color:var(--text-dim);font-size:14px}
.completion-anim{font-size:60px;margin-bottom:12px;animation:bounceIn .6s}
@keyframes bounceIn{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
/* ACTION BUTTON */
.action-area{flex-shrink:0;padding:12px 0;display:flex;justify-content:center;gap:10px}
.action-btn{padding:12px 32px;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;transition:all .25s;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.action-btn:hover{transform:translateY(-2px);filter:brightness(1.12)}
.action-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.action-btn.purple{background:linear-gradient(135deg,#7c4dff,#651fff)}
.action-btn.blue{background:linear-gradient(135deg,var(--blue),#1565c0)}
.action-btn.red{background:linear-gradient(135deg,var(--accent),#c62828)}
.action-btn.green{background:linear-gradient(135deg,var(--ok),#2e7d32)}
.action-btn.hidden{display:none}
/* RIGHT SIDEBAR */
.right-sidebar{width:280px;min-width:280px;background:var(--bg2);border-left:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;overflow-y:auto;padding:12px}
.right-sidebar h3{font-size:13px;color:var(--teal);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
.hud-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px}
.hud-stat{background:var(--card-bg);border-radius:8px;padding:8px;text-align:center}
.hud-stat .val{font-size:22px;font-weight:900;color:var(--teal)}
.hud-stat .label{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px}
.progress-bar-wrap{background:rgba(255,255,255,.06);border-radius:8px;height:20px;margin-bottom:6px;overflow:hidden;position:relative}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--ok));border-radius:8px;transition:width .5s ease;width:0%}
.progress-msg{font-size:12px;color:var(--teal);text-align:center;margin-bottom:12px;font-weight:600}
.data-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.copy-btn{padding:5px 12px;border:none;border-radius:6px;background:var(--blue);color:#fff;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s}
.copy-btn:hover{filter:brightness(1.15)}
.data-table-wrap{flex:1;overflow-y:auto}
.data-table{width:100%;border-collapse:collapse;font-size:10px}
.data-table th{background:rgba(0,188,212,.15);color:var(--teal);padding:6px 4px;text-align:left;font-size:9px;position:sticky;top:0;z-index:1}
.data-table td{padding:5px 4px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top;font-size:10px;color:var(--text-dim);line-height:1.3}
.data-table tr:nth-child(even){background:rgba(255,255,255,.02)}
.data-table tr.new-row{animation:rowGlow .8s ease}
@keyframes rowGlow{0%{background:rgba(0,188,212,.2)}100%{background:transparent}}
/* COMPLETION MODAL */
.completion-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center}
.completion-overlay.show{display:flex}
.completion-modal{background:linear-gradient(135deg,var(--bg2),var(--bg));border:2px solid var(--teal);border-radius:20px;padding:32px;text-align:center;max-width:450px;animation:modalIn .5s}
@keyframes modalIn{0%{transform:scale(.8);opacity:0}100%{transform:scale(1);opacity:1}}
.completion-modal .trophy{font-size:80px}
.completion-modal h2{margin:12px 0;color:var(--teal)}
.completion-modal p{color:var(--text-dim);font-size:14px;line-height:1.5;margin-bottom:16px}
/* Extra credit message */
.ec-banner{display:none;background:linear-gradient(135deg,#ffd600,#ff6f00);color:#000;padding:8px 16px;border-radius:10px;font-weight:700;font-size:13px;text-align:center;margin-top:8px}
.ec-banner.show{display:block}
/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:3px}
</style>
</head>
<body>

<div class="sim-header">
<h1>ü´Ä Mr. Jawad Simulation ‚Äî Circulatory System: What Happens When Your Heart Faces Extreme Demands</h1>
</div>

<div class="main">
<!-- LEFT SIDEBAR -->
<div class="left-sidebar">
<h3>Pick Any 5 You Like</h3>
<div class="scenario-count" id="scenarioCount">8 stories ‚Äî pick at least 5</div>
<div id="scenarioList"></div>
<div class="divider"></div>
<div class="reading-level-section">
<h3>Reading Level</h3>
<div class="rl-tabs">
<div class="rl-tab active-low" data-level="low" id="rlLow" onclick="setLevel('low')">Low</div>
<div class="rl-tab" data-level="med" id="rlMed" onclick="setLevel('med')">Med</div>
<div class="rl-tab" data-level="high" id="rlHigh" onclick="setLevel('high')">High</div>
</div>
</div>
<div class="divider"></div>
<div class="keywords-section">
<h3>Key Words</h3>
<div id="keywordsList"></div>
</div>
<div class="bottom-btns">
<button class="btn-reset red" onclick="resetSim()">Reset</button>
<button class="btn-reset blue" onclick="newRun()">New Run</button>
</div>
</div>

<!-- CENTER PANEL -->
<div class="center-panel">
<div class="step-tabs">
<div class="step-tab predict" id="stepPredict">1. PREDICT</div>
<div class="step-tab read" id="stepRead">2. READ</div>
<div class="step-tab watch" id="stepWatch">3. WATCH</div>
<div class="step-tab record" id="stepRecord">4. RECORD</div>
</div>
<div class="center-content" id="centerContent">
<div class="welcome-screen" id="welcomeScreen">
<div class="big-heart">ü´Ä</div>
<h2>Heart Stories</h2>
<p>Real people's hearts have been pushed to the edge ‚Äî some survived, some barely made it. Every story reveals how the heart responds when demand gets extreme.</p>
<div class="mission-box"><strong>Mission:</strong> Investigate 8 real heart cases ‚Äî predict each outcome, read the true story, watch the heart respond, and build the most complete case file you can. Complete at least 5 for full credit.</div>
</div>
<div class="predict-screen" id="predictScreen">
<div class="predict-card">
<h3 id="predictScenarioName"></h3>
<div class="premise" id="predictPremise"></div>
<div class="predict-q">What do you think will happen to this person's heart?</div>
<div class="predict-options" id="predictOptions"></div>
</div>
</div>
<div class="read-screen" id="readScreen">
<div class="read-card">
<h3 id="readScenarioName"></h3>
<div class="passage-text" id="passageText"></div>
</div>
</div>
<div class="watch-screen" id="watchScreen">
<div class="watch-arena" id="watchArena">
<div class="gauge-container">
<div class="gauge-zone gz-danger">DANGER</div>
<div class="gauge-zone gz-strain">STRAIN</div>
<div class="gauge-zone gz-ok">OK</div>
<div class="gauge-zone gz-stopped">STOPPED</div>
</div>
<div class="gauge-indicator" id="gaugeIndicator" style="top:55%"></div>
<div class="gauge-bpm" id="gaugeBpm">72 BPM</div>
<div class="heart-visual beating" id="heartVisual" style="--beat-speed:1s">‚ù§Ô∏è</div>
<div class="particle-container" id="particleContainer"></div>
<div class="anim-overlay" id="animOverlay"></div>
<div class="cpr-icon" id="cprIcon">ü§≤</div>
<div class="defib-flash" id="defibFlash"></div>
<div class="warning-flash" id="warningFlash"></div>
<div class="watch-timer" id="watchTimer"></div>
</div>
</div>
<div class="record-screen" id="recordScreen">
<div class="record-card">
<div class="completion-anim">‚úÖ</div>
<h3>Data Recorded!</h3>
<p id="recordMsg">Check the data table on the right. Pick your next story!</p>
</div>
</div>
</div>
<div class="action-area">
<button class="action-btn blue hidden" id="readAloudBtn" onclick="toggleReadAloud()">üîä Read Aloud</button>
<button class="action-btn purple hidden" id="actionBtn" onclick="handleAction()">Select a Story</button>
</div>
</div>

<!-- RIGHT SIDEBAR -->
<div class="right-sidebar">
<h3>Progress</h3>
<div class="hud-grid">
<div class="hud-stat"><div class="val" id="hudScore">0</div><div class="label">Score</div></div>
<div class="hud-stat"><div class="val" id="hudStreak">0</div><div class="label">Streak</div></div>
<div class="hud-stat"><div class="val" id="hudCompleted">0/5</div><div class="label">Completed</div></div>
<div class="hud-stat"><div class="val" id="hudAccuracy">--</div><div class="label">Accuracy</div></div>
</div>
<div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressFill"></div></div>
<div class="progress-msg" id="progressMsg">Pick your first story!</div>
<div class="ec-banner" id="ecBanner">‚≠ê EXTRA CREDIT ‚Äî Complete all 8! ‚≠ê</div>
<div class="divider"></div>
<div class="data-header">
<h3>Data Table</h3>
<button class="copy-btn" id="copyBtn" onclick="copyTable()">üìã Copy Table</button>
</div>
<div class="data-table-wrap">
<table class="data-table">
<thead><tr><th>Scenario</th><th>What Happened?</th><th>Response</th><th>Heart Demand?</th></tr></thead>
<tbody id="dataBody"></tbody>
</table>
</div>
</div>
</div>

<div class="completion-overlay" id="completionOverlay">
<div class="completion-modal">
<div class="trophy">üèÜ</div>
<h2 id="completionTitle">Required Complete!</h2>
<p id="completionText">You investigated 5 heart stories. Keep going for extra credit!</p>
<button class="action-btn green" onclick="closeCompletion()">Keep Going</button>
</div>
</div>

<script>
// ====== DATA ======
const SCENARIOS = [
{id:1,name:"28 Beats Per Minute",emoji:"üö¥",premise:"Spanish cyclist Miguel Indurain's resting heart rate was measured at just 28 beats per minute ‚Äî less than half of a normal person's ‚Äî after years of extreme endurance training.",
predictions:["Heart slowed because it got weaker","Heart slowed because it got stronger and more efficient","Heart rate is low due to a medical problem","His heart beats fast but the machine read it wrong"],
correctPred:1,
readings:{
low:{text:'Miguel Indurain sits in a doctor\'s office while they measure his <span class="kw">heart rate</span> ‚Äî it reads just 28 beats per minute. A normal person\'s resting <span class="kw">heart rate</span> is 60 to 100. Years of <span class="kw">endurance</span> training made his heart so powerful that it pumps more blood with each beat, so it barely has to work at rest.'},
med:{text:'Miguel Indurain sits in a doctor\'s office while they check his <span class="kw">heart rate</span> ‚Äî it reads just 28 beats per minute. Most people rest between 60 and 100. Indurain won the Tour de France five times, and all that <span class="kw">endurance</span> training changed how his heart works. His heart grew larger and stronger, pumping more blood with every single beat. Because each beat delivers so much <span class="kw">oxygen</span>, his heart barely has to work at rest ‚Äî the <span class="kw">demand</span> is low, and his heart handles it easily.'},
high:{text:'Miguel Indurain sits in a doctor\'s office while they measure his <span class="kw">heart rate</span> ‚Äî the monitor reads just 28 beats per minute. A normal person\'s resting <span class="kw">heart rate</span> falls between 60 and 100. Indurain won the Tour de France five times, racing thousands of miles across mountains and flatlands. All that <span class="kw">endurance</span> training didn\'t just build leg muscles ‚Äî it changed his heart. His heart grew larger and stronger, pumping far more blood with every single beat. Because each beat pushes so much <span class="kw">oxygen</span>-rich blood through his body, his heart barely has to work when <span class="kw">demand</span> is low. At rest, Indurain\'s heart does in one beat what most hearts need two or three beats to do.'}
},
watchAnim:'indurain',
dataRow:{scenario:"28 Beats Per Minute",what:"Indurain trained for years of endurance cycling",response:"Heart grew stronger, resting rate dropped to 28 bpm",connection:"Training lowered demand ‚Äî pumps more per beat, works less at rest"},
keywords:['heart rate','oxygen','endurance','demand']},

{id:2,name:"180 for Two Hours",emoji:"üèÉ",premise:"Eliud Kipchoge's heart pounded at 180 beats per minute for over two hours straight during his world-record marathon ‚Äî and never gave out.",
predictions:["His heart couldn't keep up and he collapsed","His trained heart delivered enough oxygen for the whole race","His heart slowed down to save energy mid-race","The 180 bpm damaged his heart permanently"],
correctPred:1,
readings:{
low:{text:'Eliud Kipchoge lines up for a marathon ‚Äî 26.2 miles of nonstop running. His body\'s <span class="kw">demand</span> for <span class="kw">oxygen</span> is about to explode. Within minutes, his <span class="kw">heart rate</span> rockets to 180 beats per minute and stays there for over two hours straight. His heart trained through years of <span class="kw">endurance</span> work delivers enough <span class="kw">oxygen</span> to keep his legs moving the entire race.'},
med:{text:'Eliud Kipchoge crouches at the starting line of a world-record marathon. The gun fires. Within minutes, his <span class="kw">heart rate</span> rockets from a resting 33 beats per minute to 180 ‚Äî and stays pinned there for over two hours. His body\'s <span class="kw">demand</span> for <span class="kw">oxygen</span> is massive, but his heart was built for this. Years of <span class="kw">endurance</span> training gave him a heart strong enough to pump huge amounts of blood per beat, delivering <span class="kw">oxygen</span> to every muscle that needs it. Kipchoge crosses the finish line with a world record ‚Äî his heart pushed to the edge and held.'},
high:{text:'Eliud Kipchoge crouches at the starting line. 26.2 miles of road stretch ahead. His resting <span class="kw">heart rate</span> sits at about 33 beats per minute ‚Äî one of the lowest ever recorded in a healthy athlete. The gun fires, and within minutes his <span class="kw">heart rate</span> rockets to 180. It stays there for over two hours straight. His body\'s <span class="kw">demand</span> for <span class="kw">oxygen</span> is enormous, every leg muscle screaming for fuel with every stride. Years of <span class="kw">endurance</span> training made his heart large and powerful, pumping huge volumes of blood per beat so <span class="kw">oxygen</span> reaches his muscles fast enough to keep going. He crosses the finish line with a world record, and his heart ‚Äî still pounding ‚Äî begins its slow recovery back to 33.'}
},
watchAnim:'kipchoge',
dataRow:{scenario:"180 for Two Hours",what:"Kipchoge ran a world-record marathon at 180 bpm for 2+ hours",response:"Trained heart sustained massive output without failing",connection:"Endurance training let his heart meet extreme demand for hours"},
keywords:['heart rate','oxygen','demand','endurance']},

{id:3,name:"Ryan's Collapse",emoji:"üèÄ",premise:"Ryan Chian, 15, collapsed during basketball tryouts when his heart suddenly stopped ‚Äî cardiac arrest struck without any warning.",
predictions:["His heart just needed a short rest and restarted on its own","His heart stopped and needed CPR and a defibrillator to restart","He fainted from dehydration but his heart was fine","His heart rate dropped dangerously low but never fully stopped"],
correctPred:1,
readings:{
low:{text:'Ryan Chian, 15, runs a mile in PE class, then heads straight to basketball tryouts. Minutes into practice, his body\'s <span class="kw">demand</span> for <span class="kw">oxygen</span> has been high all day ‚Äî and his heart cannot keep up. Ryan collapses on the gym floor ‚Äî <span class="kw">cardiac arrest</span>, his heart just stops. Lifeguards start <span class="kw">CPR</span> and paramedics use a <span class="kw">defibrillator</span> to shock his heart back into rhythm ‚Äî he survives.'},
med:{text:'Ryan Chian, 15, has a normal day at school ‚Äî he runs a mile in PE, eats lunch, then walks to basketball tryouts. His body\'s <span class="kw">demand</span> for <span class="kw">oxygen</span> has been stacking up all afternoon. Minutes into tryouts, Ryan collapses on the gym floor ‚Äî <span class="kw">cardiac arrest</span> hits without warning, and his heart stops beating. Lifeguards rush in and begin <span class="kw">CPR</span>, pressing on his chest to keep blood and <span class="kw">oxygen</span> moving to his brain. Paramedics arrive with a <span class="kw">defibrillator</span>, deliver a shock, and Ryan\'s <span class="kw">heart rate</span> returns ‚Äî he survives.'},
high:{text:'Ryan Chian, 15, has a completely normal day ‚Äî he runs a mile in PE, sits through classes, and heads to basketball tryouts after school. His body\'s <span class="kw">demand</span> for <span class="kw">oxygen</span> has been building all afternoon without him feeling anything wrong. Minutes into tryouts, with no chest pain and no warning signs, Ryan drops to the gym floor. His heart has stopped ‚Äî <span class="kw">cardiac arrest</span>, sudden and total. Without a heartbeat, <span class="kw">oxygen</span> stops reaching his brain within seconds. Lifeguards begin <span class="kw">CPR</span> immediately, pushing on his chest to force blood through his body and buy time. Paramedics arrive, use a <span class="kw">defibrillator</span> to shock his heart, and his <span class="kw">heart rate</span> returns ‚Äî Ryan survives because people around him acted fast.'}
},
watchAnim:'cardiac_arrest_cpr',
dataRow:{scenario:"Ryan's Collapse",what:"Ryan collapsed at basketball tryouts ‚Äî cardiac arrest with no warning",response:"CPR and defibrillator restarted his heart",connection:"Demand stacked too high ‚Äî his heart stopped and needed outside help"},
keywords:['cardiac arrest','oxygen','demand','CPR','defibrillator','heart rate']},

{id:4,name:"96-Minute Rescue",emoji:"ü´Ä",premise:"Howard Snitzer's heart stopped on a sidewalk, and bystanders performed CPR for 96 straight minutes ‚Äî the longest known successful street rescue.",
predictions:["96 minutes of CPR wasn't enough and he didn't make it","CPR kept oxygen moving to his brain and he survived intact","His heart restarted on its own after a few minutes of CPR","The CPR only kept his body alive but his brain was damaged"],
correctPred:1,
readings:{
low:{text:'Howard Snitzer, 54, collapses on a sidewalk ‚Äî his heart stops completely. Without a heartbeat, <span class="kw">oxygen</span> stops reaching his brain in seconds. Bystanders take turns doing <span class="kw">CPR</span> for 96 straight minutes. They press on his chest to push blood and <span class="kw">oxygen</span> to his brain by hand. He survives with his brain intact ‚Äî the longest known street rescue.'},
med:{text:'Howard Snitzer, 54, is walking down a sidewalk when his heart suddenly stops ‚Äî <span class="kw">cardiac arrest</span>. Without a heartbeat, his blood stops moving, and <span class="kw">oxygen</span> stops reaching his brain within seconds. Brain cells begin dying fast when they lose <span class="kw">oxygen</span> ‚Äî but bystanders act immediately, starting <span class="kw">CPR</span> to push blood through his body by hand. They take turns pressing on his chest for 96 straight minutes, doing the heart\'s job for it. Snitzer survives with his brain fully intact ‚Äî the longest known successful street rescue, because <span class="kw">CPR</span> kept <span class="kw">oxygen</span> flowing the entire time.'},
high:{text:'Howard Snitzer, 54, is walking down a sidewalk when his heart suddenly stops ‚Äî <span class="kw">cardiac arrest</span>, no warning. He drops to the ground. His blood stops moving instantly, and <span class="kw">oxygen</span> stops reaching his brain within seconds. Without <span class="kw">oxygen</span>, brain cells start dying fast ‚Äî they only last four to six minutes. But bystanders don\'t wait for paramedics. They drop to their knees and start <span class="kw">CPR</span>, pressing hard on his chest to force blood through his body by hand. They take turns for 96 straight minutes ‚Äî over an hour and a half of nonstop compressions, each one pushing <span class="kw">oxygen</span> toward his brain. Snitzer survives with his brain fully intact, making it the longest known successful street rescue.'}
},
watchAnim:'cpr_96min',
dataRow:{scenario:"96-Minute Rescue",what:"Snitzer's heart stopped on a sidewalk ‚Äî cardiac arrest",response:"Bystanders did CPR for 96 minutes, keeping oxygen moving",connection:"CPR replaced the heart's job ‚Äî kept oxygen reaching the brain when demand was zero"},
keywords:['cardiac arrest','oxygen','CPR']},

{id:5,name:"Foul Tip Strike",emoji:"‚öæ",premise:"Dex Avdem, 14, was catching in a baseball tournament when a foul tip hit his chest at exactly the wrong moment between heartbeats, stopping his heart instantly.",
predictions:["The ball hit broke his ribs and that stopped his heart","The impact hit at the exact wrong moment in the heartbeat cycle, disrupting the rhythm","The ball knocked the wind out of him but his heart was fine","His chest protector absorbed the hit and he walked it off"],
correctPred:1,
readings:{
low:{text:'Dex Avdem, 14, crouches behind home plate during a baseball state tournament in North Dakota. A foul tip slams into his chest at exactly the wrong moment between heartbeats. The impact disrupts his <span class="kw">heart rate</span> ‚Äî his heart stops instantly, <span class="kw">cardiac arrest</span>. A <span class="kw">defibrillator</span> at the field delivers a shock that restarts his heart, and Dex survives.'},
med:{text:'Dex Avdem, 14, is catching in a baseball state tournament in North Dakota when a foul tip rockets into his chest. The ball hits at exactly the wrong moment ‚Äî right between two heartbeats, when the heart\'s electrical system is resetting. That split-second impact disrupts his <span class="kw">heart rate</span> completely, and his heart stops ‚Äî <span class="kw">cardiac arrest</span>, instant and total. Without a heartbeat, <span class="kw">oxygen</span> stops reaching his brain within seconds. A charged <span class="kw">defibrillator</span> at the field delivers a shock that restarts his heart ‚Äî Dex survives, and returns the next day to watch his team win the championship.'},
high:{text:'Dex Avdem, 14, crouches behind home plate at a state baseball tournament in North Dakota. He has done this thousands of times before ‚Äî catching pitch after pitch is routine. But this time, a foul tip rockets straight into his chest. The ball hits at exactly the wrong moment in his <span class="kw">heart rate</span> cycle ‚Äî the split second between beats when the heart\'s electrical system is resetting. That tiny window is when the heart is most vulnerable, and the impact throws the entire rhythm off. Dex\'s heart stops instantly ‚Äî <span class="kw">cardiac arrest</span> triggered not by disease, but by precise bad timing. Without a heartbeat, <span class="kw">oxygen</span> stops reaching his brain in seconds, and every moment counts. A charged <span class="kw">defibrillator</span> at the field delivers a shock that restarts his heart ‚Äî Dex is airlifted to a hospital, recovers, and returns the next day to watch his team win the championship.'}
},
watchAnim:'foul_tip',
dataRow:{scenario:"Foul Tip Strike",what:"Ball hit Dex's chest at exact wrong moment between heartbeats",response:"Heart stopped instantly ‚Äî defibrillator restarted it",connection:"Timing of impact disrupted rhythm ‚Äî demand didn't cause it, a physical shock did"},
keywords:['heart rate','cardiac arrest','oxygen','defibrillator']},

{id:6,name:"Overtraining Backfire",emoji:"üò∞",premise:"A competitive runner pushed harder every week, but his resting heart rate started rising and his race times got worse ‚Äî a real condition called overtraining syndrome that affects about 1 in 3 competitive athletes.",
predictions:["His heart got stronger from all the extra work","His body broke down because he trained too much without rest","His heart rate rose because he was getting faster","He just needed more water and sleep"],
correctPred:1,
readings:{
low:{text:'A competitive runner trains hard every single day ‚Äî running, cycling, and pushing harder each week. After months of nonstop work, his resting <span class="kw">heart rate</span> starts rising instead of dropping. He feels exhausted, gets sick often, and his race times get worse. Doctors say his body\'s <span class="kw">demand</span> for recovery was greater than what his training allowed ‚Äî pushing past the limit made his heart weaker, not stronger.'},
med:{text:'A competitive runner pushes himself hard every day ‚Äî running in the morning, cycling at night, increasing distance each week. For a while, his <span class="kw">endurance</span> improves and his resting <span class="kw">heart rate</span> drops, just like a trained athlete\'s should. But after months of nonstop training without enough rest, something changes. His resting <span class="kw">heart rate</span> starts rising, he gets sick more often, and his race times get worse instead of better. Doctors diagnose overtraining syndrome ‚Äî his body\'s <span class="kw">demand</span> for recovery exceeded what he gave it, and the extra work broke his system down instead of building it up.'},
high:{text:'A competitive runner trains relentlessly ‚Äî running every morning, cycling every evening, pushing harder each week. At first, it works: his <span class="kw">endurance</span> climbs, his resting <span class="kw">heart rate</span> drops, and his race times improve. Everything points to a stronger heart. Then his body starts fighting back. His resting <span class="kw">heart rate</span> creeps upward instead of staying low, and he catches colds constantly. His race times get worse ‚Äî not better. Doctors call it overtraining syndrome, a condition that hits roughly one in three competitive athletes. His body\'s <span class="kw">demand</span> for rest was greater than what his schedule allowed, and pushing past that limit destroyed what he built.'}
},
watchAnim:'overtraining',
dataRow:{scenario:"Overtraining Backfire",what:"Runner trained nonstop without rest for months",response:"Resting heart rate rose, performance dropped, got sick",connection:"Demand for recovery exceeded rest ‚Äî overwork weakened the heart instead of strengthening it"},
keywords:['heart rate','endurance','demand']},

{id:7,name:"The Coach Who Collapsed",emoji:"üèüÔ∏è",premise:"During a youth basketball game in 2024, a coach collapsed on the gym floor ‚Äî cardiac arrest from hidden heart damage, documented in national news coverage when a nurse in the crowd saved his life with CPR.",
predictions:["The coach had a panic attack from the stress of coaching","Hidden heart damage caused sudden cardiac arrest when demand got too high","He collapsed from exhaustion but his heart was fine","His heart slowed down as a warning before it stopped"],
correctPred:1,
readings:{
low:{text:'A basketball coach calls a timeout during his daughter\'s game, walks to the sideline, and collapses ‚Äî <span class="kw">cardiac arrest</span>. His heart had hidden damage building for years, but he never felt it. A nurse in the crowd rushes over and starts <span class="kw">CPR</span>, keeping blood and <span class="kw">oxygen</span> flowing to his brain. The coach survives, but his heart failed the moment <span class="kw">demand</span> got too high for his damaged system to handle.'},
med:{text:'A basketball coach paces the sideline during his daughter\'s game, calling plays and shouting encouragement. His heart has been carrying hidden damage for years ‚Äî blocked vessels slowly building up ‚Äî but he never felt a single symptom. During a timeout, the <span class="kw">demand</span> on his heart crosses a line his body can no longer handle. He collapses on the gym floor ‚Äî <span class="kw">cardiac arrest</span>, sudden and total. A nurse in the crowd checks for a pulse, finds nothing, and begins <span class="kw">CPR</span> immediately, pressing on his chest to force blood and <span class="kw">oxygen</span> to his brain. The coach survives because someone nearby knew how to do the heart\'s job when the heart could not.'},
high:{text:'A basketball coach paces the sideline during his daughter\'s game, shouting plays and clapping after good shots. To everyone watching, he looks perfectly fine ‚Äî healthy, energetic, in control. But inside his chest, his heart has been carrying hidden damage for years. Blood vessels have been slowly narrowing, reducing how much blood and <span class="kw">oxygen</span> his heart can pump under pressure. He never felt a symptom ‚Äî no pain, no warning, nothing. During a timeout, the <span class="kw">demand</span> on his heart pushes past what his damaged system can deliver, and he collapses on the gym floor ‚Äî <span class="kw">cardiac arrest</span>. A nurse in the crowd starts <span class="kw">CPR</span> immediately, keeping <span class="kw">oxygen</span> moving to his brain until paramedics arrive ‚Äî he survives, but only because someone acted in the seconds that mattered most.'}
},
watchAnim:'hidden_damage',
dataRow:{scenario:"The Coach Who Collapsed",what:"Coach collapsed during a game ‚Äî hidden heart damage for years",response:"CPR from a nurse kept oxygen flowing until paramedics arrived",connection:"Hidden damage reduced heart capacity ‚Äî when demand exceeded the limit, it failed"},
keywords:['cardiac arrest','oxygen','demand','CPR']},

{id:8,name:"Three Hearts, One Family",emoji:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶",premise:"Joe Krejci, his mother Virginia, and his sister Sara all survived separate cardiac arrest events years apart ‚Äî each saved by CPR and quick action.",
predictions:["Only one of the three family members survived","All three survived because someone nearby always knew CPR","The family had a genetic condition that made their hearts stronger","Two survived but the third didn't make it"],
correctPred:1,
readings:{
low:{text:'Joe Krejci, a teenager in Texas, collapses during sports ‚Äî <span class="kw">cardiac arrest</span>. Someone does <span class="kw">CPR</span> to keep <span class="kw">oxygen</span> moving until a <span class="kw">defibrillator</span> restarts his heart. Four years later, his mother Virginia has <span class="kw">cardiac arrest</span> too ‚Äî his father saves her with <span class="kw">CPR</span>. Then his sister Sara collapses years after that, and a bystander\'s <span class="kw">CPR</span> saves her life too.'},
med:{text:'Joe Krejci, a teenager in Texas, collapses during sports ‚Äî <span class="kw">cardiac arrest</span> strikes without warning, and his heart stops. Someone nearby starts <span class="kw">CPR</span> immediately, keeping <span class="kw">oxygen</span> flowing to his brain until paramedics arrive with a <span class="kw">defibrillator</span> to restart his heart ‚Äî he survives. Four years later, his mother Virginia collapses in a parking lot ‚Äî <span class="kw">cardiac arrest</span> again. Joe\'s father, who learned <span class="kw">CPR</span> after Joe\'s event, drops to his knees and does the heart\'s job by hand ‚Äî she survives. Three years after that, Joe\'s sister Sara collapses at a college event, and a bystander\'s <span class="kw">CPR</span> plus a <span class="kw">defibrillator</span> save her life too. Only about 9 out of 100 people survive <span class="kw">cardiac arrest</span> outside a hospital ‚Äî three members of one family beat those odds because someone always knew <span class="kw">CPR</span>.'},
high:{text:'Joe Krejci, a teenager in Texas, collapses during a sports event ‚Äî <span class="kw">cardiac arrest</span>, sudden and total. His heart stops, and <span class="kw">oxygen</span> stops reaching his brain in seconds. A bystander starts <span class="kw">CPR</span> immediately, pressing on Joe\'s chest to keep blood moving until paramedics arrive with a <span class="kw">defibrillator</span> to shock his heart back into rhythm ‚Äî Joe survives. The family learns <span class="kw">CPR</span> together after the scare, hoping they will never need it again. Four years later, Joe\'s mother Virginia collapses in a parking lot ‚Äî <span class="kw">cardiac arrest</span>, the same emergency. Her husband drops to his knees and begins <span class="kw">CPR</span>, using the skill they learned because of Joe ‚Äî she survives. Three years after that, Joe\'s sister Sara collapses at a college event, and a bystander\'s <span class="kw">CPR</span> plus a nearby <span class="kw">defibrillator</span> save her too. Only about 9% of people survive <span class="kw">cardiac arrest</span> outside a hospital, but all three Krejcis beat those odds because someone nearby always knew how to keep <span class="kw">oxygen</span> moving when the heart could not.'}
},
watchAnim:'three_hearts',
dataRow:{scenario:"Three Hearts, One Family",what:"Three family members had cardiac arrest years apart",response:"All three survived ‚Äî CPR and defibrillators saved each one",connection:"CPR kept oxygen moving every time ‚Äî survival depended on someone acting fast when demand was impossible"},
keywords:['cardiac arrest','oxygen','CPR','defibrillator']}
];

const ALL_KEYWORDS = ['heart rate','oxygen','cardiac arrest','demand','CPR','defibrillator','endurance'];

// ====== STATE ======
let state = {
currentScenario: null,
currentStep: null, // null, 'predict','read','watch','record'
readingLevel: 'low',
completedIds: [],
score: 0,
streak: 0,
predictions: 0,
correctPredictions: 0,
selectedPrediction: null,
speaking: false,
speechResumeInterval: null
};

// ====== INIT ======
function init() {
buildScenarioCards();
buildKeywords();
updateHUD();
}

function buildScenarioCards() {
const list = document.getElementById('scenarioList');
list.innerHTML = '';
SCENARIOS.forEach(s => {
const div = document.createElement('div');
div.className = 'scenario-card' + (state.completedIds.includes(s.id) ? ' completed' : '') + (state.currentScenario && state.currentScenario.id === s.id ? ' active' : '');
div.innerHTML = `<span class="sc-emoji">${s.emoji}</span><span class="sc-name">${s.name}</span>`;
div.onclick = () => selectScenario(s);
list.appendChild(div);
});
}

function buildKeywords() {
const list = document.getElementById('keywordsList');
list.innerHTML = '';
ALL_KEYWORDS.forEach(kw => {
const div = document.createElement('div');
div.className = 'kw-item';
div.textContent = kw;
div.dataset.kw = kw;
list.appendChild(div);
});
}

function highlightKeywords(kwArr) {
document.querySelectorAll('.kw-item').forEach(el => {
el.classList.toggle('highlighted', kwArr.includes(el.dataset.kw));
});
}

// ====== READING LEVEL ======
function setLevel(lv) {
state.readingLevel = lv;
document.querySelectorAll('.rl-tab').forEach(t => t.className = 'rl-tab');
const el = document.getElementById(lv === 'low' ? 'rlLow' : lv === 'med' ? 'rlMed' : 'rlHigh');
el.classList.add(lv === 'low' ? 'active-low' : lv === 'med' ? 'active-med' : 'active-high');
if (state.currentStep === 'read' && state.currentScenario) {
showReadStep();
}
}

// ====== SELECT SCENARIO ======
function selectScenario(s) {
if (state.currentStep === 'watch') return;
stopSpeech();
state.currentScenario = s;
state.currentStep = 'predict';
state.selectedPrediction = null;
highlightKeywords(s.keywords);
buildScenarioCards();
showPredictStep();
updateStepTabs();
}

// ====== STEP TABS ======
function updateStepTabs() {
['Predict','Read','Watch','Record'].forEach(name => {
const el = document.getElementById('step' + name);
el.classList.remove('active','done');
});
if (!state.currentStep) return;
const map = {predict:'Predict',read:'Read',watch:'Watch',record:'Record'};
const steps = ['predict','read','watch','record'];
const idx = steps.indexOf(state.currentStep);
steps.forEach((s, i) => {
const el = document.getElementById('step' + map[s]);
if (i < idx) el.classList.add('done');
else if (i === idx) el.classList.add('active');
});
}

// ====== SCREENS ======
function hideAllScreens() {
document.getElementById('welcomeScreen').style.display = 'none';
['predictScreen','readScreen','watchScreen','recordScreen'].forEach(id => {
document.getElementById(id).classList.remove('show');
});
}

function showPredictStep() {
hideAllScreens();
const s = state.currentScenario;
document.getElementById('predictScenarioName').textContent = s.emoji + ' ' + s.name;
document.getElementById('predictPremise').textContent = s.premise;
const opts = document.getElementById('predictOptions');
opts.innerHTML = '';
s.predictions.forEach((p, i) => {
const div = document.createElement('div');
div.className = 'predict-opt';
div.textContent = p;
div.onclick = () => {
state.selectedPrediction = i;
opts.querySelectorAll('.predict-opt').forEach(o => o.classList.remove('selected'));
div.classList.add('selected');
};
opts.appendChild(div);
});
document.getElementById('predictScreen').classList.add('show');
showActionBtn('Make Prediction', 'purple', state.selectedPrediction === null);
document.getElementById('readAloudBtn').classList.add('hidden');
}

function showReadStep() {
hideAllScreens();
const s = state.currentScenario;
const lv = state.readingLevel;
document.getElementById('readScenarioName').textContent = s.emoji + ' ' + s.name + ' (' + lv.toUpperCase() + ')';
document.getElementById('passageText').innerHTML = s.readings[lv].text;
document.getElementById('readScreen').classList.add('show');
showActionBtn('Continue to Watch', 'blue');
document.getElementById('readAloudBtn').classList.remove('hidden');
document.getElementById('readAloudBtn').textContent = 'üîä Read Aloud';
document.getElementById('readAloudBtn').classList.remove('speaking');
}

function showWatchStep() {
hideAllScreens();
document.getElementById('watchScreen').classList.add('show');
showActionBtn('', 'green', true);
document.getElementById('actionBtn').classList.add('hidden');
document.getElementById('readAloudBtn').classList.add('hidden');
runWatchAnimation(state.currentScenario);
}

function showRecordStep() {
hideAllScreens();
const s = state.currentScenario;
if (!state.completedIds.includes(s.id)) {
state.completedIds.push(s.id);
state.score += 100;
state.streak++;
state.predictions++;
if (state.selectedPrediction === s.correctPred) state.correctPredictions++;
addDataRow(s.dataRow);
}
document.getElementById('recordScreen').classList.add('show');
const done = state.completedIds.length;
const msg = done >= 8 ? 'All 8 complete ‚Äî EXTRA CREDIT earned!' : done >= 5 ? 'Required complete! Keep going for extra credit!' : `${done} down, ${5 - done} more to go!`;
document.getElementById('recordMsg').textContent = msg + ' Pick your next story!';
showActionBtn('Pick Next Story', 'green');
document.getElementById('readAloudBtn').classList.add('hidden');
buildScenarioCards();
updateHUD();
if (done === 5) showCompletion(false);
if (done === 8) showCompletion(true);
}

function showActionBtn(text, color, disabled) {
const btn = document.getElementById('actionBtn');
btn.textContent = text;
btn.className = 'action-btn ' + color;
btn.disabled = !!disabled;
btn.classList.remove('hidden');
}

// ====== ACTION HANDLER ======
function handleAction() {
if (!state.currentScenario) return;
switch (state.currentStep) {
case 'predict':
if (state.selectedPrediction === null) return;
state.currentStep = 'read';
updateStepTabs();
showReadStep();
break;
case 'read':
stopSpeech();
state.currentStep = 'watch';
updateStepTabs();
showWatchStep();
break;
case 'watch':
state.currentStep = 'record';
updateStepTabs();
showRecordStep();
break;
case 'record':
state.currentScenario = null;
state.currentStep = null;
hideAllScreens();
document.getElementById('welcomeScreen').style.display = '';
document.getElementById('actionBtn').classList.add('hidden');
updateStepTabs();
highlightKeywords([]);
buildScenarioCards();
break;
}
}

// Prediction re-check
setInterval(() => {
if (state.currentStep === 'predict') {
const btn = document.getElementById('actionBtn');
btn.disabled = state.selectedPrediction === null;
}
}, 200);

// ====== WATCH ANIMATIONS ======
function runWatchAnimation(scenario) {
const gauge = document.getElementById('gaugeIndicator');
const bpm = document.getElementById('gaugeBpm');
const heart = document.getElementById('heartVisual');
const cpr = document.getElementById('cprIcon');
const defib = document.getElementById('defibFlash');
const warn = document.getElementById('warningFlash');
const timer = document.getElementById('watchTimer');
const overlay = document.getElementById('animOverlay');

// Reset
gauge.style.top = '55%';
bpm.textContent = '72 BPM';
bpm.className = 'gauge-bpm';
heart.className = 'heart-visual beating';
heart.style.setProperty('--beat-speed', '1s');
cpr.classList.remove('active');
cpr.style.opacity = '0';
timer.textContent = '';
overlay.innerHTML = '';
clearParticles();

const labels = [];
function addLabel(text, x, y, delay, dur) {
const el = document.createElement('div');
el.className = 'anim-label';
el.textContent = text;
el.style.left = x;
el.style.top = y;
overlay.appendChild(el);
setTimeout(() => el.classList.add('show'), delay);
if (dur) setTimeout(() => el.classList.remove('show'), delay + dur);
labels.push(el);
}

let safetyTimeout;
function finishWatch() {
clearTimeout(safetyTimeout);
showActionBtn('Record Data', 'green');
document.getElementById('actionBtn').classList.remove('hidden');
}

safetyTimeout = setTimeout(finishWatch, 12000);

const anim = scenario.watchAnim;
try {
if (anim === 'indurain') {
// Heart slows way down, large efficient heart
setTimeout(() => { gauge.style.top = '72%'; bpm.textContent = '60 BPM'; }, 300);
setTimeout(() => { gauge.style.top = '82%'; bpm.textContent = '40 BPM'; heart.style.setProperty('--beat-speed', '2s'); addLabel('Training effect', '40%', '30%', 0, 3000); }, 1500);
setTimeout(() => { gauge.style.top = '88%'; bpm.textContent = '28 BPM'; bpm.className = 'gauge-bpm'; heart.style.setProperty('--beat-speed', '2.5s'); heart.style.fontSize = '120px'; addLabel('28 BPM', '35%', '55%', 0, 4000); startOxygenFlow(); }, 3500);
setTimeout(() => { addLabel('1 beat = 3 normal', '30%', '75%', 0, 3000); }, 5500);
setTimeout(finishWatch, 8000);
}
else if (anim === 'kipchoge') {
setTimeout(() => { gauge.style.top = '80%'; bpm.textContent = '33 BPM'; heart.style.setProperty('--beat-speed', '2s'); addLabel('Resting: 33 BPM', '30%', '30%', 0, 2000); }, 300);
setTimeout(() => { gauge.style.top = '25%'; bpm.textContent = '180 BPM'; bpm.className = 'gauge-bpm strain-color'; heart.style.setProperty('--beat-speed', '.33s'); startOxygenFlow(true); addLabel('Race starts!', '40%', '25%', 0, 2000); }, 2500);
setTimeout(() => { addLabel('180 BPM ‚Äî 2+ hours', '28%', '55%', 0, 3000); timer.textContent = '‚è±Ô∏è 2:00:00+'; }, 5000);
setTimeout(() => { gauge.style.top = '60%'; bpm.textContent = '33 BPM'; bpm.className = 'gauge-bpm'; heart.style.setProperty('--beat-speed', '2s'); addLabel('Recovery', '40%', '70%', 0, 2000); timer.textContent = ''; }, 8000);
setTimeout(finishWatch, 10000);
}
else if (anim === 'cardiac_arrest_cpr' || anim === 'hidden_damage') {
const isHidden = anim === 'hidden_damage';
if (isHidden) setTimeout(() => { addLabel('Hidden damage', '35%', '20%', 0, 2000); heart.style.filter = 'hue-rotate(30deg) brightness(0.7)'; }, 300);
setTimeout(() => { gauge.style.top = '35%'; bpm.textContent = isHidden ? '95 BPM' : '140 BPM'; bpm.className = 'gauge-bpm strain-color'; heart.style.setProperty('--beat-speed', '.5s'); }, isHidden ? 1500 : 500);
setTimeout(() => {
gauge.style.top = '95%'; bpm.textContent = '0 BPM'; bpm.className = 'gauge-bpm stopped-color';
heart.className = 'heart-visual stopped'; heart.style.filter = 'grayscale(1) brightness(.4)';
warn.classList.add('flash'); setTimeout(() => warn.classList.remove('flash'), 800);
addLabel('CARDIAC ARREST', '28%', '40%', 0, 3000);
stopParticles();
}, isHidden ? 3500 : 2500);
setTimeout(() => {
cpr.style.opacity = '1'; cpr.classList.add('active');
addLabel('CPR ‚Äî keeping oxygen moving', '22%', '25%', 0, 3000);
startOxygenFlow(false, true);
}, isHidden ? 5500 : 4500);
setTimeout(() => {
if (!isHidden) {
defib.classList.add('flash'); setTimeout(() => defib.classList.remove('flash'), 300);
addLabel('‚ö° Defibrillator', '38%', '55%', 0, 2000);
}
cpr.classList.remove('active'); cpr.style.opacity = '0';
gauge.style.top = '55%'; bpm.textContent = '72 BPM'; bpm.className = 'gauge-bpm';
heart.className = 'heart-visual beating'; heart.style.setProperty('--beat-speed', '1s'); heart.style.filter = '';
startOxygenFlow();
}, isHidden ? 8000 : 7000);
setTimeout(finishWatch, isHidden ? 10000 : 9500);
}
else if (anim === 'cpr_96min') {
setTimeout(() => {
gauge.style.top = '95%'; bpm.textContent = '0 BPM'; bpm.className = 'gauge-bpm stopped-color';
heart.className = 'heart-visual stopped'; heart.style.filter = 'grayscale(1) brightness(.4)';
warn.classList.add('flash'); setTimeout(() => warn.classList.remove('flash'), 800);
addLabel('CARDIAC ARREST', '28%', '35%', 0, 2500);
stopParticles();
}, 500);
setTimeout(() => {
cpr.style.opacity = '1'; cpr.classList.add('active');
addLabel('CPR begins ‚Äî oxygen to brain', '20%', '25%', 0, 3000);
startOxygenFlow(false, true);
timer.textContent = '‚è±Ô∏è Counting...';
}, 2500);
setTimeout(() => { timer.textContent = '‚è±Ô∏è 96 MINUTES'; addLabel('96 min ‚Äî brain still OK', '22%', '65%', 0, 3000); }, 5500);
setTimeout(() => {
cpr.classList.remove('active'); cpr.style.opacity = '0';
gauge.style.top = '55%'; bpm.textContent = '72 BPM'; bpm.className = 'gauge-bpm';
heart.className = 'heart-visual beating'; heart.style.setProperty('--beat-speed', '1s'); heart.style.filter = '';
timer.textContent = ''; startOxygenFlow();
addLabel('Survived ‚Äî brain intact', '28%', '50%', 0, 2500);
}, 8000);
setTimeout(finishWatch, 10500);
}
else if (anim === 'foul_tip') {
addLabel('Normal heartbeat', '30%', '25%', 300, 1500);
setTimeout(() => {
addLabel('‚öæ IMPACT!', '38%', '45%', 0, 2000);
warn.classList.add('flash'); setTimeout(() => warn.classList.remove('flash'), 800);
gauge.style.top = '95%'; bpm.textContent = '0 BPM'; bpm.className = 'gauge-bpm stopped-color';
heart.className = 'heart-visual stopped'; heart.style.filter = 'grayscale(1) brightness(.4)';
stopParticles();
}, 2000);
setTimeout(() => { addLabel('Rhythm disrupted', '30%', '65%', 0, 2000); }, 3500);
setTimeout(() => {
defib.classList.add('flash'); setTimeout(() => defib.classList.remove('flash'), 300);
addLabel('‚ö° Defibrillator restarts', '28%', '40%', 0, 2500);
gauge.style.top = '55%'; bpm.textContent = '72 BPM'; bpm.className = 'gauge-bpm';
heart.className = 'heart-visual beating'; heart.style.setProperty('--beat-speed', '1s'); heart.style.filter = '';
startOxygenFlow();
}, 5500);
setTimeout(finishWatch, 8500);
}
else if (anim === 'overtraining') {
setTimeout(() => { gauge.style.top = '65%'; bpm.textContent = '60 BPM'; addLabel('Training works!', '35%', '25%', 0, 1500); startOxygenFlow(); }, 500);
setTimeout(() => { gauge.style.top = '75%'; bpm.textContent = '52 BPM'; heart.style.setProperty('--beat-speed', '1.3s'); addLabel('Rate dropping ‚Üì', '35%', '45%', 0, 1500); }, 2000);
setTimeout(() => { gauge.style.top = '45%'; bpm.textContent = '66 BPM'; bpm.className = 'gauge-bpm strain-color'; heart.style.setProperty('--beat-speed', '.8s'); heart.style.filter = 'hue-rotate(30deg) brightness(.7)'; addLabel('Rate rising ‚Üë FATIGUE', '25%', '35%', 0, 2500); }, 4000);
setTimeout(() => { gauge.style.top = '38%'; bpm.textContent = '74 BPM'; addLabel('Performance ‚Üì', '35%', '65%', 0, 2500); }, 6500);
setTimeout(() => { addLabel('1 in 3 athletes', '32%', '80%', 0, 2000); }, 8000);
setTimeout(finishWatch, 10000);
}
else if (anim === 'three_hearts') {
// Three sequential mini-scenes
// JOE
setTimeout(() => { addLabel('JOE', '45%', '15%', 0, 2500); gauge.style.top = '95%'; bpm.textContent = '0 BPM'; bpm.className = 'gauge-bpm stopped-color'; heart.className = 'heart-visual stopped'; heart.style.filter = 'grayscale(1) brightness(.4)'; warn.classList.add('flash'); setTimeout(() => warn.classList.remove('flash'), 500); }, 300);
setTimeout(() => { defib.classList.add('flash'); setTimeout(() => defib.classList.remove('flash'), 200); gauge.style.top = '55%'; bpm.textContent = '72 BPM'; bpm.className = 'gauge-bpm'; heart.className = 'heart-visual beating'; heart.style.filter = ''; }, 2500);
// VIRGINIA
setTimeout(() => { addLabel('VIRGINIA ‚Äî 4 yrs later', '28%', '15%', 0, 2500); gauge.style.top = '95%'; bpm.textContent = '0 BPM'; bpm.className = 'gauge-bpm stopped-color'; heart.className = 'heart-visual stopped'; heart.style.filter = 'grayscale(1) brightness(.4)'; }, 4000);
setTimeout(() => { cpr.style.opacity = '1'; cpr.classList.add('active'); }, 5000);
setTimeout(() => { cpr.classList.remove('active'); cpr.style.opacity = '0'; gauge.style.top = '55%'; bpm.textContent = '72 BPM'; bpm.className = 'gauge-bpm'; heart.className = 'heart-visual beating'; heart.style.filter = ''; }, 6000);
// SARA
setTimeout(() => { addLabel('SARA ‚Äî 7 yrs later', '30%', '15%', 0, 2500); gauge.style.top = '95%'; bpm.textContent = '0 BPM'; bpm.className = 'gauge-bpm stopped-color'; heart.className = 'heart-visual stopped'; heart.style.filter = 'grayscale(1) brightness(.4)'; }, 7000);
setTimeout(() => { defib.classList.add('flash'); setTimeout(() => defib.classList.remove('flash'), 200); gauge.style.top = '55%'; bpm.textContent = '72 BPM'; bpm.className = 'gauge-bpm'; heart.className = 'heart-visual beating'; heart.style.filter = ''; startOxygenFlow(); }, 8500);
setTimeout(() => { addLabel('3/3 SURVIVED', '33%', '50%', 0, 3000); addLabel('Normal: 9% ‚Äî Family: 100%', '22%', '72%', 0, 3000); }, 9500);
setTimeout(finishWatch, 11500);
}
} catch(e) {
console.error('Animation error:', e);
setTimeout(finishWatch, 3000);
}
}

// ====== PARTICLES ======
let particleInterval = null;
function startOxygenFlow(fast, slow) {
stopParticles();
const container = document.getElementById('particleContainer');
const speed = fast ? 100 : slow ? 400 : 200;
particleInterval = setInterval(() => {
const dot = document.createElement('div');
dot.className = 'oxygen-dot';
const startX = 55 + Math.random() * 15;
const startY = 35 + Math.random() * 30;
dot.style.left = startX + '%';
dot.style.top = startY + '%';
container.appendChild(dot);
const endX = startX + (Math.random() - .5) * 40;
const endY = startY + (Math.random() - .5) * 40;
dot.animate([
{opacity: 0, transform: 'scale(0)'},
{opacity: .8, transform: 'scale(1)', offset: .2},
{opacity: .6, transform: `translate(${endX - startX}vw, ${endY - startY}vh) scale(.5)`, offset: .8},
{opacity: 0, transform: `translate(${(endX - startX)*1.5}vw, ${(endY - startY)*1.5}vh) scale(0)`}
], {duration: fast ? 800 : 1500, easing: 'ease-out'});
setTimeout(() => dot.remove(), fast ? 800 : 1500);
}, speed);
}
function stopParticles() { clearInterval(particleInterval); particleInterval = null; }
function clearParticles() { stopParticles(); document.getElementById('particleContainer').innerHTML = ''; }

// ====== HUD ======
function updateHUD() {
const done = state.completedIds.length;
document.getElementById('hudScore').textContent = state.score;
document.getElementById('hudStreak').textContent = state.streak;
document.getElementById('hudCompleted').textContent = done + '/5';
document.getElementById('hudAccuracy').textContent = state.predictions > 0 ? Math.round(state.correctPredictions / state.predictions * 100) + '%' : '--';
const pct = Math.min(done / 5, 1) * 100;
document.getElementById('progressFill').style.width = pct + '%';
if (done === 0) document.getElementById('progressMsg').textContent = 'Pick your first story!';
else if (done < 5) document.getElementById('progressMsg').textContent = `${done} done! ${5 - done} more to go!`;
else if (done < 8) document.getElementById('progressMsg').textContent = `Required complete! ${8 - done} more for extra credit!`;
else document.getElementById('progressMsg').textContent = 'ALL 8 COMPLETE! üèÜ';
document.getElementById('ecBanner').classList.toggle('show', done >= 5 && done < 8);
}

// ====== DATA TABLE ======
function addDataRow(d) {
const tbody = document.getElementById('dataBody');
const tr = document.createElement('tr');
tr.className = 'new-row';
tr.innerHTML = `<td>${d.scenario}</td><td>${d.what}</td><td>${d.response}</td><td>${d.connection}</td>`;
tbody.appendChild(tr);
}

function copyTable() {
const rows = [['Scenario','What Happened?','Person/Situation Response','Connection to Heart Demand?']];
document.querySelectorAll('#dataBody tr').forEach(tr => {
const cells = tr.querySelectorAll('td');
rows.push([cells[0].textContent, cells[1].textContent, cells[2].textContent, cells[3].textContent]);
});
const text = rows.map(r => r.join('\t')).join('\n');
try {
navigator.clipboard.writeText(text);
const btn = document.getElementById('copyBtn');
btn.textContent = '‚úÖ Copied!';
setTimeout(() => btn.textContent = 'üìã Copy Table', 2000);
} catch(e) {
const ta = document.createElement('textarea');
ta.value = text;
document.body.appendChild(ta);
ta.select();
document.execCommand('copy');
document.body.removeChild(ta);
const btn = document.getElementById('copyBtn');
btn.textContent = '‚úÖ Copied!';
setTimeout(() => btn.textContent = 'üìã Copy Table', 2000);
}
}

// ====== COMPLETION ======
function showCompletion(extraCredit) {
const overlay = document.getElementById('completionOverlay');
document.getElementById('completionTitle').textContent = extraCredit ? 'EXTRA CREDIT COMPLETE! üåü' : 'Required Complete!';
document.getElementById('completionText').textContent = extraCredit ? 'Amazing work! You investigated all 8 heart stories. Full extra credit earned!' : 'You investigated 5 heart stories ‚Äî full credit earned! Keep going for extra credit (all 8).';
overlay.classList.add('show');
}
function closeCompletion() {
document.getElementById('completionOverlay').classList.remove('show');
}

// ====== READ ALOUD ======
function toggleReadAloud() {
if (state.speaking) { stopSpeech(); return; }
try {
if (!('speechSynthesis' in window)) { document.getElementById('readAloudBtn').textContent = 'Text Only'; return; }
const passage = document.getElementById('passageText');
const text = passage.textContent || passage.innerText;
const utter = new SpeechSynthesisUtterance(text);
utter.rate = 0.9;
utter.onend = () => { stopSpeech(); };
utter.onerror = () => { stopSpeech(); };
window.speechSynthesis.cancel();
window.speechSynthesis.speak(utter);
state.speaking = true;
document.getElementById('readAloudBtn').textContent = '‚èπÔ∏è Stop Reading';
document.getElementById('readAloudBtn').classList.add('speaking');
// Chrome 15s bug workaround
state.speechResumeInterval = setInterval(() => {
if (window.speechSynthesis.speaking) window.speechSynthesis.resume();
}, 10000);
} catch(e) {
console.error('Speech error:', e);
document.getElementById('readAloudBtn').textContent = 'Text Only';
}
}

function stopSpeech() {
try {
if ('speechSynthesis' in window) window.speechSynthesis.cancel();
} catch(e) {}
state.speaking = false;
clearInterval(state.speechResumeInterval);
state.speechResumeInterval = null;
const btn = document.getElementById('readAloudBtn');
if (btn) { btn.textContent = 'üîä Read Aloud'; btn.classList.remove('speaking'); }
}

// ====== RESET / NEW RUN ======
function resetSim() {
stopSpeech(); clearParticles();
state = { currentScenario: null, currentStep: null, readingLevel: state.readingLevel, completedIds: [], score: 0, streak: 0, predictions: 0, correctPredictions: 0, selectedPrediction: null, speaking: false, speechResumeInterval: null };
document.getElementById('dataBody').innerHTML = '';
hideAllScreens();
document.getElementById('welcomeScreen').style.display = '';
document.getElementById('actionBtn').classList.add('hidden');
document.getElementById('readAloudBtn').classList.add('hidden');
highlightKeywords([]);
buildScenarioCards();
updateHUD();
updateStepTabs();
document.getElementById('ecBanner').classList.remove('show');
}

function newRun() { resetSim(); }

// ====== INIT ======
init();
</script>
</body>
</html>
